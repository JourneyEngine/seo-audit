2018-03-20 16:08:58,918: Tracking: tracking
2018-03-20 16:08:58,934: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10976b4e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10976b240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10976bd30>]}
2018-03-20 16:08:59,761: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-20 16:08:59,790: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-20 16:08:59,796: Parsing core.sql
2018-03-20 16:08:59,831: Parsing adapters/bigquery.sql
2018-03-20 16:08:59,844: Parsing adapters/common.sql
2018-03-20 16:08:59,864: Parsing adapters/postgres.sql
2018-03-20 16:08:59,875: Parsing adapters/redshift.sql
2018-03-20 16:08:59,909: Parsing etc/get_custom_schema.sql
2018-03-20 16:08:59,922: Parsing materializations/archive.sql
2018-03-20 16:09:00,031: Parsing materializations/bigquery.sql
2018-03-20 16:09:00,061: Parsing materializations/helpers.sql
2018-03-20 16:09:00,097: Parsing materializations/incremental.sql
2018-03-20 16:09:00,164: Parsing materializations/table.sql
2018-03-20 16:09:00,199: Parsing materializations/view.sql
2018-03-20 16:09:00,219: Parsing materializations/wrapper.sql
2018-03-20 16:09:00,225: Parsing schema_tests/accepted_values.sql
2018-03-20 16:09:00,232: Parsing schema_tests/not_null.sql
2018-03-20 16:09:00,236: Parsing schema_tests/relationships.sql
2018-03-20 16:09:00,241: Parsing schema_tests/unique.sql
2018-03-20 16:09:00,325: Parsing model.seo_audit.actions_data_studio
2018-03-20 16:09:00,330: Acquiring new bigquery connection "master".
2018-03-20 16:09:00,330: Opening a new connection (0 currently allocated)
2018-03-20 16:09:00,334: Parsing model.seo_audit.actions_hierarchy
2018-03-20 16:09:00,342: Parsing model.seo_audit.actions_proc
2018-03-20 16:09:00,347: Parsing model.seo_audit.accounts_proc
2018-03-20 16:09:00,354: Parsing model.seo_audit.all_dates
2018-03-20 16:09:00,360: Parsing model.seo_audit.dates
2018-03-20 16:09:00,365: Parsing model.seo_audit.mappings_ga_proc
2018-03-20 16:09:00,397: Parsing model.seo_audit.agg_all
2018-03-20 16:09:00,410: Parsing model.seo_audit.agg_indicative
2018-03-20 16:09:00,414: Parsing model.seo_audit.agg_stats
2018-03-20 16:09:00,425: Parsing model.seo_audit.agg_stats_client
2018-03-20 16:09:00,431: Parsing model.seo_audit.deepcrawl_class
2018-03-20 16:09:00,439: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-20 16:09:00,441: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-20 16:09:00,443: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-20 16:09:00,445: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-20 16:09:00,448: Parsing model.seo_audit.deepcrawl_proc
2018-03-20 16:09:00,455: Parsing model.seo_audit.deepcrawl_reclass
2018-03-20 16:09:00,460: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-20 16:09:00,471: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-20 16:09:00,474: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-20 16:09:00,475: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-20 16:09:00,477: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-20 16:09:00,479: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-20 16:09:00,481: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-20 16:09:00,485: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-20 16:09:00,489: Parsing model.seo_audit.deepcrawl_urls
2018-03-20 16:09:00,491: Parsing model.seo_audit.ga_proc
2018-03-20 16:09:00,495: Parsing model.seo_audit.ga_proc_pageviews
2018-03-20 16:09:00,498: Parsing model.seo_audit.ga_stats
2018-03-20 16:09:00,503: Parsing model.seo_audit.majestic_domain_history
2018-03-20 16:09:00,505: Parsing model.seo_audit.majestic_domain_proc
2018-03-20 16:09:00,508: Parsing model.seo_audit.majestic_domain_stats
2018-03-20 16:09:00,511: Parsing model.seo_audit.moz_proc
2018-03-20 16:09:00,513: Parsing model.seo_audit.screamingfrog_proc
2018-03-20 16:09:00,519: Parsing model.seo_audit.search_console_history
2018-03-20 16:09:00,524: Parsing model.seo_audit.search_console_proc
2018-03-20 16:09:00,527: Parsing model.seo_audit.search_console_stats_keyword
2018-03-20 16:09:00,534: Parsing model.seo_audit.search_console_stats_url
2018-03-20 16:09:00,538: Parsing model.seo_audit.semrush_domain_proc
2018-03-20 16:09:00,544: Parsing model.seo_audit.semrush_keyword_history
2018-03-20 16:09:00,550: Parsing model.seo_audit.semrush_keyword_proc
2018-03-20 16:09:00,562: Parsing model.seo_audit.semrush_keyword_stats
2018-03-20 16:09:00,569: Parsing model.seo_audit.semrush_url_history
2018-03-20 16:09:00,578: Parsing model.seo_audit.semrush_url_stats
2018-03-20 16:09:00,585: Parsing model.seo_audit.sitemap_proc
2018-03-20 16:09:00,627: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-20 16:09:00,710: 
2018-03-20 16:09:01,997: 16:09:01 | Concurrency: 4 threads (target='prod')
2018-03-20 16:09:01,998: 16:09:01 | 
2018-03-20 16:09:02,378: 16:09:02 | 1 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-20 16:09:02,378: Compiling model.seo_audit.deepcrawl_proc
2018-03-20 16:09:02,378: 16:09:02 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-20 16:09:02,388: Compiling model.seo_audit.accounts_proc
2018-03-20 16:09:02,378: 16:09:02 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-20 16:09:02,388: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-20 16:09:02,395: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-20 16:09:02,395: Compiling model.seo_audit.all_dates
2018-03-20 16:09:02,401: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-20 16:09:02,402: Acquiring new bigquery connection "accounts_proc".
2018-03-20 16:09:02,402: Opening a new connection (1 currently allocated)
2018-03-20 16:09:02,404: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-20 16:09:02,406: Acquiring new bigquery connection "all_dates".
2018-03-20 16:09:02,456: Opening a new connection (2 currently allocated)
2018-03-20 16:09:02,462: Opening a new connection (3 currently allocated)
2018-03-20 16:09:03,381: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-20 16:09:03,399: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-20 16:09:03,471: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-20 16:09:04,480: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099e37f0>]}
2018-03-20 16:09:04,700: 16:09:04 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.08s]
2018-03-20 16:09:05,591: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109931b38>]}
2018-03-20 16:09:05,822: 16:09:05 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.20s]
2018-03-20 16:09:20,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099e37f0>]}
2018-03-20 16:09:20,457: 16:09:20 | 1 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 17.83s]
2018-03-20 16:09:20,458: 16:09:20 | 4 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-20 16:09:20,459: Compiling model.seo_audit.sitemap_proc
2018-03-20 16:09:20,458: 16:09:20 | 5 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-20 16:09:20,465: Compiling model.seo_audit.search_console_proc
2018-03-20 16:09:20,473: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-20 16:09:20,459: 16:09:20 | 6 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-20 16:09:20,474: Compiling model.seo_audit.semrush_domain_proc
2018-03-20 16:09:20,479: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-20 16:09:20,482: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-20 16:09:20,459: 16:09:20 | 7 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-20 16:09:20,482: Compiling model.seo_audit.screamingfrog_proc
2018-03-20 16:09:20,488: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-20 16:09:20,490: Acquiring new bigquery connection "sitemap_proc".
2018-03-20 16:09:20,490: Re-using an available connection from the pool.
2018-03-20 16:09:20,491: Acquiring new bigquery connection "search_console_proc".
2018-03-20 16:09:20,491: Re-using an available connection from the pool.
2018-03-20 16:09:20,491: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-20 16:09:20,494: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-20 16:09:20,496: Re-using an available connection from the pool.
2018-03-20 16:09:20,499: Opening a new connection (4 currently allocated)
2018-03-20 16:09:21,158: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-20 16:09:21,185: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-20 16:09:21,287: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-20 16:09:21,517: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-20 16:09:23,519: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109974630>]}
2018-03-20 16:09:23,760: 16:09:23 | 6 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.05s]
2018-03-20 16:09:23,761: 16:09:23 | 8 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-20 16:09:23,761: Compiling model.seo_audit.moz_proc
2018-03-20 16:09:23,770: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-20 16:09:23,772: Acquiring new bigquery connection "moz_proc".
2018-03-20 16:09:23,772: Re-using an available connection from the pool.
2018-03-20 16:09:24,440: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-20 16:09:24,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109931ba8>]}
2018-03-20 16:09:25,004: 16:09:25 | 7 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.31s]
2018-03-20 16:09:25,005: 16:09:25 | 9 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-20 16:09:25,005: Compiling model.seo_audit.mappings_ga_proc
2018-03-20 16:09:25,015: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-20 16:09:25,019: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-20 16:09:25,019: Re-using an available connection from the pool.
2018-03-20 16:09:26,058: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993ebe0>]}
2018-03-20 16:09:26,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109974630>]}
2018-03-20 16:09:26,291: 16:09:26 | 5 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.59s]
2018-03-20 16:09:26,292: 16:09:26 | 10 of 46 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-03-20 16:09:26,294: Compiling model.seo_audit.semrush_keyword_proc
2018-03-20 16:09:26,307: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-20 16:09:26,309: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-20 16:09:26,310: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-20 16:09:26,311: Re-using an available connection from the pool.
2018-03-20 16:09:26,527: 16:09:26 | 8 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.38s]
2018-03-20 16:09:26,528: 16:09:26 | 11 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-20 16:09:26,528: Compiling model.seo_audit.majestic_domain_proc
2018-03-20 16:09:26,538: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-20 16:09:26,539: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-20 16:09:26,539: Re-using an available connection from the pool.
2018-03-20 16:09:27,013: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-20 16:09:27,188: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-20 16:09:28,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109931ba8>]}
2018-03-20 16:09:28,696: 16:09:28 | 9 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.47s]
2018-03-20 16:09:29,194: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993ebe0>]}
2018-03-20 16:09:29,402: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109974630>]}
2018-03-20 16:09:29,463: 16:09:29 | 10 of 46 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 2.90s]
2018-03-20 16:09:29,710: 16:09:29 | 11 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 2.87s]
2018-03-20 16:09:30,437: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099748d0>]}
2018-03-20 16:09:30,660: 16:09:30 | 4 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 9.98s]
2018-03-20 16:09:30,661: 16:09:30 | 12 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-20 16:09:30,661: 16:09:30 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-20 16:09:30,661: 16:09:30 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-20 16:09:30,661: 16:09:30 | 15 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-20 16:09:30,662: Compiling model.seo_audit.semrush_url_history
2018-03-20 16:09:30,662: Compiling model.seo_audit.semrush_keyword_history
2018-03-20 16:09:30,662: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-20 16:09:30,662: Compiling model.seo_audit.majestic_domain_history
2018-03-20 16:09:30,667: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-20 16:09:30,675: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-20 16:09:30,682: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-20 16:09:30,693: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-20 16:09:30,696: Acquiring new bigquery connection "majestic_domain_history".
2018-03-20 16:09:30,697: Acquiring new bigquery connection "semrush_url_history".
2018-03-20 16:09:30,697: Re-using an available connection from the pool.
2018-03-20 16:09:30,697: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-20 16:09:30,698: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-20 16:09:30,699: Re-using an available connection from the pool.
2018-03-20 16:09:30,700: Re-using an available connection from the pool.
2018-03-20 16:09:30,701: Re-using an available connection from the pool.
2018-03-20 16:09:31,381: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-20 16:09:31,396: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-20 16:09:31,429: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-20 16:09:31,548: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-20 16:09:33,577: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099c9c18>]}
2018-03-20 16:09:33,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099e37f0>]}
2018-03-20 16:09:33,808: 16:09:33 | 15 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.91s]
2018-03-20 16:09:34,027: 16:09:34 | 12 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.94s]
2018-03-20 16:09:37,953: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064d1ef0>]}
2018-03-20 16:09:38,180: 16:09:38 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 7.29s]
2018-03-20 16:09:58,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064fb8d0>]}
2018-03-20 16:09:59,524: 16:09:59 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 27.81s]
2018-03-20 16:09:59,524: 16:09:59 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-20 16:09:59,525: Compiling model.seo_audit.deepcrawl_class
2018-03-20 16:09:59,534: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-20 16:09:59,535: Acquiring new bigquery connection "deepcrawl_class".
2018-03-20 16:09:59,535: Re-using an available connection from the pool.
2018-03-20 16:10:01,084: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-20 16:10:11,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099e37f0>]}
2018-03-20 16:10:12,416: 16:10:12 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 12.21s]
2018-03-20 16:10:12,416: 16:10:12 | 17 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-20 16:10:12,416: 16:10:12 | 18 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-20 16:10:12,417: 16:10:12 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-20 16:10:12,417: 16:10:12 | 20 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-20 16:10:12,417: Compiling model.seo_audit.semrush_keyword_stats
2018-03-20 16:10:12,417: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-20 16:10:12,417: Compiling model.seo_audit.semrush_url_stats
2018-03-20 16:10:12,417: Compiling model.seo_audit.majestic_domain_stats
2018-03-20 16:10:12,423: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-20 16:10:12,428: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-20 16:10:12,433: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-20 16:10:12,439: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-20 16:10:12,442: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-20 16:10:12,443: Re-using an available connection from the pool.
2018-03-20 16:10:12,447: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-20 16:10:12,447: Re-using an available connection from the pool.
2018-03-20 16:10:12,448: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-20 16:10:12,448: Re-using an available connection from the pool.
2018-03-20 16:10:12,448: Acquiring new bigquery connection "semrush_url_stats".
2018-03-20 16:10:12,451: Re-using an available connection from the pool.
2018-03-20 16:10:13,289: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-20 16:10:13,321: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-20 16:10:13,889: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-20 16:10:13,890: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-20 16:10:15,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064b2358>]}
2018-03-20 16:10:15,548: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099c9c18>]}
2018-03-20 16:10:15,897: 16:10:15 | 20 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.06s]
2018-03-20 16:10:15,899: 16:10:15 | 21 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-20 16:10:15,899: Compiling model.seo_audit.deepcrawl_urls
2018-03-20 16:10:15,907: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-20 16:10:15,910: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-20 16:10:15,911: Re-using an available connection from the pool.
2018-03-20 16:10:16,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064b2940>]}
2018-03-20 16:10:16,361: 16:10:16 | 18 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.13s]
2018-03-20 16:10:16,606: 16:10:16 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.94s]
2018-03-20 16:10:17,100: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-20 16:10:17,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10641f668>]}
2018-03-20 16:10:17,930: 16:10:17 | 17 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 5.06s]
2018-03-20 16:10:19,271: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109975cc0>]}
2018-03-20 16:10:19,729: 16:10:19 | 21 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.37s]
2018-03-20 16:10:19,730: 16:10:19 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-20 16:10:19,730: 16:10:19 | 23 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-20 16:10:19,730: 16:10:19 | 24 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-20 16:10:19,731: 16:10:19 | 25 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-20 16:10:19,731: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-20 16:10:19,731: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-20 16:10:19,731: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-20 16:10:19,731: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-20 16:10:19,740: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-20 16:10:19,745: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-20 16:10:19,750: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-20 16:10:19,755: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-20 16:10:19,759: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-20 16:10:19,760: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-20 16:10:19,761: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-20 16:10:19,761: Re-using an available connection from the pool.
2018-03-20 16:10:19,762: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-20 16:10:19,762: Re-using an available connection from the pool.
2018-03-20 16:10:19,763: Re-using an available connection from the pool.
2018-03-20 16:10:19,765: Re-using an available connection from the pool.
2018-03-20 16:10:20,553: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-20 16:10:20,553: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-20 16:10:20,561: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-20 16:10:20,612: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-20 16:10:22,750: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a05d68>]}
2018-03-20 16:10:22,787: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064b79b0>]}
2018-03-20 16:10:22,805: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099e37f0>]}
2018-03-20 16:10:22,809: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064c2eb8>]}
2018-03-20 16:10:23,211: 16:10:23 | 23 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.02s]
2018-03-20 16:10:23,212: 16:10:23 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-20 16:10:23,212: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-20 16:10:23,218: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-20 16:10:23,222: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-20 16:10:23,222: Re-using an available connection from the pool.
2018-03-20 16:10:23,700: 16:10:23 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 3.06s]
2018-03-20 16:10:23,701: 16:10:23 | 27 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-20 16:10:23,702: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-20 16:10:23,707: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-20 16:10:23,709: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-20 16:10:23,710: Re-using an available connection from the pool.
2018-03-20 16:10:23,940: 16:10:23 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.07s]
2018-03-20 16:10:24,222: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-20 16:10:24,421: 16:10:24 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.08s]
2018-03-20 16:10:25,263: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-20 16:10:25,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a05d68>]}
2018-03-20 16:10:26,324: 16:10:26 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.67s]
2018-03-20 16:10:26,935: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064c2780>]}
2018-03-20 16:10:27,376: 16:10:27 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.23s]
2018-03-20 16:10:27,378: 16:10:27 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-20 16:10:27,378: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-20 16:10:27,390: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-20 16:10:27,388: 16:10:27 | 29 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-20 16:10:27,390: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-20 16:10:27,389: 16:10:27 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-20 16:10:27,397: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-20 16:10:27,400: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-20 16:10:27,400: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-20 16:10:27,400: Re-using an available connection from the pool.
2018-03-20 16:10:27,407: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-20 16:10:27,410: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-20 16:10:27,410: Re-using an available connection from the pool.
2018-03-20 16:10:27,417: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-20 16:10:27,417: Re-using an available connection from the pool.
2018-03-20 16:10:29,737: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-20 16:10:29,738: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-20 16:10:29,986: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-20 16:10:31,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099c9c18>]}
2018-03-20 16:10:31,258: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10654b080>]}
2018-03-20 16:10:31,260: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a05f98>]}
2018-03-20 16:10:31,668: 16:10:31 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 3.88s]
2018-03-20 16:10:32,116: 16:10:32 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 3.86s]
2018-03-20 16:10:32,352: 16:10:32 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 3.87s]
2018-03-20 16:10:32,353: 16:10:32 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-20 16:10:32,354: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-20 16:10:32,381: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-20 16:10:32,382: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-20 16:10:32,382: Re-using an available connection from the pool.
2018-03-20 16:10:34,535: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-20 16:10:46,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993e470>]}
2018-03-20 16:10:47,262: 16:10:47 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 14.62s]
2018-03-20 16:10:47,262: 16:10:47 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-20 16:10:47,263: Compiling model.seo_audit.deepcrawl_reclass
2018-03-20 16:10:47,268: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-20 16:10:47,271: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-20 16:10:47,271: Re-using an available connection from the pool.
2018-03-20 16:10:47,948: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-20 16:10:59,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493ac8>]}
2018-03-20 16:11:00,148: 16:11:00 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 12.67s]
2018-03-20 16:11:00,149: 16:11:00 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-20 16:11:00,149: Compiling model.seo_audit.ga_proc
2018-03-20 16:11:00,149: 16:11:00 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-20 16:11:00,157: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-20 16:11:00,157: Compiling model.seo_audit.ga_proc_pageviews
2018-03-20 16:11:00,163: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-20 16:11:00,164: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-20 16:11:00,164: Re-using an available connection from the pool.
2018-03-20 16:11:00,165: Acquiring new bigquery connection "ga_proc".
2018-03-20 16:11:00,165: Re-using an available connection from the pool.
2018-03-20 16:11:00,854: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) revenue,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-20 16:11:00,869: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-20 16:11:08,455: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064e2438>]}
2018-03-20 16:11:08,711: 16:11:08 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 8.30s]
2018-03-20 16:11:15,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993e470>]}
2018-03-20 16:11:15,780: 16:11:15 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 14.98s]
2018-03-20 16:11:15,781: 16:11:15 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-20 16:11:15,782: Compiling model.seo_audit.agg_indicative
2018-03-20 16:11:15,790: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-20 16:11:15,793: Acquiring new bigquery connection "agg_indicative".
2018-03-20 16:11:15,793: Re-using an available connection from the pool.
2018-03-20 16:11:16,534: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-20 16:11:20,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493ac8>]}
2018-03-20 16:11:21,148: 16:11:21 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 5.13s]
2018-03-20 16:11:21,149: 16:11:21 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-20 16:11:21,150: Compiling model.seo_audit.dates
2018-03-20 16:11:21,160: Writing injected SQL for node "model.seo_audit.dates"
2018-03-20 16:11:21,165: Acquiring new bigquery connection "dates".
2018-03-20 16:11:21,165: Re-using an available connection from the pool.
2018-03-20 16:11:22,089: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-20 16:11:24,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993e470>]}
2018-03-20 16:11:24,540: 16:11:24 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.12s]
2018-03-20 16:11:24,541: 16:11:24 | 37 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-20 16:11:24,541: Compiling model.seo_audit.search_console_history
2018-03-20 16:11:24,541: 16:11:24 | 38 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-20 16:11:24,548: Compiling model.seo_audit.ga_stats
2018-03-20 16:11:24,550: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-20 16:11:24,556: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-20 16:11:24,558: Acquiring new bigquery connection "ga_stats".
2018-03-20 16:11:24,558: Re-using an available connection from the pool.
2018-03-20 16:11:24,561: Acquiring new bigquery connection "search_console_history".
2018-03-20 16:11:24,561: Re-using an available connection from the pool.
2018-03-20 16:11:25,262: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-20 16:11:25,361: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-20 16:11:28,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493ac8>]}
2018-03-20 16:11:28,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a05ef0>]}
2018-03-20 16:11:28,766: 16:11:28 | 37 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.00s]
2018-03-20 16:11:29,020: 16:11:29 | 38 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 4.11s]
2018-03-20 16:11:29,021: 16:11:29 | 39 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-20 16:11:29,021: 16:11:29 | 40 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-20 16:11:29,021: Compiling model.seo_audit.search_console_stats_keyword
2018-03-20 16:11:29,022: Compiling model.seo_audit.search_console_stats_url
2018-03-20 16:11:29,034: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-20 16:11:29,036: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-20 16:11:29,038: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-20 16:11:29,038: Acquiring new bigquery connection "search_console_stats_url".
2018-03-20 16:11:29,038: Re-using an available connection from the pool.
2018-03-20 16:11:29,039: Re-using an available connection from the pool.
2018-03-20 16:11:29,873: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-20 16:11:29,874: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-20 16:11:32,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993e470>]}
2018-03-20 16:11:32,081: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999ff98>]}
2018-03-20 16:11:32,280: 16:11:32 | 39 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.04s]
2018-03-20 16:11:32,512: 16:11:32 | 40 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.06s]
2018-03-20 16:11:32,513: 16:11:32 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-20 16:11:32,514: Compiling model.seo_audit.agg_stats
2018-03-20 16:11:32,526: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-20 16:11:32,527: Acquiring new bigquery connection "agg_stats".
2018-03-20 16:11:32,527: Re-using an available connection from the pool.
2018-03-20 16:11:33,278: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-20 16:11:37,648: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999f400>]}
2018-03-20 16:11:38,350: 16:11:38 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 5.13s]
2018-03-20 16:11:38,351: 16:11:38 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-20 16:11:38,351: Compiling model.seo_audit.agg_stats_client
2018-03-20 16:11:38,365: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-20 16:11:38,367: Acquiring new bigquery connection "agg_stats_client".
2018-03-20 16:11:38,367: Re-using an available connection from the pool.
2018-03-20 16:11:39,009: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(revenue_30d) revenue_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(revenue_mom) revenue_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(revenue_yoy) revenue_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-20 16:11:49,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999ff98>]}
2018-03-20 16:11:50,085: 16:11:50 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 11.51s]
2018-03-20 16:11:50,086: 16:11:50 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-20 16:11:50,087: Compiling model.seo_audit.agg_all
2018-03-20 16:11:50,095: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-20 16:11:50,096: Acquiring new bigquery connection "agg_all".
2018-03-20 16:11:50,096: Re-using an available connection from the pool.
2018-03-20 16:11:50,965: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-20 16:12:01,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999f400>]}
2018-03-20 16:12:02,139: 16:12:02 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 11.84s]
2018-03-20 16:12:02,140: 16:12:02 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-20 16:12:02,140: Compiling model.seo_audit.actions_proc
2018-03-20 16:12:02,149: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-20 16:12:02,153: Acquiring new bigquery connection "actions_proc".
2018-03-20 16:12:02,153: Re-using an available connection from the pool.
2018-03-20 16:12:02,946: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
coalesce(found_at_sitemap, sitemap) sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and ( sitemap is not null or found_at_sitemap is not null ) then concat('remove from sitemap: ', coalesce(found_at_sitemap, sitemap) ) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and found_at_sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = '' then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = ''  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = '' then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 2000 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-20 16:12:08,390: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999ff98>]}
2018-03-20 16:12:08,629: 16:12:08 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 6.25s]
2018-03-20 16:12:08,630: 16:12:08 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-20 16:12:08,630: Compiling model.seo_audit.actions_hierarchy
2018-03-20 16:12:08,637: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-20 16:12:08,638: Acquiring new bigquery connection "actions_hierarchy".
2018-03-20 16:12:08,638: Re-using an available connection from the pool.
2018-03-20 16:12:09,294: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-20 16:12:13,658: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999f400>]}
2018-03-20 16:12:14,000: 16:12:14 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 5.03s]
2018-03-20 16:12:14,001: 16:12:14 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-20 16:12:14,002: Compiling model.seo_audit.actions_data_studio
2018-03-20 16:12:14,011: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-20 16:12:14,012: Acquiring new bigquery connection "actions_data_studio".
2018-03-20 16:12:14,013: Re-using an available connection from the pool.
2018-03-20 16:12:14,720: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-20 16:12:19,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '911d5bb9-9a5d-46bc-a792-6e2c44badc78', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999ff98>]}
2018-03-20 16:12:19,292: 16:12:19 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 5.05s]
2018-03-20 16:12:19,397: 16:12:19 | 
2018-03-20 16:12:19,397: 16:12:19 | Finished running 46 table models in 197.40s.
2018-03-20 16:12:19,398: Connection 'master' was left open.
2018-03-20 16:12:19,398: 
2018-03-20 16:12:19,398: Completed successfully
2018-03-20 16:12:19,399: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-20 16:12:19,401: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106493748>]}
2018-03-20 16:12:19,610: Flushing usage events
2018-03-21 10:10:01,047: Tracking: tracking
2018-03-21 10:10:01,054: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092ba710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092baa20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092ba198>]}
2018-03-21 10:10:02,123: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-21 10:10:02,143: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-21 10:10:02,150: Parsing core.sql
2018-03-21 10:10:02,173: Parsing adapters/bigquery.sql
2018-03-21 10:10:02,180: Parsing adapters/common.sql
2018-03-21 10:10:02,198: Parsing adapters/postgres.sql
2018-03-21 10:10:02,205: Parsing adapters/redshift.sql
2018-03-21 10:10:02,227: Parsing etc/get_custom_schema.sql
2018-03-21 10:10:02,235: Parsing materializations/archive.sql
2018-03-21 10:10:02,275: Parsing materializations/bigquery.sql
2018-03-21 10:10:02,291: Parsing materializations/helpers.sql
2018-03-21 10:10:02,310: Parsing materializations/incremental.sql
2018-03-21 10:10:02,342: Parsing materializations/table.sql
2018-03-21 10:10:02,366: Parsing materializations/view.sql
2018-03-21 10:10:02,386: Parsing materializations/wrapper.sql
2018-03-21 10:10:02,392: Parsing schema_tests/accepted_values.sql
2018-03-21 10:10:02,398: Parsing schema_tests/not_null.sql
2018-03-21 10:10:02,403: Parsing schema_tests/relationships.sql
2018-03-21 10:10:02,408: Parsing schema_tests/unique.sql
2018-03-21 10:10:02,518: Parsing model.seo_audit.actions_data_studio
2018-03-21 10:10:02,523: Acquiring new bigquery connection "master".
2018-03-21 10:10:02,523: Opening a new connection (0 currently allocated)
2018-03-21 10:10:02,530: Parsing model.seo_audit.actions_hierarchy
2018-03-21 10:10:02,533: Parsing model.seo_audit.actions_proc
2018-03-21 10:10:02,538: Parsing model.seo_audit.accounts_proc
2018-03-21 10:10:02,541: Parsing model.seo_audit.all_dates
2018-03-21 10:10:02,542: Parsing model.seo_audit.dates
2018-03-21 10:10:02,545: Parsing model.seo_audit.mappings_ga_proc
2018-03-21 10:10:02,548: Parsing model.seo_audit.agg_all
2018-03-21 10:10:02,551: Parsing model.seo_audit.agg_indicative
2018-03-21 10:10:02,554: Parsing model.seo_audit.agg_stats
2018-03-21 10:10:02,559: Parsing model.seo_audit.agg_stats_client
2018-03-21 10:10:02,563: Parsing model.seo_audit.deepcrawl_class
2018-03-21 10:10:02,566: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-21 10:10:02,568: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-21 10:10:02,569: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-21 10:10:02,571: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-21 10:10:02,573: Parsing model.seo_audit.deepcrawl_proc
2018-03-21 10:10:02,576: Parsing model.seo_audit.deepcrawl_reclass
2018-03-21 10:10:02,579: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-21 10:10:02,589: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-21 10:10:02,592: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-21 10:10:02,594: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-21 10:10:02,595: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-21 10:10:02,597: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-21 10:10:02,599: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-21 10:10:02,601: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-21 10:10:02,605: Parsing model.seo_audit.deepcrawl_urls
2018-03-21 10:10:02,606: Parsing model.seo_audit.ga_proc
2018-03-21 10:10:02,610: Parsing model.seo_audit.ga_proc_pageviews
2018-03-21 10:10:02,613: Parsing model.seo_audit.ga_stats
2018-03-21 10:10:02,616: Parsing model.seo_audit.majestic_domain_history
2018-03-21 10:10:02,617: Parsing model.seo_audit.majestic_domain_proc
2018-03-21 10:10:02,620: Parsing model.seo_audit.majestic_domain_stats
2018-03-21 10:10:02,622: Parsing model.seo_audit.moz_proc
2018-03-21 10:10:02,625: Parsing model.seo_audit.screamingfrog_proc
2018-03-21 10:10:02,628: Parsing model.seo_audit.search_console_history
2018-03-21 10:10:02,630: Parsing model.seo_audit.search_console_proc
2018-03-21 10:10:02,633: Parsing model.seo_audit.search_console_stats_keyword
2018-03-21 10:10:02,636: Parsing model.seo_audit.search_console_stats_url
2018-03-21 10:10:02,638: Parsing model.seo_audit.semrush_domain_proc
2018-03-21 10:10:02,640: Parsing model.seo_audit.semrush_keyword_history
2018-03-21 10:10:02,643: Parsing model.seo_audit.semrush_keyword_proc
2018-03-21 10:10:02,649: Parsing model.seo_audit.semrush_keyword_stats
2018-03-21 10:10:02,653: Parsing model.seo_audit.semrush_url_history
2018-03-21 10:10:02,657: Parsing model.seo_audit.semrush_url_stats
2018-03-21 10:10:02,660: Parsing model.seo_audit.sitemap_proc
2018-03-21 10:10:02,680: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-21 10:10:02,704: 
2018-03-21 10:10:04,707: 10:10:04 | Concurrency: 4 threads (target='prod')
2018-03-21 10:10:04,708: 10:10:04 | 
2018-03-21 10:10:05,200: 10:10:05 | 1 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-21 10:10:05,200: 10:10:05 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-21 10:10:05,200: Compiling model.seo_audit.deepcrawl_proc
2018-03-21 10:10:05,201: 10:10:05 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-21 10:10:05,201: Compiling model.seo_audit.accounts_proc
2018-03-21 10:10:05,206: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-21 10:10:05,206: Compiling model.seo_audit.all_dates
2018-03-21 10:10:05,212: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-21 10:10:05,215: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-21 10:10:05,217: Acquiring new bigquery connection "accounts_proc".
2018-03-21 10:10:05,217: Opening a new connection (1 currently allocated)
2018-03-21 10:10:05,219: Acquiring new bigquery connection "all_dates".
2018-03-21 10:10:05,219: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-21 10:10:05,220: Opening a new connection (2 currently allocated)
2018-03-21 10:10:05,277: Opening a new connection (3 currently allocated)
2018-03-21 10:10:06,504: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-21 10:10:06,505: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-21 10:10:06,523: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-21 10:10:07,639: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095750f0>]}
2018-03-21 10:10:07,863: 10:10:07 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.43s]
2018-03-21 10:10:08,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546710>]}
2018-03-21 10:10:09,100: 10:10:09 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.55s]
2018-03-21 10:10:22,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575f98>]}
2018-03-21 10:10:22,457: 10:10:22 | 1 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 16.96s]
2018-03-21 10:10:22,457: 10:10:22 | 4 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-21 10:10:22,458: Compiling model.seo_audit.moz_proc
2018-03-21 10:10:22,458: 10:10:22 | 5 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-21 10:10:22,467: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-21 10:10:22,467: Compiling model.seo_audit.majestic_domain_proc
2018-03-21 10:10:22,458: 10:10:22 | 6 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-21 10:10:22,476: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-21 10:10:22,458: 10:10:22 | 7 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-21 10:10:22,477: Compiling model.seo_audit.mappings_ga_proc
2018-03-21 10:10:22,478: Acquiring new bigquery connection "moz_proc".
2018-03-21 10:10:22,493: Re-using an available connection from the pool.
2018-03-21 10:10:22,478: Compiling model.seo_audit.sitemap_proc
2018-03-21 10:10:22,493: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-21 10:10:22,479: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-21 10:10:22,520: Re-using an available connection from the pool.
2018-03-21 10:10:22,523: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-21 10:10:22,525: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-21 10:10:22,525: Re-using an available connection from the pool.
2018-03-21 10:10:22,528: Acquiring new bigquery connection "sitemap_proc".
2018-03-21 10:10:22,529: Opening a new connection (4 currently allocated)
2018-03-21 10:10:23,302: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-21 10:10:23,352: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-21 10:10:23,379: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-21 10:10:23,813: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-21 10:10:25,529: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094bf160>]}
2018-03-21 10:10:25,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546f60>]}
2018-03-21 10:10:25,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575f98>]}
2018-03-21 10:10:25,833: 10:10:25 | 5 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.06s]
2018-03-21 10:10:25,833: 10:10:25 | 8 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-21 10:10:25,834: Compiling model.seo_audit.screamingfrog_proc
2018-03-21 10:10:25,849: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-21 10:10:25,852: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-21 10:10:25,852: Re-using an available connection from the pool.
2018-03-21 10:10:26,057: 10:10:26 | 6 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.12s]
2018-03-21 10:10:26,061: 10:10:26 | 9 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-21 10:10:26,062: Compiling model.seo_audit.semrush_domain_proc
2018-03-21 10:10:26,069: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-21 10:10:26,070: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-21 10:10:26,071: Re-using an available connection from the pool.
2018-03-21 10:10:26,363: 10:10:26 | 4 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.18s]
2018-03-21 10:10:26,363: 10:10:26 | 10 of 46 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-03-21 10:10:26,364: Compiling model.seo_audit.semrush_keyword_proc
2018-03-21 10:10:26,375: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-21 10:10:26,376: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-21 10:10:26,376: Re-using an available connection from the pool.
2018-03-21 10:10:26,736: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-21 10:10:26,782: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-21 10:10:27,159: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-21 10:10:28,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10957c358>]}
2018-03-21 10:10:28,593: 10:10:28 | 7 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 5.90s]
2018-03-21 10:10:28,593: 10:10:28 | 11 of 46 START table model seo_audit.search_console_proc............. [RUN]
2018-03-21 10:10:28,594: Compiling model.seo_audit.search_console_proc
2018-03-21 10:10:28,605: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-21 10:10:28,609: Acquiring new bigquery connection "search_console_proc".
2018-03-21 10:10:28,609: Re-using an available connection from the pool.
2018-03-21 10:10:29,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094bf160>]}
2018-03-21 10:10:29,350: 10:10:29 | 8 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.20s]
2018-03-21 10:10:29,351: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-21 10:10:29,493: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575f98>]}
2018-03-21 10:10:29,812: 10:10:29 | 10 of 46 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 3.13s]
2018-03-21 10:10:30,130: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546f60>]}
2018-03-21 10:10:30,437: 10:10:30 | 9 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 4.07s]
2018-03-21 10:10:33,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10957c358>]}
2018-03-21 10:10:34,181: 10:10:34 | 11 of 46 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 5.29s]
2018-03-21 10:10:34,182: 10:10:34 | 12 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-21 10:10:34,182: 10:10:34 | 13 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-21 10:10:34,182: 10:10:34 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-21 10:10:34,183: Compiling model.seo_audit.semrush_keyword_history
2018-03-21 10:10:34,183: 10:10:34 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-21 10:10:34,183: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-21 10:10:34,183: Compiling model.seo_audit.majestic_domain_history
2018-03-21 10:10:34,190: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-21 10:10:34,190: Compiling model.seo_audit.semrush_url_history
2018-03-21 10:10:34,198: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-21 10:10:34,202: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-21 10:10:34,207: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-21 10:10:34,211: Acquiring new bigquery connection "majestic_domain_history".
2018-03-21 10:10:34,211: Re-using an available connection from the pool.
2018-03-21 10:10:34,212: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-21 10:10:34,212: Re-using an available connection from the pool.
2018-03-21 10:10:34,216: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-21 10:10:34,219: Acquiring new bigquery connection "semrush_url_history".
2018-03-21 10:10:34,220: Re-using an available connection from the pool.
2018-03-21 10:10:34,222: Re-using an available connection from the pool.
2018-03-21 10:10:34,932: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-21 10:10:34,990: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-21 10:10:35,029: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-21 10:10:35,065: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-21 10:10:37,164: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bec88>]}
2018-03-21 10:10:37,222: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546ba8>]}
2018-03-21 10:10:37,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094cac18>]}
2018-03-21 10:10:37,405: 10:10:37 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.98s]
2018-03-21 10:10:37,608: 10:10:37 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.03s]
2018-03-21 10:10:37,879: 10:10:37 | 12 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.09s]
2018-03-21 10:11:03,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094ca668>]}
2018-03-21 10:11:03,959: 10:11:03 | 13 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 29.07s]
2018-03-21 10:11:03,960: 10:11:03 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-21 10:11:03,960: Compiling model.seo_audit.deepcrawl_class
2018-03-21 10:11:03,971: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-21 10:11:03,973: Acquiring new bigquery connection "deepcrawl_class".
2018-03-21 10:11:03,973: Re-using an available connection from the pool.
2018-03-21 10:11:04,770: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-21 10:11:16,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546f60>]}
2018-03-21 10:11:16,331: 10:11:16 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 12.07s]
2018-03-21 10:11:16,332: 10:11:16 | 17 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-21 10:11:16,333: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-21 10:11:16,332: 10:11:16 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-21 10:11:16,340: Compiling model.seo_audit.semrush_keyword_stats
2018-03-21 10:11:16,342: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-21 10:11:16,347: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-21 10:11:16,332: 10:11:16 | 19 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-21 10:11:16,347: Compiling model.seo_audit.deepcrawl_urls
2018-03-21 10:11:16,352: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-21 10:11:16,333: 10:11:16 | 20 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-21 10:11:16,352: Compiling model.seo_audit.majestic_domain_stats
2018-03-21 10:11:16,357: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-21 10:11:16,359: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-21 10:11:16,360: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-21 10:11:16,360: Re-using an available connection from the pool.
2018-03-21 10:11:16,360: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-21 10:11:16,361: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-21 10:11:16,361: Re-using an available connection from the pool.
2018-03-21 10:11:16,363: Re-using an available connection from the pool.
2018-03-21 10:11:16,369: Re-using an available connection from the pool.
2018-03-21 10:11:17,165: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-21 10:11:17,166: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-21 10:11:17,167: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-21 10:11:17,167: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-21 10:11:19,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094ec438>]}
2018-03-21 10:11:19,505: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10957c358>]}
2018-03-21 10:11:19,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10957cac8>]}
2018-03-21 10:11:19,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109520a20>]}
2018-03-21 10:11:19,793: 10:11:19 | 20 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.14s]
2018-03-21 10:11:19,795: 10:11:19 | 21 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-21 10:11:19,798: Compiling model.seo_audit.semrush_url_stats
2018-03-21 10:11:19,809: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-21 10:11:19,812: Acquiring new bigquery connection "semrush_url_stats".
2018-03-21 10:11:19,812: Re-using an available connection from the pool.
2018-03-21 10:11:20,111: 10:11:20 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.17s]
2018-03-21 10:11:20,452: 10:11:20 | 19 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.16s]
2018-03-21 10:11:20,587: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-21 10:11:20,847: 10:11:20 | 17 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.18s]
2018-03-21 10:11:22,836: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094ec438>]}
2018-03-21 10:11:23,149: 10:11:23 | 21 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.04s]
2018-03-21 10:11:23,150: 10:11:23 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-21 10:11:23,150: 10:11:23 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-21 10:11:23,150: 10:11:23 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-21 10:11:23,151: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-21 10:11:23,151: 10:11:23 | 25 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-21 10:11:23,151: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-21 10:11:23,151: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-21 10:11:23,158: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-21 10:11:23,159: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-21 10:11:23,167: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-21 10:11:23,173: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-21 10:11:23,177: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-21 10:11:23,179: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-21 10:11:23,179: Re-using an available connection from the pool.
2018-03-21 10:11:23,181: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-21 10:11:23,182: Re-using an available connection from the pool.
2018-03-21 10:11:23,183: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-21 10:11:23,184: Re-using an available connection from the pool.
2018-03-21 10:11:23,187: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-21 10:11:23,187: Re-using an available connection from the pool.
2018-03-21 10:11:23,917: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-21 10:11:23,930: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:11:23,934: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:11:23,969: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-21 10:11:25,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:11:25,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:11:25,256: 10:11:25 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.89s]
2018-03-21 10:11:25,257: 10:11:25 | 26 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-21 10:11:25,257: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-21 10:11:25,265: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-21 10:11:25,268: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-21 10:11:25,268: Re-using an available connection from the pool.
2018-03-21 10:11:25,549: 10:11:25 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.91s]
2018-03-21 10:11:25,549: 10:11:25 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-21 10:11:25,551: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-21 10:11:25,556: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-21 10:11:25,557: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-21 10:11:25,557: Re-using an available connection from the pool.
2018-03-21 10:11:26,182: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095c2d68>]}
2018-03-21 10:11:26,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546f60>]}
2018-03-21 10:11:26,433: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:11:26,541: 10:11:26 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.02s]
2018-03-21 10:11:26,700: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-21 10:11:26,812: 10:11:26 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.07s]
2018-03-21 10:11:27,585: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:11:27,885: 10:11:27 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.33s]
2018-03-21 10:11:29,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:11:29,393: 10:11:29 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.46s]
2018-03-21 10:11:29,394: 10:11:29 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-21 10:11:29,395: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-21 10:11:29,395: 10:11:29 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-21 10:11:29,401: 10:11:29 | 30 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-21 10:11:29,403: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-21 10:11:29,403: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-21 10:11:29,404: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-21 10:11:29,409: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-21 10:11:29,413: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-21 10:11:29,414: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-21 10:11:29,414: Re-using an available connection from the pool.
2018-03-21 10:11:29,415: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-21 10:11:29,415: Re-using an available connection from the pool.
2018-03-21 10:11:29,419: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-21 10:11:29,419: Re-using an available connection from the pool.
2018-03-21 10:11:30,499: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-21 10:11:30,840: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-21 10:11:30,840: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-21 10:11:31,864: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546710>]}
2018-03-21 10:11:32,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094ec438>]}
2018-03-21 10:11:32,116: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093c9198>]}
2018-03-21 10:11:32,490: 10:11:32 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.46s]
2018-03-21 10:11:33,210: 10:11:33 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.72s]
2018-03-21 10:11:33,741: 10:11:33 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.71s]
2018-03-21 10:11:33,742: 10:11:33 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-21 10:11:33,742: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-21 10:11:33,756: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-21 10:11:33,756: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-21 10:11:33,756: Re-using an available connection from the pool.
2018-03-21 10:11:35,409: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-21 10:11:46,678: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:11:46,973: 10:11:46 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 12.94s]
2018-03-21 10:11:46,974: 10:11:46 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-21 10:11:46,974: Compiling model.seo_audit.deepcrawl_reclass
2018-03-21 10:11:46,984: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-21 10:11:46,987: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-21 10:11:46,987: Re-using an available connection from the pool.
2018-03-21 10:11:47,793: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-21 10:11:57,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:11:58,673: 10:11:58 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 10.94s]
2018-03-21 10:11:58,674: 10:11:58 | 33 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-21 10:11:58,674: Compiling model.seo_audit.agg_indicative
2018-03-21 10:11:58,684: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-21 10:11:58,685: Acquiring new bigquery connection "agg_indicative".
2018-03-21 10:11:58,685: Re-using an available connection from the pool.
2018-03-21 10:11:59,553: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-21 10:12:04,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093d4a20>]}
2018-03-21 10:12:04,317: 10:12:04 | 33 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 5.35s]
2018-03-21 10:12:04,318: 10:12:04 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-21 10:12:04,319: Compiling model.seo_audit.ga_proc_pageviews
2018-03-21 10:12:04,319: 10:12:04 | 35 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-21 10:12:04,326: Compiling model.seo_audit.ga_proc
2018-03-21 10:12:04,338: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-21 10:12:04,344: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-21 10:12:04,348: Acquiring new bigquery connection "ga_proc".
2018-03-21 10:12:04,348: Re-using an available connection from the pool.
2018-03-21 10:12:04,349: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-21 10:12:04,351: Re-using an available connection from the pool.
2018-03-21 10:12:05,235: Model SQL (ga_proc):
SELECT
date,
unix_date,
account,
client,
platform,
url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions

FROM
( 
	SELECT 
	date,
	unix_date,
	a.account,
	c.client,
	a.platform,
	case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
		else a.url_stripped end as url,
	sessions,
	revenue,
	transactions
	FROM

	( 

		SELECT 
		date,
		unix_date,
		account,
		platform,
		lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
		lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
		sum(sessions) sessions,
		sum(revenue) revenue,
		sum(transactions) transactions
		FROM (
			SELECT 
			date,
			unix_date(date) unix_date,
			account,
			'Google Analytics' as platform,
			hostname,
			first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
			path,
			source,
			medium,
			max(sessions) sessions,
			max(leads) revenue,
			max(transactions) transactions
			FROM `curious-domain-121318.seo_audit.ga` 
			where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
			and path != "(not set)"
			and medium = 'organic'
			group by date, account, platform, source, medium, hostname, path
			)
		group by date, unix_date, account, platform, url, url_stripped
	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
	ON (
		a.url = b.url
		)
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
	ON (
		a.platform = c.platform and
		a.account = c.account
	)
)	
GROUP BY 
	date, unix_date, account, client, platform, url
2018-03-21 10:12:05,251: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
client,
platform,
url,
sum(pageviews) pageviews
FROM

( 
	SELECT 
	date,
	unix_date,
	a.account,
	c.client,
	a.platform,
	case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
		else a.url_stripped end as url,
	pageviews
	FROM

	( 
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
		lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
		max(pageviews) pageviews
		FROM `curious-domain-121318.seo_audit.ga_pageviews` 
		where account in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
		and path != "(not set)"
		group by date, account, platform, url, url_stripped

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
	ON (
		a.url = b.url
		)
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
	ON (
		a.platform = c.platform and
		a.account = c.account
	)
)
	
GROUP BY 
date, unix_date, client, account, platform, url
2018-03-21 10:12:09,778: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:12:10,434: 10:12:10 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 5.46s]
2018-03-21 10:12:10,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:12:11,134: 10:12:11 | 35 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 6.52s]
2018-03-21 10:12:11,135: 10:12:11 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-21 10:12:11,135: Compiling model.seo_audit.dates
2018-03-21 10:12:11,143: Writing injected SQL for node "model.seo_audit.dates"
2018-03-21 10:12:11,146: Acquiring new bigquery connection "dates".
2018-03-21 10:12:11,146: Re-using an available connection from the pool.
2018-03-21 10:12:11,944: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-21 10:12:14,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:12:14,483: 10:12:14 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.04s]
2018-03-21 10:12:14,484: 10:12:14 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-21 10:12:14,484: Compiling model.seo_audit.ga_stats
2018-03-21 10:12:14,484: 10:12:14 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-21 10:12:14,491: Compiling model.seo_audit.search_console_history
2018-03-21 10:12:14,496: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-21 10:12:14,498: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-21 10:12:14,499: Acquiring new bigquery connection "search_console_history".
2018-03-21 10:12:14,499: Re-using an available connection from the pool.
2018-03-21 10:12:14,501: Acquiring new bigquery connection "ga_stats".
2018-03-21 10:12:14,501: Re-using an available connection from the pool.
2018-03-21 10:12:15,247: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-21 10:12:15,254: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-21 10:12:17,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093c3cc0>]}
2018-03-21 10:12:17,748: 10:12:17 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.99s]
2018-03-21 10:12:19,798: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:12:20,084: 10:12:20 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 5.31s]
2018-03-21 10:12:20,084: 10:12:20 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-21 10:12:20,085: 10:12:20 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-21 10:12:20,085: Compiling model.seo_audit.search_console_stats_url
2018-03-21 10:12:20,085: Compiling model.seo_audit.search_console_stats_keyword
2018-03-21 10:12:20,100: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-21 10:12:20,101: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-21 10:12:20,102: Acquiring new bigquery connection "search_console_stats_url".
2018-03-21 10:12:20,102: Re-using an available connection from the pool.
2018-03-21 10:12:20,104: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-21 10:12:20,104: Re-using an available connection from the pool.
2018-03-21 10:12:20,873: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-21 10:12:20,873: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-21 10:12:23,113: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095bd630>]}
2018-03-21 10:12:23,124: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575940>]}
2018-03-21 10:12:23,404: 10:12:23 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.03s]
2018-03-21 10:12:23,644: 10:12:23 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.04s]
2018-03-21 10:12:23,646: 10:12:23 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-21 10:12:23,646: Compiling model.seo_audit.agg_stats
2018-03-21 10:12:23,656: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-21 10:12:23,659: Acquiring new bigquery connection "agg_stats".
2018-03-21 10:12:23,659: Re-using an available connection from the pool.
2018-03-21 10:12:24,673: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-21 10:12:29,193: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:12:29,443: 10:12:29 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 5.55s]
2018-03-21 10:12:29,444: 10:12:29 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-21 10:12:29,445: Compiling model.seo_audit.agg_stats_client
2018-03-21 10:12:29,453: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-21 10:12:29,454: Acquiring new bigquery connection "agg_stats_client".
2018-03-21 10:12:29,454: Re-using an available connection from the pool.
2018-03-21 10:12:30,274: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(revenue_30d) revenue_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(revenue_mom) revenue_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(revenue_yoy) revenue_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-21 10:13:43,365: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575940>]}
2018-03-21 10:13:44,059: 10:13:44 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 73.92s]
2018-03-21 10:13:44,060: 10:13:44 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-21 10:13:44,060: Compiling model.seo_audit.agg_all
2018-03-21 10:13:44,066: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-21 10:13:44,070: Acquiring new bigquery connection "agg_all".
2018-03-21 10:13:44,070: Re-using an available connection from the pool.
2018-03-21 10:13:45,049: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-21 10:13:58,459: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:13:58,694: 10:13:58 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 14.40s]
2018-03-21 10:13:58,695: 10:13:58 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-21 10:13:58,696: Compiling model.seo_audit.actions_proc
2018-03-21 10:13:58,705: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-21 10:13:58,711: Acquiring new bigquery connection "actions_proc".
2018-03-21 10:13:58,711: Re-using an available connection from the pool.
2018-03-21 10:13:59,674: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
coalesce(found_at_sitemap, sitemap) sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and ( sitemap is not null or found_at_sitemap is not null ) then concat('remove from sitemap: ', coalesce(found_at_sitemap, sitemap) ) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and found_at_sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = '' then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = ''  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = '' then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 2000 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-21 10:14:04,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575940>]}
2018-03-21 10:14:04,498: 10:14:04 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 5.50s]
2018-03-21 10:14:04,498: 10:14:04 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-21 10:14:04,499: Compiling model.seo_audit.actions_hierarchy
2018-03-21 10:14:04,508: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-21 10:14:04,510: Acquiring new bigquery connection "actions_hierarchy".
2018-03-21 10:14:04,510: Re-using an available connection from the pool.
2018-03-21 10:14:05,609: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-21 10:14:08,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575cc0>]}
2018-03-21 10:14:09,271: 10:14:09 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 4.47s]
2018-03-21 10:14:09,272: 10:14:09 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-21 10:14:09,272: Compiling model.seo_audit.actions_data_studio
2018-03-21 10:14:09,280: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-21 10:14:09,282: Acquiring new bigquery connection "actions_data_studio".
2018-03-21 10:14:09,282: Re-using an available connection from the pool.
2018-03-21 10:14:10,116: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-21 10:14:13,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab388523-08db-45ec-95a9-d69059c9fea6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109575940>]}
2018-03-21 10:14:13,787: 10:14:13 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 4.23s]
2018-03-21 10:14:13,822: 10:14:13 | 
2018-03-21 10:14:13,822: 10:14:13 | Finished running 46 table models in 249.12s.
2018-03-21 10:14:13,822: Connection 'master' was left open.
2018-03-21 10:14:13,823: 
2018-03-21 10:14:13,823: Completed successfully
2018-03-21 10:14:13,824: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-21 10:14:13,824: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109392908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093927b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092baef0>]}
2018-03-21 10:14:14,126: Flushing usage events
2018-03-21 10:33:11,880: Tracking: tracking
2018-03-21 10:33:11,888: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88dda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88de48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88d9e8>]}
2018-03-21 10:33:12,642: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-21 10:33:12,670: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-21 10:33:12,674: Parsing core.sql
2018-03-21 10:33:12,706: Parsing adapters/bigquery.sql
2018-03-21 10:33:12,717: Parsing adapters/common.sql
2018-03-21 10:33:12,735: Parsing adapters/postgres.sql
2018-03-21 10:33:12,742: Parsing adapters/redshift.sql
2018-03-21 10:33:12,767: Parsing etc/get_custom_schema.sql
2018-03-21 10:33:12,777: Parsing materializations/archive.sql
2018-03-21 10:33:12,813: Parsing materializations/bigquery.sql
2018-03-21 10:33:12,830: Parsing materializations/helpers.sql
2018-03-21 10:33:12,865: Parsing materializations/incremental.sql
2018-03-21 10:33:12,921: Parsing materializations/table.sql
2018-03-21 10:33:12,952: Parsing materializations/view.sql
2018-03-21 10:33:12,977: Parsing materializations/wrapper.sql
2018-03-21 10:33:12,987: Parsing schema_tests/accepted_values.sql
2018-03-21 10:33:12,998: Parsing schema_tests/not_null.sql
2018-03-21 10:33:13,006: Parsing schema_tests/relationships.sql
2018-03-21 10:33:13,012: Parsing schema_tests/unique.sql
2018-03-21 10:33:13,090: Parsing model.seo_audit.actions_data_studio
2018-03-21 10:33:13,093: Acquiring new bigquery connection "master".
2018-03-21 10:33:13,093: Opening a new connection (0 currently allocated)
2018-03-21 10:33:13,100: Parsing model.seo_audit.actions_hierarchy
2018-03-21 10:33:13,104: Parsing model.seo_audit.actions_proc
2018-03-21 10:33:13,108: Parsing model.seo_audit.accounts_proc
2018-03-21 10:33:13,111: Parsing model.seo_audit.all_dates
2018-03-21 10:33:13,112: Parsing model.seo_audit.dates
2018-03-21 10:33:13,115: Parsing model.seo_audit.mappings_ga_proc
2018-03-21 10:33:13,117: Parsing model.seo_audit.agg_all
2018-03-21 10:33:13,121: Parsing model.seo_audit.agg_indicative
2018-03-21 10:33:13,123: Parsing model.seo_audit.agg_stats
2018-03-21 10:33:13,129: Parsing model.seo_audit.agg_stats_client
2018-03-21 10:33:13,132: Parsing model.seo_audit.deepcrawl_class
2018-03-21 10:33:13,134: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-21 10:33:13,136: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-21 10:33:13,139: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-21 10:33:13,142: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-21 10:33:13,144: Parsing model.seo_audit.deepcrawl_proc
2018-03-21 10:33:13,147: Parsing model.seo_audit.deepcrawl_reclass
2018-03-21 10:33:13,150: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-21 10:33:13,157: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-21 10:33:13,160: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-21 10:33:13,161: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-21 10:33:13,163: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-21 10:33:13,164: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-21 10:33:13,168: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-21 10:33:13,172: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-21 10:33:13,179: Parsing model.seo_audit.deepcrawl_urls
2018-03-21 10:33:13,182: Parsing model.seo_audit.ga_proc
2018-03-21 10:33:13,186: Parsing model.seo_audit.ga_proc_pageviews
2018-03-21 10:33:13,190: Parsing model.seo_audit.ga_stats
2018-03-21 10:33:13,193: Parsing model.seo_audit.majestic_domain_history
2018-03-21 10:33:13,194: Parsing model.seo_audit.majestic_domain_proc
2018-03-21 10:33:13,198: Parsing model.seo_audit.majestic_domain_stats
2018-03-21 10:33:13,203: Parsing model.seo_audit.moz_proc
2018-03-21 10:33:13,208: Parsing model.seo_audit.screamingfrog_proc
2018-03-21 10:33:13,214: Parsing model.seo_audit.search_console_history
2018-03-21 10:33:13,217: Parsing model.seo_audit.search_console_proc
2018-03-21 10:33:13,220: Parsing model.seo_audit.search_console_stats_keyword
2018-03-21 10:33:13,223: Parsing model.seo_audit.search_console_stats_url
2018-03-21 10:33:13,224: Parsing model.seo_audit.semrush_domain_proc
2018-03-21 10:33:13,227: Parsing model.seo_audit.semrush_keyword_history
2018-03-21 10:33:13,230: Parsing model.seo_audit.semrush_keyword_proc
2018-03-21 10:33:13,234: Parsing model.seo_audit.semrush_keyword_stats
2018-03-21 10:33:13,236: Parsing model.seo_audit.semrush_url_history
2018-03-21 10:33:13,238: Parsing model.seo_audit.semrush_url_stats
2018-03-21 10:33:13,241: Parsing model.seo_audit.sitemap_proc
2018-03-21 10:33:13,255: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-21 10:33:13,272: 
2018-03-21 10:33:14,586: 10:33:14 | Concurrency: 4 threads (target='prod')
2018-03-21 10:33:14,586: 10:33:14 | 
2018-03-21 10:33:15,040: 10:33:15 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-21 10:33:15,041: Compiling model.seo_audit.all_dates
2018-03-21 10:33:15,044: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-21 10:33:15,040: 10:33:15 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-21 10:33:15,045: Compiling model.seo_audit.accounts_proc
2018-03-21 10:33:15,050: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-21 10:33:15,041: 10:33:15 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-21 10:33:15,051: Compiling model.seo_audit.deepcrawl_proc
2018-03-21 10:33:15,056: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-21 10:33:15,057: Acquiring new bigquery connection "accounts_proc".
2018-03-21 10:33:15,058: Acquiring new bigquery connection "all_dates".
2018-03-21 10:33:15,058: Opening a new connection (1 currently allocated)
2018-03-21 10:33:15,060: Opening a new connection (2 currently allocated)
2018-03-21 10:33:15,117: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-21 10:33:15,123: Opening a new connection (3 currently allocated)
2018-03-21 10:33:16,403: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-21 10:33:16,404: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-21 10:33:16,421: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-21 10:33:17,529: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9e9c50>]}
2018-03-21 10:33:17,779: 10:33:17 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.49s]
2018-03-21 10:33:18,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da6a4e0>]}
2018-03-21 10:33:18,901: 10:33:18 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.62s]
2018-03-21 10:33:34,320: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da89208>]}
2018-03-21 10:33:34,636: 10:33:34 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 19.27s]
2018-03-21 10:33:34,636: 10:33:34 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-21 10:33:34,637: 10:33:34 | 5 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-21 10:33:34,637: Compiling model.seo_audit.search_console_proc
2018-03-21 10:33:34,637: 10:33:34 | 6 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-21 10:33:34,637: 10:33:34 | 7 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-21 10:33:34,637: Compiling model.seo_audit.screamingfrog_proc
2018-03-21 10:33:34,644: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-21 10:33:34,645: Compiling model.seo_audit.majestic_domain_proc
2018-03-21 10:33:34,645: Compiling model.seo_audit.mappings_ga_proc
2018-03-21 10:33:34,653: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-21 10:33:34,660: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-21 10:33:34,666: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-21 10:33:34,667: Acquiring new bigquery connection "search_console_proc".
2018-03-21 10:33:34,668: Re-using an available connection from the pool.
2018-03-21 10:33:34,671: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-21 10:33:34,672: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-21 10:33:34,674: Re-using an available connection from the pool.
2018-03-21 10:33:34,674: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-21 10:33:34,676: Re-using an available connection from the pool.
2018-03-21 10:33:34,678: Opening a new connection (4 currently allocated)
2018-03-21 10:33:35,445: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-21 10:33:35,478: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-21 10:33:35,614: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-21 10:33:36,162: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-21 10:33:37,702: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b3208>]}
2018-03-21 10:33:37,718: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d94cbe0>]}
2018-03-21 10:33:37,908: 10:33:37 | 5 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.06s]
2018-03-21 10:33:37,908: 10:33:37 | 8 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-21 10:33:37,908: Compiling model.seo_audit.sitemap_proc
2018-03-21 10:33:37,932: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-21 10:33:37,933: Acquiring new bigquery connection "sitemap_proc".
2018-03-21 10:33:37,934: Re-using an available connection from the pool.
2018-03-21 10:33:38,246: 10:33:38 | 6 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.07s]
2018-03-21 10:33:38,246: 10:33:38 | 9 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-21 10:33:38,247: Compiling model.seo_audit.semrush_keyword_proc
2018-03-21 10:33:38,260: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-21 10:33:38,261: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-21 10:33:38,261: Re-using an available connection from the pool.
2018-03-21 10:33:38,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9c0208>]}
2018-03-21 10:33:38,681: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-21 10:33:38,805: 10:33:38 | 7 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.84s]
2018-03-21 10:33:38,806: 10:33:38 | 10 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-21 10:33:38,806: Compiling model.seo_audit.moz_proc
2018-03-21 10:33:38,821: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-21 10:33:38,823: Acquiring new bigquery connection "moz_proc".
2018-03-21 10:33:38,824: Re-using an available connection from the pool.
2018-03-21 10:33:38,996: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-21 10:33:39,673: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-21 10:33:40,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da915c0>]}
2018-03-21 10:33:40,505: 10:33:40 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.58s]
2018-03-21 10:33:40,506: 10:33:40 | 11 of 46 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-03-21 10:33:40,506: Compiling model.seo_audit.semrush_domain_proc
2018-03-21 10:33:40,521: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-21 10:33:40,536: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-21 10:33:40,537: Re-using an available connection from the pool.
2018-03-21 10:33:41,413: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-21 10:33:41,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da6ab38>]}
2018-03-21 10:33:42,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b3208>]}
2018-03-21 10:33:42,177: 10:33:42 | 10 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 3.12s]
2018-03-21 10:33:42,378: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d94cbe0>]}
2018-03-21 10:33:42,455: 10:33:42 | 8 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.13s]
2018-03-21 10:33:42,666: 10:33:42 | 9 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.13s]
2018-03-21 10:33:43,659: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da915c0>]}
2018-03-21 10:33:43,919: 10:33:43 | 11 of 46 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 3.15s]
2018-03-21 10:33:43,920: 10:33:43 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-21 10:33:43,920: Compiling model.seo_audit.majestic_domain_history
2018-03-21 10:33:43,929: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-21 10:33:43,930: Acquiring new bigquery connection "majestic_domain_history".
2018-03-21 10:33:43,931: Re-using an available connection from the pool.
2018-03-21 10:33:43,933: 10:33:43 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-21 10:33:43,934: Compiling model.seo_audit.semrush_url_history
2018-03-21 10:33:43,944: 10:33:43 | 14 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-21 10:33:43,945: Compiling model.seo_audit.semrush_keyword_history
2018-03-21 10:33:43,956: 10:33:43 | 15 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-21 10:33:43,956: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-21 10:33:43,971: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-21 10:33:43,976: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-21 10:33:43,977: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-21 10:33:43,977: Re-using an available connection from the pool.
2018-03-21 10:33:43,986: Acquiring new bigquery connection "semrush_url_history".
2018-03-21 10:33:43,986: Re-using an available connection from the pool.
2018-03-21 10:33:44,011: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-21 10:33:44,013: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-21 10:33:44,013: Re-using an available connection from the pool.
2018-03-21 10:33:44,746: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-21 10:33:44,755: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-21 10:33:44,779: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-21 10:33:44,845: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-21 10:33:46,970: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da01828>]}
2018-03-21 10:33:46,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a522ba8>]}
2018-03-21 10:33:47,000: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a504dd8>]}
2018-03-21 10:33:47,273: 10:33:47 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.04s]
2018-03-21 10:33:47,543: 10:33:47 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.07s]
2018-03-21 10:33:47,802: 10:33:47 | 14 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.05s]
2018-03-21 10:34:16,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a50df60>]}
2018-03-21 10:34:17,519: 10:34:17 | 15 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 32.98s]
2018-03-21 10:34:17,520: 10:34:17 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-21 10:34:17,520: Compiling model.seo_audit.deepcrawl_class
2018-03-21 10:34:17,528: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-21 10:34:17,531: Acquiring new bigquery connection "deepcrawl_class".
2018-03-21 10:34:17,532: Re-using an available connection from the pool.
2018-03-21 10:34:18,558: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-21 10:34:29,737: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f1cf8>]}
2018-03-21 10:34:30,041: 10:34:30 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 12.22s]
2018-03-21 10:34:30,042: 10:34:30 | 17 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-21 10:34:30,042: 10:34:30 | 18 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-21 10:34:30,042: 10:34:30 | 19 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-21 10:34:30,043: 10:34:30 | 20 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-21 10:34:30,043: Compiling model.seo_audit.deepcrawl_urls
2018-03-21 10:34:30,043: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-21 10:34:30,043: Compiling model.seo_audit.semrush_keyword_stats
2018-03-21 10:34:30,043: Compiling model.seo_audit.semrush_url_stats
2018-03-21 10:34:30,049: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-21 10:34:30,064: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-21 10:34:30,070: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-21 10:34:30,072: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-21 10:34:30,072: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-21 10:34:30,073: Re-using an available connection from the pool.
2018-03-21 10:34:30,074: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-21 10:34:30,075: Acquiring new bigquery connection "semrush_url_stats".
2018-03-21 10:34:30,075: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-21 10:34:30,076: Re-using an available connection from the pool.
2018-03-21 10:34:30,077: Re-using an available connection from the pool.
2018-03-21 10:34:30,080: Re-using an available connection from the pool.
2018-03-21 10:34:30,793: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-21 10:34:30,832: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-21 10:34:30,923: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-21 10:34:31,124: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-21 10:34:33,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b37f0>]}
2018-03-21 10:34:33,089: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da919e8>]}
2018-03-21 10:34:33,323: 10:34:33 | 17 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.98s]
2018-03-21 10:34:33,327: 10:34:33 | 21 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-21 10:34:33,329: Compiling model.seo_audit.majestic_domain_stats
2018-03-21 10:34:33,340: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-21 10:34:33,341: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-21 10:34:33,341: Re-using an available connection from the pool.
2018-03-21 10:34:33,637: 10:34:33 | 20 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.05s]
2018-03-21 10:34:34,123: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-21 10:34:34,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da22e10>]}
2018-03-21 10:34:34,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da77e10>]}
2018-03-21 10:34:34,614: 10:34:34 | 19 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.25s]
2018-03-21 10:34:34,917: 10:34:34 | 18 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 4.42s]
2018-03-21 10:34:36,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b37f0>]}
2018-03-21 10:34:36,648: 10:34:36 | 21 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.03s]
2018-03-21 10:34:36,649: 10:34:36 | 22 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-21 10:34:36,650: 10:34:36 | 23 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-21 10:34:36,650: 10:34:36 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-21 10:34:36,650: 10:34:36 | 25 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-21 10:34:36,650: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-21 10:34:36,651: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-21 10:34:36,651: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-21 10:34:36,651: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-21 10:34:36,657: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-21 10:34:36,663: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-21 10:34:36,669: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-21 10:34:36,673: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-21 10:34:36,675: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-21 10:34:36,675: Re-using an available connection from the pool.
2018-03-21 10:34:36,676: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-21 10:34:36,676: Re-using an available connection from the pool.
2018-03-21 10:34:36,678: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-21 10:34:36,679: Re-using an available connection from the pool.
2018-03-21 10:34:36,685: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-21 10:34:36,686: Re-using an available connection from the pool.
2018-03-21 10:34:37,508: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:34:37,509: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:34:37,509: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-21 10:34:37,512: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-21 10:34:38,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da22e10>]}
2018-03-21 10:34:38,873: 10:34:38 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.01s]
2018-03-21 10:34:38,874: 10:34:38 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-21 10:34:38,874: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-21 10:34:38,880: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-21 10:34:38,882: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-21 10:34:38,882: Re-using an available connection from the pool.
2018-03-21 10:34:39,675: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-21 10:34:39,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5d2940>]}
2018-03-21 10:34:39,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5d2e80>]}
2018-03-21 10:34:39,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f1cf8>]}
2018-03-21 10:34:40,052: 10:34:40 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.10s]
2018-03-21 10:34:40,053: 10:34:40 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-21 10:34:40,053: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-21 10:34:40,080: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-21 10:34:40,084: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-21 10:34:40,085: Re-using an available connection from the pool.
2018-03-21 10:34:40,373: 10:34:40 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.11s]
2018-03-21 10:34:40,665: 10:34:40 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 3.11s]
2018-03-21 10:34:40,999: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-21 10:34:41,912: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da22e10>]}
2018-03-21 10:34:42,227: 10:34:42 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.04s]
2018-03-21 10:34:43,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5d2940>]}
2018-03-21 10:34:43,552: 10:34:43 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.20s]
2018-03-21 10:34:43,552: 10:34:43 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-21 10:34:43,553: 10:34:43 | 29 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-21 10:34:43,553: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-21 10:34:43,553: 10:34:43 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-21 10:34:43,559: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-21 10:34:43,561: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-21 10:34:43,553: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-21 10:34:43,568: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-21 10:34:43,574: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-21 10:34:43,575: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-21 10:34:43,576: Re-using an available connection from the pool.
2018-03-21 10:34:43,577: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-21 10:34:43,577: Re-using an available connection from the pool.
2018-03-21 10:34:43,579: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-21 10:34:43,579: Re-using an available connection from the pool.
2018-03-21 10:34:44,316: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-21 10:34:44,317: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-21 10:34:44,385: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-21 10:34:45,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4fdf98>]}
2018-03-21 10:34:45,452: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da58898>]}
2018-03-21 10:34:45,493: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b37f0>]}
2018-03-21 10:34:45,656: 10:34:45 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.88s]
2018-03-21 10:34:45,892: 10:34:45 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.90s]
2018-03-21 10:34:46,189: 10:34:46 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.94s]
2018-03-21 10:34:46,190: 10:34:46 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-21 10:34:46,190: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-21 10:34:46,211: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-21 10:34:46,212: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-21 10:34:46,212: Re-using an available connection from the pool.
2018-03-21 10:34:46,975: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-21 10:34:59,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d95ed30>]}
2018-03-21 10:34:59,513: 10:34:59 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 13.01s]
2018-03-21 10:34:59,514: 10:34:59 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-21 10:34:59,514: Compiling model.seo_audit.deepcrawl_reclass
2018-03-21 10:34:59,523: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-21 10:34:59,524: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-21 10:34:59,524: Re-using an available connection from the pool.
2018-03-21 10:35:00,447: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-21 10:35:09,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b37f0>]}
2018-03-21 10:35:09,835: 10:35:09 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 10.02s]
2018-03-21 10:35:09,836: 10:35:09 | 33 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-21 10:35:09,837: Compiling model.seo_audit.agg_indicative
2018-03-21 10:35:09,846: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-21 10:35:09,850: Acquiring new bigquery connection "agg_indicative".
2018-03-21 10:35:09,850: Re-using an available connection from the pool.
2018-03-21 10:35:10,907: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-21 10:35:15,455: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d95ed30>]}
2018-03-21 10:35:15,746: 10:35:15 | 33 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 5.62s]
2018-03-21 10:35:15,747: 10:35:15 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-21 10:35:15,748: 10:35:15 | 35 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-21 10:35:15,748: Compiling model.seo_audit.ga_proc_pageviews
2018-03-21 10:35:15,748: Compiling model.seo_audit.ga_proc
2018-03-21 10:35:15,761: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-21 10:35:15,762: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-21 10:35:15,766: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-21 10:35:15,766: Re-using an available connection from the pool.
2018-03-21 10:35:15,767: Acquiring new bigquery connection "ga_proc".
2018-03-21 10:35:15,769: Re-using an available connection from the pool.
2018-03-21 10:35:16,620: Model SQL (ga_proc):
SELECT
date,
unix_date,
account,
client,
platform,
url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions

FROM
( 
	SELECT 
	date,
	unix_date,
	a.account,
	c.client,
	a.platform,
	case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
		else a.url_stripped end as url,
	sessions,
	revenue,
	transactions
	FROM

	( 

		SELECT 
		date,
		unix_date,
		account,
		platform,
		lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
		lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
		sum(sessions) sessions,
		sum(revenue) revenue,
		sum(transactions) transactions
		FROM (
			SELECT 
			date,
			unix_date(date) unix_date,
			account,
			'Google Analytics' as platform,
			hostname,
			first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
			path,
			source,
			medium,
			max(sessions) sessions,
			max(leads) revenue,
			max(transactions) transactions
			FROM `curious-domain-121318.seo_audit.ga` 
			where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
			and path != "(not set)"
			and medium = 'organic'
			group by date, account, platform, source, medium, hostname, path
			)
		group by date, unix_date, account, platform, url, url_stripped
	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
	ON (
		a.url = b.url
		)
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
	ON (
		a.platform = c.platform and
		a.account = c.account
	)
)	
GROUP BY 
	date, unix_date, account, client, platform, url
2018-03-21 10:35:16,739: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
client,
platform,
url,
sum(pageviews) pageviews
FROM

( 
	SELECT 
	date,
	unix_date,
	a.account,
	c.client,
	a.platform,
	case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
		else a.url_stripped end as url,
	pageviews
	FROM

	( 
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
		lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
		max(pageviews) pageviews
		FROM `curious-domain-121318.seo_audit.ga_pageviews` 
		where account in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
		and path != "(not set)"
		group by date, account, platform, url, url_stripped

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
	ON (
		a.url = b.url
		)
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
	ON (
		a.platform = c.platform and
		a.account = c.account
	)
)
	
GROUP BY 
date, unix_date, client, account, platform, url
2018-03-21 10:35:22,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9b37f0>]}
2018-03-21 10:35:23,041: 10:35:23 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 6.57s]
2018-03-21 10:35:24,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5dd470>]}
2018-03-21 10:35:24,730: 10:35:24 | 35 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 8.77s]
2018-03-21 10:35:24,731: 10:35:24 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-21 10:35:24,731: Compiling model.seo_audit.dates
2018-03-21 10:35:24,739: Writing injected SQL for node "model.seo_audit.dates"
2018-03-21 10:35:24,742: Acquiring new bigquery connection "dates".
2018-03-21 10:35:24,742: Re-using an available connection from the pool.
2018-03-21 10:35:25,636: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-21 10:35:28,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d95ed30>]}
2018-03-21 10:35:29,197: 10:35:29 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 4.26s]
2018-03-21 10:35:29,198: 10:35:29 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-21 10:35:29,198: 10:35:29 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-21 10:35:29,198: Compiling model.seo_audit.ga_stats
2018-03-21 10:35:29,198: Compiling model.seo_audit.search_console_history
2018-03-21 10:35:29,206: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-21 10:35:29,211: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-21 10:35:29,212: Acquiring new bigquery connection "ga_stats".
2018-03-21 10:35:29,212: Re-using an available connection from the pool.
2018-03-21 10:35:29,215: Acquiring new bigquery connection "search_console_history".
2018-03-21 10:35:29,215: Re-using an available connection from the pool.
2018-03-21 10:35:30,035: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-21 10:35:30,044: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-21 10:35:32,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da72860>]}
2018-03-21 10:35:32,567: 10:35:32 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.15s]
2018-03-21 10:35:33,383: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da77240>]}
2018-03-21 10:35:33,676: 10:35:33 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.18s]
2018-03-21 10:35:33,677: 10:35:33 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-21 10:35:33,677: 10:35:33 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-21 10:35:33,677: Compiling model.seo_audit.search_console_stats_url
2018-03-21 10:35:33,677: Compiling model.seo_audit.search_console_stats_keyword
2018-03-21 10:35:33,682: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-21 10:35:33,690: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-21 10:35:33,691: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-21 10:35:33,691: Re-using an available connection from the pool.
2018-03-21 10:35:33,693: Acquiring new bigquery connection "search_console_stats_url".
2018-03-21 10:35:33,693: Re-using an available connection from the pool.
2018-03-21 10:35:34,442: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-21 10:35:34,443: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-21 10:35:36,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a50d390>]}
2018-03-21 10:35:36,954: 10:35:36 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.98s]
2018-03-21 10:35:37,770: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a50df98>]}
2018-03-21 10:35:38,089: 10:35:38 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 4.09s]
2018-03-21 10:35:38,090: 10:35:38 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-21 10:35:38,090: Compiling model.seo_audit.agg_stats
2018-03-21 10:35:38,100: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-21 10:35:38,101: Acquiring new bigquery connection "agg_stats".
2018-03-21 10:35:38,101: Re-using an available connection from the pool.
2018-03-21 10:35:38,944: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-21 10:35:42,294: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d95ed30>]}
2018-03-21 10:35:42,608: 10:35:42 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 4.20s]
2018-03-21 10:35:42,609: 10:35:42 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-21 10:35:42,609: Compiling model.seo_audit.agg_stats_client
2018-03-21 10:35:42,620: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-21 10:35:42,621: Acquiring new bigquery connection "agg_stats_client".
2018-03-21 10:35:42,621: Re-using an available connection from the pool.
2018-03-21 10:35:43,434: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
max(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
max(ref_domain_count) as ref_domain_count,
max(avg_trust_flow) as avg_trust_flow,
max(avg_citation_flow) as avg_citation_flow,
max(gsc_keyword_count_90d) as gsc_keyword_count_90d,
max(gsc_impressions_90d) as gsc_impressions_90d,
max(gsc_clicks_90d) as gsc_clicks_90d,	
max(gsc_ctr_90d) as gsc_ctr_90d,
max(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
max(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
max(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
max(semrush_keyword_count) semrush_keyword_count,
max(semrush_total_cpc) semrush_total_cpc,
max(semrush_total_search_volume) semrush_total_search_volume,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
max(sessions_30d) sessions_30d,
max(revenue_30d) revenue_30d,
max(transactions_30d) transactions_30d,
max(pageviews_30d) pageviews_30d,
max(sessions_mom) sessions_mom,
max(revenue_mom) revenue_mom,
max(transactions_mom) transactions_mom,
max(pageviews_mom) pageviews_mom,
max(sessions_yoy) sessions_yoy,
max(revenue_yoy) revenue_yoy,
max(transactions_yoy) transactions_yoy,
max(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-21 10:35:54,578: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da58898>]}
2018-03-21 10:35:54,897: 10:35:54 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 11.97s]
2018-03-21 10:35:54,897: 10:35:54 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-21 10:35:54,898: Compiling model.seo_audit.agg_all
2018-03-21 10:35:54,906: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-21 10:35:54,909: Acquiring new bigquery connection "agg_all".
2018-03-21 10:35:54,910: Re-using an available connection from the pool.
2018-03-21 10:35:55,680: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
#case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
#PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-21 10:36:06,876: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9e9470>]}
2018-03-21 10:36:07,210: 10:36:07 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 11.98s]
2018-03-21 10:36:07,211: 10:36:07 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-21 10:36:07,211: Compiling model.seo_audit.actions_proc
2018-03-21 10:36:07,227: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-21 10:36:07,231: Acquiring new bigquery connection "actions_proc".
2018-03-21 10:36:07,231: Re-using an available connection from the pool.
2018-03-21 10:36:08,131: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
coalesce(found_at_sitemap, sitemap) sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and ( sitemap is not null or found_at_sitemap is not null ) then concat('remove from sitemap: ', coalesce(found_at_sitemap, sitemap) ) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and found_at_sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = '' then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = ''  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = '' then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 2000 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
#lead_conversion_rate_30d,
transaction_conversion_rate_30d,
#med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-21 10:36:14,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da58898>]}
2018-03-21 10:36:15,029: 10:36:15 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 7.57s]
2018-03-21 10:36:15,030: 10:36:15 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-21 10:36:15,030: Compiling model.seo_audit.actions_hierarchy
2018-03-21 10:36:15,041: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-21 10:36:15,042: Acquiring new bigquery connection "actions_hierarchy".
2018-03-21 10:36:15,043: Re-using an available connection from the pool.
2018-03-21 10:36:15,913: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
#lead_conversion_rate_30d,
transaction_conversion_rate_30d,
#med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-21 10:36:19,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9e9470>]}
2018-03-21 10:36:19,556: 10:36:19 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 4.23s]
2018-03-21 10:36:19,557: 10:36:19 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-21 10:36:19,557: Compiling model.seo_audit.actions_data_studio
2018-03-21 10:36:19,564: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-21 10:36:19,565: Acquiring new bigquery connection "actions_data_studio".
2018-03-21 10:36:19,565: Re-using an available connection from the pool.
2018-03-21 10:36:20,388: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
domain,
canonical_url,
canonical_status,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
#lead_conversion_rate_30d,
transaction_conversion_rate_30d,
#med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-21 10:36:23,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9f2907f-2e56-4acd-9bca-032d22836b86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da58898>]}
2018-03-21 10:36:24,338: 10:36:24 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 4.16s]
2018-03-21 10:36:24,420: 10:36:24 | 
2018-03-21 10:36:24,420: 10:36:24 | Finished running 46 table models in 189.83s.
2018-03-21 10:36:24,421: Connection 'master' was left open.
2018-03-21 10:36:24,421: 
2018-03-21 10:36:24,422: Completed successfully
2018-03-21 10:36:24,422: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-21 10:36:24,423: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d94c9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d94c860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8f2550>]}
2018-03-21 10:36:24,728: Flushing usage events
