2018-03-12 17:12:16,273: Tracking: tracking
2018-03-12 17:12:16,285: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056415f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105641390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fb9550>]}
2018-03-12 17:12:17,161: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:12:17,186: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:12:17,190: Parsing core.sql
2018-03-12 17:12:17,213: Parsing adapters/bigquery.sql
2018-03-12 17:12:17,220: Parsing adapters/common.sql
2018-03-12 17:12:17,241: Parsing adapters/postgres.sql
2018-03-12 17:12:17,249: Parsing adapters/redshift.sql
2018-03-12 17:12:17,278: Parsing etc/get_custom_schema.sql
2018-03-12 17:12:17,288: Parsing materializations/archive.sql
2018-03-12 17:12:17,340: Parsing materializations/bigquery.sql
2018-03-12 17:12:17,431: Parsing materializations/helpers.sql
2018-03-12 17:12:17,502: Parsing materializations/incremental.sql
2018-03-12 17:12:17,545: Parsing materializations/table.sql
2018-03-12 17:12:17,571: Parsing materializations/view.sql
2018-03-12 17:12:17,593: Parsing materializations/wrapper.sql
2018-03-12 17:12:17,599: Parsing schema_tests/accepted_values.sql
2018-03-12 17:12:17,606: Parsing schema_tests/not_null.sql
2018-03-12 17:12:17,609: Parsing schema_tests/relationships.sql
2018-03-12 17:12:17,615: Parsing schema_tests/unique.sql
2018-03-12 17:12:17,660: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:12:17,663: Acquiring new bigquery connection "master".
2018-03-12 17:12:17,663: Opening a new connection (0 currently allocated)
2018-03-12 17:12:17,668: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:12:17,672: Parsing model.seo_audit.actions_proc
2018-03-12 17:12:17,681: Parsing model.seo_audit.accounts_proc
2018-03-12 17:12:17,686: Parsing model.seo_audit.all_dates
2018-03-12 17:12:17,688: Parsing model.seo_audit.dates
2018-03-12 17:12:17,693: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:12:17,697: Parsing model.seo_audit.agg_all
2018-03-12 17:12:17,703: Parsing model.seo_audit.agg_indicative
2018-03-12 17:12:17,707: Parsing model.seo_audit.agg_stats
2018-03-12 17:12:17,718: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:12:17,724: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:12:17,729: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:12:17,732: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:12:17,735: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:12:17,739: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:12:17,743: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:12:17,746: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:12:17,751: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:12:17,772: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:12:17,778: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:12:17,782: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:12:17,785: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:12:17,788: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:12:17,793: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:12:17,797: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:12:17,806: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:12:17,810: Parsing model.seo_audit.ga_proc
2018-03-12 17:12:17,820: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:12:17,827: Parsing model.seo_audit.ga_stats
2018-03-12 17:12:17,833: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:12:17,836: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:12:17,842: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:12:17,847: Parsing model.seo_audit.moz_proc
2018-03-12 17:12:17,853: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:12:17,861: Parsing model.seo_audit.search_console_history
2018-03-12 17:12:17,867: Parsing model.seo_audit.search_console_proc
2018-03-12 17:12:17,871: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:12:17,878: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:12:17,881: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:12:17,884: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:12:17,890: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:12:17,901: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:12:17,905: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:12:17,910: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:12:17,921: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:12:17,963: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:12:18,088: 
2018-03-12 17:12:20,015: 17:12:20 | Concurrency: 4 threads (target='prod')
2018-03-12 17:12:20,016: 17:12:20 | 
2018-03-12 17:12:20,452: 17:12:20 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:12:20,453: Compiling model.seo_audit.all_dates
2018-03-12 17:12:20,469: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:12:20,453: 17:12:20 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:12:20,471: Compiling model.seo_audit.accounts_proc
2018-03-12 17:12:20,454: 17:12:20 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:12:20,477: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:12:20,481: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:12:20,489: Acquiring new bigquery connection "all_dates".
2018-03-12 17:12:20,489: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:12:20,490: Opening a new connection (1 currently allocated)
2018-03-12 17:12:20,500: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:12:20,503: Opening a new connection (2 currently allocated)
2018-03-12 17:12:20,621: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:12:20,717: Opening a new connection (3 currently allocated)
2018-03-12 17:12:21,780: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:12:21,785: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT * FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT * FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:12:21,785: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:12:21,785: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT * FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT * FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:12:21,785: 400 Column 68 in UNION ALL has incompatible types: INT64, STRING at [70:5]
2018-03-12 17:12:21,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045c6f60>]}
2018-03-12 17:12:22,074: 17:12:22 | 3 of 46 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 1.31s]
2018-03-12 17:12:23,967: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104436048>]}
2018-03-12 17:12:23,982: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070b0ba8>]}
2018-03-12 17:12:24,257: 17:12:24 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.50s]
2018-03-12 17:12:24,505: 17:12:24 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.53s]
2018-03-12 17:12:24,506: 17:12:24 | 4 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:12:24,507: Compiling model.seo_audit.moz_proc
2018-03-12 17:12:24,506: 17:12:24 | 5 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:12:24,506: 17:12:24 | 6 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:12:24,519: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:12:24,521: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:12:24,506: 17:12:24 | 7 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:12:24,522: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:12:24,535: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:12:24,535: Compiling model.seo_audit.search_console_proc
2018-03-12 17:12:24,551: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:12:24,564: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:12:24,567: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:12:24,568: Re-using an available connection from the pool.
2018-03-12 17:12:24,569: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:12:24,571: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:12:24,572: Re-using an available connection from the pool.
2018-03-12 17:12:24,575: Re-using an available connection from the pool.
2018-03-12 17:12:24,584: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:12:24,587: Opening a new connection (4 currently allocated)
2018-03-12 17:12:25,269: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:12:25,278: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:12:25,402: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:12:25,580: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:12:27,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045f6668>]}
2018-03-12 17:12:27,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104436048>]}
2018-03-12 17:12:27,607: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045f6358>]}
2018-03-12 17:12:27,677: 17:12:27 | 4 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.96s]
2018-03-12 17:12:27,679: 17:12:27 | 8 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:12:27,679: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:12:27,687: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:12:27,693: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:12:27,694: Re-using an available connection from the pool.
2018-03-12 17:12:28,000: 17:12:28 | 5 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.98s]
2018-03-12 17:12:28,001: 17:12:28 | 9 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:12:28,001: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:12:28,009: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:12:28,017: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:12:28,017: Re-using an available connection from the pool.
2018-03-12 17:12:28,290: 17:12:28 | 6 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.08s]
2018-03-12 17:12:28,290: 17:12:28 | 10 of 46 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-03-12 17:12:28,291: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:12:28,299: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:12:28,300: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:12:28,300: Re-using an available connection from the pool.
2018-03-12 17:12:28,568: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:12:28,718: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:12:28,938: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:12:30,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045c8e10>]}
2018-03-12 17:12:31,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045f6358>]}
2018-03-12 17:12:31,207: 17:12:31 | 9 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.92s]
2018-03-12 17:12:31,208: 17:12:31 | 11 of 46 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-03-12 17:12:31,209: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:12:31,221: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:12:31,224: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:12:31,225: Re-using an available connection from the pool.
2018-03-12 17:12:31,442: 17:12:31 | 10 of 46 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.84s]
2018-03-12 17:12:31,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045f6668>]}
2018-03-12 17:12:31,922: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:12:32,184: 17:12:32 | 8 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 4.21s]
2018-03-12 17:12:33,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045c82b0>]}
2018-03-12 17:12:33,450: 17:12:33 | 7 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 8.71s]
2018-03-12 17:12:34,121: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070aa080>]}
2018-03-12 17:12:34,401: 17:12:34 | 11 of 46 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 2.91s]
2018-03-12 17:12:34,401: 17:12:34 | 12 of 46 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-03-12 17:12:34,401: 17:12:34 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:12:34,402: 17:12:34 | 14 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:12:34,402: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:12:34,402: 17:12:34 | 15 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:12:34,402: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:12:34,409: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:12:34,410: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:12:34,426: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:12:34,433: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:12:34,436: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:12:34,437: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:12:34,437: Re-using an available connection from the pool.
2018-03-12 17:12:34,438: Re-using an available connection from the pool.
2018-03-12 17:12:34,440: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:12:34,450: Re-using an available connection from the pool.
2018-03-12 17:12:35,030: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:12:35,128: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:12:35,180: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:12:37,232: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109421438>]}
2018-03-12 17:12:37,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109421550>]}
2018-03-12 17:12:37,357: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093fada0>]}
2018-03-12 17:12:37,442: 17:12:37 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.83s]
2018-03-12 17:12:37,695: 17:12:37 | 14 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.92s]
2018-03-12 17:12:38,086: 17:12:38 | 15 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.95s]
2018-03-12 17:12:38,087: 17:12:38 | 16 of 46 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-03-12 17:12:38,087: 17:12:38 | 17 of 46 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-03-12 17:12:38,088: 17:12:38 | 18 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:12:38,088: 17:12:38 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:12:38,088: 17:12:38 | 20 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:12:38,089: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:12:38,088: 17:12:38 | 21 of 46 SKIP relation seo_audit.deepcrawl_urls...................... [SKIP]
2018-03-12 17:12:38,089: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:12:38,089: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:12:38,102: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:12:38,134: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:12:38,135: Re-using an available connection from the pool.
2018-03-12 17:12:38,116: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:12:38,128: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:12:38,139: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:12:38,141: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:12:38,142: Re-using an available connection from the pool.
2018-03-12 17:12:38,143: Re-using an available connection from the pool.
2018-03-12 17:12:38,849: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:12:38,852: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:12:38,857: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:12:41,058: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cbcc0>]}
2018-03-12 17:12:41,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109421240>]}
2018-03-12 17:12:41,091: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8fef05d3-08cb-4cc7-bd39-0e39cad3c675', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109408e80>]}
2018-03-12 17:12:41,401: 17:12:41 | 18 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.97s]
2018-03-12 17:12:41,712: 17:12:41 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.00s]
2018-03-12 17:12:41,930: 17:12:41 | 20 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.00s]
2018-03-12 17:12:41,936: 17:12:41 | 22 of 46 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-03-12 17:12:41,937: 17:12:41 | 23 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-03-12 17:12:41,937: 17:12:41 | 24 of 46 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-03-12 17:12:41,937: 17:12:41 | 25 of 46 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-03-12 17:12:41,937: 17:12:41 | 26 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-03-12 17:12:41,938: 17:12:41 | 27 of 46 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-03-12 17:12:41,940: 17:12:41 | 28 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-03-12 17:12:41,940: 17:12:41 | 29 of 46 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-03-12 17:12:41,940: 17:12:41 | 30 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-03-12 17:12:41,941: 17:12:41 | 31 of 46 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-03-12 17:12:41,942: 17:12:41 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:12:41,943: 17:12:41 | 33 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:12:41,943: 17:12:41 | 34 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:12:41,944: 17:12:41 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:12:41,945: 17:12:41 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:12:41,946: 17:12:41 | 37 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:12:41,946: 17:12:41 | 38 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:12:41,947: 17:12:41 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:12:41,947: 17:12:41 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:12:41,948: 17:12:41 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:12:41,948: 17:12:41 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:12:41,949: 17:12:41 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:12:41,950: 17:12:41 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:12:41,950: 17:12:41 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:12:41,951: 17:12:41 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:12:42,018: 17:12:42 | 
2018-03-12 17:12:42,019: 17:12:42 | Finished running 46 table models in 22.00s.
2018-03-12 17:12:42,019: Connection 'master' was left open.
2018-03-12 17:12:42,020: 
2018-03-12 17:12:42,020: Completed with 1 errors:
2018-03-12 17:12:42,020: 
2018-03-12 17:12:42,020: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-03-12 17:12:42,021:   Column 68 in UNION ALL has incompatible types: INT64, STRING at [70:5]
2018-03-12 17:12:42,021:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-03-12 17:12:42,021: 
Done. PASS=16 ERROR=1 SKIP=29 TOTAL=46
2018-03-12 17:12:42,022: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104561470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104423978>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104423828>]}
2018-03-12 17:12:42,239: Flushing usage events
2018-03-12 17:16:43,621: Tracking: tracking
2018-03-12 17:16:43,624: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dda82e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dda8b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dda8080>]}
2018-03-12 17:16:44,494: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:16:44,524: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:16:44,528: Parsing core.sql
2018-03-12 17:16:44,547: Parsing adapters/bigquery.sql
2018-03-12 17:16:44,558: Parsing adapters/common.sql
2018-03-12 17:16:44,576: Parsing adapters/postgres.sql
2018-03-12 17:16:44,582: Parsing adapters/redshift.sql
2018-03-12 17:16:44,603: Parsing etc/get_custom_schema.sql
2018-03-12 17:16:44,613: Parsing materializations/archive.sql
2018-03-12 17:16:44,649: Parsing materializations/bigquery.sql
2018-03-12 17:16:44,666: Parsing materializations/helpers.sql
2018-03-12 17:16:44,686: Parsing materializations/incremental.sql
2018-03-12 17:16:44,721: Parsing materializations/table.sql
2018-03-12 17:16:44,743: Parsing materializations/view.sql
2018-03-12 17:16:44,766: Parsing materializations/wrapper.sql
2018-03-12 17:16:44,773: Parsing schema_tests/accepted_values.sql
2018-03-12 17:16:44,782: Parsing schema_tests/not_null.sql
2018-03-12 17:16:44,787: Parsing schema_tests/relationships.sql
2018-03-12 17:16:44,793: Parsing schema_tests/unique.sql
2018-03-12 17:16:44,847: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:16:44,850: Acquiring new bigquery connection "master".
2018-03-12 17:16:44,850: Opening a new connection (0 currently allocated)
2018-03-12 17:16:44,855: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:16:44,860: Parsing model.seo_audit.actions_proc
2018-03-12 17:16:44,867: Parsing model.seo_audit.accounts_proc
2018-03-12 17:16:44,871: Parsing model.seo_audit.all_dates
2018-03-12 17:16:44,872: Parsing model.seo_audit.dates
2018-03-12 17:16:44,874: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:16:44,878: Parsing model.seo_audit.agg_all
2018-03-12 17:16:44,881: Parsing model.seo_audit.agg_indicative
2018-03-12 17:16:44,883: Parsing model.seo_audit.agg_stats
2018-03-12 17:16:44,890: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:16:44,894: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:16:44,897: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:16:44,899: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:16:44,900: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:16:44,902: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:16:44,905: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:16:44,908: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:16:44,912: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:16:44,920: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:16:44,922: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:16:44,924: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:16:44,927: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:16:44,929: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:16:44,931: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:16:44,932: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:16:44,936: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:16:44,938: Parsing model.seo_audit.ga_proc
2018-03-12 17:16:44,941: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:16:44,945: Parsing model.seo_audit.ga_stats
2018-03-12 17:16:44,948: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:16:44,950: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:16:44,953: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:16:44,955: Parsing model.seo_audit.moz_proc
2018-03-12 17:16:44,957: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:16:44,961: Parsing model.seo_audit.search_console_history
2018-03-12 17:16:44,963: Parsing model.seo_audit.search_console_proc
2018-03-12 17:16:44,966: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:16:44,969: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:16:44,971: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:16:44,973: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:16:44,976: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:16:44,980: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:16:44,982: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:16:44,985: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:16:44,987: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:16:45,002: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:16:45,018: 
2018-03-12 17:16:45,838: 17:16:45 | Concurrency: 4 threads (target='prod')
2018-03-12 17:16:45,839: 17:16:45 | 
2018-03-12 17:16:47,009: 17:16:47 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:16:47,009: Compiling model.seo_audit.accounts_proc
2018-03-12 17:16:47,014: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:16:47,009: 17:16:47 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:16:47,014: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:16:47,020: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:16:47,009: 17:16:47 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:16:47,020: Compiling model.seo_audit.all_dates
2018-03-12 17:16:47,024: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:16:47,027: Acquiring new bigquery connection "all_dates".
2018-03-12 17:16:47,029: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:16:47,029: Opening a new connection (1 currently allocated)
2018-03-12 17:16:47,030: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:16:47,032: Opening a new connection (2 currently allocated)
2018-03-12 17:16:47,095: Opening a new connection (3 currently allocated)
2018-03-12 17:16:48,397: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT 
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:16:48,397: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT 
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:16:48,397: 400 Queries in UNION ALL have mismatched column count; query 1 has 50 columns, query 2 has 47 columns at [121:5]
2018-03-12 17:16:48,398: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df7d2b0>]}
2018-03-12 17:16:48,530: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:16:48,581: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:16:48,684: 17:16:48 | 2 of 46 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 1.38s]
2018-03-12 17:16:49,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df9c320>]}
2018-03-12 17:16:49,871: 17:16:49 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.62s]
2018-03-12 17:16:50,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee04a8>]}
2018-03-12 17:16:51,093: 17:16:51 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.78s]
2018-03-12 17:16:51,094: 17:16:51 | 4 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:16:51,095: 17:16:51 | 5 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:16:51,095: 17:16:51 | 6 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:16:51,095: 17:16:51 | 7 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:16:51,095: Compiling model.seo_audit.moz_proc
2018-03-12 17:16:51,096: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:16:51,096: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:16:51,096: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:16:51,103: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:16:51,111: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:16:51,116: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:16:51,122: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:16:51,127: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:16:51,127: Re-using an available connection from the pool.
2018-03-12 17:16:51,129: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:16:51,129: Re-using an available connection from the pool.
2018-03-12 17:16:51,130: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:16:51,131: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:16:51,132: Re-using an available connection from the pool.
2018-03-12 17:16:51,134: Opening a new connection (4 currently allocated)
2018-03-12 17:16:51,892: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:16:51,898: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:16:51,916: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:16:52,211: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:16:54,103: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee0080>]}
2018-03-12 17:16:54,133: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df25710>]}
2018-03-12 17:16:54,144: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b20c0b8>]}
2018-03-12 17:16:54,384: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee00b8>]}
2018-03-12 17:16:54,414: 17:16:54 | 4 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.01s]
2018-03-12 17:16:54,416: 17:16:54 | 8 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:16:54,417: Compiling model.seo_audit.search_console_proc
2018-03-12 17:16:54,434: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:16:54,438: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:16:54,438: Re-using an available connection from the pool.
2018-03-12 17:16:54,658: 17:16:54 | 7 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.04s]
2018-03-12 17:16:54,658: 17:16:54 | 9 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:16:54,659: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:16:54,720: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:16:54,726: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:16:54,726: Re-using an available connection from the pool.
2018-03-12 17:16:55,027: 17:16:55 | 6 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.05s]
2018-03-12 17:16:55,029: 17:16:55 | 10 of 46 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-03-12 17:16:55,029: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:16:55,039: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:16:55,041: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:16:55,042: Re-using an available connection from the pool.
2018-03-12 17:16:55,204: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:16:55,339: 17:16:55 | 5 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.29s]
2018-03-12 17:16:55,339: 17:16:55 | 11 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-12 17:16:55,340: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:16:55,352: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:16:55,354: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:16:55,354: Re-using an available connection from the pool.
2018-03-12 17:16:55,449: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:16:55,763: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:16:56,058: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:16:57,982: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df50f60>]}
2018-03-12 17:16:58,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee00b8>]}
2018-03-12 17:16:58,322: 17:16:58 | 10 of 46 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.95s]
2018-03-12 17:16:58,623: 17:16:58 | 11 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.92s]
2018-03-12 17:16:58,774: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df25710>]}
2018-03-12 17:16:58,995: 17:16:58 | 9 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 4.11s]
2018-03-12 17:17:00,734: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee0080>]}
2018-03-12 17:17:01,038: 17:17:01 | 8 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 6.32s]
2018-03-12 17:17:01,039: 17:17:01 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:17:01,039: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:17:01,040: 17:17:01 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:17:01,040: 17:17:01 | 14 of 46 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-03-12 17:17:01,040: 17:17:01 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:17:01,051: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:17:01,051: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:17:01,051: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:17:01,063: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:17:01,084: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:17:01,084: Re-using an available connection from the pool.
2018-03-12 17:17:01,074: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:17:01,075: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:17:01,090: Re-using an available connection from the pool.
2018-03-12 17:17:01,090: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:17:01,100: Re-using an available connection from the pool.
2018-03-12 17:17:01,844: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:17:01,845: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:17:01,846: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:17:05,176: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b220a20>]}
2018-03-12 17:17:05,496: 17:17:05 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 4.12s]
2018-03-12 17:17:06,353: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee5da0>]}
2018-03-12 17:17:06,376: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee04a8>]}
2018-03-12 17:17:06,636: 17:17:06 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 5.30s]
2018-03-12 17:17:06,949: 17:17:06 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 5.34s]
2018-03-12 17:17:06,951: 17:17:06 | 16 of 46 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-03-12 17:17:06,953: 17:17:06 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:17:06,953: 17:17:06 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:17:06,954: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:17:06,953: 17:17:06 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:17:06,954: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:17:06,953: 17:17:06 | 20 of 46 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-03-12 17:17:06,969: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:17:06,973: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:17:06,982: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:17:06,982: 17:17:06 | 21 of 46 SKIP relation seo_audit.deepcrawl_urls...................... [SKIP]
2018-03-12 17:17:06,990: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:17:06,992: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:17:06,993: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:17:06,993: Re-using an available connection from the pool.
2018-03-12 17:17:06,994: Re-using an available connection from the pool.
2018-03-12 17:17:06,996: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:17:06,997: Re-using an available connection from the pool.
2018-03-12 17:17:07,788: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:17:07,789: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:17:07,790: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:17:12,602: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dee04a8>]}
2018-03-12 17:17:12,603: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df9c128>]}
2018-03-12 17:17:12,920: 17:17:12 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 5.65s]
2018-03-12 17:17:13,209: 17:17:13 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 5.63s]
2018-03-12 17:17:13,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '78bcb4e2-cca1-47cf-8ee6-de5c5f502e8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df68668>]}
2018-03-12 17:17:13,996: 17:17:13 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 6.84s]
2018-03-12 17:17:13,997: 17:17:13 | 22 of 46 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-03-12 17:17:13,998: 17:17:13 | 23 of 46 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-03-12 17:17:13,998: 17:17:13 | 24 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-03-12 17:17:13,998: 17:17:13 | 25 of 46 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-03-12 17:17:13,999: 17:17:13 | 26 of 46 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-03-12 17:17:13,999: 17:17:13 | 27 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-03-12 17:17:14,001: 17:17:14 | 28 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-03-12 17:17:14,002: 17:17:14 | 29 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-03-12 17:17:14,002: 17:17:14 | 30 of 46 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-03-12 17:17:14,003: 17:17:14 | 31 of 46 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-03-12 17:17:14,004: 17:17:14 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:17:14,005: 17:17:14 | 33 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:17:14,005: 17:17:14 | 34 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:17:14,006: 17:17:14 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:17:14,007: 17:17:14 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:17:14,008: 17:17:14 | 37 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:17:14,008: 17:17:14 | 38 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:17:14,009: 17:17:14 | 39 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:17:14,010: 17:17:14 | 40 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:17:14,011: 17:17:14 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:17:14,012: 17:17:14 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:17:14,013: 17:17:14 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:17:14,014: 17:17:14 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:17:14,015: 17:17:14 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:17:14,015: 17:17:14 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:17:14,077: 17:17:14 | 
2018-03-12 17:17:14,077: 17:17:14 | Finished running 46 table models in 28.24s.
2018-03-12 17:17:14,077: Connection 'master' was left open.
2018-03-12 17:17:14,078: 
2018-03-12 17:17:14,078: Completed with 1 errors:
2018-03-12 17:17:14,079: 
2018-03-12 17:17:14,079: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-03-12 17:17:14,079:   Queries in UNION ALL have mismatched column count; query 1 has 50 columns, query 2 has 47 columns at [121:5]
2018-03-12 17:17:14,079:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-03-12 17:17:14,080: 
Done. PASS=16 ERROR=1 SKIP=29 TOTAL=46
2018-03-12 17:17:14,081: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de7c6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de7c828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10de7c6d8>]}
2018-03-12 17:17:14,366: Flushing usage events
2018-03-12 17:18:56,568: Tracking: tracking
2018-03-12 17:18:56,571: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e08e2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e08eb70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e08e080>]}
2018-03-12 17:18:57,333: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:18:57,357: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:18:57,364: Parsing core.sql
2018-03-12 17:18:57,389: Parsing adapters/bigquery.sql
2018-03-12 17:18:57,396: Parsing adapters/common.sql
2018-03-12 17:18:57,421: Parsing adapters/postgres.sql
2018-03-12 17:18:57,428: Parsing adapters/redshift.sql
2018-03-12 17:18:57,455: Parsing etc/get_custom_schema.sql
2018-03-12 17:18:57,467: Parsing materializations/archive.sql
2018-03-12 17:18:57,511: Parsing materializations/bigquery.sql
2018-03-12 17:18:57,539: Parsing materializations/helpers.sql
2018-03-12 17:18:57,562: Parsing materializations/incremental.sql
2018-03-12 17:18:57,594: Parsing materializations/table.sql
2018-03-12 17:18:57,620: Parsing materializations/view.sql
2018-03-12 17:18:57,640: Parsing materializations/wrapper.sql
2018-03-12 17:18:57,645: Parsing schema_tests/accepted_values.sql
2018-03-12 17:18:57,651: Parsing schema_tests/not_null.sql
2018-03-12 17:18:57,655: Parsing schema_tests/relationships.sql
2018-03-12 17:18:57,661: Parsing schema_tests/unique.sql
2018-03-12 17:18:57,727: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:18:57,731: Acquiring new bigquery connection "master".
2018-03-12 17:18:57,731: Opening a new connection (0 currently allocated)
2018-03-12 17:18:57,741: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:18:57,746: Parsing model.seo_audit.actions_proc
2018-03-12 17:18:57,753: Parsing model.seo_audit.accounts_proc
2018-03-12 17:18:57,756: Parsing model.seo_audit.all_dates
2018-03-12 17:18:57,757: Parsing model.seo_audit.dates
2018-03-12 17:18:57,760: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:18:57,763: Parsing model.seo_audit.agg_all
2018-03-12 17:18:57,766: Parsing model.seo_audit.agg_indicative
2018-03-12 17:18:57,769: Parsing model.seo_audit.agg_stats
2018-03-12 17:18:57,775: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:18:57,778: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:18:57,781: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:18:57,782: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:18:57,785: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:18:57,786: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:18:57,789: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:18:57,792: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:18:57,795: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:18:57,803: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:18:57,806: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:18:57,807: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:18:57,809: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:18:57,811: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:18:57,813: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:18:57,815: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:18:57,819: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:18:57,820: Parsing model.seo_audit.ga_proc
2018-03-12 17:18:57,824: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:18:57,827: Parsing model.seo_audit.ga_stats
2018-03-12 17:18:57,830: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:18:57,834: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:18:57,839: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:18:57,842: Parsing model.seo_audit.moz_proc
2018-03-12 17:18:57,845: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:18:57,849: Parsing model.seo_audit.search_console_history
2018-03-12 17:18:57,852: Parsing model.seo_audit.search_console_proc
2018-03-12 17:18:57,855: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:18:57,858: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:18:57,860: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:18:57,862: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:18:57,865: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:18:57,870: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:18:57,873: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:18:57,875: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:18:57,877: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:18:57,900: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:18:57,926: 
2018-03-12 17:18:58,762: 17:18:58 | Concurrency: 4 threads (target='prod')
2018-03-12 17:18:58,762: 17:18:58 | 
2018-03-12 17:18:59,122: 17:18:59 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:18:59,123: Compiling model.seo_audit.accounts_proc
2018-03-12 17:18:59,128: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:18:59,123: 17:18:59 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:18:59,128: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:18:59,135: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:18:59,123: 17:18:59 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:18:59,135: Compiling model.seo_audit.all_dates
2018-03-12 17:18:59,140: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:18:59,141: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:18:59,142: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:18:59,143: Acquiring new bigquery connection "all_dates".
2018-03-12 17:18:59,143: Opening a new connection (1 currently allocated)
2018-03-12 17:18:59,145: Opening a new connection (2 currently allocated)
2018-03-12 17:18:59,207: Opening a new connection (3 currently allocated)
2018-03-12 17:18:59,995: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:18:59,996: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:18:59,996: 400 Column 30 in UNION ALL has incompatible types: INT64, STRING at [121:5]
2018-03-12 17:18:59,996: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2a0438>]}
2018-03-12 17:19:00,191: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:19:00,236: 17:19:00 | 2 of 46 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 0.87s]
2018-03-12 17:19:00,299: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:19:01,296: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e27e780>]}
2018-03-12 17:19:01,516: 17:19:01 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.16s]
2018-03-12 17:19:02,540: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e27edd8>]}
2018-03-12 17:19:02,811: 17:19:02 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.42s]
2018-03-12 17:19:02,812: 17:19:02 | 4 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:19:02,813: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:19:02,813: 17:19:02 | 5 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:19:02,819: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:19:02,827: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:19:02,828: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:19:02,813: 17:19:02 | 6 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:19:02,829: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:19:02,836: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:19:02,813: 17:19:02 | 7 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:19:02,837: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:19:02,837: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:19:02,838: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:19:02,838: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:19:02,839: Re-using an available connection from the pool.
2018-03-12 17:19:02,845: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:19:02,845: Re-using an available connection from the pool.
2018-03-12 17:19:02,849: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:19:02,854: Re-using an available connection from the pool.
2018-03-12 17:19:02,858: Opening a new connection (4 currently allocated)
2018-03-12 17:19:03,513: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:19:03,544: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:19:03,594: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:19:03,898: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:19:05,694: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e160f98>]}
2018-03-12 17:19:05,732: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e281630>]}
2018-03-12 17:19:05,993: 17:19:05 | 4 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.88s]
2018-03-12 17:19:05,995: 17:19:05 | 8 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:19:05,997: Compiling model.seo_audit.moz_proc
2018-03-12 17:19:06,009: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:19:06,017: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:19:06,018: Re-using an available connection from the pool.
2018-03-12 17:19:06,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e24c7f0>]}
2018-03-12 17:19:06,227: 17:19:06 | 5 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.91s]
2018-03-12 17:19:06,227: 17:19:06 | 9 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:19:06,232: Compiling model.seo_audit.search_console_proc
2018-03-12 17:19:06,242: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:19:06,245: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:19:06,245: Re-using an available connection from the pool.
2018-03-12 17:19:06,532: 17:19:06 | 7 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.27s]
2018-03-12 17:19:06,532: 17:19:06 | 10 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-12 17:19:06,533: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:19:06,541: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:19:06,544: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:19:06,544: Re-using an available connection from the pool.
2018-03-12 17:19:06,790: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:19:06,917: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:19:06,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e212860>]}
2018-03-12 17:19:07,205: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:19:07,249: 17:19:07 | 6 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.13s]
2018-03-12 17:19:07,249: 17:19:07 | 11 of 46 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-03-12 17:19:07,250: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:19:07,261: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:19:07,261: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:19:07,261: Re-using an available connection from the pool.
2018-03-12 17:19:07,895: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:19:09,385: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e212908>]}
2018-03-12 17:19:10,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e212860>]}
2018-03-12 17:19:10,092: 17:19:10 | 10 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.85s]
2018-03-12 17:19:10,099: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e267f28>]}
2018-03-12 17:19:10,378: 17:19:10 | 11 of 46 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 2.82s]
2018-03-12 17:19:10,665: 17:19:10 | 8 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 4.10s]
2018-03-12 17:19:11,271: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2ae0b8>]}
2018-03-12 17:19:11,581: 17:19:11 | 9 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.04s]
2018-03-12 17:19:11,582: 17:19:11 | 12 of 46 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-03-12 17:19:11,582: 17:19:11 | 13 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:19:11,583: 17:19:11 | 14 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:19:11,583: 17:19:11 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:19:11,583: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:19:11,584: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:19:11,584: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:19:11,598: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:19:11,601: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:19:11,613: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:19:11,615: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:19:11,615: Re-using an available connection from the pool.
2018-03-12 17:19:11,617: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:19:11,624: Re-using an available connection from the pool.
2018-03-12 17:19:11,619: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:19:11,626: Re-using an available connection from the pool.
2018-03-12 17:19:12,403: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:19:12,405: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:19:12,406: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:19:14,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1c9d68>]}
2018-03-12 17:19:14,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb2518>]}
2018-03-12 17:19:14,916: 17:19:14 | 13 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.03s]
2018-03-12 17:19:15,220: 17:19:15 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.04s]
2018-03-12 17:19:15,686: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e27ebe0>]}
2018-03-12 17:19:15,979: 17:19:15 | 14 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.10s]
2018-03-12 17:19:15,980: 17:19:15 | 16 of 46 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-03-12 17:19:15,981: 17:19:15 | 17 of 46 SKIP relation seo_audit.deepcrawl_urls...................... [SKIP]
2018-03-12 17:19:15,981: 17:19:15 | 18 of 46 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-03-12 17:19:15,982: 17:19:15 | 19 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:19:15,983: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:19:15,982: 17:19:15 | 20 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:19:15,990: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:19:15,982: 17:19:15 | 21 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:19:15,994: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:19:16,000: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:19:16,002: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:19:16,008: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:19:16,009: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:19:16,010: Re-using an available connection from the pool.
2018-03-12 17:19:16,010: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:19:16,011: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:19:16,012: Re-using an available connection from the pool.
2018-03-12 17:19:16,013: Re-using an available connection from the pool.
2018-03-12 17:19:16,804: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:19:16,807: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:19:16,807: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:19:19,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1b6c18>]}
2018-03-12 17:19:19,071: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb2128>]}
2018-03-12 17:19:19,324: 17:19:19 | 21 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.02s]
2018-03-12 17:19:19,625: 17:19:19 | 19 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.09s]
2018-03-12 17:19:20,137: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd7cc3db3-e83a-4293-8b5d-f07f0f75fc4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac8c898>]}
2018-03-12 17:19:20,363: 17:19:20 | 20 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.15s]
2018-03-12 17:19:20,364: 17:19:20 | 22 of 46 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-03-12 17:19:20,364: 17:19:20 | 23 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-03-12 17:19:20,364: 17:19:20 | 24 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-03-12 17:19:20,365: 17:19:20 | 25 of 46 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-03-12 17:19:20,365: 17:19:20 | 26 of 46 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-03-12 17:19:20,365: 17:19:20 | 27 of 46 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-03-12 17:19:20,367: 17:19:20 | 28 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-03-12 17:19:20,368: 17:19:20 | 29 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-03-12 17:19:20,368: 17:19:20 | 30 of 46 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-03-12 17:19:20,370: 17:19:20 | 31 of 46 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-03-12 17:19:20,371: 17:19:20 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:19:20,372: 17:19:20 | 33 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:19:20,372: 17:19:20 | 34 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:19:20,373: 17:19:20 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:19:20,374: 17:19:20 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:19:20,374: 17:19:20 | 37 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:19:20,374: 17:19:20 | 38 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:19:20,376: 17:19:20 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:19:20,376: 17:19:20 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:19:20,377: 17:19:20 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:19:20,377: 17:19:20 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:19:20,378: 17:19:20 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:19:20,378: 17:19:20 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:19:20,379: 17:19:20 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:19:20,379: 17:19:20 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:19:20,424: 17:19:20 | 
2018-03-12 17:19:20,424: 17:19:20 | Finished running 46 table models in 21.67s.
2018-03-12 17:19:20,424: Connection 'master' was left open.
2018-03-12 17:19:20,424: 
2018-03-12 17:19:20,424: Completed with 1 errors:
2018-03-12 17:19:20,424: 
2018-03-12 17:19:20,425: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-03-12 17:19:20,425:   Column 30 in UNION ALL has incompatible types: INT64, STRING at [121:5]
2018-03-12 17:19:20,425:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-03-12 17:19:20,425: 
Done. PASS=16 ERROR=1 SKIP=29 TOTAL=46
2018-03-12 17:19:20,426: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e1606d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e160860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e160710>]}
2018-03-12 17:19:20,721: Flushing usage events
2018-03-12 17:20:02,130: Tracking: tracking
2018-03-12 17:20:02,133: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d4af5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d4af390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee40e10>]}
2018-03-12 17:20:02,478: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:20:02,506: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:20:02,514: Parsing core.sql
2018-03-12 17:20:02,546: Parsing adapters/bigquery.sql
2018-03-12 17:20:02,553: Parsing adapters/common.sql
2018-03-12 17:20:02,572: Parsing adapters/postgres.sql
2018-03-12 17:20:02,578: Parsing adapters/redshift.sql
2018-03-12 17:20:02,601: Parsing etc/get_custom_schema.sql
2018-03-12 17:20:02,609: Parsing materializations/archive.sql
2018-03-12 17:20:02,647: Parsing materializations/bigquery.sql
2018-03-12 17:20:02,669: Parsing materializations/helpers.sql
2018-03-12 17:20:02,699: Parsing materializations/incremental.sql
2018-03-12 17:20:02,729: Parsing materializations/table.sql
2018-03-12 17:20:02,752: Parsing materializations/view.sql
2018-03-12 17:20:02,769: Parsing materializations/wrapper.sql
2018-03-12 17:20:02,775: Parsing schema_tests/accepted_values.sql
2018-03-12 17:20:02,781: Parsing schema_tests/not_null.sql
2018-03-12 17:20:02,786: Parsing schema_tests/relationships.sql
2018-03-12 17:20:02,792: Parsing schema_tests/unique.sql
2018-03-12 17:20:02,859: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:20:02,862: Acquiring new bigquery connection "master".
2018-03-12 17:20:02,863: Opening a new connection (0 currently allocated)
2018-03-12 17:20:02,867: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:20:02,869: Parsing model.seo_audit.actions_proc
2018-03-12 17:20:02,874: Parsing model.seo_audit.accounts_proc
2018-03-12 17:20:02,877: Parsing model.seo_audit.all_dates
2018-03-12 17:20:02,878: Parsing model.seo_audit.dates
2018-03-12 17:20:02,881: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:20:02,884: Parsing model.seo_audit.agg_all
2018-03-12 17:20:02,887: Parsing model.seo_audit.agg_indicative
2018-03-12 17:20:02,890: Parsing model.seo_audit.agg_stats
2018-03-12 17:20:02,895: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:20:02,897: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:20:02,900: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:20:02,902: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:20:02,904: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:20:02,906: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:20:02,908: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:20:02,911: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:20:02,914: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:20:02,922: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:20:02,926: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:20:02,929: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:20:02,932: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:20:02,935: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:20:02,937: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:20:02,939: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:20:02,943: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:20:02,945: Parsing model.seo_audit.ga_proc
2018-03-12 17:20:02,948: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:20:02,951: Parsing model.seo_audit.ga_stats
2018-03-12 17:20:02,954: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:20:02,956: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:20:02,960: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:20:02,963: Parsing model.seo_audit.moz_proc
2018-03-12 17:20:02,967: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:20:02,972: Parsing model.seo_audit.search_console_history
2018-03-12 17:20:02,975: Parsing model.seo_audit.search_console_proc
2018-03-12 17:20:02,977: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:20:02,981: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:20:02,983: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:20:02,985: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:20:02,988: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:20:02,992: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:20:02,994: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:20:02,996: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:20:02,999: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:20:03,021: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:20:03,046: 
2018-03-12 17:20:03,441: 17:20:03 | Concurrency: 4 threads (target='prod')
2018-03-12 17:20:03,442: 17:20:03 | 
2018-03-12 17:20:03,774: 17:20:03 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:20:03,774: 17:20:03 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:20:03,775: Compiling model.seo_audit.all_dates
2018-03-12 17:20:03,775: 17:20:03 | 3 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:20:03,775: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:20:03,780: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:20:03,780: Compiling model.seo_audit.accounts_proc
2018-03-12 17:20:03,786: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:20:03,791: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:20:03,792: Acquiring new bigquery connection "all_dates".
2018-03-12 17:20:03,793: Opening a new connection (1 currently allocated)
2018-03-12 17:20:03,796: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:20:03,797: Opening a new connection (2 currently allocated)
2018-03-12 17:20:03,798: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:20:03,853: Opening a new connection (3 currently allocated)
2018-03-12 17:20:04,738: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:20:04,738: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    decimal_price,
    currency_price,
    add_to_cart,
    google_maps,
    learn_more,
    review,
    size,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:20:04,738: 400 Column name decimal_price is ambiguous at [48:11]
2018-03-12 17:20:04,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efd46d8>]}
2018-03-12 17:20:04,771: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:20:04,825: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:20:04,942: 17:20:04 | 2 of 46 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 0.96s]
2018-03-12 17:20:05,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efaff28>]}
2018-03-12 17:20:06,178: 17:20:06 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.10s]
2018-03-12 17:20:07,005: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efafc18>]}
2018-03-12 17:20:07,297: 17:20:07 | 3 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.23s]
2018-03-12 17:20:07,298: 17:20:07 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:20:07,299: Compiling model.seo_audit.search_console_proc
2018-03-12 17:20:07,299: 17:20:07 | 5 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:20:07,306: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:20:07,299: 17:20:07 | 6 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:20:07,317: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:20:07,318: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:20:07,320: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:20:07,299: 17:20:07 | 7 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:20:07,326: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:20:07,326: Compiling model.seo_audit.moz_proc
2018-03-12 17:20:07,332: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:20:07,334: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:20:07,334: Re-using an available connection from the pool.
2018-03-12 17:20:07,336: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:20:07,337: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:20:07,338: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:20:07,341: Re-using an available connection from the pool.
2018-03-12 17:20:07,343: Re-using an available connection from the pool.
2018-03-12 17:20:07,347: Opening a new connection (4 currently allocated)
2018-03-12 17:20:07,966: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:20:08,042: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:20:08,059: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:20:08,285: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:20:10,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef0ea58>]}
2018-03-12 17:20:10,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef2f358>]}
2018-03-12 17:20:10,967: 17:20:10 | 7 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.90s]
2018-03-12 17:20:10,968: 17:20:10 | 8 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:20:10,969: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:20:10,979: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:20:10,980: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:20:10,981: Re-using an available connection from the pool.
2018-03-12 17:20:11,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef0ebe0>]}
2018-03-12 17:20:11,275: 17:20:11 | 5 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.04s]
2018-03-12 17:20:11,279: 17:20:11 | 9 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:20:11,281: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:20:11,293: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:20:11,296: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:20:11,296: Re-using an available connection from the pool.
2018-03-12 17:20:11,580: 17:20:11 | 6 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.94s]
2018-03-12 17:20:11,580: 17:20:11 | 10 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-12 17:20:11,580: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:20:11,589: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:20:11,596: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:20:11,597: Re-using an available connection from the pool.
2018-03-12 17:20:11,648: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:20:12,026: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:20:12,308: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:20:12,694: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efaf198>]}
2018-03-12 17:20:12,995: 17:20:12 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.39s]
2018-03-12 17:20:12,995: 17:20:12 | 11 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-12 17:20:12,995: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:20:13,010: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:20:13,012: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:20:13,012: Re-using an available connection from the pool.
2018-03-12 17:20:13,669: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:20:13,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef0ea58>]}
2018-03-12 17:20:14,187: 17:20:14 | 8 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.87s]
2018-03-12 17:20:14,202: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f015668>]}
2018-03-12 17:20:14,411: 17:20:14 | 9 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.92s]
2018-03-12 17:20:14,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef0ebe0>]}
2018-03-12 17:20:14,770: 17:20:14 | 10 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.97s]
2018-03-12 17:20:15,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efaf198>]}
2018-03-12 17:20:16,129: 17:20:16 | 11 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 2.84s]
2018-03-12 17:20:16,130: 17:20:16 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:20:16,130: 17:20:16 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:20:16,131: 17:20:16 | 14 of 46 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-03-12 17:20:16,131: 17:20:16 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:20:16,131: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:20:16,132: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:20:16,132: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:20:16,141: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:20:16,147: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:20:16,152: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:20:16,153: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:20:16,153: Re-using an available connection from the pool.
2018-03-12 17:20:16,156: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:20:16,156: Re-using an available connection from the pool.
2018-03-12 17:20:16,158: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:20:16,158: Re-using an available connection from the pool.
2018-03-12 17:20:16,916: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:20:16,916: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:20:16,917: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:20:19,092: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efafc18>]}
2018-03-12 17:20:19,113: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efdf358>]}
2018-03-12 17:20:19,135: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bacf208>]}
2018-03-12 17:20:19,308: 17:20:19 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.96s]
2018-03-12 17:20:19,521: 17:20:19 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.98s]
2018-03-12 17:20:19,805: 17:20:19 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.00s]
2018-03-12 17:20:19,807: 17:20:19 | 16 of 46 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-03-12 17:20:19,808: 17:20:19 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:20:19,808: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:20:19,808: 17:20:19 | 18 of 46 SKIP relation seo_audit.deepcrawl_urls...................... [SKIP]
2018-03-12 17:20:19,819: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:20:19,808: 17:20:19 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:20:19,808: 17:20:19 | 20 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:20:19,819: 17:20:19 | 21 of 46 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-03-12 17:20:19,820: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:20:19,820: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:20:19,822: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:20:19,847: Re-using an available connection from the pool.
2018-03-12 17:20:19,836: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:20:19,857: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:20:19,857: Re-using an available connection from the pool.
2018-03-12 17:20:19,859: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:20:19,865: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:20:19,870: Re-using an available connection from the pool.
2018-03-12 17:20:20,617: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:20:20,618: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:20:20,618: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:20:22,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bae1828>]}
2018-03-12 17:20:22,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef4a748>]}
2018-03-12 17:20:23,087: 17:20:23 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.04s]
2018-03-12 17:20:23,310: 17:20:23 | 20 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.11s]
2018-03-12 17:20:24,049: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd974b43c-c885-4b77-8597-20160c37862d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f021c88>]}
2018-03-12 17:20:24,359: 17:20:24 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 4.24s]
2018-03-12 17:20:24,360: 17:20:24 | 22 of 46 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-03-12 17:20:24,360: 17:20:24 | 23 of 46 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-03-12 17:20:24,360: 17:20:24 | 24 of 46 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-03-12 17:20:24,361: 17:20:24 | 25 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-03-12 17:20:24,361: 17:20:24 | 26 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-03-12 17:20:24,361: 17:20:24 | 27 of 46 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-03-12 17:20:24,363: 17:20:24 | 28 of 46 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-03-12 17:20:24,363: 17:20:24 | 29 of 46 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-03-12 17:20:24,363: 17:20:24 | 30 of 46 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-03-12 17:20:24,364: 17:20:24 | 31 of 46 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-03-12 17:20:24,365: 17:20:24 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:20:24,365: 17:20:24 | 33 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:20:24,366: 17:20:24 | 34 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:20:24,366: 17:20:24 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:20:24,367: 17:20:24 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:20:24,367: 17:20:24 | 37 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:20:24,368: 17:20:24 | 38 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:20:24,368: 17:20:24 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:20:24,368: 17:20:24 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:20:24,369: 17:20:24 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:20:24,370: 17:20:24 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:20:24,370: 17:20:24 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:20:24,370: 17:20:24 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:20:24,371: 17:20:24 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:20:24,371: 17:20:24 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:20:24,431: 17:20:24 | 
2018-03-12 17:20:24,432: 17:20:24 | Finished running 46 table models in 20.99s.
2018-03-12 17:20:24,432: Connection 'master' was left open.
2018-03-12 17:20:24,432: 
2018-03-12 17:20:24,432: Completed with 1 errors:
2018-03-12 17:20:24,432: 
2018-03-12 17:20:24,433: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-03-12 17:20:24,433:   Column name decimal_price is ambiguous at [48:11]
2018-03-12 17:20:24,433:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-03-12 17:20:24,433: 
Done. PASS=16 ERROR=1 SKIP=29 TOTAL=46
2018-03-12 17:20:24,433: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee9e048>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eef75f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eef76d8>]}
2018-03-12 17:20:24,631: Flushing usage events
2018-03-12 17:21:20,310: Tracking: tracking
2018-03-12 17:21:20,312: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a22e2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a22eb70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a22e080>]}
2018-03-12 17:21:21,123: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:21:21,140: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:21:21,146: Parsing core.sql
2018-03-12 17:21:21,165: Parsing adapters/bigquery.sql
2018-03-12 17:21:21,176: Parsing adapters/common.sql
2018-03-12 17:21:21,193: Parsing adapters/postgres.sql
2018-03-12 17:21:21,200: Parsing adapters/redshift.sql
2018-03-12 17:21:21,223: Parsing etc/get_custom_schema.sql
2018-03-12 17:21:21,231: Parsing materializations/archive.sql
2018-03-12 17:21:21,288: Parsing materializations/bigquery.sql
2018-03-12 17:21:21,317: Parsing materializations/helpers.sql
2018-03-12 17:21:21,344: Parsing materializations/incremental.sql
2018-03-12 17:21:21,386: Parsing materializations/table.sql
2018-03-12 17:21:21,411: Parsing materializations/view.sql
2018-03-12 17:21:21,430: Parsing materializations/wrapper.sql
2018-03-12 17:21:21,436: Parsing schema_tests/accepted_values.sql
2018-03-12 17:21:21,443: Parsing schema_tests/not_null.sql
2018-03-12 17:21:21,447: Parsing schema_tests/relationships.sql
2018-03-12 17:21:21,453: Parsing schema_tests/unique.sql
2018-03-12 17:21:21,517: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:21:21,519: Acquiring new bigquery connection "master".
2018-03-12 17:21:21,519: Opening a new connection (0 currently allocated)
2018-03-12 17:21:21,524: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:21:21,528: Parsing model.seo_audit.actions_proc
2018-03-12 17:21:21,533: Parsing model.seo_audit.accounts_proc
2018-03-12 17:21:21,537: Parsing model.seo_audit.all_dates
2018-03-12 17:21:21,538: Parsing model.seo_audit.dates
2018-03-12 17:21:21,542: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:21:21,546: Parsing model.seo_audit.agg_all
2018-03-12 17:21:21,549: Parsing model.seo_audit.agg_indicative
2018-03-12 17:21:21,553: Parsing model.seo_audit.agg_stats
2018-03-12 17:21:21,560: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:21:21,564: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:21:21,566: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:21:21,569: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:21:21,570: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:21:21,572: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:21:21,577: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:21:21,581: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:21:21,584: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:21:21,593: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:21:21,596: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:21:21,599: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:21:21,602: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:21:21,604: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:21:21,607: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:21:21,610: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:21:21,614: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:21:21,616: Parsing model.seo_audit.ga_proc
2018-03-12 17:21:21,619: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:21:21,622: Parsing model.seo_audit.ga_stats
2018-03-12 17:21:21,627: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:21:21,629: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:21:21,632: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:21:21,635: Parsing model.seo_audit.moz_proc
2018-03-12 17:21:21,638: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:21:21,642: Parsing model.seo_audit.search_console_history
2018-03-12 17:21:21,645: Parsing model.seo_audit.search_console_proc
2018-03-12 17:21:21,648: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:21:21,650: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:21:21,652: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:21:21,656: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:21:21,661: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:21:21,665: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:21:21,667: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:21:21,669: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:21:21,671: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:21:21,689: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:21:21,709: 
2018-03-12 17:21:22,522: 17:21:22 | Concurrency: 4 threads (target='prod')
2018-03-12 17:21:22,523: 17:21:22 | 
2018-03-12 17:21:22,995: 17:21:22 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:21:22,995: Compiling model.seo_audit.accounts_proc
2018-03-12 17:21:22,995: 17:21:22 | 2 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:21:23,001: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:21:22,995: 17:21:22 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:21:23,002: Compiling model.seo_audit.all_dates
2018-03-12 17:21:23,002: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:21:23,006: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:21:23,007: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:21:23,017: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:21:23,018: Opening a new connection (1 currently allocated)
2018-03-12 17:21:23,019: Acquiring new bigquery connection "all_dates".
2018-03-12 17:21:23,098: Opening a new connection (2 currently allocated)
2018-03-12 17:21:23,106: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:21:23,180: Opening a new connection (3 currently allocated)
2018-03-12 17:21:24,008: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:21:24,115: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:21:24,131: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:21:25,212: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3e6908>]}
2018-03-12 17:21:25,220: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3e67f0>]}
2018-03-12 17:21:25,548: 17:21:25 | 2 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.21s]
2018-03-12 17:21:25,770: 17:21:25 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.22s]
2018-03-12 17:21:42,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a442b70>]}
2018-03-12 17:21:42,965: 17:21:42 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 19.67s]
2018-03-12 17:21:42,966: 17:21:42 | 4 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:21:42,967: Compiling model.seo_audit.moz_proc
2018-03-12 17:21:42,966: 17:21:42 | 5 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:21:42,973: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:21:42,983: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:21:42,988: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:21:42,966: 17:21:42 | 6 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:21:42,988: Compiling model.seo_audit.search_console_proc
2018-03-12 17:21:42,994: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:21:42,966: 17:21:42 | 7 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:21:42,995: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:21:42,995: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:21:42,996: Re-using an available connection from the pool.
2018-03-12 17:21:43,003: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:21:43,013: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:21:43,016: Re-using an available connection from the pool.
2018-03-12 17:21:43,018: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:21:43,019: Re-using an available connection from the pool.
2018-03-12 17:21:43,023: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:21:43,025: Opening a new connection (4 currently allocated)
2018-03-12 17:21:43,678: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:21:43,797: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:21:43,837: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:21:44,044: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:21:45,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3ee2e8>]}
2018-03-12 17:21:46,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3d4320>]}
2018-03-12 17:21:46,175: 17:21:46 | 5 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.87s]
2018-03-12 17:21:46,176: 17:21:46 | 8 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:21:46,177: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:21:46,190: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:21:46,193: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:21:46,193: Re-using an available connection from the pool.
2018-03-12 17:21:46,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3e64e0>]}
2018-03-12 17:21:46,479: 17:21:46 | 4 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.05s]
2018-03-12 17:21:46,480: 17:21:46 | 9 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:21:46,480: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:21:46,490: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:21:46,494: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:21:46,494: Re-using an available connection from the pool.
2018-03-12 17:21:46,775: 17:21:46 | 7 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.23s]
2018-03-12 17:21:46,775: 17:21:46 | 10 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-12 17:21:46,776: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:21:46,789: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:21:46,790: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:21:46,790: Re-using an available connection from the pool.
2018-03-12 17:21:46,909: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:21:47,154: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:21:47,534: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:21:48,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38b780>]}
2018-03-12 17:21:48,576: 17:21:48 | 6 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.37s]
2018-03-12 17:21:48,577: 17:21:48 | 11 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-12 17:21:48,578: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:21:48,589: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:21:48,590: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:21:48,590: Re-using an available connection from the pool.
2018-03-12 17:21:49,557: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3d4320>]}
2018-03-12 17:21:49,883: 17:21:49 | 9 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.08s]
2018-03-12 17:21:50,811: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:21:53,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3e64e0>]}
2018-03-12 17:21:53,751: 17:21:53 | 10 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 6.68s]
2018-03-12 17:21:54,034: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a36f978>]}
2018-03-12 17:21:54,325: 17:21:54 | 8 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 7.86s]
2018-03-12 17:21:54,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38b780>]}
2018-03-12 17:21:55,211: 17:21:55 | 11 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 6.34s]
2018-03-12 17:21:55,212: 17:21:55 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:21:55,213: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:21:55,212: 17:21:55 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:21:55,212: 17:21:55 | 14 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:21:55,228: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:21:55,228: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:21:55,212: 17:21:55 | 15 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:21:55,229: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:21:55,235: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:21:55,240: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:21:55,246: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:21:55,254: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:21:55,256: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:21:55,258: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:21:55,259: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:21:55,259: Re-using an available connection from the pool.
2018-03-12 17:21:55,269: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:21:55,269: Re-using an available connection from the pool.
2018-03-12 17:21:55,269: Re-using an available connection from the pool.
2018-03-12 17:21:55,272: Re-using an available connection from the pool.
2018-03-12 17:21:57,471: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:21:57,471: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:21:57,474: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:21:57,474: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:21:58,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a422dd8>]}
2018-03-12 17:21:58,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4227b8>]}
2018-03-12 17:21:59,191: 17:21:59 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.74s]
2018-03-12 17:21:59,488: 17:21:59 | 15 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.74s]
2018-03-12 17:22:00,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a36f978>]}
2018-03-12 17:22:00,757: 17:22:00 | 14 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 5.24s]
2018-03-12 17:22:30,345: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a315ba8>]}
2018-03-12 17:22:31,019: 17:22:31 | 12 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 35.13s]
2018-03-12 17:22:31,020: 17:22:31 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 17:22:31,020: Compiling model.seo_audit.deepcrawl_class
2018-03-12 17:22:31,031: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 17:22:31,034: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 17:22:31,034: Re-using an available connection from the pool.
2018-03-12 17:22:33,512: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 17:22:45,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38b780>]}
2018-03-12 17:22:45,889: 17:22:45 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 14.55s]
2018-03-12 17:22:45,891: 17:22:45 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:22:45,892: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:22:45,891: 17:22:45 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:22:45,898: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:22:45,908: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:22:45,910: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:22:45,892: 17:22:45 | 19 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 17:22:45,910: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 17:22:45,917: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 17:22:45,892: 17:22:45 | 20 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:22:45,918: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:22:45,918: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:22:45,918: Re-using an available connection from the pool.
2018-03-12 17:22:45,925: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:22:45,927: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:22:45,928: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 17:22:45,929: Re-using an available connection from the pool.
2018-03-12 17:22:45,933: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:22:45,935: Re-using an available connection from the pool.
2018-03-12 17:22:45,936: Re-using an available connection from the pool.
2018-03-12 17:22:48,164: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 17:22:48,165: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:22:48,165: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:22:48,166: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:22:51,120: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3efe48>]}
2018-03-12 17:22:51,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a315ba8>]}
2018-03-12 17:22:51,133: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10762ba58>]}
2018-03-12 17:22:51,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a36f6d8>]}
2018-03-12 17:22:51,425: 17:22:51 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 5.22s]
2018-03-12 17:22:51,426: 17:22:51 | 21 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 17:22:51,428: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:22:51,440: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 17:22:51,443: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 17:22:51,444: Re-using an available connection from the pool.
2018-03-12 17:22:51,757: 17:22:51 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 5.24s]
2018-03-12 17:22:51,971: 17:22:51 | 20 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 5.21s]
2018-03-12 17:22:52,179: 17:22:52 | 19 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 5.24s]
2018-03-12 17:22:53,685: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 17:22:56,582: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3efe48>]}
2018-03-12 17:22:56,868: 17:22:56 | 21 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 5.15s]
2018-03-12 17:22:56,869: 17:22:56 | 22 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 17:22:56,870: 17:22:56 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 17:22:56,870: 17:22:56 | 24 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 17:22:56,871: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:22:56,870: 17:22:56 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 17:22:56,871: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:22:56,871: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:22:56,877: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:22:56,878: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 17:22:56,882: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 17:22:56,891: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 17:22:56,891: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 17:22:56,893: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 17:22:56,894: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 17:22:56,894: Re-using an available connection from the pool.
2018-03-12 17:22:56,895: Re-using an available connection from the pool.
2018-03-12 17:22:56,896: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 17:22:56,896: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 17:22:56,900: Re-using an available connection from the pool.
2018-03-12 17:22:56,900: Re-using an available connection from the pool.
2018-03-12 17:22:59,096: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 17:22:59,118: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:22:59,143: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:22:59,154: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:23:00,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a300f98>]}
2018-03-12 17:23:00,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38b780>]}
2018-03-12 17:23:00,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107619630>]}
2018-03-12 17:23:00,851: 17:23:00 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.69s]
2018-03-12 17:23:00,852: 17:23:00 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 17:23:00,853: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:23:00,863: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 17:23:00,865: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 17:23:00,866: Re-using an available connection from the pool.
2018-03-12 17:23:01,082: 17:23:01 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.70s]
2018-03-12 17:23:01,082: 17:23:01 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 17:23:01,082: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:23:01,093: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 17:23:01,100: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 17:23:01,100: Re-using an available connection from the pool.
2018-03-12 17:23:01,398: 17:23:01 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.71s]
2018-03-12 17:23:01,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a422e10>]}
2018-03-12 17:23:02,262: 17:23:02 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 5.12s]
2018-03-12 17:23:03,208: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 17:23:03,210: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 17:23:04,829: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a300f98>]}
2018-03-12 17:23:04,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38b780>]}
2018-03-12 17:23:05,118: 17:23:05 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.98s]
2018-03-12 17:23:05,327: 17:23:05 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.76s]
2018-03-12 17:23:05,328: 17:23:05 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 17:23:05,328: 17:23:05 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 17:23:05,328: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:23:05,329: 17:23:05 | 30 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 17:23:05,329: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:23:05,336: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:23:05,336: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 17:23:05,341: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 17:23:05,345: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 17:23:05,347: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 17:23:05,347: Re-using an available connection from the pool.
2018-03-12 17:23:05,348: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 17:23:05,348: Re-using an available connection from the pool.
2018-03-12 17:23:05,352: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 17:23:05,353: Re-using an available connection from the pool.
2018-03-12 17:23:05,976: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 17:23:06,053: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 17:23:06,065: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 17:23:07,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3efe48>]}
2018-03-12 17:23:07,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3d4c18>]}
2018-03-12 17:23:07,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a36fd30>]}
2018-03-12 17:23:07,351: 17:23:07 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.73s]
2018-03-12 17:23:07,678: 17:23:07 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.81s]
2018-03-12 17:23:07,961: 17:23:07 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.82s]
2018-03-12 17:23:07,962: 17:23:07 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 17:23:07,962: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:23:07,979: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 17:23:07,979: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 17:23:07,979: Re-using an available connection from the pool.
2018-03-12 17:23:08,737: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-12 17:28:36,236: Unhandled error while running:
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-12 17:28:36,241: Runtime Error
  BigQuery Timeout Exceeded
2018-03-12 17:28:36,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1b2f0c3-eeee-45e1-8761-111fe6d8120c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3ef710>]}
2018-03-12 17:28:37,008: 17:28:37 | 31 of 46 ERROR creating table model seo_audit.deepcrawl_reclass_proc. [ERROR in 328.28s]
2018-03-12 17:28:37,012: 17:28:37 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:28:37,013: 17:28:37 | 33 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:28:37,013: 17:28:37 | 34 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:28:37,014: 17:28:37 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:28:37,015: 17:28:37 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:28:37,016: 17:28:37 | 37 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:28:37,016: 17:28:37 | 38 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:28:37,017: 17:28:37 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:28:37,017: 17:28:37 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:28:37,018: 17:28:37 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:28:37,019: 17:28:37 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:28:37,019: 17:28:37 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:28:37,020: 17:28:37 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:28:37,020: 17:28:37 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:28:37,021: 17:28:37 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:28:37,051: 17:28:37 | 
2018-03-12 17:28:37,051: 17:28:37 | Finished running 46 table models in 434.53s.
2018-03-12 17:28:37,051: Connection 'master' was left open.
2018-03-12 17:28:37,052: 
2018-03-12 17:28:37,052: Completed with 1 errors:
2018-03-12 17:28:37,052: 
2018-03-12 17:28:37,053: Runtime Error in model deepcrawl_reclass_proc (models/base-adp/deepcrawl/deepcrawl_reclass_proc.sql)
2018-03-12 17:28:37,053:   Runtime Error
2018-03-12 17:28:37,053:     BigQuery Timeout Exceeded
2018-03-12 17:28:37,053: 
Done. PASS=30 ERROR=1 SKIP=15 TOTAL=46
2018-03-12 17:28:37,054: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3006d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a300860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a300710>]}
2018-03-12 17:28:37,304: Flushing usage events
2018-03-12 17:29:45,699: Tracking: tracking
2018-03-12 17:29:45,726: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eac62e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eac6b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eac6080>]}
2018-03-12 17:29:46,572: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:29:46,588: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:29:46,598: Parsing core.sql
2018-03-12 17:29:46,617: Parsing adapters/bigquery.sql
2018-03-12 17:29:46,630: Parsing adapters/common.sql
2018-03-12 17:29:46,651: Parsing adapters/postgres.sql
2018-03-12 17:29:46,657: Parsing adapters/redshift.sql
2018-03-12 17:29:46,682: Parsing etc/get_custom_schema.sql
2018-03-12 17:29:46,695: Parsing materializations/archive.sql
2018-03-12 17:29:46,734: Parsing materializations/bigquery.sql
2018-03-12 17:29:46,750: Parsing materializations/helpers.sql
2018-03-12 17:29:46,769: Parsing materializations/incremental.sql
2018-03-12 17:29:46,797: Parsing materializations/table.sql
2018-03-12 17:29:46,818: Parsing materializations/view.sql
2018-03-12 17:29:46,835: Parsing materializations/wrapper.sql
2018-03-12 17:29:46,841: Parsing schema_tests/accepted_values.sql
2018-03-12 17:29:46,848: Parsing schema_tests/not_null.sql
2018-03-12 17:29:46,853: Parsing schema_tests/relationships.sql
2018-03-12 17:29:46,859: Parsing schema_tests/unique.sql
2018-03-12 17:29:46,926: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:29:46,930: Acquiring new bigquery connection "master".
2018-03-12 17:29:46,930: Opening a new connection (0 currently allocated)
2018-03-12 17:29:46,938: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:29:46,943: Parsing model.seo_audit.actions_proc
2018-03-12 17:29:46,951: Parsing model.seo_audit.accounts_proc
2018-03-12 17:29:46,955: Parsing model.seo_audit.all_dates
2018-03-12 17:29:46,956: Parsing model.seo_audit.dates
2018-03-12 17:29:46,959: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:29:46,962: Parsing model.seo_audit.agg_all
2018-03-12 17:29:46,965: Parsing model.seo_audit.agg_indicative
2018-03-12 17:29:46,968: Parsing model.seo_audit.agg_stats
2018-03-12 17:29:46,973: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:29:46,977: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:29:46,982: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:29:46,985: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:29:46,988: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:29:46,990: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:29:46,993: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:29:46,996: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:29:46,998: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:29:47,006: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:29:47,008: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:29:47,010: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:29:47,012: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:29:47,014: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:29:47,016: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:29:47,018: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:29:47,021: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:29:47,023: Parsing model.seo_audit.ga_proc
2018-03-12 17:29:47,027: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:29:47,030: Parsing model.seo_audit.ga_stats
2018-03-12 17:29:47,033: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:29:47,035: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:29:47,038: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:29:47,040: Parsing model.seo_audit.moz_proc
2018-03-12 17:29:47,043: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:29:47,047: Parsing model.seo_audit.search_console_history
2018-03-12 17:29:47,049: Parsing model.seo_audit.search_console_proc
2018-03-12 17:29:47,052: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:29:47,055: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:29:47,057: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:29:47,060: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:29:47,066: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:29:47,073: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:29:47,077: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:29:47,079: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:29:47,082: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:29:47,097: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:29:47,113: 
2018-03-12 17:29:48,341: 17:29:48 | Concurrency: 4 threads (target='prod')
2018-03-12 17:29:48,341: 17:29:48 | 
2018-03-12 17:29:48,715: 17:29:48 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:29:48,715: Compiling model.seo_audit.all_dates
2018-03-12 17:29:48,715: 17:29:48 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:29:48,719: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:29:48,715: 17:29:48 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:29:48,719: Compiling model.seo_audit.accounts_proc
2018-03-12 17:29:48,720: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:29:48,732: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:29:48,734: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:29:48,734: Acquiring new bigquery connection "all_dates".
2018-03-12 17:29:48,735: Opening a new connection (1 currently allocated)
2018-03-12 17:29:48,736: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:29:48,738: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:29:48,796: Opening a new connection (2 currently allocated)
2018-03-12 17:29:48,952: Opening a new connection (3 currently allocated)
2018-03-12 17:29:49,948: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:29:49,965: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:29:50,028: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:29:51,051: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec7d908>]}
2018-03-12 17:29:51,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec7d7f0>]}
2018-03-12 17:29:51,399: 17:29:51 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.33s]
2018-03-12 17:29:51,632: 17:29:51 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.35s]
2018-03-12 17:30:09,580: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecd7940>]}
2018-03-12 17:30:09,833: 17:30:09 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 20.86s]
2018-03-12 17:30:09,835: 17:30:09 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:30:09,835: Compiling model.seo_audit.search_console_proc
2018-03-12 17:30:09,850: 17:30:09 | 5 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:30:09,850: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:30:09,858: 17:30:09 | 6 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:30:09,859: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:30:09,924: 17:30:09 | 7 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:30:09,925: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:30:09,999: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:30:10,000: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:30:10,001: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:30:10,009: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:30:10,021: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:30:10,022: Re-using an available connection from the pool.
2018-03-12 17:30:10,025: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:30:10,025: Re-using an available connection from the pool.
2018-03-12 17:30:10,041: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:30:10,041: Re-using an available connection from the pool.
2018-03-12 17:30:10,049: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:30:10,049: Opening a new connection (4 currently allocated)
2018-03-12 17:30:10,991: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:30:11,005: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:30:11,070: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:30:11,352: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:30:13,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebfeb70>]}
2018-03-12 17:30:13,479: 17:30:13 | 5 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.35s]
2018-03-12 17:30:13,481: 17:30:13 | 8 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:30:13,484: Compiling model.seo_audit.moz_proc
2018-03-12 17:30:13,598: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:30:13,601: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:30:13,602: Re-using an available connection from the pool.
2018-03-12 17:30:14,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec9ed68>]}
2018-03-12 17:30:14,390: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:30:14,628: 17:30:14 | 7 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.40s]
2018-03-12 17:30:14,628: 17:30:14 | 9 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:30:14,628: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:30:14,644: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:30:14,645: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:30:14,646: Re-using an available connection from the pool.
2018-03-12 17:30:15,321: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:30:15,403: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec01ef0>]}
2018-03-12 17:30:15,646: 17:30:15 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.57s]
2018-03-12 17:30:15,646: 17:30:15 | 10 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-12 17:30:15,647: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:30:15,666: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:30:15,668: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:30:15,668: Re-using an available connection from the pool.
2018-03-12 17:30:16,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebfeb70>]}
2018-03-12 17:30:16,638: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:30:16,939: 17:30:16 | 8 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.12s]
2018-03-12 17:30:16,940: 17:30:16 | 11 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-12 17:30:16,940: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:30:16,955: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:30:16,965: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:30:16,965: Re-using an available connection from the pool.
2018-03-12 17:30:17,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec9ed68>]}
2018-03-12 17:30:17,788: 17:30:17 | 9 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.89s]
2018-03-12 17:30:17,803: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:30:17,896: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec9ee10>]}
2018-03-12 17:30:18,198: 17:30:18 | 6 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 8.04s]
2018-03-12 17:30:19,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec01ef0>]}
2018-03-12 17:30:20,234: 17:30:20 | 10 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 4.28s]
2018-03-12 17:30:31,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebfeb70>]}
2018-03-12 17:30:32,287: 17:30:32 | 11 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 15.02s]
2018-03-12 17:30:32,289: 17:30:32 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:30:32,290: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:30:32,289: 17:30:32 | 13 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:30:32,303: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:30:32,289: 17:30:32 | 14 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:30:32,316: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:30:32,321: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:30:32,290: 17:30:32 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:30:32,326: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:30:32,326: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:30:32,348: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:30:32,350: Re-using an available connection from the pool.
2018-03-12 17:30:32,315: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:30:32,360: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:30:32,345: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:30:32,366: Re-using an available connection from the pool.
2018-03-12 17:30:32,378: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:30:32,379: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:30:32,379: Re-using an available connection from the pool.
2018-03-12 17:30:32,380: Re-using an available connection from the pool.
2018-03-12 17:30:33,156: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:30:33,161: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:30:33,162: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:30:33,205: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:30:35,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b7736d8>]}
2018-03-12 17:30:35,374: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec6c438>]}
2018-03-12 17:30:35,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0079e8>]}
2018-03-12 17:30:35,631: 17:30:35 | 13 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.07s]
2018-03-12 17:30:35,921: 17:30:35 | 14 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.06s]
2018-03-12 17:30:36,124: 17:30:36 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.05s]
2018-03-12 17:30:59,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0131d0>]}
2018-03-12 17:31:00,412: 17:31:00 | 12 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 27.29s]
2018-03-12 17:31:00,417: 17:31:00 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 17:31:00,417: Compiling model.seo_audit.deepcrawl_class
2018-03-12 17:31:00,431: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 17:31:00,433: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 17:31:00,433: Re-using an available connection from the pool.
2018-03-12 17:31:01,113: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 17:31:12,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebfeb70>]}
2018-03-12 17:31:12,300: 17:31:12 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 11.63s]
2018-03-12 17:31:12,301: 17:31:12 | 17 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:31:12,302: 17:31:12 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:31:12,302: 17:31:12 | 19 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 17:31:12,303: 17:31:12 | 20 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 17:31:12,303: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:31:12,303: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:31:12,303: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 17:31:12,303: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:31:12,321: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:31:12,322: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:31:12,321: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 17:31:12,327: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 17:31:12,329: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:31:12,330: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:31:12,330: Re-using an available connection from the pool.
2018-03-12 17:31:12,331: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 17:31:12,331: Re-using an available connection from the pool.
2018-03-12 17:31:12,332: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 17:31:12,334: Re-using an available connection from the pool.
2018-03-12 17:31:12,336: Re-using an available connection from the pool.
2018-03-12 17:31:12,995: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 17:31:13,029: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 17:31:13,033: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:31:13,087: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:31:15,204: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb98f98>]}
2018-03-12 17:31:15,206: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c026be0>]}
2018-03-12 17:31:15,533: 17:31:15 | 19 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.90s]
2018-03-12 17:31:15,534: 17:31:15 | 21 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:31:15,534: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:31:15,544: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:31:15,547: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:31:15,547: Re-using an available connection from the pool.
2018-03-12 17:31:15,843: 17:31:15 | 20 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.90s]
2018-03-12 17:31:16,224: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:31:16,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebadf28>]}
2018-03-12 17:31:16,383: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c03b9b0>]}
2018-03-12 17:31:16,566: 17:31:16 | 17 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.97s]
2018-03-12 17:31:16,808: 17:31:16 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.08s]
2018-03-12 17:31:18,404: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb98f98>]}
2018-03-12 17:31:18,734: 17:31:18 | 21 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.87s]
2018-03-12 17:31:18,734: 17:31:18 | 22 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 17:31:18,735: 17:31:18 | 23 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 17:31:18,735: 17:31:18 | 24 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 17:31:18,735: 17:31:18 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 17:31:18,736: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:31:18,736: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:31:18,736: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:31:18,736: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:31:18,749: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 17:31:18,754: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 17:31:18,755: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 17:31:18,759: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 17:31:18,761: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 17:31:18,761: Re-using an available connection from the pool.
2018-03-12 17:31:18,763: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 17:31:18,763: Re-using an available connection from the pool.
2018-03-12 17:31:18,765: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 17:31:18,765: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 17:31:18,766: Re-using an available connection from the pool.
2018-03-12 17:31:18,769: Re-using an available connection from the pool.
2018-03-12 17:31:19,409: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 17:31:19,435: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 17:31:19,544: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:31:19,632: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:31:21,625: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec84668>]}
2018-03-12 17:31:21,627: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec01f60>]}
2018-03-12 17:31:21,817: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebfeb70>]}
2018-03-12 17:31:21,920: 17:31:21 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.89s]
2018-03-12 17:31:21,921: 17:31:21 | 26 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 17:31:21,924: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:31:21,934: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 17:31:21,935: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 17:31:21,935: Re-using an available connection from the pool.
2018-03-12 17:31:22,265: 17:31:22 | 23 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.89s]
2018-03-12 17:31:22,269: 17:31:22 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 17:31:22,271: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:31:22,276: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 17:31:22,277: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 17:31:22,277: Re-using an available connection from the pool.
2018-03-12 17:31:22,554: 17:31:22 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 3.08s]
2018-03-12 17:31:22,636: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:31:22,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec9e160>]}
2018-03-12 17:31:23,004: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 17:31:23,167: 17:31:23 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 4.13s]
2018-03-12 17:31:23,748: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec84668>]}
2018-03-12 17:31:24,027: 17:31:24 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.82s]
2018-03-12 17:31:25,184: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec7d4e0>]}
2018-03-12 17:31:25,487: 17:31:25 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.91s]
2018-03-12 17:31:25,487: 17:31:25 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 17:31:25,488: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:31:25,488: 17:31:25 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 17:31:25,494: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:31:25,499: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 17:31:25,501: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 17:31:25,488: 17:31:25 | 30 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 17:31:25,502: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:31:25,506: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 17:31:25,507: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 17:31:25,507: Re-using an available connection from the pool.
2018-03-12 17:31:25,508: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 17:31:25,508: Re-using an available connection from the pool.
2018-03-12 17:31:25,511: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 17:31:25,511: Re-using an available connection from the pool.
2018-03-12 17:31:26,154: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 17:31:26,155: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 17:31:26,259: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 17:31:27,235: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec6cf28>]}
2018-03-12 17:31:27,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0044a8>]}
2018-03-12 17:31:27,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0a9c2361-a0db-4ba0-8e53-baa68edc5ffd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb98f98>]}
2018-03-12 17:31:27,528: 17:31:27 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.73s]
2018-03-12 17:31:27,850: 17:31:27 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.75s]
2018-03-12 17:31:28,154: 17:31:28 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.85s]
2018-03-12 17:31:28,156: 17:31:28 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 17:31:28,156: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:31:28,200: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 17:31:28,205: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 17:31:28,205: Re-using an available connection from the pool.
2018-03-12 17:31:28,777: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-12 17:36:33,066: 17:36:33 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-03-12 17:36:33,069: Connection 'master' was left open.
2018-03-12 17:36:33,070: ctrl-c
2018-03-12 17:36:43,614: Tracking: tracking
2018-03-12 17:36:43,614: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113613da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113613e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136139e8>]}
2018-03-12 17:36:44,446: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:36:44,467: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:36:44,470: Parsing core.sql
2018-03-12 17:36:44,498: Parsing adapters/bigquery.sql
2018-03-12 17:36:44,510: Parsing adapters/common.sql
2018-03-12 17:36:44,527: Parsing adapters/postgres.sql
2018-03-12 17:36:44,533: Parsing adapters/redshift.sql
2018-03-12 17:36:44,554: Parsing etc/get_custom_schema.sql
2018-03-12 17:36:44,562: Parsing materializations/archive.sql
2018-03-12 17:36:44,600: Parsing materializations/bigquery.sql
2018-03-12 17:36:44,616: Parsing materializations/helpers.sql
2018-03-12 17:36:44,641: Parsing materializations/incremental.sql
2018-03-12 17:36:44,670: Parsing materializations/table.sql
2018-03-12 17:36:44,690: Parsing materializations/view.sql
2018-03-12 17:36:44,708: Parsing materializations/wrapper.sql
2018-03-12 17:36:44,716: Parsing schema_tests/accepted_values.sql
2018-03-12 17:36:44,725: Parsing schema_tests/not_null.sql
2018-03-12 17:36:44,731: Parsing schema_tests/relationships.sql
2018-03-12 17:36:44,739: Parsing schema_tests/unique.sql
2018-03-12 17:36:44,891: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:36:44,895: Acquiring new bigquery connection "master".
2018-03-12 17:36:44,895: Opening a new connection (0 currently allocated)
2018-03-12 17:36:44,902: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:36:44,906: Parsing model.seo_audit.actions_proc
2018-03-12 17:36:44,911: Parsing model.seo_audit.accounts_proc
2018-03-12 17:36:44,914: Parsing model.seo_audit.all_dates
2018-03-12 17:36:44,915: Parsing model.seo_audit.dates
2018-03-12 17:36:44,917: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:36:44,921: Parsing model.seo_audit.agg_all
2018-03-12 17:36:44,924: Parsing model.seo_audit.agg_indicative
2018-03-12 17:36:44,926: Parsing model.seo_audit.agg_stats
2018-03-12 17:36:44,932: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:36:44,935: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:36:44,938: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:36:44,939: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:36:44,941: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:36:44,943: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:36:44,945: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:36:44,948: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:36:44,951: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:36:44,959: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:36:44,961: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:36:44,963: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:36:44,964: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:36:44,966: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:36:44,968: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:36:44,970: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:36:44,974: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:36:44,976: Parsing model.seo_audit.ga_proc
2018-03-12 17:36:44,980: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:36:44,983: Parsing model.seo_audit.ga_stats
2018-03-12 17:36:44,986: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:36:44,988: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:36:44,991: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:36:44,993: Parsing model.seo_audit.moz_proc
2018-03-12 17:36:44,996: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:36:44,999: Parsing model.seo_audit.search_console_history
2018-03-12 17:36:45,001: Parsing model.seo_audit.search_console_proc
2018-03-12 17:36:45,004: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:36:45,007: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:36:45,009: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:36:45,012: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:36:45,014: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:36:45,018: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:36:45,021: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:36:45,023: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:36:45,026: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:36:45,041: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:36:45,059: 
2018-03-12 17:36:46,340: 17:36:46 | Concurrency: 4 threads (target='prod')
2018-03-12 17:36:46,340: 17:36:46 | 
2018-03-12 17:36:46,705: 17:36:46 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:36:46,705: Compiling model.seo_audit.all_dates
2018-03-12 17:36:46,710: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:36:46,705: 17:36:46 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:36:46,710: Compiling model.seo_audit.accounts_proc
2018-03-12 17:36:46,715: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:36:46,705: 17:36:46 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:36:46,716: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:36:46,722: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:36:46,723: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:36:46,723: Opening a new connection (1 currently allocated)
2018-03-12 17:36:46,724: Acquiring new bigquery connection "all_dates".
2018-03-12 17:36:46,724: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:36:46,726: Opening a new connection (2 currently allocated)
2018-03-12 17:36:46,836: Opening a new connection (3 currently allocated)
2018-03-12 17:36:47,810: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:36:47,843: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:36:47,893: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:36:48,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137f20f0>]}
2018-03-12 17:36:49,247: 17:36:49 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.23s]
2018-03-12 17:36:50,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137ae1d0>]}
2018-03-12 17:36:50,357: 17:36:50 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.35s]
2018-03-12 17:37:05,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fbe0>]}
2018-03-12 17:37:06,518: 17:37:06 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 19.10s]
2018-03-12 17:37:06,519: 17:37:06 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:37:06,520: 17:37:06 | 5 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:37:06,520: 17:37:06 | 6 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:37:06,520: 17:37:06 | 7 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:37:06,521: Compiling model.seo_audit.search_console_proc
2018-03-12 17:37:06,521: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:37:06,521: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:37:06,521: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:37:06,536: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:37:06,541: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:37:06,541: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:37:06,547: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:37:06,551: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:37:06,551: Re-using an available connection from the pool.
2018-03-12 17:37:06,553: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:37:06,554: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:37:06,555: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:37:06,556: Re-using an available connection from the pool.
2018-03-12 17:37:06,557: Re-using an available connection from the pool.
2018-03-12 17:37:06,557: Opening a new connection (4 currently allocated)
2018-03-12 17:37:07,300: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:37:07,366: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:37:07,443: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:37:08,140: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:37:09,558: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11373db00>]}
2018-03-12 17:37:09,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113794b38>]}
2018-03-12 17:37:09,863: 17:37:09 | 6 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.04s]
2018-03-12 17:37:09,865: 17:37:09 | 8 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:37:09,866: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:37:09,880: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:37:09,882: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:37:09,882: Re-using an available connection from the pool.
2018-03-12 17:37:10,194: 17:37:10 | 5 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.14s]
2018-03-12 17:37:10,194: 17:37:10 | 9 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:37:10,195: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:37:10,208: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:37:10,212: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:37:10,212: Re-using an available connection from the pool.
2018-03-12 17:37:10,399: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11012a6d8>]}
2018-03-12 17:37:10,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11375a748>]}
2018-03-12 17:37:10,558: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:37:10,744: 17:37:10 | 7 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.88s]
2018-03-12 17:37:10,745: 17:37:10 | 10 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-12 17:37:10,745: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:37:10,757: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:37:10,761: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:37:10,761: Re-using an available connection from the pool.
2018-03-12 17:37:10,898: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:37:11,121: 17:37:11 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.02s]
2018-03-12 17:37:11,122: 17:37:11 | 11 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-12 17:37:11,122: Compiling model.seo_audit.moz_proc
2018-03-12 17:37:11,135: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:37:11,136: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:37:11,136: Re-using an available connection from the pool.
2018-03-12 17:37:11,443: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:37:12,202: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:37:13,056: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11373db00>]}
2018-03-12 17:37:13,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377f470>]}
2018-03-12 17:37:13,336: 17:37:13 | 8 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.19s]
2018-03-12 17:37:13,620: 17:37:13 | 9 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.93s]
2018-03-12 17:37:14,364: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11375a748>]}
2018-03-12 17:37:14,652: 17:37:14 | 11 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 3.24s]
2018-03-12 17:37:17,949: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11012a6d8>]}
2018-03-12 17:37:18,253: 17:37:18 | 10 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 7.20s]
2018-03-12 17:37:18,254: 17:37:18 | 12 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:37:18,254: 17:37:18 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:37:18,255: 17:37:18 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:37:18,255: 17:37:18 | 15 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:37:18,255: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:37:18,256: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:37:18,256: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:37:18,256: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:37:18,267: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:37:18,270: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:37:18,274: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:37:18,281: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:37:18,285: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:37:18,286: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:37:18,286: Re-using an available connection from the pool.
2018-03-12 17:37:18,287: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:37:18,288: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:37:18,288: Re-using an available connection from the pool.
2018-03-12 17:37:18,293: Re-using an available connection from the pool.
2018-03-12 17:37:18,296: Re-using an available connection from the pool.
2018-03-12 17:37:18,940: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:37:18,949: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:37:18,950: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:37:18,974: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:37:21,109: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fd68>]}
2018-03-12 17:37:21,132: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fbe0>]}
2018-03-12 17:37:21,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1101a2a90>]}
2018-03-12 17:37:21,409: 17:37:21 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.85s]
2018-03-12 17:37:21,777: 17:37:21 | 12 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.88s]
2018-03-12 17:37:22,074: 17:37:22 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.90s]
2018-03-12 17:37:44,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11017d0f0>]}
2018-03-12 17:37:45,082: 17:37:45 | 15 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 26.51s]
2018-03-12 17:37:45,083: 17:37:45 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 17:37:45,083: Compiling model.seo_audit.deepcrawl_class
2018-03-12 17:37:45,094: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 17:37:45,095: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 17:37:45,095: Re-using an available connection from the pool.
2018-03-12 17:37:45,904: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 17:37:55,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11012a6d8>]}
2018-03-12 17:37:56,050: 17:37:56 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 10.64s]
2018-03-12 17:37:56,052: 17:37:56 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:37:56,053: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:37:56,052: 17:37:56 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:37:56,065: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:37:56,065: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:37:56,053: 17:37:56 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:37:56,070: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:37:56,053: 17:37:56 | 20 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 17:37:56,071: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:37:56,071: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:37:56,071: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 17:37:56,072: Re-using an available connection from the pool.
2018-03-12 17:37:56,078: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:37:56,083: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 17:37:56,086: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:37:56,093: Re-using an available connection from the pool.
2018-03-12 17:37:56,092: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 17:37:56,093: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:37:56,098: Re-using an available connection from the pool.
2018-03-12 17:37:56,102: Re-using an available connection from the pool.
2018-03-12 17:37:56,780: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:37:56,781: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 17:37:56,785: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:37:56,785: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:37:58,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113794eb8>]}
2018-03-12 17:37:58,993: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113822550>]}
2018-03-12 17:37:59,273: 17:37:59 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.90s]
2018-03-12 17:37:59,275: 17:37:59 | 21 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 17:37:59,276: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:37:59,286: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 17:37:59,288: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 17:37:59,288: Re-using an available connection from the pool.
2018-03-12 17:37:59,567: 17:37:59 | 20 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.92s]
2018-03-12 17:38:00,002: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 17:38:00,086: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113815860>]}
2018-03-12 17:38:00,306: 17:38:00 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.02s]
2018-03-12 17:38:02,173: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113726be0>]}
2018-03-12 17:38:02,398: 17:38:02 | 21 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.90s]
2018-03-12 17:38:03,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136e60b8>]}
2018-03-12 17:38:03,544: 17:38:03 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 7.26s]
2018-03-12 17:38:03,545: 17:38:03 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 17:38:03,546: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:38:03,546: 17:38:03 | 23 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 17:38:03,546: 17:38:03 | 24 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 17:38:03,546: 17:38:03 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 17:38:03,555: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 17:38:03,555: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:38:03,556: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:38:03,556: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:38:03,571: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 17:38:03,588: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 17:38:03,588: Re-using an available connection from the pool.
2018-03-12 17:38:03,573: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 17:38:03,595: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 17:38:03,583: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 17:38:03,598: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 17:38:03,601: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 17:38:03,603: Re-using an available connection from the pool.
2018-03-12 17:38:03,605: Re-using an available connection from the pool.
2018-03-12 17:38:03,611: Re-using an available connection from the pool.
2018-03-12 17:38:04,209: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:38:04,272: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 17:38:04,284: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 17:38:04,304: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 17:38:05,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fc88>]}
2018-03-12 17:38:05,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11012a6d8>]}
2018-03-12 17:38:05,614: 17:38:05 | 23 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.81s]
2018-03-12 17:38:05,615: 17:38:05 | 26 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 17:38:05,616: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:38:05,623: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 17:38:05,626: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 17:38:05,626: Re-using an available connection from the pool.
2018-03-12 17:38:05,914: 17:38:05 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.82s]
2018-03-12 17:38:05,914: 17:38:05 | 27 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 17:38:05,915: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:38:05,923: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 17:38:05,924: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 17:38:05,924: Re-using an available connection from the pool.
2018-03-12 17:38:06,266: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:38:06,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1101c9908>]}
2018-03-12 17:38:06,663: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:38:07,117: 17:38:07 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.94s]
2018-03-12 17:38:07,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fc88>]}
2018-03-12 17:38:07,637: 17:38:07 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.73s]
2018-03-12 17:38:07,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11012a6d8>]}
2018-03-12 17:38:08,054: 17:38:08 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.84s]
2018-03-12 17:38:09,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137c0438>]}
2018-03-12 17:38:09,869: 17:38:09 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 6.08s]
2018-03-12 17:38:09,870: 17:38:09 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 17:38:09,871: 17:38:09 | 29 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 17:38:09,871: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:38:09,871: 17:38:09 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 17:38:09,871: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:38:09,877: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:38:09,879: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 17:38:09,884: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 17:38:09,888: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 17:38:09,890: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 17:38:09,890: Re-using an available connection from the pool.
2018-03-12 17:38:09,891: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 17:38:09,892: Re-using an available connection from the pool.
2018-03-12 17:38:09,895: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 17:38:09,895: Re-using an available connection from the pool.
2018-03-12 17:38:10,508: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 17:38:10,544: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 17:38:10,548: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 17:38:11,605: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11375a748>]}
2018-03-12 17:38:11,629: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11373d438>]}
2018-03-12 17:38:11,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136e60b8>]}
2018-03-12 17:38:11,915: 17:38:11 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.73s]
2018-03-12 17:38:12,119: 17:38:12 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.75s]
2018-03-12 17:38:12,367: 17:38:12 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.76s]
2018-03-12 17:38:12,368: 17:38:12 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 17:38:12,368: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:38:12,388: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 17:38:12,389: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 17:38:12,389: Re-using an available connection from the pool.
2018-03-12 17:38:12,973: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-12 17:44:01,019: Unhandled error while running:
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-12 17:44:01,024: Runtime Error
  BigQuery Timeout Exceeded
2018-03-12 17:44:01,028: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffc8df58-8d16-403e-be1a-b66d9626a4f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113726630>]}
2018-03-12 17:44:02,172: 17:44:02 | 31 of 46 ERROR creating table model seo_audit.deepcrawl_reclass_proc. [ERROR in 348.66s]
2018-03-12 17:44:02,175: 17:44:02 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:44:02,176: 17:44:02 | 33 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:44:02,176: 17:44:02 | 34 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:44:02,177: 17:44:02 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:44:02,178: 17:44:02 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:44:02,178: 17:44:02 | 37 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:44:02,178: 17:44:02 | 38 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:44:02,179: 17:44:02 | 39 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:44:02,179: 17:44:02 | 40 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:44:02,180: 17:44:02 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:44:02,181: 17:44:02 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:44:02,181: 17:44:02 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:44:02,182: 17:44:02 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:44:02,182: 17:44:02 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:44:02,183: 17:44:02 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:44:02,297: 17:44:02 | 
2018-03-12 17:44:02,297: 17:44:02 | Finished running 46 table models in 435.95s.
2018-03-12 17:44:02,297: Connection 'master' was left open.
2018-03-12 17:44:02,298: 
2018-03-12 17:44:02,298: Completed with 1 errors:
2018-03-12 17:44:02,298: 
2018-03-12 17:44:02,298: Runtime Error in model deepcrawl_reclass_proc (models/base-adp/deepcrawl/deepcrawl_reclass_proc.sql)
2018-03-12 17:44:02,299:   Runtime Error
2018-03-12 17:44:02,299:     BigQuery Timeout Exceeded
2018-03-12 17:44:02,299: 
Done. PASS=30 ERROR=1 SKIP=15 TOTAL=46
2018-03-12 17:44:02,300: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11370b4e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136d3a20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136d3780>]}
2018-03-12 17:44:02,508: Flushing usage events
2018-03-12 17:45:59,222: Tracking: tracking
2018-03-12 17:45:59,223: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d731c18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d731b00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d731518>]}
2018-03-12 17:45:59,858: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:45:59,876: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:45:59,882: Parsing core.sql
2018-03-12 17:45:59,911: Parsing adapters/bigquery.sql
2018-03-12 17:45:59,918: Parsing adapters/common.sql
2018-03-12 17:45:59,937: Parsing adapters/postgres.sql
2018-03-12 17:45:59,943: Parsing adapters/redshift.sql
2018-03-12 17:45:59,965: Parsing etc/get_custom_schema.sql
2018-03-12 17:45:59,975: Parsing materializations/archive.sql
2018-03-12 17:46:00,011: Parsing materializations/bigquery.sql
2018-03-12 17:46:00,031: Parsing materializations/helpers.sql
2018-03-12 17:46:00,080: Parsing materializations/incremental.sql
2018-03-12 17:46:00,147: Parsing materializations/table.sql
2018-03-12 17:46:00,171: Parsing materializations/view.sql
2018-03-12 17:46:00,193: Parsing materializations/wrapper.sql
2018-03-12 17:46:00,201: Parsing schema_tests/accepted_values.sql
2018-03-12 17:46:00,209: Parsing schema_tests/not_null.sql
2018-03-12 17:46:00,215: Parsing schema_tests/relationships.sql
2018-03-12 17:46:00,223: Parsing schema_tests/unique.sql
2018-03-12 17:46:00,270: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:46:00,273: Acquiring new bigquery connection "master".
2018-03-12 17:46:00,274: Opening a new connection (0 currently allocated)
2018-03-12 17:46:00,281: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:46:00,287: Parsing model.seo_audit.actions_proc
2018-03-12 17:46:00,297: Parsing model.seo_audit.accounts_proc
2018-03-12 17:46:00,302: Parsing model.seo_audit.all_dates
2018-03-12 17:46:00,305: Parsing model.seo_audit.dates
2018-03-12 17:46:00,311: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:46:00,318: Parsing model.seo_audit.agg_all
2018-03-12 17:46:00,323: Parsing model.seo_audit.agg_indicative
2018-03-12 17:46:00,327: Parsing model.seo_audit.agg_stats
2018-03-12 17:46:00,332: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:46:00,336: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:46:00,340: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:46:00,343: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:46:00,347: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:46:00,349: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:46:00,352: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:46:00,355: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:46:00,358: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:46:00,366: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:46:00,368: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:46:00,370: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:46:00,372: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:46:00,374: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:46:00,376: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:46:00,378: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:46:00,382: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:46:00,384: Parsing model.seo_audit.ga_proc
2018-03-12 17:46:00,388: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:46:00,392: Parsing model.seo_audit.ga_stats
2018-03-12 17:46:00,395: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:46:00,397: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:46:00,400: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:46:00,402: Parsing model.seo_audit.moz_proc
2018-03-12 17:46:00,405: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:46:00,409: Parsing model.seo_audit.search_console_history
2018-03-12 17:46:00,411: Parsing model.seo_audit.search_console_proc
2018-03-12 17:46:00,414: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:46:00,417: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:46:00,419: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:46:00,422: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:46:00,425: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:46:00,429: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:46:00,431: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:46:00,433: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:46:00,436: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:46:00,457: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:46:00,477: 
2018-03-12 17:46:01,586: 17:46:01 | Concurrency: 4 threads (target='prod')
2018-03-12 17:46:01,586: 17:46:01 | 
2018-03-12 17:46:01,992: 17:46:01 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:46:01,992: 17:46:01 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:46:01,993: Compiling model.seo_audit.accounts_proc
2018-03-12 17:46:01,993: 17:46:01 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:46:01,993: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:46:01,998: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:46:01,998: Compiling model.seo_audit.all_dates
2018-03-12 17:46:02,005: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:46:02,010: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:46:02,013: Acquiring new bigquery connection "all_dates".
2018-03-12 17:46:02,013: Opening a new connection (1 currently allocated)
2018-03-12 17:46:02,014: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:46:02,015: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:46:02,017: Opening a new connection (2 currently allocated)
2018-03-12 17:46:02,073: Opening a new connection (3 currently allocated)
2018-03-12 17:46:03,171: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:46:03,176: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:46:03,213: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:46:04,258: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9055f8>]}
2018-03-12 17:46:04,629: 17:46:04 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.26s]
2018-03-12 17:46:05,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d85f128>]}
2018-03-12 17:46:05,637: 17:46:05 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.34s]
2018-03-12 17:46:20,522: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d91f4e0>]}
2018-03-12 17:46:20,859: 17:46:20 | 2 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 18.53s]
2018-03-12 17:46:20,862: 17:46:20 | 4 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 17:46:20,862: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:46:20,867: 17:46:20 | 5 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 17:46:20,868: Compiling model.seo_audit.moz_proc
2018-03-12 17:46:20,879: 17:46:20 | 6 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:46:20,880: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:46:20,883: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:46:20,883: Compiling model.seo_audit.search_console_proc
2018-03-12 17:46:20,879: 17:46:20 | 7 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:46:20,890: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:46:20,891: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:46:20,904: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:46:20,906: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:46:20,918: Re-using an available connection from the pool.
2018-03-12 17:46:20,925: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:46:20,925: Re-using an available connection from the pool.
2018-03-12 17:46:20,931: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:46:20,934: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:46:20,935: Re-using an available connection from the pool.
2018-03-12 17:46:20,935: Opening a new connection (4 currently allocated)
2018-03-12 17:46:21,672: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:46:21,764: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:46:21,798: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:46:21,946: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:46:23,853: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d943748>]}
2018-03-12 17:46:23,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d832be0>]}
2018-03-12 17:46:24,128: 17:46:24 | 7 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.96s]
2018-03-12 17:46:24,128: 17:46:24 | 8 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:46:24,128: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:46:24,142: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:46:24,145: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:46:24,149: Re-using an available connection from the pool.
2018-03-12 17:46:24,449: 17:46:24 | 5 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.06s]
2018-03-12 17:46:24,449: 17:46:24 | 9 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:46:24,450: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:46:24,466: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:46:24,468: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:46:24,468: Re-using an available connection from the pool.
2018-03-12 17:46:24,965: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:46:25,128: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:46:25,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed6d8>]}
2018-03-12 17:46:25,442: 17:46:25 | 4 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 4.29s]
2018-03-12 17:46:25,442: 17:46:25 | 10 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-12 17:46:25,442: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:46:25,454: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:46:25,455: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:46:25,455: Re-using an available connection from the pool.
2018-03-12 17:46:26,136: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:46:26,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8d0c88>]}
2018-03-12 17:46:26,577: 17:46:26 | 6 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.40s]
2018-03-12 17:46:26,577: 17:46:26 | 11 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-12 17:46:26,578: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:46:26,586: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:46:26,587: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:46:26,587: Re-using an available connection from the pool.
2018-03-12 17:46:27,130: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d813240>]}
2018-03-12 17:46:27,263: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:46:27,361: 17:46:27 | 8 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.00s]
2018-03-12 17:46:28,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed6d8>]}
2018-03-12 17:46:28,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d832be0>]}
2018-03-12 17:46:28,599: 17:46:28 | 10 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 2.86s]
2018-03-12 17:46:28,890: 17:46:28 | 9 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.97s]
2018-03-12 17:46:29,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8d0c88>]}
2018-03-12 17:46:29,763: 17:46:29 | 11 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 2.85s]
2018-03-12 17:46:29,764: 17:46:29 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:46:29,765: 17:46:29 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:46:29,765: 17:46:29 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:46:29,766: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:46:29,765: 17:46:29 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:46:29,766: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:46:29,766: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:46:29,777: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:46:29,778: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:46:29,782: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:46:29,787: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:46:29,794: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:46:29,795: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:46:29,796: Re-using an available connection from the pool.
2018-03-12 17:46:29,796: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:46:29,797: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:46:29,799: Re-using an available connection from the pool.
2018-03-12 17:46:29,800: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:46:29,801: Re-using an available connection from the pool.
2018-03-12 17:46:29,806: Re-using an available connection from the pool.
2018-03-12 17:46:30,539: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:46:30,631: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:46:30,654: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:46:30,809: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:46:32,730: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d905470>]}
2018-03-12 17:46:32,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'decd00e0-2e24-4203-880b-428890858cd7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d85f128>]}
2018-03-12 17:46:32,982: 17:46:32 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.96s]
2018-03-12 17:46:33,272: 17:46:33 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.19s]
2018-03-12 17:46:34,083: 17:46:34 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-03-12 17:46:34,083: Connection 'master' was left open.
2018-03-12 17:46:34,084: ctrl-c
2018-03-12 17:47:58,002: Tracking: tracking
2018-03-12 17:47:58,008: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e985f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e98390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b82be10>]}
2018-03-12 17:47:58,785: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:47:58,808: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:47:58,815: Parsing core.sql
2018-03-12 17:47:58,837: Parsing adapters/bigquery.sql
2018-03-12 17:47:58,845: Parsing adapters/common.sql
2018-03-12 17:47:58,873: Parsing adapters/postgres.sql
2018-03-12 17:47:58,880: Parsing adapters/redshift.sql
2018-03-12 17:47:58,901: Parsing etc/get_custom_schema.sql
2018-03-12 17:47:58,909: Parsing materializations/archive.sql
2018-03-12 17:47:58,951: Parsing materializations/bigquery.sql
2018-03-12 17:47:58,971: Parsing materializations/helpers.sql
2018-03-12 17:47:58,990: Parsing materializations/incremental.sql
2018-03-12 17:47:59,019: Parsing materializations/table.sql
2018-03-12 17:47:59,041: Parsing materializations/view.sql
2018-03-12 17:47:59,067: Parsing materializations/wrapper.sql
2018-03-12 17:47:59,073: Parsing schema_tests/accepted_values.sql
2018-03-12 17:47:59,081: Parsing schema_tests/not_null.sql
2018-03-12 17:47:59,086: Parsing schema_tests/relationships.sql
2018-03-12 17:47:59,094: Parsing schema_tests/unique.sql
2018-03-12 17:47:59,137: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:47:59,139: Acquiring new bigquery connection "master".
2018-03-12 17:47:59,139: Opening a new connection (0 currently allocated)
2018-03-12 17:47:59,144: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:47:59,150: Parsing model.seo_audit.actions_proc
2018-03-12 17:47:59,156: Parsing model.seo_audit.accounts_proc
2018-03-12 17:47:59,159: Parsing model.seo_audit.all_dates
2018-03-12 17:47:59,160: Parsing model.seo_audit.dates
2018-03-12 17:47:59,163: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:47:59,166: Parsing model.seo_audit.agg_all
2018-03-12 17:47:59,169: Parsing model.seo_audit.agg_indicative
2018-03-12 17:47:59,172: Parsing model.seo_audit.agg_stats
2018-03-12 17:47:59,177: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:47:59,180: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:47:59,183: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:47:59,185: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:47:59,187: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:47:59,189: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:47:59,191: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:47:59,198: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:47:59,202: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:47:59,210: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:47:59,212: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:47:59,214: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:47:59,216: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:47:59,218: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:47:59,220: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:47:59,222: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:47:59,225: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:47:59,227: Parsing model.seo_audit.ga_proc
2018-03-12 17:47:59,232: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:47:59,235: Parsing model.seo_audit.ga_stats
2018-03-12 17:47:59,239: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:47:59,241: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:47:59,245: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:47:59,248: Parsing model.seo_audit.moz_proc
2018-03-12 17:47:59,250: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:47:59,254: Parsing model.seo_audit.search_console_history
2018-03-12 17:47:59,257: Parsing model.seo_audit.search_console_proc
2018-03-12 17:47:59,260: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:47:59,263: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:47:59,265: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:47:59,268: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:47:59,272: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:47:59,278: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:47:59,281: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:47:59,283: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:47:59,286: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:47:59,303: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:47:59,323: 
2018-03-12 17:48:00,527: 17:48:00 | Concurrency: 4 threads (target='prod')
2018-03-12 17:48:00,527: 17:48:00 | 
2018-03-12 17:48:00,992: 17:48:00 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:48:00,993: Compiling model.seo_audit.all_dates
2018-03-12 17:48:00,992: 17:48:00 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:48:00,998: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:48:00,993: 17:48:00 | 3 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:48:00,998: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:48:00,998: Compiling model.seo_audit.accounts_proc
2018-03-12 17:48:01,005: Acquiring new bigquery connection "all_dates".
2018-03-12 17:48:01,006: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:48:01,013: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:48:01,013: Opening a new connection (1 currently allocated)
2018-03-12 17:48:01,021: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:48:01,026: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:48:01,026: Opening a new connection (2 currently allocated)
2018-03-12 17:48:01,135: Opening a new connection (3 currently allocated)
2018-03-12 17:48:02,160: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:48:02,161: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:48:02,178: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:48:03,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9bfa90>]}
2018-03-12 17:48:03,538: 17:48:03 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.25s]
2018-03-12 17:48:04,344: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba04320>]}
2018-03-12 17:48:04,668: 17:48:04 | 3 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.35s]
2018-03-12 17:48:44,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba1c320>]}
2018-03-12 17:48:44,898: 17:48:44 | 2 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 43.62s]
2018-03-12 17:48:44,901: 17:48:44 | 4 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:48:44,902: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:48:44,902: 17:48:44 | 5 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:48:44,903: 17:48:44 | 6 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:48:44,903: 17:48:44 | 7 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:48:44,915: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:48:44,922: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:48:44,922: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:48:44,922: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:48:44,928: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:48:44,936: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:48:44,944: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:48:44,945: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:48:44,946: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:48:44,947: Re-using an available connection from the pool.
2018-03-12 17:48:44,948: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:48:44,948: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:48:44,951: Re-using an available connection from the pool.
2018-03-12 17:48:44,965: Re-using an available connection from the pool.
2018-03-12 17:48:44,968: Opening a new connection (4 currently allocated)
2018-03-12 17:48:45,793: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:48:45,834: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:48:45,875: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:48:46,196: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:48:47,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b93bac8>]}
2018-03-12 17:48:48,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba1c198>]}
2018-03-12 17:48:48,043: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b96d8>]}
2018-03-12 17:48:48,272: 17:48:48 | 6 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.05s]
2018-03-12 17:48:48,274: 17:48:48 | 8 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:48:48,274: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:48:48,285: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:48:48,288: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:48:48,291: Re-using an available connection from the pool.
2018-03-12 17:48:48,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9184e0>]}
2018-03-12 17:48:48,611: 17:48:48 | 4 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.11s]
2018-03-12 17:48:48,615: 17:48:48 | 9 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:48:48,617: Compiling model.seo_audit.search_console_proc
2018-03-12 17:48:48,623: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:48:48,627: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:48:48,627: Re-using an available connection from the pool.
2018-03-12 17:48:48,862: 17:48:48 | 5 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.13s]
2018-03-12 17:48:48,862: 17:48:48 | 10 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-12 17:48:48,863: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:48:48,869: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:48:48,874: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:48:48,874: Re-using an available connection from the pool.
2018-03-12 17:48:49,073: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:48:49,159: 17:48:49 | 7 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.47s]
2018-03-12 17:48:49,159: 17:48:49 | 11 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-12 17:48:49,160: Compiling model.seo_audit.moz_proc
2018-03-12 17:48:49,171: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:48:49,175: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:48:49,176: Re-using an available connection from the pool.
2018-03-12 17:48:49,302: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:48:49,534: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:48:49,856: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:48:52,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b93bac8>]}
2018-03-12 17:48:52,656: 17:48:52 | 8 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 4.08s]
2018-03-12 17:48:52,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b96d8>]}
2018-03-12 17:48:53,081: 17:48:53 | 10 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.92s]
2018-03-12 17:48:53,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9184e0>]}
2018-03-12 17:48:53,427: 17:48:53 | 11 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 3.97s]
2018-03-12 17:48:53,626: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90a550>]}
2018-03-12 17:48:53,918: 17:48:53 | 9 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.01s]
2018-03-12 17:48:53,919: 17:48:53 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:48:53,920: 17:48:53 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:48:53,920: 17:48:53 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:48:53,920: 17:48:53 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:48:53,921: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:48:53,921: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:48:53,921: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:48:53,921: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:48:53,929: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:48:53,939: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:48:53,952: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:48:53,953: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:48:53,957: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:48:53,957: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:48:53,958: Re-using an available connection from the pool.
2018-03-12 17:48:53,958: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:48:53,960: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:48:53,960: Re-using an available connection from the pool.
2018-03-12 17:48:53,961: Re-using an available connection from the pool.
2018-03-12 17:48:53,963: Re-using an available connection from the pool.
2018-03-12 17:48:54,691: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:48:54,692: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:48:54,692: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:48:54,692: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:48:56,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9bf128>]}
2018-03-12 17:48:56,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b98e278>]}
2018-03-12 17:48:57,093: 17:48:57 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.96s]
2018-03-12 17:48:57,403: 17:48:57 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.98s]
2018-03-12 17:48:57,947: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c17860>]}
2018-03-12 17:48:58,166: 17:48:58 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.03s]
2018-03-12 17:49:24,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9ef358>]}
2018-03-12 17:49:24,859: 17:49:24 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 30.22s]
2018-03-12 17:49:24,859: 17:49:24 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 17:49:24,860: Compiling model.seo_audit.deepcrawl_class
2018-03-12 17:49:24,867: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 17:49:24,869: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 17:49:24,869: Re-using an available connection from the pool.
2018-03-12 17:49:25,609: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 17:49:37,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90a550>]}
2018-03-12 17:49:37,490: 17:49:37 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 12.38s]
2018-03-12 17:49:37,491: 17:49:37 | 17 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:49:37,492: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:49:37,499: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:49:37,491: 17:49:37 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:49:37,500: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:49:37,505: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:49:37,491: 17:49:37 | 19 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 17:49:37,505: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:49:37,492: 17:49:37 | 20 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 17:49:37,512: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:49:37,513: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:49:37,515: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 17:49:37,515: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 17:49:37,515: Re-using an available connection from the pool.
2018-03-12 17:49:37,524: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 17:49:37,525: Re-using an available connection from the pool.
2018-03-12 17:49:37,525: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 17:49:37,542: Re-using an available connection from the pool.
2018-03-12 17:49:37,532: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 17:49:37,546: Re-using an available connection from the pool.
2018-03-12 17:49:38,156: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:49:38,190: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 17:49:38,225: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 17:49:38,253: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:49:40,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c39518>]}
2018-03-12 17:49:40,385: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba160b8>]}
2018-03-12 17:49:40,647: 17:49:40 | 19 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.85s]
2018-03-12 17:49:40,648: 17:49:40 | 21 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:49:40,648: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:49:40,657: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:49:40,659: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:49:40,659: Re-using an available connection from the pool.
2018-03-12 17:49:40,894: 17:49:40 | 20 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.87s]
2018-03-12 17:49:41,346: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:49:41,404: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b918668>]}
2018-03-12 17:49:41,528: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c35d68>]}
2018-03-12 17:49:41,617: 17:49:41 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.90s]
2018-03-12 17:49:41,917: 17:49:41 | 17 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 4.04s]
2018-03-12 17:49:43,515: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b93ba90>]}
2018-03-12 17:49:43,798: 17:49:43 | 21 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.87s]
2018-03-12 17:49:43,798: 17:49:43 | 22 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 17:49:43,799: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:49:43,798: 17:49:43 | 23 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 17:49:43,805: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 17:49:43,805: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:49:43,799: 17:49:43 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 17:49:43,799: 17:49:43 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 17:49:43,811: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 17:49:43,812: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:49:43,812: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:49:43,813: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 17:49:43,825: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 17:49:43,826: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 17:49:43,828: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 17:49:43,829: Re-using an available connection from the pool.
2018-03-12 17:49:43,831: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 17:49:43,842: Re-using an available connection from the pool.
2018-03-12 17:49:43,832: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 17:49:43,847: Re-using an available connection from the pool.
2018-03-12 17:49:43,861: Re-using an available connection from the pool.
2018-03-12 17:49:44,471: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 17:49:44,524: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:49:44,550: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 17:49:44,599: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:49:45,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90a550>]}
2018-03-12 17:49:45,843: 17:49:45 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.74s]
2018-03-12 17:49:45,843: 17:49:45 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 17:49:45,843: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:49:45,849: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 17:49:45,851: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 17:49:45,851: Re-using an available connection from the pool.
2018-03-12 17:49:46,601: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 17:49:46,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba06ac8>]}
2018-03-12 17:49:46,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba0f438>]}
2018-03-12 17:49:46,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b937390>]}
2018-03-12 17:49:47,007: 17:49:47 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.90s]
2018-03-12 17:49:47,008: 17:49:47 | 27 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 17:49:47,009: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:49:47,020: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 17:49:47,023: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 17:49:47,023: Re-using an available connection from the pool.
2018-03-12 17:49:47,234: 17:49:47 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.90s]
2018-03-12 17:49:47,478: 17:49:47 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.97s]
2018-03-12 17:49:47,714: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:49:49,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90a0b8>]}
2018-03-12 17:49:50,210: 17:49:50 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.91s]
2018-03-12 17:49:59,792: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90a550>]}
2018-03-12 17:50:00,081: 17:50:00 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 13.95s]
2018-03-12 17:50:00,082: 17:50:00 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 17:50:00,082: 17:50:00 | 29 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 17:50:00,083: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:50:00,083: 17:50:00 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 17:50:00,083: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:50:00,093: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 17:50:00,093: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:50:00,106: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 17:50:00,107: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 17:50:00,107: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 17:50:00,108: Re-using an available connection from the pool.
2018-03-12 17:50:00,108: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 17:50:00,109: Re-using an available connection from the pool.
2018-03-12 17:50:00,113: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 17:50:00,115: Re-using an available connection from the pool.
2018-03-12 17:50:00,834: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 17:50:00,834: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 17:50:00,839: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 17:50:01,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b96d8>]}
2018-03-12 17:50:01,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b93b048>]}
2018-03-12 17:50:01,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9bf630>]}
2018-03-12 17:50:02,150: 17:50:02 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.82s]
2018-03-12 17:50:02,385: 17:50:02 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.83s]
2018-03-12 17:50:02,619: 17:50:02 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.85s]
2018-03-12 17:50:02,620: 17:50:02 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 17:50:02,620: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:50:02,633: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 17:50:02,634: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 17:50:02,634: Re-using an available connection from the pool.
2018-03-12 17:50:03,215: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 17:50:03,216: Bad request while running:
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 17:50:03,216: 400 Syntax error: Unexpected "." at [55:8]
2018-03-12 17:50:03,217: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '94b0bfac-79ef-4473-8a90-1d3d798a41a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b93bba8>]}
2018-03-12 17:50:03,552: 17:50:03 | 31 of 46 ERROR creating table model seo_audit.deepcrawl_reclass_proc. [ERROR in 0.60s]
2018-03-12 17:50:03,553: 17:50:03 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-12 17:50:03,554: 17:50:03 | 33 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:50:03,554: 17:50:03 | 34 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:50:03,555: 17:50:03 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:50:03,556: 17:50:03 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:50:03,556: 17:50:03 | 37 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:50:03,556: 17:50:03 | 38 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:50:03,557: 17:50:03 | 39 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:50:03,557: 17:50:03 | 40 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:50:03,558: 17:50:03 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:50:03,558: 17:50:03 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:50:03,558: 17:50:03 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:50:03,559: 17:50:03 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:50:03,560: 17:50:03 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:50:03,560: 17:50:03 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:50:03,640: 17:50:03 | 
2018-03-12 17:50:03,640: 17:50:03 | Finished running 46 table models in 123.11s.
2018-03-12 17:50:03,641: Connection 'master' was left open.
2018-03-12 17:50:03,641: 
2018-03-12 17:50:03,641: Completed with 1 errors:
2018-03-12 17:50:03,642: 
2018-03-12 17:50:03,642: Database Error in model deepcrawl_reclass_proc (models/base-adp/deepcrawl/deepcrawl_reclass_proc.sql)
2018-03-12 17:50:03,642:   Syntax error: Unexpected "." at [55:8]
2018-03-12 17:50:03,642:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass_proc.sql
2018-03-12 17:50:03,642: 
Done. PASS=30 ERROR=1 SKIP=15 TOTAL=46
2018-03-12 17:50:03,643: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8e2860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8e2710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b91b390>]}
2018-03-12 17:50:03,925: Flushing usage events
2018-03-12 17:50:30,980: Tracking: tracking
2018-03-12 17:50:30,982: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc8390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc8828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc8748>]}
2018-03-12 17:50:31,888: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 17:50:31,914: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 17:50:31,919: Parsing core.sql
2018-03-12 17:50:31,946: Parsing adapters/bigquery.sql
2018-03-12 17:50:31,953: Parsing adapters/common.sql
2018-03-12 17:50:31,972: Parsing adapters/postgres.sql
2018-03-12 17:50:31,979: Parsing adapters/redshift.sql
2018-03-12 17:50:32,004: Parsing etc/get_custom_schema.sql
2018-03-12 17:50:32,013: Parsing materializations/archive.sql
2018-03-12 17:50:32,056: Parsing materializations/bigquery.sql
2018-03-12 17:50:32,076: Parsing materializations/helpers.sql
2018-03-12 17:50:32,098: Parsing materializations/incremental.sql
2018-03-12 17:50:32,135: Parsing materializations/table.sql
2018-03-12 17:50:32,164: Parsing materializations/view.sql
2018-03-12 17:50:32,186: Parsing materializations/wrapper.sql
2018-03-12 17:50:32,192: Parsing schema_tests/accepted_values.sql
2018-03-12 17:50:32,199: Parsing schema_tests/not_null.sql
2018-03-12 17:50:32,203: Parsing schema_tests/relationships.sql
2018-03-12 17:50:32,210: Parsing schema_tests/unique.sql
2018-03-12 17:50:32,249: Parsing model.seo_audit.actions_data_studio
2018-03-12 17:50:32,252: Acquiring new bigquery connection "master".
2018-03-12 17:50:32,252: Opening a new connection (0 currently allocated)
2018-03-12 17:50:32,261: Parsing model.seo_audit.actions_hierarchy
2018-03-12 17:50:32,265: Parsing model.seo_audit.actions_proc
2018-03-12 17:50:32,272: Parsing model.seo_audit.accounts_proc
2018-03-12 17:50:32,277: Parsing model.seo_audit.all_dates
2018-03-12 17:50:32,279: Parsing model.seo_audit.dates
2018-03-12 17:50:32,284: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 17:50:32,288: Parsing model.seo_audit.agg_all
2018-03-12 17:50:32,293: Parsing model.seo_audit.agg_indicative
2018-03-12 17:50:32,298: Parsing model.seo_audit.agg_stats
2018-03-12 17:50:32,309: Parsing model.seo_audit.agg_stats_client
2018-03-12 17:50:32,315: Parsing model.seo_audit.deepcrawl_class
2018-03-12 17:50:32,322: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:50:32,326: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:50:32,331: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:50:32,334: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:50:32,354: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 17:50:32,368: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 17:50:32,375: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:50:32,402: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:50:32,409: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:50:32,413: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:50:32,419: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:50:32,423: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:50:32,427: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:50:32,429: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 17:50:32,434: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 17:50:32,436: Parsing model.seo_audit.ga_proc
2018-03-12 17:50:32,444: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 17:50:32,454: Parsing model.seo_audit.ga_stats
2018-03-12 17:50:32,462: Parsing model.seo_audit.majestic_domain_history
2018-03-12 17:50:32,467: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 17:50:32,473: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 17:50:32,477: Parsing model.seo_audit.moz_proc
2018-03-12 17:50:32,481: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 17:50:32,488: Parsing model.seo_audit.search_console_history
2018-03-12 17:50:32,493: Parsing model.seo_audit.search_console_proc
2018-03-12 17:50:32,499: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 17:50:32,504: Parsing model.seo_audit.search_console_stats_url
2018-03-12 17:50:32,508: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 17:50:32,515: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 17:50:32,521: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 17:50:32,534: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 17:50:32,540: Parsing model.seo_audit.semrush_url_history
2018-03-12 17:50:32,545: Parsing model.seo_audit.semrush_url_stats
2018-03-12 17:50:32,549: Parsing model.seo_audit.sitemap_proc
2018-03-12 17:50:32,575: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 17:50:32,636: 
2018-03-12 17:50:33,970: 17:50:33 | Concurrency: 4 threads (target='prod')
2018-03-12 17:50:33,970: 17:50:33 | 
2018-03-12 17:50:34,283: 17:50:34 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 17:50:34,284: Compiling model.seo_audit.accounts_proc
2018-03-12 17:50:34,289: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 17:50:34,283: 17:50:34 | 2 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 17:50:34,289: Compiling model.seo_audit.all_dates
2018-03-12 17:50:34,295: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 17:50:34,284: 17:50:34 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 17:50:34,295: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 17:50:34,296: Acquiring new bigquery connection "accounts_proc".
2018-03-12 17:50:34,303: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 17:50:34,303: Opening a new connection (1 currently allocated)
2018-03-12 17:50:34,304: Acquiring new bigquery connection "all_dates".
2018-03-12 17:50:34,363: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 17:50:34,379: Opening a new connection (2 currently allocated)
2018-03-12 17:50:34,382: Opening a new connection (3 currently allocated)
2018-03-12 17:50:35,346: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 17:50:35,383: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 17:50:35,481: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 17:50:37,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b748>]}
2018-03-12 17:50:37,800: 17:50:37 | 2 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.23s]
2018-03-12 17:50:39,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080c2550>]}
2018-03-12 17:50:40,120: 17:50:40 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 5.52s]
2018-03-12 17:50:52,799: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108145470>]}
2018-03-12 17:50:53,084: 17:50:53 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 18.50s]
2018-03-12 17:50:53,084: 17:50:53 | 4 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 17:50:53,085: 17:50:53 | 5 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 17:50:53,085: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 17:50:53,085: 17:50:53 | 6 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 17:50:53,092: Compiling model.seo_audit.sitemap_proc
2018-03-12 17:50:53,085: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 17:50:53,092: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 17:50:53,085: 17:50:53 | 7 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 17:50:53,100: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 17:50:53,108: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 17:50:53,108: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 17:50:53,116: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 17:50:53,117: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 17:50:53,117: Re-using an available connection from the pool.
2018-03-12 17:50:53,118: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 17:50:53,124: Re-using an available connection from the pool.
2018-03-12 17:50:53,121: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 17:50:53,129: Re-using an available connection from the pool.
2018-03-12 17:50:53,124: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 17:50:53,137: Opening a new connection (4 currently allocated)
2018-03-12 17:50:54,025: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 17:50:54,031: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 17:50:54,064: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 17:50:54,390: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:50:56,208: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b0b8>]}
2018-03-12 17:50:56,252: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148160>]}
2018-03-12 17:50:56,492: 17:50:56 | 6 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.12s]
2018-03-12 17:50:56,493: 17:50:56 | 8 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 17:50:56,494: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 17:50:56,511: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 17:50:56,512: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 17:50:56,512: Re-using an available connection from the pool.
2018-03-12 17:50:56,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b6a0>]}
2018-03-12 17:50:56,869: 17:50:56 | 5 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.17s]
2018-03-12 17:50:56,871: 17:50:56 | 9 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 17:50:56,872: Compiling model.seo_audit.search_console_proc
2018-03-12 17:50:56,879: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 17:50:56,883: Acquiring new bigquery connection "search_console_proc".
2018-03-12 17:50:56,883: Re-using an available connection from the pool.
2018-03-12 17:50:57,178: 17:50:57 | 7 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.46s]
2018-03-12 17:50:57,178: 17:50:57 | 10 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-12 17:50:57,178: Compiling model.seo_audit.moz_proc
2018-03-12 17:50:57,186: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 17:50:57,189: Acquiring new bigquery connection "moz_proc".
2018-03-12 17:50:57,189: Re-using an available connection from the pool.
2018-03-12 17:50:57,230: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 17:50:57,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080b1fd0>]}
2018-03-12 17:50:57,531: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 17:50:57,611: 17:50:57 | 4 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 4.18s]
2018-03-12 17:50:57,611: 17:50:57 | 11 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-12 17:50:57,611: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 17:50:57,623: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 17:50:57,626: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 17:50:57,626: Re-using an available connection from the pool.
2018-03-12 17:50:57,919: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 17:50:58,280: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 17:50:59,390: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b0b8>]}
2018-03-12 17:50:59,589: 17:50:59 | 8 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.90s]
2018-03-12 17:51:00,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b6a0>]}
2018-03-12 17:51:00,307: 17:51:00 | 10 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 2.93s]
2018-03-12 17:51:00,468: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cc9cf8>]}
2018-03-12 17:51:00,675: 17:51:00 | 11 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.86s]
2018-03-12 17:51:00,837: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148160>]}
2018-03-12 17:51:01,186: 17:51:01 | 9 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.96s]
2018-03-12 17:51:01,186: 17:51:01 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 17:51:01,187: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 17:51:01,187: 17:51:01 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 17:51:01,196: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 17:51:01,187: 17:51:01 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 17:51:01,197: Compiling model.seo_audit.semrush_url_history
2018-03-12 17:51:01,187: 17:51:01 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 17:51:01,197: Compiling model.seo_audit.majestic_domain_history
2018-03-12 17:51:01,203: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 17:51:01,203: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 17:51:01,204: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 17:51:01,224: Re-using an available connection from the pool.
2018-03-12 17:51:01,210: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 17:51:01,212: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 17:51:01,229: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 17:51:01,233: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 17:51:01,234: Re-using an available connection from the pool.
2018-03-12 17:51:01,236: Re-using an available connection from the pool.
2018-03-12 17:51:01,239: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 17:51:01,244: Re-using an available connection from the pool.
2018-03-12 17:51:01,859: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 17:51:01,870: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 17:51:01,910: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 17:51:01,911: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 17:51:04,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081bba20>]}
2018-03-12 17:51:04,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081317f0>]}
2018-03-12 17:51:04,324: 17:51:04 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.82s]
2018-03-12 17:51:04,615: 17:51:04 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.93s]
2018-03-12 17:51:05,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080b1b70>]}
2018-03-12 17:51:05,304: 17:51:05 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.90s]
2018-03-12 17:51:34,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108145470>]}
2018-03-12 17:51:35,264: 17:51:35 | 12 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 33.40s]
2018-03-12 17:51:35,265: 17:51:35 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 17:51:35,266: Compiling model.seo_audit.deepcrawl_class
2018-03-12 17:51:35,275: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 17:51:35,278: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 17:51:35,278: Re-using an available connection from the pool.
2018-03-12 17:51:36,189: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 17:51:44,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148160>]}
2018-03-12 17:51:45,155: 17:51:45 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 9.67s]
2018-03-12 17:51:45,156: 17:51:45 | 17 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 17:51:45,157: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 17:51:45,157: 17:51:45 | 18 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 17:51:45,163: Compiling model.seo_audit.semrush_url_stats
2018-03-12 17:51:45,168: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 17:51:45,170: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 17:51:45,157: 17:51:45 | 19 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 17:51:45,171: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 17:51:45,175: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 17:51:45,176: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 17:51:45,176: Re-using an available connection from the pool.
2018-03-12 17:51:45,178: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 17:51:45,178: Re-using an available connection from the pool.
2018-03-12 17:51:45,180: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 17:51:45,180: Re-using an available connection from the pool.
2018-03-12 17:51:45,157: 17:51:45 | 20 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 17:51:45,182: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 17:51:45,195: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 17:51:45,197: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 17:51:45,197: Re-using an available connection from the pool.
2018-03-12 17:51:45,861: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 17:51:45,913: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 17:51:45,933: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:51:46,001: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 17:51:48,026: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148d68>]}
2018-03-12 17:51:48,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081376a0>]}
2018-03-12 17:51:48,314: 17:51:48 | 19 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.85s]
2018-03-12 17:51:48,315: 17:51:48 | 21 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 17:51:48,316: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 17:51:48,326: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 17:51:48,330: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 17:51:48,330: Re-using an available connection from the pool.
2018-03-12 17:51:48,717: 17:51:48 | 20 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.99s]
2018-03-12 17:51:49,185: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108145470>]}
2018-03-12 17:51:49,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108196080>]}
2018-03-12 17:51:49,393: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 17:51:49,466: 17:51:49 | 17 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.03s]
2018-03-12 17:51:49,674: 17:51:49 | 18 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 4.06s]
2018-03-12 17:51:51,596: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148d68>]}
2018-03-12 17:51:51,818: 17:51:51 | 21 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.28s]
2018-03-12 17:51:51,819: 17:51:51 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 17:51:51,820: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 17:51:51,819: 17:51:51 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 17:51:51,826: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 17:51:51,831: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 17:51:51,832: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 17:51:51,820: 17:51:51 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 17:51:51,833: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 17:51:51,837: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 17:51:51,820: 17:51:51 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 17:51:51,837: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 17:51:51,842: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 17:51:51,843: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 17:51:51,843: Re-using an available connection from the pool.
2018-03-12 17:51:51,844: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 17:51:51,845: Re-using an available connection from the pool.
2018-03-12 17:51:51,846: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 17:51:51,847: Re-using an available connection from the pool.
2018-03-12 17:51:51,848: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 17:51:51,849: Re-using an available connection from the pool.
2018-03-12 17:51:52,482: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:51:52,498: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 17:51:52,514: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 17:51:52,537: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 17:51:53,580: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081bbd30>]}
2018-03-12 17:51:53,973: 17:51:53 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.75s]
2018-03-12 17:51:53,974: 17:51:53 | 26 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 17:51:53,974: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 17:51:53,984: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 17:51:53,986: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 17:51:53,987: Re-using an available connection from the pool.
2018-03-12 17:51:54,592: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:51:55,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081dbdd8>]}
2018-03-12 17:51:55,103: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108196080>]}
2018-03-12 17:51:55,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148160>]}
2018-03-12 17:51:55,396: 17:51:55 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.25s]
2018-03-12 17:51:55,397: 17:51:55 | 27 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 17:51:55,397: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 17:51:55,405: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 17:51:55,408: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 17:51:55,408: Re-using an available connection from the pool.
2018-03-12 17:51:55,681: 17:51:55 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.27s]
2018-03-12 17:51:55,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d1b4e0>]}
2018-03-12 17:51:55,936: 17:51:55 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.29s]
2018-03-12 17:51:56,284: 17:51:56 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.94s]
2018-03-12 17:51:57,059: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 17:51:58,164: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108145470>]}
2018-03-12 17:51:58,471: 17:51:58 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.77s]
2018-03-12 17:51:58,472: 17:51:58 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 17:51:58,472: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 17:51:58,473: 17:51:58 | 29 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 17:51:58,480: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 17:51:58,478: 17:51:58 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 17:51:58,481: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 17:51:58,481: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 17:51:58,486: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 17:51:58,490: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 17:51:58,491: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 17:51:58,491: Re-using an available connection from the pool.
2018-03-12 17:51:58,492: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 17:51:58,493: Re-using an available connection from the pool.
2018-03-12 17:51:58,494: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 17:51:58,497: Re-using an available connection from the pool.
2018-03-12 17:51:59,145: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 17:51:59,148: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 17:51:59,174: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 17:52:00,348: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10817b710>]}
2018-03-12 17:52:00,364: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108148d68>]}
2018-03-12 17:52:00,365: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081376a0>]}
2018-03-12 17:52:00,574: 17:52:00 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.87s]
2018-03-12 17:52:00,894: 17:52:00 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.89s]
2018-03-12 17:52:01,201: 17:52:01 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.88s]
2018-03-12 17:52:01,203: 17:52:01 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 17:52:01,204: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 17:52:01,222: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 17:52:01,223: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 17:52:01,223: Re-using an available connection from the pool.
2018-03-12 17:52:01,787: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 17:52:12,083: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108145470>]}
2018-03-12 17:52:12,400: 17:52:12 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 10.88s]
2018-03-12 17:52:12,401: 17:52:12 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-12 17:52:12,401: Compiling model.seo_audit.deepcrawl_reclass
2018-03-12 17:52:12,415: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-12 17:52:12,416: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-12 17:52:12,417: Re-using an available connection from the pool.
2018-03-12 17:52:13,065: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-12 17:52:13,067: Bad request while running:
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-12 17:52:13,067: 400 Unrecognized name: class_if_unclassified at [6:50]
2018-03-12 17:52:13,068: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '495e87ca-58aa-41e0-8e6d-e1fed57527a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108139278>]}
2018-03-12 17:52:13,310: 17:52:13 | 32 of 46 ERROR creating table model seo_audit.deepcrawl_reclass...... [ERROR in 0.67s]
2018-03-12 17:52:13,311: 17:52:13 | 33 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-12 17:52:13,312: 17:52:13 | 34 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-12 17:52:13,313: 17:52:13 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-12 17:52:13,313: 17:52:13 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-12 17:52:13,314: 17:52:13 | 37 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-12 17:52:13,314: 17:52:13 | 38 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-12 17:52:13,314: 17:52:13 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-12 17:52:13,315: 17:52:13 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-12 17:52:13,315: 17:52:13 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-12 17:52:13,316: 17:52:13 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-12 17:52:13,316: 17:52:13 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-12 17:52:13,317: 17:52:13 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-12 17:52:13,317: 17:52:13 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 17:52:13,318: 17:52:13 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 17:52:13,369: 17:52:13 | 
2018-03-12 17:52:13,370: 17:52:13 | Finished running 46 table models in 99.40s.
2018-03-12 17:52:13,370: Connection 'master' was left open.
2018-03-12 17:52:13,371: 
2018-03-12 17:52:13,371: Completed with 1 errors:
2018-03-12 17:52:13,371: 
2018-03-12 17:52:13,371: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-03-12 17:52:13,371:   Unrecognized name: class_if_unclassified at [6:50]
2018-03-12 17:52:13,371:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-03-12 17:52:13,372: 
Done. PASS=31 ERROR=1 SKIP=14 TOTAL=46
2018-03-12 17:52:13,372: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10809a7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10809a6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10809a668>]}
2018-03-12 17:52:13,676: Flushing usage events
2018-03-12 20:34:09,380: Tracking: tracking
2018-03-12 20:34:09,384: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111696da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111696e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116969e8>]}
2018-03-12 20:34:10,206: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 20:34:10,225: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 20:34:10,232: Parsing core.sql
2018-03-12 20:34:10,256: Parsing adapters/bigquery.sql
2018-03-12 20:34:10,269: Parsing adapters/common.sql
2018-03-12 20:34:10,287: Parsing adapters/postgres.sql
2018-03-12 20:34:10,293: Parsing adapters/redshift.sql
2018-03-12 20:34:10,320: Parsing etc/get_custom_schema.sql
2018-03-12 20:34:10,331: Parsing materializations/archive.sql
2018-03-12 20:34:10,383: Parsing materializations/bigquery.sql
2018-03-12 20:34:10,403: Parsing materializations/helpers.sql
2018-03-12 20:34:10,424: Parsing materializations/incremental.sql
2018-03-12 20:34:10,458: Parsing materializations/table.sql
2018-03-12 20:34:10,483: Parsing materializations/view.sql
2018-03-12 20:34:10,500: Parsing materializations/wrapper.sql
2018-03-12 20:34:10,509: Parsing schema_tests/accepted_values.sql
2018-03-12 20:34:10,517: Parsing schema_tests/not_null.sql
2018-03-12 20:34:10,522: Parsing schema_tests/relationships.sql
2018-03-12 20:34:10,528: Parsing schema_tests/unique.sql
2018-03-12 20:34:10,638: Parsing model.seo_audit.actions_data_studio
2018-03-12 20:34:10,642: Acquiring new bigquery connection "master".
2018-03-12 20:34:10,642: Opening a new connection (0 currently allocated)
2018-03-12 20:34:10,647: Parsing model.seo_audit.actions_hierarchy
2018-03-12 20:34:10,650: Parsing model.seo_audit.actions_proc
2018-03-12 20:34:10,655: Parsing model.seo_audit.accounts_proc
2018-03-12 20:34:10,658: Parsing model.seo_audit.all_dates
2018-03-12 20:34:10,659: Parsing model.seo_audit.dates
2018-03-12 20:34:10,662: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 20:34:10,665: Parsing model.seo_audit.agg_all
2018-03-12 20:34:10,668: Parsing model.seo_audit.agg_indicative
2018-03-12 20:34:10,670: Parsing model.seo_audit.agg_stats
2018-03-12 20:34:10,675: Parsing model.seo_audit.agg_stats_client
2018-03-12 20:34:10,679: Parsing model.seo_audit.deepcrawl_class
2018-03-12 20:34:10,682: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 20:34:10,683: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 20:34:10,685: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 20:34:10,687: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 20:34:10,689: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 20:34:10,692: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 20:34:10,695: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 20:34:10,706: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 20:34:10,709: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 20:34:10,712: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 20:34:10,714: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 20:34:10,716: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 20:34:10,718: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 20:34:10,720: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 20:34:10,723: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 20:34:10,725: Parsing model.seo_audit.ga_proc
2018-03-12 20:34:10,729: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 20:34:10,732: Parsing model.seo_audit.ga_stats
2018-03-12 20:34:10,735: Parsing model.seo_audit.majestic_domain_history
2018-03-12 20:34:10,737: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 20:34:10,740: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 20:34:10,742: Parsing model.seo_audit.moz_proc
2018-03-12 20:34:10,745: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 20:34:10,749: Parsing model.seo_audit.search_console_history
2018-03-12 20:34:10,751: Parsing model.seo_audit.search_console_proc
2018-03-12 20:34:10,753: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 20:34:10,756: Parsing model.seo_audit.search_console_stats_url
2018-03-12 20:34:10,758: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 20:34:10,761: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 20:34:10,764: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 20:34:10,767: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 20:34:10,769: Parsing model.seo_audit.semrush_url_history
2018-03-12 20:34:10,771: Parsing model.seo_audit.semrush_url_stats
2018-03-12 20:34:10,774: Parsing model.seo_audit.sitemap_proc
2018-03-12 20:34:10,788: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 20:34:10,803: 
2018-03-12 20:34:12,009: 20:34:12 | Concurrency: 4 threads (target='prod')
2018-03-12 20:34:12,009: 20:34:12 | 
2018-03-12 20:34:12,410: 20:34:12 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 20:34:12,411: Compiling model.seo_audit.accounts_proc
2018-03-12 20:34:12,415: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 20:34:12,410: 20:34:12 | 2 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 20:34:12,410: 20:34:12 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 20:34:12,416: Compiling model.seo_audit.all_dates
2018-03-12 20:34:12,416: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 20:34:12,420: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 20:34:12,421: Acquiring new bigquery connection "accounts_proc".
2018-03-12 20:34:12,426: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 20:34:12,427: Opening a new connection (1 currently allocated)
2018-03-12 20:34:12,430: Acquiring new bigquery connection "all_dates".
2018-03-12 20:34:12,433: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 20:34:12,434: Opening a new connection (2 currently allocated)
2018-03-12 20:34:12,491: Opening a new connection (3 currently allocated)
2018-03-12 20:34:13,625: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 20:34:13,654: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 20:34:13,676: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 20:34:15,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118fc438>]}
2018-03-12 20:34:15,889: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11187fcf8>]}
2018-03-12 20:34:16,163: 20:34:16 | 2 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.45s]
2018-03-12 20:34:17,414: 20:34:17 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.48s]
2018-03-12 20:34:31,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11187ffd0>]}
2018-03-12 20:34:31,539: 20:34:31 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 18.82s]
2018-03-12 20:34:31,540: 20:34:31 | 4 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 20:34:31,541: 20:34:31 | 5 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 20:34:31,541: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 20:34:31,541: 20:34:31 | 6 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 20:34:31,542: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 20:34:31,541: 20:34:31 | 7 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 20:34:31,548: Compiling model.seo_audit.search_console_proc
2018-03-12 20:34:31,551: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 20:34:31,557: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 20:34:31,557: Compiling model.seo_audit.sitemap_proc
2018-03-12 20:34:31,562: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 20:34:31,570: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 20:34:31,573: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 20:34:31,573: Re-using an available connection from the pool.
2018-03-12 20:34:31,575: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 20:34:31,575: Re-using an available connection from the pool.
2018-03-12 20:34:31,576: Acquiring new bigquery connection "search_console_proc".
2018-03-12 20:34:31,577: Re-using an available connection from the pool.
2018-03-12 20:34:31,580: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 20:34:31,582: Opening a new connection (4 currently allocated)
2018-03-12 20:34:32,333: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 20:34:32,412: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 20:34:32,495: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 20:34:32,709: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 20:34:34,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11187ff28>]}
2018-03-12 20:34:34,848: 20:34:34 | 4 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.01s]
2018-03-12 20:34:34,849: 20:34:34 | 8 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 20:34:34,849: Compiling model.seo_audit.moz_proc
2018-03-12 20:34:34,857: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 20:34:34,858: Acquiring new bigquery connection "moz_proc".
2018-03-12 20:34:34,858: Re-using an available connection from the pool.
2018-03-12 20:34:35,701: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 20:34:35,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4ba8>]}
2018-03-12 20:34:35,983: 20:34:35 | 5 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 4.22s]
2018-03-12 20:34:35,984: 20:34:35 | 9 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 20:34:35,984: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 20:34:35,994: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 20:34:35,996: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 20:34:35,996: Re-using an available connection from the pool.
2018-03-12 20:34:36,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111763d68>]}
2018-03-12 20:34:36,252: 20:34:36 | 7 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.48s]
2018-03-12 20:34:36,252: 20:34:36 | 10 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-12 20:34:36,253: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 20:34:36,261: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 20:34:36,262: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 20:34:36,262: Re-using an available connection from the pool.
2018-03-12 20:34:36,713: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 20:34:36,796: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118e5828>]}
2018-03-12 20:34:36,963: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 20:34:37,083: 20:34:37 | 6 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.25s]
2018-03-12 20:34:37,084: 20:34:37 | 11 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-12 20:34:37,084: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 20:34:37,096: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 20:34:37,099: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 20:34:37,099: Re-using an available connection from the pool.
2018-03-12 20:34:37,813: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 20:34:37,905: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111756c18>]}
2018-03-12 20:34:38,192: 20:34:38 | 8 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.06s]
2018-03-12 20:34:39,160: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111763d68>]}
2018-03-12 20:34:39,451: 20:34:39 | 10 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 2.91s]
2018-03-12 20:34:39,993: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118fc5f8>]}
2018-03-12 20:34:40,024: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4ba8>]}
2018-03-12 20:34:40,278: 20:34:40 | 11 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.91s]
2018-03-12 20:34:40,554: 20:34:40 | 9 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.04s]
2018-03-12 20:34:40,555: 20:34:40 | 12 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 20:34:40,556: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 20:34:40,556: 20:34:40 | 13 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 20:34:40,567: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 20:34:40,556: 20:34:40 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 20:34:40,567: Compiling model.seo_audit.majestic_domain_history
2018-03-12 20:34:40,556: 20:34:40 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 20:34:40,568: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 20:34:40,573: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 20:34:40,574: Compiling model.seo_audit.semrush_url_history
2018-03-12 20:34:40,574: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 20:34:40,591: Re-using an available connection from the pool.
2018-03-12 20:34:40,581: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 20:34:40,590: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 20:34:40,601: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 20:34:40,604: Re-using an available connection from the pool.
2018-03-12 20:34:40,607: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 20:34:40,616: Re-using an available connection from the pool.
2018-03-12 20:34:40,615: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 20:34:40,621: Re-using an available connection from the pool.
2018-03-12 20:34:41,226: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 20:34:41,301: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 20:34:41,339: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 20:34:41,413: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 20:34:43,435: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111896a58>]}
2018-03-12 20:34:43,506: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1119152b0>]}
2018-03-12 20:34:43,549: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11187ffd0>]}
2018-03-12 20:34:44,258: 20:34:44 | 13 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.87s]
2018-03-12 20:34:44,473: 20:34:44 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.93s]
2018-03-12 20:34:44,712: 20:34:44 | 12 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.99s]
2018-03-12 20:35:08,092: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec26f28>]}
2018-03-12 20:35:08,395: 20:35:08 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 27.52s]
2018-03-12 20:35:08,396: 20:35:08 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 20:35:08,396: Compiling model.seo_audit.deepcrawl_class
2018-03-12 20:35:08,403: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 20:35:08,404: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 20:35:08,404: Re-using an available connection from the pool.
2018-03-12 20:35:09,243: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 20:35:18,414: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111875c50>]}
2018-03-12 20:35:19,160: 20:35:19 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 10.02s]
2018-03-12 20:35:19,161: 20:35:19 | 17 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 20:35:19,162: Compiling model.seo_audit.semrush_url_stats
2018-03-12 20:35:19,161: 20:35:19 | 18 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 20:35:19,161: 20:35:19 | 19 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 20:35:19,170: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 20:35:19,170: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 20:35:19,161: 20:35:19 | 20 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 20:35:19,170: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 20:35:19,175: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 20:35:19,176: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 20:35:19,181: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 20:35:19,182: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 20:35:19,188: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 20:35:19,188: Re-using an available connection from the pool.
2018-03-12 20:35:19,189: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 20:35:19,190: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 20:35:19,190: Re-using an available connection from the pool.
2018-03-12 20:35:19,193: Re-using an available connection from the pool.
2018-03-12 20:35:19,196: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 20:35:19,200: Re-using an available connection from the pool.
2018-03-12 20:35:19,895: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 20:35:19,904: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 20:35:19,971: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 20:35:19,996: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 20:35:22,106: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118e5358>]}
2018-03-12 20:35:22,108: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a470>]}
2018-03-12 20:35:22,163: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11187ffd0>]}
2018-03-12 20:35:22,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11182e5c0>]}
2018-03-12 20:35:22,415: 20:35:22 | 18 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.94s]
2018-03-12 20:35:22,417: 20:35:22 | 21 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 20:35:22,417: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 20:35:22,426: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 20:35:22,431: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 20:35:22,431: Re-using an available connection from the pool.
2018-03-12 20:35:22,809: 20:35:22 | 20 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.93s]
2018-03-12 20:35:23,134: 20:35:23 | 19 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.99s]
2018-03-12 20:35:23,263: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 20:35:23,357: 20:35:23 | 17 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.01s]
2018-03-12 20:35:25,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:35:25,789: 20:35:25 | 21 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.06s]
2018-03-12 20:35:25,790: 20:35:25 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 20:35:25,791: 20:35:25 | 23 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 20:35:25,791: 20:35:25 | 24 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 20:35:25,791: 20:35:25 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 20:35:25,791: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 20:35:25,792: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 20:35:25,792: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 20:35:25,792: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 20:35:25,807: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 20:35:25,809: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 20:35:25,814: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 20:35:25,818: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 20:35:25,820: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 20:35:25,820: Re-using an available connection from the pool.
2018-03-12 20:35:25,821: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 20:35:25,821: Re-using an available connection from the pool.
2018-03-12 20:35:25,824: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 20:35:25,825: Re-using an available connection from the pool.
2018-03-12 20:35:25,829: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 20:35:25,831: Re-using an available connection from the pool.
2018-03-12 20:35:26,436: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 20:35:26,523: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 20:35:26,524: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 20:35:26,570: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:35:27,511: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a588>]}
2018-03-12 20:35:27,823: 20:35:27 | 23 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.72s]
2018-03-12 20:35:27,824: 20:35:27 | 26 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 20:35:27,824: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 20:35:27,834: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 20:35:27,835: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 20:35:27,835: Re-using an available connection from the pool.
2018-03-12 20:35:28,603: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:35:28,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118fc080>]}
2018-03-12 20:35:28,720: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111875c50>]}
2018-03-12 20:35:28,946: 20:35:28 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.92s]
2018-03-12 20:35:28,948: 20:35:28 | 27 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 20:35:28,948: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 20:35:28,957: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 20:35:28,961: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 20:35:28,962: Re-using an available connection from the pool.
2018-03-12 20:35:29,258: 20:35:29 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.93s]
2018-03-12 20:35:29,662: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:35:29,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a588>]}
2018-03-12 20:35:30,014: 20:35:30 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.98s]
2018-03-12 20:35:30,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188ad68>]}
2018-03-12 20:35:31,097: 20:35:31 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.83s]
2018-03-12 20:35:43,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11190fb70>]}
2018-03-12 20:35:43,491: 20:35:43 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 17.38s]
2018-03-12 20:35:43,492: 20:35:43 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 20:35:43,492: 20:35:43 | 29 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 20:35:43,492: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 20:35:43,492: 20:35:43 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 20:35:43,493: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 20:35:43,499: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 20:35:43,499: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 20:35:43,506: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 20:35:43,511: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 20:35:43,512: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 20:35:43,513: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 20:35:43,513: Re-using an available connection from the pool.
2018-03-12 20:35:43,513: Re-using an available connection from the pool.
2018-03-12 20:35:43,518: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 20:35:43,520: Re-using an available connection from the pool.
2018-03-12 20:35:44,166: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 20:35:44,242: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 20:35:44,250: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 20:35:45,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:35:45,351: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a470>]}
2018-03-12 20:35:45,357: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118e5048>]}
2018-03-12 20:35:45,503: 20:35:45 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.78s]
2018-03-12 20:35:45,836: 20:35:45 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.86s]
2018-03-12 20:35:46,146: 20:35:46 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.86s]
2018-03-12 20:35:46,146: 20:35:46 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 20:35:46,147: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 20:35:46,161: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 20:35:46,162: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 20:35:46,163: Re-using an available connection from the pool.
2018-03-12 20:35:47,041: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 20:36:02,398: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec26f28>]}
2018-03-12 20:36:02,715: 20:36:02 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 16.25s]
2018-03-12 20:36:02,716: 20:36:02 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-12 20:36:02,716: Compiling model.seo_audit.deepcrawl_reclass
2018-03-12 20:36:02,727: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-12 20:36:02,728: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-12 20:36:02,729: Re-using an available connection from the pool.
2018-03-12 20:36:03,239: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-12 20:36:14,254: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:36:14,576: 20:36:14 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 11.54s]
2018-03-12 20:36:14,576: 20:36:14 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-12 20:36:14,577: 20:36:14 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-12 20:36:14,577: Compiling model.seo_audit.ga_proc
2018-03-12 20:36:14,577: Compiling model.seo_audit.ga_proc_pageviews
2018-03-12 20:36:14,585: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-12 20:36:14,591: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-12 20:36:14,595: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-12 20:36:14,595: Re-using an available connection from the pool.
2018-03-12 20:36:14,598: Acquiring new bigquery connection "ga_proc".
2018-03-12 20:36:14,599: Re-using an available connection from the pool.
2018-03-12 20:36:15,238: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-12 20:36:15,321: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) revenue,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-12 20:36:18,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a470>]}
2018-03-12 20:36:18,958: 20:36:18 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.15s]
2018-03-12 20:36:19,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec26f28>]}
2018-03-12 20:36:19,799: 20:36:19 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 4.56s]
2018-03-12 20:36:19,800: 20:36:19 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-12 20:36:19,800: Compiling model.seo_audit.agg_indicative
2018-03-12 20:36:19,809: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-12 20:36:19,816: Acquiring new bigquery connection "agg_indicative".
2018-03-12 20:36:19,816: Re-using an available connection from the pool.
2018-03-12 20:36:20,820: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-12 20:36:25,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:36:25,800: 20:36:25 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 5.67s]
2018-03-12 20:36:25,801: 20:36:25 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-12 20:36:25,802: Compiling model.seo_audit.dates
2018-03-12 20:36:25,813: Writing injected SQL for node "model.seo_audit.dates"
2018-03-12 20:36:25,816: Acquiring new bigquery connection "dates".
2018-03-12 20:36:25,817: Re-using an available connection from the pool.
2018-03-12 20:36:26,662: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-12 20:36:28,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec26f28>]}
2018-03-12 20:36:29,150: 20:36:29 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.05s]
2018-03-12 20:36:29,151: 20:36:29 | 37 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-12 20:36:29,152: 20:36:29 | 38 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-12 20:36:29,152: Compiling model.seo_audit.search_console_history
2018-03-12 20:36:29,152: Compiling model.seo_audit.ga_stats
2018-03-12 20:36:29,168: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-12 20:36:29,175: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-12 20:36:29,176: Acquiring new bigquery connection "search_console_history".
2018-03-12 20:36:29,176: Re-using an available connection from the pool.
2018-03-12 20:36:29,181: Acquiring new bigquery connection "ga_stats".
2018-03-12 20:36:29,182: Re-using an available connection from the pool.
2018-03-12 20:36:29,797: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-12 20:36:29,907: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-12 20:36:31,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118e5f98>]}
2018-03-12 20:36:32,196: 20:36:32 | 38 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.81s]
2018-03-12 20:36:33,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11188a588>]}
2018-03-12 20:36:33,518: 20:36:33 | 37 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.06s]
2018-03-12 20:36:33,519: 20:36:33 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-12 20:36:33,520: Compiling model.seo_audit.search_console_stats_url
2018-03-12 20:36:33,520: 20:36:33 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-12 20:36:33,528: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-12 20:36:33,528: Compiling model.seo_audit.search_console_stats_keyword
2018-03-12 20:36:33,533: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-12 20:36:33,537: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-12 20:36:33,537: Acquiring new bigquery connection "search_console_stats_url".
2018-03-12 20:36:33,538: Re-using an available connection from the pool.
2018-03-12 20:36:33,539: Re-using an available connection from the pool.
2018-03-12 20:36:34,239: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-12 20:36:34,240: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-12 20:36:36,449: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec26f28>]}
2018-03-12 20:36:36,459: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecdcda0>]}
2018-03-12 20:36:36,695: 20:36:36 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.93s]
2018-03-12 20:36:37,010: 20:36:37 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.93s]
2018-03-12 20:36:37,011: 20:36:37 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-12 20:36:37,011: Compiling model.seo_audit.agg_stats
2018-03-12 20:36:37,027: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-12 20:36:37,031: Acquiring new bigquery connection "agg_stats".
2018-03-12 20:36:37,031: Re-using an available connection from the pool.
2018-03-12 20:36:37,822: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-12 20:36:41,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:36:41,378: 20:36:41 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 4.06s]
2018-03-12 20:36:41,378: 20:36:41 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-12 20:36:41,379: Compiling model.seo_audit.agg_stats_client
2018-03-12 20:36:41,386: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-12 20:36:41,387: Acquiring new bigquery connection "agg_stats_client".
2018-03-12 20:36:41,387: Re-using an available connection from the pool.
2018-03-12 20:36:42,158: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(revenue_30d) revenue_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(revenue_mom) revenue_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(revenue_yoy) revenue_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-12 20:36:49,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111915390>]}
2018-03-12 20:36:50,146: 20:36:50 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 8.45s]
2018-03-12 20:36:50,147: 20:36:50 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-12 20:36:50,147: Compiling model.seo_audit.agg_all
2018-03-12 20:36:50,156: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-12 20:36:50,157: Acquiring new bigquery connection "agg_all".
2018-03-12 20:36:50,157: Re-using an available connection from the pool.
2018-03-12 20:36:50,817: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-12 20:36:59,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118c4fd0>]}
2018-03-12 20:36:59,842: 20:36:59 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 9.44s]
2018-03-12 20:36:59,843: 20:36:59 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-12 20:36:59,843: Compiling model.seo_audit.actions_proc
2018-03-12 20:36:59,857: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-12 20:36:59,861: Acquiring new bigquery connection "actions_proc".
2018-03-12 20:36:59,861: Re-using an available connection from the pool.
2018-03-12 20:37:00,553: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = 200 then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = 200  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = 200 then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-12 20:37:00,553: Bad request while running:
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = 200 then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = 200  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = 200 then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-12 20:37:00,553: 400 No matching signature for operator = for argument types: STRING, INT64. Supported signatures: ANY = ANY at [39:89]
2018-03-12 20:37:00,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a3c87b07-3f8e-4738-9436-f7a36b342309', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111915b38>]}
2018-03-12 20:37:00,865: 20:37:00 | 44 of 46 ERROR creating table model seo_audit.actions_proc........... [ERROR in 0.71s]
2018-03-12 20:37:00,867: 20:37:00 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-12 20:37:00,867: 20:37:00 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-12 20:37:00,965: 20:37:00 | 
2018-03-12 20:37:00,965: 20:37:00 | Finished running 46 table models in 168.96s.
2018-03-12 20:37:00,966: Connection 'master' was left open.
2018-03-12 20:37:00,966: 
2018-03-12 20:37:00,967: Completed with 1 errors:
2018-03-12 20:37:00,967: 
2018-03-12 20:37:00,967: Database Error in model actions_proc (models/actions/actions_proc.sql)
2018-03-12 20:37:00,967:   No matching signature for operator = for argument types: STRING, INT64. Supported signatures: ANY = ANY at [39:89]
2018-03-12 20:37:00,968:   compiled SQL at target/compiled/seo_audit/actions/actions_proc.sql
2018-03-12 20:37:00,968: 
Done. PASS=43 ERROR=1 SKIP=2 TOTAL=46
2018-03-12 20:37:00,969: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111756a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111756748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118124e0>]}
2018-03-12 20:37:01,282: Flushing usage events
2018-03-12 20:51:28,790: Tracking: tracking
2018-03-12 20:51:28,793: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10880f2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10880fb70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10880f080>]}
2018-03-12 20:51:29,538: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 20:51:29,556: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 20:51:29,565: Parsing core.sql
2018-03-12 20:51:29,587: Parsing adapters/bigquery.sql
2018-03-12 20:51:29,595: Parsing adapters/common.sql
2018-03-12 20:51:29,615: Parsing adapters/postgres.sql
2018-03-12 20:51:29,621: Parsing adapters/redshift.sql
2018-03-12 20:51:29,646: Parsing etc/get_custom_schema.sql
2018-03-12 20:51:29,654: Parsing materializations/archive.sql
2018-03-12 20:51:29,697: Parsing materializations/bigquery.sql
2018-03-12 20:51:29,717: Parsing materializations/helpers.sql
2018-03-12 20:51:29,739: Parsing materializations/incremental.sql
2018-03-12 20:51:29,786: Parsing materializations/table.sql
2018-03-12 20:51:29,818: Parsing materializations/view.sql
2018-03-12 20:51:29,853: Parsing materializations/wrapper.sql
2018-03-12 20:51:29,867: Parsing schema_tests/accepted_values.sql
2018-03-12 20:51:29,881: Parsing schema_tests/not_null.sql
2018-03-12 20:51:29,888: Parsing schema_tests/relationships.sql
2018-03-12 20:51:29,892: Parsing schema_tests/unique.sql
2018-03-12 20:51:29,948: Parsing model.seo_audit.actions_data_studio
2018-03-12 20:51:29,953: Acquiring new bigquery connection "master".
2018-03-12 20:51:29,953: Opening a new connection (0 currently allocated)
2018-03-12 20:51:29,970: Parsing model.seo_audit.actions_hierarchy
2018-03-12 20:51:30,033: Parsing model.seo_audit.actions_proc
2018-03-12 20:51:30,073: Parsing model.seo_audit.accounts_proc
2018-03-12 20:51:30,123: Parsing model.seo_audit.all_dates
2018-03-12 20:51:30,130: Parsing model.seo_audit.dates
2018-03-12 20:51:30,134: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 20:51:30,143: Parsing model.seo_audit.agg_all
2018-03-12 20:51:30,151: Parsing model.seo_audit.agg_indicative
2018-03-12 20:51:30,166: Parsing model.seo_audit.agg_stats
2018-03-12 20:51:30,202: Parsing model.seo_audit.agg_stats_client
2018-03-12 20:51:30,209: Parsing model.seo_audit.deepcrawl_class
2018-03-12 20:51:30,214: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 20:51:30,230: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 20:51:30,234: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 20:51:30,238: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 20:51:30,242: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 20:51:30,284: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 20:51:30,296: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 20:51:30,354: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 20:51:30,367: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 20:51:30,384: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 20:51:30,395: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 20:51:30,400: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 20:51:30,406: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 20:51:30,449: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 20:51:30,480: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 20:51:30,512: Parsing model.seo_audit.ga_proc
2018-03-12 20:51:30,522: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 20:51:30,531: Parsing model.seo_audit.ga_stats
2018-03-12 20:51:30,538: Parsing model.seo_audit.majestic_domain_history
2018-03-12 20:51:30,548: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 20:51:30,562: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 20:51:30,567: Parsing model.seo_audit.moz_proc
2018-03-12 20:51:30,573: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 20:51:30,591: Parsing model.seo_audit.search_console_history
2018-03-12 20:51:30,598: Parsing model.seo_audit.search_console_proc
2018-03-12 20:51:30,603: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 20:51:30,608: Parsing model.seo_audit.search_console_stats_url
2018-03-12 20:51:30,615: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 20:51:30,618: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 20:51:30,622: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 20:51:30,631: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 20:51:30,644: Parsing model.seo_audit.semrush_url_history
2018-03-12 20:51:30,649: Parsing model.seo_audit.semrush_url_stats
2018-03-12 20:51:30,653: Parsing model.seo_audit.sitemap_proc
2018-03-12 20:51:30,687: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 20:51:30,785: 
2018-03-12 20:51:32,137: 20:51:32 | Concurrency: 4 threads (target='prod')
2018-03-12 20:51:32,137: 20:51:32 | 
2018-03-12 20:51:32,563: 20:51:32 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 20:51:32,563: Compiling model.seo_audit.all_dates
2018-03-12 20:51:32,568: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 20:51:32,563: 20:51:32 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 20:51:32,569: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 20:51:32,563: 20:51:32 | 3 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 20:51:32,575: Compiling model.seo_audit.accounts_proc
2018-03-12 20:51:32,583: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 20:51:32,583: Acquiring new bigquery connection "all_dates".
2018-03-12 20:51:32,588: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 20:51:32,588: Opening a new connection (1 currently allocated)
2018-03-12 20:51:32,592: Acquiring new bigquery connection "accounts_proc".
2018-03-12 20:51:32,674: Opening a new connection (2 currently allocated)
2018-03-12 20:51:32,675: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 20:51:32,677: Opening a new connection (3 currently allocated)
2018-03-12 20:51:33,737: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 20:51:33,803: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 20:51:33,832: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 20:51:35,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c3390>]}
2018-03-12 20:51:35,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c3710>]}
2018-03-12 20:51:36,229: 20:51:36 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.37s]
2018-03-12 20:51:36,513: 20:51:36 | 3 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.40s]
2018-03-12 20:51:51,402: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06f60>]}
2018-03-12 20:51:51,738: 20:51:51 | 2 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 18.83s]
2018-03-12 20:51:51,739: 20:51:51 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 20:51:51,740: Compiling model.seo_audit.search_console_proc
2018-03-12 20:51:51,765: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 20:51:51,766: 20:51:51 | 5 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-12 20:51:51,766: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 20:51:51,781: 20:51:51 | 6 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-12 20:51:51,782: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 20:51:51,810: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 20:51:51,832: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 20:51:51,834: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 20:51:51,835: 20:51:51 | 7 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 20:51:51,836: Re-using an available connection from the pool.
2018-03-12 20:51:51,836: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 20:51:51,838: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 20:51:51,855: Re-using an available connection from the pool.
2018-03-12 20:51:51,885: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 20:51:51,887: Acquiring new bigquery connection "search_console_proc".
2018-03-12 20:51:51,887: Re-using an available connection from the pool.
2018-03-12 20:51:51,898: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 20:51:51,898: Opening a new connection (4 currently allocated)
2018-03-12 20:51:52,826: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 20:51:52,866: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 20:51:52,874: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 20:51:53,282: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 20:51:55,045: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108907048>]}
2018-03-12 20:51:55,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089365f8>]}
2018-03-12 20:51:55,682: 20:51:55 | 5 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.28s]
2018-03-12 20:51:55,683: 20:51:55 | 8 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 20:51:55,683: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 20:51:55,693: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 20:51:55,697: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 20:51:55,697: Re-using an available connection from the pool.
2018-03-12 20:51:56,021: 20:51:56 | 6 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.28s]
2018-03-12 20:51:56,040: 20:51:56 | 9 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 20:51:56,043: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 20:51:56,060: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 20:51:56,064: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 20:51:56,064: Re-using an available connection from the pool.
2018-03-12 20:51:56,452: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 20:51:56,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c3390>]}
2018-03-12 20:51:56,755: 20:51:56 | 7 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 4.71s]
2018-03-12 20:51:56,756: 20:51:56 | 10 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-12 20:51:56,756: Compiling model.seo_audit.moz_proc
2018-03-12 20:51:56,765: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 20:51:56,766: Acquiring new bigquery connection "moz_proc".
2018-03-12 20:51:56,767: Re-using an available connection from the pool.
2018-03-12 20:51:56,937: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 20:51:57,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108964358>]}
2018-03-12 20:51:57,531: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 20:51:57,539: 20:51:57 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.50s]
2018-03-12 20:51:57,539: 20:51:57 | 11 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-12 20:51:57,540: Compiling model.seo_audit.sitemap_proc
2018-03-12 20:51:57,555: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 20:51:57,556: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 20:51:57,557: Re-using an available connection from the pool.
2018-03-12 20:51:58,197: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 20:51:59,775: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108907048>]}
2018-03-12 20:52:00,188: 20:52:00 | 8 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.09s]
2018-03-12 20:52:00,783: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c3390>]}
2018-03-12 20:52:00,990: 20:52:00 | 10 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 4.03s]
2018-03-12 20:52:02,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108964358>]}
2018-03-12 20:52:02,863: 20:52:02 | 11 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 5.02s]
2018-03-12 20:52:04,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089365f8>]}
2018-03-12 20:52:04,834: 20:52:04 | 9 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 8.58s]
2018-03-12 20:52:04,835: 20:52:04 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 20:52:04,835: 20:52:04 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 20:52:04,835: 20:52:04 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 20:52:04,836: 20:52:04 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 20:52:04,836: Compiling model.seo_audit.majestic_domain_history
2018-03-12 20:52:04,836: Compiling model.seo_audit.semrush_url_history
2018-03-12 20:52:04,837: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 20:52:04,837: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 20:52:04,845: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 20:52:04,851: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 20:52:04,863: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 20:52:04,863: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 20:52:04,865: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 20:52:04,865: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 20:52:04,866: Re-using an available connection from the pool.
2018-03-12 20:52:04,866: Re-using an available connection from the pool.
2018-03-12 20:52:04,869: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 20:52:04,870: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 20:52:04,872: Re-using an available connection from the pool.
2018-03-12 20:52:04,873: Re-using an available connection from the pool.
2018-03-12 20:52:05,572: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 20:52:05,572: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 20:52:05,574: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 20:52:05,583: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 20:52:08,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:52:09,563: 20:52:09 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 4.00s]
2018-03-12 20:52:09,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108953048>]}
2018-03-12 20:52:10,266: 20:52:10 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 5.12s]
2018-03-12 20:52:11,052: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108964358>]}
2018-03-12 20:52:11,332: 20:52:11 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 6.22s]
2018-03-12 20:52:34,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a11908>]}
2018-03-12 20:52:34,668: 20:52:34 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 29.47s]
2018-03-12 20:52:34,670: 20:52:34 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 20:52:34,670: Compiling model.seo_audit.deepcrawl_class
2018-03-12 20:52:34,685: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 20:52:34,686: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 20:52:34,686: Re-using an available connection from the pool.
2018-03-12 20:52:35,369: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 20:52:47,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108953a20>]}
2018-03-12 20:52:47,515: 20:52:47 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 12.58s]
2018-03-12 20:52:47,518: 20:52:47 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 20:52:47,519: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 20:52:47,519: 20:52:47 | 18 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 20:52:47,519: 20:52:47 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 20:52:47,537: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 20:52:47,543: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 20:52:47,543: Compiling model.seo_audit.semrush_url_stats
2018-03-12 20:52:47,556: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 20:52:47,569: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 20:52:47,519: 20:52:47 | 20 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 20:52:47,570: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 20:52:47,578: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 20:52:47,579: Re-using an available connection from the pool.
2018-03-12 20:52:47,580: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 20:52:47,580: Re-using an available connection from the pool.
2018-03-12 20:52:47,588: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 20:52:47,589: Re-using an available connection from the pool.
2018-03-12 20:52:47,598: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 20:52:47,599: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 20:52:47,599: Re-using an available connection from the pool.
2018-03-12 20:52:49,703: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 20:52:49,714: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 20:52:49,746: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 20:52:51,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a11f60>]}
2018-03-12 20:52:51,480: 20:52:51 | 20 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.59s]
2018-03-12 20:52:51,482: 20:52:51 | 21 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 20:52:51,489: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 20:52:51,544: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 20:52:51,550: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 20:52:51,550: Re-using an available connection from the pool.
2018-03-12 20:52:51,570: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 20:52:52,592: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c13da0>]}
2018-03-12 20:52:52,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06ba8>]}
2018-03-12 20:52:52,900: 20:52:52 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 5.05s]
2018-03-12 20:52:53,112: 20:52:53 | 18 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 5.06s]
2018-03-12 20:52:54,475: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 20:52:55,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108964358>]}
2018-03-12 20:52:56,126: 20:52:56 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 8.40s]
2018-03-12 20:52:57,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a11f60>]}
2018-03-12 20:52:57,946: 20:52:57 | 21 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 6.25s]
2018-03-12 20:52:57,947: 20:52:57 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 20:52:57,947: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 20:52:57,947: 20:52:57 | 23 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 20:52:57,955: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 20:52:57,947: 20:52:57 | 24 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 20:52:57,960: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 20:52:57,984: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 20:52:58,008: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 20:52:58,018: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 20:52:57,947: 20:52:57 | 25 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 20:52:58,019: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 20:52:58,031: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 20:52:58,034: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 20:52:58,034: Re-using an available connection from the pool.
2018-03-12 20:52:58,046: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 20:52:58,046: Re-using an available connection from the pool.
2018-03-12 20:52:58,048: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 20:52:58,048: Re-using an available connection from the pool.
2018-03-12 20:52:58,050: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 20:52:58,051: Re-using an available connection from the pool.
2018-03-12 20:52:58,667: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 20:52:58,741: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:52:58,766: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:52:59,748: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108953a20>]}
2018-03-12 20:52:59,794: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 20:53:00,044: 20:53:00 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.80s]
2018-03-12 20:53:00,044: 20:53:00 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 20:53:00,044: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 20:53:00,052: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 20:53:00,054: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 20:53:00,054: Re-using an available connection from the pool.
2018-03-12 20:53:00,647: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 20:53:00,905: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a02320>]}
2018-03-12 20:53:00,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a02630>]}
2018-03-12 20:53:01,212: 20:53:01 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.94s]
2018-03-12 20:53:01,213: 20:53:01 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 20:53:01,213: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 20:53:01,220: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 20:53:01,225: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 20:53:01,225: Re-using an available connection from the pool.
2018-03-12 20:53:01,532: 20:53:01 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.95s]
2018-03-12 20:53:01,924: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 20:53:01,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a1f320>]}
2018-03-12 20:53:02,283: 20:53:02 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 4.04s]
2018-03-12 20:53:02,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108953a20>]}
2018-03-12 20:53:03,126: 20:53:03 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.80s]
2018-03-12 20:53:04,089: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c4b0b8>]}
2018-03-12 20:53:04,428: 20:53:04 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.88s]
2018-03-12 20:53:04,429: 20:53:04 | 28 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 20:53:04,429: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 20:53:04,440: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 20:53:04,437: 20:53:04 | 29 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 20:53:04,441: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 20:53:04,448: 20:53:04 | 30 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 20:53:04,449: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 20:53:04,458: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 20:53:04,463: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 20:53:04,465: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 20:53:04,465: Re-using an available connection from the pool.
2018-03-12 20:53:04,470: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 20:53:04,470: Re-using an available connection from the pool.
2018-03-12 20:53:04,475: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 20:53:04,476: Re-using an available connection from the pool.
2018-03-12 20:53:05,175: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 20:53:05,176: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 20:53:05,177: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 20:53:06,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108953048>]}
2018-03-12 20:53:06,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:53:06,549: 20:53:06 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.80s]
2018-03-12 20:53:06,844: 20:53:06 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.83s]
2018-03-12 20:53:07,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c359b0>]}
2018-03-12 20:53:07,927: 20:53:07 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.94s]
2018-03-12 20:53:07,928: 20:53:07 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 20:53:07,928: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 20:53:07,945: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 20:53:07,946: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 20:53:07,946: Re-using an available connection from the pool.
2018-03-12 20:53:08,603: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 20:53:19,456: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:53:20,122: 20:53:20 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 11.53s]
2018-03-12 20:53:20,122: 20:53:20 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-12 20:53:20,123: Compiling model.seo_audit.deepcrawl_reclass
2018-03-12 20:53:20,132: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-12 20:53:20,134: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-12 20:53:20,134: Re-using an available connection from the pool.
2018-03-12 20:53:20,834: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-12 20:53:32,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089cd748>]}
2018-03-12 20:53:33,134: 20:53:33 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 12.68s]
2018-03-12 20:53:33,135: 20:53:33 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-12 20:53:33,136: 20:53:33 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-12 20:53:33,136: Compiling model.seo_audit.ga_proc
2018-03-12 20:53:33,136: Compiling model.seo_audit.ga_proc_pageviews
2018-03-12 20:53:33,154: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-12 20:53:33,156: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-12 20:53:33,160: Acquiring new bigquery connection "ga_proc".
2018-03-12 20:53:33,160: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-12 20:53:33,160: Re-using an available connection from the pool.
2018-03-12 20:53:33,161: Re-using an available connection from the pool.
2018-03-12 20:53:33,943: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-12 20:53:33,944: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) revenue,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-12 20:53:37,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089365f8>]}
2018-03-12 20:53:37,529: 20:53:37 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.11s]
2018-03-12 20:53:38,277: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:53:38,563: 20:53:38 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 5.14s]
2018-03-12 20:53:38,564: 20:53:38 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-12 20:53:38,564: Compiling model.seo_audit.agg_indicative
2018-03-12 20:53:38,570: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-12 20:53:38,573: Acquiring new bigquery connection "agg_indicative".
2018-03-12 20:53:38,573: Re-using an available connection from the pool.
2018-03-12 20:53:39,266: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-12 20:53:43,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089fe0b8>]}
2018-03-12 20:53:43,786: 20:53:43 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 5.02s]
2018-03-12 20:53:43,787: 20:53:43 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-12 20:53:43,787: Compiling model.seo_audit.dates
2018-03-12 20:53:43,795: Writing injected SQL for node "model.seo_audit.dates"
2018-03-12 20:53:43,798: Acquiring new bigquery connection "dates".
2018-03-12 20:53:43,799: Re-using an available connection from the pool.
2018-03-12 20:53:44,595: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-12 20:53:46,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:53:47,123: 20:53:47 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.08s]
2018-03-12 20:53:47,124: 20:53:47 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-12 20:53:47,125: Compiling model.seo_audit.ga_stats
2018-03-12 20:53:47,125: 20:53:47 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-12 20:53:47,135: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-12 20:53:47,136: Compiling model.seo_audit.search_console_history
2018-03-12 20:53:47,141: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-12 20:53:47,143: Acquiring new bigquery connection "ga_stats".
2018-03-12 20:53:47,143: Re-using an available connection from the pool.
2018-03-12 20:53:47,144: Acquiring new bigquery connection "search_console_history".
2018-03-12 20:53:47,144: Re-using an available connection from the pool.
2018-03-12 20:53:47,868: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-12 20:53:47,993: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-12 20:53:50,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c3390>]}
2018-03-12 20:53:50,368: 20:53:50 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.91s]
2018-03-12 20:53:51,328: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089cd5f8>]}
2018-03-12 20:53:51,615: 20:53:51 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.19s]
2018-03-12 20:53:51,616: 20:53:51 | 39 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-12 20:53:51,616: 20:53:51 | 40 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-12 20:53:51,616: Compiling model.seo_audit.search_console_stats_keyword
2018-03-12 20:53:51,616: Compiling model.seo_audit.search_console_stats_url
2018-03-12 20:53:51,627: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-12 20:53:51,628: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-12 20:53:51,629: Acquiring new bigquery connection "search_console_stats_url".
2018-03-12 20:53:51,629: Re-using an available connection from the pool.
2018-03-12 20:53:51,630: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-12 20:53:51,631: Re-using an available connection from the pool.
2018-03-12 20:53:52,272: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-12 20:53:52,290: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-12 20:53:54,450: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:53:54,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089cdda0>]}
2018-03-12 20:53:54,755: 20:53:54 | 39 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.83s]
2018-03-12 20:53:55,053: 20:53:55 | 40 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.85s]
2018-03-12 20:53:55,054: 20:53:55 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-12 20:53:55,055: Compiling model.seo_audit.agg_stats
2018-03-12 20:53:55,070: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-12 20:53:55,071: Acquiring new bigquery connection "agg_stats".
2018-03-12 20:53:55,071: Re-using an available connection from the pool.
2018-03-12 20:53:55,828: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-12 20:53:59,173: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c37f0>]}
2018-03-12 20:53:59,480: 20:53:59 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 4.12s]
2018-03-12 20:53:59,481: 20:53:59 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-12 20:53:59,482: Compiling model.seo_audit.agg_stats_client
2018-03-12 20:53:59,492: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-12 20:53:59,494: Acquiring new bigquery connection "agg_stats_client".
2018-03-12 20:53:59,494: Re-using an available connection from the pool.
2018-03-12 20:54:00,361: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(revenue_30d) revenue_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(revenue_mom) revenue_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(revenue_yoy) revenue_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-12 20:54:08,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:54:08,331: 20:54:08 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 8.54s]
2018-03-12 20:54:08,331: 20:54:08 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-12 20:54:08,332: Compiling model.seo_audit.agg_all
2018-03-12 20:54:08,343: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-12 20:54:08,344: Acquiring new bigquery connection "agg_all".
2018-03-12 20:54:08,344: Re-using an available connection from the pool.
2018-03-12 20:54:09,189: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-12 20:54:17,923: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c37f0>]}
2018-03-12 20:54:18,234: 20:54:18 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 9.59s]
2018-03-12 20:54:18,235: 20:54:18 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-12 20:54:18,235: Compiling model.seo_audit.actions_proc
2018-03-12 20:54:18,255: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-12 20:54:18,258: Acquiring new bigquery connection "actions_proc".
2018-03-12 20:54:18,258: Re-using an available connection from the pool.
2018-03-12 20:54:18,952: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = '' then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = ''  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = '' then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-12 20:54:22,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:54:22,892: 20:54:22 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 4.00s]
2018-03-12 20:54:22,893: 20:54:22 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-12 20:54:22,894: Compiling model.seo_audit.actions_hierarchy
2018-03-12 20:54:22,905: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-12 20:54:22,908: Acquiring new bigquery connection "actions_hierarchy".
2018-03-12 20:54:22,909: Re-using an available connection from the pool.
2018-03-12 20:54:23,646: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap,
domain,
canonical_url,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-12 20:54:26,902: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089c37f0>]}
2018-03-12 20:54:27,111: 20:54:27 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 4.01s]
2018-03-12 20:54:27,112: 20:54:27 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-12 20:54:27,112: Compiling model.seo_audit.actions_data_studio
2018-03-12 20:54:27,120: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-12 20:54:27,121: Acquiring new bigquery connection "actions_data_studio".
2018-03-12 20:54:27,121: Re-using an available connection from the pool.
2018-03-12 20:54:27,914: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap deepcrawl_sitemap,
domain,
canonical_url,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-12 20:54:31,177: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7cf83f04-8d20-42bc-9500-8909ecf3bd9b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b6a0>]}
2018-03-12 20:54:31,395: 20:54:31 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 4.07s]
2018-03-12 20:54:31,503: 20:54:31 | 
2018-03-12 20:54:31,503: 20:54:31 | Finished running 46 table models in 179.37s.
2018-03-12 20:54:31,503: Connection 'master' was left open.
2018-03-12 20:54:31,504: 
2018-03-12 20:54:31,504: Completed successfully
2018-03-12 20:54:31,504: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-12 20:54:31,505: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e16d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e1860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e1710>]}
2018-03-12 20:54:31,739: Flushing usage events
2018-03-12 21:05:28,466: Tracking: tracking
2018-03-12 21:05:28,470: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e204ba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e204860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e204828>]}
2018-03-12 21:05:29,278: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-12 21:05:29,298: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-12 21:05:29,303: Parsing core.sql
2018-03-12 21:05:29,322: Parsing adapters/bigquery.sql
2018-03-12 21:05:29,333: Parsing adapters/common.sql
2018-03-12 21:05:29,350: Parsing adapters/postgres.sql
2018-03-12 21:05:29,355: Parsing adapters/redshift.sql
2018-03-12 21:05:29,379: Parsing etc/get_custom_schema.sql
2018-03-12 21:05:29,388: Parsing materializations/archive.sql
2018-03-12 21:05:29,420: Parsing materializations/bigquery.sql
2018-03-12 21:05:29,442: Parsing materializations/helpers.sql
2018-03-12 21:05:29,461: Parsing materializations/incremental.sql
2018-03-12 21:05:29,491: Parsing materializations/table.sql
2018-03-12 21:05:29,512: Parsing materializations/view.sql
2018-03-12 21:05:29,530: Parsing materializations/wrapper.sql
2018-03-12 21:05:29,537: Parsing schema_tests/accepted_values.sql
2018-03-12 21:05:29,543: Parsing schema_tests/not_null.sql
2018-03-12 21:05:29,547: Parsing schema_tests/relationships.sql
2018-03-12 21:05:29,553: Parsing schema_tests/unique.sql
2018-03-12 21:05:29,690: Parsing model.seo_audit.actions_data_studio
2018-03-12 21:05:29,694: Acquiring new bigquery connection "master".
2018-03-12 21:05:29,694: Opening a new connection (0 currently allocated)
2018-03-12 21:05:29,704: Parsing model.seo_audit.actions_hierarchy
2018-03-12 21:05:29,710: Parsing model.seo_audit.actions_proc
2018-03-12 21:05:29,720: Parsing model.seo_audit.accounts_proc
2018-03-12 21:05:29,726: Parsing model.seo_audit.all_dates
2018-03-12 21:05:29,728: Parsing model.seo_audit.dates
2018-03-12 21:05:29,732: Parsing model.seo_audit.mappings_ga_proc
2018-03-12 21:05:29,736: Parsing model.seo_audit.agg_all
2018-03-12 21:05:29,741: Parsing model.seo_audit.agg_indicative
2018-03-12 21:05:29,745: Parsing model.seo_audit.agg_stats
2018-03-12 21:05:29,750: Parsing model.seo_audit.agg_stats_client
2018-03-12 21:05:29,754: Parsing model.seo_audit.deepcrawl_class
2018-03-12 21:05:29,758: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 21:05:29,759: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 21:05:29,762: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 21:05:29,763: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-12 21:05:29,768: Parsing model.seo_audit.deepcrawl_proc
2018-03-12 21:05:29,774: Parsing model.seo_audit.deepcrawl_reclass
2018-03-12 21:05:29,777: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-12 21:05:29,789: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-12 21:05:29,792: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 21:05:29,793: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-12 21:05:29,795: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 21:05:29,797: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-12 21:05:29,800: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 21:05:29,802: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-12 21:05:29,808: Parsing model.seo_audit.deepcrawl_urls
2018-03-12 21:05:29,811: Parsing model.seo_audit.ga_proc
2018-03-12 21:05:29,818: Parsing model.seo_audit.ga_proc_pageviews
2018-03-12 21:05:29,823: Parsing model.seo_audit.ga_stats
2018-03-12 21:05:29,827: Parsing model.seo_audit.majestic_domain_history
2018-03-12 21:05:29,830: Parsing model.seo_audit.majestic_domain_proc
2018-03-12 21:05:29,833: Parsing model.seo_audit.majestic_domain_stats
2018-03-12 21:05:29,836: Parsing model.seo_audit.moz_proc
2018-03-12 21:05:29,839: Parsing model.seo_audit.screamingfrog_proc
2018-03-12 21:05:29,843: Parsing model.seo_audit.search_console_history
2018-03-12 21:05:29,846: Parsing model.seo_audit.search_console_proc
2018-03-12 21:05:29,849: Parsing model.seo_audit.search_console_stats_keyword
2018-03-12 21:05:29,853: Parsing model.seo_audit.search_console_stats_url
2018-03-12 21:05:29,855: Parsing model.seo_audit.semrush_domain_proc
2018-03-12 21:05:29,858: Parsing model.seo_audit.semrush_keyword_history
2018-03-12 21:05:29,861: Parsing model.seo_audit.semrush_keyword_proc
2018-03-12 21:05:29,865: Parsing model.seo_audit.semrush_keyword_stats
2018-03-12 21:05:29,868: Parsing model.seo_audit.semrush_url_history
2018-03-12 21:05:29,870: Parsing model.seo_audit.semrush_url_stats
2018-03-12 21:05:29,873: Parsing model.seo_audit.sitemap_proc
2018-03-12 21:05:29,893: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-12 21:05:29,912: 
2018-03-12 21:05:31,134: 21:05:31 | Concurrency: 4 threads (target='prod')
2018-03-12 21:05:31,134: 21:05:31 | 
2018-03-12 21:05:31,579: 21:05:31 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-12 21:05:31,580: Compiling model.seo_audit.accounts_proc
2018-03-12 21:05:31,579: 21:05:31 | 2 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-12 21:05:31,586: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-12 21:05:31,579: 21:05:31 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-12 21:05:31,586: Compiling model.seo_audit.deepcrawl_proc
2018-03-12 21:05:31,586: Compiling model.seo_audit.all_dates
2018-03-12 21:05:31,592: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-12 21:05:31,596: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-12 21:05:31,597: Acquiring new bigquery connection "accounts_proc".
2018-03-12 21:05:31,597: Opening a new connection (1 currently allocated)
2018-03-12 21:05:31,601: Acquiring new bigquery connection "all_dates".
2018-03-12 21:05:31,602: Opening a new connection (2 currently allocated)
2018-03-12 21:05:31,602: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-12 21:05:31,756: Opening a new connection (3 currently allocated)
2018-03-12 21:05:33,021: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-12 21:05:33,070: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-12 21:05:33,071: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM
  ( 
    -- SELECT 
    -- url,
    -- canonical_url,
    -- crawl_datetime,
    -- found_at_sitemap,
    -- http_status_code,
    -- level,
    -- schema_type,
    -- header_content_type,
    -- word_count, 
    -- page_title,
    -- page_title_length,
    -- description,
    -- description_length,
    -- indexable,
    -- robots_noindex,
    -- is_self_canonical,
    -- backlink_count,
    -- backlink_domain_count,
    -- redirected_to_url,
    -- found_at_url,
    -- rel_next_url,
    -- rel_prev_url,
    -- links_in_count,
    -- links_out_count,
    -- external_links_count,
    -- internal_links_count,
    -- h1_tag,
    -- h2_tag,
    -- redirect_chain,
    -- redirected_to_status_code,
    -- is_redirect_loop,
    -- duplicate_page,
    -- duplicate_page_count,
    -- duplicate_body,
    -- duplicate_body_count,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- google_maps,
    -- learn_more,
    -- review,
    -- size,
    -- form_submit,
    -- infinite_scroll,
    -- decimal_price,
    -- currency_price,
    -- add_to_cart,
    -- learn_more,
    -- review,
    -- size
    -- FROM  
    -- `curious-domain-121318.seo_audit.deepcrawl_cifl` 

    -- UNION ALL

    SELECT 
    url,
    canonical_url,
    crawl_datetime,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    page_title,
    page_title_length,
    description,
    description_length,
    indexable,
    robots_noindex,
    is_self_canonical,
    backlink_count,
    backlink_domain_count,
    redirected_to_url,
    found_at_url,
    rel_next_url,
    rel_prev_url,
    links_in_count,
    links_out_count,
    external_links_count,
    internal_links_count,
    h1_tag,
    h2_tag,
    redirect_chain,
    redirected_to_status_code,
    is_redirect_loop,
    duplicate_page,
    duplicate_page_count,
    duplicate_body,
    duplicate_body_count,
    form_submit,
    infinite_scroll,
    decimal_price,
    currency_price,
    google_maps,
    add_to_cart,
    learn_more,
    review,
    size
    FROM  
    `curious-domain-121318.seo_audit.deepcrawl_discount_party_supplies` 
    )
 )
WHERE last_crawl = crawl_datetime
2018-03-12 21:05:35,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862f28>]}
2018-03-12 21:05:35,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a908>]}
2018-03-12 21:05:35,543: 21:05:35 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.63s]
2018-03-12 21:05:35,862: 21:05:35 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.66s]
2018-03-12 21:05:49,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e37d080>]}
2018-03-12 21:05:50,094: 21:05:50 | 2 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 18.15s]
2018-03-12 21:05:50,095: 21:05:50 | 4 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-12 21:05:50,096: Compiling model.seo_audit.screamingfrog_proc
2018-03-12 21:05:50,095: 21:05:50 | 5 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-12 21:05:50,108: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-12 21:05:50,096: 21:05:50 | 6 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-12 21:05:50,108: Compiling model.seo_audit.semrush_domain_proc
2018-03-12 21:05:50,096: 21:05:50 | 7 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-12 21:05:50,109: Compiling model.seo_audit.semrush_keyword_proc
2018-03-12 21:05:50,116: Compiling model.seo_audit.search_console_proc
2018-03-12 21:05:50,117: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-12 21:05:50,123: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-12 21:05:50,126: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-12 21:05:50,142: Re-using an available connection from the pool.
2018-03-12 21:05:50,142: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-12 21:05:50,143: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-12 21:05:50,145: Re-using an available connection from the pool.
2018-03-12 21:05:50,151: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-12 21:05:50,152: Acquiring new bigquery connection "search_console_proc".
2018-03-12 21:05:50,154: Re-using an available connection from the pool.
2018-03-12 21:05:50,156: Opening a new connection (4 currently allocated)
2018-03-12 21:05:50,868: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-12 21:05:50,923: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-12 21:05:50,936: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-12 21:05:51,335: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-12 21:05:53,072: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80be80>]}
2018-03-12 21:05:53,393: 21:05:53 | 5 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.96s]
2018-03-12 21:05:53,393: 21:05:53 | 8 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-12 21:05:53,394: Compiling model.seo_audit.sitemap_proc
2018-03-12 21:05:53,405: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-12 21:05:53,406: Acquiring new bigquery connection "sitemap_proc".
2018-03-12 21:05:53,407: Re-using an available connection from the pool.
2018-03-12 21:05:54,176: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-12 21:05:54,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83ad30>]}
2018-03-12 21:05:54,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862eb8>]}
2018-03-12 21:05:54,529: 21:05:54 | 4 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.11s]
2018-03-12 21:05:54,538: 21:05:54 | 9 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-12 21:05:54,538: Compiling model.seo_audit.moz_proc
2018-03-12 21:05:54,546: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-12 21:05:54,549: Acquiring new bigquery connection "moz_proc".
2018-03-12 21:05:54,549: Re-using an available connection from the pool.
2018-03-12 21:05:54,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2ed358>]}
2018-03-12 21:05:54,939: 21:05:54 | 6 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.11s]
2018-03-12 21:05:54,943: 21:05:54 | 10 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-12 21:05:54,945: Compiling model.seo_audit.mappings_ga_proc
2018-03-12 21:05:54,956: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-12 21:05:54,960: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-12 21:05:54,960: Re-using an available connection from the pool.
2018-03-12 21:05:55,262: 21:05:55 | 7 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.74s]
2018-03-12 21:05:55,263: 21:05:55 | 11 of 46 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-03-12 21:05:55,263: Compiling model.seo_audit.majestic_domain_proc
2018-03-12 21:05:55,270: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-12 21:05:55,272: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-12 21:05:55,272: Re-using an available connection from the pool.
2018-03-12 21:05:55,304: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-12 21:05:55,670: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-12 21:05:55,969: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-12 21:05:56,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80be80>]}
2018-03-12 21:05:56,730: 21:05:56 | 8 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.98s]
2018-03-12 21:05:57,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83ad30>]}
2018-03-12 21:05:57,811: 21:05:57 | 9 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.95s]
2018-03-12 21:05:57,873: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862eb8>]}
2018-03-12 21:05:58,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2ed358>]}
2018-03-12 21:05:58,226: 21:05:58 | 10 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.93s]
2018-03-12 21:05:58,559: 21:05:58 | 11 of 46 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 2.91s]
2018-03-12 21:05:58,559: 21:05:58 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-12 21:05:58,560: 21:05:58 | 13 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-12 21:05:58,560: 21:05:58 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-12 21:05:58,560: 21:05:58 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-12 21:05:58,561: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-12 21:05:58,561: Compiling model.seo_audit.semrush_keyword_history
2018-03-12 21:05:58,561: Compiling model.seo_audit.majestic_domain_history
2018-03-12 21:05:58,561: Compiling model.seo_audit.semrush_url_history
2018-03-12 21:05:58,570: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-12 21:05:58,576: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-12 21:05:58,580: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-12 21:05:58,585: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-12 21:05:58,592: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-12 21:05:58,592: Re-using an available connection from the pool.
2018-03-12 21:05:58,593: Acquiring new bigquery connection "majestic_domain_history".
2018-03-12 21:05:58,594: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-12 21:05:58,595: Re-using an available connection from the pool.
2018-03-12 21:05:58,596: Acquiring new bigquery connection "semrush_url_history".
2018-03-12 21:05:58,600: Re-using an available connection from the pool.
2018-03-12 21:05:58,605: Re-using an available connection from the pool.
2018-03-12 21:05:59,322: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-12 21:05:59,323: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-12 21:05:59,351: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-12 21:05:59,408: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-12 21:06:01,536: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b867ba8>]}
2018-03-12 21:06:01,663: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aea7d30>]}
2018-03-12 21:06:01,850: 21:06:01 | 13 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.98s]
2018-03-12 21:06:02,154: 21:06:02 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.10s]
2018-03-12 21:06:02,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aec5cc0>]}
2018-03-12 21:06:02,871: 21:06:02 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.06s]
2018-03-12 21:06:27,859: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b867f28>]}
2018-03-12 21:06:28,163: 21:06:28 | 12 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 29.30s]
2018-03-12 21:06:28,164: 21:06:28 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-12 21:06:28,164: Compiling model.seo_audit.deepcrawl_class
2018-03-12 21:06:28,175: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-12 21:06:28,176: Acquiring new bigquery connection "deepcrawl_class".
2018-03-12 21:06:28,176: Re-using an available connection from the pool.
2018-03-12 21:06:28,835: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-12 21:06:38,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:06:39,779: 21:06:39 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 10.50s]
2018-03-12 21:06:39,779: 21:06:39 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-12 21:06:39,780: 21:06:39 | 18 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-12 21:06:39,780: 21:06:39 | 19 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-12 21:06:39,780: 21:06:39 | 20 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-12 21:06:39,781: Compiling model.seo_audit.majestic_domain_stats
2018-03-12 21:06:39,781: Compiling model.seo_audit.deepcrawl_urls
2018-03-12 21:06:39,781: Compiling model.seo_audit.semrush_keyword_stats
2018-03-12 21:06:39,781: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-12 21:06:39,791: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-12 21:06:39,796: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-12 21:06:39,801: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-12 21:06:39,806: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-12 21:06:39,810: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-12 21:06:39,810: Re-using an available connection from the pool.
2018-03-12 21:06:39,813: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-12 21:06:39,814: Re-using an available connection from the pool.
2018-03-12 21:06:39,815: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-12 21:06:39,815: Re-using an available connection from the pool.
2018-03-12 21:06:39,817: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-12 21:06:39,817: Re-using an available connection from the pool.
2018-03-12 21:06:40,689: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-12 21:06:40,695: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-12 21:06:40,696: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 21:06:40,697: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-12 21:06:42,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aea28d0>]}
2018-03-12 21:06:42,886: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b867f28>]}
2018-03-12 21:06:42,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aea2860>]}
2018-03-12 21:06:43,190: 21:06:43 | 20 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.10s]
2018-03-12 21:06:43,192: 21:06:43 | 21 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-12 21:06:43,195: Compiling model.seo_audit.semrush_url_stats
2018-03-12 21:06:43,206: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-12 21:06:43,207: Acquiring new bigquery connection "semrush_url_stats".
2018-03-12 21:06:43,207: Re-using an available connection from the pool.
2018-03-12 21:06:43,443: 21:06:43 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.11s]
2018-03-12 21:06:43,658: 21:06:43 | 18 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.11s]
2018-03-12 21:06:44,013: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-12 21:06:45,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e350438>]}
2018-03-12 21:06:45,431: 21:06:45 | 19 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 5.36s]
2018-03-12 21:06:46,194: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aed3ef0>]}
2018-03-12 21:06:46,475: 21:06:46 | 21 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.00s]
2018-03-12 21:06:46,476: 21:06:46 | 22 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-12 21:06:46,476: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-12 21:06:46,476: 21:06:46 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-12 21:06:46,482: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-12 21:06:46,476: 21:06:46 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-12 21:06:46,482: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-12 21:06:46,476: 21:06:46 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-12 21:06:46,488: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-12 21:06:46,482: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-12 21:06:46,487: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-12 21:06:46,504: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-12 21:06:46,505: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-12 21:06:46,508: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-12 21:06:46,508: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-12 21:06:46,510: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-12 21:06:46,510: Re-using an available connection from the pool.
2018-03-12 21:06:46,512: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-12 21:06:46,512: Re-using an available connection from the pool.
2018-03-12 21:06:46,518: Re-using an available connection from the pool.
2018-03-12 21:06:46,519: Re-using an available connection from the pool.
2018-03-12 21:06:47,271: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 21:06:47,276: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-12 21:06:47,321: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-12 21:06:47,350: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 21:06:49,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a2b0>]}
2018-03-12 21:06:49,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:06:49,536: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3509b0>]}
2018-03-12 21:06:49,787: 21:06:49 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.00s]
2018-03-12 21:06:49,791: 21:06:49 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-12 21:06:49,793: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-12 21:06:49,801: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-12 21:06:49,802: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-12 21:06:49,802: Re-using an available connection from the pool.
2018-03-12 21:06:50,018: 21:06:50 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.03s]
2018-03-12 21:06:50,030: 21:06:50 | 27 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-12 21:06:50,031: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-12 21:06:50,041: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-12 21:06:50,042: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-12 21:06:50,042: Re-using an available connection from the pool.
2018-03-12 21:06:50,291: 21:06:50 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 3.05s]
2018-03-12 21:06:50,481: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-12 21:06:50,740: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-12 21:06:51,570: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a2b0>]}
2018-03-12 21:06:51,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b86c5f8>]}
2018-03-12 21:06:51,825: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:06:51,857: 21:06:51 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.78s]
2018-03-12 21:06:52,151: 21:06:52 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 5.27s]
2018-03-12 21:06:52,367: 21:06:52 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.79s]
2018-03-12 21:06:52,368: 21:06:52 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-12 21:06:52,368: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-12 21:06:52,374: 21:06:52 | 29 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-12 21:06:52,377: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-12 21:06:52,377: 21:06:52 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-12 21:06:52,377: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-12 21:06:52,378: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-12 21:06:52,384: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-12 21:06:52,385: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-12 21:06:52,389: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-12 21:06:52,390: Re-using an available connection from the pool.
2018-03-12 21:06:52,391: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-12 21:06:52,391: Re-using an available connection from the pool.
2018-03-12 21:06:52,394: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-12 21:06:52,395: Re-using an available connection from the pool.
2018-03-12 21:06:53,107: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-12 21:06:53,108: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-12 21:06:53,108: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-12 21:06:54,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a1d0>]}
2018-03-12 21:06:54,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3505f8>]}
2018-03-12 21:06:54,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862550>]}
2018-03-12 21:06:54,413: 21:06:54 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.82s]
2018-03-12 21:06:54,716: 21:06:54 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.83s]
2018-03-12 21:06:55,007: 21:06:55 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.84s]
2018-03-12 21:06:55,008: 21:06:55 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-12 21:06:55,008: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-12 21:06:55,021: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-12 21:06:55,022: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-12 21:06:55,023: Re-using an available connection from the pool.
2018-03-12 21:06:55,635: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
'' as last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
'' as first_subfolder_http_status,
a.second_subfolder second_subfolder,
'' as second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
-- b.query_string query_string_rule,
-- e.pct_of_classification query_string_pct_of_class,
-- e.pct_of_value query_string_pct_of_value,
-- h.classification class_if_unclassified_query_string,
-- c.filename filename_rule,
-- f.pct_of_classification filename_pct_of_class,
-- f.pct_of_value filename_pct_of_value,
-- i.classification class_if_unclassified_filename,
-- d.first_path first_path_rule,
-- g.pct_of_classification first_path_pct_of_class,
-- g.pct_of_value first_path_pct_of_value,
-- j.classification class_if_unclassified_first_path,
-- coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
-- case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
-- case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
-- case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
-- ON (  a.classification = b.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
-- ON (  a.classification = c.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
-- ON (  a.classification = d.classification )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
-- ON (  a.classification = e.classification AND 
-- 	a.query_string = e.query_string ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
-- ON (  a.classification = f.classification AND 
-- 	a.filename = f.filename ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
-- ON (  a.classification = g.classification AND 
-- 	a.first_path = g.first_path ) 
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
-- ON (  a.query_string = h.query_string )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
-- ON (  a.filename = i.filename )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
-- ON (  a.first_path = j.first_path )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
-- ON (  a.first_subfolder = k.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
-- ON (  a.second_subfolder = l.url )
-- LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
-- ON (  a.last_subfolder = m.url )
2018-03-12 21:07:19,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:07:20,064: 21:07:20 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 24.71s]
2018-03-12 21:07:20,065: 21:07:20 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-12 21:07:20,067: Compiling model.seo_audit.deepcrawl_reclass
2018-03-12 21:07:20,099: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-12 21:07:20,101: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-12 21:07:20,102: Re-using an available connection from the pool.
2018-03-12 21:07:20,934: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when original_class != 'unclassified' then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	-- when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
-- query_string_rule,
-- query_string_pct_of_class,
-- query_string_pct_of_value,
-- class_if_unclassified_query_string,
-- filename_rule,
-- filename_pct_of_class,
-- filename_pct_of_value,
-- class_if_unclassified_filename,
-- first_path_rule,
-- first_path_pct_of_class,
-- first_path_pct_of_value,
-- class_if_unclassified_first_path,
-- class_if_unclassified,
-- reclass_query_string,
-- reclass_filename, 
-- reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-12 21:07:31,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862550>]}
2018-03-12 21:07:32,611: 21:07:32 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 11.86s]
2018-03-12 21:07:32,612: 21:07:32 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-12 21:07:32,612: 21:07:32 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-12 21:07:32,613: Compiling model.seo_audit.ga_proc
2018-03-12 21:07:32,613: Compiling model.seo_audit.ga_proc_pageviews
2018-03-12 21:07:32,636: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-12 21:07:32,638: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-12 21:07:32,643: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-12 21:07:32,643: Acquiring new bigquery connection "ga_proc".
2018-03-12 21:07:32,643: Re-using an available connection from the pool.
2018-03-12 21:07:32,644: Re-using an available connection from the pool.
2018-03-12 21:07:33,426: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-12 21:07:33,427: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(revenue) revenue,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) revenue,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-12 21:07:36,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e350080>]}
2018-03-12 21:07:36,946: 21:07:36 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.11s]
2018-03-12 21:07:40,364: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:07:40,667: 21:07:40 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 7.75s]
2018-03-12 21:07:40,668: 21:07:40 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-12 21:07:40,668: Compiling model.seo_audit.agg_indicative
2018-03-12 21:07:40,677: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-12 21:07:40,680: Acquiring new bigquery connection "agg_indicative".
2018-03-12 21:07:40,680: Re-using an available connection from the pool.
2018-03-12 21:07:42,933: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-12 21:07:48,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862550>]}
2018-03-12 21:07:49,263: 21:07:49 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 8.30s]
2018-03-12 21:07:49,264: 21:07:49 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-12 21:07:49,265: Compiling model.seo_audit.dates
2018-03-12 21:07:49,274: Writing injected SQL for node "model.seo_audit.dates"
2018-03-12 21:07:49,278: Acquiring new bigquery connection "dates".
2018-03-12 21:07:49,278: Re-using an available connection from the pool.
2018-03-12 21:07:51,679: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-12 21:07:53,179: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b80b048>]}
2018-03-12 21:07:53,448: 21:07:53 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.91s]
2018-03-12 21:07:53,449: 21:07:53 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-12 21:07:53,449: Compiling model.seo_audit.ga_stats
2018-03-12 21:07:53,455: 21:07:53 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-12 21:07:53,461: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-12 21:07:53,461: Compiling model.seo_audit.search_console_history
2018-03-12 21:07:53,467: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-12 21:07:53,471: Acquiring new bigquery connection "ga_stats".
2018-03-12 21:07:53,472: Acquiring new bigquery connection "search_console_history".
2018-03-12 21:07:53,472: Re-using an available connection from the pool.
2018-03-12 21:07:53,474: Re-using an available connection from the pool.
2018-03-12 21:07:55,748: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-12 21:07:55,748: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, revenue, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as revenue, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then revenue else 0 end ) as revenue_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then revenue else 0 end ) as revenue_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then revenue else 0 end ) as revenue_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(revenue) revenue,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-12 21:07:57,211: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b862550>]}
2018-03-12 21:07:57,499: 21:07:57 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.76s]
2018-03-12 21:07:58,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b86cfd0>]}
2018-03-12 21:07:58,933: 21:07:58 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 5.24s]
2018-03-12 21:07:58,934: 21:07:58 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-12 21:07:58,934: 21:07:58 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-12 21:07:58,935: Compiling model.seo_audit.search_console_stats_url
2018-03-12 21:07:58,935: Compiling model.seo_audit.search_console_stats_keyword
2018-03-12 21:07:58,949: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-12 21:07:58,954: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-12 21:07:58,955: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-12 21:07:58,955: Re-using an available connection from the pool.
2018-03-12 21:07:58,956: Acquiring new bigquery connection "search_console_stats_url".
2018-03-12 21:07:58,956: Re-using an available connection from the pool.
2018-03-12 21:08:01,279: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-12 21:08:01,281: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-12 21:08:02,790: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3501d0>]}
2018-03-12 21:08:02,795: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a1d0>]}
2018-03-12 21:08:03,007: 21:08:03 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.86s]
2018-03-12 21:08:03,309: 21:08:03 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.86s]
2018-03-12 21:08:03,310: 21:08:03 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-12 21:08:03,311: Compiling model.seo_audit.agg_stats
2018-03-12 21:08:03,321: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-12 21:08:03,322: Acquiring new bigquery connection "agg_stats".
2018-03-12 21:08:03,322: Re-using an available connection from the pool.
2018-03-12 21:08:05,648: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as revenue_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as revenue_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as revenue_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-12 21:08:08,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b86cfd0>]}
2018-03-12 21:08:08,926: 21:08:08 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 5.31s]
2018-03-12 21:08:08,927: 21:08:08 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-12 21:08:08,927: Compiling model.seo_audit.agg_stats_client
2018-03-12 21:08:08,935: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-12 21:08:08,936: Acquiring new bigquery connection "agg_stats_client".
2018-03-12 21:08:08,936: Re-using an available connection from the pool.
2018-03-12 21:08:11,212: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(revenue_30d) revenue_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(revenue_mom) revenue_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(revenue_yoy) revenue_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-12 21:08:24,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a1d0>]}
2018-03-12 21:08:24,387: 21:08:24 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 15.11s]
2018-03-12 21:08:24,387: 21:08:24 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-12 21:08:24,388: Compiling model.seo_audit.agg_all
2018-03-12 21:08:24,400: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-12 21:08:24,400: Acquiring new bigquery connection "agg_all".
2018-03-12 21:08:24,401: Re-using an available connection from the pool.
2018-03-12 21:08:25,148: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'revenue'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then revenue_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then revenue_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when revenue_mom > 0 then (revenue_30d-revenue_mom)/revenue_mom else null end revenue_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when revenue_yoy > 0 then (revenue_30d-revenue_yoy)/revenue_yoy else null end revenue_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-12 21:08:36,011: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae867f0>]}
2018-03-12 21:08:36,738: 21:08:36 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 11.62s]
2018-03-12 21:08:36,739: 21:08:36 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-12 21:08:36,740: Compiling model.seo_audit.actions_proc
2018-03-12 21:08:36,752: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-12 21:08:36,755: Acquiring new bigquery connection "actions_proc".
2018-03-12 21:08:36,755: Re-using an available connection from the pool.
2018-03-12 21:08:37,633: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = '' then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = ''  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = '' then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'revenue' and revenue_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('revenue', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'revenue' and ( revenue_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-12 21:08:40,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a1d0>]}
2018-03-12 21:08:41,260: 21:08:41 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 4.23s]
2018-03-12 21:08:41,261: 21:08:41 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-12 21:08:41,261: Compiling model.seo_audit.actions_hierarchy
2018-03-12 21:08:41,272: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-12 21:08:41,273: Acquiring new bigquery connection "actions_hierarchy".
2018-03-12 21:08:41,273: Re-using an available connection from the pool.
2018-03-12 21:08:42,235: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap,
domain,
canonical_url,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-12 21:08:44,488: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e350080>]}
2018-03-12 21:08:44,763: 21:08:44 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 3.23s]
2018-03-12 21:08:44,764: 21:08:44 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-12 21:08:44,764: Compiling model.seo_audit.actions_data_studio
2018-03-12 21:08:44,773: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-12 21:08:44,777: Acquiring new bigquery connection "actions_data_studio".
2018-03-12 21:08:44,777: Re-using an available connection from the pool.
2018-03-12 21:08:45,516: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap deepcrawl_sitemap,
domain,
canonical_url,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
revenue_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
revenue_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
revenue_mom_pct,
transactions_mom_pct,
sessions_yoy,
revenue_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
revenue_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-12 21:08:48,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49ddd1ed-64db-417b-b6eb-5d223a925277', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b83a1d0>]}
2018-03-12 21:08:49,152: 21:08:49 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 4.03s]
2018-03-12 21:08:49,257: 21:08:49 | 
2018-03-12 21:08:49,258: 21:08:49 | Finished running 46 table models in 198.13s.
2018-03-12 21:08:49,258: Connection 'master' was left open.
2018-03-12 21:08:49,258: 
2018-03-12 21:08:49,259: Completed successfully
2018-03-12 21:08:49,259: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-12 21:08:49,260: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2d2780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2d2908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2d27b8>]}
2018-03-12 21:08:49,487: Flushing usage events
