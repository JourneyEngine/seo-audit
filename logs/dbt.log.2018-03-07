2018-03-07 17:25:27,758: Tracking: tracking
2018-03-07 17:25:27,771: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104027198>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10426a400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10494ae10>]}
2018-03-07 17:25:28,887: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:25:28,908: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:25:28,912: Parsing core.sql
2018-03-07 17:25:28,936: Parsing adapters/bigquery.sql
2018-03-07 17:25:28,948: Parsing adapters/common.sql
2018-03-07 17:25:28,968: Parsing adapters/postgres.sql
2018-03-07 17:25:28,975: Parsing adapters/redshift.sql
2018-03-07 17:25:28,999: Parsing etc/get_custom_schema.sql
2018-03-07 17:25:29,010: Parsing materializations/archive.sql
2018-03-07 17:25:29,070: Parsing materializations/bigquery.sql
2018-03-07 17:25:29,089: Parsing materializations/helpers.sql
2018-03-07 17:25:29,119: Parsing materializations/incremental.sql
2018-03-07 17:25:29,166: Parsing materializations/table.sql
2018-03-07 17:25:29,193: Parsing materializations/view.sql
2018-03-07 17:25:29,212: Parsing materializations/wrapper.sql
2018-03-07 17:25:29,218: Parsing schema_tests/accepted_values.sql
2018-03-07 17:25:29,226: Parsing schema_tests/not_null.sql
2018-03-07 17:25:29,232: Parsing schema_tests/relationships.sql
2018-03-07 17:25:29,239: Parsing schema_tests/unique.sql
2018-03-07 17:25:29,286: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:25:29,290: Acquiring new bigquery connection "master".
2018-03-07 17:25:29,291: Opening a new connection (0 currently allocated)
2018-03-07 17:25:29,295: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:25:29,300: Parsing model.seo_audit.actions_proc
2018-03-07 17:25:29,305: Parsing model.seo_audit.accounts_proc
2018-03-07 17:25:29,309: Parsing model.seo_audit.all_dates
2018-03-07 17:25:29,312: Parsing model.seo_audit.dates
2018-03-07 17:25:29,317: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:25:29,325: Parsing model.seo_audit.agg_all
2018-03-07 17:25:29,330: Parsing model.seo_audit.agg_indicative
2018-03-07 17:25:29,333: Parsing model.seo_audit.agg_stats
2018-03-07 17:25:29,347: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:25:29,355: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:25:29,358: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:25:29,360: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:25:29,363: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:25:29,364: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:25:29,367: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:25:29,369: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:25:29,372: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:25:29,379: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:25:29,381: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:25:29,383: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:25:29,385: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:25:29,386: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:25:29,388: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:25:29,390: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:25:29,394: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:25:29,396: Parsing model.seo_audit.ga_proc
2018-03-07 17:25:29,400: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:25:29,402: Parsing model.seo_audit.ga_stats
2018-03-07 17:25:29,405: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:25:29,407: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:25:29,410: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:25:29,412: Parsing model.seo_audit.moz_proc
2018-03-07 17:25:29,415: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:25:29,418: Parsing model.seo_audit.search_console_history
2018-03-07 17:25:29,420: Parsing model.seo_audit.search_console_proc
2018-03-07 17:25:29,424: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:25:29,428: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:25:29,430: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:25:29,433: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:25:29,437: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:25:29,442: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:25:29,445: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:25:29,447: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:25:29,450: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:25:29,471: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:25:29,493: 
2018-03-07 17:25:31,107: 17:25:31 | Concurrency: 4 threads (target='prod')
2018-03-07 17:25:31,107: 17:25:31 | 
2018-03-07 17:25:31,605: 17:25:31 | 1 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-07 17:25:31,606: 17:25:31 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-07 17:25:31,606: Compiling model.seo_audit.deepcrawl_proc
2018-03-07 17:25:31,606: Compiling model.seo_audit.accounts_proc
2018-03-07 17:25:31,606: 17:25:31 | 3 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-07 17:25:31,612: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-07 17:25:31,616: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-07 17:25:31,617: Compiling model.seo_audit.all_dates
2018-03-07 17:25:31,621: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-07 17:25:31,624: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-07 17:25:31,624: Opening a new connection (1 currently allocated)
2018-03-07 17:25:31,625: Acquiring new bigquery connection "all_dates".
2018-03-07 17:25:31,626: Acquiring new bigquery connection "accounts_proc".
2018-03-07 17:25:31,627: Opening a new connection (2 currently allocated)
2018-03-07 17:25:31,737: Opening a new connection (3 currently allocated)
2018-03-07 17:25:33,231: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-07 17:25:33,242: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-07 17:25:33,281: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-03-07 17:25:34,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b1ca58>]}
2018-03-07 17:25:34,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4fd0>]}
2018-03-07 17:25:34,786: 17:25:34 | 3 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.78s]
2018-03-07 17:25:35,163: 17:25:35 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.83s]
2018-03-07 17:25:35,643: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4cc0>]}
2018-03-07 17:25:36,004: 17:25:36 | 1 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 4.04s]
2018-03-07 17:25:36,005: 17:25:36 | 4 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-07 17:25:36,005: 17:25:36 | 5 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-07 17:25:36,005: 17:25:36 | 6 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-07 17:25:36,005: 17:25:36 | 7 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-07 17:25:36,005: Compiling model.seo_audit.majestic_domain_proc
2018-03-07 17:25:36,005: Compiling model.seo_audit.sitemap_proc
2018-03-07 17:25:36,006: Compiling model.seo_audit.screamingfrog_proc
2018-03-07 17:25:36,006: Compiling model.seo_audit.search_console_proc
2018-03-07 17:25:36,013: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-07 17:25:36,021: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-07 17:25:36,032: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-07 17:25:36,043: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-07 17:25:36,046: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-07 17:25:36,046: Re-using an available connection from the pool.
2018-03-07 17:25:36,048: Acquiring new bigquery connection "search_console_proc".
2018-03-07 17:25:36,049: Acquiring new bigquery connection "sitemap_proc".
2018-03-07 17:25:36,049: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-07 17:25:36,050: Re-using an available connection from the pool.
2018-03-07 17:25:36,051: Re-using an available connection from the pool.
2018-03-07 17:25:36,052: Opening a new connection (4 currently allocated)
2018-03-07 17:25:36,962: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-07 17:25:37,104: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-07 17:25:37,138: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-07 17:25:37,842: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-07 17:25:39,321: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4da0>]}
2018-03-07 17:25:39,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a27ba8>]}
2018-03-07 17:25:39,459: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a53518>]}
2018-03-07 17:25:39,702: 17:25:39 | 4 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.32s]
2018-03-07 17:25:39,703: 17:25:39 | 8 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-07 17:25:39,703: Compiling model.seo_audit.semrush_domain_proc
2018-03-07 17:25:39,713: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-07 17:25:39,717: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-07 17:25:39,717: Re-using an available connection from the pool.
2018-03-07 17:25:40,095: 17:25:40 | 7 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.44s]
2018-03-07 17:25:40,097: 17:25:40 | 9 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-07 17:25:40,097: Compiling model.seo_audit.semrush_keyword_proc
2018-03-07 17:25:40,112: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-07 17:25:40,115: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-07 17:25:40,116: Re-using an available connection from the pool.
2018-03-07 17:25:40,489: 17:25:40 | 5 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.45s]
2018-03-07 17:25:40,489: 17:25:40 | 10 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-07 17:25:40,490: Compiling model.seo_audit.mappings_ga_proc
2018-03-07 17:25:40,498: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-07 17:25:40,501: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-07 17:25:40,502: Re-using an available connection from the pool.
2018-03-07 17:25:40,637: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:25:40,993: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-07 17:25:41,421: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-07 17:25:41,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e75da0>]}
2018-03-07 17:25:41,885: 17:25:41 | 6 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 5.49s]
2018-03-07 17:25:41,886: 17:25:41 | 11 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-07 17:25:41,886: Compiling model.seo_audit.moz_proc
2018-03-07 17:25:41,897: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-07 17:25:41,898: Acquiring new bigquery connection "moz_proc".
2018-03-07 17:25:41,898: Re-using an available connection from the pool.
2018-03-07 17:25:42,795: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:25:42,933: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afb978>]}
2018-03-07 17:25:43,315: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a27ba8>]}
2018-03-07 17:25:43,342: 17:25:43 | 8 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.23s]
2018-03-07 17:25:43,718: 17:25:43 | 9 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.22s]
2018-03-07 17:25:43,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a53518>]}
2018-03-07 17:25:44,305: 17:25:44 | 10 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.35s]
2018-03-07 17:25:45,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e855f8>]}
2018-03-07 17:25:45,506: 17:25:45 | 11 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 3.23s]
2018-03-07 17:25:45,507: 17:25:45 | 12 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-07 17:25:45,508: Compiling model.seo_audit.majestic_domain_history
2018-03-07 17:25:45,517: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-07 17:25:45,507: 17:25:45 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-07 17:25:45,517: Compiling model.seo_audit.semrush_url_history
2018-03-07 17:25:45,527: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-07 17:25:45,529: Acquiring new bigquery connection "majestic_domain_history".
2018-03-07 17:25:45,508: 17:25:45 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-07 17:25:45,508: 17:25:45 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-07 17:25:45,529: Re-using an available connection from the pool.
2018-03-07 17:25:45,530: Acquiring new bigquery connection "semrush_url_history".
2018-03-07 17:25:45,530: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-07 17:25:45,531: Compiling model.seo_audit.semrush_keyword_history
2018-03-07 17:25:45,532: Re-using an available connection from the pool.
2018-03-07 17:25:45,550: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-07 17:25:45,563: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-07 17:25:45,570: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-07 17:25:45,571: Re-using an available connection from the pool.
2018-03-07 17:25:45,572: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-07 17:25:45,572: Re-using an available connection from the pool.
2018-03-07 17:25:46,433: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-07 17:25:46,461: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-07 17:25:46,472: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-07 17:25:46,510: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-07 17:25:48,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4cc0>]}
2018-03-07 17:25:48,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b27160>]}
2018-03-07 17:25:48,836: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4ef0>]}
2018-03-07 17:25:48,837: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e85400>]}
2018-03-07 17:25:49,258: 17:25:49 | 12 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.29s]
2018-03-07 17:25:49,636: 17:25:49 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.28s]
2018-03-07 17:25:50,076: 17:25:50 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.31s]
2018-03-07 17:25:50,460: 17:25:50 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.31s]
2018-03-07 17:25:50,461: 17:25:50 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-07 17:25:50,461: Compiling model.seo_audit.deepcrawl_class
2018-03-07 17:25:50,475: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-07 17:25:50,477: Acquiring new bigquery connection "deepcrawl_class".
2018-03-07 17:25:50,477: Re-using an available connection from the pool.
2018-03-07 17:25:51,411: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-07 17:25:52,597: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b0c208>]}
2018-03-07 17:25:53,062: 17:25:53 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.14s]
2018-03-07 17:25:53,063: 17:25:53 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-07 17:25:53,063: Compiling model.seo_audit.majestic_domain_stats
2018-03-07 17:25:53,069: 17:25:53 | 18 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-07 17:25:53,077: 17:25:53 | 19 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-07 17:25:53,077: 17:25:53 | 20 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-07 17:25:53,084: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-07 17:25:53,084: Compiling model.seo_audit.semrush_url_stats
2018-03-07 17:25:53,084: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:25:53,085: Compiling model.seo_audit.deepcrawl_urls
2018-03-07 17:25:53,096: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-07 17:25:53,129: Acquiring new bigquery connection "semrush_url_stats".
2018-03-07 17:25:53,121: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-07 17:25:53,129: Re-using an available connection from the pool.
2018-03-07 17:25:53,099: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-07 17:25:53,133: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-07 17:25:53,137: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-07 17:25:53,139: Re-using an available connection from the pool.
2018-03-07 17:25:53,140: Re-using an available connection from the pool.
2018-03-07 17:25:53,146: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-07 17:25:53,147: Re-using an available connection from the pool.
2018-03-07 17:25:53,911: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-07 17:25:54,212: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-07 17:25:54,286: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:25:54,341: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:25:55,375: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afbda0>]}
2018-03-07 17:25:55,758: 17:25:55 | 19 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.29s]
2018-03-07 17:25:55,759: 17:25:55 | 21 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-07 17:25:55,760: Compiling model.seo_audit.semrush_keyword_stats
2018-03-07 17:25:55,769: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-07 17:25:55,770: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-07 17:25:55,771: Re-using an available connection from the pool.
2018-03-07 17:25:56,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e900b8>]}
2018-03-07 17:25:56,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ad4cc0>]}
2018-03-07 17:25:56,665: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-07 17:25:56,692: 17:25:56 | 20 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.19s]
2018-03-07 17:25:56,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a38208>]}
2018-03-07 17:25:57,103: 17:25:57 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.56s]
2018-03-07 17:25:57,487: 17:25:57 | 18 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.81s]
2018-03-07 17:25:59,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b1c828>]}
2018-03-07 17:25:59,418: 17:25:59 | 21 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.26s]
2018-03-07 17:25:59,419: 17:25:59 | 22 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-07 17:25:59,420: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:25:59,425: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-07 17:25:59,419: 17:25:59 | 23 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-07 17:25:59,425: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:25:59,419: 17:25:59 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-07 17:25:59,431: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-07 17:25:59,420: 17:25:59 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-07 17:25:59,431: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:25:59,432: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-07 17:25:59,432: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:25:59,436: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-07 17:25:59,437: Re-using an available connection from the pool.
2018-03-07 17:25:59,443: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-07 17:25:59,444: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-07 17:25:59,444: Re-using an available connection from the pool.
2018-03-07 17:25:59,446: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-07 17:25:59,447: Re-using an available connection from the pool.
2018-03-07 17:25:59,460: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-07 17:25:59,460: Re-using an available connection from the pool.
2018-03-07 17:26:00,352: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:26:00,370: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:26:00,371: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-07 17:26:00,591: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-07 17:26:01,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b37a58>]}
2018-03-07 17:26:02,082: 17:26:02 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.10s]
2018-03-07 17:26:02,083: 17:26:02 | 26 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-07 17:26:02,083: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:26:02,090: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-07 17:26:02,091: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-07 17:26:02,091: Re-using an available connection from the pool.
2018-03-07 17:26:02,947: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a16f60>]}
2018-03-07 17:26:02,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b0c208>]}
2018-03-07 17:26:03,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b37a58>]}
2018-03-07 17:26:04,274: 17:26:04 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.53s]
2018-03-07 17:26:04,276: 17:26:04 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-07 17:26:04,279: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:26:04,288: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-07 17:26:04,289: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-07 17:26:04,290: Re-using an available connection from the pool.
2018-03-07 17:26:04,346: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:26:05,925: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101e12ef0>]}
2018-03-07 17:26:06,358: 17:26:06 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.52s]
2018-03-07 17:26:07,195: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-07 17:26:07,705: 17:26:07 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.96s]
2018-03-07 17:26:08,983: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b0c518>]}
2018-03-07 17:26:09,383: 17:26:09 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 3.84s]
2018-03-07 17:26:09,808: 17:26:09 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 4.70s]
2018-03-07 17:26:09,809: 17:26:09 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-07 17:26:09,809: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:26:09,809: 17:26:09 | 29 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-07 17:26:09,816: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:26:09,824: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-07 17:26:09,828: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-07 17:26:09,809: 17:26:09 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-07 17:26:09,828: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:26:09,837: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-07 17:26:09,838: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-07 17:26:09,840: Re-using an available connection from the pool.
2018-03-07 17:26:09,839: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-07 17:26:09,840: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-07 17:26:09,843: Re-using an available connection from the pool.
2018-03-07 17:26:09,852: Re-using an available connection from the pool.
2018-03-07 17:26:10,680: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-07 17:26:10,763: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-07 17:26:10,781: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-07 17:26:11,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a16f60>]}
2018-03-07 17:26:11,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a38208>]}
2018-03-07 17:26:11,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101e12a90>]}
2018-03-07 17:26:12,273: 17:26:12 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.00s]
2018-03-07 17:26:12,728: 17:26:12 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.16s]
2018-03-07 17:26:13,281: 17:26:13 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.16s]
2018-03-07 17:26:13,283: 17:26:13 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-07 17:26:13,283: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:26:13,315: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-07 17:26:13,316: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-07 17:26:13,317: Re-using an available connection from the pool.
2018-03-07 17:26:14,226: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:26:14,226: Bad request while running:
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:26:14,227: 400 Column name http_status_code is ambiguous at [19:1]
2018-03-07 17:26:14,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fad421b1-6f04-4778-a98c-597ab34e21ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101e12240>]}
2018-03-07 17:26:14,667: 17:26:14 | 31 of 46 ERROR creating table model seo_audit.deepcrawl_reclass_proc. [ERROR in 0.94s]
2018-03-07 17:26:14,669: 17:26:14 | 32 of 46 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-03-07 17:26:14,669: 17:26:14 | 33 of 46 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-03-07 17:26:14,670: 17:26:14 | 34 of 46 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-03-07 17:26:14,671: 17:26:14 | 35 of 46 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-03-07 17:26:14,671: 17:26:14 | 36 of 46 SKIP relation seo_audit.dates............................... [SKIP]
2018-03-07 17:26:14,672: 17:26:14 | 37 of 46 SKIP relation seo_audit.search_console_history.............. [SKIP]
2018-03-07 17:26:14,672: 17:26:14 | 38 of 46 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-03-07 17:26:14,673: 17:26:14 | 39 of 46 SKIP relation seo_audit.search_console_stats_keyword........ [SKIP]
2018-03-07 17:26:14,674: 17:26:14 | 40 of 46 SKIP relation seo_audit.search_console_stats_url............ [SKIP]
2018-03-07 17:26:14,675: 17:26:14 | 41 of 46 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-03-07 17:26:14,675: 17:26:14 | 42 of 46 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-03-07 17:26:14,676: 17:26:14 | 43 of 46 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-03-07 17:26:14,677: 17:26:14 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-07 17:26:14,678: 17:26:14 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-07 17:26:14,679: 17:26:14 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-07 17:26:14,797: 17:26:14 | 
2018-03-07 17:26:14,797: 17:26:14 | Finished running 46 table models in 43.69s.
2018-03-07 17:26:14,798: Connection 'master' was left open.
2018-03-07 17:26:14,798: 
2018-03-07 17:26:14,798: Completed with 1 errors:
2018-03-07 17:26:14,799: 
2018-03-07 17:26:14,799: Database Error in model deepcrawl_reclass_proc (models/base-adp/deepcrawl/deepcrawl_reclass_proc.sql)
2018-03-07 17:26:14,799:   Column name http_status_code is ambiguous at [19:1]
2018-03-07 17:26:14,799:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass_proc.sql
2018-03-07 17:26:14,799: 
Done. PASS=30 ERROR=1 SKIP=15 TOTAL=46
2018-03-07 17:26:14,800: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a01860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a01710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049a9048>]}
2018-03-07 17:26:15,303: Flushing usage events
2018-03-07 17:27:19,093: Tracking: tracking
2018-03-07 17:27:19,096: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c91ada0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c91ae48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c91a9e8>]}
2018-03-07 17:27:20,105: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:27:20,127: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:27:20,134: Parsing core.sql
2018-03-07 17:27:20,154: Parsing adapters/bigquery.sql
2018-03-07 17:27:20,163: Parsing adapters/common.sql
2018-03-07 17:27:20,180: Parsing adapters/postgres.sql
2018-03-07 17:27:20,186: Parsing adapters/redshift.sql
2018-03-07 17:27:20,210: Parsing etc/get_custom_schema.sql
2018-03-07 17:27:20,218: Parsing materializations/archive.sql
2018-03-07 17:27:20,260: Parsing materializations/bigquery.sql
2018-03-07 17:27:20,281: Parsing materializations/helpers.sql
2018-03-07 17:27:20,302: Parsing materializations/incremental.sql
2018-03-07 17:27:20,340: Parsing materializations/table.sql
2018-03-07 17:27:20,361: Parsing materializations/view.sql
2018-03-07 17:27:20,381: Parsing materializations/wrapper.sql
2018-03-07 17:27:20,387: Parsing schema_tests/accepted_values.sql
2018-03-07 17:27:20,393: Parsing schema_tests/not_null.sql
2018-03-07 17:27:20,397: Parsing schema_tests/relationships.sql
2018-03-07 17:27:20,403: Parsing schema_tests/unique.sql
2018-03-07 17:27:20,464: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:27:20,466: Acquiring new bigquery connection "master".
2018-03-07 17:27:20,466: Opening a new connection (0 currently allocated)
2018-03-07 17:27:20,471: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:27:20,473: Parsing model.seo_audit.actions_proc
2018-03-07 17:27:20,478: Parsing model.seo_audit.accounts_proc
2018-03-07 17:27:20,481: Parsing model.seo_audit.all_dates
2018-03-07 17:27:20,482: Parsing model.seo_audit.dates
2018-03-07 17:27:20,485: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:27:20,490: Parsing model.seo_audit.agg_all
2018-03-07 17:27:20,494: Parsing model.seo_audit.agg_indicative
2018-03-07 17:27:20,498: Parsing model.seo_audit.agg_stats
2018-03-07 17:27:20,504: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:27:20,507: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:27:20,510: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:27:20,512: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:27:20,513: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:27:20,515: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:27:20,518: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:27:20,521: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:27:20,523: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:27:20,531: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:27:20,534: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:27:20,538: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:27:20,541: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:27:20,542: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:27:20,544: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:27:20,548: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:27:20,556: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:27:20,560: Parsing model.seo_audit.ga_proc
2018-03-07 17:27:20,566: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:27:20,570: Parsing model.seo_audit.ga_stats
2018-03-07 17:27:20,574: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:27:20,576: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:27:20,581: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:27:20,583: Parsing model.seo_audit.moz_proc
2018-03-07 17:27:20,586: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:27:20,589: Parsing model.seo_audit.search_console_history
2018-03-07 17:27:20,591: Parsing model.seo_audit.search_console_proc
2018-03-07 17:27:20,594: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:27:20,597: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:27:20,599: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:27:20,602: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:27:20,605: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:27:20,608: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:27:20,611: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:27:20,613: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:27:20,618: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:27:20,635: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:27:20,652: 
2018-03-07 17:27:21,416: 17:27:21 | Concurrency: 4 threads (target='prod')
2018-03-07 17:27:21,416: 17:27:21 | 
2018-03-07 17:27:21,957: 17:27:21 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-07 17:27:21,958: Compiling model.seo_audit.all_dates
2018-03-07 17:27:21,957: 17:27:21 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-07 17:27:21,962: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-07 17:27:21,957: 17:27:21 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-07 17:27:21,963: Compiling model.seo_audit.accounts_proc
2018-03-07 17:27:21,963: Compiling model.seo_audit.deepcrawl_proc
2018-03-07 17:27:21,980: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-07 17:27:21,986: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-07 17:27:21,987: Acquiring new bigquery connection "all_dates".
2018-03-07 17:27:21,988: Opening a new connection (1 currently allocated)
2018-03-07 17:27:21,989: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-07 17:27:21,990: Acquiring new bigquery connection "accounts_proc".
2018-03-07 17:27:21,992: Opening a new connection (2 currently allocated)
2018-03-07 17:27:22,205: Opening a new connection (3 currently allocated)
2018-03-07 17:27:23,570: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-07 17:27:23,664: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-03-07 17:27:23,711: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-07 17:27:24,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc88588>]}
2018-03-07 17:27:25,210: 17:27:25 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.83s]
2018-03-07 17:27:25,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc3a358>]}
2018-03-07 17:27:26,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4b358>]}
2018-03-07 17:27:26,403: 17:27:26 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 4.03s]
2018-03-07 17:27:26,780: 17:27:26 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 4.41s]
2018-03-07 17:27:26,781: 17:27:26 | 4 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-07 17:27:26,781: Compiling model.seo_audit.majestic_domain_proc
2018-03-07 17:27:26,781: 17:27:26 | 5 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-07 17:27:26,787: Compiling model.seo_audit.search_console_proc
2018-03-07 17:27:26,792: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-07 17:27:26,793: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-07 17:27:26,781: 17:27:26 | 6 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-07 17:27:26,793: Compiling model.seo_audit.screamingfrog_proc
2018-03-07 17:27:26,781: 17:27:26 | 7 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-07 17:27:26,799: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-07 17:27:26,800: Compiling model.seo_audit.semrush_keyword_proc
2018-03-07 17:27:26,800: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-07 17:27:26,807: Acquiring new bigquery connection "search_console_proc".
2018-03-07 17:27:26,807: Re-using an available connection from the pool.
2018-03-07 17:27:26,808: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-07 17:27:26,811: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-07 17:27:26,811: Re-using an available connection from the pool.
2018-03-07 17:27:26,815: Re-using an available connection from the pool.
2018-03-07 17:27:26,831: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-07 17:27:26,832: Opening a new connection (4 currently allocated)
2018-03-07 17:27:27,740: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-07 17:27:27,744: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-07 17:27:27,770: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-07 17:27:28,722: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-07 17:27:30,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4bb00>]}
2018-03-07 17:27:30,444: 17:27:30 | 4 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.28s]
2018-03-07 17:27:30,444: 17:27:30 | 8 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-07 17:27:30,445: Compiling model.seo_audit.semrush_domain_proc
2018-03-07 17:27:30,453: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-07 17:27:30,454: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-07 17:27:30,454: Re-using an available connection from the pool.
2018-03-07 17:27:31,212: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc16ac8>]}
2018-03-07 17:27:31,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:31,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbcd8d0>]}
2018-03-07 17:27:31,321: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:27:32,619: 17:27:32 | 5 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.43s]
2018-03-07 17:27:32,620: 17:27:32 | 9 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-07 17:27:32,620: Compiling model.seo_audit.moz_proc
2018-03-07 17:27:32,629: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-07 17:27:32,634: Acquiring new bigquery connection "moz_proc".
2018-03-07 17:27:32,634: Re-using an available connection from the pool.
2018-03-07 17:27:33,065: 17:27:33 | 6 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.42s]
2018-03-07 17:27:33,066: 17:27:33 | 10 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-07 17:27:33,070: Compiling model.seo_audit.sitemap_proc
2018-03-07 17:27:33,080: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-07 17:27:33,082: Acquiring new bigquery connection "sitemap_proc".
2018-03-07 17:27:33,082: Re-using an available connection from the pool.
2018-03-07 17:27:33,441: 17:27:33 | 7 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.49s]
2018-03-07 17:27:33,442: 17:27:33 | 11 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-07 17:27:33,442: Compiling model.seo_audit.mappings_ga_proc
2018-03-07 17:27:33,447: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-07 17:27:33,450: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:27:33,450: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-07 17:27:33,450: Re-using an available connection from the pool.
2018-03-07 17:27:33,611: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4bb00>]}
2018-03-07 17:27:33,982: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-07 17:27:34,010: 17:27:34 | 8 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.17s]
2018-03-07 17:27:34,374: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-07 17:27:35,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eff1e80>]}
2018-03-07 17:27:36,276: 17:27:36 | 9 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.20s]
2018-03-07 17:27:36,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:36,713: 17:27:36 | 10 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 3.26s]
2018-03-07 17:27:36,761: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbcd8d0>]}
2018-03-07 17:27:37,213: 17:27:37 | 11 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.32s]
2018-03-07 17:27:37,214: 17:27:37 | 12 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-07 17:27:37,215: Compiling model.seo_audit.semrush_url_history
2018-03-07 17:27:37,214: 17:27:37 | 13 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-07 17:27:37,224: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-07 17:27:37,214: 17:27:37 | 14 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-07 17:27:37,214: 17:27:37 | 15 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-07 17:27:37,224: Compiling model.seo_audit.majestic_domain_history
2018-03-07 17:27:37,224: Compiling model.seo_audit.semrush_keyword_history
2018-03-07 17:27:37,225: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-07 17:27:37,225: Acquiring new bigquery connection "semrush_url_history".
2018-03-07 17:27:37,230: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-07 17:27:37,236: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-07 17:27:37,243: Re-using an available connection from the pool.
2018-03-07 17:27:37,247: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-07 17:27:37,254: Acquiring new bigquery connection "majestic_domain_history".
2018-03-07 17:27:37,257: Re-using an available connection from the pool.
2018-03-07 17:27:37,256: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-07 17:27:37,263: Re-using an available connection from the pool.
2018-03-07 17:27:37,275: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-07 17:27:37,276: Re-using an available connection from the pool.
2018-03-07 17:27:38,147: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-07 17:27:38,148: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-07 17:27:38,163: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-07 17:27:38,250: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-07 17:27:39,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4b198>]}
2018-03-07 17:27:40,481: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efee940>]}
2018-03-07 17:27:40,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb880f0>]}
2018-03-07 17:27:40,548: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc04d68>]}
2018-03-07 17:27:40,721: 17:27:40 | 14 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.09s]
2018-03-07 17:27:41,087: 17:27:41 | 13 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.26s]
2018-03-07 17:27:41,455: 17:27:41 | 12 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.31s]
2018-03-07 17:27:41,865: 17:27:41 | 15 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.32s]
2018-03-07 17:27:41,866: 17:27:41 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-07 17:27:41,866: Compiling model.seo_audit.deepcrawl_class
2018-03-07 17:27:41,874: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-07 17:27:41,875: Acquiring new bigquery connection "deepcrawl_class".
2018-03-07 17:27:41,875: Re-using an available connection from the pool.
2018-03-07 17:27:42,730: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-07 17:27:45,110: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:45,519: 17:27:45 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 3.24s]
2018-03-07 17:27:45,519: 17:27:45 | 17 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-07 17:27:45,520: 17:27:45 | 18 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-07 17:27:45,521: Compiling model.seo_audit.deepcrawl_urls
2018-03-07 17:27:45,521: 17:27:45 | 20 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-07 17:27:45,521: Compiling model.seo_audit.majestic_domain_stats
2018-03-07 17:27:45,520: 17:27:45 | 19 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-07 17:27:45,527: Compiling model.seo_audit.semrush_keyword_stats
2018-03-07 17:27:45,529: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-07 17:27:45,536: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-07 17:27:45,536: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:27:45,542: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-07 17:27:45,548: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-07 17:27:45,551: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-07 17:27:45,552: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-07 17:27:45,553: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-07 17:27:45,554: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-07 17:27:45,554: Re-using an available connection from the pool.
2018-03-07 17:27:45,555: Re-using an available connection from the pool.
2018-03-07 17:27:45,555: Re-using an available connection from the pool.
2018-03-07 17:27:45,558: Re-using an available connection from the pool.
2018-03-07 17:27:46,462: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-07 17:27:46,490: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-07 17:27:46,594: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-07 17:27:46,662: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:27:47,796: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc12860>]}
2018-03-07 17:27:48,236: 17:27:48 | 17 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.28s]
2018-03-07 17:27:48,236: 17:27:48 | 21 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-07 17:27:48,236: Compiling model.seo_audit.semrush_url_stats
2018-03-07 17:27:48,242: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-07 17:27:48,243: Acquiring new bigquery connection "semrush_url_stats".
2018-03-07 17:27:48,243: Re-using an available connection from the pool.
2018-03-07 17:27:48,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc88e80>]}
2018-03-07 17:27:48,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:27:49,083: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:27:49,171: 17:27:49 | 19 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.25s]
2018-03-07 17:27:49,571: 17:27:49 | 18 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.32s]
2018-03-07 17:27:50,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc88208>]}
2018-03-07 17:27:50,484: 17:27:50 | 20 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.58s]
2018-03-07 17:27:51,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc12860>]}
2018-03-07 17:27:51,811: 17:27:51 | 21 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.16s]
2018-03-07 17:27:51,812: 17:27:51 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-07 17:27:51,813: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:27:51,823: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-07 17:27:51,812: 17:27:51 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-07 17:27:51,812: 17:27:51 | 24 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-07 17:27:51,813: 17:27:51 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-07 17:27:51,823: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:27:51,824: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-07 17:27:51,824: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:27:51,824: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:27:51,828: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-07 17:27:51,829: Re-using an available connection from the pool.
2018-03-07 17:27:51,833: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-07 17:27:51,840: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-07 17:27:51,844: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-07 17:27:51,850: Re-using an available connection from the pool.
2018-03-07 17:27:51,848: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-07 17:27:51,855: Re-using an available connection from the pool.
2018-03-07 17:27:51,849: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-07 17:27:51,859: Re-using an available connection from the pool.
2018-03-07 17:27:52,654: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-07 17:27:52,711: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:27:52,731: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:27:52,769: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-07 17:27:53,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:53,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:27:54,246: 17:27:54 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.00s]
2018-03-07 17:27:54,247: 17:27:54 | 26 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-07 17:27:54,247: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:27:54,252: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-07 17:27:54,255: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-07 17:27:54,255: Re-using an available connection from the pool.
2018-03-07 17:27:54,707: 17:27:54 | 24 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.07s]
2018-03-07 17:27:54,708: 17:27:54 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-07 17:27:54,708: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:27:54,712: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-07 17:27:54,714: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-07 17:27:54,714: Re-using an available connection from the pool.
2018-03-07 17:27:55,150: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:27:55,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc8cdd8>]}
2018-03-07 17:27:55,594: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-07 17:27:55,645: 17:27:55 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.36s]
2018-03-07 17:27:56,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ca1b828>]}
2018-03-07 17:27:56,301: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:56,625: 17:27:56 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 4.40s]
2018-03-07 17:27:56,740: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:27:56,994: 17:27:56 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.05s]
2018-03-07 17:27:57,369: 17:27:57 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.03s]
2018-03-07 17:27:57,370: 17:27:57 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-07 17:27:57,370: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:27:57,370: 17:27:57 | 29 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-07 17:27:57,376: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-07 17:27:57,370: 17:27:57 | 30 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-07 17:27:57,377: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:27:57,377: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:27:57,381: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-07 17:27:57,386: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-07 17:27:57,387: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-07 17:27:57,387: Re-using an available connection from the pool.
2018-03-07 17:27:57,391: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-07 17:27:57,391: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-07 17:27:57,393: Re-using an available connection from the pool.
2018-03-07 17:27:57,393: Re-using an available connection from the pool.
2018-03-07 17:27:58,261: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-07 17:27:58,262: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-07 17:27:58,293: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-07 17:27:59,448: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc8cc88>]}
2018-03-07 17:27:59,451: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4bb00>]}
2018-03-07 17:27:59,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:27:59,862: 17:27:59 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.07s]
2018-03-07 17:28:00,933: 17:28:00 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.07s]
2018-03-07 17:28:01,359: 17:28:01 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.08s]
2018-03-07 17:28:01,360: 17:28:01 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-07 17:28:01,360: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:28:01,377: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-07 17:28:01,378: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-07 17:28:01,378: Re-using an available connection from the pool.
2018-03-07 17:28:02,478: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:28:06,012: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:28:06,397: 17:28:06 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.65s]
2018-03-07 17:28:06,398: 17:28:06 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-07 17:28:06,398: Compiling model.seo_audit.deepcrawl_reclass
2018-03-07 17:28:06,409: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-07 17:28:06,413: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-07 17:28:06,413: Re-using an available connection from the pool.
2018-03-07 17:28:07,424: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-07 17:28:08,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:28:09,002: 17:28:09 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.22s]
2018-03-07 17:28:09,003: 17:28:09 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-07 17:28:09,003: Compiling model.seo_audit.ga_proc
2018-03-07 17:28:09,003: 17:28:09 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-07 17:28:09,016: Compiling model.seo_audit.ga_proc_pageviews
2018-03-07 17:28:09,024: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-07 17:28:09,027: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-07 17:28:09,030: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-07 17:28:09,031: Acquiring new bigquery connection "ga_proc".
2018-03-07 17:28:09,031: Re-using an available connection from the pool.
2018-03-07 17:28:09,031: Re-using an available connection from the pool.
2018-03-07 17:28:09,991: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) leads,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-07 17:28:09,994: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-07 17:28:13,548: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc4bb00>]}
2018-03-07 17:28:13,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:28:13,929: 17:28:13 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.53s]
2018-03-07 17:28:14,346: 17:28:14 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 4.73s]
2018-03-07 17:28:14,347: 17:28:14 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-07 17:28:14,347: Compiling model.seo_audit.agg_indicative
2018-03-07 17:28:14,356: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-07 17:28:14,357: Acquiring new bigquery connection "agg_indicative".
2018-03-07 17:28:14,357: Re-using an available connection from the pool.
2018-03-07 17:28:15,251: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-07 17:28:17,580: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:28:17,943: 17:28:17 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.23s]
2018-03-07 17:28:17,944: 17:28:17 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-07 17:28:17,944: Compiling model.seo_audit.dates
2018-03-07 17:28:17,950: Writing injected SQL for node "model.seo_audit.dates"
2018-03-07 17:28:17,953: Acquiring new bigquery connection "dates".
2018-03-07 17:28:17,953: Re-using an available connection from the pool.
2018-03-07 17:28:18,800: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-07 17:28:21,134: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:28:21,506: 17:28:21 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.19s]
2018-03-07 17:28:21,507: 17:28:21 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-07 17:28:21,507: 17:28:21 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-07 17:28:21,508: Compiling model.seo_audit.ga_stats
2018-03-07 17:28:21,509: Compiling model.seo_audit.search_console_history
2018-03-07 17:28:21,527: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-07 17:28:21,529: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-07 17:28:21,530: Acquiring new bigquery connection "ga_stats".
2018-03-07 17:28:21,530: Re-using an available connection from the pool.
2018-03-07 17:28:21,531: Acquiring new bigquery connection "search_console_history".
2018-03-07 17:28:21,531: Re-using an available connection from the pool.
2018-03-07 17:28:22,482: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then leads else 0 end ) as leads_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then leads else 0 end ) as leads_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then leads else 0 end ) as leads_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-07 17:28:22,483: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-07 17:28:24,844: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efee4e0>]}
2018-03-07 17:28:24,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:28:25,283: 17:28:25 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.33s]
2018-03-07 17:28:25,658: 17:28:25 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.35s]
2018-03-07 17:28:25,659: 17:28:25 | 39 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-07 17:28:25,660: Compiling model.seo_audit.search_console_stats_keyword
2018-03-07 17:28:25,659: 17:28:25 | 40 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-07 17:28:25,670: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-07 17:28:25,670: Compiling model.seo_audit.search_console_stats_url
2018-03-07 17:28:25,677: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-07 17:28:25,678: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-07 17:28:25,678: Re-using an available connection from the pool.
2018-03-07 17:28:25,680: Acquiring new bigquery connection "search_console_stats_url".
2018-03-07 17:28:25,680: Re-using an available connection from the pool.
2018-03-07 17:28:26,784: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-07 17:28:26,793: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-07 17:28:27,966: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbffeb8>]}
2018-03-07 17:28:28,344: 17:28:28 | 39 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.31s]
2018-03-07 17:28:29,191: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10efeea90>]}
2018-03-07 17:28:29,615: 17:28:29 | 40 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.52s]
2018-03-07 17:28:29,615: 17:28:29 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-07 17:28:29,616: Compiling model.seo_audit.agg_stats
2018-03-07 17:28:29,629: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-07 17:28:29,630: Acquiring new bigquery connection "agg_stats".
2018-03-07 17:28:29,630: Re-using an available connection from the pool.
2018-03-07 17:28:30,761: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-07 17:28:31,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096b46d8>]}
2018-03-07 17:28:32,338: 17:28:32 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.34s]
2018-03-07 17:28:32,339: 17:28:32 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-07 17:28:32,339: Compiling model.seo_audit.agg_stats_client
2018-03-07 17:28:32,346: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-07 17:28:32,347: Acquiring new bigquery connection "agg_stats_client".
2018-03-07 17:28:32,347: Re-using an available connection from the pool.
2018-03-07 17:28:33,171: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-07 17:28:36,662: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc16c50>]}
2018-03-07 17:28:38,492: 17:28:38 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.32s]
2018-03-07 17:28:38,493: 17:28:38 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-07 17:28:38,493: Compiling model.seo_audit.agg_all
2018-03-07 17:28:38,501: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-07 17:28:38,502: Acquiring new bigquery connection "agg_all".
2018-03-07 17:28:38,502: Re-using an available connection from the pool.
2018-03-07 17:28:39,372: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(url, r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
duplicate_body_count,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:28:39,375: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(url, r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
duplicate_body_count,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:28:39,375: 400 Column name url is ambiguous at [61:27]
2018-03-07 17:28:39,376: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7eaa18d5-f69f-4d14-95a3-1a1f23dbcf5b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbcd828>]}
2018-03-07 17:28:39,766: 17:28:39 | 43 of 46 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.88s]
2018-03-07 17:28:39,767: 17:28:39 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-07 17:28:39,768: 17:28:39 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-07 17:28:39,769: 17:28:39 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-07 17:28:39,840: 17:28:39 | 
2018-03-07 17:28:39,840: 17:28:39 | Finished running 46 table models in 78.43s.
2018-03-07 17:28:39,840: Connection 'master' was left open.
2018-03-07 17:28:39,841: 
2018-03-07 17:28:39,841: Completed with 1 errors:
2018-03-07 17:28:39,841: 
2018-03-07 17:28:39,841: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-03-07 17:28:39,841:   Column name url is ambiguous at [61:27]
2018-03-07 17:28:39,841:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-03-07 17:28:39,842: 
Done. PASS=42 ERROR=1 SKIP=3 TOTAL=46
2018-03-07 17:28:39,842: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cbff240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c9824e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc92ac8>]}
2018-03-07 17:28:40,217: Flushing usage events
2018-03-07 17:32:02,642: Tracking: tracking
2018-03-07 17:32:02,645: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11186b3c8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11186bb00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11186b828>]}
2018-03-07 17:32:03,142: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:32:03,162: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:32:03,168: Parsing core.sql
2018-03-07 17:32:03,186: Parsing adapters/bigquery.sql
2018-03-07 17:32:03,193: Parsing adapters/common.sql
2018-03-07 17:32:03,209: Parsing adapters/postgres.sql
2018-03-07 17:32:03,217: Parsing adapters/redshift.sql
2018-03-07 17:32:03,243: Parsing etc/get_custom_schema.sql
2018-03-07 17:32:03,251: Parsing materializations/archive.sql
2018-03-07 17:32:03,287: Parsing materializations/bigquery.sql
2018-03-07 17:32:03,304: Parsing materializations/helpers.sql
2018-03-07 17:32:03,330: Parsing materializations/incremental.sql
2018-03-07 17:32:03,365: Parsing materializations/table.sql
2018-03-07 17:32:03,385: Parsing materializations/view.sql
2018-03-07 17:32:03,404: Parsing materializations/wrapper.sql
2018-03-07 17:32:03,410: Parsing schema_tests/accepted_values.sql
2018-03-07 17:32:03,417: Parsing schema_tests/not_null.sql
2018-03-07 17:32:03,422: Parsing schema_tests/relationships.sql
2018-03-07 17:32:03,427: Parsing schema_tests/unique.sql
2018-03-07 17:32:03,480: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:32:03,482: Acquiring new bigquery connection "master".
2018-03-07 17:32:03,482: Opening a new connection (0 currently allocated)
2018-03-07 17:32:03,491: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:32:03,495: Parsing model.seo_audit.actions_proc
2018-03-07 17:32:03,500: Parsing model.seo_audit.accounts_proc
2018-03-07 17:32:03,505: Parsing model.seo_audit.all_dates
2018-03-07 17:32:03,506: Parsing model.seo_audit.dates
2018-03-07 17:32:03,508: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:32:03,512: Parsing model.seo_audit.agg_all
2018-03-07 17:32:03,515: Parsing model.seo_audit.agg_indicative
2018-03-07 17:32:03,518: Parsing model.seo_audit.agg_stats
2018-03-07 17:32:03,523: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:32:03,526: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:32:03,529: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:32:03,531: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:32:03,532: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:32:03,534: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:32:03,537: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:32:03,539: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:32:03,542: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:32:03,551: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:32:03,553: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:32:03,556: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:32:03,558: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:32:03,559: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:32:03,562: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:32:03,563: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:32:03,567: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:32:03,569: Parsing model.seo_audit.ga_proc
2018-03-07 17:32:03,572: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:32:03,575: Parsing model.seo_audit.ga_stats
2018-03-07 17:32:03,578: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:32:03,580: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:32:03,583: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:32:03,585: Parsing model.seo_audit.moz_proc
2018-03-07 17:32:03,587: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:32:03,591: Parsing model.seo_audit.search_console_history
2018-03-07 17:32:03,593: Parsing model.seo_audit.search_console_proc
2018-03-07 17:32:03,596: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:32:03,599: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:32:03,601: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:32:03,603: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:32:03,606: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:32:03,609: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:32:03,612: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:32:03,614: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:32:03,616: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:32:03,633: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:32:03,648: 
2018-03-07 17:32:03,756: Unhandled error while running:
list dataset
2018-03-07 17:32:03,756: HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))
2018-03-07 17:32:03,756: Connection 'master' was left open.
2018-03-07 17:32:03,756: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11199a1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11199a5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11199a828>]}
2018-03-07 17:32:03,779: Encountered an error:
2018-03-07 17:32:03,779: Runtime Error
  HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))
2018-03-07 17:32:03,820: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connection.py", line 141, in _new_conn
    (self.host, self.port), self.timeout, **extra_kw)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/util/connection.py", line 60, in create_connection
    for res in socket.getaddrinfo(host, port, family, socket.SOCK_STREAM):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/socket.py", line 745, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 346, in _make_request
    self._validate_conn(conn)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 850, in _validate_conn
    conn.connect()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connection.py", line 284, in connect
    conn = self._new_conn()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connection.py", line 150, in _new_conn
    self, "Failed to establish a new connection: %s" % e)
urllib3.exceptions.NewConnectionError: <urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/util/retry.py", line 388, in increment
    raise MaxRetryError(_pool, url, error or ResponseError(cause))
urllib3.exceptions.MaxRetryError: HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/auth/transport/requests.py", line 112, in __call__
    **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/sessions.py", line 508, in request
    resp = self.send(prep, **send_kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/adapters.py", line 508, in send
    raise ConnectionError(e, request=request)
requests.exceptions.ConnectionError: HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 51, in exception_handler
    yield
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 342, in get_existing_schemas
    return [ds.name for ds in all_datasets]
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 342, in <listcomp>
    return [ds.name for ds in all_datasets]
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 248, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 290, in api_request
    headers=headers, target_object=_target_object)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 183, in _make_request
    return self._do_request(method, url, headers, data, target_object)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 212, in _do_request
    url=url, method=method, headers=headers, data=data)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/auth/transport/requests.py", line 176, in request
    self._auth_request, method, url, request_headers)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/auth/credentials.py", line 121, in before_request
    self.refresh(request)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/oauth2/service_account.py", line 322, in refresh
    request, self._token_uri, assertion)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/oauth2/_client.py", line 143, in jwt_grant
    response_data = _token_endpoint_request(request, token_uri, body)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/oauth2/_client.py", line 104, in _token_endpoint_request
    method='POST', url=token_uri, headers=headers, body=body)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/auth/transport/requests.py", line 115, in __call__
    raise exceptions.TransportError(exc)
google.auth.exceptions.TransportError: HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 206, in run_from_graph
    Runner.before_run(self.project, adapter, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 326, in before_run
    cls.create_schemas(project, adapter, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 319, in create_schemas
    existing_schemas = set(adapter.get_existing_schemas(profile))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 342, in get_existing_schemas
    return [ds.name for ds in all_datasets]
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/contextlib.py", line 99, in __exit__
    self.gen.throw(type, value, traceback)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 64, in exception_handler
    raise dbt.exceptions.RuntimeException(dbt.compat.to_string(e))
dbt.exceptions.RuntimeException: Runtime Error
  HTTPSConnectionPool(host='accounts.google.com', port=443): Max retries exceeded with url: /o/oauth2/token (Caused by NewConnectionError('<urllib3.connection.VerifiedHTTPSConnection object at 0x11199a978>: Failed to establish a new connection: [Errno 8] nodename nor servname provided, or not known',))

2018-03-07 17:32:44,438: Tracking: tracking
2018-03-07 17:32:44,444: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddb85f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ddb8390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f74ce10>]}
2018-03-07 17:32:45,381: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:32:45,399: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:32:45,403: Parsing core.sql
2018-03-07 17:32:45,424: Parsing adapters/bigquery.sql
2018-03-07 17:32:45,434: Parsing adapters/common.sql
2018-03-07 17:32:45,453: Parsing adapters/postgres.sql
2018-03-07 17:32:45,460: Parsing adapters/redshift.sql
2018-03-07 17:32:45,481: Parsing etc/get_custom_schema.sql
2018-03-07 17:32:45,489: Parsing materializations/archive.sql
2018-03-07 17:32:45,524: Parsing materializations/bigquery.sql
2018-03-07 17:32:45,541: Parsing materializations/helpers.sql
2018-03-07 17:32:45,565: Parsing materializations/incremental.sql
2018-03-07 17:32:45,598: Parsing materializations/table.sql
2018-03-07 17:32:45,624: Parsing materializations/view.sql
2018-03-07 17:32:45,646: Parsing materializations/wrapper.sql
2018-03-07 17:32:45,654: Parsing schema_tests/accepted_values.sql
2018-03-07 17:32:45,661: Parsing schema_tests/not_null.sql
2018-03-07 17:32:45,665: Parsing schema_tests/relationships.sql
2018-03-07 17:32:45,671: Parsing schema_tests/unique.sql
2018-03-07 17:32:45,758: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:32:45,761: Acquiring new bigquery connection "master".
2018-03-07 17:32:45,761: Opening a new connection (0 currently allocated)
2018-03-07 17:32:45,765: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:32:45,768: Parsing model.seo_audit.actions_proc
2018-03-07 17:32:45,773: Parsing model.seo_audit.accounts_proc
2018-03-07 17:32:45,776: Parsing model.seo_audit.all_dates
2018-03-07 17:32:45,778: Parsing model.seo_audit.dates
2018-03-07 17:32:45,784: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:32:45,787: Parsing model.seo_audit.agg_all
2018-03-07 17:32:45,791: Parsing model.seo_audit.agg_indicative
2018-03-07 17:32:45,794: Parsing model.seo_audit.agg_stats
2018-03-07 17:32:45,799: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:32:45,802: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:32:45,806: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:32:45,809: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:32:45,811: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:32:45,814: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:32:45,817: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:32:45,819: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:32:45,822: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:32:45,832: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:32:45,834: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:32:45,836: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:32:45,838: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:32:45,840: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:32:45,842: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:32:45,844: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:32:45,848: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:32:45,849: Parsing model.seo_audit.ga_proc
2018-03-07 17:32:45,853: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:32:45,857: Parsing model.seo_audit.ga_stats
2018-03-07 17:32:45,861: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:32:45,863: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:32:45,866: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:32:45,869: Parsing model.seo_audit.moz_proc
2018-03-07 17:32:45,873: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:32:45,877: Parsing model.seo_audit.search_console_history
2018-03-07 17:32:45,879: Parsing model.seo_audit.search_console_proc
2018-03-07 17:32:45,882: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:32:45,885: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:32:45,887: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:32:45,890: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:32:45,893: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:32:45,898: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:32:45,901: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:32:45,903: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:32:45,907: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:32:45,923: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:32:45,940: 
2018-03-07 17:32:47,617: 17:32:47 | Concurrency: 4 threads (target='prod')
2018-03-07 17:32:47,617: 17:32:47 | 
2018-03-07 17:32:48,093: 17:32:48 | 1 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-07 17:32:48,093: Compiling model.seo_audit.accounts_proc
2018-03-07 17:32:48,093: 17:32:48 | 2 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-07 17:32:48,098: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-07 17:32:48,093: 17:32:48 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-07 17:32:48,098: Compiling model.seo_audit.all_dates
2018-03-07 17:32:48,098: Compiling model.seo_audit.deepcrawl_proc
2018-03-07 17:32:48,102: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-07 17:32:48,108: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-07 17:32:48,110: Acquiring new bigquery connection "all_dates".
2018-03-07 17:32:48,110: Opening a new connection (1 currently allocated)
2018-03-07 17:32:48,113: Acquiring new bigquery connection "accounts_proc".
2018-03-07 17:32:48,115: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-07 17:32:48,115: Opening a new connection (2 currently allocated)
2018-03-07 17:32:48,183: Opening a new connection (3 currently allocated)
2018-03-07 17:32:49,903: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-07 17:32:49,906: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-07 17:32:49,948: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-03-07 17:32:51,114: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f858320>]}
2018-03-07 17:32:51,116: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e0eb8>]}
2018-03-07 17:32:51,567: 17:32:51 | 1 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.02s]
2018-03-07 17:32:51,969: 17:32:51 | 2 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.02s]
2018-03-07 17:32:53,413: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f92f5f8>]}
2018-03-07 17:32:53,795: 17:32:53 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 5.31s]
2018-03-07 17:32:53,796: 17:32:53 | 4 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-07 17:32:53,797: Compiling model.seo_audit.sitemap_proc
2018-03-07 17:32:53,796: 17:32:53 | 5 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-07 17:32:53,803: Compiling model.seo_audit.search_console_proc
2018-03-07 17:32:53,809: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-07 17:32:53,810: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-07 17:32:53,796: 17:32:53 | 6 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-07 17:32:53,797: 17:32:53 | 7 of 46 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-03-07 17:32:53,811: Compiling model.seo_audit.semrush_keyword_proc
2018-03-07 17:32:53,811: Compiling model.seo_audit.mappings_ga_proc
2018-03-07 17:32:53,818: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-07 17:32:53,823: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-07 17:32:53,824: Acquiring new bigquery connection "search_console_proc".
2018-03-07 17:32:53,825: Acquiring new bigquery connection "sitemap_proc".
2018-03-07 17:32:53,826: Re-using an available connection from the pool.
2018-03-07 17:32:53,826: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-07 17:32:53,827: Re-using an available connection from the pool.
2018-03-07 17:32:53,828: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-07 17:32:53,829: Re-using an available connection from the pool.
2018-03-07 17:32:53,837: Opening a new connection (4 currently allocated)
2018-03-07 17:32:54,781: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-07 17:32:54,836: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-07 17:32:54,939: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-07 17:32:55,464: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-07 17:32:58,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f803a90>]}
2018-03-07 17:32:58,350: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f92f470>]}
2018-03-07 17:32:58,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8582e8>]}
2018-03-07 17:32:58,682: 17:32:58 | 5 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.51s]
2018-03-07 17:32:58,683: 17:32:58 | 8 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-07 17:32:58,683: Compiling model.seo_audit.semrush_domain_proc
2018-03-07 17:32:58,693: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-07 17:32:58,695: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-07 17:32:58,695: Re-using an available connection from the pool.
2018-03-07 17:32:59,077: 17:32:59 | 4 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.55s]
2018-03-07 17:32:59,078: 17:32:59 | 9 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-07 17:32:59,079: Compiling model.seo_audit.majestic_domain_proc
2018-03-07 17:32:59,088: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-07 17:32:59,091: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-07 17:32:59,091: Re-using an available connection from the pool.
2018-03-07 17:32:59,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e0e10>]}
2018-03-07 17:32:59,475: 17:32:59 | 6 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.63s]
2018-03-07 17:32:59,477: 17:32:59 | 10 of 46 START table model seo_audit.moz_proc........................ [RUN]
2018-03-07 17:32:59,479: Compiling model.seo_audit.moz_proc
2018-03-07 17:32:59,491: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-07 17:32:59,491: Acquiring new bigquery connection "moz_proc".
2018-03-07 17:32:59,492: Re-using an available connection from the pool.
2018-03-07 17:32:59,913: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:32:59,914: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-07 17:32:59,922: 17:32:59 | 7 of 46 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 5.37s]
2018-03-07 17:32:59,923: 17:32:59 | 11 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-07 17:32:59,923: Compiling model.seo_audit.screamingfrog_proc
2018-03-07 17:32:59,931: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-07 17:32:59,932: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-07 17:32:59,932: Re-using an available connection from the pool.
2018-03-07 17:33:00,294: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:33:00,903: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-07 17:33:02,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f803a90>]}
2018-03-07 17:33:02,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f82cbe0>]}
2018-03-07 17:33:02,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8582e8>]}
2018-03-07 17:33:03,073: 17:33:03 | 8 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.53s]
2018-03-07 17:33:03,214: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f835b70>]}
2018-03-07 17:33:03,452: 17:33:03 | 9 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.17s]
2018-03-07 17:33:03,838: 17:33:03 | 10 of 46 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 3.10s]
2018-03-07 17:33:04,229: 17:33:04 | 11 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 3.29s]
2018-03-07 17:33:04,230: 17:33:04 | 12 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-07 17:33:04,231: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-07 17:33:04,230: 17:33:04 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-07 17:33:04,237: Compiling model.seo_audit.semrush_url_history
2018-03-07 17:33:04,244: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-07 17:33:04,247: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-07 17:33:04,230: 17:33:04 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-07 17:33:04,247: Compiling model.seo_audit.majestic_domain_history
2018-03-07 17:33:04,252: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-07 17:33:04,230: 17:33:04 | 15 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-07 17:33:04,253: Compiling model.seo_audit.semrush_keyword_history
2018-03-07 17:33:04,262: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-07 17:33:04,263: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-07 17:33:04,266: Re-using an available connection from the pool.
2018-03-07 17:33:04,265: Acquiring new bigquery connection "semrush_url_history".
2018-03-07 17:33:04,266: Acquiring new bigquery connection "majestic_domain_history".
2018-03-07 17:33:04,269: Re-using an available connection from the pool.
2018-03-07 17:33:04,271: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-07 17:33:04,287: Re-using an available connection from the pool.
2018-03-07 17:33:04,293: Re-using an available connection from the pool.
2018-03-07 17:33:05,119: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-07 17:33:05,156: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-07 17:33:05,207: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-07 17:33:05,245: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-07 17:33:07,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8b7cf8>]}
2018-03-07 17:33:07,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f86cc18>]}
2018-03-07 17:33:07,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f818c18>]}
2018-03-07 17:33:07,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f951048>]}
2018-03-07 17:33:07,871: 17:33:07 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.22s]
2018-03-07 17:33:08,238: 17:33:08 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.26s]
2018-03-07 17:33:08,655: 17:33:08 | 15 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.29s]
2018-03-07 17:33:09,037: 17:33:09 | 12 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.33s]
2018-03-07 17:33:09,038: 17:33:09 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-07 17:33:09,039: Compiling model.seo_audit.deepcrawl_class
2018-03-07 17:33:09,050: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-07 17:33:09,051: Acquiring new bigquery connection "deepcrawl_class".
2018-03-07 17:33:09,051: Re-using an available connection from the pool.
2018-03-07 17:33:10,237: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-07 17:33:11,385: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e09e8>]}
2018-03-07 17:33:11,759: 17:33:11 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.35s]
2018-03-07 17:33:11,760: 17:33:11 | 17 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-07 17:33:11,760: Compiling model.seo_audit.semrush_keyword_stats
2018-03-07 17:33:11,760: 17:33:11 | 18 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-07 17:33:11,768: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-07 17:33:11,760: 17:33:11 | 19 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-07 17:33:11,760: 17:33:11 | 20 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-07 17:33:11,768: Compiling model.seo_audit.semrush_url_stats
2018-03-07 17:33:11,768: Compiling model.seo_audit.majestic_domain_stats
2018-03-07 17:33:11,769: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:33:11,774: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-07 17:33:11,781: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-07 17:33:11,793: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-07 17:33:11,796: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-07 17:33:11,798: Acquiring new bigquery connection "semrush_url_stats".
2018-03-07 17:33:11,799: Re-using an available connection from the pool.
2018-03-07 17:33:11,800: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-07 17:33:11,801: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-07 17:33:11,802: Re-using an available connection from the pool.
2018-03-07 17:33:11,803: Re-using an available connection from the pool.
2018-03-07 17:33:11,811: Re-using an available connection from the pool.
2018-03-07 17:33:12,783: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-07 17:33:12,783: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:33:12,784: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:33:13,359: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-07 17:33:15,086: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3339e8>]}
2018-03-07 17:33:15,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9248d0>]}
2018-03-07 17:33:15,133: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8b09e8>]}
2018-03-07 17:33:15,495: 17:33:15 | 19 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.32s]
2018-03-07 17:33:15,496: 17:33:15 | 21 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-07 17:33:15,496: Compiling model.seo_audit.deepcrawl_urls
2018-03-07 17:33:15,504: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-07 17:33:15,506: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-07 17:33:15,507: Re-using an available connection from the pool.
2018-03-07 17:33:15,895: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f818c18>]}
2018-03-07 17:33:15,964: 17:33:15 | 18 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.32s]
2018-03-07 17:33:16,345: 17:33:16 | 20 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.36s]
2018-03-07 17:33:16,480: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-07 17:33:16,958: 17:33:16 | 17 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.13s]
2018-03-07 17:33:17,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f835cf8>]}
2018-03-07 17:33:18,300: 17:33:18 | 21 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.42s]
2018-03-07 17:33:18,301: 17:33:18 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-07 17:33:18,302: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:33:18,302: 17:33:18 | 23 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-07 17:33:18,308: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:33:18,315: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-07 17:33:18,317: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-07 17:33:18,302: 17:33:18 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-07 17:33:18,317: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:33:18,322: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-07 17:33:18,302: 17:33:18 | 25 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-07 17:33:18,323: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:33:18,329: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-07 17:33:18,333: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-07 17:33:18,334: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-07 17:33:18,336: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-07 17:33:18,339: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-07 17:33:18,339: Re-using an available connection from the pool.
2018-03-07 17:33:18,340: Re-using an available connection from the pool.
2018-03-07 17:33:18,348: Re-using an available connection from the pool.
2018-03-07 17:33:18,359: Re-using an available connection from the pool.
2018-03-07 17:33:19,157: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-07 17:33:19,225: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-07 17:33:19,226: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-07 17:33:19,566: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:33:20,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f93ea20>]}
2018-03-07 17:33:20,363: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:33:20,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9240b8>]}
2018-03-07 17:33:20,718: 17:33:20 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.99s]
2018-03-07 17:33:20,721: 17:33:20 | 26 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-07 17:33:20,722: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:33:20,728: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-07 17:33:20,729: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-07 17:33:20,730: Re-using an available connection from the pool.
2018-03-07 17:33:21,155: 17:33:21 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.06s]
2018-03-07 17:33:21,156: 17:33:21 | 27 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-07 17:33:21,157: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:33:21,166: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-07 17:33:21,168: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-07 17:33:21,169: Re-using an available connection from the pool.
2018-03-07 17:33:21,664: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:33:21,991: 17:33:21 | 23 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.08s]
2018-03-07 17:33:22,175: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:33:22,883: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e0e10>]}
2018-03-07 17:33:23,043: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f929cc0>]}
2018-03-07 17:33:23,298: 17:33:23 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.16s]
2018-03-07 17:33:23,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:33:23,705: 17:33:23 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 4.72s]
2018-03-07 17:33:24,547: 17:33:24 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.17s]
2018-03-07 17:33:24,549: 17:33:24 | 28 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-07 17:33:24,549: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:33:24,555: 17:33:24 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-07 17:33:24,557: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-07 17:33:24,557: 17:33:24 | 30 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-07 17:33:24,557: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:33:24,557: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:33:24,562: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-07 17:33:24,566: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-07 17:33:24,568: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-07 17:33:24,568: Re-using an available connection from the pool.
2018-03-07 17:33:24,569: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-07 17:33:24,570: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-07 17:33:24,570: Re-using an available connection from the pool.
2018-03-07 17:33:24,572: Re-using an available connection from the pool.
2018-03-07 17:33:25,443: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-07 17:33:25,463: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-07 17:33:25,464: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-07 17:33:26,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f835cf8>]}
2018-03-07 17:33:26,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f911ba8>]}
2018-03-07 17:33:26,625: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9115c0>]}
2018-03-07 17:33:26,944: 17:33:26 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.04s]
2018-03-07 17:33:27,328: 17:33:27 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.07s]
2018-03-07 17:33:27,735: 17:33:27 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.07s]
2018-03-07 17:33:27,735: 17:33:27 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-07 17:33:27,736: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:33:27,754: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-07 17:33:27,755: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-07 17:33:27,755: Re-using an available connection from the pool.
2018-03-07 17:33:28,723: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:33:32,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:33:32,662: 17:33:32 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.54s]
2018-03-07 17:33:32,663: 17:33:32 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-07 17:33:32,663: Compiling model.seo_audit.deepcrawl_reclass
2018-03-07 17:33:32,672: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-07 17:33:32,673: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-07 17:33:32,673: Re-using an available connection from the pool.
2018-03-07 17:33:34,090: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-07 17:33:35,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8b7cf8>]}
2018-03-07 17:33:35,724: 17:33:35 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.61s]
2018-03-07 17:33:35,725: 17:33:35 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-07 17:33:35,725: Compiling model.seo_audit.ga_proc
2018-03-07 17:33:35,731: 17:33:35 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-07 17:33:35,733: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-07 17:33:35,733: Compiling model.seo_audit.ga_proc_pageviews
2018-03-07 17:33:35,741: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-07 17:33:35,742: Acquiring new bigquery connection "ga_proc".
2018-03-07 17:33:35,742: Re-using an available connection from the pool.
2018-03-07 17:33:35,746: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-07 17:33:35,747: Re-using an available connection from the pool.
2018-03-07 17:33:36,624: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-07 17:33:36,765: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) leads,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-07 17:33:40,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3336a0>]}
2018-03-07 17:33:40,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:33:40,486: 17:33:40 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.38s]
2018-03-07 17:33:40,846: 17:33:40 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 4.53s]
2018-03-07 17:33:40,847: 17:33:40 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-07 17:33:40,847: Compiling model.seo_audit.agg_indicative
2018-03-07 17:33:40,856: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-07 17:33:40,857: Acquiring new bigquery connection "agg_indicative".
2018-03-07 17:33:40,857: Re-using an available connection from the pool.
2018-03-07 17:33:42,206: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-07 17:33:48,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e0f98>]}
2018-03-07 17:33:48,437: 17:33:48 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 7.17s]
2018-03-07 17:33:48,438: 17:33:48 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-07 17:33:48,438: Compiling model.seo_audit.dates
2018-03-07 17:33:48,447: Writing injected SQL for node "model.seo_audit.dates"
2018-03-07 17:33:48,448: Acquiring new bigquery connection "dates".
2018-03-07 17:33:48,448: Re-using an available connection from the pool.
2018-03-07 17:33:51,023: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-07 17:33:52,575: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:33:53,447: 17:33:53 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 4.14s]
2018-03-07 17:33:53,449: 17:33:53 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-07 17:33:53,450: Compiling model.seo_audit.ga_stats
2018-03-07 17:33:53,449: 17:33:53 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-07 17:33:53,457: Compiling model.seo_audit.search_console_history
2018-03-07 17:33:53,465: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-07 17:33:53,467: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-07 17:33:53,468: Acquiring new bigquery connection "ga_stats".
2018-03-07 17:33:53,468: Acquiring new bigquery connection "search_console_history".
2018-03-07 17:33:53,468: Re-using an available connection from the pool.
2018-03-07 17:33:53,469: Re-using an available connection from the pool.
2018-03-07 17:33:55,981: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then leads else 0 end ) as leads_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then leads else 0 end ) as leads_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then leads else 0 end ) as leads_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-07 17:33:55,982: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-07 17:33:57,565: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8e0f98>]}
2018-03-07 17:33:57,921: 17:33:57 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 4.12s]
2018-03-07 17:33:59,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c2bd438>]}
2018-03-07 17:33:59,558: 17:33:59 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 5.70s]
2018-03-07 17:33:59,559: 17:33:59 | 39 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-07 17:33:59,560: 17:33:59 | 40 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-07 17:33:59,560: Compiling model.seo_audit.search_console_stats_keyword
2018-03-07 17:33:59,560: Compiling model.seo_audit.search_console_stats_url
2018-03-07 17:33:59,570: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-07 17:33:59,578: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-07 17:33:59,579: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-07 17:33:59,579: Re-using an available connection from the pool.
2018-03-07 17:33:59,583: Acquiring new bigquery connection "search_console_stats_url".
2018-03-07 17:33:59,583: Re-using an available connection from the pool.
2018-03-07 17:34:01,173: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-07 17:34:01,351: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-07 17:34:03,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f8feb70>]}
2018-03-07 17:34:03,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c338400>]}
2018-03-07 17:34:03,938: 17:34:03 | 39 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.95s]
2018-03-07 17:34:04,340: 17:34:04 | 40 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 4.09s]
2018-03-07 17:34:04,341: 17:34:04 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-07 17:34:04,341: Compiling model.seo_audit.agg_stats
2018-03-07 17:34:04,354: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-07 17:34:04,355: Acquiring new bigquery connection "agg_stats".
2018-03-07 17:34:04,355: Re-using an available connection from the pool.
2018-03-07 17:34:05,603: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-07 17:34:06,842: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f835cf8>]}
2018-03-07 17:34:07,227: 17:34:07 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.50s]
2018-03-07 17:34:07,228: 17:34:07 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-07 17:34:07,228: Compiling model.seo_audit.agg_stats_client
2018-03-07 17:34:07,239: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-07 17:34:07,240: Acquiring new bigquery connection "agg_stats_client".
2018-03-07 17:34:07,240: Re-using an available connection from the pool.
2018-03-07 17:34:08,251: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-07 17:34:10,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c2bd278>]}
2018-03-07 17:34:11,099: 17:34:11 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 3.44s]
2018-03-07 17:34:11,100: 17:34:11 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-07 17:34:11,100: Compiling model.seo_audit.agg_all
2018-03-07 17:34:11,111: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-07 17:34:11,112: Acquiring new bigquery connection "agg_all".
2018-03-07 17:34:11,112: Re-using an available connection from the pool.
2018-03-07 17:34:11,875: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
duplicate_body_count,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:34:11,876: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
duplicate_body_count,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:34:11,876: 400 Duplicate column names in the result are not supported. Found duplicate(s): duplicate_body_count
2018-03-07 17:34:11,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f315ab2-2049-48e2-acc9-0931cdafe529', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f929fd0>]}
2018-03-07 17:34:12,298: 17:34:12 | 43 of 46 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.78s]
2018-03-07 17:34:12,301: 17:34:12 | 44 of 46 SKIP relation seo_audit.actions_proc........................ [SKIP]
2018-03-07 17:34:12,302: 17:34:12 | 45 of 46 SKIP relation seo_audit.actions_hierarchy................... [SKIP]
2018-03-07 17:34:12,303: 17:34:12 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-07 17:34:12,345: 17:34:12 | 
2018-03-07 17:34:12,346: 17:34:12 | Finished running 46 table models in 84.73s.
2018-03-07 17:34:12,346: Connection 'master' was left open.
2018-03-07 17:34:12,346: 
2018-03-07 17:34:12,347: Completed with 1 errors:
2018-03-07 17:34:12,347: 
2018-03-07 17:34:12,347: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-03-07 17:34:12,347:   Duplicate column names in the result are not supported. Found duplicate(s): duplicate_body_count
2018-03-07 17:34:12,347:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-03-07 17:34:12,348: 
Done. PASS=42 ERROR=1 SKIP=3 TOTAL=46
2018-03-07 17:34:12,349: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f803860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f803710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f83d390>]}
2018-03-07 17:34:12,801: Flushing usage events
2018-03-07 17:34:49,479: Tracking: tracking
2018-03-07 17:34:49,482: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c4ce2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c4ceb70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c4ce080>]}
2018-03-07 17:34:50,066: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:34:50,087: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:34:50,090: Parsing core.sql
2018-03-07 17:34:50,116: Parsing adapters/bigquery.sql
2018-03-07 17:34:50,126: Parsing adapters/common.sql
2018-03-07 17:34:50,146: Parsing adapters/postgres.sql
2018-03-07 17:34:50,154: Parsing adapters/redshift.sql
2018-03-07 17:34:50,182: Parsing etc/get_custom_schema.sql
2018-03-07 17:34:50,191: Parsing materializations/archive.sql
2018-03-07 17:34:50,232: Parsing materializations/bigquery.sql
2018-03-07 17:34:50,248: Parsing materializations/helpers.sql
2018-03-07 17:34:50,268: Parsing materializations/incremental.sql
2018-03-07 17:34:50,296: Parsing materializations/table.sql
2018-03-07 17:34:50,317: Parsing materializations/view.sql
2018-03-07 17:34:50,334: Parsing materializations/wrapper.sql
2018-03-07 17:34:50,342: Parsing schema_tests/accepted_values.sql
2018-03-07 17:34:50,351: Parsing schema_tests/not_null.sql
2018-03-07 17:34:50,355: Parsing schema_tests/relationships.sql
2018-03-07 17:34:50,363: Parsing schema_tests/unique.sql
2018-03-07 17:34:50,431: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:34:50,435: Acquiring new bigquery connection "master".
2018-03-07 17:34:50,435: Opening a new connection (0 currently allocated)
2018-03-07 17:34:50,440: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:34:50,443: Parsing model.seo_audit.actions_proc
2018-03-07 17:34:50,447: Parsing model.seo_audit.accounts_proc
2018-03-07 17:34:50,450: Parsing model.seo_audit.all_dates
2018-03-07 17:34:50,452: Parsing model.seo_audit.dates
2018-03-07 17:34:50,454: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:34:50,457: Parsing model.seo_audit.agg_all
2018-03-07 17:34:50,460: Parsing model.seo_audit.agg_indicative
2018-03-07 17:34:50,462: Parsing model.seo_audit.agg_stats
2018-03-07 17:34:50,468: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:34:50,471: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:34:50,473: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:34:50,475: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:34:50,477: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:34:50,479: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:34:50,481: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:34:50,484: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:34:50,488: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:34:50,498: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:34:50,501: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:34:50,502: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:34:50,504: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:34:50,506: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:34:50,508: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:34:50,510: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:34:50,514: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:34:50,515: Parsing model.seo_audit.ga_proc
2018-03-07 17:34:50,519: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:34:50,522: Parsing model.seo_audit.ga_stats
2018-03-07 17:34:50,525: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:34:50,527: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:34:50,529: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:34:50,532: Parsing model.seo_audit.moz_proc
2018-03-07 17:34:50,536: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:34:50,541: Parsing model.seo_audit.search_console_history
2018-03-07 17:34:50,544: Parsing model.seo_audit.search_console_proc
2018-03-07 17:34:50,546: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:34:50,549: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:34:50,552: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:34:50,557: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:34:50,561: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:34:50,565: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:34:50,568: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:34:50,572: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:34:50,576: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:34:50,592: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:34:50,607: 
2018-03-07 17:34:51,894: 17:34:51 | Concurrency: 4 threads (target='prod')
2018-03-07 17:34:51,895: 17:34:51 | 
2018-03-07 17:34:52,316: 17:34:52 | 1 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-07 17:34:52,317: Compiling model.seo_audit.all_dates
2018-03-07 17:34:52,320: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-07 17:34:52,316: 17:34:52 | 2 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-07 17:34:52,321: Compiling model.seo_audit.accounts_proc
2018-03-07 17:34:52,317: 17:34:52 | 3 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-07 17:34:52,326: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-07 17:34:52,326: Compiling model.seo_audit.deepcrawl_proc
2018-03-07 17:34:52,327: Acquiring new bigquery connection "all_dates".
2018-03-07 17:34:52,331: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-07 17:34:52,332: Opening a new connection (1 currently allocated)
2018-03-07 17:34:52,337: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-07 17:34:52,338: Acquiring new bigquery connection "accounts_proc".
2018-03-07 17:34:52,395: Opening a new connection (2 currently allocated)
2018-03-07 17:34:52,491: Opening a new connection (3 currently allocated)
2018-03-07 17:34:53,942: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-07 17:34:53,980: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-03-07 17:34:54,208: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-07 17:34:56,295: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6bf780>]}
2018-03-07 17:34:56,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c64c748>]}
2018-03-07 17:34:56,686: 17:34:56 | 3 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.97s]
2018-03-07 17:34:56,873: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5b6ba8>]}
2018-03-07 17:34:57,078: 17:34:57 | 2 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.99s]
2018-03-07 17:34:57,457: 17:34:57 | 1 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 4.56s]
2018-03-07 17:34:57,458: 17:34:57 | 4 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-07 17:34:57,458: Compiling model.seo_audit.search_console_proc
2018-03-07 17:34:57,458: 17:34:57 | 5 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-07 17:34:57,465: Compiling model.seo_audit.semrush_domain_proc
2018-03-07 17:34:57,471: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-07 17:34:57,474: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-07 17:34:57,458: 17:34:57 | 6 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-07 17:34:57,458: 17:34:57 | 7 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-07 17:34:57,475: Compiling model.seo_audit.moz_proc
2018-03-07 17:34:57,475: Compiling model.seo_audit.semrush_keyword_proc
2018-03-07 17:34:57,481: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-07 17:34:57,487: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-07 17:34:57,489: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-07 17:34:57,490: Acquiring new bigquery connection "search_console_proc".
2018-03-07 17:34:57,490: Re-using an available connection from the pool.
2018-03-07 17:34:57,491: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-07 17:34:57,492: Acquiring new bigquery connection "moz_proc".
2018-03-07 17:34:57,492: Re-using an available connection from the pool.
2018-03-07 17:34:57,502: Re-using an available connection from the pool.
2018-03-07 17:34:57,505: Opening a new connection (4 currently allocated)
2018-03-07 17:34:58,352: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-07 17:34:58,372: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-07 17:34:58,434: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:34:59,515: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:35:00,735: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ff16d8>]}
2018-03-07 17:35:00,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608ba8>]}
2018-03-07 17:35:01,733: 17:35:01 | 5 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.27s]
2018-03-07 17:35:01,735: 17:35:01 | 8 of 46 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-03-07 17:35:01,735: Compiling model.seo_audit.screamingfrog_proc
2018-03-07 17:35:01,748: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-07 17:35:01,751: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-07 17:35:01,752: Re-using an available connection from the pool.
2018-03-07 17:35:01,869: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608d68>]}
2018-03-07 17:35:01,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c64c358>]}
2018-03-07 17:35:02,671: 17:35:02 | 4 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.47s]
2018-03-07 17:35:02,672: 17:35:02 | 9 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-07 17:35:02,673: Compiling model.seo_audit.majestic_domain_proc
2018-03-07 17:35:02,684: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-07 17:35:02,687: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-07 17:35:02,689: Re-using an available connection from the pool.
2018-03-07 17:35:03,125: 17:35:03 | 7 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.39s]
2018-03-07 17:35:03,126: 17:35:03 | 10 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-07 17:35:03,127: Compiling model.seo_audit.mappings_ga_proc
2018-03-07 17:35:03,140: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-07 17:35:03,146: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-07 17:35:03,147: Re-using an available connection from the pool.
2018-03-07 17:35:03,533: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-07 17:35:03,569: 17:35:03 | 6 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 4.40s]
2018-03-07 17:35:03,569: 17:35:03 | 11 of 46 START table model seo_audit.sitemap_proc.................... [RUN]
2018-03-07 17:35:03,569: Compiling model.seo_audit.sitemap_proc
2018-03-07 17:35:03,580: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-07 17:35:03,581: Acquiring new bigquery connection "sitemap_proc".
2018-03-07 17:35:03,582: Re-using an available connection from the pool.
2018-03-07 17:35:03,805: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-07 17:35:04,014: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-07 17:35:04,422: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-07 17:35:06,221: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ff16d8>]}
2018-03-07 17:35:06,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608ba8>]}
2018-03-07 17:35:06,609: 17:35:06 | 8 of 46 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.49s]
2018-03-07 17:35:07,019: 17:35:07 | 9 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.55s]
2018-03-07 17:35:07,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c64c358>]}
2018-03-07 17:35:08,754: 17:35:08 | 11 of 46 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 4.32s]
2018-03-07 17:35:24,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608d68>]}
2018-03-07 17:35:25,326: 17:35:25 | 10 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 21.35s]
2018-03-07 17:35:25,327: 17:35:25 | 12 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-07 17:35:25,327: 17:35:25 | 13 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-07 17:35:25,327: 17:35:25 | 14 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-07 17:35:25,328: 17:35:25 | 15 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-07 17:35:25,328: Compiling model.seo_audit.semrush_keyword_history
2018-03-07 17:35:25,328: Compiling model.seo_audit.semrush_url_history
2018-03-07 17:35:25,328: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-07 17:35:25,329: Compiling model.seo_audit.majestic_domain_history
2018-03-07 17:35:25,339: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-07 17:35:25,344: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-07 17:35:25,350: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-07 17:35:25,355: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-07 17:35:25,358: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-07 17:35:25,359: Re-using an available connection from the pool.
2018-03-07 17:35:25,360: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-07 17:35:25,362: Acquiring new bigquery connection "majestic_domain_history".
2018-03-07 17:35:25,362: Re-using an available connection from the pool.
2018-03-07 17:35:25,364: Acquiring new bigquery connection "semrush_url_history".
2018-03-07 17:35:25,364: Re-using an available connection from the pool.
2018-03-07 17:35:25,366: Re-using an available connection from the pool.
2018-03-07 17:35:26,374: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-07 17:35:26,374: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-07 17:35:26,376: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-07 17:35:26,377: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-07 17:35:27,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5d2748>]}
2018-03-07 17:35:27,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c64c5f8>]}
2018-03-07 17:35:27,953: 17:35:27 | 12 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.21s]
2018-03-07 17:35:28,340: 17:35:28 | 15 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.24s]
2018-03-07 17:35:28,758: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6cdd68>]}
2018-03-07 17:35:29,279: 17:35:29 | 13 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.43s]
2018-03-07 17:35:30,014: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6cd940>]}
2018-03-07 17:35:30,433: 17:35:30 | 14 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 4.68s]
2018-03-07 17:35:30,434: 17:35:30 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-07 17:35:30,434: Compiling model.seo_audit.deepcrawl_class
2018-03-07 17:35:30,443: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-07 17:35:30,449: Acquiring new bigquery connection "deepcrawl_class".
2018-03-07 17:35:30,450: Re-using an available connection from the pool.
2018-03-07 17:35:31,444: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-07 17:35:32,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5f36d8>]}
2018-03-07 17:35:34,515: 17:35:34 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.51s]
2018-03-07 17:35:34,515: 17:35:34 | 17 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-07 17:35:34,516: Compiling model.seo_audit.semrush_keyword_stats
2018-03-07 17:35:34,527: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-07 17:35:34,527: 17:35:34 | 18 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-07 17:35:34,527: 17:35:34 | 19 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-07 17:35:34,528: Compiling model.seo_audit.deepcrawl_urls
2018-03-07 17:35:34,528: 17:35:34 | 20 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-07 17:35:34,528: Compiling model.seo_audit.semrush_url_stats
2018-03-07 17:35:34,529: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-07 17:35:34,543: Re-using an available connection from the pool.
2018-03-07 17:35:34,535: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-07 17:35:34,535: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:35:34,562: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-07 17:35:34,563: Re-using an available connection from the pool.
2018-03-07 17:35:34,543: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-07 17:35:34,568: Acquiring new bigquery connection "semrush_url_stats".
2018-03-07 17:35:34,568: Re-using an available connection from the pool.
2018-03-07 17:35:34,586: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-07 17:35:34,587: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-07 17:35:34,588: Re-using an available connection from the pool.
2018-03-07 17:35:35,424: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-07 17:35:35,470: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:35:35,481: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-07 17:35:35,564: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-07 17:35:37,694: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c696860>]}
2018-03-07 17:35:37,744: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6ece80>]}
2018-03-07 17:35:37,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6ce940>]}
2018-03-07 17:35:37,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5b6ef0>]}
2018-03-07 17:35:38,081: 17:35:38 | 20 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.16s]
2018-03-07 17:35:38,082: 17:35:38 | 21 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-07 17:35:38,083: Compiling model.seo_audit.majestic_domain_stats
2018-03-07 17:35:38,089: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-07 17:35:38,093: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-07 17:35:38,094: Re-using an available connection from the pool.
2018-03-07 17:35:38,480: 17:35:38 | 19 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.22s]
2018-03-07 17:35:38,893: 17:35:38 | 18 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 3.26s]
2018-03-07 17:35:39,035: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:35:39,261: 17:35:39 | 17 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.34s]
2018-03-07 17:35:43,285: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5b6ef0>]}
2018-03-07 17:35:44,853: 17:35:44 | 21 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 5.20s]
2018-03-07 17:35:44,854: 17:35:44 | 22 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-07 17:35:44,854: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:35:44,854: 17:35:44 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-07 17:35:44,861: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-07 17:35:44,862: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:35:44,854: 17:35:44 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-07 17:35:44,854: 17:35:44 | 25 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-07 17:35:44,867: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-07 17:35:44,867: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:35:44,867: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:35:44,872: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-07 17:35:44,873: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-07 17:35:44,880: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-07 17:35:44,880: Re-using an available connection from the pool.
2018-03-07 17:35:44,881: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-07 17:35:44,881: Re-using an available connection from the pool.
2018-03-07 17:35:44,883: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-07 17:35:44,883: Re-using an available connection from the pool.
2018-03-07 17:35:44,903: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-07 17:35:44,905: Re-using an available connection from the pool.
2018-03-07 17:35:47,558: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:35:47,568: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:35:47,642: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-07 17:35:47,814: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:35:49,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5f36d8>]}
2018-03-07 17:35:49,459: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6a5a58>]}
2018-03-07 17:35:49,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6c41d0>]}
2018-03-07 17:35:49,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668860>]}
2018-03-07 17:35:50,184: 17:35:50 | 22 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 4.38s]
2018-03-07 17:35:50,186: 17:35:50 | 26 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-07 17:35:50,189: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:35:50,200: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-07 17:35:50,201: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-07 17:35:50,201: Re-using an available connection from the pool.
2018-03-07 17:35:51,478: 17:35:51 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 4.60s]
2018-03-07 17:35:51,479: 17:35:51 | 27 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-07 17:35:51,479: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:35:51,484: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-07 17:35:51,486: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-07 17:35:51,486: Re-using an available connection from the pool.
2018-03-07 17:35:52,360: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-07 17:35:52,933: 17:35:52 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 4.59s]
2018-03-07 17:35:53,998: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5f36d8>]}
2018-03-07 17:35:54,061: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-07 17:35:54,604: 17:35:54 | 25 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 4.65s]
2018-03-07 17:35:55,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668b38>]}
2018-03-07 17:35:56,169: 17:35:56 | 26 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.81s]
2018-03-07 17:35:58,050: 17:35:58 | 27 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 4.35s]
2018-03-07 17:35:58,050: 17:35:58 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-07 17:35:58,051: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:35:58,062: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-07 17:35:58,061: 17:35:58 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-07 17:35:58,062: 17:35:58 | 30 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-07 17:35:58,063: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:35:58,063: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:35:58,071: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-07 17:35:58,073: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-07 17:35:58,092: Re-using an available connection from the pool.
2018-03-07 17:35:58,080: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-07 17:35:58,100: Re-using an available connection from the pool.
2018-03-07 17:35:58,090: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-07 17:35:58,112: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-07 17:35:58,112: Re-using an available connection from the pool.
2018-03-07 17:36:00,082: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-07 17:36:00,112: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-07 17:36:00,193: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-07 17:36:01,276: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5b6ef0>]}
2018-03-07 17:36:01,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10904bc50>]}
2018-03-07 17:36:01,694: 17:36:01 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 3.23s]
2018-03-07 17:36:02,084: 17:36:02 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 3.27s]
2018-03-07 17:36:02,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668b38>]}
2018-03-07 17:36:03,474: 17:36:03 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 4.48s]
2018-03-07 17:36:03,475: 17:36:03 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-07 17:36:03,476: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:36:03,489: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-07 17:36:03,490: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-07 17:36:03,490: Re-using an available connection from the pool.
2018-03-07 17:36:04,732: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:36:08,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59ff60>]}
2018-03-07 17:36:08,643: 17:36:08 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.80s]
2018-03-07 17:36:08,644: 17:36:08 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-07 17:36:08,645: Compiling model.seo_audit.deepcrawl_reclass
2018-03-07 17:36:08,653: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-07 17:36:08,654: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-07 17:36:08,654: Re-using an available connection from the pool.
2018-03-07 17:36:09,662: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-07 17:36:10,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668b38>]}
2018-03-07 17:36:11,178: 17:36:11 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.16s]
2018-03-07 17:36:11,180: 17:36:11 | 33 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-07 17:36:11,180: Compiling model.seo_audit.ga_proc
2018-03-07 17:36:11,180: 17:36:11 | 34 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-07 17:36:11,187: Compiling model.seo_audit.ga_proc_pageviews
2018-03-07 17:36:11,202: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-07 17:36:11,203: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-07 17:36:11,204: Acquiring new bigquery connection "ga_proc".
2018-03-07 17:36:11,204: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-07 17:36:11,205: Re-using an available connection from the pool.
2018-03-07 17:36:11,205: Re-using an available connection from the pool.
2018-03-07 17:36:12,158: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) leads,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-07 17:36:12,159: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-07 17:36:14,452: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59ff60>]}
2018-03-07 17:36:14,834: 17:36:14 | 33 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.27s]
2018-03-07 17:36:15,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c605080>]}
2018-03-07 17:36:16,076: 17:36:16 | 34 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.48s]
2018-03-07 17:36:16,077: 17:36:16 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-07 17:36:16,078: Compiling model.seo_audit.agg_indicative
2018-03-07 17:36:16,088: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-07 17:36:16,091: Acquiring new bigquery connection "agg_indicative".
2018-03-07 17:36:16,091: Re-using an available connection from the pool.
2018-03-07 17:36:17,053: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-07 17:36:19,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668b38>]}
2018-03-07 17:36:19,792: 17:36:19 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.32s]
2018-03-07 17:36:19,793: 17:36:19 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-07 17:36:19,794: Compiling model.seo_audit.dates
2018-03-07 17:36:19,805: Writing injected SQL for node "model.seo_audit.dates"
2018-03-07 17:36:19,808: Acquiring new bigquery connection "dates".
2018-03-07 17:36:19,808: Re-using an available connection from the pool.
2018-03-07 17:36:20,702: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-07 17:36:23,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6bfcf8>]}
2018-03-07 17:36:23,654: 17:36:23 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.26s]
2018-03-07 17:36:23,655: 17:36:23 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-07 17:36:23,655: Compiling model.seo_audit.ga_stats
2018-03-07 17:36:23,655: 17:36:23 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-07 17:36:23,662: Compiling model.seo_audit.search_console_history
2018-03-07 17:36:23,673: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-07 17:36:23,676: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-07 17:36:23,678: Acquiring new bigquery connection "search_console_history".
2018-03-07 17:36:23,678: Re-using an available connection from the pool.
2018-03-07 17:36:23,679: Acquiring new bigquery connection "ga_stats".
2018-03-07 17:36:23,681: Re-using an available connection from the pool.
2018-03-07 17:36:24,541: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then leads else 0 end ) as leads_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then leads else 0 end ) as leads_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then leads else 0 end ) as leads_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-07 17:36:24,563: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-07 17:36:26,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c668b38>]}
2018-03-07 17:36:26,850: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6ec3c8>]}
2018-03-07 17:36:27,249: 17:36:27 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.19s]
2018-03-07 17:36:27,634: 17:36:27 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.19s]
2018-03-07 17:36:27,635: 17:36:27 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-07 17:36:27,636: Compiling model.seo_audit.search_console_stats_url
2018-03-07 17:36:27,635: 17:36:27 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-07 17:36:27,645: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-07 17:36:27,645: Compiling model.seo_audit.search_console_stats_keyword
2018-03-07 17:36:27,652: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-07 17:36:27,653: Acquiring new bigquery connection "search_console_stats_url".
2018-03-07 17:36:27,653: Re-using an available connection from the pool.
2018-03-07 17:36:27,654: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-07 17:36:27,654: Re-using an available connection from the pool.
2018-03-07 17:36:28,706: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-07 17:36:28,739: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-07 17:36:31,081: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5f36d8>]}
2018-03-07 17:36:31,467: 17:36:31 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.45s]
2018-03-07 17:36:32,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59ff60>]}
2018-03-07 17:36:32,875: 17:36:32 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 4.59s]
2018-03-07 17:36:32,876: 17:36:32 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-07 17:36:32,876: Compiling model.seo_audit.agg_stats
2018-03-07 17:36:32,888: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-07 17:36:32,889: Acquiring new bigquery connection "agg_stats".
2018-03-07 17:36:32,889: Re-using an available connection from the pool.
2018-03-07 17:36:34,182: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-07 17:36:36,530: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6ce9b0>]}
2018-03-07 17:36:36,896: 17:36:36 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.65s]
2018-03-07 17:36:36,897: 17:36:36 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-07 17:36:36,897: Compiling model.seo_audit.agg_stats_client
2018-03-07 17:36:36,904: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-07 17:36:36,905: Acquiring new bigquery connection "agg_stats_client".
2018-03-07 17:36:36,905: Re-using an available connection from the pool.
2018-03-07 17:36:38,181: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-07 17:36:40,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59ff60>]}
2018-03-07 17:36:41,898: 17:36:41 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.08s]
2018-03-07 17:36:41,899: 17:36:41 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-07 17:36:41,899: Compiling model.seo_audit.agg_all
2018-03-07 17:36:41,908: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-07 17:36:41,909: Acquiring new bigquery connection "agg_all".
2018-03-07 17:36:41,909: Re-using an available connection from the pool.
2018-03-07 17:36:42,729: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:36:45,008: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6ceb70>]}
2018-03-07 17:36:45,707: 17:36:45 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 3.11s]
2018-03-07 17:36:45,708: 17:36:45 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-07 17:36:45,708: Compiling model.seo_audit.actions_proc
2018-03-07 17:36:45,725: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-07 17:36:45,729: Acquiring new bigquery connection "actions_proc".
2018-03-07 17:36:45,729: Re-using an available connection from the pool.
2018-03-07 17:36:47,302: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = 200 then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = 200  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = 200 then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'leads' and leads_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('leads', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'leads' and ( leads_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-07 17:36:51,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59ff60>]}
2018-03-07 17:36:52,436: 17:36:52 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 6.26s]
2018-03-07 17:36:52,437: 17:36:52 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-07 17:36:52,437: Compiling model.seo_audit.actions_hierarchy
2018-03-07 17:36:52,448: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-07 17:36:52,450: Acquiring new bigquery connection "actions_hierarchy".
2018-03-07 17:36:52,450: Re-using an available connection from the pool.
2018-03-07 17:36:53,221: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap,
domain,
canonical_url,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then http_status_code
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-07 17:36:53,222: Bad request while running:
SELECT
date,
client,
url,
sitemap,
found_at_sitemap,
domain,
canonical_url,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then http_status_code
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-07 17:36:53,222: 400 No matching signature for operator CASE for argument types: BOOL, STRING, BOOL, STRING, BOOL, INT64, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, STRING at [21:1]
2018-03-07 17:36:53,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '028453ef-0ea9-4167-a19a-742e6af186c5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10904bb38>]}
2018-03-07 17:36:53,611: 17:36:53 | 45 of 46 ERROR creating table model seo_audit.actions_hierarchy...... [ERROR in 0.79s]
2018-03-07 17:36:53,612: 17:36:53 | 46 of 46 SKIP relation seo_audit.actions_data_studio................. [SKIP]
2018-03-07 17:36:53,682: 17:36:53 | 
2018-03-07 17:36:53,682: 17:36:53 | Finished running 46 table models in 121.79s.
2018-03-07 17:36:53,682: Connection 'master' was left open.
2018-03-07 17:36:53,683: 
2018-03-07 17:36:53,683: Completed with 1 errors:
2018-03-07 17:36:53,683: 
2018-03-07 17:36:53,683: Database Error in model actions_hierarchy (models/actions/actions_hierarchy.sql)
2018-03-07 17:36:53,684:   No matching signature for operator CASE for argument types: BOOL, STRING, BOOL, STRING, BOOL, INT64, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, BOOL, STRING, STRING at [21:1]
2018-03-07 17:36:53,684:   compiled SQL at target/compiled/seo_audit/actions/actions_hierarchy.sql
2018-03-07 17:36:53,684: 
Done. PASS=44 ERROR=1 SKIP=1 TOTAL=46
2018-03-07 17:36:53,685: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c6052e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59f828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c59f6d8>]}
2018-03-07 17:36:54,079: Flushing usage events
2018-03-07 17:40:33,178: Tracking: tracking
2018-03-07 17:40:33,180: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b057ba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b057860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b057828>]}
2018-03-07 17:40:34,068: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-03-07 17:40:34,085: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-03-07 17:40:34,090: Parsing core.sql
2018-03-07 17:40:34,109: Parsing adapters/bigquery.sql
2018-03-07 17:40:34,117: Parsing adapters/common.sql
2018-03-07 17:40:34,135: Parsing adapters/postgres.sql
2018-03-07 17:40:34,141: Parsing adapters/redshift.sql
2018-03-07 17:40:34,168: Parsing etc/get_custom_schema.sql
2018-03-07 17:40:34,177: Parsing materializations/archive.sql
2018-03-07 17:40:34,215: Parsing materializations/bigquery.sql
2018-03-07 17:40:34,240: Parsing materializations/helpers.sql
2018-03-07 17:40:34,259: Parsing materializations/incremental.sql
2018-03-07 17:40:34,290: Parsing materializations/table.sql
2018-03-07 17:40:34,311: Parsing materializations/view.sql
2018-03-07 17:40:34,329: Parsing materializations/wrapper.sql
2018-03-07 17:40:34,335: Parsing schema_tests/accepted_values.sql
2018-03-07 17:40:34,341: Parsing schema_tests/not_null.sql
2018-03-07 17:40:34,345: Parsing schema_tests/relationships.sql
2018-03-07 17:40:34,351: Parsing schema_tests/unique.sql
2018-03-07 17:40:34,393: Parsing model.seo_audit.actions_data_studio
2018-03-07 17:40:34,395: Acquiring new bigquery connection "master".
2018-03-07 17:40:34,395: Opening a new connection (0 currently allocated)
2018-03-07 17:40:34,402: Parsing model.seo_audit.actions_hierarchy
2018-03-07 17:40:34,408: Parsing model.seo_audit.actions_proc
2018-03-07 17:40:34,414: Parsing model.seo_audit.accounts_proc
2018-03-07 17:40:34,417: Parsing model.seo_audit.all_dates
2018-03-07 17:40:34,418: Parsing model.seo_audit.dates
2018-03-07 17:40:34,421: Parsing model.seo_audit.mappings_ga_proc
2018-03-07 17:40:34,425: Parsing model.seo_audit.agg_all
2018-03-07 17:40:34,429: Parsing model.seo_audit.agg_indicative
2018-03-07 17:40:34,432: Parsing model.seo_audit.agg_stats
2018-03-07 17:40:34,437: Parsing model.seo_audit.agg_stats_client
2018-03-07 17:40:34,441: Parsing model.seo_audit.deepcrawl_class
2018-03-07 17:40:34,443: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:40:34,445: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:40:34,447: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:40:34,448: Parsing model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:40:34,451: Parsing model.seo_audit.deepcrawl_proc
2018-03-07 17:40:34,454: Parsing model.seo_audit.deepcrawl_reclass
2018-03-07 17:40:34,457: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:40:34,465: Parsing model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:40:34,467: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:40:34,469: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:40:34,471: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:40:34,473: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:40:34,475: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:40:34,476: Parsing model.seo_audit.deepcrawl_url_proc
2018-03-07 17:40:34,480: Parsing model.seo_audit.deepcrawl_urls
2018-03-07 17:40:34,482: Parsing model.seo_audit.ga_proc
2018-03-07 17:40:34,487: Parsing model.seo_audit.ga_proc_pageviews
2018-03-07 17:40:34,491: Parsing model.seo_audit.ga_stats
2018-03-07 17:40:34,494: Parsing model.seo_audit.majestic_domain_history
2018-03-07 17:40:34,496: Parsing model.seo_audit.majestic_domain_proc
2018-03-07 17:40:34,499: Parsing model.seo_audit.majestic_domain_stats
2018-03-07 17:40:34,501: Parsing model.seo_audit.moz_proc
2018-03-07 17:40:34,504: Parsing model.seo_audit.screamingfrog_proc
2018-03-07 17:40:34,507: Parsing model.seo_audit.search_console_history
2018-03-07 17:40:34,510: Parsing model.seo_audit.search_console_proc
2018-03-07 17:40:34,512: Parsing model.seo_audit.search_console_stats_keyword
2018-03-07 17:40:34,515: Parsing model.seo_audit.search_console_stats_url
2018-03-07 17:40:34,517: Parsing model.seo_audit.semrush_domain_proc
2018-03-07 17:40:34,520: Parsing model.seo_audit.semrush_keyword_history
2018-03-07 17:40:34,523: Parsing model.seo_audit.semrush_keyword_proc
2018-03-07 17:40:34,528: Parsing model.seo_audit.semrush_keyword_stats
2018-03-07 17:40:34,533: Parsing model.seo_audit.semrush_url_history
2018-03-07 17:40:34,537: Parsing model.seo_audit.semrush_url_stats
2018-03-07 17:40:34,544: Parsing model.seo_audit.sitemap_proc
2018-03-07 17:40:34,560: Found 46 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-03-07 17:40:34,575: 
2018-03-07 17:40:36,684: 17:40:36 | Concurrency: 4 threads (target='prod')
2018-03-07 17:40:36,685: 17:40:36 | 
2018-03-07 17:40:37,213: 17:40:37 | 1 of 46 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-03-07 17:40:37,214: Compiling model.seo_audit.deepcrawl_proc
2018-03-07 17:40:37,213: 17:40:37 | 2 of 46 START table model seo_audit.all_dates........................ [RUN]
2018-03-07 17:40:37,219: Compiling model.seo_audit.all_dates
2018-03-07 17:40:37,224: Writing injected SQL for node "model.seo_audit.all_dates"
2018-03-07 17:40:37,213: 17:40:37 | 3 of 46 START table model seo_audit.accounts_proc.................... [RUN]
2018-03-07 17:40:37,224: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-03-07 17:40:37,225: Compiling model.seo_audit.accounts_proc
2018-03-07 17:40:37,232: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-03-07 17:40:37,232: Acquiring new bigquery connection "all_dates".
2018-03-07 17:40:37,233: Opening a new connection (1 currently allocated)
2018-03-07 17:40:37,234: Acquiring new bigquery connection "deepcrawl_proc".
2018-03-07 17:40:37,234: Acquiring new bigquery connection "accounts_proc".
2018-03-07 17:40:37,236: Opening a new connection (2 currently allocated)
2018-03-07 17:40:37,334: Opening a new connection (3 currently allocated)
2018-03-07 17:40:38,769: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-03-07 17:40:38,920: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-03-07 17:40:38,921: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  case when url like '%?%' then 1 else 0 end as url_query_string_flag,
  case when canonical_url like '%?%' and canonical_url is not null then 1 else 0 end as canonical_query_string_flag,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-03-07 17:40:39,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b267da0>]}
2018-03-07 17:40:40,084: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:40:40,452: 17:40:40 | 2 of 46 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.77s]
2018-03-07 17:40:40,963: 17:40:40 | 3 of 46 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.86s]
2018-03-07 17:40:41,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b248f28>]}
2018-03-07 17:40:41,613: 17:40:41 | 1 of 46 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 4.04s]
2018-03-07 17:40:41,614: 17:40:41 | 4 of 46 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-03-07 17:40:41,614: 17:40:41 | 5 of 46 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-03-07 17:40:41,615: Compiling model.seo_audit.semrush_domain_proc
2018-03-07 17:40:41,614: 17:40:41 | 6 of 46 START table model seo_audit.moz_proc......................... [RUN]
2018-03-07 17:40:41,615: Compiling model.seo_audit.semrush_keyword_proc
2018-03-07 17:40:41,614: 17:40:41 | 7 of 46 START table model seo_audit.search_console_proc.............. [RUN]
2018-03-07 17:40:41,621: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-03-07 17:40:41,621: Compiling model.seo_audit.moz_proc
2018-03-07 17:40:41,628: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-03-07 17:40:41,628: Compiling model.seo_audit.search_console_proc
2018-03-07 17:40:41,634: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-03-07 17:40:41,641: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-03-07 17:40:41,642: Acquiring new bigquery connection "semrush_keyword_proc".
2018-03-07 17:40:41,643: Acquiring new bigquery connection "semrush_domain_proc".
2018-03-07 17:40:41,645: Acquiring new bigquery connection "search_console_proc".
2018-03-07 17:40:41,643: Re-using an available connection from the pool.
2018-03-07 17:40:41,645: Re-using an available connection from the pool.
2018-03-07 17:40:41,652: Re-using an available connection from the pool.
2018-03-07 17:40:41,660: Acquiring new bigquery connection "moz_proc".
2018-03-07 17:40:41,660: Opening a new connection (4 currently allocated)
2018-03-07 17:40:42,490: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:40:42,678: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
and keyword not in ('cifl', 'losers', 'coding is for losers')
group by date, unix_date, account, platform, url, keyword
2018-03-07 17:40:42,796: Model SQL (search_console_proc):
select 
date,
unix_date,
a.account,
b.client,
a.platform,
url,
keyword,
impressions,
clicks,
position
FROM (

	SELECT  
	date, 
	unix_date(date) as unix_date,
	site as account,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	keyword,
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	min(position) as position
	FROM `curious-domain-121318.seo_audit.gsc` 
	group by date, unix_date, account, platform, url, keyword
	) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON (
	a.platform = b.platform and
	a.account = b.account
)
2018-03-07 17:40:43,230: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-03-07 17:40:43,679: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b18ca20>]}
2018-03-07 17:40:44,064: 17:40:44 | 4 of 46 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.06s]
2018-03-07 17:40:44,065: 17:40:44 | 8 of 46 START table model seo_audit.sitemap_proc..................... [RUN]
2018-03-07 17:40:44,065: Compiling model.seo_audit.sitemap_proc
2018-03-07 17:40:44,074: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-03-07 17:40:44,075: Acquiring new bigquery connection "sitemap_proc".
2018-03-07 17:40:44,075: Re-using an available connection from the pool.
2018-03-07 17:40:44,948: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-03-07 17:40:45,000: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b267550>]}
2018-03-07 17:40:45,720: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b267128>]}
2018-03-07 17:40:45,896: 17:40:45 | 5 of 46 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.39s]
2018-03-07 17:40:45,897: 17:40:45 | 9 of 46 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-03-07 17:40:45,897: Compiling model.seo_audit.majestic_domain_proc
2018-03-07 17:40:45,909: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-03-07 17:40:45,912: Acquiring new bigquery connection "majestic_domain_proc".
2018-03-07 17:40:45,912: Re-using an available connection from the pool.
2018-03-07 17:40:46,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:40:46,317: 17:40:46 | 6 of 46 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 4.10s]
2018-03-07 17:40:46,318: 17:40:46 | 10 of 46 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-03-07 17:40:46,323: Compiling model.seo_audit.screamingfrog_proc
2018-03-07 17:40:46,337: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-03-07 17:40:46,339: Acquiring new bigquery connection "screamingfrog_proc".
2018-03-07 17:40:46,339: Re-using an available connection from the pool.
2018-03-07 17:40:46,756: 17:40:46 | 7 of 46 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.60s]
2018-03-07 17:40:46,757: 17:40:46 | 11 of 46 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-03-07 17:40:46,757: Compiling model.seo_audit.mappings_ga_proc
2018-03-07 17:40:46,767: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-03-07 17:40:46,770: Acquiring new bigquery connection "mappings_ga_proc".
2018-03-07 17:40:46,770: Re-using an available connection from the pool.
2018-03-07 17:40:46,836: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-03-07 17:40:47,205: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-03-07 17:40:47,281: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b18ca20>]}
2018-03-07 17:40:47,579: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-03-07 17:40:47,664: 17:40:47 | 8 of 46 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.22s]
2018-03-07 17:40:49,132: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b124b38>]}
2018-03-07 17:40:49,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149160>]}
2018-03-07 17:40:49,526: 17:40:49 | 9 of 46 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.23s]
2018-03-07 17:40:49,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:40:49,915: 17:40:49 | 10 of 46 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 3.19s]
2018-03-07 17:40:50,355: 17:40:50 | 11 of 46 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.13s]
2018-03-07 17:40:50,356: 17:40:50 | 12 of 46 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-03-07 17:40:50,357: Compiling model.seo_audit.semrush_keyword_history
2018-03-07 17:40:50,357: 17:40:50 | 13 of 46 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-03-07 17:40:50,372: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-03-07 17:40:50,372: Compiling model.seo_audit.deepcrawl_url_proc
2018-03-07 17:40:50,357: 17:40:50 | 14 of 46 START table model seo_audit.majestic_domain_history......... [RUN]
2018-03-07 17:40:50,386: Compiling model.seo_audit.majestic_domain_history
2018-03-07 17:40:50,373: 17:40:50 | 15 of 46 START table model seo_audit.semrush_url_history............. [RUN]
2018-03-07 17:40:50,394: Compiling model.seo_audit.semrush_url_history
2018-03-07 17:40:50,386: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-03-07 17:40:50,406: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-03-07 17:40:50,408: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-03-07 17:40:50,380: Acquiring new bigquery connection "semrush_keyword_history".
2018-03-07 17:40:50,409: Re-using an available connection from the pool.
2018-03-07 17:40:50,414: Acquiring new bigquery connection "majestic_domain_history".
2018-03-07 17:40:50,415: Re-using an available connection from the pool.
2018-03-07 17:40:50,416: Acquiring new bigquery connection "semrush_url_history".
2018-03-07 17:40:50,418: Re-using an available connection from the pool.
2018-03-07 17:40:50,420: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-03-07 17:40:50,420: Re-using an available connection from the pool.
2018-03-07 17:40:51,251: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-03-07 17:40:51,330: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-03-07 17:40:51,331: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-03-07 17:40:51,334: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
canonical_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
url_query_string_flag,
canonical_query_string_flag,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_path, '') second_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
case when trim(replace(url, last_path, ''),'/') = domain then domain else concat(domain,'/',first_path) end as first_subfolder,
case when trim(replace(url, last_path, ''),'/') = domain then domain 
  when second_path is not null then concat(domain,'/',first_path,'/',second_path) 
  else '' end as second_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
lower(page_title) page_title,
page_title_length,
lower(description) description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores|login|signup') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  case when url = canonical_url then url else url_stripped end as url,
  length(canonical_url) canonical_url_length,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  SPLIT(url, '/')[SAFE_ORDINAL(3)] second_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  url_query_string_flag,
  canonical_query_string_flag,
  case when url = canonical_url then 'self'
    when canonical_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url missing query string)'
    when url_query_string_flag = 1 and url_stripped = canonical_url_stripped then 'self (url extra query string)'
    when canonical_url = '' or canonical_url is null then 'missing_canonical'
    else 'canonicalized' end as canonical_status,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  links_in_count,
  links_out_count,
  external_links_count,
  internal_links_count,
  h1_tag,
  h2_tag,
  redirect_chain,
  redirected_to_status_code,
  is_redirect_loop,
  duplicate_page,
  duplicate_page_count,
  duplicate_body,
  duplicate_body_count,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-03-07 17:40:53,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5a7a90>]}
2018-03-07 17:40:53,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149160>]}
2018-03-07 17:40:53,925: 17:40:53 | 12 of 46 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.18s]
2018-03-07 17:40:54,301: 17:40:54 | 14 of 46 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.26s]
2018-03-07 17:40:54,769: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b124b38>]}
2018-03-07 17:40:54,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b197d30>]}
2018-03-07 17:40:55,151: 17:40:55 | 13 of 46 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 4.40s]
2018-03-07 17:40:55,562: 17:40:55 | 15 of 46 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.39s]
2018-03-07 17:40:55,563: 17:40:55 | 16 of 46 START table model seo_audit.deepcrawl_class................. [RUN]
2018-03-07 17:40:55,563: Compiling model.seo_audit.deepcrawl_class
2018-03-07 17:40:55,574: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-03-07 17:40:55,575: Acquiring new bigquery connection "deepcrawl_class".
2018-03-07 17:40:55,576: Re-using an available connection from the pool.
2018-03-07 17:40:56,452: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
canonical_url_length,
longest_url_length,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
second_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when url = domain then 'homepage'
	when url like '%404%' then '404'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when class_sitemap in ('article', 'product') then class_sitemap
	when class_sitemap = 'category' and flag_prices = 0 then 'blog_category'
	when class_sitemap = 'category' and flag_prices = 1 then 'product_category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_paginated = 1 then 'blog_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1 then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	canonical_url_length,
	first_value(canonical_url_length) over (partition by url_stripped order by canonical_url_length desc) longest_url_length,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	second_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
  	links_in_count,
  	links_out_count,
  	external_links_count,
  	internal_links_count,	
	h1_tag,
	h2_tag,
	redirect_chain,
	redirected_to_status_code,
	is_redirect_loop,
	duplicate_page,
	duplicate_page_count,
	duplicate_body,
	duplicate_body_count,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
) 
where ( canonical_url_length = longest_url_length or longest_url_length is null )
2018-03-07 17:40:57,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:40:58,087: 17:40:58 | 16 of 46 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.06s]
2018-03-07 17:40:58,087: 17:40:58 | 17 of 46 START table model seo_audit.semrush_url_stats............... [RUN]
2018-03-07 17:40:58,088: Compiling model.seo_audit.semrush_url_stats
2018-03-07 17:40:58,087: 17:40:58 | 18 of 46 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-03-07 17:40:58,094: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-03-07 17:40:58,088: 17:40:58 | 19 of 46 START table model seo_audit.deepcrawl_urls.................. [RUN]
2018-03-07 17:40:58,094: Compiling model.seo_audit.deepcrawl_classification_stats
2018-03-07 17:40:58,088: 17:40:58 | 20 of 46 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-03-07 17:40:58,106: Compiling model.seo_audit.semrush_keyword_stats
2018-03-07 17:40:58,101: Acquiring new bigquery connection "semrush_url_stats".
2018-03-07 17:40:58,105: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-03-07 17:40:58,094: Compiling model.seo_audit.deepcrawl_urls
2018-03-07 17:40:58,118: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-03-07 17:40:58,118: Re-using an available connection from the pool.
2018-03-07 17:40:58,120: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-03-07 17:40:58,139: Re-using an available connection from the pool.
2018-03-07 17:40:58,134: Writing injected SQL for node "model.seo_audit.deepcrawl_urls"
2018-03-07 17:40:58,143: Acquiring new bigquery connection "deepcrawl_urls".
2018-03-07 17:40:58,148: Re-using an available connection from the pool.
2018-03-07 17:40:58,135: Acquiring new bigquery connection "semrush_keyword_stats".
2018-03-07 17:40:58,153: Re-using an available connection from the pool.
2018-03-07 17:40:58,972: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-03-07 17:40:58,986: Model SQL (deepcrawl_urls):
SELECT 
url,
http_status_code
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class`
2018-03-07 17:40:59,032: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-03-07 17:40:59,271: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:41:00,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149160>]}
2018-03-07 17:41:00,500: 17:41:00 | 19 of 46 OK created table model seo_audit.deepcrawl_urls............. [CREATE TABLE in 2.04s]
2018-03-07 17:41:00,500: 17:41:00 | 21 of 46 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-03-07 17:41:00,501: Compiling model.seo_audit.majestic_domain_stats
2018-03-07 17:41:00,506: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-03-07 17:41:00,507: Acquiring new bigquery connection "majestic_domain_stats".
2018-03-07 17:41:00,507: Re-using an available connection from the pool.
2018-03-07 17:41:01,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1ea5c0>]}
2018-03-07 17:41:01,340: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-03-07 17:41:01,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b279550>]}
2018-03-07 17:41:01,614: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b197d30>]}
2018-03-07 17:41:01,692: 17:41:01 | 18 of 46 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.20s]
2018-03-07 17:41:02,067: 17:41:02 | 20 of 46 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.25s]
2018-03-07 17:41:02,440: 17:41:02 | 17 of 46 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.53s]
2018-03-07 17:41:03,694: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149160>]}
2018-03-07 17:41:04,088: 17:41:04 | 21 of 46 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.19s]
2018-03-07 17:41:04,089: 17:41:04 | 22 of 46 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-03-07 17:41:04,090: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-03-07 17:41:04,090: 17:41:04 | 23 of 46 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-03-07 17:41:04,098: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-03-07 17:41:04,090: 17:41:04 | 24 of 46 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-03-07 17:41:04,098: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-03-07 17:41:04,090: 17:41:04 | 25 of 46 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-03-07 17:41:04,098: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-03-07 17:41:04,103: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-03-07 17:41:04,103: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-03-07 17:41:04,104: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-03-07 17:41:04,118: Re-using an available connection from the pool.
2018-03-07 17:41:04,111: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-03-07 17:41:04,128: Re-using an available connection from the pool.
2018-03-07 17:41:04,128: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-03-07 17:41:04,112: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-03-07 17:41:04,138: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-03-07 17:41:04,142: Re-using an available connection from the pool.
2018-03-07 17:41:04,142: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-03-07 17:41:04,143: Re-using an available connection from the pool.
2018-03-07 17:41:05,033: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-03-07 17:41:05,110: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-03-07 17:41:05,119: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-03-07 17:41:05,287: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:41:06,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1ea5c0>]}
2018-03-07 17:41:06,260: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:06,574: 17:41:06 | 24 of 46 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.10s]
2018-03-07 17:41:06,575: 17:41:06 | 26 of 46 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-03-07 17:41:06,577: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-03-07 17:41:06,589: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-03-07 17:41:06,592: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-03-07 17:41:06,592: Re-using an available connection from the pool.
2018-03-07 17:41:07,038: 17:41:07 | 22 of 46 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.17s]
2018-03-07 17:41:07,040: 17:41:07 | 27 of 46 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-03-07 17:41:07,041: Compiling model.seo_audit.deepcrawl_rules_filename
2018-03-07 17:41:07,053: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-03-07 17:41:07,054: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-03-07 17:41:07,054: Re-using an available connection from the pool.
2018-03-07 17:41:07,938: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:41:08,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1f6d68>]}
2018-03-07 17:41:08,750: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-03-07 17:41:08,816: 17:41:08 | 25 of 46 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 4.29s]
2018-03-07 17:41:09,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cff748>]}
2018-03-07 17:41:09,455: 17:41:09 | 26 of 46 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.50s]
2018-03-07 17:41:09,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b137cc0>]}
2018-03-07 17:41:09,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:09,974: 17:41:09 | 23 of 46 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 5.46s]
2018-03-07 17:41:10,370: 17:41:10 | 27 of 46 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.86s]
2018-03-07 17:41:10,371: 17:41:10 | 28 of 46 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-03-07 17:41:10,371: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-03-07 17:41:10,371: 17:41:10 | 29 of 46 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-03-07 17:41:10,371: 17:41:10 | 30 of 46 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-03-07 17:41:10,382: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-03-07 17:41:10,381: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-03-07 17:41:10,381: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-03-07 17:41:10,392: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-03-07 17:41:10,399: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-03-07 17:41:10,399: Re-using an available connection from the pool.
2018-03-07 17:41:10,404: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-03-07 17:41:10,404: Re-using an available connection from the pool.
2018-03-07 17:41:10,416: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-03-07 17:41:10,418: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-03-07 17:41:10,419: Re-using an available connection from the pool.
2018-03-07 17:41:11,210: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-03-07 17:41:11,232: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-03-07 17:41:11,309: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-03-07 17:41:12,385: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149160>]}
2018-03-07 17:41:12,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b229588>]}
2018-03-07 17:41:12,781: 17:41:12 | 28 of 46 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.01s]
2018-03-07 17:41:13,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b240390>]}
2018-03-07 17:41:13,626: 17:41:13 | 29 of 46 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.08s]
2018-03-07 17:41:14,043: 17:41:14 | 30 of 46 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 3.18s]
2018-03-07 17:41:14,044: 17:41:14 | 31 of 46 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-03-07 17:41:14,044: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-03-07 17:41:14,064: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-03-07 17:41:14,065: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-03-07 17:41:14,065: Re-using an available connection from the pool.
2018-03-07 17:41:15,160: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
a.url url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
a.last_subfolder last_subfolder,
m.http_status_code last_subfolder_http_status,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
a.http_status_code http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
a.first_path first_path,
a.first_subfolder first_subfolder,
k.http_status_code first_subfolder_http_status,
a.second_subfolder second_subfolder,
l.http_status_code second_subfolder_http_status,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` k
ON (  a.first_subfolder = k.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` l
ON (  a.second_subfolder = l.url )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_urls` m
ON (  a.last_subfolder = m.url )
2018-03-07 17:41:18,691: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:19,125: 17:41:19 | 31 of 46 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.65s]
2018-03-07 17:41:19,126: 17:41:19 | 32 of 46 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-03-07 17:41:19,126: Compiling model.seo_audit.deepcrawl_reclass
2018-03-07 17:41:19,135: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-03-07 17:41:19,137: Acquiring new bigquery connection "deepcrawl_reclass".
2018-03-07 17:41:19,137: Re-using an available connection from the pool.
2018-03-07 17:41:20,019: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
last_subfolder_http_status,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-03-07 17:41:21,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b229588>]}
2018-03-07 17:41:21,656: 17:41:21 | 32 of 46 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.13s]
2018-03-07 17:41:21,656: 17:41:21 | 33 of 46 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-03-07 17:41:21,657: Compiling model.seo_audit.ga_proc_pageviews
2018-03-07 17:41:21,666: 17:41:21 | 34 of 46 START table model seo_audit.ga_proc......................... [RUN]
2018-03-07 17:41:21,667: Compiling model.seo_audit.ga_proc
2018-03-07 17:41:21,681: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-03-07 17:41:21,683: Acquiring new bigquery connection "ga_proc_pageviews".
2018-03-07 17:41:21,683: Re-using an available connection from the pool.
2018-03-07 17:41:21,695: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-03-07 17:41:21,697: Acquiring new bigquery connection "ga_proc".
2018-03-07 17:41:21,697: Re-using an available connection from the pool.
2018-03-07 17:41:22,609: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where hostname in ( select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
and path != "(not set)"
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, c.client, a.account, a.platform, url
2018-03-07 17:41:22,609: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
c.client,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 

	SELECT 
	date,
	unix_date,
	account,
	platform,
	lower(trim(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),'/')) url,
	lower(trim(regexp_replace(replace(replace(replace(CONCAT(sessions_hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) url_stripped,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions
	FROM (
		SELECT 
		date,
		unix_date(date) unix_date,
		account,
		'Google Analytics' as platform,
		hostname,
		first_value(hostname) OVER (PARTITION BY path ORDER BY max(sessions) desc) sessions_hostname,
		path,
		source,
		medium,
		max(sessions) sessions,
		max(leads) leads,
		max(transactions) transactions
		FROM `curious-domain-121318.seo_audit.ga` 
		where hostname in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Deepcrawl')
		and path != "(not set)"
		and medium = 'organic'
		group by date, account, platform, source, medium, hostname, path
		)
	group by date, unix_date, account, platform, url, url_stripped
) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` c
ON (
	a.platform = c.platform and
	a.account = c.account
)
GROUP BY 
date, unix_date, account, client, platform, url
2018-03-07 17:41:24,970: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d59b198>]}
2018-03-07 17:41:25,360: 17:41:25 | 34 of 46 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.30s]
2018-03-07 17:41:26,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:26,525: 17:41:26 | 33 of 46 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.49s]
2018-03-07 17:41:26,526: 17:41:26 | 35 of 46 START table model seo_audit.agg_indicative.................. [RUN]
2018-03-07 17:41:26,526: Compiling model.seo_audit.agg_indicative
2018-03-07 17:41:26,537: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-03-07 17:41:26,541: Acquiring new bigquery connection "agg_indicative".
2018-03-07 17:41:26,541: Re-using an available connection from the pool.
2018-03-07 17:41:27,651: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
case when dc.canonical_url like '%?%' then coalesce(dc.url, s.url) else coalesce(dc.url_stripped, s.url) end as url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(first_subfolder_http_status) first_subfolder_http_status,
max(second_subfolder) second_subfolder,
max(second_subfolder_http_status) second_subfolder_http_status,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(last_subfolder_http_status) last_subfolder_http_status,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(links_in_count) links_in_count,
max(links_out_count) links_out_count,
max(external_links_count) external_links_count,
max(internal_links_count) internal_links_count,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(redirect_chain) redirect_chain,
max(redirected_to_status_code) redirected_to_status_code,
max(is_redirect_loop) is_redirect_loop,
max(duplicate_page) duplicate_page,
max(duplicate_page_count) duplicate_page_count,
max(duplicate_body) duplicate_body,
max(duplicate_body_count) duplicate_body_count,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-03-07 17:41:29,980: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b229588>]}
2018-03-07 17:41:30,351: 17:41:30 | 35 of 46 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.45s]
2018-03-07 17:41:30,352: 17:41:30 | 36 of 46 START table model seo_audit.dates........................... [RUN]
2018-03-07 17:41:30,353: Compiling model.seo_audit.dates
2018-03-07 17:41:30,363: Writing injected SQL for node "model.seo_audit.dates"
2018-03-07 17:41:30,366: Acquiring new bigquery connection "dates".
2018-03-07 17:41:30,366: Re-using an available connection from the pool.
2018-03-07 17:41:31,209: Model SQL (dates):
with ga as (
	select
	account,
	client,
	platform,
	date,
	count(url) ga_count,
	null as ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc` 
	group by account, client, platform, date
),

ga_pageviews as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	count(url) ga_pageviews_count,
	null as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews` 
	group by account, client, platform, date
),

gsc as (
	select
	account,
	client,
	platform,
	date,
	null as ga_count,
	null as ga_pageviews_count,
	count(url) as gsc_count
	FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` 
	group by account, client, platform, date
)


select
client,
max(date) run_date,
unix_date(max(date)) unix_run_date
from (
  select 
  client,
  date,
  sum(ga_count) ga_count,
  sum(ga_pageviews_count) ga_pageviews_count,
  sum(gsc_count) gsc_count
  from (
    select * from ga
    union all
    select * from ga_pageviews
    union all
    select * from gsc
    )
  group by client, date )
where ga_count > 0
and ga_pageviews_count > 0
and gsc_count > 0 
group by client
2018-03-07 17:41:33,529: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:33,912: 17:41:33 | 36 of 46 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.18s]
2018-03-07 17:41:33,913: 17:41:33 | 37 of 46 START table model seo_audit.ga_stats........................ [RUN]
2018-03-07 17:41:33,913: 17:41:33 | 38 of 46 START table model seo_audit.search_console_history.......... [RUN]
2018-03-07 17:41:33,913: Compiling model.seo_audit.ga_stats
2018-03-07 17:41:33,914: Compiling model.seo_audit.search_console_history
2018-03-07 17:41:33,931: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-03-07 17:41:33,934: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-03-07 17:41:33,935: Acquiring new bigquery connection "search_console_history".
2018-03-07 17:41:33,935: Re-using an available connection from the pool.
2018-03-07 17:41:33,936: Acquiring new bigquery connection "ga_stats".
2018-03-07 17:41:33,936: Re-using an available connection from the pool.
2018-03-07 17:41:34,920: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, client, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
run_date,
account,
client,
platform,
url,
sum(case when unix_date >= ( unix_run_date - 30) and unix_date <= unix_run_date then sessions else 0 end ) as sessions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then leads else 0 end ) as leads_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then transactions else 0 end ) as transactions_30d,
sum(case when unix_date >= unix_run_date - 30 and unix_date <= unix_run_date then pageviews else 0 end ) as pageviews_30d,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then sessions else 0 end ) as sessions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then leads else 0 end ) as leads_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then transactions else 0 end ) as transactions_mom,
sum(case when unix_date >= (unix_run_date - 60) and unix_date < (unix_run_date - 30) then pageviews else 0 end ) as pageviews_mom,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then sessions else 0 end ) as sessions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then leads else 0 end ) as leads_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then transactions else 0 end ) as transactions_yoy,
sum(case when unix_date >= (unix_run_date - 395) and unix_date < (unix_run_date - 365) then pageviews else 0 end ) as pageviews_yoy
FROM (

	select 
	a.date date,
    b.run_date run_date,
	unix_date,
	b.unix_run_date unix_run_date,
	a.account,
	a.client,
	a.platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	) a
	LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
	ON (
		a.client = b.client
		)
	group by date, run_date, unix_date, unix_run_date, account, client, platform, url

)
group by run_date, account, client, platform, url
2018-03-07 17:41:34,922: Model SQL (search_console_history):
SELECT  
b.run_date run_date,
b.unix_run_date unix_run_date,
account,
a.client,
platform,
url,
keyword,
sum(impressions) as impressions_90d,
sum(clicks) as clicks_90d,
sum(clicks)/sum(impressions) as ctr_90d,
sum(impressions * position)/sum(impressions) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`dates` b
ON (
	a.client = b.client
)
WHERE a.unix_date >= ( b.unix_run_date - 90 ) 
AND a.unix_date <= b.unix_run_date
group by run_date, unix_run_date, account, client, platform, url, keyword
2018-03-07 17:41:38,011: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b229588>]}
2018-03-07 17:41:38,016: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b248160>]}
2018-03-07 17:41:41,115: 17:41:41 | 37 of 46 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 4.10s]
2018-03-07 17:41:43,199: 17:41:43 | 38 of 46 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.10s]
2018-03-07 17:41:43,200: 17:41:43 | 39 of 46 START table model seo_audit.search_console_stats_url........ [RUN]
2018-03-07 17:41:43,200: Compiling model.seo_audit.search_console_stats_url
2018-03-07 17:41:43,200: 17:41:43 | 40 of 46 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-03-07 17:41:43,209: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-03-07 17:41:43,209: Compiling model.seo_audit.search_console_stats_keyword
2018-03-07 17:41:43,221: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-03-07 17:41:43,222: Acquiring new bigquery connection "search_console_stats_url".
2018-03-07 17:41:43,222: Re-using an available connection from the pool.
2018-03-07 17:41:43,226: Acquiring new bigquery connection "search_console_stats_keyword".
2018-03-07 17:41:43,228: Re-using an available connection from the pool.
2018-03-07 17:41:45,637: Model SQL (search_console_stats_keyword):
SELECT
run_date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
first_value(max(impressions)) OVER w2 as gsc_top_url_impressions_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
run_date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url ORDER BY impressions_90d desc)

)

GROUP BY run_date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword ORDER BY max(impressions) desc)
2018-03-07 17:41:45,686: Model SQL (search_console_stats_url):
SELECT 
run_date,
account,
client,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY run_date, account, client, platform, url
2018-03-07 17:41:47,886: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5b9710>]}
2018-03-07 17:41:47,982: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:48,264: 17:41:48 | 40 of 46 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 4.68s]
2018-03-07 17:41:48,683: 17:41:48 | 39 of 46 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 4.78s]
2018-03-07 17:41:48,684: 17:41:48 | 41 of 46 START table model seo_audit.agg_stats....................... [RUN]
2018-03-07 17:41:48,685: Compiling model.seo_audit.agg_stats
2018-03-07 17:41:48,703: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-03-07 17:41:48,705: Acquiring new bigquery connection "agg_stats".
2018-03-07 17:41:48,705: Re-using an available connection from the pool.
2018-03-07 17:41:50,010: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
run_date date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
null as gsc_top_url_impressions_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-03-07 17:41:51,186: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ce5dd8>]}
2018-03-07 17:41:51,941: 17:41:51 | 41 of 46 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.50s]
2018-03-07 17:41:51,942: 17:41:51 | 42 of 46 START table model seo_audit.agg_stats_client................ [RUN]
2018-03-07 17:41:51,942: Compiling model.seo_audit.agg_stats_client
2018-03-07 17:41:51,948: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-03-07 17:41:51,950: Acquiring new bigquery connection "agg_stats_client".
2018-03-07 17:41:51,950: Re-using an available connection from the pool.
2018-03-07 17:41:53,290: Model SQL (agg_stats_client):
SELECT 
a.date date, 
case when c.canonical_url like '%?%' then a.url else trim(regexp_replace(a.url,r'\?.*$',''),'/') end as url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(gsc_top_url_impressions_for_keyword_90d) as gsc_top_url_impressions_for_keyword_90d,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` c
ON (
	a.url = c.url
	)
GROUP BY date, client, url
2018-03-07 17:41:55,578: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:41:55,957: 17:41:55 | 42 of 46 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 3.64s]
2018-03-07 17:41:55,958: 17:41:55 | 43 of 46 START table model seo_audit.agg_all......................... [RUN]
2018-03-07 17:41:55,958: Compiling model.seo_audit.agg_all
2018-03-07 17:41:55,970: Writing injected SQL for node "model.seo_audit.agg_all"
2018-03-07 17:41:55,971: Acquiring new bigquery connection "agg_all".
2018-03-07 17:41:55,971: Re-using an available connection from the pool.
2018-03-07 17:41:56,852: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
case when page_type in ('info') then 'pageviews'
	when page_type in ('homepage', 'lead_generation', 'article', 'blog_category') then 'leads'
	when page_type like 'product%' then 'sales'
	else 'traffic' end as page_objective,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
second_subfolder,
second_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY second_subfolder) second_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY second_subfolder) second_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_http_status,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 
	when ( gsc_top_keyword_90d is not null or gsc_top_keyword_90d != '' ) then 0 else 2 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
flag_paginated,
case when regexp_contains(coalesce(a.url, b.url), r'\d') then 1 else 0 end as url_contains_digit,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
case when sessions_30d > 0 then leads_30d/sessions_30d else null end as lead_conversion_rate_30d,
case when sessions_30d > 0 then transactions_30d/sessions_30d else null end as transaction_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then leads_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_lead_conversion_rate_30d,
PERCENTILE_DISC(case when sessions_30d > 0 then transactions_30d/sessions_30d else null end, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
PERCENTILE_DISC(ref_domain_count, 0.5 IGNORE NULLS) OVER (PARTITION BY http_status_code) AS med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_url_impressions_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-03-07 17:41:59,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b149048>]}
2018-03-07 17:41:59,605: 17:41:59 | 43 of 46 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 3.26s]
2018-03-07 17:41:59,606: 17:41:59 | 44 of 46 START table model seo_audit.actions_proc.................... [RUN]
2018-03-07 17:41:59,606: Compiling model.seo_audit.actions_proc
2018-03-07 17:41:59,621: Writing injected SQL for node "model.seo_audit.actions_proc"
2018-03-07 17:41:59,624: Acquiring new bigquery connection "actions_proc".
2018-03-07 17:41:59,624: Re-using an available connection from the pool.
2018-03-07 17:42:00,709: Model SQL (actions_proc):
SELECT
a.date date,
c.run_date run_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
page_objective,

#indicative actions roll up to each other, nested one by one

case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,

case when page_type is null then 'missing from crawl' else '' end as crawl_action,

case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,

case 
	when ( robots_noindex = true or http_status_code in (404, 302, 301) ) and sitemap is not null then concat('remove from sitemap: ', sitemap) 
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	when ( robots_noindex = false or robots_noindex is null ) and sitemap is null and a.url not like '%/page/%' then 'add to sitemap'
	else '' end as sitemap_action,

case 
	when a.gsc_top_url_for_keyword_90d != a.url and a.gsc_top_keyword_90d != '' and a.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url and a.gsc_top_keyword_90d != '' and b.gsc_top_url_impressions_for_keyword_90d > 500 then concat('canonicalize to: ', b.gsc_top_url_for_keyword_90d)
	when canonical_status = 'missing_canonical' then 'missing canonical'
	when canonical_status = 'canonicalized' then 'canonicalized, leave as is'
	else '' end as canonical_action,		

case
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 and first_subfolder_http_status = 200 then concat('block crawl to: ', first_subfolder)
	when second_subfolder_sessions_30d = 0 and second_subfolder_pageviews_30d > 0 and second_subfolder_http_status = 200  then concat('block crawl to: ', second_subfolder)
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 and last_subfolder_http_status = 200 then concat('block crawl to: ', last_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and second_subfolder_pageviews_30d > 0 then concat('301 to: ', second_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else '' end as traffic_redirect_action,	

# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 then 'review content for relevance'
	when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'review thin content'	
	when page_objective = 'leads' and leads_30d = 0 and sessions_30d > 0 then  'review relevance for top keywords'
	when page_objective = 'sales' and transactions_30d = 0 and sessions_30d > 0 then 'review relevance for top keywords'
	when page_objective in ('leads', 'sales') and sessions_yoy_pct < 0 then 'review relevance for top keywords'
else '' end as content_action,

case 
	when page_objective = 'pageviews' and pageviews_30d = 0 and links_in_count < 10 then 'review low internal link count'
	when page_objective = 'leads' and ( leads_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
	when page_objective = 'sales' and ( transactions_30d = 0 or sessions_yoy_pct < 0 ) then 'target external links'
else '' end as link_action,

case 
	when page_type is not null and (description is null or page_title is null) then 'metas missing' 
	when page_type is not null and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	when page_type is not null and sessions_30d = 0 and a.gsc_top_keyword_impressions_90d > 0 then 'review meta relevance for top keywords'
	else '' end as meta_rewrite_action,

# category actions (only display pagination_action if category_action is blank)

case when page_type = 'blog_category' and page_type_rank > 10 and a.url not like '%/page/%' then concat('potential 301 to top category: ', first_value(a.url) over (partition by page_type order by page_type_rank asc)) else '' end as category_action,

case when page_type like '%category%' and flag_paginated = 0 and url_contains_digit = 1 then 'needs pagination' else '' end as pagination_action,

page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
second_subfolder_sessions_30d,
second_subfolder_pageviews_30d,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
links_in_count,
links_out_count,
external_links_count,
internal_links_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_impressions_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
b.gsc_top_url_impressions_for_keyword_90d gsc_top_canonical_url_impressions_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.run_date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE ( a.date = c.run_date
OR a.date is null )
and ( sessions_30d > 0 or sessions_mom > 0 or sessions_yoy > 0 or page_type is not null )
2018-03-07 17:42:03,040: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:42:03,392: 17:42:03 | 44 of 46 OK created table model seo_audit.actions_proc............... [CREATE TABLE in 3.43s]
2018-03-07 17:42:03,393: 17:42:03 | 45 of 46 START table model seo_audit.actions_hierarchy............... [RUN]
2018-03-07 17:42:03,393: Compiling model.seo_audit.actions_hierarchy
2018-03-07 17:42:03,399: Writing injected SQL for node "model.seo_audit.actions_hierarchy"
2018-03-07 17:42:03,401: Acquiring new bigquery connection "actions_hierarchy".
2018-03-07 17:42:03,401: Re-using an available connection from the pool.
2018-03-07 17:42:04,163: Model SQL (actions_hierarchy):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap,
domain,
canonical_url,
page_type,
page_objective,
case 
	when anchored_url_action != '' then anchored_url_action
	when crawl_action != '' then crawl_action
	when http_status_action != '' then http_status_action
	when sitemap_action != '' then sitemap_action
	when canonical_action != '' then canonical_action
	when traffic_redirect_action != '' then traffic_redirect_action
	when category_action != '' then category_action
	else '' end as admin_action,

case 
	when anchored_url_action != '' then 'anchored url'
	when crawl_action != '' then 'not crawled by deepcrawl'
	when http_status_action != '' then cast(http_status_code as string)
	when sitemap_action like '%remove%' then '301, 404 or noindexed page'
	when sitemap_action like '%leave as is%' then 'already canonicalized'
	when sitemap_action != '' then 'page missing from sitemap'
	when canonical_action like 'canonicalize to:%' then 'url has higher search impressions for top keyword'
	when canonical_action = 'missing canonical' then 'canonical url not found by deepcrawl'
	when canonical_action like '%leave as is%' then 'already canonicalized'
	when traffic_redirect_action like 'block crawl to:%' then 'subfolder receives no traffic'
	when traffic_redirect_action = 'noindex' then 'page receives pageviews but no organic traffic'
	when traffic_redirect_action like '301 to:%' then 'page receives no pageviews, 301 to subfolder'
	when category_action != '' then 'ranks below the top 10 blog category pages'
	else '' end as admin_action_reason,
 
# analytics actions are separate from indicative actions - only display if admin_action in ('', 'add to sitemap', 'missing from crawl')
content_action,
link_action,
meta_rewrite_action,
pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_proc`
2018-03-07 17:42:05,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b229198>]}
2018-03-07 17:42:05,693: 17:42:05 | 45 of 46 OK created table model seo_audit.actions_hierarchy.......... [CREATE TABLE in 1.94s]
2018-03-07 17:42:05,694: 17:42:05 | 46 of 46 START table model seo_audit.actions_data_studio............. [RUN]
2018-03-07 17:42:05,694: Compiling model.seo_audit.actions_data_studio
2018-03-07 17:42:05,703: Writing injected SQL for node "model.seo_audit.actions_data_studio"
2018-03-07 17:42:05,705: Acquiring new bigquery connection "actions_data_studio".
2018-03-07 17:42:05,705: Re-using an available connection from the pool.
2018-03-07 17:42:06,573: Model SQL (actions_data_studio):
SELECT
date,
client,
url,
sitemap,
found_at_sitemap deepcrawl_sitemap,
domain,
canonical_url,
page_type,
page_objective,
admin_action,
admin_action_reason,
case when admin_action in ('', 'missing from crawl') then content_action else '' end as content_action,
case when admin_action in ('', 'missing from crawl') then link_action else '' end as link_action,
case when admin_action in ('', 'missing from crawl') then meta_rewrite_action else '' end as meta_rewrite_action,
case when admin_action in ('', 'missing from crawl') then pagination_action else '' end as pagination_action,
first_subfolder,
first_subfolder_http_status,
second_subfolder,
second_subfolder_http_status,
last_subfolder,
last_subfolder_http_status,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
robots_noindex,
redirected_to_url,
links_in_count,
links_out_count,
h1_tag,
h2_tag,
redirect_chain,
redirected_to_status_code,
is_redirect_loop,
duplicate_page,
duplicate_page_count,
duplicate_body,
duplicate_body_count,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
lead_conversion_rate_30d,
transaction_conversion_rate_30d,
med_lead_conversion_rate_30d,
med_transaction_conversion_rate_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
med_ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_canonical_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`actions_hierarchy`
2018-03-07 17:42:07,750: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '44eeca51-841c-4b24-b9d0-55bf5c855523', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b19b2e8>]}
2018-03-07 17:42:08,516: 17:42:08 | 46 of 46 OK created table model seo_audit.actions_data_studio........ [CREATE TABLE in 2.05s]
2018-03-07 17:42:08,543: 17:42:08 | 
2018-03-07 17:42:08,544: 17:42:08 | Finished running 46 table models in 91.86s.
2018-03-07 17:42:08,544: Connection 'master' was left open.
2018-03-07 17:42:08,545: 
2018-03-07 17:42:08,545: Completed successfully
2018-03-07 17:42:08,545: 
Done. PASS=46 ERROR=0 SKIP=0 TOTAL=46
2018-03-07 17:42:08,546: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b124780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b124908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1247b8>]}
2018-03-07 17:42:08,927: Flushing usage events
