2018-02-06 12:58:23,390: Tracking: tracking
2018-02-06 12:58:23,404: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111319ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111319d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111319a90>]}
2018-02-06 12:58:24,574: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 12:58:24,600: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 12:58:24,611: Parsing core.sql
2018-02-06 12:58:24,645: Parsing adapters/bigquery.sql
2018-02-06 12:58:24,650: Parsing adapters/common.sql
2018-02-06 12:58:24,662: Parsing adapters/postgres.sql
2018-02-06 12:58:24,678: Parsing adapters/redshift.sql
2018-02-06 12:58:24,694: Parsing etc/get_custom_schema.sql
2018-02-06 12:58:24,698: Parsing materializations/archive.sql
2018-02-06 12:58:24,727: Parsing materializations/bigquery.sql
2018-02-06 12:58:24,743: Parsing materializations/helpers.sql
2018-02-06 12:58:24,768: Parsing materializations/incremental.sql
2018-02-06 12:58:24,790: Parsing materializations/table.sql
2018-02-06 12:58:24,806: Parsing materializations/view.sql
2018-02-06 12:58:24,832: Parsing materializations/wrapper.sql
2018-02-06 12:58:24,835: Parsing schema_tests/accepted_values.sql
2018-02-06 12:58:24,848: Parsing schema_tests/not_null.sql
2018-02-06 12:58:24,850: Parsing schema_tests/relationships.sql
2018-02-06 12:58:24,853: Parsing schema_tests/unique.sql
2018-02-06 12:58:25,121: Parsing model.seo_audit.accounts_proc
2018-02-06 12:58:25,124: Parsing model.seo_audit.all_dates
2018-02-06 12:58:25,125: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 12:58:25,128: Acquiring new bigquery connection "master".
2018-02-06 12:58:25,128: Opening a new connection (0 currently allocated)
2018-02-06 12:58:25,204: Parsing model.seo_audit.agg_all
2018-02-06 12:58:25,207: Parsing model.seo_audit.agg_indicative
2018-02-06 12:58:25,209: Parsing model.seo_audit.agg_stats
2018-02-06 12:58:25,213: Parsing model.seo_audit.agg_stats_client
2018-02-06 12:58:25,216: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 12:58:25,217: Parsing model.seo_audit.ga_proc
2018-02-06 12:58:25,219: Parsing model.seo_audit.ga_stats
2018-02-06 12:58:25,221: Parsing model.seo_audit.majestic_domain_history
2018-02-06 12:58:25,222: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 12:58:25,224: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 12:58:25,226: Parsing model.seo_audit.moz_proc
2018-02-06 12:58:25,228: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 12:58:25,231: Parsing model.seo_audit.search_console_history
2018-02-06 12:58:25,232: Parsing model.seo_audit.search_console_proc
2018-02-06 12:58:25,234: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 12:58:25,236: Parsing model.seo_audit.search_console_stats_url
2018-02-06 12:58:25,238: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 12:58:25,240: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 12:58:25,243: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 12:58:25,245: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 12:58:25,247: Parsing model.seo_audit.semrush_url_history
2018-02-06 12:58:25,249: Parsing model.seo_audit.semrush_url_stats
2018-02-06 12:58:25,251: Parsing model.seo_audit.sitemap_proc
2018-02-06 12:58:25,260: Found 26 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 12:58:25,265: 
2018-02-06 12:58:26,976: 12:58:26 | Concurrency: 4 threads (target='prod')
2018-02-06 12:58:26,976: 12:58:26 | 
2018-02-06 12:58:27,139: 12:58:27 | 1 of 26 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 12:58:27,139: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 12:58:27,139: 12:58:27 | 2 of 26 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 12:58:27,144: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 12:58:27,139: 12:58:27 | 3 of 26 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 12:58:27,145: Compiling model.seo_audit.all_dates
2018-02-06 12:58:27,158: Compiling model.seo_audit.accounts_proc
2018-02-06 12:58:27,162: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 12:58:27,168: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 12:58:27,172: Acquiring new bigquery connection "accounts_proc".
2018-02-06 12:58:27,172: Acquiring new bigquery connection "all_dates".
2018-02-06 12:58:27,172: Opening a new connection (1 currently allocated)
2018-02-06 12:58:27,175: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 12:58:27,176: Opening a new connection (2 currently allocated)
2018-02-06 12:58:27,219: Opening a new connection (3 currently allocated)
2018-02-06 12:58:27,578: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_dec_price,
  avg(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_cur_price,
  avg(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_reviews,
  qt_size,
  min(qt_size) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_review,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  )
2018-02-06 12:58:27,664: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 12:58:27,674: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 12:58:27,762: Bad request while running:
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_dec_price,
  avg(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_cur_price,
  avg(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_reviews,
  qt_size,
  min(qt_size) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_review,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  )
2018-02-06 12:58:27,762: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables: Syntax error: Expected ")" but got keyword AS at [58:126]
2018-02-06 12:58:27,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114521d0>]}
2018-02-06 12:58:27,955: 12:58:27 | 1 of 26 ERROR creating view model seo_audit.deepcrawl_proc........... [ERROR in 0.62s]
2018-02-06 12:58:27,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140cba8>]}
2018-02-06 12:58:27,969: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140c518>]}
2018-02-06 12:58:28,175: 12:58:28 | 2 of 26 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.82s]
2018-02-06 12:58:28,367: 12:58:28 | 3 of 26 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.81s]
2018-02-06 12:58:28,367: 12:58:28 | 4 of 26 START view model seo_audit.semrush_keyword_proc.............. [RUN]
2018-02-06 12:58:28,367: 12:58:28 | 5 of 26 START view model seo_audit.semrush_domain_proc............... [RUN]
2018-02-06 12:58:28,367: 12:58:28 | 6 of 26 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 12:58:28,368: 12:58:28 | 7 of 26 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 12:58:28,368: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 12:58:28,368: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 12:58:28,368: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 12:58:28,368: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 12:58:28,372: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 12:58:28,377: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 12:58:28,382: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 12:58:28,386: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 12:58:28,801: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 12:58:28,801: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 12:58:28,801: Re-using an available connection from the pool.
2018-02-06 12:58:28,802: Re-using an available connection from the pool.
2018-02-06 12:58:28,803: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 12:58:28,803: Re-using an available connection from the pool.
2018-02-06 12:58:28,803: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 12:58:28,804: Opening a new connection (4 currently allocated)
2018-02-06 12:58:29,258: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 12:58:29,275: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 12:58:29,302: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 12:58:29,335: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 12:58:29,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111442668>]}
2018-02-06 12:58:29,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114dbda0>]}
2018-02-06 12:58:29,620: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140cba8>]}
2018-02-06 12:58:29,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111452d30>]}
2018-02-06 12:58:29,739: 12:58:29 | 5 of 26 OK created view model seo_audit.semrush_domain_proc.......... [CREATE VIEW in 1.15s]
2018-02-06 12:58:29,740: 12:58:29 | 8 of 26 START view model seo_audit.search_console_proc............... [RUN]
2018-02-06 12:58:29,740: Compiling model.seo_audit.search_console_proc
2018-02-06 12:58:29,745: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 12:58:29,844: Acquiring new bigquery connection "search_console_proc".
2018-02-06 12:58:29,844: Re-using an available connection from the pool.
2018-02-06 12:58:29,927: 12:58:29 | 7 of 26 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 1.20s]
2018-02-06 12:58:29,927: 12:58:29 | 9 of 26 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 12:58:29,928: Compiling model.seo_audit.moz_proc
2018-02-06 12:58:29,934: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 12:58:29,986: Acquiring new bigquery connection "moz_proc".
2018-02-06 12:58:29,986: Re-using an available connection from the pool.
2018-02-06 12:58:30,073: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 12:58:30,125: 12:58:30 | 4 of 26 OK created view model seo_audit.semrush_keyword_proc......... [CREATE VIEW in 1.25s]
2018-02-06 12:58:30,126: 12:58:30 | 10 of 26 START view model seo_audit.ga_proc.......................... [RUN]
2018-02-06 12:58:30,126: Compiling model.seo_audit.ga_proc
2018-02-06 12:58:30,134: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 12:58:30,137: Acquiring new bigquery connection "ga_proc".
2018-02-06 12:58:30,138: Re-using an available connection from the pool.
2018-02-06 12:58:30,232: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 12:58:30,333: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 12:58:30,342: 12:58:30 | 6 of 26 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 1.30s]
2018-02-06 12:58:30,342: 12:58:30 | 11 of 26 START view model seo_audit.majestic_domain_proc............. [RUN]
2018-02-06 12:58:30,343: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 12:58:30,347: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 12:58:30,348: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 12:58:30,348: Re-using an available connection from the pool.
2018-02-06 12:58:30,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114b1a20>]}
2018-02-06 12:58:30,508: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140c1d0>]}
2018-02-06 12:58:30,572: 12:58:30 | 8 of 26 OK created view model seo_audit.search_console_proc.......... [CREATE VIEW in 0.65s]
2018-02-06 12:58:30,572: 12:58:30 | 12 of 26 START view model seo_audit.sitemap_proc..................... [RUN]
2018-02-06 12:58:30,573: Compiling model.seo_audit.sitemap_proc
2018-02-06 12:58:30,580: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 12:58:30,582: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 12:58:30,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140cba8>]}
2018-02-06 12:58:30,590: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 12:58:30,592: Re-using an available connection from the pool.
2018-02-06 12:58:30,781: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 12:58:30,782: 12:58:30 | 9 of 26 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 0.58s]
2018-02-06 12:58:30,981: 12:58:30 | 10 of 26 OK created view model seo_audit.ga_proc..................... [CREATE VIEW in 0.46s]
2018-02-06 12:58:31,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111452d30>]}
2018-02-06 12:58:31,263: 12:58:31 | 11 of 26 OK created view model seo_audit.majestic_domain_proc........ [CREATE VIEW in 0.73s]
2018-02-06 12:58:31,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114b1a20>]}
2018-02-06 12:58:31,505: 12:58:31 | 12 of 26 OK created view model seo_audit.sitemap_proc................ [CREATE VIEW in 0.74s]
2018-02-06 12:58:31,505: 12:58:31 | 13 of 26 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 12:58:31,505: 12:58:31 | 14 of 26 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 12:58:31,506: 12:58:31 | 15 of 26 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 12:58:31,506: 12:58:31 | 16 of 26 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 12:58:31,506: Compiling model.seo_audit.search_console_history
2018-02-06 12:58:31,506: Compiling model.seo_audit.ga_stats
2018-02-06 12:58:31,506: Compiling model.seo_audit.majestic_domain_history
2018-02-06 12:58:31,506: Compiling model.seo_audit.semrush_url_history
2018-02-06 12:58:31,510: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 12:58:31,514: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 12:58:31,518: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 12:58:31,522: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 12:58:31,523: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 12:58:31,524: Acquiring new bigquery connection "search_console_history".
2018-02-06 12:58:31,524: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 12:58:31,524: Re-using an available connection from the pool.
2018-02-06 12:58:31,526: Re-using an available connection from the pool.
2018-02-06 12:58:31,526: Acquiring new bigquery connection "ga_stats".
2018-02-06 12:58:31,526: Re-using an available connection from the pool.
2018-02-06 12:58:31,527: Re-using an available connection from the pool.
2018-02-06 12:58:31,731: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 12:58:31,734: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 12:58:31,766: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 12:58:31,769: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 12:58:32,138: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111457710>]}
2018-02-06 12:58:32,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114f66a0>]}
2018-02-06 12:58:32,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df3b6d8>]}
2018-02-06 12:58:32,168: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11140cba8>]}
2018-02-06 12:58:32,335: 12:58:32 | 13 of 26 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.63s]
2018-02-06 12:58:32,335: 12:58:32 | 17 of 26 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 12:58:32,336: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 12:58:32,341: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 12:58:32,343: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 12:58:32,343: Re-using an available connection from the pool.
2018-02-06 12:58:32,527: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 12:58:32,534: 12:58:32 | 15 of 26 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.64s]
2018-02-06 12:58:32,741: 12:58:32 | 14 of 26 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.65s]
2018-02-06 12:58:32,849: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111457710>]}
2018-02-06 12:58:32,925: 12:58:32 | 16 of 26 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.66s]
2018-02-06 12:58:33,117: 12:58:33 | 17 of 26 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.51s]
2018-02-06 12:58:33,117: 12:58:33 | 18 of 26 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 12:58:33,117: 12:58:33 | 19 of 26 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 12:58:33,117: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 12:58:33,118: 12:58:33 | 20 of 26 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 12:58:33,118: Compiling model.seo_audit.search_console_stats_url
2018-02-06 12:58:33,122: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 12:58:33,122: Compiling model.seo_audit.agg_indicative
2018-02-06 12:58:33,126: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 12:58:33,130: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 12:58:33,160: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 12:58:33,160: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 12:58:33,160: Re-using an available connection from the pool.
2018-02-06 12:58:33,161: Acquiring new bigquery connection "agg_indicative".
2018-02-06 12:58:33,161: Re-using an available connection from the pool.
2018-02-06 12:58:33,164: Re-using an available connection from the pool.
2018-02-06 12:58:33,346: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 12:58:33,354: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 12:58:33,367: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 12:58:33,664: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114f6668>]}
2018-02-06 12:58:33,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11141da20>]}
2018-02-06 12:58:33,671: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111452d30>]}
2018-02-06 12:58:33,851: 12:58:33 | 20 of 26 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.54s]
2018-02-06 12:58:34,048: 12:58:34 | 18 of 26 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.55s]
2018-02-06 12:58:34,242: 12:58:34 | 19 of 26 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.55s]
2018-02-06 12:58:34,243: 12:58:34 | 21 of 26 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 12:58:34,243: 12:58:34 | 22 of 26 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 12:58:34,243: Compiling model.seo_audit.semrush_url_stats
2018-02-06 12:58:34,243: 12:58:34 | 23 of 26 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 12:58:34,243: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 12:58:34,248: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 12:58:34,248: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 12:58:34,252: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 12:58:34,256: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 12:58:34,257: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 12:58:34,257: Re-using an available connection from the pool.
2018-02-06 12:58:34,258: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 12:58:34,258: Re-using an available connection from the pool.
2018-02-06 12:58:34,260: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 12:58:34,261: Re-using an available connection from the pool.
2018-02-06 12:58:34,460: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 12:58:34,464: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 12:58:34,485: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 12:58:34,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111457710>]}
2018-02-06 12:58:34,825: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113f40f0>]}
2018-02-06 12:58:34,828: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111442f60>]}
2018-02-06 12:58:34,990: 12:58:34 | 21 of 26 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.55s]
2018-02-06 12:58:35,182: 12:58:35 | 22 of 26 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.58s]
2018-02-06 12:58:35,374: 12:58:35 | 23 of 26 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.58s]
2018-02-06 12:58:35,375: 12:58:35 | 24 of 26 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 12:58:35,375: Compiling model.seo_audit.agg_stats
2018-02-06 12:58:35,381: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 12:58:35,382: Acquiring new bigquery connection "agg_stats".
2018-02-06 12:58:35,382: Re-using an available connection from the pool.
2018-02-06 12:58:35,589: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 12:58:36,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111452d30>]}
2018-02-06 12:58:36,340: 12:58:36 | 24 of 26 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.77s]
2018-02-06 12:58:36,341: 12:58:36 | 25 of 26 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 12:58:36,341: Compiling model.seo_audit.agg_stats_client
2018-02-06 12:58:36,345: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 12:58:36,346: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 12:58:36,346: Re-using an available connection from the pool.
2018-02-06 12:58:36,516: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 12:58:37,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111442f60>]}
2018-02-06 12:58:37,296: 12:58:37 | 25 of 26 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.77s]
2018-02-06 12:58:37,297: 12:58:37 | 26 of 26 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 12:58:37,297: Compiling model.seo_audit.agg_all
2018-02-06 12:58:37,301: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 12:58:37,302: Acquiring new bigquery connection "agg_all".
2018-02-06 12:58:37,302: Re-using an available connection from the pool.
2018-02-06 12:58:37,494: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 12:58:38,235: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fea3a872-3b6c-45ee-9434-5b62cea582d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111452d30>]}
2018-02-06 12:58:38,421: 12:58:38 | 26 of 26 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.94s]
2018-02-06 12:58:38,509: 12:58:38 | 
2018-02-06 12:58:38,509: 12:58:38 | Finished running 26 view models in 11.53s.
2018-02-06 12:58:38,510: Connection 'master' was left open.
2018-02-06 12:58:38,510: 
2018-02-06 12:58:38,510: Completed with 1 errors:
2018-02-06 12:58:38,510: 
2018-02-06 12:58:38,510: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-06 12:58:38,510:   Syntax error: Expected ")" but got keyword AS at [58:126]
2018-02-06 12:58:38,510:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-02-06 12:58:38,510: 
Done. PASS=25 ERROR=1 SKIP=0 TOTAL=26
2018-02-06 12:58:38,511: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113e6a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1113e6748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111319ef0>]}
2018-02-06 12:58:38,702: Flushing usage events
2018-02-06 13:00:36,016: Tracking: tracking
2018-02-06 13:00:36,016: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111393860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111393470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111393668>]}
2018-02-06 13:00:36,612: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:00:36,623: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:00:36,625: Parsing core.sql
2018-02-06 13:00:36,635: Parsing adapters/bigquery.sql
2018-02-06 13:00:36,639: Parsing adapters/common.sql
2018-02-06 13:00:36,652: Parsing adapters/postgres.sql
2018-02-06 13:00:36,654: Parsing adapters/redshift.sql
2018-02-06 13:00:36,676: Parsing etc/get_custom_schema.sql
2018-02-06 13:00:36,680: Parsing materializations/archive.sql
2018-02-06 13:00:36,707: Parsing materializations/bigquery.sql
2018-02-06 13:00:36,719: Parsing materializations/helpers.sql
2018-02-06 13:00:36,733: Parsing materializations/incremental.sql
2018-02-06 13:00:36,755: Parsing materializations/table.sql
2018-02-06 13:00:36,773: Parsing materializations/view.sql
2018-02-06 13:00:36,787: Parsing materializations/wrapper.sql
2018-02-06 13:00:36,790: Parsing schema_tests/accepted_values.sql
2018-02-06 13:00:36,793: Parsing schema_tests/not_null.sql
2018-02-06 13:00:36,794: Parsing schema_tests/relationships.sql
2018-02-06 13:00:36,796: Parsing schema_tests/unique.sql
2018-02-06 13:00:36,804: Parsing model.seo_audit.accounts_proc
2018-02-06 13:00:36,806: Parsing model.seo_audit.all_dates
2018-02-06 13:00:36,807: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:00:36,808: Acquiring new bigquery connection "master".
2018-02-06 13:00:36,809: Opening a new connection (0 currently allocated)
2018-02-06 13:00:36,810: Parsing model.seo_audit.agg_all
2018-02-06 13:00:36,813: Parsing model.seo_audit.agg_indicative
2018-02-06 13:00:36,815: Parsing model.seo_audit.agg_stats
2018-02-06 13:00:36,819: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:00:36,822: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:00:36,824: Parsing model.seo_audit.ga_proc
2018-02-06 13:00:36,826: Parsing model.seo_audit.ga_stats
2018-02-06 13:00:36,827: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:00:36,829: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:00:36,831: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:00:36,833: Parsing model.seo_audit.moz_proc
2018-02-06 13:00:36,835: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:00:36,838: Parsing model.seo_audit.search_console_history
2018-02-06 13:00:36,840: Parsing model.seo_audit.search_console_proc
2018-02-06 13:00:36,842: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:00:36,844: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:00:36,846: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:00:36,848: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:00:36,850: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:00:36,853: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:00:36,854: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:00:36,856: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:00:36,858: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:00:36,867: Found 26 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:00:36,873: 
2018-02-06 13:00:38,016: 13:00:38 | Concurrency: 4 threads (target='prod')
2018-02-06 13:00:38,016: 13:00:38 | 
2018-02-06 13:00:38,162: 13:00:38 | 1 of 26 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:00:38,163: Compiling model.seo_audit.all_dates
2018-02-06 13:00:38,163: 13:00:38 | 2 of 26 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:00:38,163: 13:00:38 | 3 of 26 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:00:38,166: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:00:38,166: Compiling model.seo_audit.accounts_proc
2018-02-06 13:00:38,166: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:00:38,170: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:00:38,174: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:00:38,175: Acquiring new bigquery connection "all_dates".
2018-02-06 13:00:38,175: Opening a new connection (1 currently allocated)
2018-02-06 13:00:38,177: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:00:38,177: Opening a new connection (2 currently allocated)
2018-02-06 13:00:38,220: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:00:38,222: Opening a new connection (3 currently allocated)
2018-02-06 13:00:38,588: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_dec_price,
  avg(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_cur_price,
  avg(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_reviews,
  qt_size,
  min(qt_size) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_review,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  )
2018-02-06 13:00:38,685: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:00:38,696: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:00:38,751: Bad request while running:
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_dec_price,
  avg(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_cur_price,
  avg(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_reviews,
  qt_size,
  min(qt_size) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_review,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  )
2018-02-06 13:00:38,751: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables: Unrecognized name: qt_reviews; Did you mean qt_review? at [45:3]
2018-02-06 13:00:38,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111527e48>]}
2018-02-06 13:00:38,927: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111503400>]}
2018-02-06 13:00:38,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111503320>]}
2018-02-06 13:00:38,935: 13:00:38 | 3 of 26 ERROR creating view model seo_audit.deepcrawl_proc........... [ERROR in 0.58s]
2018-02-06 13:00:39,139: 13:00:39 | 2 of 26 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.76s]
2018-02-06 13:00:39,336: 13:00:39 | 1 of 26 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.77s]
2018-02-06 13:00:39,337: 13:00:39 | 4 of 26 START view model seo_audit.majestic_domain_proc.............. [RUN]
2018-02-06 13:00:39,337: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:00:39,341: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:00:39,341: 13:00:39 | 5 of 26 START view model seo_audit.semrush_domain_proc............... [RUN]
2018-02-06 13:00:39,342: 13:00:39 | 6 of 26 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:00:39,342: 13:00:39 | 7 of 26 START view model seo_audit.ga_proc........................... [RUN]
2018-02-06 13:00:39,342: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:00:39,342: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:00:39,342: Compiling model.seo_audit.ga_proc
2018-02-06 13:00:39,347: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:00:39,352: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:00:39,352: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:00:39,358: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:00:39,358: Re-using an available connection from the pool.
2018-02-06 13:00:39,360: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:00:39,360: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:00:39,361: Re-using an available connection from the pool.
2018-02-06 13:00:39,362: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:00:39,363: Re-using an available connection from the pool.
2018-02-06 13:00:39,366: Opening a new connection (4 currently allocated)
2018-02-06 13:00:39,576: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:00:39,616: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:00:39,656: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:00:39,780: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:00:39,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9550>]}
2018-02-06 13:00:39,905: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111503470>]}
2018-02-06 13:00:39,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1115787b8>]}
2018-02-06 13:00:40,073: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111578978>]}
2018-02-06 13:00:40,079: 13:00:40 | 4 of 26 OK created view model seo_audit.majestic_domain_proc......... [CREATE VIEW in 0.53s]
2018-02-06 13:00:40,079: 13:00:40 | 8 of 26 START view model seo_audit.search_console_proc............... [RUN]
2018-02-06 13:00:40,079: Compiling model.seo_audit.search_console_proc
2018-02-06 13:00:40,084: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:00:40,086: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:00:40,087: Re-using an available connection from the pool.
2018-02-06 13:00:40,241: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:00:40,278: 13:00:40 | 5 of 26 OK created view model seo_audit.semrush_domain_proc.......... [CREATE VIEW in 0.56s]
2018-02-06 13:00:40,279: 13:00:40 | 9 of 26 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:00:40,280: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:00:40,285: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:00:40,287: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:00:40,287: Re-using an available connection from the pool.
2018-02-06 13:00:40,480: 13:00:40 | 6 of 26 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.58s]
2018-02-06 13:00:40,480: 13:00:40 | 10 of 26 START view model seo_audit.moz_proc......................... [RUN]
2018-02-06 13:00:40,483: Compiling model.seo_audit.moz_proc
2018-02-06 13:00:40,492: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:00:40,494: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:00:40,494: Re-using an available connection from the pool.
2018-02-06 13:00:40,525: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:00:40,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9550>]}
2018-02-06 13:00:40,688: 13:00:40 | 7 of 26 OK created view model seo_audit.ga_proc...................... [CREATE VIEW in 0.73s]
2018-02-06 13:00:40,689: 13:00:40 | 11 of 26 START view model seo_audit.sitemap_proc..................... [RUN]
2018-02-06 13:00:40,689: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:00:40,696: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:00:40,698: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:00:40,699: Re-using an available connection from the pool.
2018-02-06 13:00:40,702: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:00:40,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111471048>]}
2018-02-06 13:00:40,861: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:00:40,891: 13:00:40 | 8 of 26 OK created view model seo_audit.search_console_proc.......... [CREATE VIEW in 0.49s]
2018-02-06 13:00:40,891: 13:00:40 | 12 of 26 START view model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-06 13:00:40,892: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:00:40,896: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:00:40,898: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:00:40,899: Re-using an available connection from the pool.
2018-02-06 13:00:40,967: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111503630>]}
2018-02-06 13:00:41,086: 13:00:41 | 9 of 26 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 0.53s]
2018-02-06 13:00:41,095: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:00:41,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111585550>]}
2018-02-06 13:00:41,394: 13:00:41 | 10 of 26 OK created view model seo_audit.moz_proc.................... [CREATE VIEW in 0.48s]
2018-02-06 13:00:41,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df30748>]}
2018-02-06 13:00:41,579: 13:00:41 | 11 of 26 OK created view model seo_audit.sitemap_proc................ [CREATE VIEW in 0.44s]
2018-02-06 13:00:41,796: 13:00:41 | 12 of 26 OK created view model seo_audit.semrush_keyword_proc........ [CREATE VIEW in 0.51s]
2018-02-06 13:00:41,796: 13:00:41 | 13 of 26 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:00:41,797: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:00:41,801: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:00:41,796: 13:00:41 | 14 of 26 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:00:41,801: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:00:41,805: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:00:41,797: 13:00:41 | 15 of 26 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:00:41,806: Compiling model.seo_audit.ga_stats
2018-02-06 13:00:41,810: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:00:41,797: 13:00:41 | 16 of 26 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:00:41,810: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:00:41,810: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:00:41,811: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:00:41,817: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:00:41,817: Re-using an available connection from the pool.
2018-02-06 13:00:41,819: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:00:41,819: Re-using an available connection from the pool.
2018-02-06 13:00:41,820: Re-using an available connection from the pool.
2018-02-06 13:00:41,829: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:00:41,831: Re-using an available connection from the pool.
2018-02-06 13:00:42,019: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:00:42,021: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:00:42,034: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:00:42,153: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:00:42,367: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111585a90>]}
2018-02-06 13:00:42,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9f28>]}
2018-02-06 13:00:42,420: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9c18>]}
2018-02-06 13:00:42,462: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114b5e10>]}
2018-02-06 13:00:42,551: 13:00:42 | 13 of 26 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.57s]
2018-02-06 13:00:42,552: 13:00:42 | 17 of 26 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:00:42,552: Compiling model.seo_audit.search_console_history
2018-02-06 13:00:42,556: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:00:42,559: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:00:42,559: Re-using an available connection from the pool.
2018-02-06 13:00:42,759: 13:00:42 | 14 of 26 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.59s]
2018-02-06 13:00:42,771: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:00:42,946: 13:00:42 | 16 of 26 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.61s]
2018-02-06 13:00:43,134: 13:00:43 | 15 of 26 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.66s]
2018-02-06 13:00:43,145: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114969b0>]}
2018-02-06 13:00:43,348: 13:00:43 | 17 of 26 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.59s]
2018-02-06 13:00:43,348: 13:00:43 | 18 of 26 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:00:43,348: 13:00:43 | 19 of 26 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:00:43,349: 13:00:43 | 20 of 26 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:00:43,349: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:00:43,349: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:00:43,349: Compiling model.seo_audit.agg_indicative
2018-02-06 13:00:43,353: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:00:43,357: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:00:43,361: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:00:43,362: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:00:43,362: Re-using an available connection from the pool.
2018-02-06 13:00:43,363: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:00:43,363: Re-using an available connection from the pool.
2018-02-06 13:00:43,364: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:00:43,364: Re-using an available connection from the pool.
2018-02-06 13:00:43,589: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:00:43,608: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:00:43,610: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:00:43,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1115274e0>]}
2018-02-06 13:00:43,940: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df30748>]}
2018-02-06 13:00:43,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9ef0>]}
2018-02-06 13:00:44,086: 13:00:44 | 19 of 26 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.54s]
2018-02-06 13:00:44,284: 13:00:44 | 18 of 26 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.59s]
2018-02-06 13:00:44,473: 13:00:44 | 20 of 26 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.62s]
2018-02-06 13:00:44,473: 13:00:44 | 21 of 26 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:00:44,474: 13:00:44 | 22 of 26 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:00:44,474: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:00:44,474: 13:00:44 | 23 of 26 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:00:44,474: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:00:44,478: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:00:44,478: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:00:44,482: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:00:44,486: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:00:44,487: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:00:44,487: Re-using an available connection from the pool.
2018-02-06 13:00:44,488: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:00:44,489: Re-using an available connection from the pool.
2018-02-06 13:00:44,489: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:00:44,493: Re-using an available connection from the pool.
2018-02-06 13:00:44,693: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:00:44,696: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:00:44,725: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:00:45,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111471048>]}
2018-02-06 13:00:45,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111516a90>]}
2018-02-06 13:00:45,092: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114969b0>]}
2018-02-06 13:00:45,245: 13:00:45 | 22 of 26 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.59s]
2018-02-06 13:00:45,439: 13:00:45 | 23 of 26 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.61s]
2018-02-06 13:00:45,623: 13:00:45 | 21 of 26 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.62s]
2018-02-06 13:00:45,624: 13:00:45 | 24 of 26 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:00:45,624: Compiling model.seo_audit.agg_stats
2018-02-06 13:00:45,630: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:00:45,631: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:00:45,631: Re-using an available connection from the pool.
2018-02-06 13:00:45,875: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:00:46,400: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9ef0>]}
2018-02-06 13:00:46,601: 13:00:46 | 24 of 26 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.78s]
2018-02-06 13:00:46,602: 13:00:46 | 25 of 26 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:00:46,602: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:00:46,606: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:00:46,607: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:00:46,607: Re-using an available connection from the pool.
2018-02-06 13:00:46,815: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:00:47,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114969b0>]}
2018-02-06 13:00:47,689: 13:00:47 | 25 of 26 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.90s]
2018-02-06 13:00:47,689: 13:00:47 | 26 of 26 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:00:47,689: Compiling model.seo_audit.agg_all
2018-02-06 13:00:47,694: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:00:47,695: Acquiring new bigquery connection "agg_all".
2018-02-06 13:00:47,695: Re-using an available connection from the pool.
2018-02-06 13:00:47,928: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:00:48,608: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2a17315-4976-4d19-bf66-452e7fa5ec98', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114c9ef0>]}
2018-02-06 13:00:48,802: 13:00:48 | 26 of 26 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.92s]
2018-02-06 13:00:48,835: 13:00:48 | 
2018-02-06 13:00:48,835: 13:00:48 | Finished running 26 view models in 10.82s.
2018-02-06 13:00:48,835: Connection 'master' was left open.
2018-02-06 13:00:48,836: 
2018-02-06 13:00:48,836: Completed with 1 errors:
2018-02-06 13:00:48,836: 
2018-02-06 13:00:48,836: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-06 13:00:48,836:   Unrecognized name: qt_reviews; Did you mean qt_review? at [45:3]
2018-02-06 13:00:48,836:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-02-06 13:00:48,836: 
Done. PASS=25 ERROR=1 SKIP=0 TOTAL=26
2018-02-06 13:00:48,837: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114617b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111461940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114617f0>]}
2018-02-06 13:00:49,026: Flushing usage events
2018-02-06 13:02:08,269: Tracking: tracking
2018-02-06 13:02:08,269: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112357860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112357470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112357668>]}
2018-02-06 13:02:08,859: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:02:08,871: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:02:08,873: Parsing core.sql
2018-02-06 13:02:08,884: Parsing adapters/bigquery.sql
2018-02-06 13:02:08,889: Parsing adapters/common.sql
2018-02-06 13:02:08,902: Parsing adapters/postgres.sql
2018-02-06 13:02:08,905: Parsing adapters/redshift.sql
2018-02-06 13:02:08,924: Parsing etc/get_custom_schema.sql
2018-02-06 13:02:08,929: Parsing materializations/archive.sql
2018-02-06 13:02:08,970: Parsing materializations/bigquery.sql
2018-02-06 13:02:08,983: Parsing materializations/helpers.sql
2018-02-06 13:02:08,997: Parsing materializations/incremental.sql
2018-02-06 13:02:09,020: Parsing materializations/table.sql
2018-02-06 13:02:09,036: Parsing materializations/view.sql
2018-02-06 13:02:09,049: Parsing materializations/wrapper.sql
2018-02-06 13:02:09,052: Parsing schema_tests/accepted_values.sql
2018-02-06 13:02:09,055: Parsing schema_tests/not_null.sql
2018-02-06 13:02:09,056: Parsing schema_tests/relationships.sql
2018-02-06 13:02:09,059: Parsing schema_tests/unique.sql
2018-02-06 13:02:09,067: Parsing model.seo_audit.accounts_proc
2018-02-06 13:02:09,069: Parsing model.seo_audit.all_dates
2018-02-06 13:02:09,070: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:02:09,072: Acquiring new bigquery connection "master".
2018-02-06 13:02:09,072: Opening a new connection (0 currently allocated)
2018-02-06 13:02:09,073: Parsing model.seo_audit.agg_all
2018-02-06 13:02:09,076: Parsing model.seo_audit.agg_indicative
2018-02-06 13:02:09,078: Parsing model.seo_audit.agg_stats
2018-02-06 13:02:09,082: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:02:09,084: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:02:09,086: Parsing model.seo_audit.ga_proc
2018-02-06 13:02:09,088: Parsing model.seo_audit.ga_stats
2018-02-06 13:02:09,089: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:02:09,091: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:02:09,093: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:02:09,095: Parsing model.seo_audit.moz_proc
2018-02-06 13:02:09,098: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:02:09,100: Parsing model.seo_audit.search_console_history
2018-02-06 13:02:09,102: Parsing model.seo_audit.search_console_proc
2018-02-06 13:02:09,104: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:02:09,106: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:02:09,108: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:02:09,110: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:02:09,112: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:02:09,115: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:02:09,117: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:02:09,118: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:02:09,120: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:02:09,128: Found 26 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:02:09,134: 
2018-02-06 13:02:09,808: 13:02:09 | Concurrency: 4 threads (target='prod')
2018-02-06 13:02:09,808: 13:02:09 | 
2018-02-06 13:02:09,964: 13:02:09 | 1 of 26 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:02:09,964: Compiling model.seo_audit.accounts_proc
2018-02-06 13:02:09,964: 13:02:09 | 2 of 26 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:02:09,968: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:02:09,964: 13:02:09 | 3 of 26 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:02:09,969: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:02:09,969: Compiling model.seo_audit.all_dates
2018-02-06 13:02:09,973: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:02:09,976: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:02:09,976: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:02:09,977: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:02:09,977: Opening a new connection (1 currently allocated)
2018-02-06 13:02:09,978: Acquiring new bigquery connection "all_dates".
2018-02-06 13:02:09,979: Opening a new connection (2 currently allocated)
2018-02-06 13:02:10,035: Opening a new connection (3 currently allocated)
2018-02-06 13:02:10,385: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_dec_price,
  avg(qt_dec_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_cur_price,
  avg(qt_cur_price) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_reviews,
  qt_size,
  min(qt_size) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER (PARTITION BY header_content_type ORDER BY http_status_code desc) AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  )
2018-02-06 13:02:10,484: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:02:10,523: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:02:10,614: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124dd860>]}
2018-02-06 13:02:10,675: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c84a8>]}
2018-02-06 13:02:10,734: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8470>]}
2018-02-06 13:02:10,804: 13:02:10 | 2 of 26 OK created view model seo_audit.deepcrawl_proc............... [CREATE VIEW in 0.65s]
2018-02-06 13:02:10,999: 13:02:10 | 3 of 26 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.71s]
2018-02-06 13:02:11,187: 13:02:11 | 1 of 26 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.77s]
2018-02-06 13:02:11,187: 13:02:11 | 4 of 26 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:02:11,187: 13:02:11 | 5 of 26 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 13:02:11,187: 13:02:11 | 6 of 26 START view model seo_audit.ga_proc........................... [RUN]
2018-02-06 13:02:11,187: 13:02:11 | 7 of 26 START view model seo_audit.sitemap_proc...................... [RUN]
2018-02-06 13:02:11,188: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:02:11,188: Compiling model.seo_audit.moz_proc
2018-02-06 13:02:11,188: Compiling model.seo_audit.ga_proc
2018-02-06 13:02:11,188: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:02:11,193: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:02:11,197: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:02:11,201: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:02:11,206: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:02:11,208: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:02:11,208: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:02:11,208: Re-using an available connection from the pool.
2018-02-06 13:02:11,209: Re-using an available connection from the pool.
2018-02-06 13:02:11,209: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:02:11,210: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:02:11,210: Re-using an available connection from the pool.
2018-02-06 13:02:11,211: Opening a new connection (4 currently allocated)
2018-02-06 13:02:11,414: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:02:11,428: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:02:11,451: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:02:12,048: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:02:12,055: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8ba8>]}
2018-02-06 13:02:12,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8f28>]}
2018-02-06 13:02:12,083: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11245c1d0>]}
2018-02-06 13:02:12,250: 13:02:12 | 6 of 26 OK created view model seo_audit.ga_proc...................... [CREATE VIEW in 0.87s]
2018-02-06 13:02:12,251: 13:02:12 | 8 of 26 START view model seo_audit.semrush_keyword_proc.............. [RUN]
2018-02-06 13:02:12,252: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:02:12,256: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:02:12,258: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:02:12,258: Re-using an available connection from the pool.
2018-02-06 13:02:12,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8128>]}
2018-02-06 13:02:12,445: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:02:12,452: 13:02:12 | 7 of 26 OK created view model seo_audit.sitemap_proc................. [CREATE VIEW in 0.87s]
2018-02-06 13:02:12,453: 13:02:12 | 9 of 26 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:02:12,453: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:02:12,458: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:02:12,459: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:02:12,460: Re-using an available connection from the pool.
2018-02-06 13:02:12,650: 13:02:12 | 4 of 26 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.90s]
2018-02-06 13:02:12,650: 13:02:12 | 10 of 26 START view model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-06 13:02:12,651: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:02:12,656: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:02:12,657: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:02:12,659: Re-using an available connection from the pool.
2018-02-06 13:02:12,676: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:02:12,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8ba8>]}
2018-02-06 13:02:12,842: 13:02:12 | 5 of 26 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 1.14s]
2018-02-06 13:02:12,843: 13:02:12 | 11 of 26 START view model seo_audit.search_console_proc.............. [RUN]
2018-02-06 13:02:12,844: Compiling model.seo_audit.search_console_proc
2018-02-06 13:02:12,849: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:02:12,851: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:02:12,851: Re-using an available connection from the pool.
2018-02-06 13:02:12,860: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:02:12,977: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124c8f28>]}
2018-02-06 13:02:13,022: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:02:13,040: 13:02:13 | 8 of 26 OK created view model seo_audit.semrush_keyword_proc......... [CREATE VIEW in 0.52s]
2018-02-06 13:02:13,040: 13:02:13 | 12 of 26 START view model seo_audit.majestic_domain_proc............. [RUN]
2018-02-06 13:02:13,040: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:02:13,045: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:02:13,047: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:02:13,048: Re-using an available connection from the pool.
2018-02-06 13:02:13,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11245c1d0>]}
2018-02-06 13:02:13,232: 13:02:13 | 9 of 26 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 0.52s]
2018-02-06 13:02:13,269: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:02:13,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247a048>]}
2018-02-06 13:02:13,427: 13:02:13 | 10 of 26 OK created view model seo_audit.semrush_domain_proc......... [CREATE VIEW in 0.46s]
2018-02-06 13:02:13,536: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112564ef0>]}
2018-02-06 13:02:13,611: 13:02:13 | 11 of 26 OK created view model seo_audit.search_console_proc......... [CREATE VIEW in 0.47s]
2018-02-06 13:02:13,799: 13:02:13 | 12 of 26 OK created view model seo_audit.majestic_domain_proc........ [CREATE VIEW in 0.50s]
2018-02-06 13:02:13,799: 13:02:13 | 13 of 26 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:02:13,800: 13:02:13 | 14 of 26 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:02:13,800: Compiling model.seo_audit.search_console_history
2018-02-06 13:02:13,800: 13:02:13 | 15 of 26 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:02:13,800: 13:02:13 | 16 of 26 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:02:13,800: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:02:13,804: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:02:13,804: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:02:13,804: Compiling model.seo_audit.ga_stats
2018-02-06 13:02:13,807: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:02:13,812: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:02:13,815: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:02:13,817: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:02:13,817: Re-using an available connection from the pool.
2018-02-06 13:02:13,817: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:02:13,818: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:02:13,818: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:02:13,820: Re-using an available connection from the pool.
2018-02-06 13:02:13,822: Re-using an available connection from the pool.
2018-02-06 13:02:13,823: Re-using an available connection from the pool.
2018-02-06 13:02:13,994: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:02:14,004: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:02:14,020: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:02:14,031: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:02:14,294: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247a978>]}
2018-02-06 13:02:14,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247ac18>]}
2018-02-06 13:02:14,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247a048>]}
2018-02-06 13:02:14,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11245c6a0>]}
2018-02-06 13:02:14,512: 13:02:14 | 16 of 26 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.49s]
2018-02-06 13:02:14,513: 13:02:14 | 17 of 26 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:02:14,513: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:02:14,517: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:02:14,519: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:02:14,520: Re-using an available connection from the pool.
2018-02-06 13:02:14,709: 13:02:14 | 15 of 26 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.50s]
2018-02-06 13:02:14,747: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:02:14,914: 13:02:14 | 13 of 26 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.51s]
2018-02-06 13:02:15,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247a978>]}
2018-02-06 13:02:15,097: 13:02:15 | 14 of 26 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.59s]
2018-02-06 13:02:15,296: 13:02:15 | 17 of 26 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.55s]
2018-02-06 13:02:15,296: 13:02:15 | 18 of 26 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:02:15,297: 13:02:15 | 19 of 26 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:02:15,297: Compiling model.seo_audit.agg_indicative
2018-02-06 13:02:15,297: 13:02:15 | 20 of 26 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:02:15,297: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:02:15,301: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:02:15,301: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:02:15,305: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:02:15,309: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:02:15,310: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:02:15,311: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:02:15,311: Re-using an available connection from the pool.
2018-02-06 13:02:15,311: Re-using an available connection from the pool.
2018-02-06 13:02:15,314: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:02:15,315: Re-using an available connection from the pool.
2018-02-06 13:02:15,503: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:02:15,511: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:02:15,539: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:02:15,812: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112552cc0>]}
2018-02-06 13:02:15,814: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11247a978>]}
2018-02-06 13:02:15,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112435cc0>]}
2018-02-06 13:02:16,033: 13:02:16 | 20 of 26 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.51s]
2018-02-06 13:02:16,223: 13:02:16 | 19 of 26 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.52s]
2018-02-06 13:02:16,413: 13:02:16 | 18 of 26 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.59s]
2018-02-06 13:02:16,413: 13:02:16 | 21 of 26 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:02:16,414: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:02:16,418: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:02:16,414: 13:02:16 | 22 of 26 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:02:16,418: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:02:16,422: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:02:16,414: 13:02:16 | 23 of 26 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:02:16,422: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:02:16,427: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:02:16,428: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:02:16,428: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:02:16,428: Re-using an available connection from the pool.
2018-02-06 13:02:16,429: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:02:16,429: Re-using an available connection from the pool.
2018-02-06 13:02:16,429: Re-using an available connection from the pool.
2018-02-06 13:02:16,616: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:02:16,635: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:02:16,640: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:02:16,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124f7080>]}
2018-02-06 13:02:17,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124ddc18>]}
2018-02-06 13:02:17,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112482d68>]}
2018-02-06 13:02:17,163: 13:02:17 | 23 of 26 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.55s]
2018-02-06 13:02:17,359: 13:02:17 | 22 of 26 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.60s]
2018-02-06 13:02:17,544: 13:02:17 | 21 of 26 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.73s]
2018-02-06 13:02:17,545: 13:02:17 | 24 of 26 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:02:17,545: Compiling model.seo_audit.agg_stats
2018-02-06 13:02:17,551: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:02:17,552: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:02:17,552: Re-using an available connection from the pool.
2018-02-06 13:02:17,738: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:02:18,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112435cc0>]}
2018-02-06 13:02:18,497: 13:02:18 | 24 of 26 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.76s]
2018-02-06 13:02:18,498: 13:02:18 | 25 of 26 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:02:18,498: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:02:18,502: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:02:18,503: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:02:18,503: Re-using an available connection from the pool.
2018-02-06 13:02:18,696: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:02:19,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112482d68>]}
2018-02-06 13:02:19,435: 13:02:19 | 25 of 26 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.75s]
2018-02-06 13:02:19,436: 13:02:19 | 26 of 26 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:02:19,436: Compiling model.seo_audit.agg_all
2018-02-06 13:02:19,441: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:02:19,442: Acquiring new bigquery connection "agg_all".
2018-02-06 13:02:19,442: Re-using an available connection from the pool.
2018-02-06 13:02:19,649: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:02:20,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '678246bb-a372-4d8c-bf4c-a1bb53b4d4aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112435cc0>]}
2018-02-06 13:02:20,503: 13:02:20 | 26 of 26 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.87s]
2018-02-06 13:02:20,608: 13:02:20 | 
2018-02-06 13:02:20,608: 13:02:20 | Finished running 26 view models in 10.80s.
2018-02-06 13:02:20,608: Connection 'master' was left open.
2018-02-06 13:02:20,608: 
2018-02-06 13:02:20,608: Completed successfully
2018-02-06 13:02:20,608: 
Done. PASS=26 ERROR=0 SKIP=0 TOTAL=26
2018-02-06 13:02:20,608: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112426780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112426908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1124267b8>]}
2018-02-06 13:02:20,798: Flushing usage events
2018-02-06 13:09:51,362: Tracking: tracking
2018-02-06 13:09:51,374: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b87e400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b87e198>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b87e710>]}
2018-02-06 13:09:52,175: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:09:52,194: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:09:52,205: Parsing core.sql
2018-02-06 13:09:52,250: Parsing adapters/bigquery.sql
2018-02-06 13:09:52,255: Parsing adapters/common.sql
2018-02-06 13:09:52,266: Parsing adapters/postgres.sql
2018-02-06 13:09:52,282: Parsing adapters/redshift.sql
2018-02-06 13:09:52,298: Parsing etc/get_custom_schema.sql
2018-02-06 13:09:52,303: Parsing materializations/archive.sql
2018-02-06 13:09:52,331: Parsing materializations/bigquery.sql
2018-02-06 13:09:52,348: Parsing materializations/helpers.sql
2018-02-06 13:09:52,372: Parsing materializations/incremental.sql
2018-02-06 13:09:52,395: Parsing materializations/table.sql
2018-02-06 13:09:52,411: Parsing materializations/view.sql
2018-02-06 13:09:52,437: Parsing materializations/wrapper.sql
2018-02-06 13:09:52,450: Parsing schema_tests/accepted_values.sql
2018-02-06 13:09:52,453: Parsing schema_tests/not_null.sql
2018-02-06 13:09:52,455: Parsing schema_tests/relationships.sql
2018-02-06 13:09:52,458: Parsing schema_tests/unique.sql
2018-02-06 13:09:52,533: Parsing model.seo_audit.accounts_proc
2018-02-06 13:09:52,535: Parsing model.seo_audit.all_dates
2018-02-06 13:09:52,536: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:09:52,539: Acquiring new bigquery connection "master".
2018-02-06 13:09:52,539: Opening a new connection (0 currently allocated)
2018-02-06 13:09:52,553: Parsing model.seo_audit.agg_all
2018-02-06 13:09:52,556: Parsing model.seo_audit.agg_indicative
2018-02-06 13:09:52,558: Parsing model.seo_audit.agg_stats
2018-02-06 13:09:52,562: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:09:52,565: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:09:52,567: Parsing model.seo_audit.ga_proc
2018-02-06 13:09:52,569: Parsing model.seo_audit.ga_stats
2018-02-06 13:09:52,571: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:09:52,573: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:09:52,575: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:09:52,577: Parsing model.seo_audit.moz_proc
2018-02-06 13:09:52,579: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:09:52,582: Parsing model.seo_audit.search_console_history
2018-02-06 13:09:52,583: Parsing model.seo_audit.search_console_proc
2018-02-06 13:09:52,585: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:09:52,588: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:09:52,589: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:09:52,591: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:09:52,594: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:09:52,596: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:09:52,598: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:09:52,600: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:09:52,602: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:09:52,611: Found 26 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:09:52,617: 
2018-02-06 13:09:53,674: 13:09:53 | Concurrency: 4 threads (target='prod')
2018-02-06 13:09:53,674: 13:09:53 | 
2018-02-06 13:09:53,821: 13:09:53 | 1 of 26 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:09:53,821: 13:09:53 | 2 of 26 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:09:53,821: Compiling model.seo_audit.all_dates
2018-02-06 13:09:53,821: 13:09:53 | 3 of 26 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:09:53,821: Compiling model.seo_audit.accounts_proc
2018-02-06 13:09:53,825: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:09:53,825: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:09:53,829: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:09:53,833: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:09:53,834: Acquiring new bigquery connection "all_dates".
2018-02-06 13:09:53,834: Opening a new connection (1 currently allocated)
2018-02-06 13:09:53,835: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:09:53,835: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:09:53,836: Opening a new connection (2 currently allocated)
2018-02-06 13:09:53,881: Opening a new connection (3 currently allocated)
2018-02-06 13:09:54,321: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else '' end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else '' end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:09:54,322: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:09:54,354: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:09:54,508: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b99db70>]}
2018-02-06 13:09:54,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:09:54,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b99d630>]}
2018-02-06 13:09:54,694: 13:09:54 | 1 of 26 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.69s]
2018-02-06 13:09:54,878: 13:09:54 | 3 of 26 OK created view model seo_audit.deepcrawl_proc............... [CREATE VIEW in 0.72s]
2018-02-06 13:09:55,081: 13:09:55 | 2 of 26 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.73s]
2018-02-06 13:09:55,081: 13:09:55 | 4 of 26 START view model seo_audit.semrush_domain_proc............... [RUN]
2018-02-06 13:09:55,082: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:09:55,081: 13:09:55 | 5 of 26 START view model seo_audit.majestic_domain_proc.............. [RUN]
2018-02-06 13:09:55,087: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:09:55,081: 13:09:55 | 6 of 26 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 13:09:55,087: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:09:55,082: 13:09:55 | 7 of 26 START view model seo_audit.search_console_proc............... [RUN]
2018-02-06 13:09:55,087: Compiling model.seo_audit.moz_proc
2018-02-06 13:09:55,092: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:09:55,092: Compiling model.seo_audit.search_console_proc
2018-02-06 13:09:55,096: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:09:55,097: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:09:55,104: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:09:55,105: Re-using an available connection from the pool.
2018-02-06 13:09:55,106: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:09:55,106: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:09:55,107: Re-using an available connection from the pool.
2018-02-06 13:09:55,109: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:09:55,110: Re-using an available connection from the pool.
2018-02-06 13:09:55,112: Opening a new connection (4 currently allocated)
2018-02-06 13:09:55,305: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:09:55,332: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:09:55,358: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:09:55,524: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:09:55,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:09:55,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9aa198>]}
2018-02-06 13:09:55,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:09:55,792: 13:09:55 | 5 of 26 OK created view model seo_audit.majestic_domain_proc......... [CREATE VIEW in 0.51s]
2018-02-06 13:09:55,793: 13:09:55 | 8 of 26 START view model seo_audit.semrush_keyword_proc.............. [RUN]
2018-02-06 13:09:55,794: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:09:55,799: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:09:55,800: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:09:55,801: Re-using an available connection from the pool.
2018-02-06 13:09:55,844: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9aa940>]}
2018-02-06 13:09:55,990: 13:09:55 | 6 of 26 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 0.55s]
2018-02-06 13:09:55,991: 13:09:55 | 9 of 26 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:09:55,993: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:09:55,998: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:09:56,001: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:09:56,003: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:09:56,004: Re-using an available connection from the pool.
2018-02-06 13:09:56,194: 13:09:56 | 4 of 26 OK created view model seo_audit.semrush_domain_proc.......... [CREATE VIEW in 0.56s]
2018-02-06 13:09:56,195: 13:09:56 | 10 of 26 START view model seo_audit.sitemap_proc..................... [RUN]
2018-02-06 13:09:56,195: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:09:56,200: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:09:56,203: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:09:56,203: Re-using an available connection from the pool.
2018-02-06 13:09:56,214: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:09:56,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:09:56,389: 13:09:56 | 7 of 26 OK created view model seo_audit.search_console_proc.......... [CREATE VIEW in 0.75s]
2018-02-06 13:09:56,390: 13:09:56 | 11 of 26 START view model seo_audit.mappings_ga_proc................. [RUN]
2018-02-06 13:09:56,390: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:09:56,396: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:09:56,397: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:09:56,400: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:09:56,401: Re-using an available connection from the pool.
2018-02-06 13:09:56,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9aacc0>]}
2018-02-06 13:09:56,595: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:09:56,597: 13:09:56 | 8 of 26 OK created view model seo_audit.semrush_keyword_proc......... [CREATE VIEW in 0.50s]
2018-02-06 13:09:56,599: 13:09:56 | 12 of 26 START view model seo_audit.ga_proc.......................... [RUN]
2018-02-06 13:09:56,599: Compiling model.seo_audit.ga_proc
2018-02-06 13:09:56,611: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:09:56,612: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:09:56,612: Re-using an available connection from the pool.
2018-02-06 13:09:56,662: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:09:56,801: 13:09:56 | 9 of 26 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.50s]
2018-02-06 13:09:56,819: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:09:56,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9aa940>]}
2018-02-06 13:09:56,988: 13:09:56 | 10 of 26 OK created view model seo_audit.sitemap_proc................ [CREATE VIEW in 0.47s]
2018-02-06 13:09:57,087: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:09:57,265: 13:09:57 | 11 of 26 OK created view model seo_audit.mappings_ga_proc............ [CREATE VIEW in 0.47s]
2018-02-06 13:09:57,457: 13:09:57 | 12 of 26 OK created view model seo_audit.ga_proc..................... [CREATE VIEW in 0.49s]
2018-02-06 13:09:57,458: 13:09:57 | 13 of 26 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:09:57,458: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:09:57,462: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:09:57,462: 13:09:57 | 14 of 26 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:09:57,462: 13:09:57 | 15 of 26 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:09:57,462: 13:09:57 | 16 of 26 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:09:57,462: Compiling model.seo_audit.search_console_history
2018-02-06 13:09:57,462: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:09:57,463: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:09:57,466: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:09:57,472: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:09:57,473: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:09:57,480: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:09:57,482: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:09:57,482: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:09:57,483: Re-using an available connection from the pool.
2018-02-06 13:09:57,483: Re-using an available connection from the pool.
2018-02-06 13:09:57,486: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:09:57,486: Re-using an available connection from the pool.
2018-02-06 13:09:57,489: Re-using an available connection from the pool.
2018-02-06 13:09:57,665: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:09:57,673: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:09:57,676: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:09:57,695: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:09:57,942: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:09:57,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba43c88>]}
2018-02-06 13:09:57,993: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba2fe80>]}
2018-02-06 13:09:58,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba54550>]}
2018-02-06 13:09:58,162: 13:09:58 | 13 of 26 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.48s]
2018-02-06 13:09:58,163: 13:09:58 | 17 of 26 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:09:58,163: Compiling model.seo_audit.ga_stats
2018-02-06 13:09:58,167: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:09:58,384: 13:09:58 | 14 of 26 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.51s]
2018-02-06 13:09:58,562: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:09:58,562: Re-using an available connection from the pool.
2018-02-06 13:09:58,577: 13:09:58 | 16 of 26 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.53s]
2018-02-06 13:09:58,768: 13:09:58 | 15 of 26 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.55s]
2018-02-06 13:09:58,778: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:09:59,128: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:09:59,328: 13:09:59 | 17 of 26 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.97s]
2018-02-06 13:09:59,328: 13:09:59 | 18 of 26 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:09:59,328: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:09:59,332: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:09:59,328: 13:09:59 | 19 of 26 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:09:59,333: Compiling model.seo_audit.agg_indicative
2018-02-06 13:09:59,328: 13:09:59 | 20 of 26 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:09:59,337: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:09:59,337: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:09:59,342: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:09:59,342: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:09:59,343: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:09:59,343: Re-using an available connection from the pool.
2018-02-06 13:09:59,344: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:09:59,344: Re-using an available connection from the pool.
2018-02-06 13:09:59,345: Re-using an available connection from the pool.
2018-02-06 13:09:59,517: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:09:59,528: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:09:59,532: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:09:59,838: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba59ef0>]}
2018-02-06 13:09:59,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba54160>]}
2018-02-06 13:09:59,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:10:00,032: 13:10:00 | 19 of 26 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.51s]
2018-02-06 13:10:00,222: 13:10:00 | 20 of 26 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.50s]
2018-02-06 13:10:00,433: 13:10:00 | 18 of 26 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.53s]
2018-02-06 13:10:00,433: 13:10:00 | 21 of 26 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:10:00,434: 13:10:00 | 22 of 26 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:10:00,434: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:10:00,434: 13:10:00 | 23 of 26 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:10:00,434: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:10:00,438: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:10:00,438: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:10:00,442: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:10:00,447: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:10:00,448: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:10:00,448: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:10:00,448: Re-using an available connection from the pool.
2018-02-06 13:10:00,449: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:10:00,450: Re-using an available connection from the pool.
2018-02-06 13:10:00,451: Re-using an available connection from the pool.
2018-02-06 13:10:00,635: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:10:00,643: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:10:00,649: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:10:01,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9ea320>]}
2018-02-06 13:10:01,045: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba54550>]}
2018-02-06 13:10:01,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:10:01,228: 13:10:01 | 22 of 26 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.60s]
2018-02-06 13:10:01,424: 13:10:01 | 23 of 26 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.61s]
2018-02-06 13:10:01,613: 13:10:01 | 21 of 26 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.64s]
2018-02-06 13:10:01,614: 13:10:01 | 24 of 26 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:10:01,614: Compiling model.seo_audit.agg_stats
2018-02-06 13:10:01,620: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:10:01,621: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:10:01,621: Re-using an available connection from the pool.
2018-02-06 13:10:01,831: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:10:02,376: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:10:02,572: 13:10:02 | 24 of 26 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.76s]
2018-02-06 13:10:02,573: 13:10:02 | 25 of 26 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:10:02,573: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:10:02,578: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:10:02,579: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:10:02,579: Re-using an available connection from the pool.
2018-02-06 13:10:02,776: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:10:03,345: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b973080>]}
2018-02-06 13:10:03,535: 13:10:03 | 25 of 26 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.77s]
2018-02-06 13:10:03,536: 13:10:03 | 26 of 26 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:10:03,536: Compiling model.seo_audit.agg_all
2018-02-06 13:10:03,541: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:10:03,541: Acquiring new bigquery connection "agg_all".
2018-02-06 13:10:03,542: Re-using an available connection from the pool.
2018-02-06 13:10:03,727: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:10:04,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd986eea-fd91-4b9e-bc92-17a071bae8dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b95def0>]}
2018-02-06 13:10:04,652: 13:10:04 | 26 of 26 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.90s]
2018-02-06 13:10:04,737: 13:10:04 | 
2018-02-06 13:10:04,737: 13:10:04 | Finished running 26 view models in 11.06s.
2018-02-06 13:10:04,737: Connection 'master' was left open.
2018-02-06 13:10:04,737: 
2018-02-06 13:10:04,737: Completed successfully
2018-02-06 13:10:04,737: 
Done. PASS=26 ERROR=0 SKIP=0 TOTAL=26
2018-02-06 13:10:04,737: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b96fe48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b94a6d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b94a7b8>]}
2018-02-06 13:10:04,933: Flushing usage events
2018-02-06 13:18:56,483: Tracking: tracking
2018-02-06 13:18:56,484: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e54cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e54e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e54f98>]}
2018-02-06 13:18:57,107: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:18:57,118: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:18:57,119: Parsing core.sql
2018-02-06 13:18:57,131: Parsing adapters/bigquery.sql
2018-02-06 13:18:57,134: Parsing adapters/common.sql
2018-02-06 13:18:57,146: Parsing adapters/postgres.sql
2018-02-06 13:18:57,149: Parsing adapters/redshift.sql
2018-02-06 13:18:57,164: Parsing etc/get_custom_schema.sql
2018-02-06 13:18:57,169: Parsing materializations/archive.sql
2018-02-06 13:18:57,194: Parsing materializations/bigquery.sql
2018-02-06 13:18:57,205: Parsing materializations/helpers.sql
2018-02-06 13:18:57,220: Parsing materializations/incremental.sql
2018-02-06 13:18:57,242: Parsing materializations/table.sql
2018-02-06 13:18:57,258: Parsing materializations/view.sql
2018-02-06 13:18:57,270: Parsing materializations/wrapper.sql
2018-02-06 13:18:57,273: Parsing schema_tests/accepted_values.sql
2018-02-06 13:18:57,275: Parsing schema_tests/not_null.sql
2018-02-06 13:18:57,277: Parsing schema_tests/relationships.sql
2018-02-06 13:18:57,279: Parsing schema_tests/unique.sql
2018-02-06 13:18:57,285: Parsing model.seo_audit.accounts_proc
2018-02-06 13:18:57,287: Parsing model.seo_audit.all_dates
2018-02-06 13:18:57,288: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:18:57,290: Acquiring new bigquery connection "master".
2018-02-06 13:18:57,290: Opening a new connection (0 currently allocated)
2018-02-06 13:18:57,291: Parsing model.seo_audit.agg_all
2018-02-06 13:18:57,293: Parsing model.seo_audit.agg_indicative
2018-02-06 13:18:57,295: Parsing model.seo_audit.agg_stats
2018-02-06 13:18:57,299: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:18:57,302: Parsing model.seo_audit.deepcrawl_class
2018-02-06 13:18:57,303: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:18:57,305: Parsing model.seo_audit.ga_proc
2018-02-06 13:18:57,307: Parsing model.seo_audit.ga_stats
2018-02-06 13:18:57,309: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:18:57,310: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:18:57,312: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:18:57,314: Parsing model.seo_audit.moz_proc
2018-02-06 13:18:57,316: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:18:57,319: Parsing model.seo_audit.search_console_history
2018-02-06 13:18:57,321: Parsing model.seo_audit.search_console_proc
2018-02-06 13:18:57,323: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:18:57,325: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:18:57,327: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:18:57,329: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:18:57,331: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:18:57,334: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:18:57,335: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:18:57,337: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:18:57,339: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:18:57,348: Found 27 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:18:57,354: 
2018-02-06 13:18:58,448: 13:18:58 | Concurrency: 4 threads (target='prod')
2018-02-06 13:18:58,448: 13:18:58 | 
2018-02-06 13:18:58,622: 13:18:58 | 1 of 27 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:18:58,622: 13:18:58 | 2 of 27 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:18:58,623: Compiling model.seo_audit.accounts_proc
2018-02-06 13:18:58,623: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:18:58,622: 13:18:58 | 3 of 27 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:18:58,629: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:18:58,634: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:18:58,634: Compiling model.seo_audit.all_dates
2018-02-06 13:18:58,638: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:18:58,639: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:18:58,639: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:18:58,639: Opening a new connection (1 currently allocated)
2018-02-06 13:18:58,640: Acquiring new bigquery connection "all_dates".
2018-02-06 13:18:58,642: Opening a new connection (2 currently allocated)
2018-02-06 13:18:58,691: Opening a new connection (3 currently allocated)
2018-02-06 13:18:59,131: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:18:59,193: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_match(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:18:59,216: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:18:59,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fc1a20>]}
2018-02-06 13:18:59,353: Bad request while running:
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_match(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:18:59,353: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables: Function not found: regexp_match at [23:11]
2018-02-06 13:18:59,354: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ff7208>]}
2018-02-06 13:18:59,439: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ff7ef0>]}
2018-02-06 13:18:59,521: 13:18:59 | 3 of 27 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.68s]
2018-02-06 13:18:59,719: 13:18:59 | 2 of 27 ERROR creating view model seo_audit.deepcrawl_proc........... [ERROR in 0.73s]
2018-02-06 13:18:59,910: 13:18:59 | 1 of 27 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.82s]
2018-02-06 13:18:59,910: 13:18:59 | 4 of 27 START view model seo_audit.ga_proc........................... [RUN]
2018-02-06 13:18:59,910: Compiling model.seo_audit.ga_proc
2018-02-06 13:18:59,915: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:18:59,915: 13:18:59 | 5 of 27 START view model seo_audit.semrush_keyword_proc.............. [RUN]
2018-02-06 13:18:59,915: 13:18:59 | 6 of 27 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 13:18:59,916: 13:18:59 | 7 of 27 START view model seo_audit.sitemap_proc...................... [RUN]
2018-02-06 13:18:59,916: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:18:59,916: Compiling model.seo_audit.moz_proc
2018-02-06 13:18:59,916: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:18:59,921: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:18:59,925: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:18:59,925: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:18:59,932: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:18:59,933: Re-using an available connection from the pool.
2018-02-06 13:18:59,933: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:18:59,934: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:18:59,937: Re-using an available connection from the pool.
2018-02-06 13:18:59,938: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:18:59,939: Re-using an available connection from the pool.
2018-02-06 13:18:59,941: Opening a new connection (4 currently allocated)
2018-02-06 13:19:00,130: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:19:00,192: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:19:00,193: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:19:00,369: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:19:00,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10701a898>]}
2018-02-06 13:19:00,476: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10701aa20>]}
2018-02-06 13:19:00,627: 13:19:00 | 4 of 27 OK created view model seo_audit.ga_proc...................... [CREATE VIEW in 0.53s]
2018-02-06 13:19:00,628: 13:19:00 | 8 of 27 START view model seo_audit.semrush_domain_proc............... [RUN]
2018-02-06 13:19:00,629: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:19:00,633: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:19:00,635: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:19:00,635: Re-using an available connection from the pool.
2018-02-06 13:19:00,829: 13:19:00 | 6 of 27 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 0.56s]
2018-02-06 13:19:00,829: 13:19:00 | 9 of 27 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:19:00,829: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:19:00,834: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:19:00,835: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:19:00,835: Re-using an available connection from the pool.
2018-02-06 13:19:01,708: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:19:01,884: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10702a4e0>]}
2018-02-06 13:19:02,053: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:19:02,072: 13:19:02 | 7 of 27 OK created view model seo_audit.sitemap_proc................. [CREATE VIEW in 1.97s]
2018-02-06 13:19:02,072: 13:19:02 | 10 of 27 START view model seo_audit.majestic_domain_proc............. [RUN]
2018-02-06 13:19:02,072: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:19:02,077: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:19:02,078: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:19:02,078: Re-using an available connection from the pool.
2018-02-06 13:19:02,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f567b8>]}
2018-02-06 13:19:02,269: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10701aa20>]}
2018-02-06 13:19:02,276: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:19:02,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10701a898>]}
2018-02-06 13:19:02,343: 13:19:02 | 5 of 27 OK created view model seo_audit.semrush_keyword_proc......... [CREATE VIEW in 2.22s]
2018-02-06 13:19:02,345: 13:19:02 | 11 of 27 START view model seo_audit.screamingfrog_proc............... [RUN]
2018-02-06 13:19:02,346: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:19:02,351: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:19:02,352: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:19:02,352: Re-using an available connection from the pool.
2018-02-06 13:19:02,541: 13:19:02 | 9 of 27 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 1.44s]
2018-02-06 13:19:02,542: 13:19:02 | 12 of 27 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-06 13:19:02,542: 13:19:02 | 13 of 27 START view model seo_audit.search_console_proc.............. [RUN]
2018-02-06 13:19:02,543: Compiling model.seo_audit.search_console_proc
2018-02-06 13:19:02,548: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:19:02,550: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:19:02,550: Re-using an available connection from the pool.
2018-02-06 13:19:02,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10702a4e0>]}
2018-02-06 13:19:02,578: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:19:02,743: 13:19:02 | 8 of 27 OK created view model seo_audit.semrush_domain_proc.......... [CREATE VIEW in 1.70s]
2018-02-06 13:19:02,756: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:19:02,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f567b8>]}
2018-02-06 13:19:02,933: 13:19:02 | 10 of 27 OK created view model seo_audit.majestic_domain_proc........ [CREATE VIEW in 0.48s]
2018-02-06 13:19:03,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10701acc0>]}
2018-02-06 13:19:03,124: 13:19:03 | 11 of 27 OK created view model seo_audit.screamingfrog_proc.......... [CREATE VIEW in 0.52s]
2018-02-06 13:19:03,307: 13:19:03 | 13 of 27 OK created view model seo_audit.search_console_proc......... [CREATE VIEW in 0.56s]
2018-02-06 13:19:03,308: 13:19:03 | 14 of 27 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:19:03,308: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:19:03,312: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:19:03,308: 13:19:03 | 15 of 27 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:19:03,312: Compiling model.seo_audit.search_console_history
2018-02-06 13:19:03,316: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:19:03,308: 13:19:03 | 16 of 27 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:19:03,308: 13:19:03 | 17 of 27 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:19:03,316: Compiling model.seo_audit.ga_stats
2018-02-06 13:19:03,318: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:19:03,318: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:19:03,319: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:19:03,323: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:19:03,323: Re-using an available connection from the pool.
2018-02-06 13:19:03,331: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:19:03,332: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:19:03,333: Re-using an available connection from the pool.
2018-02-06 13:19:03,335: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:19:03,336: Re-using an available connection from the pool.
2018-02-06 13:19:03,338: Re-using an available connection from the pool.
2018-02-06 13:19:03,526: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:19:03,532: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:19:03,534: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:19:03,553: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:19:04,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ff7400>]}
2018-02-06 13:19:04,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10702ab70>]}
2018-02-06 13:19:04,048: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fa9278>]}
2018-02-06 13:19:04,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f567b8>]}
2018-02-06 13:19:04,190: 13:19:04 | 17 of 27 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.68s]
2018-02-06 13:19:04,190: 13:19:04 | 18 of 27 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:19:04,191: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:19:04,195: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:19:04,197: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:19:04,198: Re-using an available connection from the pool.
2018-02-06 13:19:04,391: 13:19:04 | 15 of 27 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.73s]
2018-02-06 13:19:04,589: 13:19:04 | 14 of 27 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.74s]
2018-02-06 13:19:04,606: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:19:04,788: 13:19:04 | 16 of 27 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.75s]
2018-02-06 13:19:04,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107031a58>]}
2018-02-06 13:19:05,148: 13:19:05 | 18 of 27 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.77s]
2018-02-06 13:19:05,149: 13:19:05 | 19 of 27 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:19:05,149: Compiling model.seo_audit.agg_indicative
2018-02-06 13:19:05,149: 13:19:05 | 20 of 27 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:19:05,154: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:19:05,149: 13:19:05 | 21 of 27 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:19:05,154: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:19:05,154: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:19:05,159: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:19:05,164: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:19:05,165: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:19:05,166: Re-using an available connection from the pool.
2018-02-06 13:19:05,167: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:19:05,168: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:19:05,168: Re-using an available connection from the pool.
2018-02-06 13:19:05,171: Re-using an available connection from the pool.
2018-02-06 13:19:05,362: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:19:05,393: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:19:05,473: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:19:05,690: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ffe940>]}
2018-02-06 13:19:05,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f74080>]}
2018-02-06 13:19:05,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ffe588>]}
2018-02-06 13:19:05,887: 13:19:05 | 20 of 27 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.54s]
2018-02-06 13:19:06,072: 13:19:06 | 19 of 27 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.56s]
2018-02-06 13:19:06,260: 13:19:06 | 21 of 27 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.70s]
2018-02-06 13:19:06,261: 13:19:06 | 22 of 27 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:19:06,261: 13:19:06 | 23 of 27 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:19:06,261: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:19:06,261: 13:19:06 | 24 of 27 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:19:06,261: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:19:06,265: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:19:06,265: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:19:06,269: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:19:06,274: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:19:06,275: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:19:06,275: Re-using an available connection from the pool.
2018-02-06 13:19:06,277: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:19:06,277: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:19:06,277: Re-using an available connection from the pool.
2018-02-06 13:19:06,278: Re-using an available connection from the pool.
2018-02-06 13:19:06,453: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:19:06,539: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:19:06,544: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:19:06,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107051fd0>]}
2018-02-06 13:19:06,859: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f8def0>]}
2018-02-06 13:19:06,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f450f0>]}
2018-02-06 13:19:07,008: 13:19:07 | 23 of 27 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.55s]
2018-02-06 13:19:07,193: 13:19:07 | 24 of 27 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.59s]
2018-02-06 13:19:07,389: 13:19:07 | 22 of 27 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.70s]
2018-02-06 13:19:07,390: 13:19:07 | 25 of 27 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:19:07,390: Compiling model.seo_audit.agg_stats
2018-02-06 13:19:07,397: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:19:07,398: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:19:07,398: Re-using an available connection from the pool.
2018-02-06 13:19:07,630: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:19:08,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107025eb8>]}
2018-02-06 13:19:08,405: 13:19:08 | 25 of 27 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.83s]
2018-02-06 13:19:08,406: 13:19:08 | 26 of 27 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:19:08,406: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:19:08,410: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:19:08,411: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:19:08,411: Re-using an available connection from the pool.
2018-02-06 13:19:08,603: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:19:09,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f450f0>]}
2018-02-06 13:19:09,501: 13:19:09 | 26 of 27 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.90s]
2018-02-06 13:19:09,501: 13:19:09 | 27 of 27 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:19:09,501: Compiling model.seo_audit.agg_all
2018-02-06 13:19:09,506: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:19:09,507: Acquiring new bigquery connection "agg_all".
2018-02-06 13:19:09,507: Re-using an available connection from the pool.
2018-02-06 13:19:09,687: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:19:10,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e1db4d0-e6e0-4d39-9750-450c60baf481', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107025eb8>]}
2018-02-06 13:19:10,588: 13:19:10 | 27 of 27 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.89s]
2018-02-06 13:19:10,623: 13:19:10 | 
2018-02-06 13:19:10,623: 13:19:10 | Finished running 27 view models in 12.18s.
2018-02-06 13:19:10,623: Connection 'master' was left open.
2018-02-06 13:19:10,624: 
2018-02-06 13:19:10,624: Completed with 1 errors:
2018-02-06 13:19:10,624: 
2018-02-06 13:19:10,624: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-06 13:19:10,624:   Function not found: regexp_match at [23:11]
2018-02-06 13:19:10,624:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-02-06 13:19:10,624: 
Done. PASS=25 ERROR=1 SKIP=1 TOTAL=27
2018-02-06 13:19:10,624: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f1f7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f1fac8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f1f780>]}
2018-02-06 13:19:10,841: Flushing usage events
2018-02-06 13:20:32,406: Tracking: tracking
2018-02-06 13:20:32,426: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd1eb38>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd1ef60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd1eef0>]}
2018-02-06 13:20:33,575: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:20:33,588: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:20:33,599: Parsing core.sql
2018-02-06 13:20:33,646: Parsing adapters/bigquery.sql
2018-02-06 13:20:33,657: Parsing adapters/common.sql
2018-02-06 13:20:33,681: Parsing adapters/postgres.sql
2018-02-06 13:20:33,710: Parsing adapters/redshift.sql
2018-02-06 13:20:33,740: Parsing etc/get_custom_schema.sql
2018-02-06 13:20:33,746: Parsing materializations/archive.sql
2018-02-06 13:20:33,804: Parsing materializations/bigquery.sql
2018-02-06 13:20:33,831: Parsing materializations/helpers.sql
2018-02-06 13:20:33,878: Parsing materializations/incremental.sql
2018-02-06 13:20:33,930: Parsing materializations/table.sql
2018-02-06 13:20:33,986: Parsing materializations/view.sql
2018-02-06 13:20:34,008: Parsing materializations/wrapper.sql
2018-02-06 13:20:34,012: Parsing schema_tests/accepted_values.sql
2018-02-06 13:20:34,025: Parsing schema_tests/not_null.sql
2018-02-06 13:20:34,055: Parsing schema_tests/relationships.sql
2018-02-06 13:20:34,064: Parsing schema_tests/unique.sql
2018-02-06 13:20:34,184: Parsing model.seo_audit.accounts_proc
2018-02-06 13:20:34,188: Parsing model.seo_audit.all_dates
2018-02-06 13:20:34,191: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:20:34,196: Acquiring new bigquery connection "master".
2018-02-06 13:20:34,196: Opening a new connection (0 currently allocated)
2018-02-06 13:20:34,214: Parsing model.seo_audit.agg_all
2018-02-06 13:20:34,217: Parsing model.seo_audit.agg_indicative
2018-02-06 13:20:34,219: Parsing model.seo_audit.agg_stats
2018-02-06 13:20:34,224: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:20:34,227: Parsing model.seo_audit.deepcrawl_class
2018-02-06 13:20:34,229: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:20:34,231: Parsing model.seo_audit.ga_proc
2018-02-06 13:20:34,235: Parsing model.seo_audit.ga_stats
2018-02-06 13:20:34,239: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:20:34,243: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:20:34,246: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:20:34,248: Parsing model.seo_audit.moz_proc
2018-02-06 13:20:34,251: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:20:34,257: Parsing model.seo_audit.search_console_history
2018-02-06 13:20:34,258: Parsing model.seo_audit.search_console_proc
2018-02-06 13:20:34,261: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:20:34,264: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:20:34,265: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:20:34,268: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:20:34,270: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:20:34,273: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:20:34,274: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:20:34,279: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:20:34,282: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:20:34,294: Found 27 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:20:34,300: 
2018-02-06 13:20:35,385: 13:20:35 | Concurrency: 4 threads (target='prod')
2018-02-06 13:20:35,385: 13:20:35 | 
2018-02-06 13:20:35,569: 13:20:35 | 1 of 27 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:20:35,569: Compiling model.seo_audit.accounts_proc
2018-02-06 13:20:35,569: 13:20:35 | 2 of 27 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:20:35,576: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:20:35,569: 13:20:35 | 3 of 27 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:20:35,576: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:20:35,577: Compiling model.seo_audit.all_dates
2018-02-06 13:20:35,584: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:20:35,591: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:20:35,593: Opening a new connection (1 currently allocated)
2018-02-06 13:20:35,591: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:20:35,594: Acquiring new bigquery connection "all_dates".
2018-02-06 13:20:35,592: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:20:35,652: Opening a new connection (2 currently allocated)
2018-02-06 13:20:35,654: Opening a new connection (3 currently allocated)
2018-02-06 13:20:36,042: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_cur_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_cur_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_cur_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:20:36,123: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:20:36,128: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:20:36,272: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe4aa90>]}
2018-02-06 13:20:36,287: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fec2eb8>]}
2018-02-06 13:20:36,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fec2978>]}
2018-02-06 13:20:36,465: 13:20:36 | 2 of 27 OK created view model seo_audit.deepcrawl_proc............... [CREATE VIEW in 0.70s]
2018-02-06 13:20:36,661: 13:20:36 | 3 of 27 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.71s]
2018-02-06 13:20:36,930: 13:20:36 | 1 of 27 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.74s]
2018-02-06 13:20:36,931: 13:20:36 | 4 of 27 START view model seo_audit.sitemap_proc...................... [RUN]
2018-02-06 13:20:36,931: 13:20:36 | 5 of 27 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 13:20:36,931: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:20:36,931: 13:20:36 | 6 of 27 START view model seo_audit.deepcrawl_class................... [RUN]
2018-02-06 13:20:36,931: 13:20:36 | 7 of 27 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:20:36,931: Compiling model.seo_audit.moz_proc
2018-02-06 13:20:36,936: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:20:36,937: Compiling model.seo_audit.deepcrawl_class
2018-02-06 13:20:36,937: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:20:36,941: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:20:36,945: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 13:20:36,950: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:20:36,954: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:20:36,954: Re-using an available connection from the pool.
2018-02-06 13:20:36,955: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:20:36,955: Re-using an available connection from the pool.
2018-02-06 13:20:36,956: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 13:20:36,957: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:20:36,957: Re-using an available connection from the pool.
2018-02-06 13:20:36,958: Opening a new connection (4 currently allocated)
2018-02-06 13:20:37,037: Model SQL (deepcrawl_class):
SELECT 
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_cur_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	word_count,
	header_content_type,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_cur_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
)
2018-02-06 13:20:37,162: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:20:37,201: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:20:37,267: Bad request while running:
SELECT 
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_cur_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	word_count,
	header_content_type,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_cur_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
)
2018-02-06 13:20:37,268: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables: Unrecognized name: flag_below_avg_prices; Did you mean flag_below_avg_cur_prices? at [28:63]
2018-02-06 13:20:37,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff18f98>]}
2018-02-06 13:20:37,359: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:20:37,412: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:37,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fec2128>]}
2018-02-06 13:20:37,458: 13:20:37 | 6 of 27 ERROR creating view model seo_audit.deepcrawl_class.......... [ERROR in 0.33s]
2018-02-06 13:20:37,459: 13:20:37 | 8 of 27 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:20:37,459: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:20:37,464: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:20:37,466: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:20:37,466: Re-using an available connection from the pool.
2018-02-06 13:20:37,663: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:20:37,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe4aa90>]}
2018-02-06 13:20:37,689: 13:20:37 | 4 of 27 OK created view model seo_audit.sitemap_proc................. [CREATE VIEW in 0.48s]
2018-02-06 13:20:37,690: 13:20:37 | 9 of 27 START view model seo_audit.search_console_proc............... [RUN]
2018-02-06 13:20:37,691: Compiling model.seo_audit.search_console_proc
2018-02-06 13:20:37,696: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:20:37,698: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:20:37,698: Re-using an available connection from the pool.
2018-02-06 13:20:37,887: 13:20:37 | 7 of 27 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 0.51s]
2018-02-06 13:20:37,888: 13:20:37 | 10 of 27 START view model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-06 13:20:37,888: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:20:37,892: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:20:37,894: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:20:37,895: Re-using an available connection from the pool.
2018-02-06 13:20:37,900: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:20:37,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe66160>]}
2018-02-06 13:20:38,071: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:20:38,077: 13:20:38 | 5 of 27 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 0.74s]
2018-02-06 13:20:38,078: 13:20:38 | 11 of 27 START view model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-06 13:20:38,078: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:20:38,083: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:20:38,085: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:20:38,085: Re-using an available connection from the pool.
2018-02-06 13:20:38,154: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:38,252: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:20:38,267: 13:20:38 | 8 of 27 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.45s]
2018-02-06 13:20:38,268: 13:20:38 | 12 of 27 START view model seo_audit.majestic_domain_proc............. [RUN]
2018-02-06 13:20:38,269: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:20:38,274: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:20:38,276: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:20:38,276: Re-using an available connection from the pool.
2018-02-06 13:20:38,321: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59c88>]}
2018-02-06 13:20:38,462: 13:20:38 | 9 of 27 OK created view model seo_audit.search_console_proc.......... [CREATE VIEW in 0.46s]
2018-02-06 13:20:38,463: 13:20:38 | 13 of 27 START view model seo_audit.ga_proc.......................... [RUN]
2018-02-06 13:20:38,464: Compiling model.seo_audit.ga_proc
2018-02-06 13:20:38,468: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:20:38,470: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:20:38,472: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:20:38,473: Re-using an available connection from the pool.
2018-02-06 13:20:38,495: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe4aa90>]}
2018-02-06 13:20:38,644: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:20:38,692: 13:20:38 | 10 of 27 OK created view model seo_audit.semrush_domain_proc......... [CREATE VIEW in 0.43s]
2018-02-06 13:20:38,729: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe66160>]}
2018-02-06 13:20:38,893: 13:20:38 | 11 of 27 OK created view model seo_audit.semrush_keyword_proc........ [CREATE VIEW in 0.42s]
2018-02-06 13:20:38,904: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:39,087: 13:20:39 | 12 of 27 OK created view model seo_audit.majestic_domain_proc........ [CREATE VIEW in 0.46s]
2018-02-06 13:20:39,277: 13:20:39 | 13 of 27 OK created view model seo_audit.ga_proc..................... [CREATE VIEW in 0.44s]
2018-02-06 13:20:39,277: 13:20:39 | 14 of 27 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:20:39,277: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:20:39,282: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:20:39,282: 13:20:39 | 15 of 27 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:20:39,282: 13:20:39 | 16 of 27 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:20:39,282: 13:20:39 | 17 of 27 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:20:39,282: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:20:39,283: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:20:39,283: Compiling model.seo_audit.ga_stats
2018-02-06 13:20:39,283: Compiling model.seo_audit.search_console_history
2018-02-06 13:20:39,287: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:20:39,287: Re-using an available connection from the pool.
2018-02-06 13:20:39,291: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:20:39,297: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:20:39,299: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:20:39,300: Re-using an available connection from the pool.
2018-02-06 13:20:39,301: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:20:39,302: Re-using an available connection from the pool.
2018-02-06 13:20:39,303: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:20:39,305: Re-using an available connection from the pool.
2018-02-06 13:20:39,482: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:20:39,483: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:20:39,483: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:20:39,490: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:20:39,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff18b00>]}
2018-02-06 13:20:39,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59c88>]}
2018-02-06 13:20:39,795: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdf8390>]}
2018-02-06 13:20:39,798: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fef7710>]}
2018-02-06 13:20:39,913: 13:20:39 | 16 of 27 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.44s]
2018-02-06 13:20:39,914: 13:20:39 | 18 of 27 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:20:39,914: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:20:39,918: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:20:39,921: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:20:39,921: Re-using an available connection from the pool.
2018-02-06 13:20:40,098: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:20:40,103: 13:20:40 | 17 of 27 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.48s]
2018-02-06 13:20:40,291: 13:20:40 | 14 of 27 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.52s]
2018-02-06 13:20:40,407: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:40,478: 13:20:40 | 15 of 27 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.52s]
2018-02-06 13:20:40,672: 13:20:40 | 18 of 27 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.49s]
2018-02-06 13:20:40,672: 13:20:40 | 19 of 27 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:20:40,672: 13:20:40 | 20 of 27 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:20:40,673: 13:20:40 | 21 of 27 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:20:40,673: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:20:40,673: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:20:40,673: Compiling model.seo_audit.agg_indicative
2018-02-06 13:20:40,677: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:20:40,681: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:20:40,685: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:20:40,686: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:20:40,686: Re-using an available connection from the pool.
2018-02-06 13:20:40,688: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:20:40,688: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:20:40,688: Re-using an available connection from the pool.
2018-02-06 13:20:40,689: Re-using an available connection from the pool.
2018-02-06 13:20:40,857: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:20:40,858: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:20:40,879: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:20:41,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:41,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdf81d0>]}
2018-02-06 13:20:41,209: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fef7898>]}
2018-02-06 13:20:41,351: 13:20:41 | 20 of 27 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.49s]
2018-02-06 13:20:41,550: 13:20:41 | 19 of 27 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.52s]
2018-02-06 13:20:41,734: 13:20:41 | 21 of 27 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.54s]
2018-02-06 13:20:41,735: 13:20:41 | 22 of 27 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:20:41,735: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:20:41,739: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:20:41,735: 13:20:41 | 23 of 27 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:20:41,740: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:20:41,744: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:20:41,735: 13:20:41 | 24 of 27 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:20:41,744: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:20:41,749: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:20:41,749: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:20:41,750: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:20:41,750: Re-using an available connection from the pool.
2018-02-06 13:20:41,750: Re-using an available connection from the pool.
2018-02-06 13:20:41,753: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:20:41,756: Re-using an available connection from the pool.
2018-02-06 13:20:41,923: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:20:41,933: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:20:41,952: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:20:42,261: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdf8390>]}
2018-02-06 13:20:42,265: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fef7710>]}
2018-02-06 13:20:42,286: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fef4320>]}
2018-02-06 13:20:42,446: 13:20:42 | 22 of 27 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.53s]
2018-02-06 13:20:42,635: 13:20:42 | 23 of 27 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.53s]
2018-02-06 13:20:42,827: 13:20:42 | 24 of 27 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.54s]
2018-02-06 13:20:42,827: 13:20:42 | 25 of 27 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:20:42,827: Compiling model.seo_audit.agg_stats
2018-02-06 13:20:42,834: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:20:42,834: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:20:42,835: Re-using an available connection from the pool.
2018-02-06 13:20:43,041: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:20:43,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:43,821: 13:20:43 | 25 of 27 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.76s]
2018-02-06 13:20:43,821: 13:20:43 | 26 of 27 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:20:43,821: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:20:43,826: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:20:43,826: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:20:43,826: Re-using an available connection from the pool.
2018-02-06 13:20:44,002: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:20:44,574: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fef4320>]}
2018-02-06 13:20:44,761: 13:20:44 | 26 of 27 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.75s]
2018-02-06 13:20:44,762: 13:20:44 | 27 of 27 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:20:44,762: Compiling model.seo_audit.agg_all
2018-02-06 13:20:44,767: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:20:44,767: Acquiring new bigquery connection "agg_all".
2018-02-06 13:20:44,767: Re-using an available connection from the pool.
2018-02-06 13:20:44,977: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:20:45,749: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a71d5b4-0ab5-4270-89ec-b377d5dfb2ff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe59a90>]}
2018-02-06 13:20:45,936: 13:20:45 | 27 of 27 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.99s]
2018-02-06 13:20:45,947: 13:20:45 | 
2018-02-06 13:20:45,947: 13:20:45 | Finished running 27 view models in 10.56s.
2018-02-06 13:20:45,947: Connection 'master' was left open.
2018-02-06 13:20:45,947: 
2018-02-06 13:20:45,947: Completed with 1 errors:
2018-02-06 13:20:45,947: 
2018-02-06 13:20:45,947: Database Error in model deepcrawl_class (models/base-adp/deepcrawl/deepcrawl_class.sql)
2018-02-06 13:20:45,947:   Unrecognized name: flag_below_avg_prices; Did you mean flag_below_avg_cur_prices? at [28:63]
2018-02-06 13:20:45,948:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class.sql
2018-02-06 13:20:45,948: 
Done. PASS=26 ERROR=1 SKIP=0 TOTAL=27
2018-02-06 13:20:45,948: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdeabe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdea908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fdeaba8>]}
2018-02-06 13:20:46,138: Flushing usage events
2018-02-06 13:26:38,608: Tracking: tracking
2018-02-06 13:26:38,623: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f2aef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f2ad30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f2af60>]}
2018-02-06 13:26:39,495: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:26:39,518: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:26:39,552: Parsing core.sql
2018-02-06 13:26:39,608: Parsing adapters/bigquery.sql
2018-02-06 13:26:39,612: Parsing adapters/common.sql
2018-02-06 13:26:39,624: Parsing adapters/postgres.sql
2018-02-06 13:26:39,640: Parsing adapters/redshift.sql
2018-02-06 13:26:39,656: Parsing etc/get_custom_schema.sql
2018-02-06 13:26:39,673: Parsing materializations/archive.sql
2018-02-06 13:26:39,700: Parsing materializations/bigquery.sql
2018-02-06 13:26:39,716: Parsing materializations/helpers.sql
2018-02-06 13:26:39,741: Parsing materializations/incremental.sql
2018-02-06 13:26:39,763: Parsing materializations/table.sql
2018-02-06 13:26:39,779: Parsing materializations/view.sql
2018-02-06 13:26:39,839: Parsing materializations/wrapper.sql
2018-02-06 13:26:39,852: Parsing schema_tests/accepted_values.sql
2018-02-06 13:26:39,866: Parsing schema_tests/not_null.sql
2018-02-06 13:26:39,939: Parsing schema_tests/relationships.sql
2018-02-06 13:26:39,994: Parsing schema_tests/unique.sql
2018-02-06 13:26:40,226: Parsing model.seo_audit.accounts_proc
2018-02-06 13:26:40,229: Parsing model.seo_audit.all_dates
2018-02-06 13:26:40,230: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:26:40,232: Acquiring new bigquery connection "master".
2018-02-06 13:26:40,232: Opening a new connection (0 currently allocated)
2018-02-06 13:26:40,260: Parsing model.seo_audit.agg_all
2018-02-06 13:26:40,262: Parsing model.seo_audit.agg_indicative
2018-02-06 13:26:40,264: Parsing model.seo_audit.agg_stats
2018-02-06 13:26:40,268: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:26:40,271: Parsing model.seo_audit.deepcrawl_class
2018-02-06 13:26:40,273: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:26:40,275: Parsing model.seo_audit.ga_proc
2018-02-06 13:26:40,277: Parsing model.seo_audit.ga_stats
2018-02-06 13:26:40,279: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:26:40,280: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:26:40,282: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:26:40,284: Parsing model.seo_audit.moz_proc
2018-02-06 13:26:40,286: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:26:40,289: Parsing model.seo_audit.search_console_history
2018-02-06 13:26:40,290: Parsing model.seo_audit.search_console_proc
2018-02-06 13:26:40,293: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:26:40,296: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:26:40,297: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:26:40,299: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:26:40,302: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:26:40,304: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:26:40,306: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:26:40,308: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:26:40,310: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:26:40,319: Found 27 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:26:40,325: 
2018-02-06 13:26:41,443: 13:26:41 | Concurrency: 4 threads (target='prod')
2018-02-06 13:26:41,443: 13:26:41 | 
2018-02-06 13:26:41,604: 13:26:41 | 1 of 27 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:26:41,604: 13:26:41 | 2 of 27 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:26:41,604: Compiling model.seo_audit.all_dates
2018-02-06 13:26:41,604: 13:26:41 | 3 of 27 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:26:41,605: Compiling model.seo_audit.accounts_proc
2018-02-06 13:26:41,608: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:26:41,608: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:26:41,612: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:26:41,616: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:26:41,617: Acquiring new bigquery connection "all_dates".
2018-02-06 13:26:41,617: Opening a new connection (1 currently allocated)
2018-02-06 13:26:41,617: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:26:41,618: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:26:41,619: Opening a new connection (2 currently allocated)
2018-02-06 13:26:41,698: Opening a new connection (3 currently allocated)
2018-02-06 13:26:42,075: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:26:42,098: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:26:42,099: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:26:42,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141d4f60>]}
2018-02-06 13:26:42,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141d4e80>]}
2018-02-06 13:26:42,326: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141744a8>]}
2018-02-06 13:26:42,444: 13:26:42 | 1 of 27 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.65s]
2018-02-06 13:26:42,647: 13:26:42 | 2 of 27 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.70s]
2018-02-06 13:26:42,835: 13:26:42 | 3 of 27 OK created view model seo_audit.deepcrawl_proc............... [CREATE VIEW in 0.72s]
2018-02-06 13:26:42,836: 13:26:42 | 4 of 27 START view model seo_audit.ga_proc........................... [RUN]
2018-02-06 13:26:42,836: 13:26:42 | 5 of 27 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:26:42,836: 13:26:42 | 6 of 27 START view model seo_audit.semrush_keyword_proc.............. [RUN]
2018-02-06 13:26:42,836: 13:26:42 | 7 of 27 START view model seo_audit.majestic_domain_proc.............. [RUN]
2018-02-06 13:26:42,836: Compiling model.seo_audit.ga_proc
2018-02-06 13:26:42,836: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:26:42,836: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:26:42,836: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:26:42,841: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:26:42,845: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:26:42,850: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:26:42,854: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:26:42,879: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:26:42,880: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:26:42,881: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:26:42,881: Re-using an available connection from the pool.
2018-02-06 13:26:42,882: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:26:42,882: Re-using an available connection from the pool.
2018-02-06 13:26:42,883: Re-using an available connection from the pool.
2018-02-06 13:26:42,886: Opening a new connection (4 currently allocated)
2018-02-06 13:26:43,079: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:26:43,099: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:26:43,105: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:26:43,289: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:26:43,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141a3390>]}
2018-02-06 13:26:43,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141fab70>]}
2018-02-06 13:26:43,411: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114202828>]}
2018-02-06 13:26:43,565: 13:26:43 | 4 of 27 OK created view model seo_audit.ga_proc...................... [CREATE VIEW in 0.54s]
2018-02-06 13:26:43,566: 13:26:43 | 8 of 27 START view model seo_audit.moz_proc.......................... [RUN]
2018-02-06 13:26:43,567: Compiling model.seo_audit.moz_proc
2018-02-06 13:26:43,572: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:26:43,574: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:26:43,574: Re-using an available connection from the pool.
2018-02-06 13:26:43,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141faac8>]}
2018-02-06 13:26:43,760: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:26:43,766: 13:26:43 | 6 of 27 OK created view model seo_audit.semrush_keyword_proc......... [CREATE VIEW in 0.56s]
2018-02-06 13:26:43,766: 13:26:43 | 9 of 27 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:26:43,766: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:26:43,771: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:26:43,773: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:26:43,774: Re-using an available connection from the pool.
2018-02-06 13:26:43,986: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:26:44,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141256d8>]}
2018-02-06 13:26:44,133: 13:26:44 | 5 of 27 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 0.57s]
2018-02-06 13:26:44,133: 13:26:44 | 10 of 27 START view model seo_audit.sitemap_proc..................... [RUN]
2018-02-06 13:26:44,133: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:26:44,138: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:26:44,140: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:26:44,141: Re-using an available connection from the pool.
2018-02-06 13:26:44,279: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141fab70>]}
2018-02-06 13:26:44,332: 13:26:44 | 7 of 27 OK created view model seo_audit.majestic_domain_proc......... [CREATE VIEW in 0.80s]
2018-02-06 13:26:44,332: 13:26:44 | 11 of 27 START view model seo_audit.search_console_proc.............. [RUN]
2018-02-06 13:26:44,332: Compiling model.seo_audit.search_console_proc
2018-02-06 13:26:44,337: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:26:44,346: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:26:44,346: Re-using an available connection from the pool.
2018-02-06 13:26:44,348: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:26:44,533: 13:26:44 | 8 of 27 OK created view model seo_audit.moz_proc..................... [CREATE VIEW in 0.43s]
2018-02-06 13:26:44,534: 13:26:44 | 12 of 27 START view model seo_audit.deepcrawl_class.................. [RUN]
2018-02-06 13:26:44,535: Compiling model.seo_audit.deepcrawl_class
2018-02-06 13:26:44,539: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 13:26:44,540: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 13:26:44,541: Re-using an available connection from the pool.
2018-02-06 13:26:44,621: Model SQL (deepcrawl_class):
SELECT 
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	word_count,
	header_content_type,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_below_avg_prices,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
)
2018-02-06 13:26:44,647: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:26:44,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114224278>]}
2018-02-06 13:26:44,724: 13:26:44 | 9 of 27 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.51s]
2018-02-06 13:26:44,725: 13:26:44 | 13 of 27 START view model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-06 13:26:44,726: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:26:44,731: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:26:44,732: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:26:44,732: Re-using an available connection from the pool.
2018-02-06 13:26:44,851: Bad request while running:
SELECT 
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	word_count,
	header_content_type,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_below_avg_prices,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
)
2018-02-06 13:26:44,851: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables: Unrecognized name: flag_learn_more at [13:38]
2018-02-06 13:26:44,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114239dd8>]}
2018-02-06 13:26:44,919: 13:26:44 | 10 of 27 OK created view model seo_audit.sitemap_proc................ [CREATE VIEW in 0.55s]
2018-02-06 13:26:44,926: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:26:44,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141faac8>]}
2018-02-06 13:26:45,107: 13:26:45 | 12 of 27 ERROR creating view model seo_audit.deepcrawl_class......... [ERROR in 0.32s]
2018-02-06 13:26:45,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141fab70>]}
2018-02-06 13:26:45,298: 13:26:45 | 11 of 27 OK created view model seo_audit.search_console_proc......... [CREATE VIEW in 0.60s]
2018-02-06 13:26:45,492: 13:26:45 | 13 of 27 OK created view model seo_audit.semrush_domain_proc......... [CREATE VIEW in 0.45s]
2018-02-06 13:26:45,492: 13:26:45 | 14 of 27 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:26:45,492: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:26:45,496: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:26:45,492: 13:26:45 | 15 of 27 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:26:45,497: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:26:45,500: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:26:45,492: 13:26:45 | 16 of 27 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:26:45,501: Compiling model.seo_audit.ga_stats
2018-02-06 13:26:45,505: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:26:45,492: 13:26:45 | 17 of 27 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:26:45,505: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:26:45,505: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:26:45,511: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:26:45,512: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:26:45,512: Re-using an available connection from the pool.
2018-02-06 13:26:45,513: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:26:45,514: Re-using an available connection from the pool.
2018-02-06 13:26:45,515: Re-using an available connection from the pool.
2018-02-06 13:26:45,516: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:26:45,518: Re-using an available connection from the pool.
2018-02-06 13:26:45,677: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:26:45,689: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:26:45,707: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:26:45,708: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:26:45,981: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141744a8>]}
2018-02-06 13:26:45,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1142392b0>]}
2018-02-06 13:26:46,025: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114005080>]}
2018-02-06 13:26:46,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141fab70>]}
2018-02-06 13:26:46,168: 13:26:46 | 14 of 27 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.49s]
2018-02-06 13:26:46,170: 13:26:46 | 18 of 27 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:26:46,171: Compiling model.seo_audit.search_console_history
2018-02-06 13:26:46,174: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:26:46,175: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:26:46,175: Re-using an available connection from the pool.
2018-02-06 13:26:46,368: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:26:46,372: 13:26:46 | 17 of 27 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.49s]
2018-02-06 13:26:46,570: 13:26:46 | 16 of 27 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.52s]
2018-02-06 13:26:46,659: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141744a8>]}
2018-02-06 13:26:46,753: 13:26:46 | 15 of 27 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.55s]
2018-02-06 13:26:46,933: 13:26:46 | 18 of 27 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.49s]
2018-02-06 13:26:46,933: 13:26:46 | 19 of 27 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:26:46,934: 13:26:46 | 20 of 27 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:26:46,934: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:26:46,934: 13:26:46 | 21 of 27 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:26:46,934: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:26:46,938: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:26:46,938: Compiling model.seo_audit.agg_indicative
2018-02-06 13:26:46,942: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:26:46,946: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:26:46,967: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:26:46,968: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:26:46,968: Re-using an available connection from the pool.
2018-02-06 13:26:46,969: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:26:46,970: Re-using an available connection from the pool.
2018-02-06 13:26:46,971: Re-using an available connection from the pool.
2018-02-06 13:26:47,141: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:26:47,156: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:26:47,193: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:26:47,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114206fd0>]}
2018-02-06 13:26:47,501: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114133908>]}
2018-02-06 13:26:47,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114005d68>]}
2018-02-06 13:26:47,637: 13:26:47 | 20 of 27 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.51s]
2018-02-06 13:26:47,835: 13:26:47 | 19 of 27 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.57s]
2018-02-06 13:26:48,023: 13:26:48 | 21 of 27 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.57s]
2018-02-06 13:26:48,023: 13:26:48 | 22 of 27 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:26:48,024: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:26:48,028: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:26:48,024: 13:26:48 | 23 of 27 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:26:48,024: 13:26:48 | 24 of 27 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:26:48,028: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:26:48,028: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:26:48,033: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:26:48,033: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:26:48,038: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:26:48,038: Re-using an available connection from the pool.
2018-02-06 13:26:48,040: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:26:48,040: Re-using an available connection from the pool.
2018-02-06 13:26:48,045: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:26:48,046: Re-using an available connection from the pool.
2018-02-06 13:26:48,247: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:26:48,267: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:26:48,268: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:26:48,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141744a8>]}
2018-02-06 13:26:48,565: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11422c3c8>]}
2018-02-06 13:26:48,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11422c390>]}
2018-02-06 13:26:48,751: 13:26:48 | 22 of 27 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.54s]
2018-02-06 13:26:48,942: 13:26:48 | 24 of 27 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.54s]
2018-02-06 13:26:49,141: 13:26:49 | 23 of 27 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.59s]
2018-02-06 13:26:49,141: 13:26:49 | 25 of 27 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:26:49,141: Compiling model.seo_audit.agg_stats
2018-02-06 13:26:49,148: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:26:49,148: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:26:49,148: Re-using an available connection from the pool.
2018-02-06 13:26:49,344: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:26:49,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114005d68>]}
2018-02-06 13:26:50,072: 13:26:50 | 25 of 27 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.74s]
2018-02-06 13:26:50,072: 13:26:50 | 26 of 27 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:26:50,072: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:26:50,077: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:26:50,092: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:26:50,092: Re-using an available connection from the pool.
2018-02-06 13:26:50,289: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:26:50,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141da6a0>]}
2018-02-06 13:26:51,115: 13:26:51 | 26 of 27 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.84s]
2018-02-06 13:26:51,116: 13:26:51 | 27 of 27 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:26:51,116: Compiling model.seo_audit.agg_all
2018-02-06 13:26:51,120: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:26:51,122: Acquiring new bigquery connection "agg_all".
2018-02-06 13:26:51,122: Re-using an available connection from the pool.
2018-02-06 13:26:51,301: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:26:51,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1939aca9-2723-42c7-bd6e-4e43416e40f3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114005d68>]}
2018-02-06 13:26:52,188: 13:26:52 | 27 of 27 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.88s]
2018-02-06 13:26:52,250: 13:26:52 | 
2018-02-06 13:26:52,250: 13:26:52 | Finished running 27 view models in 10.81s.
2018-02-06 13:26:52,250: Connection 'master' was left open.
2018-02-06 13:26:52,250: 
2018-02-06 13:26:52,251: Completed with 1 errors:
2018-02-06 13:26:52,251: 
2018-02-06 13:26:52,251: Database Error in model deepcrawl_class (models/base-adp/deepcrawl/deepcrawl_class.sql)
2018-02-06 13:26:52,251:   Unrecognized name: flag_learn_more at [13:38]
2018-02-06 13:26:52,251:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class.sql
2018-02-06 13:26:52,251: 
Done. PASS=26 ERROR=1 SKIP=0 TOTAL=27
2018-02-06 13:26:52,251: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ff6860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ff6a20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ff6780>]}
2018-02-06 13:26:52,471: Flushing usage events
2018-02-06 13:27:55,695: Tracking: tracking
2018-02-06 13:27:55,695: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359fba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359fef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c3a710>]}
2018-02-06 13:27:56,279: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 13:27:56,291: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 13:27:56,292: Parsing core.sql
2018-02-06 13:27:56,303: Parsing adapters/bigquery.sql
2018-02-06 13:27:56,307: Parsing adapters/common.sql
2018-02-06 13:27:56,319: Parsing adapters/postgres.sql
2018-02-06 13:27:56,322: Parsing adapters/redshift.sql
2018-02-06 13:27:56,338: Parsing etc/get_custom_schema.sql
2018-02-06 13:27:56,342: Parsing materializations/archive.sql
2018-02-06 13:27:56,371: Parsing materializations/bigquery.sql
2018-02-06 13:27:56,382: Parsing materializations/helpers.sql
2018-02-06 13:27:56,396: Parsing materializations/incremental.sql
2018-02-06 13:27:56,418: Parsing materializations/table.sql
2018-02-06 13:27:56,436: Parsing materializations/view.sql
2018-02-06 13:27:56,450: Parsing materializations/wrapper.sql
2018-02-06 13:27:56,453: Parsing schema_tests/accepted_values.sql
2018-02-06 13:27:56,456: Parsing schema_tests/not_null.sql
2018-02-06 13:27:56,457: Parsing schema_tests/relationships.sql
2018-02-06 13:27:56,459: Parsing schema_tests/unique.sql
2018-02-06 13:27:56,468: Parsing model.seo_audit.accounts_proc
2018-02-06 13:27:56,470: Parsing model.seo_audit.all_dates
2018-02-06 13:27:56,471: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 13:27:56,473: Acquiring new bigquery connection "master".
2018-02-06 13:27:56,473: Opening a new connection (0 currently allocated)
2018-02-06 13:27:56,474: Parsing model.seo_audit.agg_all
2018-02-06 13:27:56,477: Parsing model.seo_audit.agg_indicative
2018-02-06 13:27:56,479: Parsing model.seo_audit.agg_stats
2018-02-06 13:27:56,484: Parsing model.seo_audit.agg_stats_client
2018-02-06 13:27:56,486: Parsing model.seo_audit.deepcrawl_class
2018-02-06 13:27:56,487: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 13:27:56,489: Parsing model.seo_audit.ga_proc
2018-02-06 13:27:56,491: Parsing model.seo_audit.ga_stats
2018-02-06 13:27:56,493: Parsing model.seo_audit.majestic_domain_history
2018-02-06 13:27:56,494: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 13:27:56,496: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 13:27:56,498: Parsing model.seo_audit.moz_proc
2018-02-06 13:27:56,500: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 13:27:56,503: Parsing model.seo_audit.search_console_history
2018-02-06 13:27:56,504: Parsing model.seo_audit.search_console_proc
2018-02-06 13:27:56,507: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 13:27:56,509: Parsing model.seo_audit.search_console_stats_url
2018-02-06 13:27:56,510: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 13:27:56,512: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 13:27:56,515: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 13:27:56,517: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 13:27:56,519: Parsing model.seo_audit.semrush_url_history
2018-02-06 13:27:56,520: Parsing model.seo_audit.semrush_url_stats
2018-02-06 13:27:56,522: Parsing model.seo_audit.sitemap_proc
2018-02-06 13:27:56,531: Found 27 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 13:27:56,536: 
2018-02-06 13:27:57,553: 13:27:57 | Concurrency: 4 threads (target='prod')
2018-02-06 13:27:57,553: 13:27:57 | 
2018-02-06 13:27:57,694: 13:27:57 | 1 of 27 START view model seo_audit.deepcrawl_proc.................... [RUN]
2018-02-06 13:27:57,694: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 13:27:57,694: 13:27:57 | 2 of 27 START view model seo_audit.accounts_proc..................... [RUN]
2018-02-06 13:27:57,694: 13:27:57 | 3 of 27 START view model seo_audit.all_dates......................... [RUN]
2018-02-06 13:27:57,698: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 13:27:57,698: Compiling model.seo_audit.accounts_proc
2018-02-06 13:27:57,698: Compiling model.seo_audit.all_dates
2018-02-06 13:27:57,703: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 13:27:57,706: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 13:27:57,706: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 13:27:57,707: Opening a new connection (1 currently allocated)
2018-02-06 13:27:57,709: Acquiring new bigquery connection "all_dates".
2018-02-06 13:27:57,709: Opening a new connection (2 currently allocated)
2018-02-06 13:27:57,749: Acquiring new bigquery connection "accounts_proc".
2018-02-06 13:27:57,752: Opening a new connection (3 currently allocated)
2018-02-06 13:27:58,186: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 13:27:58,195: Model SQL (deepcrawl_proc):
select
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more


  FROM
  (
    SELECT 
    lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
    crawl_datetime,
    first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
    found_at_sitemap,
    http_status_code,
    level,
    schema_type,
    header_content_type,
    word_count, 
    (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
    (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
    (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
    (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
    (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
    (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
    (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
    Decimal_price,
    Currency_price,
    Add_to_cart,
    Learn_more,
    Review,
    Size
    FROM `curious-domain-121318.seo_audit.deepcrawl` 
   )
  WHERE last_crawl = crawl_datetime
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 13:27:58,211: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 13:27:58,348: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137482e8>]}
2018-02-06 13:27:58,399: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377f9e8>]}
2018-02-06 13:27:58,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377fc18>]}
2018-02-06 13:27:58,541: 13:27:58 | 3 of 27 OK created view model seo_audit.all_dates.................... [CREATE VIEW in 0.65s]
2018-02-06 13:27:58,734: 13:27:58 | 2 of 27 OK created view model seo_audit.accounts_proc................ [CREATE VIEW in 0.70s]
2018-02-06 13:27:58,927: 13:27:58 | 1 of 27 OK created view model seo_audit.deepcrawl_proc............... [CREATE VIEW in 0.74s]
2018-02-06 13:27:58,928: 13:27:58 | 4 of 27 START view model seo_audit.deepcrawl_class................... [RUN]
2018-02-06 13:27:58,928: 13:27:58 | 5 of 27 START view model seo_audit.screamingfrog_proc................ [RUN]
2018-02-06 13:27:58,928: 13:27:58 | 6 of 27 START view model seo_audit.sitemap_proc...................... [RUN]
2018-02-06 13:27:58,928: 13:27:58 | 7 of 27 START view model seo_audit.semrush_domain_proc............... [RUN]
2018-02-06 13:27:58,928: Compiling model.seo_audit.deepcrawl_class
2018-02-06 13:27:58,928: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 13:27:58,928: Compiling model.seo_audit.sitemap_proc
2018-02-06 13:27:58,928: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 13:27:58,932: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 13:27:58,938: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 13:27:58,942: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 13:27:58,947: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 13:27:58,948: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 13:27:58,949: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 13:27:58,949: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 13:27:58,949: Re-using an available connection from the pool.
2018-02-06 13:27:58,949: Re-using an available connection from the pool.
2018-02-06 13:27:58,950: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 13:27:58,951: Re-using an available connection from the pool.
2018-02-06 13:27:58,953: Opening a new connection (4 currently allocated)
2018-02-06 13:27:59,085: Model SQL (deepcrawl_class):
SELECT 
url,
found_at_sitemap,
http_status_code,
level,
schema_type,
word_count,
header_content_type,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	word_count,
	header_content_type,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_below_avg_prices,
	flag_learn_more,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
)
2018-02-06 13:27:59,135: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:27:59,165: Model SQL (sitemap_proc):
SELECT 
b.client,
sitemap,
url
FROM 

(

	SELECT  
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.sitemap = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 13:27:59,352: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113738f28>]}
2018-02-06 13:27:59,363: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 13:27:59,381: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729390>]}
2018-02-06 13:27:59,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729e80>]}
2018-02-06 13:27:59,548: 13:27:59 | 4 of 27 OK created view model seo_audit.deepcrawl_class.............. [CREATE VIEW in 0.42s]
2018-02-06 13:27:59,548: 13:27:59 | 8 of 27 START view model seo_audit.majestic_domain_proc.............. [RUN]
2018-02-06 13:27:59,549: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 13:27:59,554: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 13:27:59,556: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 13:27:59,557: Re-using an available connection from the pool.
2018-02-06 13:27:59,652: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729898>]}
2018-02-06 13:27:59,737: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 13:27:59,743: 13:27:59 | 7 of 27 OK created view model seo_audit.semrush_domain_proc.......... [CREATE VIEW in 0.45s]
2018-02-06 13:27:59,744: 13:27:59 | 9 of 27 START view model seo_audit.mappings_ga_proc.................. [RUN]
2018-02-06 13:27:59,746: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 13:27:59,750: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 13:27:59,752: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 13:27:59,752: Re-using an available connection from the pool.
2018-02-06 13:27:59,935: 13:27:59 | 6 of 27 OK created view model seo_audit.sitemap_proc................. [CREATE VIEW in 0.51s]
2018-02-06 13:27:59,936: 13:27:59 | 10 of 27 START view model seo_audit.search_console_proc.............. [RUN]
2018-02-06 13:27:59,937: Compiling model.seo_audit.search_console_proc
2018-02-06 13:27:59,942: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 13:27:59,943: Acquiring new bigquery connection "search_console_proc".
2018-02-06 13:27:59,944: Re-using an available connection from the pool.
2018-02-06 13:27:59,954: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 13:28:00,025: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11377f048>]}
2018-02-06 13:28:00,150: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:28:00,151: 13:28:00 | 5 of 27 OK created view model seo_audit.screamingfrog_proc........... [CREATE VIEW in 0.72s]
2018-02-06 13:28:00,154: 13:28:00 | 11 of 27 START view model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-06 13:28:00,155: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 13:28:00,160: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 13:28:00,161: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 13:28:00,161: Re-using an available connection from the pool.
2018-02-06 13:28:00,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729390>]}
2018-02-06 13:28:00,346: 13:28:00 | 8 of 27 OK created view model seo_audit.majestic_domain_proc......... [CREATE VIEW in 0.48s]
2018-02-06 13:28:00,347: 13:28:00 | 12 of 27 START view model seo_audit.moz_proc......................... [RUN]
2018-02-06 13:28:00,347: Compiling model.seo_audit.moz_proc
2018-02-06 13:28:00,352: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 13:28:00,352: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 13:28:00,356: Acquiring new bigquery connection "moz_proc".
2018-02-06 13:28:00,356: Re-using an available connection from the pool.
2018-02-06 13:28:00,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729e80>]}
2018-02-06 13:28:00,544: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 13:28:00,551: 13:28:00 | 9 of 27 OK created view model seo_audit.mappings_ga_proc............. [CREATE VIEW in 0.51s]
2018-02-06 13:28:00,551: 13:28:00 | 13 of 27 START view model seo_audit.ga_proc.......................... [RUN]
2018-02-06 13:28:00,552: Compiling model.seo_audit.ga_proc
2018-02-06 13:28:00,559: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 13:28:00,561: Acquiring new bigquery connection "ga_proc".
2018-02-06 13:28:00,561: Re-using an available connection from the pool.
2018-02-06 13:28:00,625: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137c3a20>]}
2018-02-06 13:28:00,736: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 13:28:00,754: 13:28:00 | 10 of 27 OK created view model seo_audit.search_console_proc......... [CREATE VIEW in 0.47s]
2018-02-06 13:28:00,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113748ac8>]}
2018-02-06 13:28:00,944: 13:28:00 | 11 of 27 OK created view model seo_audit.semrush_keyword_proc........ [CREATE VIEW in 0.47s]
2018-02-06 13:28:00,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11015b748>]}
2018-02-06 13:28:01,139: 13:28:01 | 12 of 27 OK created view model seo_audit.moz_proc.................... [CREATE VIEW in 0.48s]
2018-02-06 13:28:01,325: 13:28:01 | 13 of 27 OK created view model seo_audit.ga_proc..................... [CREATE VIEW in 0.44s]
2018-02-06 13:28:01,325: 13:28:01 | 14 of 27 START view model seo_audit.semrush_url_history.............. [RUN]
2018-02-06 13:28:01,325: Compiling model.seo_audit.semrush_url_history
2018-02-06 13:28:01,329: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 13:28:01,325: 13:28:01 | 15 of 27 START view model seo_audit.ga_stats......................... [RUN]
2018-02-06 13:28:01,330: Compiling model.seo_audit.ga_stats
2018-02-06 13:28:01,334: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 13:28:01,325: 13:28:01 | 16 of 27 START view model seo_audit.majestic_domain_history.......... [RUN]
2018-02-06 13:28:01,325: 13:28:01 | 17 of 27 START view model seo_audit.search_console_history........... [RUN]
2018-02-06 13:28:01,334: Compiling model.seo_audit.majestic_domain_history
2018-02-06 13:28:01,335: Acquiring new bigquery connection "ga_stats".
2018-02-06 13:28:01,335: Compiling model.seo_audit.search_console_history
2018-02-06 13:28:01,336: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 13:28:01,339: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 13:28:01,340: Re-using an available connection from the pool.
2018-02-06 13:28:01,347: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 13:28:01,348: Re-using an available connection from the pool.
2018-02-06 13:28:01,351: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 13:28:01,352: Re-using an available connection from the pool.
2018-02-06 13:28:01,353: Acquiring new bigquery connection "search_console_history".
2018-02-06 13:28:01,358: Re-using an available connection from the pool.
2018-02-06 13:28:01,529: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 13:28:01,530: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 13:28:01,536: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 13:28:01,538: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 13:28:01,806: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137c3ba8>]}
2018-02-06 13:28:01,824: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137b4f98>]}
2018-02-06 13:28:01,838: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136b0160>]}
2018-02-06 13:28:01,872: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113740ba8>]}
2018-02-06 13:28:01,993: 13:28:01 | 14 of 27 OK created view model seo_audit.semrush_url_history......... [CREATE VIEW in 0.48s]
2018-02-06 13:28:01,994: 13:28:01 | 18 of 27 START view model seo_audit.semrush_keyword_history.......... [RUN]
2018-02-06 13:28:01,995: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 13:28:02,000: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 13:28:02,001: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 13:28:02,002: Re-using an available connection from the pool.
2018-02-06 13:28:02,178: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 13:28:02,196: 13:28:02 | 16 of 27 OK created view model seo_audit.majestic_domain_history..... [CREATE VIEW in 0.49s]
2018-02-06 13:28:02,384: 13:28:02 | 17 of 27 OK created view model seo_audit.search_console_history...... [CREATE VIEW in 0.50s]
2018-02-06 13:28:02,468: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113729710>]}
2018-02-06 13:28:02,605: 13:28:02 | 15 of 27 OK created view model seo_audit.ga_stats.................... [CREATE VIEW in 0.54s]
2018-02-06 13:28:02,816: 13:28:02 | 18 of 27 OK created view model seo_audit.semrush_keyword_history..... [CREATE VIEW in 0.47s]
2018-02-06 13:28:02,817: 13:28:02 | 19 of 27 START view model seo_audit.search_console_stats_url......... [RUN]
2018-02-06 13:28:02,817: 13:28:02 | 20 of 27 START view model seo_audit.agg_indicative................... [RUN]
2018-02-06 13:28:02,817: Compiling model.seo_audit.search_console_stats_url
2018-02-06 13:28:02,817: 13:28:02 | 21 of 27 START view model seo_audit.search_console_stats_keyword..... [RUN]
2018-02-06 13:28:02,817: Compiling model.seo_audit.agg_indicative
2018-02-06 13:28:02,821: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 13:28:02,821: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 13:28:02,825: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 13:28:02,830: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 13:28:02,831: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 13:28:02,831: Acquiring new bigquery connection "agg_indicative".
2018-02-06 13:28:02,831: Re-using an available connection from the pool.
2018-02-06 13:28:02,833: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 13:28:02,834: Re-using an available connection from the pool.
2018-02-06 13:28:02,834: Re-using an available connection from the pool.
2018-02-06 13:28:03,028: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 13:28:03,030: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 13:28:03,031: Model SQL (agg_indicative):
SELECT 
coalesce(sf.client, s.client) client,
coalesce(sf.url, s.url) url,
max(title) title,
max(title_length) title_length,
max(description) description,
max(description_length) description_length,
max(word_count) word_count,
max(sitemap) sitemap,
max(status_code) status_code,
max(meta_robots) meta_robots,
max(canonical_link_element) canonical_link_element
FROM `curious-domain-121318`.`seo_audit`.`screamingfrog_proc` sf
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( sf.url = s.url
  and sf.client = s.client )
group by client, url
2018-02-06 13:28:03,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11015b748>]}
2018-02-06 13:28:03,340: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137405f8>]}
2018-02-06 13:28:03,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113738f28>]}
2018-02-06 13:28:03,533: 13:28:03 | 19 of 27 OK created view model seo_audit.search_console_stats_url.... [CREATE VIEW in 0.52s]
2018-02-06 13:28:03,722: 13:28:03 | 20 of 27 OK created view model seo_audit.agg_indicative.............. [CREATE VIEW in 0.52s]
2018-02-06 13:28:03,915: 13:28:03 | 21 of 27 OK created view model seo_audit.search_console_stats_keyword [CREATE VIEW in 0.52s]
2018-02-06 13:28:03,916: 13:28:03 | 22 of 27 START view model seo_audit.semrush_keyword_stats............ [RUN]
2018-02-06 13:28:03,916: 13:28:03 | 23 of 27 START view model seo_audit.majestic_domain_stats............ [RUN]
2018-02-06 13:28:03,916: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 13:28:03,916: 13:28:03 | 24 of 27 START view model seo_audit.semrush_url_stats................ [RUN]
2018-02-06 13:28:03,916: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 13:28:03,921: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 13:28:03,921: Compiling model.seo_audit.semrush_url_stats
2018-02-06 13:28:03,925: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 13:28:03,929: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 13:28:03,930: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 13:28:03,930: Re-using an available connection from the pool.
2018-02-06 13:28:03,931: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 13:28:03,932: Re-using an available connection from the pool.
2018-02-06 13:28:03,933: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 13:28:03,933: Re-using an available connection from the pool.
2018-02-06 13:28:04,105: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 13:28:04,118: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:28:04,123: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 13:28:04,462: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113756cc0>]}
2018-02-06 13:28:04,480: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113748be0>]}
2018-02-06 13:28:04,482: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113740c50>]}
2018-02-06 13:28:04,654: 13:28:04 | 24 of 27 OK created view model seo_audit.semrush_url_stats........... [CREATE VIEW in 0.54s]
2018-02-06 13:28:04,876: 13:28:04 | 22 of 27 OK created view model seo_audit.semrush_keyword_stats....... [CREATE VIEW in 0.56s]
2018-02-06 13:28:05,068: 13:28:05 | 23 of 27 OK created view model seo_audit.majestic_domain_stats....... [CREATE VIEW in 0.57s]
2018-02-06 13:28:05,068: 13:28:05 | 25 of 27 START view model seo_audit.agg_stats........................ [RUN]
2018-02-06 13:28:05,068: Compiling model.seo_audit.agg_stats
2018-02-06 13:28:05,075: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 13:28:05,075: Acquiring new bigquery connection "agg_stats".
2018-02-06 13:28:05,075: Re-using an available connection from the pool.
2018-02-06 13:28:05,263: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-06 13:28:05,785: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11015b748>]}
2018-02-06 13:28:05,972: 13:28:05 | 25 of 27 OK created view model seo_audit.agg_stats................... [CREATE VIEW in 0.72s]
2018-02-06 13:28:05,972: 13:28:05 | 26 of 27 START view model seo_audit.agg_stats_client................. [RUN]
2018-02-06 13:28:05,972: Compiling model.seo_audit.agg_stats_client
2018-02-06 13:28:05,977: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 13:28:05,977: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 13:28:05,977: Re-using an available connection from the pool.
2018-02-06 13:28:06,161: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 13:28:06,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113738c50>]}
2018-02-06 13:28:07,015: 13:28:07 | 26 of 27 OK created view model seo_audit.agg_stats_client............ [CREATE VIEW in 0.86s]
2018-02-06 13:28:07,015: 13:28:07 | 27 of 27 START view model seo_audit.agg_all.......................... [RUN]
2018-02-06 13:28:07,016: Compiling model.seo_audit.agg_all
2018-02-06 13:28:07,020: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 13:28:07,021: Acquiring new bigquery connection "agg_all".
2018-02-06 13:28:07,021: Re-using an available connection from the pool.
2018-02-06 13:28:07,241: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 13:28:07,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22243da7-60da-4d2c-82e3-7c6ec8c392e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11015b748>]}
2018-02-06 13:28:08,086: 13:28:08 | 27 of 27 OK created view model seo_audit.agg_all..................... [CREATE VIEW in 0.88s]
2018-02-06 13:28:08,187: 13:28:08 | 
2018-02-06 13:28:08,188: 13:28:08 | Finished running 27 view models in 10.64s.
2018-02-06 13:28:08,188: Connection 'master' was left open.
2018-02-06 13:28:08,188: 
2018-02-06 13:28:08,188: Completed successfully
2018-02-06 13:28:08,188: 
Done. PASS=27 ERROR=0 SKIP=0 TOTAL=27
2018-02-06 13:28:08,188: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11368b908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11368b7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359fba8>]}
2018-02-06 13:28:08,380: Flushing usage events
2018-02-06 16:28:45,111: Tracking: tracking
2018-02-06 16:28:45,113: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fea97f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fea9668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fea9a20>]}
2018-02-06 16:28:46,223: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 16:28:46,241: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 16:28:46,245: Parsing core.sql
2018-02-06 16:28:46,264: Parsing adapters/bigquery.sql
2018-02-06 16:28:46,274: Parsing adapters/common.sql
2018-02-06 16:28:46,294: Parsing adapters/postgres.sql
2018-02-06 16:28:46,300: Parsing adapters/redshift.sql
2018-02-06 16:28:46,323: Parsing etc/get_custom_schema.sql
2018-02-06 16:28:46,331: Parsing materializations/archive.sql
2018-02-06 16:28:46,369: Parsing materializations/bigquery.sql
2018-02-06 16:28:46,386: Parsing materializations/helpers.sql
2018-02-06 16:28:46,406: Parsing materializations/incremental.sql
2018-02-06 16:28:46,434: Parsing materializations/table.sql
2018-02-06 16:28:46,456: Parsing materializations/view.sql
2018-02-06 16:28:46,479: Parsing materializations/wrapper.sql
2018-02-06 16:28:46,484: Parsing schema_tests/accepted_values.sql
2018-02-06 16:28:46,490: Parsing schema_tests/not_null.sql
2018-02-06 16:28:46,495: Parsing schema_tests/relationships.sql
2018-02-06 16:28:46,500: Parsing schema_tests/unique.sql
2018-02-06 16:28:46,579: Parsing model.seo_audit.accounts_proc
2018-02-06 16:28:46,584: Parsing model.seo_audit.all_dates
2018-02-06 16:28:46,586: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 16:28:46,589: Acquiring new bigquery connection "master".
2018-02-06 16:28:46,589: Opening a new connection (0 currently allocated)
2018-02-06 16:28:46,594: Parsing model.seo_audit.agg_all
2018-02-06 16:28:46,597: Parsing model.seo_audit.agg_indicative
2018-02-06 16:28:46,599: Parsing model.seo_audit.agg_stats
2018-02-06 16:28:46,604: Parsing model.seo_audit.agg_stats_client
2018-02-06 16:28:46,608: Parsing model.seo_audit.deepcrawl_class
2018-02-06 16:28:46,610: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 16:28:46,612: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 16:28:46,614: Parsing model.seo_audit.ga_proc
2018-02-06 16:28:46,617: Parsing model.seo_audit.ga_stats
2018-02-06 16:28:46,618: Parsing model.seo_audit.majestic_domain_history
2018-02-06 16:28:46,620: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 16:28:46,623: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 16:28:46,625: Parsing model.seo_audit.moz_proc
2018-02-06 16:28:46,627: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 16:28:46,630: Parsing model.seo_audit.search_console_history
2018-02-06 16:28:46,632: Parsing model.seo_audit.search_console_proc
2018-02-06 16:28:46,635: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 16:28:46,637: Parsing model.seo_audit.search_console_stats_url
2018-02-06 16:28:46,639: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 16:28:46,642: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 16:28:46,645: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 16:28:46,649: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 16:28:46,654: Parsing model.seo_audit.semrush_url_history
2018-02-06 16:28:46,658: Parsing model.seo_audit.semrush_url_stats
2018-02-06 16:28:46,662: Parsing model.seo_audit.sitemap_proc
2018-02-06 16:28:46,683: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 16:28:46,690: 
2018-02-06 16:28:47,922: 16:28:47 | Concurrency: 4 threads (target='dev')
2018-02-06 16:28:47,922: 16:28:47 | 
2018-02-06 16:28:48,118: 16:28:48 | 1 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 16:28:48,118: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 16:28:48,118: 16:28:48 | 2 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 16:28:48,123: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 16:28:48,118: 16:28:48 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 16:28:48,123: Compiling model.seo_audit.accounts_proc
2018-02-06 16:28:48,123: Compiling model.seo_audit.all_dates
2018-02-06 16:28:48,128: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 16:28:48,132: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 16:28:48,138: Acquiring new bigquery connection "accounts_proc".
2018-02-06 16:28:48,138: Opening a new connection (1 currently allocated)
2018-02-06 16:28:48,140: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 16:28:48,141: Acquiring new bigquery connection "all_dates".
2018-02-06 16:28:48,144: Opening a new connection (2 currently allocated)
2018-02-06 16:28:48,201: Opening a new connection (3 currently allocated)
2018-02-06 16:28:48,823: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 16:28:48,824: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
  regexp_extract(source_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 16:28:48,828: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 16:28:49,873: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
  regexp_extract(source_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 16:28:49,873: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: source_url at [6:18]
2018-02-06 16:28:49,874: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004e7f0>]}
2018-02-06 16:28:49,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa7080>]}
2018-02-06 16:28:49,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa7668>]}
2018-02-06 16:28:50,131: 16:28:50 | 1 of 28 ERROR creating view model seo_audit_dev.deepcrawl_proc....... [ERROR in 1.76s]
2018-02-06 16:28:50,562: 16:28:50 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.76s]
2018-02-06 16:28:50,980: 16:28:50 | 2 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.76s]
2018-02-06 16:28:50,981: 16:28:50 | 4 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 16:28:50,981: Compiling model.seo_audit.moz_proc
2018-02-06 16:28:50,981: 16:28:50 | 5 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 16:28:50,988: Compiling model.seo_audit.sitemap_proc
2018-02-06 16:28:50,999: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 16:28:51,000: Acquiring new bigquery connection "moz_proc".
2018-02-06 16:28:51,001: Re-using an available connection from the pool.
2018-02-06 16:28:50,981: 16:28:50 | 6 of 28 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-06 16:28:51,007: Compiling model.seo_audit.search_console_proc
2018-02-06 16:28:51,018: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 16:28:50,981: 16:28:50 | 7 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 16:28:51,026: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 16:28:51,026: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 16:28:51,040: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 16:28:51,041: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 16:28:51,041: Re-using an available connection from the pool.
2018-02-06 16:28:51,043: Acquiring new bigquery connection "search_console_proc".
2018-02-06 16:28:51,043: Re-using an available connection from the pool.
2018-02-06 16:28:51,050: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 16:28:51,050: Opening a new connection (4 currently allocated)
2018-02-06 16:28:51,440: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:28:51,443: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:28:51,451: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) 
where time_of_entry = lv
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 16:28:51,574: Bad request while running:
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) 
where time_of_entry = lv
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 16:28:51,574: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Unexpected keyword LEFT at [20:1]
2018-02-06 16:28:51,575: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110088cc0>]}
2018-02-06 16:28:51,728: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 16:28:51,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004ed68>]}
2018-02-06 16:28:51,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffdf5c0>]}
2018-02-06 16:28:52,034: 16:28:52 | 5 of 28 ERROR creating view model seo_audit_dev.sitemap_proc......... [ERROR in 0.59s]
2018-02-06 16:28:52,035: 16:28:52 | 8 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 16:28:52,036: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 16:28:52,044: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 16:28:52,049: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 16:28:52,049: Re-using an available connection from the pool.
2018-02-06 16:28:52,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004e748>]}
2018-02-06 16:28:52,160: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 16:28:52,490: 16:28:52 | 6 of 28 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.96s]
2018-02-06 16:28:52,491: 16:28:52 | 9 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 16:28:52,492: Compiling model.seo_audit.ga_proc
2018-02-06 16:28:52,501: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 16:28:52,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100793c8>]}
2018-02-06 16:28:52,503: Acquiring new bigquery connection "ga_proc".
2018-02-06 16:28:52,503: Re-using an available connection from the pool.
2018-02-06 16:28:52,596: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 16:28:52,770: 16:28:52 | 4 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.99s]
2018-02-06 16:28:52,771: 16:28:52 | 10 of 28 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-06 16:28:52,775: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 16:28:52,786: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 16:28:52,790: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 16:28:52,790: Re-using an available connection from the pool.
2018-02-06 16:28:53,014: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004ed68>]}
2018-02-06 16:28:53,113: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 16:28:53,263: 16:28:53 | 7 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 1.04s]
2018-02-06 16:28:53,264: 16:28:53 | 11 of 28 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-06 16:28:53,264: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 16:28:53,277: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 16:28:53,280: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 16:28:53,280: Re-using an available connection from the pool.
2018-02-06 16:28:53,539: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:28:53,543: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffdf5c0>]}
2018-02-06 16:28:54,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004e748>]}
2018-02-06 16:28:54,067: 16:28:54 | 8 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.47s]
2018-02-06 16:28:54,068: 16:28:54 | 12 of 28 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-06 16:28:54,068: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 16:28:54,076: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 16:28:54,080: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 16:28:54,081: Re-using an available connection from the pool.
2018-02-06 16:28:54,188: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:28:54,320: 16:28:54 | 9 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.52s]
2018-02-06 16:28:54,320: 16:28:54 | 13 of 28 SKIP relation seo_audit_dev.deepcrawl_class_proc............ [SKIP]
2018-02-06 16:28:54,590: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100793c8>]}
2018-02-06 16:28:54,764: 16:28:54 | 10 of 28 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.77s]
2018-02-06 16:28:55,220: 16:28:55 | 11 of 28 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.80s]
2018-02-06 16:28:55,637: 16:28:55 | 12 of 28 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.52s]
2018-02-06 16:28:55,638: 16:28:55 | 14 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 16:28:55,639: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 16:28:55,638: 16:28:55 | 15 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 16:28:55,648: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 16:28:55,638: 16:28:55 | 16 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 16:28:55,648: Compiling model.seo_audit.majestic_domain_history
2018-02-06 16:28:55,638: 16:28:55 | 17 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 16:28:55,649: Compiling model.seo_audit.semrush_url_history
2018-02-06 16:28:55,655: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 16:28:55,657: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 16:28:55,658: Compiling model.seo_audit.search_console_history
2018-02-06 16:28:55,667: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 16:28:55,668: Re-using an available connection from the pool.
2018-02-06 16:28:55,678: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 16:28:55,681: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 16:28:55,684: Re-using an available connection from the pool.
2018-02-06 16:28:55,688: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 16:28:55,689: Re-using an available connection from the pool.
2018-02-06 16:28:55,697: Acquiring new bigquery connection "search_console_history".
2018-02-06 16:28:55,697: Re-using an available connection from the pool.
2018-02-06 16:28:55,780: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 16:28:55,785: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 16:28:55,787: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 16:28:55,796: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 16:28:56,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100acb70>]}
2018-02-06 16:28:56,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffe1b00>]}
2018-02-06 16:28:56,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff8bf98>]}
2018-02-06 16:28:56,415: 16:28:56 | 16 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.51s]
2018-02-06 16:28:56,416: 16:28:56 | 18 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 16:28:56,417: Compiling model.seo_audit.ga_stats
2018-02-06 16:28:56,427: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 16:28:56,429: Acquiring new bigquery connection "ga_stats".
2018-02-06 16:28:56,429: Re-using an available connection from the pool.
2018-02-06 16:28:56,682: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 16:28:56,861: 16:28:56 | 17 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.51s]
2018-02-06 16:28:57,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110079198>]}
2018-02-06 16:28:57,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004ea58>]}
2018-02-06 16:28:57,326: 16:28:57 | 15 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.59s]
2018-02-06 16:28:57,784: 16:28:57 | 18 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.79s]
2018-02-06 16:28:58,257: 16:28:58 | 14 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 1.57s]
2018-02-06 16:28:58,258: 16:28:58 | 19 of 28 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-06 16:28:58,258: 16:28:58 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 16:28:58,259: Compiling model.seo_audit.search_console_stats_url
2018-02-06 16:28:58,258: 16:28:58 | 21 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 16:28:58,267: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 16:28:58,267: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 16:28:58,291: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 16:28:58,293: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 16:28:58,293: Re-using an available connection from the pool.
2018-02-06 16:28:58,294: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 16:28:58,295: Re-using an available connection from the pool.
2018-02-06 16:28:58,388: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 16:28:58,399: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 16:28:58,792: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11004ea20>]}
2018-02-06 16:28:59,054: 16:28:59 | 21 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.52s]
2018-02-06 16:29:02,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff77b00>]}
2018-02-06 16:29:03,096: 16:29:03 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 4.37s]
2018-02-06 16:29:03,097: 16:29:03 | 22 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 16:29:03,098: Compiling model.seo_audit.semrush_url_stats
2018-02-06 16:29:03,097: 16:29:03 | 24 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 16:29:03,097: 16:29:03 | 23 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 16:29:03,107: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 16:29:03,108: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 16:29:03,108: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 16:29:03,114: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 16:29:03,120: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 16:29:03,121: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 16:29:03,121: Re-using an available connection from the pool.
2018-02-06 16:29:03,125: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 16:29:03,125: Re-using an available connection from the pool.
2018-02-06 16:29:03,127: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 16:29:03,127: Re-using an available connection from the pool.
2018-02-06 16:29:03,218: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:29:03,226: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:29:03,236: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 16:29:03,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110065a20>]}
2018-02-06 16:29:03,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff8bf98>]}
2018-02-06 16:29:03,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff9d0b8>]}
2018-02-06 16:29:04,125: 16:29:04 | 23 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.51s]
2018-02-06 16:29:04,638: 16:29:04 | 22 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.53s]
2018-02-06 16:29:05,166: 16:29:05 | 24 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.59s]
2018-02-06 16:29:05,167: 16:29:05 | 25 of 28 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-06 16:29:05,168: 16:29:05 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 16:29:05,168: Compiling model.seo_audit.agg_stats
2018-02-06 16:29:05,180: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 16:29:05,184: Acquiring new bigquery connection "agg_stats".
2018-02-06 16:29:05,184: Re-using an available connection from the pool.
2018-02-06 16:29:05,270: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 16:29:05,837: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff9d0b8>]}
2018-02-06 16:29:06,290: 16:29:06 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.67s]
2018-02-06 16:29:06,291: 16:29:06 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 16:29:06,291: Compiling model.seo_audit.agg_stats_client
2018-02-06 16:29:06,303: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 16:29:06,305: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 16:29:06,305: Re-using an available connection from the pool.
2018-02-06 16:29:06,411: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 16:29:07,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '144c7995-966c-4aeb-a2cf-08194d757b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff8bf98>]}
2018-02-06 16:29:07,813: 16:29:07 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.00s]
2018-02-06 16:29:07,813: 16:29:07 | 28 of 28 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-06 16:29:07,887: 16:29:07 | 
2018-02-06 16:29:07,887: 16:29:07 | Finished running 28 view models in 19.97s.
2018-02-06 16:29:07,887: Connection 'master' was left open.
2018-02-06 16:29:07,888: 
2018-02-06 16:29:07,888: Completed with 2 errors:
2018-02-06 16:29:07,888: 
2018-02-06 16:29:07,888: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-06 16:29:07,888:   Unrecognized name: source_url at [6:18]
2018-02-06 16:29:07,889:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-02-06 16:29:07,889: 
2018-02-06 16:29:07,889: Database Error in model sitemap_proc (models/base-adp/sitemap/sitemap_proc.sql)
2018-02-06 16:29:07,889:   Syntax error: Unexpected keyword LEFT at [20:1]
2018-02-06 16:29:07,889:   compiled SQL at target/compiled/seo_audit/base-adp/sitemap/sitemap_proc.sql
2018-02-06 16:29:07,890: 
Done. PASS=22 ERROR=2 SKIP=4 TOTAL=28
2018-02-06 16:29:07,890: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff77748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff778d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ff77780>]}
2018-02-06 16:29:08,348: Flushing usage events
2018-02-06 16:30:11,947: Tracking: tracking
2018-02-06 16:30:11,956: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a545908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5459b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5458d0>]}
2018-02-06 16:30:12,989: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 16:30:13,011: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 16:30:13,015: Parsing core.sql
2018-02-06 16:30:13,038: Parsing adapters/bigquery.sql
2018-02-06 16:30:13,050: Parsing adapters/common.sql
2018-02-06 16:30:13,069: Parsing adapters/postgres.sql
2018-02-06 16:30:13,077: Parsing adapters/redshift.sql
2018-02-06 16:30:13,125: Parsing etc/get_custom_schema.sql
2018-02-06 16:30:13,150: Parsing materializations/archive.sql
2018-02-06 16:30:13,238: Parsing materializations/bigquery.sql
2018-02-06 16:30:13,276: Parsing materializations/helpers.sql
2018-02-06 16:30:13,423: Parsing materializations/incremental.sql
2018-02-06 16:30:13,583: Parsing materializations/table.sql
2018-02-06 16:30:13,632: Parsing materializations/view.sql
2018-02-06 16:30:13,651: Parsing materializations/wrapper.sql
2018-02-06 16:30:13,658: Parsing schema_tests/accepted_values.sql
2018-02-06 16:30:13,665: Parsing schema_tests/not_null.sql
2018-02-06 16:30:13,674: Parsing schema_tests/relationships.sql
2018-02-06 16:30:13,679: Parsing schema_tests/unique.sql
2018-02-06 16:30:13,706: Parsing model.seo_audit.accounts_proc
2018-02-06 16:30:13,709: Parsing model.seo_audit.all_dates
2018-02-06 16:30:13,710: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 16:30:13,712: Acquiring new bigquery connection "master".
2018-02-06 16:30:13,712: Opening a new connection (0 currently allocated)
2018-02-06 16:30:13,720: Parsing model.seo_audit.agg_all
2018-02-06 16:30:13,723: Parsing model.seo_audit.agg_indicative
2018-02-06 16:30:13,726: Parsing model.seo_audit.agg_stats
2018-02-06 16:30:13,730: Parsing model.seo_audit.agg_stats_client
2018-02-06 16:30:13,735: Parsing model.seo_audit.deepcrawl_class
2018-02-06 16:30:13,738: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 16:30:13,741: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 16:30:13,743: Parsing model.seo_audit.ga_proc
2018-02-06 16:30:13,746: Parsing model.seo_audit.ga_stats
2018-02-06 16:30:13,749: Parsing model.seo_audit.majestic_domain_history
2018-02-06 16:30:13,751: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 16:30:13,754: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 16:30:13,758: Parsing model.seo_audit.moz_proc
2018-02-06 16:30:13,763: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 16:30:13,775: Parsing model.seo_audit.search_console_history
2018-02-06 16:30:13,780: Parsing model.seo_audit.search_console_proc
2018-02-06 16:30:13,783: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 16:30:13,788: Parsing model.seo_audit.search_console_stats_url
2018-02-06 16:30:13,790: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 16:30:13,794: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 16:30:13,798: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 16:30:13,803: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 16:30:13,811: Parsing model.seo_audit.semrush_url_history
2018-02-06 16:30:13,833: Parsing model.seo_audit.semrush_url_stats
2018-02-06 16:30:13,842: Parsing model.seo_audit.sitemap_proc
2018-02-06 16:30:13,867: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 16:30:13,881: 
2018-02-06 16:30:14,940: 16:30:14 | Concurrency: 4 threads (target='dev')
2018-02-06 16:30:14,940: 16:30:14 | 
2018-02-06 16:30:15,222: 16:30:15 | 1 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 16:30:15,223: Compiling model.seo_audit.accounts_proc
2018-02-06 16:30:15,222: 16:30:15 | 2 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 16:30:15,233: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 16:30:15,234: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 16:30:15,223: 16:30:15 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 16:30:15,242: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 16:30:15,243: Compiling model.seo_audit.all_dates
2018-02-06 16:30:15,243: Acquiring new bigquery connection "accounts_proc".
2018-02-06 16:30:15,249: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 16:30:15,249: Opening a new connection (1 currently allocated)
2018-02-06 16:30:15,251: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 16:30:15,254: Acquiring new bigquery connection "all_dates".
2018-02-06 16:30:15,255: Opening a new connection (2 currently allocated)
2018-02-06 16:30:15,326: Opening a new connection (3 currently allocated)
2018-02-06 16:30:16,395: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 16:30:16,536: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 16:30:16,538: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 16:30:16,905: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d73a278>]}
2018-02-06 16:30:16,906: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7fca20>]}
2018-02-06 16:30:16,907: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d803438>]}
2018-02-06 16:30:17,188: 16:30:17 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.66s]
2018-02-06 16:30:17,667: 16:30:17 | 1 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.68s]
2018-02-06 16:30:18,170: 16:30:18 | 2 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.67s]
2018-02-06 16:30:18,171: 16:30:18 | 4 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 16:30:18,171: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 16:30:18,171: 16:30:18 | 5 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 16:30:18,178: Compiling model.seo_audit.moz_proc
2018-02-06 16:30:18,171: 16:30:18 | 6 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 16:30:18,189: Compiling model.seo_audit.sitemap_proc
2018-02-06 16:30:18,186: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 16:30:18,189: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 16:30:18,199: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 16:30:18,171: 16:30:18 | 7 of 28 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-06 16:30:18,200: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 16:30:18,212: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 16:30:18,213: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 16:30:18,214: Re-using an available connection from the pool.
2018-02-06 16:30:18,216: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 16:30:18,217: Re-using an available connection from the pool.
2018-02-06 16:30:18,239: Acquiring new bigquery connection "moz_proc".
2018-02-06 16:30:18,239: Re-using an available connection from the pool.
2018-02-06 16:30:18,250: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 16:30:18,250: Opening a new connection (4 currently allocated)
2018-02-06 16:30:18,567: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 16:30:18,690: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:30:18,706: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 16:30:18,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82b080>]}
2018-02-06 16:30:19,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7fcdd8>]}
2018-02-06 16:30:19,094: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bb00>]}
2018-02-06 16:30:19,291: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 16:30:19,521: 16:30:19 | 6 of 28 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.81s]
2018-02-06 16:30:19,522: 16:30:19 | 8 of 28 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-06 16:30:19,523: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 16:30:19,533: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 16:30:19,536: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 16:30:19,537: Re-using an available connection from the pool.
2018-02-06 16:30:19,736: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:30:19,790: 16:30:19 | 4 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.84s]
2018-02-06 16:30:19,792: 16:30:19 | 9 of 28 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-06 16:30:19,794: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 16:30:19,802: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 16:30:19,805: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 16:30:19,805: Re-using an available connection from the pool.
2018-02-06 16:30:19,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d803438>]}
2018-02-06 16:30:20,048: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 16:30:20,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82b080>]}
2018-02-06 16:30:20,242: 16:30:20 | 5 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.92s]
2018-02-06 16:30:20,243: 16:30:20 | 10 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 16:30:20,244: Compiling model.seo_audit.search_console_proc
2018-02-06 16:30:20,254: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 16:30:20,257: Acquiring new bigquery connection "search_console_proc".
2018-02-06 16:30:20,259: Re-using an available connection from the pool.
2018-02-06 16:30:20,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d78a6a0>]}
2018-02-06 16:30:20,691: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:30:20,726: 16:30:20 | 7 of 28 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 1.61s]
2018-02-06 16:30:20,727: 16:30:20 | 11 of 28 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-06 16:30:20,727: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 16:30:20,736: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 16:30:20,738: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 16:30:20,739: Re-using an available connection from the pool.
2018-02-06 16:30:21,128: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 16:30:21,134: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bb00>]}
2018-02-06 16:30:21,255: 16:30:21 | 8 of 28 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.55s]
2018-02-06 16:30:21,256: 16:30:21 | 12 of 28 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-06 16:30:21,256: Compiling model.seo_audit.ga_proc
2018-02-06 16:30:21,262: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 16:30:21,265: Acquiring new bigquery connection "ga_proc".
2018-02-06 16:30:21,266: Re-using an available connection from the pool.
2018-02-06 16:30:21,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d827400>]}
2018-02-06 16:30:21,768: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 16:30:21,785: 16:30:21 | 9 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.78s]
2018-02-06 16:30:21,786: 16:30:21 | 13 of 28 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-06 16:30:21,787: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 16:30:21,797: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 16:30:21,801: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 16:30:21,801: Re-using an available connection from the pool.
2018-02-06 16:30:22,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82b080>]}
2018-02-06 16:30:22,241: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:30:22,264: 16:30:22 | 10 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.89s]
2018-02-06 16:30:22,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8274e0>]}
2018-02-06 16:30:22,733: 16:30:22 | 11 of 28 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.89s]
2018-02-06 16:30:23,235: 16:30:23 | 12 of 28 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.88s]
2018-02-06 16:30:23,809: 16:30:23 | 13 of 28 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.88s]
2018-02-06 16:30:23,810: 16:30:23 | 14 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 16:30:23,810: 16:30:23 | 15 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 16:30:23,811: 16:30:23 | 16 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 16:30:23,811: 16:30:23 | 17 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 16:30:23,811: Compiling model.seo_audit.ga_stats
2018-02-06 16:30:23,812: Compiling model.seo_audit.majestic_domain_history
2018-02-06 16:30:23,812: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 16:30:23,812: Compiling model.seo_audit.semrush_url_history
2018-02-06 16:30:23,823: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 16:30:23,824: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 16:30:23,829: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 16:30:23,834: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 16:30:23,835: Acquiring new bigquery connection "ga_stats".
2018-02-06 16:30:23,836: Re-using an available connection from the pool.
2018-02-06 16:30:23,837: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 16:30:23,837: Re-using an available connection from the pool.
2018-02-06 16:30:23,838: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 16:30:23,838: Re-using an available connection from the pool.
2018-02-06 16:30:23,842: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 16:30:23,844: Re-using an available connection from the pool.
2018-02-06 16:30:24,255: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 16:30:24,257: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 16:30:24,258: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 16:30:24,263: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 16:30:24,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bf98>]}
2018-02-06 16:30:24,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d78a978>]}
2018-02-06 16:30:24,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d83a390>]}
2018-02-06 16:30:24,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d83a160>]}
2018-02-06 16:30:25,059: 16:30:25 | 17 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.95s]
2018-02-06 16:30:25,060: 16:30:25 | 18 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 16:30:25,062: Compiling model.seo_audit.search_console_history
2018-02-06 16:30:25,072: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 16:30:25,074: Acquiring new bigquery connection "search_console_history".
2018-02-06 16:30:25,075: Re-using an available connection from the pool.
2018-02-06 16:30:25,502: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 16:30:25,547: 16:30:25 | 15 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.95s]
2018-02-06 16:30:25,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bf98>]}
2018-02-06 16:30:26,335: 16:30:26 | 16 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.95s]
2018-02-06 16:30:26,568: 16:30:26 | 14 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.95s]
2018-02-06 16:30:27,026: 16:30:27 | 18 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.90s]
2018-02-06 16:30:27,027: 16:30:27 | 19 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 16:30:27,027: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 16:30:27,027: 16:30:27 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 16:30:27,038: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 16:30:27,027: 16:30:27 | 21 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 16:30:27,038: Compiling model.seo_audit.search_console_stats_url
2018-02-06 16:30:27,038: Compiling model.seo_audit.deepcrawl_class
2018-02-06 16:30:27,043: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 16:30:27,049: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 16:30:27,050: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 16:30:27,050: Re-using an available connection from the pool.
2018-02-06 16:30:27,051: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 16:30:27,052: Re-using an available connection from the pool.
2018-02-06 16:30:27,055: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 16:30:27,056: Re-using an available connection from the pool.
2018-02-06 16:30:27,382: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_below_avg_prices,
	flag_learn_more,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 16:30:27,485: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 16:30:27,519: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 16:30:27,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bb00>]}
2018-02-06 16:30:27,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d776cf8>]}
2018-02-06 16:30:27,945: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d83af28>]}
2018-02-06 16:30:28,196: 16:30:28 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.92s]
2018-02-06 16:30:28,650: 16:30:28 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.91s]
2018-02-06 16:30:29,076: 16:30:29 | 21 of 28 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.91s]
2018-02-06 16:30:29,077: 16:30:29 | 22 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 16:30:29,077: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 16:30:29,085: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 16:30:29,077: 16:30:29 | 23 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 16:30:29,077: 16:30:29 | 24 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 16:30:29,086: Compiling model.seo_audit.semrush_url_stats
2018-02-06 16:30:29,086: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 16:30:29,102: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 16:30:29,106: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 16:30:29,106: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 16:30:29,107: Re-using an available connection from the pool.
2018-02-06 16:30:29,108: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 16:30:29,109: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 16:30:29,110: Re-using an available connection from the pool.
2018-02-06 16:30:29,113: Re-using an available connection from the pool.
2018-02-06 16:30:29,576: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:30:29,582: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:30:29,584: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 16:30:30,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d78a4a8>]}
2018-02-06 16:30:30,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d78a6a0>]}
2018-02-06 16:30:30,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bf98>]}
2018-02-06 16:30:30,248: 16:30:30 | 24 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.92s]
2018-02-06 16:30:30,739: 16:30:30 | 23 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.93s]
2018-02-06 16:30:31,226: 16:30:31 | 22 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.94s]
2018-02-06 16:30:31,227: 16:30:31 | 25 of 28 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-06 16:30:31,227: Compiling model.seo_audit.agg_indicative
2018-02-06 16:30:31,237: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 16:30:31,241: Acquiring new bigquery connection "agg_indicative".
2018-02-06 16:30:31,241: Re-using an available connection from the pool.
2018-02-06 16:30:31,340: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-06 16:30:31,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bb00>]}
2018-02-06 16:30:32,317: 16:30:32 | 25 of 28 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.63s]
2018-02-06 16:30:32,318: 16:30:32 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 16:30:32,319: Compiling model.seo_audit.agg_stats
2018-02-06 16:30:32,331: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 16:30:32,332: Acquiring new bigquery connection "agg_stats".
2018-02-06 16:30:32,332: Re-using an available connection from the pool.
2018-02-06 16:30:32,814: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 16:30:33,367: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bf98>]}
2018-02-06 16:30:33,791: 16:30:33 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 1.05s]
2018-02-06 16:30:33,792: 16:30:33 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 16:30:33,792: Compiling model.seo_audit.agg_stats_client
2018-02-06 16:30:33,802: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 16:30:33,803: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 16:30:33,803: Re-using an available connection from the pool.
2018-02-06 16:30:34,200: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 16:30:34,869: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d82bb00>]}
2018-02-06 16:30:35,338: 16:30:35 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.08s]
2018-02-06 16:30:35,339: 16:30:35 | 28 of 28 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-06 16:30:35,339: Compiling model.seo_audit.agg_all
2018-02-06 16:30:35,345: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 16:30:35,348: Acquiring new bigquery connection "agg_all".
2018-02-06 16:30:35,348: Re-using an available connection from the pool.
2018-02-06 16:30:35,451: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 16:30:36,056: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
sitemap,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 16:30:36,056: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: title; Did you mean date? at [5:1]
2018-02-06 16:30:36,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d78de7b-e734-49b2-80d3-544e9cd1b5b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d830828>]}
2018-02-06 16:30:36,554: 16:30:36 | 28 of 28 ERROR creating view model seo_audit_dev.agg_all............. [ERROR in 0.72s]
2018-02-06 16:30:36,608: 16:30:36 | 
2018-02-06 16:30:36,608: 16:30:36 | Finished running 28 view models in 21.67s.
2018-02-06 16:30:36,608: Connection 'master' was left open.
2018-02-06 16:30:36,608: 
2018-02-06 16:30:36,608: Completed with 1 errors:
2018-02-06 16:30:36,609: 
2018-02-06 16:30:36,609: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-06 16:30:36,609:   Unrecognized name: title; Did you mean date? at [5:1]
2018-02-06 16:30:36,609:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-06 16:30:36,609: 
Done. PASS=27 ERROR=1 SKIP=0 TOTAL=28
2018-02-06 16:30:36,610: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d722828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d722fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7227b8>]}
2018-02-06 16:30:37,116: Flushing usage events
2018-02-06 16:45:43,595: Tracking: tracking
2018-02-06 16:45:43,597: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106f3da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106f3908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106f3f60>]}
2018-02-06 16:45:44,424: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 16:45:44,447: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 16:45:44,453: Parsing core.sql
2018-02-06 16:45:44,483: Parsing adapters/bigquery.sql
2018-02-06 16:45:44,494: Parsing adapters/common.sql
2018-02-06 16:45:44,519: Parsing adapters/postgres.sql
2018-02-06 16:45:44,528: Parsing adapters/redshift.sql
2018-02-06 16:45:44,555: Parsing etc/get_custom_schema.sql
2018-02-06 16:45:44,565: Parsing materializations/archive.sql
2018-02-06 16:45:44,606: Parsing materializations/bigquery.sql
2018-02-06 16:45:44,627: Parsing materializations/helpers.sql
2018-02-06 16:45:44,645: Parsing materializations/incremental.sql
2018-02-06 16:45:44,674: Parsing materializations/table.sql
2018-02-06 16:45:44,698: Parsing materializations/view.sql
2018-02-06 16:45:44,718: Parsing materializations/wrapper.sql
2018-02-06 16:45:44,724: Parsing schema_tests/accepted_values.sql
2018-02-06 16:45:44,733: Parsing schema_tests/not_null.sql
2018-02-06 16:45:44,737: Parsing schema_tests/relationships.sql
2018-02-06 16:45:44,742: Parsing schema_tests/unique.sql
2018-02-06 16:45:44,779: Parsing model.seo_audit.accounts_proc
2018-02-06 16:45:44,781: Parsing model.seo_audit.all_dates
2018-02-06 16:45:44,782: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 16:45:44,784: Acquiring new bigquery connection "master".
2018-02-06 16:45:44,785: Opening a new connection (0 currently allocated)
2018-02-06 16:45:44,794: Parsing model.seo_audit.agg_all
2018-02-06 16:45:44,797: Parsing model.seo_audit.agg_indicative
2018-02-06 16:45:44,799: Parsing model.seo_audit.agg_stats
2018-02-06 16:45:44,804: Parsing model.seo_audit.agg_stats_client
2018-02-06 16:45:44,807: Parsing model.seo_audit.deepcrawl_class
2018-02-06 16:45:44,809: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 16:45:44,811: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 16:45:44,813: Parsing model.seo_audit.ga_proc
2018-02-06 16:45:44,816: Parsing model.seo_audit.ga_stats
2018-02-06 16:45:44,817: Parsing model.seo_audit.majestic_domain_history
2018-02-06 16:45:44,819: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 16:45:44,821: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 16:45:44,825: Parsing model.seo_audit.moz_proc
2018-02-06 16:45:44,830: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 16:45:44,834: Parsing model.seo_audit.search_console_history
2018-02-06 16:45:44,836: Parsing model.seo_audit.search_console_proc
2018-02-06 16:45:44,839: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 16:45:44,841: Parsing model.seo_audit.search_console_stats_url
2018-02-06 16:45:44,843: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 16:45:44,846: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 16:45:44,849: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 16:45:44,851: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 16:45:44,854: Parsing model.seo_audit.semrush_url_history
2018-02-06 16:45:44,856: Parsing model.seo_audit.semrush_url_stats
2018-02-06 16:45:44,858: Parsing model.seo_audit.sitemap_proc
2018-02-06 16:45:44,871: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 16:45:44,885: 
2018-02-06 16:45:46,100: 16:45:46 | Concurrency: 4 threads (target='dev')
2018-02-06 16:45:46,100: 16:45:46 | 
2018-02-06 16:45:46,349: 16:45:46 | 1 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 16:45:46,349: Compiling model.seo_audit.all_dates
2018-02-06 16:45:46,349: 16:45:46 | 2 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 16:45:46,354: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 16:45:46,349: 16:45:46 | 3 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 16:45:46,354: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 16:45:46,354: Compiling model.seo_audit.accounts_proc
2018-02-06 16:45:46,361: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 16:45:46,367: Acquiring new bigquery connection "all_dates".
2018-02-06 16:45:46,372: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 16:45:46,373: Opening a new connection (1 currently allocated)
2018-02-06 16:45:46,378: Acquiring new bigquery connection "accounts_proc".
2018-02-06 16:45:46,434: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 16:45:46,438: Opening a new connection (2 currently allocated)
2018-02-06 16:45:46,443: Opening a new connection (3 currently allocated)
2018-02-06 16:45:47,007: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 16:45:47,013: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 16:45:47,023: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 16:45:47,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108c99e8>]}
2018-02-06 16:45:47,263: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110842860>]}
2018-02-06 16:45:47,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108009e8>]}
2018-02-06 16:45:47,498: 16:45:47 | 3 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.90s]
2018-02-06 16:45:47,725: 16:45:47 | 1 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.91s]
2018-02-06 16:45:48,135: 16:45:48 | 2 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.94s]
2018-02-06 16:45:48,136: 16:45:48 | 4 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 16:45:48,137: 16:45:48 | 5 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 16:45:48,137: 16:45:48 | 6 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 16:45:48,137: 16:45:48 | 7 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 16:45:48,137: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 16:45:48,137: Compiling model.seo_audit.ga_proc
2018-02-06 16:45:48,138: Compiling model.seo_audit.moz_proc
2018-02-06 16:45:48,138: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 16:45:48,153: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 16:45:48,158: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 16:45:48,158: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 16:45:48,163: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 16:45:48,167: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 16:45:48,168: Re-using an available connection from the pool.
2018-02-06 16:45:48,169: Acquiring new bigquery connection "moz_proc".
2018-02-06 16:45:48,169: Re-using an available connection from the pool.
2018-02-06 16:45:48,170: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 16:45:48,170: Re-using an available connection from the pool.
2018-02-06 16:45:48,172: Acquiring new bigquery connection "ga_proc".
2018-02-06 16:45:48,173: Opening a new connection (4 currently allocated)
2018-02-06 16:45:48,377: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 16:45:48,390: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:45:48,395: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 16:45:48,690: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e4080>]}
2018-02-06 16:45:48,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e4da0>]}
2018-02-06 16:45:48,825: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 16:45:48,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110842898>]}
2018-02-06 16:45:48,914: 16:45:48 | 7 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.55s]
2018-02-06 16:45:48,915: 16:45:48 | 8 of 28 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-06 16:45:48,915: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 16:45:48,921: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 16:45:48,925: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 16:45:48,925: Re-using an available connection from the pool.
2018-02-06 16:45:49,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e4898>]}
2018-02-06 16:45:49,140: 16:45:49 | 6 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.56s]
2018-02-06 16:45:49,141: 16:45:49 | 9 of 28 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-06 16:45:49,142: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 16:45:49,148: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 16:45:49,150: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 16:45:49,150: Re-using an available connection from the pool.
2018-02-06 16:45:49,360: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price < avg_cur_price then 1 else 0 end as flag_below_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resources|articles') then 1 else 0 end as flag_blog_path

FROM 
 (
  SELECT
  url,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type)
  )
2018-02-06 16:45:49,420: 16:45:49 | 4 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.71s]
2018-02-06 16:45:49,423: 16:45:49 | 10 of 28 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-06 16:45:49,424: Compiling model.seo_audit.sitemap_proc
2018-02-06 16:45:49,437: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 16:45:49,439: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 16:45:49,439: Re-using an available connection from the pool.
2018-02-06 16:45:49,651: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 16:45:49,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e4da0>]}
2018-02-06 16:45:49,682: 16:45:49 | 5 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.99s]
2018-02-06 16:45:49,682: 16:45:49 | 11 of 28 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-06 16:45:49,682: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 16:45:49,694: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 16:45:49,697: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 16:45:49,698: Re-using an available connection from the pool.
2018-02-06 16:45:49,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110843a20>]}
2018-02-06 16:45:49,923: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:45:49,924: 16:45:49 | 9 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.53s]
2018-02-06 16:45:49,925: 16:45:49 | 12 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 16:45:49,926: Compiling model.seo_audit.search_console_proc
2018-02-06 16:45:49,937: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 16:45:49,941: Acquiring new bigquery connection "search_console_proc".
2018-02-06 16:45:49,941: Re-using an available connection from the pool.
2018-02-06 16:45:50,146: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 16:45:50,177: 16:45:50 | 10 of 28 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.49s]
2018-02-06 16:45:50,177: 16:45:50 | 13 of 28 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-06 16:45:50,178: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 16:45:50,187: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 16:45:50,188: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 16:45:50,188: Re-using an available connection from the pool.
2018-02-06 16:45:50,214: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108db2e8>]}
2018-02-06 16:45:50,398: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 16:45:50,473: 16:45:50 | 11 of 28 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.53s]
2018-02-06 16:45:50,561: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e4da0>]}
2018-02-06 16:45:50,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110843a20>]}
2018-02-06 16:45:50,808: 16:45:50 | 12 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.63s]
2018-02-06 16:45:50,826: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 16:45:51,050: 16:45:51 | 13 of 28 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.52s]
2018-02-06 16:45:51,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108dbda0>]}
2018-02-06 16:45:51,368: 16:45:51 | 8 of 28 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 2.21s]
2018-02-06 16:45:51,369: 16:45:51 | 14 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 16:45:51,369: 16:45:51 | 15 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 16:45:51,369: 16:45:51 | 16 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 16:45:51,369: 16:45:51 | 17 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 16:45:51,370: Compiling model.seo_audit.search_console_history
2018-02-06 16:45:51,370: Compiling model.seo_audit.semrush_url_history
2018-02-06 16:45:51,370: Compiling model.seo_audit.ga_stats
2018-02-06 16:45:51,370: Compiling model.seo_audit.majestic_domain_history
2018-02-06 16:45:51,382: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 16:45:51,383: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 16:45:51,388: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 16:45:51,392: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 16:45:51,394: Acquiring new bigquery connection "search_console_history".
2018-02-06 16:45:51,394: Re-using an available connection from the pool.
2018-02-06 16:45:51,396: Acquiring new bigquery connection "ga_stats".
2018-02-06 16:45:51,397: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 16:45:51,397: Re-using an available connection from the pool.
2018-02-06 16:45:51,398: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 16:45:51,399: Re-using an available connection from the pool.
2018-02-06 16:45:51,401: Re-using an available connection from the pool.
2018-02-06 16:45:51,599: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 16:45:51,610: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 16:45:51,620: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 16:45:51,638: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 16:45:51,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108439e8>]}
2018-02-06 16:45:51,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110921da0>]}
2018-02-06 16:45:51,910: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110843a90>]}
2018-02-06 16:45:51,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108db2e8>]}
2018-02-06 16:45:52,122: 16:45:52 | 15 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.53s]
2018-02-06 16:45:52,123: 16:45:52 | 18 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 16:45:52,123: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 16:45:52,130: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 16:45:52,133: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 16:45:52,133: Re-using an available connection from the pool.
2018-02-06 16:45:52,335: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 16:45:52,367: 16:45:52 | 16 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.53s]
2018-02-06 16:45:52,599: 16:45:52 | 14 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.54s]
2018-02-06 16:45:52,740: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108439e8>]}
2018-02-06 16:45:52,827: 16:45:52 | 17 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.55s]
2018-02-06 16:45:53,062: 16:45:53 | 18 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.62s]
2018-02-06 16:45:53,063: 16:45:53 | 19 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 16:45:53,063: 16:45:53 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 16:45:53,064: Compiling model.seo_audit.search_console_stats_url
2018-02-06 16:45:53,063: 16:45:53 | 21 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 16:45:53,063: Compiling model.seo_audit.deepcrawl_class
2018-02-06 16:45:53,068: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 16:45:53,068: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 16:45:53,073: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 16:45:53,079: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 16:45:53,080: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 16:45:53,080: Re-using an available connection from the pool.
2018-02-06 16:45:53,082: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 16:45:53,082: Re-using an available connection from the pool.
2018-02-06 16:45:53,085: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 16:45:53,085: Re-using an available connection from the pool.
2018-02-06 16:45:53,263: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( category_score <=1 and flag_below_avg_prices = 0) then 'product_category'
	when ( product_score < 2 and flag_learn_more = 1 ) then 'info_category'
	when article_score >= 1 then 'article'
	when product_score < 2 then 'info'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_below_avg_prices,
	flag_learn_more,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_below_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 16:45:53,292: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 16:45:53,296: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 16:45:53,702: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108dbda0>]}
2018-02-06 16:45:53,707: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108db358>]}
2018-02-06 16:45:53,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108db5f8>]}
2018-02-06 16:45:53,938: 16:45:53 | 19 of 28 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.64s]
2018-02-06 16:45:54,182: 16:45:54 | 21 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.64s]
2018-02-06 16:45:54,432: 16:45:54 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-06 16:45:54,433: 16:45:54 | 22 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 16:45:54,434: 16:45:54 | 23 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 16:45:54,434: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 16:45:54,434: 16:45:54 | 24 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 16:45:54,435: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 16:45:54,443: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 16:45:54,443: Compiling model.seo_audit.semrush_url_stats
2018-02-06 16:45:54,450: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 16:45:54,459: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 16:45:54,460: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 16:45:54,460: Re-using an available connection from the pool.
2018-02-06 16:45:54,461: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 16:45:54,462: Re-using an available connection from the pool.
2018-02-06 16:45:54,463: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 16:45:54,463: Re-using an available connection from the pool.
2018-02-06 16:45:54,670: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:45:54,677: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 16:45:54,692: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 16:45:54,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108439e8>]}
2018-02-06 16:45:55,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108009e8>]}
2018-02-06 16:45:55,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11091e470>]}
2018-02-06 16:45:55,251: 16:45:55 | 22 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.56s]
2018-02-06 16:45:55,478: 16:45:55 | 23 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.61s]
2018-02-06 16:45:55,710: 16:45:55 | 24 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.65s]
2018-02-06 16:45:55,711: 16:45:55 | 25 of 28 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-06 16:45:55,712: Compiling model.seo_audit.agg_indicative
2018-02-06 16:45:55,719: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 16:45:55,720: Acquiring new bigquery connection "agg_indicative".
2018-02-06 16:45:55,720: Re-using an available connection from the pool.
2018-02-06 16:45:55,916: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-06 16:45:56,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110842668>]}
2018-02-06 16:45:56,763: 16:45:56 | 25 of 28 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.77s]
2018-02-06 16:45:56,764: 16:45:56 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 16:45:56,764: Compiling model.seo_audit.agg_stats
2018-02-06 16:45:56,773: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 16:45:56,774: Acquiring new bigquery connection "agg_stats".
2018-02-06 16:45:56,774: Re-using an available connection from the pool.
2018-02-06 16:45:56,961: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 16:45:57,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108009e8>]}
2018-02-06 16:45:57,819: 16:45:57 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.82s]
2018-02-06 16:45:57,820: 16:45:57 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 16:45:57,820: Compiling model.seo_audit.agg_stats_client
2018-02-06 16:45:57,831: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 16:45:57,832: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 16:45:57,832: Re-using an available connection from the pool.
2018-02-06 16:45:58,015: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 16:45:58,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110842668>]}
2018-02-06 16:45:58,856: 16:45:58 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.80s]
2018-02-06 16:45:58,857: 16:45:58 | 28 of 28 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-06 16:45:58,858: Compiling model.seo_audit.agg_all
2018-02-06 16:45:58,867: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 16:45:58,868: Acquiring new bigquery connection "agg_all".
2018-02-06 16:45:58,868: Re-using an available connection from the pool.
2018-02-06 16:45:58,937: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 16:45:59,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c8164d62-ca0b-4b20-8a4a-e33cc055a1bd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108009e8>]}
2018-02-06 16:46:02,641: 16:46:02 | 28 of 28 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.91s]
2018-02-06 16:46:02,705: 16:46:02 | 
2018-02-06 16:46:02,705: 16:46:02 | Finished running 28 view models in 16.61s.
2018-02-06 16:46:02,705: Connection 'master' was left open.
2018-02-06 16:46:02,706: 
2018-02-06 16:46:02,706: Completed successfully
2018-02-06 16:46:02,706: 
Done. PASS=28 ERROR=0 SKIP=0 TOTAL=28
2018-02-06 16:46:02,707: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1107da6d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1107da860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1107da710>]}
2018-02-06 16:46:05,109: Flushing usage events
2018-02-06 18:44:12,098: Tracking: tracking
2018-02-06 18:44:12,102: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf45c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf45e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf45fd0>]}
2018-02-06 18:44:12,903: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 18:44:12,933: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 18:44:12,940: Parsing core.sql
2018-02-06 18:44:12,963: Parsing adapters/bigquery.sql
2018-02-06 18:44:12,970: Parsing adapters/common.sql
2018-02-06 18:44:12,989: Parsing adapters/postgres.sql
2018-02-06 18:44:12,998: Parsing adapters/redshift.sql
2018-02-06 18:44:13,028: Parsing etc/get_custom_schema.sql
2018-02-06 18:44:13,037: Parsing materializations/archive.sql
2018-02-06 18:44:13,076: Parsing materializations/bigquery.sql
2018-02-06 18:44:13,093: Parsing materializations/helpers.sql
2018-02-06 18:44:13,120: Parsing materializations/incremental.sql
2018-02-06 18:44:13,152: Parsing materializations/table.sql
2018-02-06 18:44:13,175: Parsing materializations/view.sql
2018-02-06 18:44:13,194: Parsing materializations/wrapper.sql
2018-02-06 18:44:13,199: Parsing schema_tests/accepted_values.sql
2018-02-06 18:44:13,206: Parsing schema_tests/not_null.sql
2018-02-06 18:44:13,212: Parsing schema_tests/relationships.sql
2018-02-06 18:44:13,220: Parsing schema_tests/unique.sql
2018-02-06 18:44:13,341: Parsing model.seo_audit.accounts_proc
2018-02-06 18:44:13,346: Parsing model.seo_audit.all_dates
2018-02-06 18:44:13,348: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 18:44:13,355: Acquiring new bigquery connection "master".
2018-02-06 18:44:13,355: Opening a new connection (0 currently allocated)
2018-02-06 18:44:13,363: Parsing model.seo_audit.agg_all
2018-02-06 18:44:13,368: Parsing model.seo_audit.agg_indicative
2018-02-06 18:44:13,373: Parsing model.seo_audit.agg_stats
2018-02-06 18:44:13,383: Parsing model.seo_audit.agg_stats_client
2018-02-06 18:44:13,387: Parsing model.seo_audit.deepcrawl_class
2018-02-06 18:44:13,390: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 18:44:13,392: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 18:44:13,395: Parsing model.seo_audit.ga_proc
2018-02-06 18:44:13,397: Parsing model.seo_audit.ga_stats
2018-02-06 18:44:13,399: Parsing model.seo_audit.majestic_domain_history
2018-02-06 18:44:13,402: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 18:44:13,404: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 18:44:13,407: Parsing model.seo_audit.moz_proc
2018-02-06 18:44:13,410: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 18:44:13,413: Parsing model.seo_audit.search_console_history
2018-02-06 18:44:13,414: Parsing model.seo_audit.search_console_proc
2018-02-06 18:44:13,417: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 18:44:13,420: Parsing model.seo_audit.search_console_stats_url
2018-02-06 18:44:13,422: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 18:44:13,425: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 18:44:13,428: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 18:44:13,431: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 18:44:13,433: Parsing model.seo_audit.semrush_url_history
2018-02-06 18:44:13,435: Parsing model.seo_audit.semrush_url_stats
2018-02-06 18:44:13,437: Parsing model.seo_audit.sitemap_proc
2018-02-06 18:44:13,450: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 18:44:13,458: 
2018-02-06 18:44:14,670: 18:44:14 | Concurrency: 4 threads (target='dev')
2018-02-06 18:44:14,670: 18:44:14 | 
2018-02-06 18:44:14,962: 18:44:14 | 1 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 18:44:14,963: 18:44:14 | 2 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 18:44:14,963: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 18:44:14,963: Compiling model.seo_audit.accounts_proc
2018-02-06 18:44:14,963: 18:44:14 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 18:44:14,971: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 18:44:14,978: Compiling model.seo_audit.all_dates
2018-02-06 18:44:14,982: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 18:44:14,988: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 18:44:14,992: Acquiring new bigquery connection "accounts_proc".
2018-02-06 18:44:14,992: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 18:44:14,993: Opening a new connection (1 currently allocated)
2018-02-06 18:44:14,993: Acquiring new bigquery connection "all_dates".
2018-02-06 18:44:14,995: Opening a new connection (2 currently allocated)
2018-02-06 18:44:15,058: Opening a new connection (3 currently allocated)
2018-02-06 18:44:15,639: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 18:44:15,657: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 18:44:15,675: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 18:44:15,853: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06afd0>]}
2018-02-06 18:44:15,864: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0f5e10>]}
2018-02-06 18:44:15,879: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0f5cf8>]}
2018-02-06 18:44:16,118: 18:44:16 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.88s]
2018-02-06 18:44:16,367: 18:44:16 | 1 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.90s]
2018-02-06 18:44:16,580: 18:44:16 | 2 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.92s]
2018-02-06 18:44:16,581: 18:44:16 | 4 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 18:44:16,581: Compiling model.seo_audit.sitemap_proc
2018-02-06 18:44:16,589: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 18:44:16,581: 18:44:16 | 5 of 28 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-06 18:44:16,589: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 18:44:16,581: 18:44:16 | 7 of 28 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-06 18:44:16,581: 18:44:16 | 6 of 28 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-06 18:44:16,595: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 18:44:16,595: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 18:44:16,595: Compiling model.seo_audit.search_console_proc
2018-02-06 18:44:16,596: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 18:44:16,602: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 18:44:16,608: Re-using an available connection from the pool.
2018-02-06 18:44:16,609: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 18:44:16,611: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 18:44:16,614: Re-using an available connection from the pool.
2018-02-06 18:44:16,616: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 18:44:16,616: Re-using an available connection from the pool.
2018-02-06 18:44:16,620: Acquiring new bigquery connection "search_console_proc".
2018-02-06 18:44:16,623: Opening a new connection (4 currently allocated)
2018-02-06 18:44:16,853: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:44:16,857: Model SQL (deepcrawl_class_proc):
select
url_trimmed url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 18:44:17,098: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:44:17,118: Bad request while running:
select
url_trimmed url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 18:44:17,118: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: url at [41:27]
2018-02-06 18:44:17,119: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fdcf8>]}
2018-02-06 18:44:17,168: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fdc50>]}
2018-02-06 18:44:17,285: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 18:44:17,420: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fde10>]}
2018-02-06 18:44:17,443: 18:44:17 | 5 of 28 ERROR creating view model seo_audit_dev.deepcrawl_class_proc. [ERROR in 0.53s]
2018-02-06 18:44:17,444: 18:44:17 | 8 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 18:44:17,445: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 18:44:17,456: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 18:44:17,461: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 18:44:17,462: Re-using an available connection from the pool.
2018-02-06 18:44:17,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06a3c8>]}
2018-02-06 18:44:17,651: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 18:44:17,777: 18:44:17 | 7 of 28 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.57s]
2018-02-06 18:44:17,777: 18:44:17 | 9 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 18:44:17,777: Compiling model.seo_audit.moz_proc
2018-02-06 18:44:17,786: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 18:44:17,790: Acquiring new bigquery connection "moz_proc".
2018-02-06 18:44:17,790: Re-using an available connection from the pool.
2018-02-06 18:44:17,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fdcf8>]}
2018-02-06 18:44:17,999: 18:44:17 | 6 of 28 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.83s]
2018-02-06 18:44:18,003: 18:44:18 | 10 of 28 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-06 18:44:18,003: Compiling model.seo_audit.ga_proc
2018-02-06 18:44:18,012: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 18:44:18,013: Acquiring new bigquery connection "ga_proc".
2018-02-06 18:44:18,014: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:44:18,014: Re-using an available connection from the pool.
2018-02-06 18:44:18,217: 18:44:18 | 4 of 28 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 1.03s]
2018-02-06 18:44:18,218: 18:44:18 | 11 of 28 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-06 18:44:18,220: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 18:44:18,227: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 18:44:18,230: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 18:44:18,231: Re-using an available connection from the pool.
2018-02-06 18:44:18,281: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 18:44:18,340: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d146e48>]}
2018-02-06 18:44:18,488: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 18:44:18,518: 18:44:18 | 8 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.53s]
2018-02-06 18:44:18,520: 18:44:18 | 12 of 28 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-06 18:44:18,521: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 18:44:18,536: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 18:44:18,538: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 18:44:18,538: Re-using an available connection from the pool.
2018-02-06 18:44:18,578: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fde10>]}
2018-02-06 18:44:18,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d087ef0>]}
2018-02-06 18:44:18,826: 18:44:18 | 9 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.56s]
2018-02-06 18:44:18,827: 18:44:18 | 13 of 28 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-06 18:44:18,827: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 18:44:18,833: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 18:44:18,834: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 18:44:18,840: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 18:44:18,840: Re-using an available connection from the pool.
2018-02-06 18:44:19,067: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:44:19,068: 18:44:19 | 10 of 28 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.58s]
2018-02-06 18:44:19,117: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d02db38>]}
2018-02-06 18:44:19,282: 18:44:19 | 11 of 28 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.56s]
2018-02-06 18:44:19,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d087eb8>]}
2018-02-06 18:44:19,773: 18:44:19 | 12 of 28 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.60s]
2018-02-06 18:44:21,174: 18:44:21 | 13 of 28 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.56s]
2018-02-06 18:44:21,175: 18:44:21 | 14 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 18:44:21,175: 18:44:21 | 15 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 18:44:21,176: 18:44:21 | 16 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 18:44:21,176: 18:44:21 | 17 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 18:44:21,176: Compiling model.seo_audit.majestic_domain_history
2018-02-06 18:44:21,176: Compiling model.seo_audit.search_console_history
2018-02-06 18:44:21,177: Compiling model.seo_audit.ga_stats
2018-02-06 18:44:21,177: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 18:44:21,187: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 18:44:21,188: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 18:44:21,193: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 18:44:21,198: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 18:44:21,200: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 18:44:21,200: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 18:44:21,200: Acquiring new bigquery connection "search_console_history".
2018-02-06 18:44:21,201: Re-using an available connection from the pool.
2018-02-06 18:44:21,201: Acquiring new bigquery connection "ga_stats".
2018-02-06 18:44:21,202: Re-using an available connection from the pool.
2018-02-06 18:44:21,202: Re-using an available connection from the pool.
2018-02-06 18:44:21,204: Re-using an available connection from the pool.
2018-02-06 18:44:21,409: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 18:44:21,427: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 18:44:21,432: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 18:44:21,436: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 18:44:21,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d02db38>]}
2018-02-06 18:44:21,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fdc50>]}
2018-02-06 18:44:21,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d13f208>]}
2018-02-06 18:44:21,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d087240>]}
2018-02-06 18:44:21,987: 18:44:21 | 15 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.57s]
2018-02-06 18:44:21,988: 18:44:21 | 18 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 18:44:21,990: Compiling model.seo_audit.semrush_url_history
2018-02-06 18:44:22,000: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 18:44:22,002: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 18:44:22,002: Re-using an available connection from the pool.
2018-02-06 18:44:22,176: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 18:44:22,241: 18:44:22 | 16 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.57s]
2018-02-06 18:44:22,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d02db38>]}
2018-02-06 18:44:22,895: 18:44:22 | 14 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-06 18:44:23,208: 18:44:23 | 17 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.57s]
2018-02-06 18:44:23,509: 18:44:23 | 18 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.57s]
2018-02-06 18:44:23,510: 18:44:23 | 19 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 18:44:23,510: Compiling model.seo_audit.search_console_stats_url
2018-02-06 18:44:23,510: 18:44:23 | 20 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 18:44:23,520: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 18:44:23,510: 18:44:23 | 21 of 28 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-06 18:44:23,520: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 18:44:23,532: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 18:44:23,533: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 18:44:23,533: Re-using an available connection from the pool.
2018-02-06 18:44:23,535: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 18:44:23,535: Re-using an available connection from the pool.
2018-02-06 18:44:23,715: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 18:44:23,787: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 18:44:24,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d116550>]}
2018-02-06 18:44:24,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0fdc50>]}
2018-02-06 18:44:24,267: 18:44:24 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.55s]
2018-02-06 18:44:24,604: 18:44:24 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.64s]
2018-02-06 18:44:24,605: 18:44:24 | 22 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 18:44:24,605: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 18:44:24,605: 18:44:24 | 23 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 18:44:24,612: Compiling model.seo_audit.semrush_url_stats
2018-02-06 18:44:24,605: 18:44:24 | 24 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 18:44:24,628: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 18:44:24,636: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 18:44:24,638: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 18:44:24,643: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 18:44:24,644: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 18:44:24,645: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 18:44:24,645: Re-using an available connection from the pool.
2018-02-06 18:44:24,647: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 18:44:24,647: Re-using an available connection from the pool.
2018-02-06 18:44:24,649: Re-using an available connection from the pool.
2018-02-06 18:44:24,904: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:44:24,908: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 18:44:24,910: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:44:25,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d02db38>]}
2018-02-06 18:44:25,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d121ba8>]}
2018-02-06 18:44:25,532: 18:44:25 | 22 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.72s]
2018-02-06 18:44:25,834: 18:44:25 | 24 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.69s]
2018-02-06 18:44:26,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d081710>]}
2018-02-06 18:44:27,119: 18:44:27 | 23 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 2.25s]
2018-02-06 18:44:27,120: 18:44:27 | 25 of 28 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-06 18:44:27,121: 18:44:27 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 18:44:27,121: Compiling model.seo_audit.agg_stats
2018-02-06 18:44:27,134: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 18:44:27,135: Acquiring new bigquery connection "agg_stats".
2018-02-06 18:44:27,135: Re-using an available connection from the pool.
2018-02-06 18:44:27,369: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 18:44:28,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d114198>]}
2018-02-06 18:44:28,303: 18:44:28 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.90s]
2018-02-06 18:44:28,304: 18:44:28 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 18:44:28,304: Compiling model.seo_audit.agg_stats_client
2018-02-06 18:44:28,312: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 18:44:28,313: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 18:44:28,313: Re-using an available connection from the pool.
2018-02-06 18:44:28,526: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 18:44:29,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92d1955b-8cf7-4e48-8d01-be56c4a9016e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d114898>]}
2018-02-06 18:44:29,445: 18:44:29 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.84s]
2018-02-06 18:44:29,446: 18:44:29 | 28 of 28 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-06 18:44:29,530: 18:44:29 | 
2018-02-06 18:44:29,531: 18:44:29 | Finished running 28 view models in 14.86s.
2018-02-06 18:44:29,531: Connection 'master' was left open.
2018-02-06 18:44:29,531: 
2018-02-06 18:44:29,532: Completed with 1 errors:
2018-02-06 18:44:29,532: 
2018-02-06 18:44:29,532: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-06 18:44:29,533:   Unrecognized name: url at [41:27]
2018-02-06 18:44:29,533:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-06 18:44:29,533: 
Done. PASS=24 ERROR=1 SKIP=3 TOTAL=28
2018-02-06 18:44:29,533: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d04b2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d014518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0145f8>]}
2018-02-06 18:44:29,761: Flushing usage events
2018-02-06 18:45:23,084: Tracking: tracking
2018-02-06 18:45:23,086: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aec1d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10383e6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051aefd0>]}
2018-02-06 18:45:23,848: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 18:45:23,870: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 18:45:23,874: Parsing core.sql
2018-02-06 18:45:23,892: Parsing adapters/bigquery.sql
2018-02-06 18:45:23,900: Parsing adapters/common.sql
2018-02-06 18:45:23,915: Parsing adapters/postgres.sql
2018-02-06 18:45:23,921: Parsing adapters/redshift.sql
2018-02-06 18:45:23,944: Parsing etc/get_custom_schema.sql
2018-02-06 18:45:23,956: Parsing materializations/archive.sql
2018-02-06 18:45:23,994: Parsing materializations/bigquery.sql
2018-02-06 18:45:24,010: Parsing materializations/helpers.sql
2018-02-06 18:45:24,034: Parsing materializations/incremental.sql
2018-02-06 18:45:24,066: Parsing materializations/table.sql
2018-02-06 18:45:24,092: Parsing materializations/view.sql
2018-02-06 18:45:24,112: Parsing materializations/wrapper.sql
2018-02-06 18:45:24,121: Parsing schema_tests/accepted_values.sql
2018-02-06 18:45:24,129: Parsing schema_tests/not_null.sql
2018-02-06 18:45:24,135: Parsing schema_tests/relationships.sql
2018-02-06 18:45:24,142: Parsing schema_tests/unique.sql
2018-02-06 18:45:24,189: Parsing model.seo_audit.accounts_proc
2018-02-06 18:45:24,193: Parsing model.seo_audit.all_dates
2018-02-06 18:45:24,195: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 18:45:24,198: Acquiring new bigquery connection "master".
2018-02-06 18:45:24,198: Opening a new connection (0 currently allocated)
2018-02-06 18:45:24,202: Parsing model.seo_audit.agg_all
2018-02-06 18:45:24,205: Parsing model.seo_audit.agg_indicative
2018-02-06 18:45:24,207: Parsing model.seo_audit.agg_stats
2018-02-06 18:45:24,211: Parsing model.seo_audit.agg_stats_client
2018-02-06 18:45:24,214: Parsing model.seo_audit.deepcrawl_class
2018-02-06 18:45:24,217: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 18:45:24,220: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 18:45:24,221: Parsing model.seo_audit.ga_proc
2018-02-06 18:45:24,224: Parsing model.seo_audit.ga_stats
2018-02-06 18:45:24,226: Parsing model.seo_audit.majestic_domain_history
2018-02-06 18:45:24,227: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 18:45:24,230: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 18:45:24,232: Parsing model.seo_audit.moz_proc
2018-02-06 18:45:24,234: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 18:45:24,237: Parsing model.seo_audit.search_console_history
2018-02-06 18:45:24,239: Parsing model.seo_audit.search_console_proc
2018-02-06 18:45:24,241: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 18:45:24,244: Parsing model.seo_audit.search_console_stats_url
2018-02-06 18:45:24,245: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 18:45:24,248: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 18:45:24,250: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 18:45:24,253: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 18:45:24,255: Parsing model.seo_audit.semrush_url_history
2018-02-06 18:45:24,257: Parsing model.seo_audit.semrush_url_stats
2018-02-06 18:45:24,260: Parsing model.seo_audit.sitemap_proc
2018-02-06 18:45:24,272: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 18:45:24,279: 
2018-02-06 18:45:25,047: 18:45:25 | Concurrency: 4 threads (target='dev')
2018-02-06 18:45:25,047: 18:45:25 | 
2018-02-06 18:45:25,214: 18:45:25 | 1 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 18:45:25,215: Compiling model.seo_audit.accounts_proc
2018-02-06 18:45:25,214: 18:45:25 | 2 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 18:45:25,219: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 18:45:25,215: 18:45:25 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 18:45:25,220: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 18:45:25,220: Compiling model.seo_audit.all_dates
2018-02-06 18:45:25,221: Acquiring new bigquery connection "accounts_proc".
2018-02-06 18:45:25,225: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 18:45:25,229: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 18:45:25,229: Opening a new connection (1 currently allocated)
2018-02-06 18:45:25,282: Acquiring new bigquery connection "all_dates".
2018-02-06 18:45:25,282: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 18:45:25,283: Opening a new connection (2 currently allocated)
2018-02-06 18:45:25,287: Opening a new connection (3 currently allocated)
2018-02-06 18:45:25,795: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 18:45:25,803: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 18:45:25,814: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 18:45:25,977: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e8ef0>]}
2018-02-06 18:45:26,004: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e8d30>]}
2018-02-06 18:45:26,016: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e8d68>]}
2018-02-06 18:45:26,216: 18:45:26 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.76s]
2018-02-06 18:45:26,432: 18:45:26 | 2 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.78s]
2018-02-06 18:45:26,644: 18:45:26 | 1 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.80s]
2018-02-06 18:45:26,645: 18:45:26 | 4 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 18:45:26,646: Compiling model.seo_audit.sitemap_proc
2018-02-06 18:45:26,646: 18:45:26 | 5 of 28 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-06 18:45:26,655: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 18:45:26,646: 18:45:26 | 6 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 18:45:26,656: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 18:45:26,646: 18:45:26 | 7 of 28 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-06 18:45:26,656: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 18:45:26,663: Compiling model.seo_audit.search_console_proc
2018-02-06 18:45:26,664: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 18:45:26,674: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 18:45:26,686: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 18:45:26,688: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 18:45:26,688: Re-using an available connection from the pool.
2018-02-06 18:45:26,691: Acquiring new bigquery connection "search_console_proc".
2018-02-06 18:45:26,693: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 18:45:26,694: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 18:45:26,694: Re-using an available connection from the pool.
2018-02-06 18:45:26,698: Re-using an available connection from the pool.
2018-02-06 18:45:26,703: Opening a new connection (4 currently allocated)
2018-02-06 18:45:26,950: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:45:26,978: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:45:26,980: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 18:45:27,207: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 18:45:27,221: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d85f8>]}
2018-02-06 18:45:27,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ef518>]}
2018-02-06 18:45:27,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105385588>]}
2018-02-06 18:45:27,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e8e10>]}
2018-02-06 18:45:27,516: 18:45:27 | 5 of 28 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.57s]
2018-02-06 18:45:27,517: 18:45:27 | 8 of 28 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-06 18:45:27,519: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 18:45:27,529: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 18:45:27,534: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 18:45:27,534: Re-using an available connection from the pool.
2018-02-06 18:45:27,738: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 18:45:27,743: 18:45:27 | 7 of 28 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.59s]
2018-02-06 18:45:27,744: 18:45:27 | 9 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 18:45:27,745: Compiling model.seo_audit.ga_proc
2018-02-06 18:45:27,756: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 18:45:27,757: Acquiring new bigquery connection "ga_proc".
2018-02-06 18:45:27,758: Re-using an available connection from the pool.
2018-02-06 18:45:27,991: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 18:45:28,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d85f8>]}
2018-02-06 18:45:28,078: 18:45:28 | 4 of 28 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.67s]
2018-02-06 18:45:28,079: 18:45:28 | 10 of 28 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-06 18:45:28,079: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 18:45:28,087: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 18:45:28,090: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 18:45:28,091: Re-using an available connection from the pool.
2018-02-06 18:45:28,335: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 18:45:28,393: 18:45:28 | 6 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.83s]
2018-02-06 18:45:28,398: 18:45:28 | 11 of 28 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-06 18:45:28,398: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 18:45:28,410: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 18:45:28,413: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ef518>]}
2018-02-06 18:45:28,414: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 18:45:28,415: Re-using an available connection from the pool.
2018-02-06 18:45:28,523: Model SQL (deepcrawl_class_proc):
select
url_trimmed url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 18:45:28,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e7da0>]}
2018-02-06 18:45:28,643: 18:45:28 | 8 of 28 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.50s]
2018-02-06 18:45:28,645: 18:45:28 | 12 of 28 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-06 18:45:28,645: Compiling model.seo_audit.moz_proc
2018-02-06 18:45:28,657: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 18:45:28,659: Acquiring new bigquery connection "moz_proc".
2018-02-06 18:45:28,659: Re-using an available connection from the pool.
2018-02-06 18:45:28,760: Bad request while running:
select
url_trimmed url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 18:45:28,760: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: url_trimmed at [2:1]
2018-02-06 18:45:28,761: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e8e10>]}
2018-02-06 18:45:28,872: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:45:28,878: 18:45:28 | 9 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.67s]
2018-02-06 18:45:28,880: 18:45:28 | 13 of 28 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-06 18:45:28,880: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 18:45:28,892: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 18:45:28,893: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 18:45:28,894: Re-using an available connection from the pool.
2018-02-06 18:45:29,088: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:45:29,099: 18:45:29 | 10 of 28 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.51s]
2018-02-06 18:45:29,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053c2ef0>]}
2018-02-06 18:45:29,371: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ef518>]}
2018-02-06 18:45:29,396: 18:45:29 | 11 of 28 ERROR creating view model seo_audit_dev.deepcrawl_class_proc [ERROR in 0.36s]
2018-02-06 18:45:29,636: 18:45:29 | 12 of 28 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.51s]
2018-02-06 18:45:29,927: 18:45:29 | 13 of 28 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.49s]
2018-02-06 18:45:29,928: 18:45:29 | 14 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 18:45:29,928: 18:45:29 | 15 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 18:45:29,929: 18:45:29 | 16 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 18:45:29,929: 18:45:29 | 17 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 18:45:29,929: Compiling model.seo_audit.semrush_url_history
2018-02-06 18:45:29,929: Compiling model.seo_audit.majestic_domain_history
2018-02-06 18:45:29,929: Compiling model.seo_audit.search_console_history
2018-02-06 18:45:29,930: Compiling model.seo_audit.ga_stats
2018-02-06 18:45:29,937: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 18:45:29,942: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 18:45:29,947: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 18:45:29,952: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 18:45:29,953: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 18:45:29,953: Re-using an available connection from the pool.
2018-02-06 18:45:29,955: Acquiring new bigquery connection "search_console_history".
2018-02-06 18:45:29,955: Re-using an available connection from the pool.
2018-02-06 18:45:29,955: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 18:45:29,957: Re-using an available connection from the pool.
2018-02-06 18:45:29,958: Acquiring new bigquery connection "ga_stats".
2018-02-06 18:45:29,958: Re-using an available connection from the pool.
2018-02-06 18:45:30,145: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 18:45:30,146: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 18:45:30,148: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 18:45:30,182: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 18:45:30,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d05f8>]}
2018-02-06 18:45:30,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d8e48>]}
2018-02-06 18:45:30,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053854a8>]}
2018-02-06 18:45:30,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105385470>]}
2018-02-06 18:45:30,781: 18:45:30 | 17 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.55s]
2018-02-06 18:45:30,782: 18:45:30 | 18 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 18:45:30,782: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 18:45:30,794: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 18:45:30,795: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 18:45:30,796: Re-using an available connection from the pool.
2018-02-06 18:45:30,992: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 18:45:31,003: 18:45:31 | 16 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.55s]
2018-02-06 18:45:31,299: 18:45:31 | 15 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.56s]
2018-02-06 18:45:31,301: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d05f8>]}
2018-02-06 18:45:31,532: 18:45:31 | 14 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.58s]
2018-02-06 18:45:31,745: 18:45:31 | 18 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.52s]
2018-02-06 18:45:31,745: 18:45:31 | 19 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 18:45:31,746: 18:45:31 | 20 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 18:45:31,746: Compiling model.seo_audit.search_console_stats_url
2018-02-06 18:45:31,746: 18:45:31 | 21 of 28 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-06 18:45:31,747: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 18:45:31,756: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 18:45:31,765: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 18:45:31,766: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 18:45:31,766: Re-using an available connection from the pool.
2018-02-06 18:45:31,767: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 18:45:31,767: Re-using an available connection from the pool.
2018-02-06 18:45:31,977: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 18:45:32,003: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 18:45:32,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105293ef0>]}
2018-02-06 18:45:32,354: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ef518>]}
2018-02-06 18:45:32,508: 18:45:32 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.55s]
2018-02-06 18:45:32,805: 18:45:32 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.61s]
2018-02-06 18:45:32,806: 18:45:32 | 22 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 18:45:32,807: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 18:45:32,806: 18:45:32 | 23 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 18:45:32,816: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 18:45:32,806: 18:45:32 | 24 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 18:45:32,817: Compiling model.seo_audit.semrush_url_stats
2018-02-06 18:45:32,817: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 18:45:32,842: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 18:45:32,842: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 18:45:32,844: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 18:45:32,846: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 18:45:32,846: Re-using an available connection from the pool.
2018-02-06 18:45:32,848: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 18:45:32,848: Re-using an available connection from the pool.
2018-02-06 18:45:32,852: Re-using an available connection from the pool.
2018-02-06 18:45:33,045: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 18:45:33,057: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:45:33,058: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:45:33,421: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d05f8>]}
2018-02-06 18:45:33,423: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e7588>]}
2018-02-06 18:45:33,785: 18:45:33 | 22 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.61s]
2018-02-06 18:45:33,895: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053674a8>]}
2018-02-06 18:45:34,044: 18:45:34 | 24 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.61s]
2018-02-06 18:45:34,260: 18:45:34 | 23 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 1.08s]
2018-02-06 18:45:34,260: 18:45:34 | 25 of 28 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-06 18:45:34,261: 18:45:34 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 18:45:34,262: Compiling model.seo_audit.agg_stats
2018-02-06 18:45:34,274: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 18:45:34,275: Acquiring new bigquery connection "agg_stats".
2018-02-06 18:45:34,275: Re-using an available connection from the pool.
2018-02-06 18:45:34,476: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 18:45:35,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053674a8>]}
2018-02-06 18:45:35,313: 18:45:35 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-06 18:45:35,314: 18:45:35 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 18:45:35,314: Compiling model.seo_audit.agg_stats_client
2018-02-06 18:45:35,322: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 18:45:35,323: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 18:45:35,323: Re-using an available connection from the pool.
2018-02-06 18:45:35,518: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 18:45:36,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9fbfa67a-09e5-4a62-baa8-7ebbba3f42c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105293ef0>]}
2018-02-06 18:45:36,458: 18:45:36 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.85s]
2018-02-06 18:45:36,459: 18:45:36 | 28 of 28 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-06 18:45:36,565: 18:45:36 | 
2018-02-06 18:45:36,566: 18:45:36 | Finished running 28 view models in 11.53s.
2018-02-06 18:45:36,566: Connection 'master' was left open.
2018-02-06 18:45:36,566: 
2018-02-06 18:45:36,567: Completed with 1 errors:
2018-02-06 18:45:36,567: 
2018-02-06 18:45:36,567: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-06 18:45:36,567:   Unrecognized name: url_trimmed at [2:1]
2018-02-06 18:45:36,568:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-06 18:45:36,568: 
Done. PASS=24 ERROR=1 SKIP=3 TOTAL=28
2018-02-06 18:45:36,568: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052b2320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10527c828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10527c6d8>]}
2018-02-06 18:45:36,884: Flushing usage events
2018-02-06 18:46:33,018: Tracking: tracking
2018-02-06 18:46:33,021: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046d3908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046d39b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046d38d0>]}
2018-02-06 18:46:33,818: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 18:46:33,839: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 18:46:33,849: Parsing core.sql
2018-02-06 18:46:33,873: Parsing adapters/bigquery.sql
2018-02-06 18:46:33,885: Parsing adapters/common.sql
2018-02-06 18:46:33,902: Parsing adapters/postgres.sql
2018-02-06 18:46:33,908: Parsing adapters/redshift.sql
2018-02-06 18:46:33,929: Parsing etc/get_custom_schema.sql
2018-02-06 18:46:33,941: Parsing materializations/archive.sql
2018-02-06 18:46:33,978: Parsing materializations/bigquery.sql
2018-02-06 18:46:33,997: Parsing materializations/helpers.sql
2018-02-06 18:46:34,020: Parsing materializations/incremental.sql
2018-02-06 18:46:34,049: Parsing materializations/table.sql
2018-02-06 18:46:34,073: Parsing materializations/view.sql
2018-02-06 18:46:34,096: Parsing materializations/wrapper.sql
2018-02-06 18:46:34,104: Parsing schema_tests/accepted_values.sql
2018-02-06 18:46:34,112: Parsing schema_tests/not_null.sql
2018-02-06 18:46:34,120: Parsing schema_tests/relationships.sql
2018-02-06 18:46:34,127: Parsing schema_tests/unique.sql
2018-02-06 18:46:34,177: Parsing model.seo_audit.accounts_proc
2018-02-06 18:46:34,181: Parsing model.seo_audit.all_dates
2018-02-06 18:46:34,182: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 18:46:34,184: Acquiring new bigquery connection "master".
2018-02-06 18:46:34,185: Opening a new connection (0 currently allocated)
2018-02-06 18:46:34,188: Parsing model.seo_audit.agg_all
2018-02-06 18:46:34,191: Parsing model.seo_audit.agg_indicative
2018-02-06 18:46:34,193: Parsing model.seo_audit.agg_stats
2018-02-06 18:46:34,198: Parsing model.seo_audit.agg_stats_client
2018-02-06 18:46:34,201: Parsing model.seo_audit.deepcrawl_class
2018-02-06 18:46:34,203: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 18:46:34,205: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 18:46:34,207: Parsing model.seo_audit.ga_proc
2018-02-06 18:46:34,210: Parsing model.seo_audit.ga_stats
2018-02-06 18:46:34,211: Parsing model.seo_audit.majestic_domain_history
2018-02-06 18:46:34,213: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 18:46:34,215: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 18:46:34,217: Parsing model.seo_audit.moz_proc
2018-02-06 18:46:34,220: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 18:46:34,222: Parsing model.seo_audit.search_console_history
2018-02-06 18:46:34,224: Parsing model.seo_audit.search_console_proc
2018-02-06 18:46:34,227: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 18:46:34,229: Parsing model.seo_audit.search_console_stats_url
2018-02-06 18:46:34,230: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 18:46:34,233: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 18:46:34,236: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 18:46:34,239: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 18:46:34,241: Parsing model.seo_audit.semrush_url_history
2018-02-06 18:46:34,243: Parsing model.seo_audit.semrush_url_stats
2018-02-06 18:46:34,245: Parsing model.seo_audit.sitemap_proc
2018-02-06 18:46:34,255: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 18:46:34,261: 
2018-02-06 18:46:35,026: 18:46:35 | Concurrency: 4 threads (target='dev')
2018-02-06 18:46:35,027: 18:46:35 | 
2018-02-06 18:46:35,198: 18:46:35 | 1 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 18:46:35,199: 18:46:35 | 2 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 18:46:35,199: Compiling model.seo_audit.accounts_proc
2018-02-06 18:46:35,199: 18:46:35 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 18:46:35,199: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 18:46:35,204: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 18:46:35,204: Compiling model.seo_audit.all_dates
2018-02-06 18:46:35,208: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 18:46:35,212: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 18:46:35,215: Acquiring new bigquery connection "accounts_proc".
2018-02-06 18:46:35,216: Opening a new connection (1 currently allocated)
2018-02-06 18:46:35,217: Acquiring new bigquery connection "all_dates".
2018-02-06 18:46:35,218: Opening a new connection (2 currently allocated)
2018-02-06 18:46:35,219: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 18:46:35,275: Opening a new connection (3 currently allocated)
2018-02-06 18:46:35,782: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 18:46:35,811: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 18:46:35,857: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 18:46:36,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047dec50>]}
2018-02-06 18:46:36,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104835080>]}
2018-02-06 18:46:36,042: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048352b0>]}
2018-02-06 18:46:36,348: 18:46:36 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.83s]
2018-02-06 18:46:36,578: 18:46:36 | 1 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.84s]
2018-02-06 18:46:36,910: 18:46:36 | 2 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.84s]
2018-02-06 18:46:36,910: 18:46:36 | 4 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 18:46:36,911: Compiling model.seo_audit.ga_proc
2018-02-06 18:46:36,910: 18:46:36 | 5 of 28 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-06 18:46:36,917: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 18:46:36,910: 18:46:36 | 6 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 18:46:36,917: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 18:46:36,911: 18:46:36 | 7 of 28 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-06 18:46:36,917: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 18:46:36,923: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 18:46:36,924: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 18:46:36,929: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 18:46:36,931: Acquiring new bigquery connection "ga_proc".
2018-02-06 18:46:36,939: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 18:46:36,940: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 18:46:36,941: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 18:46:36,941: Re-using an available connection from the pool.
2018-02-06 18:46:36,944: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 18:46:36,944: Re-using an available connection from the pool.
2018-02-06 18:46:36,945: Re-using an available connection from the pool.
2018-02-06 18:46:36,953: Opening a new connection (4 currently allocated)
2018-02-06 18:46:37,227: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:46:37,236: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 18:46:37,323: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 18:46:37,519: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104835748>]}
2018-02-06 18:46:37,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104835198>]}
2018-02-06 18:46:37,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890fd0>]}
2018-02-06 18:46:37,654: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:46:37,731: 18:46:37 | 5 of 28 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.60s]
2018-02-06 18:46:37,733: 18:46:37 | 8 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 18:46:37,736: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 18:46:37,747: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 18:46:37,748: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 18:46:37,748: Re-using an available connection from the pool.
2018-02-06 18:46:37,943: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 18:46:37,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890cc0>]}
2018-02-06 18:46:38,004: 18:46:38 | 4 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.62s]
2018-02-06 18:46:38,005: 18:46:38 | 9 of 28 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-06 18:46:38,006: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 18:46:38,017: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 18:46:38,019: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 18:46:38,020: Re-using an available connection from the pool.
2018-02-06 18:46:38,120: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 18:46:38,225: 18:46:38 | 6 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.72s]
2018-02-06 18:46:38,226: 18:46:38 | 10 of 28 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-06 18:46:38,226: Compiling model.seo_audit.moz_proc
2018-02-06 18:46:38,235: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 18:46:38,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048c0ef0>]}
2018-02-06 18:46:38,238: Acquiring new bigquery connection "moz_proc".
2018-02-06 18:46:38,238: Re-using an available connection from the pool.
2018-02-06 18:46:38,440: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 18:46:38,450: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890be0>]}
2018-02-06 18:46:38,455: 18:46:38 | 7 of 28 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 1.05s]
2018-02-06 18:46:38,456: 18:46:38 | 11 of 28 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-06 18:46:38,456: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 18:46:38,464: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 18:46:38,469: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 18:46:38,469: Re-using an available connection from the pool.
2018-02-06 18:46:38,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890fd0>]}
2018-02-06 18:46:38,730: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 18:46:38,753: 18:46:38 | 8 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.50s]
2018-02-06 18:46:38,754: 18:46:38 | 12 of 28 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-06 18:46:38,754: Compiling model.seo_audit.sitemap_proc
2018-02-06 18:46:38,765: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 18:46:38,768: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 18:46:38,770: Re-using an available connection from the pool.
2018-02-06 18:46:38,992: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 18:46:39,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048dd4e0>]}
2018-02-06 18:46:39,065: 18:46:39 | 9 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.44s]
2018-02-06 18:46:39,067: 18:46:39 | 13 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 18:46:39,067: Compiling model.seo_audit.search_console_proc
2018-02-06 18:46:39,078: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 18:46:39,082: Acquiring new bigquery connection "search_console_proc".
2018-02-06 18:46:39,082: Re-using an available connection from the pool.
2018-02-06 18:46:39,290: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 18:46:39,307: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104831978>]}
2018-02-06 18:46:39,349: 18:46:39 | 10 of 28 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.49s]
2018-02-06 18:46:39,566: 18:46:39 | 11 of 28 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.60s]
2018-02-06 18:46:39,574: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890be0>]}
2018-02-06 18:46:39,809: 18:46:39 | 12 of 28 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.55s]
2018-02-06 18:46:40,097: 18:46:40 | 13 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.51s]
2018-02-06 18:46:40,098: 18:46:40 | 14 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 18:46:40,099: Compiling model.seo_audit.majestic_domain_history
2018-02-06 18:46:40,106: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 18:46:40,098: 18:46:40 | 15 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 18:46:40,106: Compiling model.seo_audit.semrush_url_history
2018-02-06 18:46:40,111: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 18:46:40,098: 18:46:40 | 16 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 18:46:40,112: Compiling model.seo_audit.ga_stats
2018-02-06 18:46:40,117: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 18:46:40,098: 18:46:40 | 17 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 18:46:40,118: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 18:46:40,123: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 18:46:40,127: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 18:46:40,129: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 18:46:40,129: Re-using an available connection from the pool.
2018-02-06 18:46:40,130: Acquiring new bigquery connection "ga_stats".
2018-02-06 18:46:40,131: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 18:46:40,133: Re-using an available connection from the pool.
2018-02-06 18:46:40,135: Re-using an available connection from the pool.
2018-02-06 18:46:40,141: Re-using an available connection from the pool.
2018-02-06 18:46:40,355: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 18:46:40,362: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 18:46:40,381: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 18:46:40,419: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 18:46:40,668: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890cc0>]}
2018-02-06 18:46:40,687: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048c0400>]}
2018-02-06 18:46:40,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890828>]}
2018-02-06 18:46:40,726: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a2f28>]}
2018-02-06 18:46:40,966: 18:46:40 | 14 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-06 18:46:40,968: 18:46:40 | 18 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 18:46:40,970: Compiling model.seo_audit.search_console_history
2018-02-06 18:46:40,982: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 18:46:40,983: Acquiring new bigquery connection "search_console_history".
2018-02-06 18:46:40,984: Re-using an available connection from the pool.
2018-02-06 18:46:41,190: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 18:46:41,279: 18:46:41 | 17 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.57s]
2018-02-06 18:46:41,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048abba8>]}
2018-02-06 18:46:41,582: 18:46:41 | 15 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.59s]
2018-02-06 18:46:41,894: 18:46:41 | 16 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.61s]
2018-02-06 18:46:42,114: 18:46:42 | 18 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.57s]
2018-02-06 18:46:42,115: 18:46:42 | 19 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 18:46:42,115: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 18:46:42,115: 18:46:42 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 18:46:42,123: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 18:46:42,115: 18:46:42 | 21 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 18:46:42,123: Compiling model.seo_audit.search_console_stats_url
2018-02-06 18:46:42,124: Compiling model.seo_audit.deepcrawl_class
2018-02-06 18:46:42,129: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 18:46:42,136: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 18:46:42,137: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 18:46:42,138: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 18:46:42,139: Re-using an available connection from the pool.
2018-02-06 18:46:42,140: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 18:46:42,140: Re-using an available connection from the pool.
2018-02-06 18:46:42,145: Re-using an available connection from the pool.
2018-02-06 18:46:42,345: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_article) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 18:46:42,361: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 18:46:42,367: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 18:46:42,707: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10481dbe0>]}
2018-02-06 18:46:42,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a2f28>]}
2018-02-06 18:46:42,781: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104890be0>]}
2018-02-06 18:46:42,954: 18:46:42 | 21 of 28 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.58s]
2018-02-06 18:46:43,322: 18:46:43 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-06 18:46:43,584: 18:46:43 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.67s]
2018-02-06 18:46:43,585: 18:46:43 | 22 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 18:46:43,585: 18:46:43 | 23 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 18:46:43,585: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 18:46:43,585: 18:46:43 | 24 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 18:46:43,586: Compiling model.seo_audit.semrush_url_stats
2018-02-06 18:46:43,591: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 18:46:43,591: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 18:46:43,596: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 18:46:43,602: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 18:46:43,603: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 18:46:43,603: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 18:46:43,604: Re-using an available connection from the pool.
2018-02-06 18:46:43,604: Re-using an available connection from the pool.
2018-02-06 18:46:43,605: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 18:46:43,605: Re-using an available connection from the pool.
2018-02-06 18:46:43,814: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 18:46:43,818: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:46:43,832: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 18:46:44,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104897630>]}
2018-02-06 18:46:44,202: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047d8ac8>]}
2018-02-06 18:46:44,228: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10481d710>]}
2018-02-06 18:46:44,407: 18:46:44 | 23 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.61s]
2018-02-06 18:46:44,651: 18:46:44 | 22 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.62s]
2018-02-06 18:46:44,897: 18:46:44 | 24 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.64s]
2018-02-06 18:46:44,898: 18:46:44 | 25 of 28 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-06 18:46:44,899: Compiling model.seo_audit.agg_indicative
2018-02-06 18:46:44,908: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 18:46:44,909: Acquiring new bigquery connection "agg_indicative".
2018-02-06 18:46:44,909: Re-using an available connection from the pool.
2018-02-06 18:46:45,118: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-06 18:46:45,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a2f28>]}
2018-02-06 18:46:45,967: 18:46:45 | 25 of 28 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.74s]
2018-02-06 18:46:45,968: 18:46:45 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 18:46:45,968: Compiling model.seo_audit.agg_stats
2018-02-06 18:46:45,981: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 18:46:45,982: Acquiring new bigquery connection "agg_stats".
2018-02-06 18:46:45,982: Re-using an available connection from the pool.
2018-02-06 18:46:46,182: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 18:46:46,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047d8ac8>]}
2018-02-06 18:46:46,964: 18:46:46 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.77s]
2018-02-06 18:46:46,964: 18:46:46 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 18:46:46,965: Compiling model.seo_audit.agg_stats_client
2018-02-06 18:46:46,972: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 18:46:46,973: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 18:46:46,973: Re-using an available connection from the pool.
2018-02-06 18:46:47,160: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 18:46:47,771: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a2f28>]}
2018-02-06 18:46:47,989: 18:46:47 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.81s]
2018-02-06 18:46:47,990: 18:46:47 | 28 of 28 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-06 18:46:47,991: Compiling model.seo_audit.agg_all
2018-02-06 18:46:47,999: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 18:46:48,000: Acquiring new bigquery connection "agg_all".
2018-02-06 18:46:48,000: Re-using an available connection from the pool.
2018-02-06 18:46:48,178: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 18:46:49,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fd318a1-67b0-464b-91b8-438dbe5ba389', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047d8ac8>]}
2018-02-06 18:46:49,311: 18:46:49 | 28 of 28 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.10s]
2018-02-06 18:46:49,336: 18:46:49 | 
2018-02-06 18:46:49,336: 18:46:49 | Finished running 28 view models in 14.31s.
2018-02-06 18:46:49,336: Connection 'master' was left open.
2018-02-06 18:46:49,337: 
2018-02-06 18:46:49,337: Completed successfully
2018-02-06 18:46:49,337: 
Done. PASS=28 ERROR=0 SKIP=0 TOTAL=28
2018-02-06 18:46:49,338: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047887b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104788518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047885f8>]}
2018-02-06 18:46:49,641: Flushing usage events
2018-02-06 20:30:33,934: Tracking: tracking
2018-02-06 20:30:33,936: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132e9da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132e9908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132e9f60>]}
2018-02-06 20:30:33,956: ctrl-c
2018-02-06 20:37:37,167: Tracking: tracking
2018-02-06 20:37:37,172: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057df358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057df5c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10714dfd0>]}
2018-02-06 20:37:37,972: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 20:37:37,989: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 20:37:37,996: Parsing core.sql
2018-02-06 20:37:38,015: Parsing adapters/bigquery.sql
2018-02-06 20:37:38,026: Parsing adapters/common.sql
2018-02-06 20:37:38,049: Parsing adapters/postgres.sql
2018-02-06 20:37:38,057: Parsing adapters/redshift.sql
2018-02-06 20:37:38,082: Parsing etc/get_custom_schema.sql
2018-02-06 20:37:38,090: Parsing materializations/archive.sql
2018-02-06 20:37:38,129: Parsing materializations/bigquery.sql
2018-02-06 20:37:38,145: Parsing materializations/helpers.sql
2018-02-06 20:37:38,163: Parsing materializations/incremental.sql
2018-02-06 20:37:38,197: Parsing materializations/table.sql
2018-02-06 20:37:38,221: Parsing materializations/view.sql
2018-02-06 20:37:38,238: Parsing materializations/wrapper.sql
2018-02-06 20:37:38,247: Parsing schema_tests/accepted_values.sql
2018-02-06 20:37:38,258: Parsing schema_tests/not_null.sql
2018-02-06 20:37:38,264: Parsing schema_tests/relationships.sql
2018-02-06 20:37:38,271: Parsing schema_tests/unique.sql
2018-02-06 20:37:38,315: Parsing model.seo_audit.accounts_proc
2018-02-06 20:37:38,319: Parsing model.seo_audit.all_dates
2018-02-06 20:37:38,321: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 20:37:38,323: Acquiring new bigquery connection "master".
2018-02-06 20:37:38,323: Opening a new connection (0 currently allocated)
2018-02-06 20:37:38,328: Parsing model.seo_audit.agg_all
2018-02-06 20:37:38,331: Parsing model.seo_audit.agg_indicative
2018-02-06 20:37:38,333: Parsing model.seo_audit.agg_stats
2018-02-06 20:37:38,338: Parsing model.seo_audit.agg_stats_client
2018-02-06 20:37:38,341: Parsing model.seo_audit.deepcrawl_class
2018-02-06 20:37:38,344: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 20:37:38,346: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 20:37:38,348: Parsing model.seo_audit.ga_proc
2018-02-06 20:37:38,350: Parsing model.seo_audit.ga_stats
2018-02-06 20:37:38,352: Parsing model.seo_audit.majestic_domain_history
2018-02-06 20:37:38,354: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 20:37:38,356: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 20:37:38,358: Parsing model.seo_audit.moz_proc
2018-02-06 20:37:38,361: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 20:37:38,364: Parsing model.seo_audit.search_console_history
2018-02-06 20:37:38,365: Parsing model.seo_audit.search_console_proc
2018-02-06 20:37:38,368: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 20:37:38,371: Parsing model.seo_audit.search_console_stats_url
2018-02-06 20:37:38,372: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 20:37:38,375: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 20:37:38,377: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 20:37:38,380: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 20:37:38,382: Parsing model.seo_audit.semrush_url_history
2018-02-06 20:37:38,385: Parsing model.seo_audit.semrush_url_stats
2018-02-06 20:37:38,388: Parsing model.seo_audit.sitemap_proc
2018-02-06 20:37:38,401: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 20:37:38,408: 
2018-02-06 20:37:39,834: 20:37:39 | Concurrency: 4 threads (target='dev')
2018-02-06 20:37:39,835: 20:37:39 | 
2018-02-06 20:37:40,034: 20:37:40 | 1 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 20:37:40,035: 20:37:40 | 2 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 20:37:40,035: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 20:37:40,035: 20:37:40 | 3 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 20:37:40,035: Compiling model.seo_audit.all_dates
2018-02-06 20:37:40,040: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 20:37:40,040: Compiling model.seo_audit.accounts_proc
2018-02-06 20:37:40,044: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 20:37:40,048: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 20:37:40,051: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 20:37:40,052: Opening a new connection (1 currently allocated)
2018-02-06 20:37:40,053: Acquiring new bigquery connection "all_dates".
2018-02-06 20:37:40,055: Acquiring new bigquery connection "accounts_proc".
2018-02-06 20:37:40,055: Opening a new connection (2 currently allocated)
2018-02-06 20:37:40,110: Opening a new connection (3 currently allocated)
2018-02-06 20:37:40,619: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 20:37:40,625: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 20:37:40,628: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 20:37:40,825: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072829e8>]}
2018-02-06 20:37:40,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107282d30>]}
2018-02-06 20:37:40,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292080>]}
2018-02-06 20:37:41,133: 20:37:41 | 2 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.79s]
2018-02-06 20:37:41,406: 20:37:41 | 3 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.79s]
2018-02-06 20:37:41,653: 20:37:41 | 1 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.88s]
2018-02-06 20:37:41,654: 20:37:41 | 4 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 20:37:41,654: Compiling model.seo_audit.sitemap_proc
2018-02-06 20:37:41,654: 20:37:41 | 5 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 20:37:41,661: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 20:37:41,661: Compiling model.seo_audit.moz_proc
2018-02-06 20:37:41,654: 20:37:41 | 6 of 28 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-06 20:37:41,654: 20:37:41 | 7 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 20:37:41,671: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 20:37:41,672: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 20:37:41,673: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 20:37:41,673: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 20:37:41,684: Re-using an available connection from the pool.
2018-02-06 20:37:41,686: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 20:37:41,700: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 20:37:41,703: Acquiring new bigquery connection "moz_proc".
2018-02-06 20:37:41,705: Re-using an available connection from the pool.
2018-02-06 20:37:41,707: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 20:37:41,707: Re-using an available connection from the pool.
2018-02-06 20:37:41,709: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 20:37:41,710: Opening a new connection (4 currently allocated)
2018-02-06 20:37:41,920: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 20:37:42,023: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 20:37:42,025: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:37:42,267: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277a58>]}
2018-02-06 20:37:42,279: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 20:37:42,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277d30>]}
2018-02-06 20:37:42,498: 20:37:42 | 4 of 28 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.61s]
2018-02-06 20:37:42,499: 20:37:42 | 8 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 20:37:42,499: Compiling model.seo_audit.ga_proc
2018-02-06 20:37:42,507: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 20:37:42,510: Acquiring new bigquery connection "ga_proc".
2018-02-06 20:37:42,510: Re-using an available connection from the pool.
2018-02-06 20:37:42,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072829e8>]}
2018-02-06 20:37:42,711: 20:37:42 | 6 of 28 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.68s]
2018-02-06 20:37:42,712: 20:37:42 | 9 of 28 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-06 20:37:42,713: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 20:37:42,722: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 20:37:42,725: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 20:37:42,725: Re-using an available connection from the pool.
2018-02-06 20:37:42,755: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 20:37:42,927: 20:37:42 | 7 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.92s]
2018-02-06 20:37:42,928: 20:37:42 | 10 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 20:37:42,928: Compiling model.seo_audit.search_console_proc
2018-02-06 20:37:42,937: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 20:37:42,941: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 20:37:42,946: Acquiring new bigquery connection "search_console_proc".
2018-02-06 20:37:42,946: Re-using an available connection from the pool.
2018-02-06 20:37:43,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277a58>]}
2018-02-06 20:37:43,149: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:37:43,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277d30>]}
2018-02-06 20:37:43,379: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107231f98>]}
2018-02-06 20:37:43,417: 20:37:43 | 8 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.53s]
2018-02-06 20:37:43,418: 20:37:43 | 11 of 28 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-06 20:37:43,418: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 20:37:43,428: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 20:37:43,432: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 20:37:43,434: Re-using an available connection from the pool.
2018-02-06 20:37:43,629: 20:37:43 | 9 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.52s]
2018-02-06 20:37:43,630: 20:37:43 | 12 of 28 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-06 20:37:43,631: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 20:37:43,633: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:37:43,644: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 20:37:43,648: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 20:37:43,648: Re-using an available connection from the pool.
2018-02-06 20:37:43,887: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 20:37:43,926: 20:37:43 | 10 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.45s]
2018-02-06 20:37:43,926: 20:37:43 | 13 of 28 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-06 20:37:43,927: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 20:37:43,938: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 20:37:43,939: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 20:37:43,939: Re-using an available connection from the pool.
2018-02-06 20:37:43,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277a58>]}
2018-02-06 20:37:44,146: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:37:44,195: 20:37:44 | 11 of 28 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.57s]
2018-02-06 20:37:44,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277d30>]}
2018-02-06 20:37:44,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107231f98>]}
2018-02-06 20:37:44,566: 20:37:44 | 12 of 28 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.64s]
2018-02-06 20:37:44,860: 20:37:44 | 13 of 28 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.47s]
2018-02-06 20:37:46,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10730c940>]}
2018-02-06 20:37:46,591: 20:37:46 | 5 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 4.63s]
2018-02-06 20:37:46,592: 20:37:46 | 14 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 20:37:46,593: Compiling model.seo_audit.majestic_domain_history
2018-02-06 20:37:46,592: 20:37:46 | 15 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 20:37:46,592: 20:37:46 | 16 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 20:37:46,599: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 20:37:46,592: 20:37:46 | 17 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 20:37:46,600: Compiling model.seo_audit.search_console_history
2018-02-06 20:37:46,600: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 20:37:46,600: Compiling model.seo_audit.ga_stats
2018-02-06 20:37:46,605: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 20:37:46,610: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 20:37:46,618: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 20:37:46,619: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 20:37:46,620: Acquiring new bigquery connection "search_console_history".
2018-02-06 20:37:46,621: Re-using an available connection from the pool.
2018-02-06 20:37:46,622: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 20:37:46,623: Re-using an available connection from the pool.
2018-02-06 20:37:46,627: Re-using an available connection from the pool.
2018-02-06 20:37:46,635: Acquiring new bigquery connection "ga_stats".
2018-02-06 20:37:46,639: Re-using an available connection from the pool.
2018-02-06 20:37:46,811: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 20:37:46,822: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 20:37:46,830: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 20:37:46,839: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 20:37:47,209: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292550>]}
2018-02-06 20:37:47,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292e10>]}
2018-02-06 20:37:47,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107367b00>]}
2018-02-06 20:37:47,520: 20:37:47 | 16 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.61s]
2018-02-06 20:37:47,521: 20:37:47 | 18 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 20:37:47,523: Compiling model.seo_audit.semrush_url_history
2018-02-06 20:37:47,534: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 20:37:47,537: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 20:37:47,538: Re-using an available connection from the pool.
2018-02-06 20:37:47,739: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 20:37:47,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277278>]}
2018-02-06 20:37:47,773: 20:37:47 | 15 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.62s]
2018-02-06 20:37:48,072: 20:37:48 | 17 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.62s]
2018-02-06 20:37:48,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292550>]}
2018-02-06 20:37:48,304: 20:37:48 | 14 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 1.17s]
2018-02-06 20:37:48,514: 20:37:48 | 18 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.59s]
2018-02-06 20:37:48,515: 20:37:48 | 19 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 20:37:48,516: 20:37:48 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 20:37:48,516: Compiling model.seo_audit.deepcrawl_class
2018-02-06 20:37:48,516: 20:37:48 | 21 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 20:37:48,516: Compiling model.seo_audit.search_console_stats_url
2018-02-06 20:37:48,526: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 20:37:48,526: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 20:37:48,531: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 20:37:48,536: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 20:37:48,538: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 20:37:48,538: Re-using an available connection from the pool.
2018-02-06 20:37:48,539: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 20:37:48,539: Re-using an available connection from the pool.
2018-02-06 20:37:48,541: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 20:37:48,541: Re-using an available connection from the pool.
2018-02-06 20:37:48,752: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 20:37:48,755: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 20:37:48,785: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 20:37:49,053: Bad request while running:
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 20:37:49,054: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: med_word_count; Did you mean word_count? at [12:1]
2018-02-06 20:37:49,055: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292e10>]}
2018-02-06 20:37:49,056: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10730c908>]}
2018-02-06 20:37:49,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107231f98>]}
2018-02-06 20:37:49,500: 20:37:49 | 19 of 28 ERROR creating view model seo_audit_dev.deepcrawl_class..... [ERROR in 0.54s]
2018-02-06 20:37:49,803: 20:37:49 | 21 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.53s]
2018-02-06 20:37:50,097: 20:37:50 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.60s]
2018-02-06 20:37:50,098: 20:37:50 | 22 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 20:37:50,098: 20:37:50 | 23 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 20:37:50,098: Compiling model.seo_audit.semrush_url_stats
2018-02-06 20:37:50,099: 20:37:50 | 24 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 20:37:50,099: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 20:37:50,109: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 20:37:50,109: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 20:37:50,118: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 20:37:50,124: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 20:37:50,125: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 20:37:50,125: Re-using an available connection from the pool.
2018-02-06 20:37:50,126: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 20:37:50,126: Re-using an available connection from the pool.
2018-02-06 20:37:50,129: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 20:37:50,131: Re-using an available connection from the pool.
2018-02-06 20:37:50,321: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:37:50,322: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 20:37:50,346: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:37:50,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10730c0f0>]}
2018-02-06 20:37:50,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107283908>]}
2018-02-06 20:37:50,715: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277a58>]}
2018-02-06 20:37:50,972: 20:37:50 | 24 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.55s]
2018-02-06 20:37:51,274: 20:37:51 | 23 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.60s]
2018-02-06 20:37:51,562: 20:37:51 | 22 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.62s]
2018-02-06 20:37:51,562: 20:37:51 | 25 of 28 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-06 20:37:51,563: 20:37:51 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 20:37:51,564: Compiling model.seo_audit.agg_stats
2018-02-06 20:37:51,576: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 20:37:51,577: Acquiring new bigquery connection "agg_stats".
2018-02-06 20:37:51,577: Re-using an available connection from the pool.
2018-02-06 20:37:51,785: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 20:37:52,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107277a58>]}
2018-02-06 20:37:52,628: 20:37:52 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.77s]
2018-02-06 20:37:52,629: 20:37:52 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 20:37:52,629: Compiling model.seo_audit.agg_stats_client
2018-02-06 20:37:52,638: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 20:37:52,640: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 20:37:52,640: Re-using an available connection from the pool.
2018-02-06 20:37:52,847: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 20:37:57,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41af6e75-fe04-451a-9d98-83f306705cea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072771d0>]}
2018-02-06 20:37:57,563: 20:37:57 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 4.72s]
2018-02-06 20:37:57,564: 20:37:57 | 28 of 28 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-06 20:37:57,669: 20:37:57 | 
2018-02-06 20:37:57,669: 20:37:57 | Finished running 28 view models in 17.84s.
2018-02-06 20:37:57,670: Connection 'master' was left open.
2018-02-06 20:37:57,670: 
2018-02-06 20:37:57,670: Completed with 1 errors:
2018-02-06 20:37:57,671: 
2018-02-06 20:37:57,671: Database Error in model deepcrawl_class (models/base-adp/deepcrawl/deepcrawl_class.sql)
2018-02-06 20:37:57,671:   Unrecognized name: med_word_count; Did you mean word_count? at [12:1]
2018-02-06 20:37:57,672:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class.sql
2018-02-06 20:37:57,672: 
Done. PASS=25 ERROR=1 SKIP=2 TOTAL=28
2018-02-06 20:37:57,672: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107251320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721b7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721b6a0>]}
2018-02-06 20:37:57,877: Flushing usage events
2018-02-06 20:38:28,997: Tracking: tracking
2018-02-06 20:38:29,002: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110535da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110535908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110535f60>]}
2018-02-06 20:38:29,384: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 20:38:29,405: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 20:38:29,411: Parsing core.sql
2018-02-06 20:38:29,431: Parsing adapters/bigquery.sql
2018-02-06 20:38:29,440: Parsing adapters/common.sql
2018-02-06 20:38:29,457: Parsing adapters/postgres.sql
2018-02-06 20:38:29,461: Parsing adapters/redshift.sql
2018-02-06 20:38:29,492: Parsing etc/get_custom_schema.sql
2018-02-06 20:38:29,503: Parsing materializations/archive.sql
2018-02-06 20:38:29,545: Parsing materializations/bigquery.sql
2018-02-06 20:38:29,562: Parsing materializations/helpers.sql
2018-02-06 20:38:29,582: Parsing materializations/incremental.sql
2018-02-06 20:38:29,615: Parsing materializations/table.sql
2018-02-06 20:38:29,636: Parsing materializations/view.sql
2018-02-06 20:38:29,654: Parsing materializations/wrapper.sql
2018-02-06 20:38:29,661: Parsing schema_tests/accepted_values.sql
2018-02-06 20:38:29,667: Parsing schema_tests/not_null.sql
2018-02-06 20:38:29,671: Parsing schema_tests/relationships.sql
2018-02-06 20:38:29,678: Parsing schema_tests/unique.sql
2018-02-06 20:38:29,737: Parsing model.seo_audit.accounts_proc
2018-02-06 20:38:29,741: Parsing model.seo_audit.all_dates
2018-02-06 20:38:29,743: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 20:38:29,749: Acquiring new bigquery connection "master".
2018-02-06 20:38:29,749: Opening a new connection (0 currently allocated)
2018-02-06 20:38:29,753: Parsing model.seo_audit.agg_all
2018-02-06 20:38:29,756: Parsing model.seo_audit.agg_indicative
2018-02-06 20:38:29,758: Parsing model.seo_audit.agg_stats
2018-02-06 20:38:29,763: Parsing model.seo_audit.agg_stats_client
2018-02-06 20:38:29,767: Parsing model.seo_audit.deepcrawl_class
2018-02-06 20:38:29,771: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 20:38:29,774: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 20:38:29,776: Parsing model.seo_audit.ga_proc
2018-02-06 20:38:29,779: Parsing model.seo_audit.ga_stats
2018-02-06 20:38:29,780: Parsing model.seo_audit.majestic_domain_history
2018-02-06 20:38:29,782: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 20:38:29,787: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 20:38:29,792: Parsing model.seo_audit.moz_proc
2018-02-06 20:38:29,794: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 20:38:29,798: Parsing model.seo_audit.search_console_history
2018-02-06 20:38:29,800: Parsing model.seo_audit.search_console_proc
2018-02-06 20:38:29,803: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 20:38:29,806: Parsing model.seo_audit.search_console_stats_url
2018-02-06 20:38:29,808: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 20:38:29,815: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 20:38:29,821: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 20:38:29,825: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 20:38:29,827: Parsing model.seo_audit.semrush_url_history
2018-02-06 20:38:29,830: Parsing model.seo_audit.semrush_url_stats
2018-02-06 20:38:29,832: Parsing model.seo_audit.sitemap_proc
2018-02-06 20:38:29,843: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 20:38:29,850: 
2018-02-06 20:38:30,546: 20:38:30 | Concurrency: 4 threads (target='dev')
2018-02-06 20:38:30,546: 20:38:30 | 
2018-02-06 20:38:30,758: 20:38:30 | 1 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 20:38:30,758: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 20:38:30,764: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 20:38:30,758: 20:38:30 | 2 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 20:38:30,758: 20:38:30 | 3 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 20:38:30,764: Compiling model.seo_audit.accounts_proc
2018-02-06 20:38:30,765: Compiling model.seo_audit.all_dates
2018-02-06 20:38:30,765: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 20:38:30,771: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 20:38:30,775: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 20:38:30,775: Opening a new connection (1 currently allocated)
2018-02-06 20:38:30,836: Acquiring new bigquery connection "accounts_proc".
2018-02-06 20:38:30,836: Opening a new connection (2 currently allocated)
2018-02-06 20:38:30,841: Acquiring new bigquery connection "all_dates".
2018-02-06 20:38:30,841: Opening a new connection (3 currently allocated)
2018-02-06 20:38:31,364: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 20:38:31,365: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 20:38:31,372: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 20:38:31,557: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4518>]}
2018-02-06 20:38:31,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110677cc0>]}
2018-02-06 20:38:31,592: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110608198>]}
2018-02-06 20:38:31,870: 20:38:31 | 2 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.79s]
2018-02-06 20:38:32,158: 20:38:32 | 3 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.79s]
2018-02-06 20:38:32,473: 20:38:32 | 1 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.83s]
2018-02-06 20:38:32,474: 20:38:32 | 4 of 28 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-06 20:38:32,475: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 20:38:32,475: 20:38:32 | 5 of 28 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-06 20:38:32,482: Compiling model.seo_audit.sitemap_proc
2018-02-06 20:38:32,475: 20:38:32 | 6 of 28 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-06 20:38:32,493: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 20:38:32,496: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 20:38:32,475: 20:38:32 | 7 of 28 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-06 20:38:32,496: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 20:38:32,496: Compiling model.seo_audit.ga_proc
2018-02-06 20:38:32,502: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 20:38:32,503: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 20:38:32,508: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 20:38:32,510: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 20:38:32,510: Re-using an available connection from the pool.
2018-02-06 20:38:32,511: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 20:38:32,513: Acquiring new bigquery connection "ga_proc".
2018-02-06 20:38:32,513: Re-using an available connection from the pool.
2018-02-06 20:38:32,515: Re-using an available connection from the pool.
2018-02-06 20:38:32,523: Opening a new connection (4 currently allocated)
2018-02-06 20:38:32,704: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 20:38:32,723: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:38:32,772: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:38:32,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a16d8>]}
2018-02-06 20:38:33,014: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 20:38:33,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110608198>]}
2018-02-06 20:38:33,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a1ac8>]}
2018-02-06 20:38:33,249: 20:38:33 | 5 of 28 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.48s]
2018-02-06 20:38:33,251: 20:38:33 | 8 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 20:38:33,254: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 20:38:33,263: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 20:38:33,265: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 20:38:33,265: Re-using an available connection from the pool.
2018-02-06 20:38:33,350: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4080>]}
2018-02-06 20:38:33,457: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 20:38:33,481: 20:38:33 | 6 of 28 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.54s]
2018-02-06 20:38:33,482: 20:38:33 | 9 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 20:38:33,482: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 20:38:33,495: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 20:38:33,497: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 20:38:33,497: Re-using an available connection from the pool.
2018-02-06 20:38:33,737: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 20:38:33,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a16d8>]}
2018-02-06 20:38:33,806: 20:38:33 | 4 of 28 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.57s]
2018-02-06 20:38:33,807: 20:38:33 | 10 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 20:38:33,807: Compiling model.seo_audit.search_console_proc
2018-02-06 20:38:33,818: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 20:38:33,822: Acquiring new bigquery connection "search_console_proc".
2018-02-06 20:38:33,822: Re-using an available connection from the pool.
2018-02-06 20:38:34,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11060bb70>]}
2018-02-06 20:38:34,037: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:38:34,045: 20:38:34 | 7 of 28 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.85s]
2018-02-06 20:38:34,046: 20:38:34 | 11 of 28 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-06 20:38:34,046: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 20:38:34,053: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 20:38:34,058: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 20:38:34,059: Re-using an available connection from the pool.
2018-02-06 20:38:34,267: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 20:38:34,287: 20:38:34 | 8 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.51s]
2018-02-06 20:38:34,288: 20:38:34 | 12 of 28 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-06 20:38:34,288: Compiling model.seo_audit.moz_proc
2018-02-06 20:38:34,294: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 20:38:34,296: Acquiring new bigquery connection "moz_proc".
2018-02-06 20:38:34,297: Re-using an available connection from the pool.
2018-02-06 20:38:34,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a1ac8>]}
2018-02-06 20:38:34,495: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:38:34,531: 20:38:34 | 9 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.53s]
2018-02-06 20:38:34,532: 20:38:34 | 13 of 28 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-06 20:38:34,532: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 20:38:34,537: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 20:38:34,540: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 20:38:34,540: Re-using an available connection from the pool.
2018-02-06 20:38:34,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0f2668>]}
2018-02-06 20:38:34,739: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 20:38:34,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a16d8>]}
2018-02-06 20:38:34,849: 20:38:34 | 10 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.54s]
2018-02-06 20:38:35,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da64f98>]}
2018-02-06 20:38:35,177: 20:38:35 | 11 of 28 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.58s]
2018-02-06 20:38:35,536: 20:38:35 | 12 of 28 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.51s]
2018-02-06 20:38:35,799: 20:38:35 | 13 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.54s]
2018-02-06 20:38:35,800: 20:38:35 | 14 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 20:38:35,801: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 20:38:35,801: 20:38:35 | 15 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 20:38:35,813: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 20:38:35,801: 20:38:35 | 16 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 20:38:35,813: Compiling model.seo_audit.majestic_domain_history
2018-02-06 20:38:35,801: 20:38:35 | 17 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 20:38:35,814: Compiling model.seo_audit.search_console_history
2018-02-06 20:38:35,821: Compiling model.seo_audit.ga_stats
2018-02-06 20:38:35,822: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 20:38:35,842: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 20:38:35,843: Re-using an available connection from the pool.
2018-02-06 20:38:35,823: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 20:38:35,849: Re-using an available connection from the pool.
2018-02-06 20:38:35,828: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 20:38:35,849: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 20:38:35,858: Acquiring new bigquery connection "search_console_history".
2018-02-06 20:38:35,858: Re-using an available connection from the pool.
2018-02-06 20:38:35,864: Acquiring new bigquery connection "ga_stats".
2018-02-06 20:38:35,864: Re-using an available connection from the pool.
2018-02-06 20:38:36,073: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 20:38:36,074: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 20:38:36,076: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 20:38:36,086: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 20:38:36,399: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4518>]}
2018-02-06 20:38:36,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11060bb00>]}
2018-02-06 20:38:36,431: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a1ac8>]}
2018-02-06 20:38:36,447: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105fb0b8>]}
2018-02-06 20:38:36,706: 20:38:36 | 14 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.60s]
2018-02-06 20:38:36,707: 20:38:36 | 18 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 20:38:36,708: Compiling model.seo_audit.semrush_url_history
2018-02-06 20:38:36,713: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 20:38:36,715: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 20:38:36,715: Re-using an available connection from the pool.
2018-02-06 20:38:36,883: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 20:38:36,982: 20:38:36 | 16 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.61s]
2018-02-06 20:38:37,230: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4518>]}
2018-02-06 20:38:37,303: 20:38:37 | 15 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.62s]
2018-02-06 20:38:38,116: 20:38:38 | 17 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.63s]
2018-02-06 20:38:38,439: 20:38:38 | 18 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.52s]
2018-02-06 20:38:38,440: 20:38:38 | 19 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 20:38:38,440: 20:38:38 | 20 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 20:38:38,441: Compiling model.seo_audit.search_console_stats_url
2018-02-06 20:38:38,441: 20:38:38 | 21 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 20:38:38,441: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 20:38:38,450: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 20:38:38,450: Compiling model.seo_audit.deepcrawl_class
2018-02-06 20:38:38,467: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 20:38:38,470: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 20:38:38,471: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 20:38:38,472: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 20:38:38,472: Re-using an available connection from the pool.
2018-02-06 20:38:38,473: Re-using an available connection from the pool.
2018-02-06 20:38:38,474: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 20:38:38,488: Re-using an available connection from the pool.
2018-02-06 20:38:38,581: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 20:38:38,660: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 20:38:38,720: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 20:38:38,923: Bad request while running:
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 20:38:38,923: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: flag_blog_h1; Did you mean flag_blog_path? at [33:62]
2018-02-06 20:38:38,923: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106b5f60>]}
2018-02-06 20:38:38,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da64f98>]}
2018-02-06 20:38:39,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105fb0b8>]}
2018-02-06 20:38:39,164: 20:38:39 | 21 of 28 ERROR creating view model seo_audit_dev.deepcrawl_class..... [ERROR in 0.47s]
2018-02-06 20:38:39,510: 20:38:39 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.53s]
2018-02-06 20:38:39,718: 20:38:39 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.59s]
2018-02-06 20:38:39,719: 20:38:39 | 22 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 20:38:39,719: 20:38:39 | 23 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 20:38:39,719: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 20:38:39,720: 20:38:39 | 24 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 20:38:39,720: Compiling model.seo_audit.semrush_url_stats
2018-02-06 20:38:39,727: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 20:38:39,729: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 20:38:39,735: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 20:38:39,739: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 20:38:39,741: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 20:38:39,742: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 20:38:39,742: Re-using an available connection from the pool.
2018-02-06 20:38:39,742: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 20:38:39,743: Re-using an available connection from the pool.
2018-02-06 20:38:39,744: Re-using an available connection from the pool.
2018-02-06 20:38:39,957: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:38:40,016: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:38:40,055: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 20:38:40,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106a1ac8>]}
2018-02-06 20:38:40,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110693898>]}
2018-02-06 20:38:40,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4518>]}
2018-02-06 20:38:40,584: 20:38:40 | 23 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.63s]
2018-02-06 20:38:40,875: 20:38:40 | 24 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.67s]
2018-02-06 20:38:41,082: 20:38:41 | 22 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.72s]
2018-02-06 20:38:41,083: 20:38:41 | 25 of 28 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-06 20:38:41,084: 20:38:41 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 20:38:41,084: Compiling model.seo_audit.agg_stats
2018-02-06 20:38:41,097: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 20:38:41,098: Acquiring new bigquery connection "agg_stats".
2018-02-06 20:38:41,098: Re-using an available connection from the pool.
2018-02-06 20:38:41,283: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 20:38:43,430: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105c4518>]}
2018-02-06 20:38:43,657: 20:38:43 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 2.35s]
2018-02-06 20:38:43,658: 20:38:43 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 20:38:43,658: Compiling model.seo_audit.agg_stats_client
2018-02-06 20:38:43,666: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 20:38:43,667: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 20:38:43,668: Re-using an available connection from the pool.
2018-02-06 20:38:43,862: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 20:38:44,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8861a3ad-d430-4858-ac25-7408864dd06b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105fb0b8>]}
2018-02-06 20:38:45,047: 20:38:45 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.80s]
2018-02-06 20:38:45,048: 20:38:45 | 28 of 28 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-06 20:38:45,114: 20:38:45 | 
2018-02-06 20:38:45,114: 20:38:45 | Finished running 28 view models in 14.57s.
2018-02-06 20:38:45,114: Connection 'master' was left open.
2018-02-06 20:38:45,115: 
2018-02-06 20:38:45,115: Completed with 1 errors:
2018-02-06 20:38:45,115: 
2018-02-06 20:38:45,115: Database Error in model deepcrawl_class (models/base-adp/deepcrawl/deepcrawl_class.sql)
2018-02-06 20:38:45,115:   Unrecognized name: flag_blog_h1; Did you mean flag_blog_path? at [33:62]
2018-02-06 20:38:45,115:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class.sql
2018-02-06 20:38:45,116: 
Done. PASS=25 ERROR=1 SKIP=2 TOTAL=28
2018-02-06 20:38:45,116: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da646d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da64860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da64710>]}
2018-02-06 20:38:45,420: Flushing usage events
2018-02-06 20:40:13,685: Tracking: tracking
2018-02-06 20:40:13,687: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11204d0f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11204d8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11204da58>]}
2018-02-06 20:40:14,494: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-06 20:40:14,511: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-06 20:40:14,515: Parsing core.sql
2018-02-06 20:40:14,535: Parsing adapters/bigquery.sql
2018-02-06 20:40:14,546: Parsing adapters/common.sql
2018-02-06 20:40:14,568: Parsing adapters/postgres.sql
2018-02-06 20:40:14,574: Parsing adapters/redshift.sql
2018-02-06 20:40:14,598: Parsing etc/get_custom_schema.sql
2018-02-06 20:40:14,607: Parsing materializations/archive.sql
2018-02-06 20:40:14,646: Parsing materializations/bigquery.sql
2018-02-06 20:40:14,670: Parsing materializations/helpers.sql
2018-02-06 20:40:14,695: Parsing materializations/incremental.sql
2018-02-06 20:40:14,723: Parsing materializations/table.sql
2018-02-06 20:40:14,745: Parsing materializations/view.sql
2018-02-06 20:40:14,762: Parsing materializations/wrapper.sql
2018-02-06 20:40:14,771: Parsing schema_tests/accepted_values.sql
2018-02-06 20:40:14,779: Parsing schema_tests/not_null.sql
2018-02-06 20:40:14,784: Parsing schema_tests/relationships.sql
2018-02-06 20:40:14,790: Parsing schema_tests/unique.sql
2018-02-06 20:40:14,857: Parsing model.seo_audit.accounts_proc
2018-02-06 20:40:14,861: Parsing model.seo_audit.all_dates
2018-02-06 20:40:14,863: Parsing model.seo_audit.mappings_ga_proc
2018-02-06 20:40:14,867: Acquiring new bigquery connection "master".
2018-02-06 20:40:14,867: Opening a new connection (0 currently allocated)
2018-02-06 20:40:14,872: Parsing model.seo_audit.agg_all
2018-02-06 20:40:14,877: Parsing model.seo_audit.agg_indicative
2018-02-06 20:40:14,880: Parsing model.seo_audit.agg_stats
2018-02-06 20:40:14,884: Parsing model.seo_audit.agg_stats_client
2018-02-06 20:40:14,887: Parsing model.seo_audit.deepcrawl_class
2018-02-06 20:40:14,890: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-06 20:40:14,892: Parsing model.seo_audit.deepcrawl_proc
2018-02-06 20:40:14,894: Parsing model.seo_audit.ga_proc
2018-02-06 20:40:14,897: Parsing model.seo_audit.ga_stats
2018-02-06 20:40:14,899: Parsing model.seo_audit.majestic_domain_history
2018-02-06 20:40:14,900: Parsing model.seo_audit.majestic_domain_proc
2018-02-06 20:40:14,903: Parsing model.seo_audit.majestic_domain_stats
2018-02-06 20:40:14,906: Parsing model.seo_audit.moz_proc
2018-02-06 20:40:14,912: Parsing model.seo_audit.screamingfrog_proc
2018-02-06 20:40:14,918: Parsing model.seo_audit.search_console_history
2018-02-06 20:40:14,921: Parsing model.seo_audit.search_console_proc
2018-02-06 20:40:14,925: Parsing model.seo_audit.search_console_stats_keyword
2018-02-06 20:40:14,927: Parsing model.seo_audit.search_console_stats_url
2018-02-06 20:40:14,929: Parsing model.seo_audit.semrush_domain_proc
2018-02-06 20:40:14,931: Parsing model.seo_audit.semrush_keyword_history
2018-02-06 20:40:14,934: Parsing model.seo_audit.semrush_keyword_proc
2018-02-06 20:40:14,937: Parsing model.seo_audit.semrush_keyword_stats
2018-02-06 20:40:14,939: Parsing model.seo_audit.semrush_url_history
2018-02-06 20:40:14,941: Parsing model.seo_audit.semrush_url_stats
2018-02-06 20:40:14,943: Parsing model.seo_audit.sitemap_proc
2018-02-06 20:40:14,956: Found 28 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-06 20:40:14,963: 
2018-02-06 20:40:15,750: 20:40:15 | Concurrency: 4 threads (target='dev')
2018-02-06 20:40:15,751: 20:40:15 | 
2018-02-06 20:40:15,928: 20:40:15 | 1 of 28 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-06 20:40:15,929: Compiling model.seo_audit.accounts_proc
2018-02-06 20:40:15,929: 20:40:15 | 2 of 28 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-06 20:40:15,934: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-06 20:40:15,929: 20:40:15 | 3 of 28 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-06 20:40:15,934: Compiling model.seo_audit.all_dates
2018-02-06 20:40:15,935: Compiling model.seo_audit.deepcrawl_proc
2018-02-06 20:40:15,939: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-06 20:40:15,943: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-06 20:40:15,947: Acquiring new bigquery connection "all_dates".
2018-02-06 20:40:15,947: Opening a new connection (1 currently allocated)
2018-02-06 20:40:15,948: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-06 20:40:15,949: Acquiring new bigquery connection "accounts_proc".
2018-02-06 20:40:15,952: Opening a new connection (2 currently allocated)
2018-02-06 20:40:16,001: Opening a new connection (3 currently allocated)
2018-02-06 20:40:16,533: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-06 20:40:16,546: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-06 20:40:16,586: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-06 20:40:16,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112183550>]}
2018-02-06 20:40:16,785: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112183ef0>]}
2018-02-06 20:40:16,805: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112183da0>]}
2018-02-06 20:40:16,937: 20:40:16 | 2 of 28 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.78s]
2018-02-06 20:40:17,199: 20:40:17 | 1 of 28 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.86s]
2018-02-06 20:40:17,526: 20:40:17 | 3 of 28 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.87s]
2018-02-06 20:40:17,527: 20:40:17 | 4 of 28 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-06 20:40:17,528: Compiling model.seo_audit.semrush_keyword_proc
2018-02-06 20:40:17,541: 20:40:17 | 5 of 28 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-06 20:40:17,541: 20:40:17 | 6 of 28 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-06 20:40:17,545: Compiling model.seo_audit.majestic_domain_proc
2018-02-06 20:40:17,541: 20:40:17 | 7 of 28 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-06 20:40:17,544: Compiling model.seo_audit.mappings_ga_proc
2018-02-06 20:40:17,552: Compiling model.seo_audit.moz_proc
2018-02-06 20:40:17,556: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-06 20:40:17,557: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-06 20:40:17,568: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-06 20:40:17,574: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-06 20:40:17,581: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-06 20:40:17,581: Re-using an available connection from the pool.
2018-02-06 20:40:17,582: Acquiring new bigquery connection "moz_proc".
2018-02-06 20:40:17,583: Re-using an available connection from the pool.
2018-02-06 20:40:17,586: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-06 20:40:17,595: Re-using an available connection from the pool.
2018-02-06 20:40:17,602: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-06 20:40:17,603: Opening a new connection (4 currently allocated)
2018-02-06 20:40:17,965: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:40:17,982: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-06 20:40:18,042: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:40:18,297: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11221b828>]}
2018-02-06 20:40:18,358: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112244a58>]}
2018-02-06 20:40:18,361: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-06 20:40:18,509: 20:40:18 | 7 of 28 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.74s]
2018-02-06 20:40:18,509: 20:40:18 | 8 of 28 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-06 20:40:18,510: Compiling model.seo_audit.screamingfrog_proc
2018-02-06 20:40:18,523: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-06 20:40:18,530: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-06 20:40:18,530: Re-using an available connection from the pool.
2018-02-06 20:40:18,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11217d828>]}
2018-02-06 20:40:18,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11218e2b0>]}
2018-02-06 20:40:18,781: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-06 20:40:18,926: 20:40:18 | 6 of 28 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.81s]
2018-02-06 20:40:18,927: 20:40:18 | 9 of 28 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-06 20:40:18,927: Compiling model.seo_audit.semrush_domain_proc
2018-02-06 20:40:18,938: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-06 20:40:18,942: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-06 20:40:18,944: Re-using an available connection from the pool.
2018-02-06 20:40:19,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1121840b8>]}
2018-02-06 20:40:19,131: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-06 20:40:19,161: 20:40:19 | 4 of 28 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 1.01s]
2018-02-06 20:40:19,162: 20:40:19 | 10 of 28 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-06 20:40:19,162: Compiling model.seo_audit.sitemap_proc
2018-02-06 20:40:19,172: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-06 20:40:19,176: Acquiring new bigquery connection "sitemap_proc".
2018-02-06 20:40:19,176: Re-using an available connection from the pool.
2018-02-06 20:40:19,390: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-06 20:40:19,403: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112153d30>]}
2018-02-06 20:40:19,444: 20:40:19 | 5 of 28 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 1.15s]
2018-02-06 20:40:19,444: 20:40:19 | 11 of 28 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-06 20:40:19,444: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-06 20:40:19,455: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-06 20:40:19,459: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-06 20:40:19,460: Re-using an available connection from the pool.
2018-02-06 20:40:19,659: Model SQL (deepcrawl_class_proc):
select
url,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'post'
  else null end as class_sitemap,
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-06 20:40:19,676: 20:40:19 | 8 of 28 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.58s]
2018-02-06 20:40:19,677: 20:40:19 | 12 of 28 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-06 20:40:19,681: Compiling model.seo_audit.search_console_proc
2018-02-06 20:40:19,694: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-06 20:40:19,696: Acquiring new bigquery connection "search_console_proc".
2018-02-06 20:40:19,696: Re-using an available connection from the pool.
2018-02-06 20:40:19,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11217d828>]}
2018-02-06 20:40:19,908: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-06 20:40:19,928: 20:40:19 | 9 of 28 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.48s]
2018-02-06 20:40:19,929: 20:40:19 | 13 of 28 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-06 20:40:19,929: Compiling model.seo_audit.ga_proc
2018-02-06 20:40:19,945: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-06 20:40:19,950: Acquiring new bigquery connection "ga_proc".
2018-02-06 20:40:19,951: Re-using an available connection from the pool.
2018-02-06 20:40:19,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11218e2b0>]}
2018-02-06 20:40:20,193: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11211bf60>]}
2018-02-06 20:40:20,194: 20:40:20 | 10 of 28 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.58s]
2018-02-06 20:40:20,201: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-06 20:40:20,486: 20:40:20 | 11 of 28 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.52s]
2018-02-06 20:40:20,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112153d30>]}
2018-02-06 20:40:20,787: 20:40:20 | 12 of 28 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.51s]
2018-02-06 20:40:21,025: 20:40:21 | 13 of 28 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.57s]
2018-02-06 20:40:21,026: 20:40:21 | 14 of 28 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-06 20:40:21,027: Compiling model.seo_audit.search_console_history
2018-02-06 20:40:21,026: 20:40:21 | 15 of 28 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-06 20:40:21,026: 20:40:21 | 16 of 28 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-06 20:40:21,033: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-06 20:40:21,027: 20:40:21 | 17 of 28 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-06 20:40:21,034: Compiling model.seo_audit.semrush_keyword_history
2018-02-06 20:40:21,034: Compiling model.seo_audit.semrush_url_history
2018-02-06 20:40:21,034: Compiling model.seo_audit.ga_stats
2018-02-06 20:40:21,051: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-06 20:40:21,079: Acquiring new bigquery connection "semrush_url_history".
2018-02-06 20:40:21,079: Re-using an available connection from the pool.
2018-02-06 20:40:21,077: Acquiring new bigquery connection "search_console_history".
2018-02-06 20:40:21,080: Re-using an available connection from the pool.
2018-02-06 20:40:21,091: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-06 20:40:21,057: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-06 20:40:21,096: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-06 20:40:21,098: Re-using an available connection from the pool.
2018-02-06 20:40:21,110: Acquiring new bigquery connection "ga_stats".
2018-02-06 20:40:21,110: Re-using an available connection from the pool.
2018-02-06 20:40:21,286: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-06 20:40:21,290: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-06 20:40:21,322: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-06 20:40:21,356: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-06 20:40:21,563: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11221be80>]}
2018-02-06 20:40:21,595: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112170a58>]}
2018-02-06 20:40:21,617: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11221b6a0>]}
2018-02-06 20:40:21,805: 20:40:21 | 15 of 28 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.53s]
2018-02-06 20:40:21,806: 20:40:21 | 18 of 28 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-06 20:40:21,807: Compiling model.seo_audit.majestic_domain_history
2018-02-06 20:40:21,816: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-06 20:40:21,817: Acquiring new bigquery connection "majestic_domain_history".
2018-02-06 20:40:21,820: Re-using an available connection from the pool.
2018-02-06 20:40:21,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1122306d8>]}
2018-02-06 20:40:22,044: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-06 20:40:22,066: 20:40:22 | 14 of 28 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.57s]
2018-02-06 20:40:22,313: 20:40:22 | 16 of 28 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.58s]
2018-02-06 20:40:22,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11221be80>]}
2018-02-06 20:40:22,515: 20:40:22 | 17 of 28 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.88s]
2018-02-06 20:40:22,731: 20:40:22 | 18 of 28 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.58s]
2018-02-06 20:40:22,732: 20:40:22 | 19 of 28 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-06 20:40:22,732: Compiling model.seo_audit.search_console_stats_keyword
2018-02-06 20:40:22,742: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-06 20:40:22,743: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-06 20:40:22,740: 20:40:22 | 20 of 28 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-06 20:40:22,744: Re-using an available connection from the pool.
2018-02-06 20:40:22,740: 20:40:22 | 21 of 28 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-06 20:40:22,744: Compiling model.seo_audit.search_console_stats_url
2018-02-06 20:40:22,745: Compiling model.seo_audit.deepcrawl_class
2018-02-06 20:40:22,769: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-06 20:40:22,772: Acquiring new bigquery connection "search_console_stats_url".
2018-02-06 20:40:22,772: Re-using an available connection from the pool.
2018-02-06 20:40:22,783: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-06 20:40:22,786: Acquiring new bigquery connection "deepcrawl_class".
2018-02-06 20:40:22,786: Re-using an available connection from the pool.
2018-02-06 20:40:22,897: Model SQL (deepcrawl_class):
SELECT 
url,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when class_sitemap is not null then class_sitemap
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when ( flag_above_avg_prices = 1 or flag_learn_more = 1 ) then 'category'
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-06 20:40:22,973: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-06 20:40:23,043: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-06 20:40:23,297: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1121f8b70>]}
2018-02-06 20:40:23,314: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112267780>]}
2018-02-06 20:40:23,431: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112267c50>]}
2018-02-06 20:40:23,507: 20:40:23 | 19 of 28 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.56s]
2018-02-06 20:40:23,721: 20:40:23 | 21 of 28 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.57s]
2018-02-06 20:40:23,949: 20:40:23 | 20 of 28 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.69s]
2018-02-06 20:40:23,950: 20:40:23 | 22 of 28 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-06 20:40:23,951: Compiling model.seo_audit.semrush_keyword_stats
2018-02-06 20:40:23,950: 20:40:23 | 23 of 28 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-06 20:40:23,962: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-06 20:40:23,962: Compiling model.seo_audit.majestic_domain_stats
2018-02-06 20:40:23,950: 20:40:23 | 24 of 28 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-06 20:40:23,974: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-06 20:40:23,974: Compiling model.seo_audit.semrush_url_stats
2018-02-06 20:40:23,982: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-06 20:40:23,988: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-06 20:40:23,988: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-06 20:40:23,989: Re-using an available connection from the pool.
2018-02-06 20:40:23,991: Re-using an available connection from the pool.
2018-02-06 20:40:23,995: Acquiring new bigquery connection "semrush_url_stats".
2018-02-06 20:40:23,995: Re-using an available connection from the pool.
2018-02-06 20:40:24,181: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:40:24,198: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-06 20:40:24,235: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-06 20:40:24,530: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1121f8b70>]}
2018-02-06 20:40:24,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112230ef0>]}
2018-02-06 20:40:24,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112131f28>]}
2018-02-06 20:40:24,755: 20:40:24 | 23 of 28 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.57s]
2018-02-06 20:40:24,980: 20:40:24 | 24 of 28 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.68s]
2018-02-06 20:40:25,201: 20:40:25 | 22 of 28 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-06 20:40:25,202: 20:40:25 | 25 of 28 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-06 20:40:25,202: Compiling model.seo_audit.agg_indicative
2018-02-06 20:40:25,212: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-06 20:40:25,214: Acquiring new bigquery connection "agg_indicative".
2018-02-06 20:40:25,214: Re-using an available connection from the pool.
2018-02-06 20:40:25,379: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-06 20:40:25,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11217dd30>]}
2018-02-06 20:40:26,205: 20:40:26 | 25 of 28 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.80s]
2018-02-06 20:40:26,206: 20:40:26 | 26 of 28 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-06 20:40:26,206: Compiling model.seo_audit.agg_stats
2018-02-06 20:40:26,219: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-06 20:40:26,220: Acquiring new bigquery connection "agg_stats".
2018-02-06 20:40:26,220: Re-using an available connection from the pool.
2018-02-06 20:40:26,456: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-06 20:40:27,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112131f28>]}
2018-02-06 20:40:27,312: 20:40:27 | 26 of 28 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.86s]
2018-02-06 20:40:27,312: 20:40:27 | 27 of 28 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-06 20:40:27,313: Compiling model.seo_audit.agg_stats_client
2018-02-06 20:40:27,322: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-06 20:40:27,324: Acquiring new bigquery connection "agg_stats_client".
2018-02-06 20:40:27,324: Re-using an available connection from the pool.
2018-02-06 20:40:27,490: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-06 20:40:28,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11217dd30>]}
2018-02-06 20:40:28,509: 20:40:28 | 27 of 28 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.93s]
2018-02-06 20:40:28,510: 20:40:28 | 28 of 28 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-06 20:40:28,510: Compiling model.seo_audit.agg_all
2018-02-06 20:40:28,521: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-06 20:40:28,523: Acquiring new bigquery connection "agg_all".
2018-02-06 20:40:28,523: Re-using an available connection from the pool.
2018-02-06 20:40:28,733: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-06 20:40:29,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0324d42d-8478-4aea-9fa2-c64027828672', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112131f28>]}
2018-02-06 20:40:29,850: 20:40:29 | 28 of 28 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.11s]
2018-02-06 20:40:29,877: 20:40:29 | 
2018-02-06 20:40:29,878: 20:40:29 | Finished running 28 view models in 14.13s.
2018-02-06 20:40:29,878: Connection 'master' was left open.
2018-02-06 20:40:29,878: 
2018-02-06 20:40:29,878: Completed successfully
2018-02-06 20:40:29,879: 
Done. PASS=28 ERROR=0 SKIP=0 TOTAL=28
2018-02-06 20:40:29,879: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112150e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11211b828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11211b6d8>]}
2018-02-06 20:40:30,124: Flushing usage events
2018-02-07 15:19:51,508: Tracking: tracking
2018-02-07 15:19:51,511: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cecc88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cece80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cecfd0>]}
2018-02-07 15:19:52,314: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:19:52,346: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:19:52,353: Parsing core.sql
2018-02-07 15:19:52,385: Parsing adapters/bigquery.sql
2018-02-07 15:19:52,394: Parsing adapters/common.sql
2018-02-07 15:19:52,415: Parsing adapters/postgres.sql
2018-02-07 15:19:52,421: Parsing adapters/redshift.sql
2018-02-07 15:19:52,466: Parsing etc/get_custom_schema.sql
2018-02-07 15:19:52,475: Parsing materializations/archive.sql
2018-02-07 15:19:52,516: Parsing materializations/bigquery.sql
2018-02-07 15:19:52,536: Parsing materializations/helpers.sql
2018-02-07 15:19:52,558: Parsing materializations/incremental.sql
2018-02-07 15:19:52,594: Parsing materializations/table.sql
2018-02-07 15:19:52,621: Parsing materializations/view.sql
2018-02-07 15:19:52,642: Parsing materializations/wrapper.sql
2018-02-07 15:19:52,648: Parsing schema_tests/accepted_values.sql
2018-02-07 15:19:52,653: Parsing schema_tests/not_null.sql
2018-02-07 15:19:52,657: Parsing schema_tests/relationships.sql
2018-02-07 15:19:52,665: Parsing schema_tests/unique.sql
2018-02-07 15:19:52,688: Parsing model.seo_audit.accounts_proc
2018-02-07 15:19:52,691: Parsing model.seo_audit.all_dates
2018-02-07 15:19:52,692: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:19:52,695: Acquiring new bigquery connection "master".
2018-02-07 15:19:52,695: Opening a new connection (0 currently allocated)
2018-02-07 15:19:52,702: Parsing model.seo_audit.agg_all
2018-02-07 15:19:52,705: Parsing model.seo_audit.agg_indicative
2018-02-07 15:19:52,707: Parsing model.seo_audit.agg_stats
2018-02-07 15:19:52,714: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:19:52,719: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:19:52,722: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:19:52,725: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:19:52,727: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:19:52,730: Parsing model.seo_audit.ga_proc
2018-02-07 15:19:52,733: Parsing model.seo_audit.ga_stats
2018-02-07 15:19:52,736: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:19:52,739: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:19:52,742: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:19:52,745: Parsing model.seo_audit.moz_proc
2018-02-07 15:19:52,748: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:19:52,752: Parsing model.seo_audit.search_console_history
2018-02-07 15:19:52,754: Parsing model.seo_audit.search_console_proc
2018-02-07 15:19:52,757: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:19:52,760: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:19:52,764: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:19:52,768: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:19:52,773: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:19:52,781: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:19:52,791: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:19:52,798: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:19:52,803: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:19:52,819: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:19:52,831: 
2018-02-07 15:19:54,082: 15:19:54 | Concurrency: 4 threads (target='dev')
2018-02-07 15:19:54,083: 15:19:54 | 
2018-02-07 15:19:54,415: 15:19:54 | 1 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:19:54,416: Compiling model.seo_audit.accounts_proc
2018-02-07 15:19:54,415: 15:19:54 | 2 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:19:54,426: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:19:54,415: 15:19:54 | 3 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:19:54,426: Compiling model.seo_audit.all_dates
2018-02-07 15:19:54,427: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:19:54,435: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:19:54,448: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:19:54,449: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:19:54,449: Opening a new connection (1 currently allocated)
2018-02-07 15:19:54,451: Acquiring new bigquery connection "all_dates".
2018-02-07 15:19:54,538: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:19:54,538: Opening a new connection (2 currently allocated)
2018-02-07 15:19:54,632: Opening a new connection (3 currently allocated)
2018-02-07 15:19:55,289: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:19:55,431: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url, '?')[SAFE_ORDINAL(2)] as query_string,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:19:55,436: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:19:55,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e956d8>]}
2018-02-07 15:19:55,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e28b70>]}
2018-02-07 15:19:55,851: 15:19:55 | 1 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.12s]
2018-02-07 15:19:56,066: 15:19:56 | 2 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.20s]
2018-02-07 15:19:56,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e28630>]}
2018-02-07 15:19:56,283: 15:19:56 | 3 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.64s]
2018-02-07 15:19:56,284: 15:19:56 | 4 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 15:19:56,285: Compiling model.seo_audit.moz_proc
2018-02-07 15:19:56,284: 15:19:56 | 5 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 15:19:56,296: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:19:56,296: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:19:56,285: 15:19:56 | 6 of 29 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-07 15:19:56,303: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:19:56,313: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:19:56,317: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:19:56,285: 15:19:56 | 7 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 15:19:56,319: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:19:56,320: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:19:56,321: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:19:56,321: Compiling model.seo_audit.search_console_proc
2018-02-07 15:19:56,322: Re-using an available connection from the pool.
2018-02-07 15:19:56,329: Re-using an available connection from the pool.
2018-02-07 15:19:56,336: Re-using an available connection from the pool.
2018-02-07 15:19:56,340: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:19:56,357: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:19:56,357: Opening a new connection (4 currently allocated)
2018-02-07 15:19:56,631: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:19:56,638: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:19:56,644: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  path_count,
  first_path,
  second_last_path,
  last_path,
  query_string,
  split(last_path,'.')[SAFE_ORDINAL(2)] as filename
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:19:56,744: Bad request while running:
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  path_count,
  first_path,
  second_last_path,
  last_path,
  query_string,
  split(last_path,'.')[SAFE_ORDINAL(2)] as filename
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:19:56,745: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Expected ")" but got identifier "url_length" at [70:3]
2018-02-07 15:19:56,745: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e11780>]}
2018-02-07 15:19:56,935: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:19:56,946: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebccf8>]}
2018-02-07 15:19:56,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebca20>]}
2018-02-07 15:19:56,962: 15:19:56 | 6 of 29 ERROR creating view model seo_audit_dev.deepcrawl_class_proc. [ERROR in 0.44s]
2018-02-07 15:19:56,965: 15:19:56 | 8 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 15:19:56,966: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:19:56,976: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:19:56,978: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:19:56,978: Re-using an available connection from the pool.
2018-02-07 15:19:57,201: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:19:57,270: 15:19:57 | 4 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.66s]
2018-02-07 15:19:57,271: 15:19:57 | 9 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 15:19:57,271: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:19:57,284: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:19:57,289: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:19:57,289: Re-using an available connection from the pool.
2018-02-07 15:19:57,424: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dd5f60>]}
2018-02-07 15:19:57,510: 15:19:57 | 5 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.65s]
2018-02-07 15:19:57,510: 15:19:57 | 10 of 29 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-07 15:19:57,512: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:19:57,525: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:19:57,528: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:19:57,529: Re-using an available connection from the pool.
2018-02-07 15:19:57,537: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:19:57,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e11780>]}
2018-02-07 15:19:57,752: 15:19:57 | 7 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 1.10s]
2018-02-07 15:19:57,755: 15:19:57 | 11 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 15:19:57,758: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:19:57,767: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:19:57,777: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:19:57,783: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:19:57,783: Re-using an available connection from the pool.
2018-02-07 15:19:57,894: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef7710>]}
2018-02-07 15:19:57,970: 15:19:57 | 8 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.57s]
2018-02-07 15:19:57,971: 15:19:57 | 12 of 29 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-07 15:19:57,975: Compiling model.seo_audit.ga_proc
2018-02-07 15:19:57,988: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:19:57,989: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:19:57,989: Re-using an available connection from the pool.
2018-02-07 15:19:58,032: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:19:58,106: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebca20>]}
2018-02-07 15:19:58,194: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:19:58,275: 15:19:58 | 9 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.62s]
2018-02-07 15:19:58,277: 15:19:58 | 13 of 29 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-07 15:19:58,279: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:19:58,293: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:19:58,297: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:19:58,297: Re-using an available connection from the pool.
2018-02-07 15:19:58,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dd5f60>]}
2018-02-07 15:19:58,498: 15:19:58 | 10 of 29 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.59s]
2018-02-07 15:19:58,504: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068956a0>]}
2018-02-07 15:19:58,523: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:19:58,814: 15:19:58 | 11 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.57s]
2018-02-07 15:19:58,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e2e470>]}
2018-02-07 15:19:59,048: 15:19:59 | 12 of 29 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.53s]
2018-02-07 15:19:59,266: 15:19:59 | 13 of 29 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.63s]
2018-02-07 15:19:59,266: 15:19:59 | 14 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:19:59,267: Compiling model.seo_audit.ga_stats
2018-02-07 15:19:59,267: 15:19:59 | 15 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:19:59,277: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:19:59,277: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:19:59,267: 15:19:59 | 16 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:19:59,289: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:19:59,267: 15:19:59 | 17 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:19:59,289: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:19:59,290: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:19:59,304: Re-using an available connection from the pool.
2018-02-07 15:19:59,297: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:19:59,307: Re-using an available connection from the pool.
2018-02-07 15:19:59,304: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:19:59,291: Compiling model.seo_audit.search_console_history
2018-02-07 15:19:59,323: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:19:59,323: Re-using an available connection from the pool.
2018-02-07 15:19:59,331: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:19:59,335: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:19:59,335: Re-using an available connection from the pool.
2018-02-07 15:19:59,528: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:19:59,533: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:19:59,548: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:19:59,553: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:19:59,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebca20>]}
2018-02-07 15:19:59,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109deb4a8>]}
2018-02-07 15:19:59,874: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebc4a8>]}
2018-02-07 15:19:59,942: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebc630>]}
2018-02-07 15:20:00,097: 15:20:00 | 16 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.57s]
2018-02-07 15:20:00,103: 15:20:00 | 18 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:20:00,105: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:20:00,118: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:20:00,120: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:20:00,120: Re-using an available connection from the pool.
2018-02-07 15:20:00,346: 15:20:00 | 14 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.60s]
2018-02-07 15:20:00,370: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:20:00,609: 15:20:00 | 17 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.58s]
2018-02-07 15:20:00,720: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebca20>]}
2018-02-07 15:20:00,839: 15:20:00 | 15 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.66s]
2018-02-07 15:20:01,140: 15:20:01 | 18 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.61s]
2018-02-07 15:20:01,141: 15:20:01 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:20:01,141: 15:20:01 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:20:01,142: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:20:01,141: 15:20:01 | 21 of 29 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-07 15:20:01,142: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:20:01,164: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:20:01,168: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:20:01,170: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:20:01,170: Re-using an available connection from the pool.
2018-02-07 15:20:01,174: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:20:01,174: Re-using an available connection from the pool.
2018-02-07 15:20:01,393: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:20:01,404: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:20:01,792: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebc4a8>]}
2018-02-07 15:20:01,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e2e470>]}
2018-02-07 15:20:02,084: 15:20:02 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-07 15:20:02,327: 15:20:02 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.74s]
2018-02-07 15:20:02,328: 15:20:02 | 22 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:20:02,328: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:20:02,328: 15:20:02 | 23 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:20:02,328: 15:20:02 | 24 of 29 SKIP relation seo_audit_dev.deepcrawl_classification_stats.. [SKIP]
2018-02-07 15:20:02,340: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:20:02,340: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:20:02,328: 15:20:02 | 25 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:20:02,352: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:20:02,353: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:20:02,364: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:20:02,365: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:20:02,366: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:20:02,367: Re-using an available connection from the pool.
2018-02-07 15:20:02,368: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:20:02,368: Re-using an available connection from the pool.
2018-02-07 15:20:02,376: Re-using an available connection from the pool.
2018-02-07 15:20:02,611: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:20:02,612: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:20:02,621: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:20:03,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebc3c8>]}
2018-02-07 15:20:03,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ed3438>]}
2018-02-07 15:20:03,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df2eb8>]}
2018-02-07 15:20:03,254: 15:20:03 | 23 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.69s]
2018-02-07 15:20:03,560: 15:20:03 | 25 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.69s]
2018-02-07 15:20:03,781: 15:20:03 | 22 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-07 15:20:03,781: 15:20:03 | 26 of 29 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-07 15:20:03,782: 15:20:03 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:20:03,782: Compiling model.seo_audit.agg_stats
2018-02-07 15:20:03,803: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:20:03,805: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:20:03,805: Re-using an available connection from the pool.
2018-02-07 15:20:04,034: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:20:04,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df2eb8>]}
2018-02-07 15:20:04,919: 15:20:04 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.90s]
2018-02-07 15:20:04,920: 15:20:04 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:20:04,921: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:20:04,935: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:20:04,936: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:20:04,936: Re-using an available connection from the pool.
2018-02-07 15:20:05,155: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:20:05,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17c86798-c996-486d-a6bf-d7b0208e37f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ebc358>]}
2018-02-07 15:20:06,057: 15:20:06 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.91s]
2018-02-07 15:20:06,059: 15:20:06 | 29 of 29 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-07 15:20:06,157: 15:20:06 | 
2018-02-07 15:20:06,157: 15:20:06 | Finished running 29 view models in 12.09s.
2018-02-07 15:20:06,158: Connection 'master' was left open.
2018-02-07 15:20:06,158: 
2018-02-07 15:20:06,158: Completed with 1 errors:
2018-02-07 15:20:06,158: 
2018-02-07 15:20:06,159: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-07 15:20:06,159:   Syntax error: Expected ")" but got identifier "url_length" at [70:3]
2018-02-07 15:20:06,159:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-07 15:20:06,159: 
Done. PASS=24 ERROR=1 SKIP=4 TOTAL=29
2018-02-07 15:20:06,160: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df2278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dbb518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dbb5f8>]}
2018-02-07 15:20:06,401: Flushing usage events
2018-02-07 15:32:16,590: Tracking: tracking
2018-02-07 15:32:16,592: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c6c358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c6c5c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5e9fd0>]}
2018-02-07 15:32:17,329: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:32:17,351: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:32:17,354: Parsing core.sql
2018-02-07 15:32:17,378: Parsing adapters/bigquery.sql
2018-02-07 15:32:17,385: Parsing adapters/common.sql
2018-02-07 15:32:17,402: Parsing adapters/postgres.sql
2018-02-07 15:32:17,407: Parsing adapters/redshift.sql
2018-02-07 15:32:17,434: Parsing etc/get_custom_schema.sql
2018-02-07 15:32:17,447: Parsing materializations/archive.sql
2018-02-07 15:32:17,483: Parsing materializations/bigquery.sql
2018-02-07 15:32:17,500: Parsing materializations/helpers.sql
2018-02-07 15:32:17,518: Parsing materializations/incremental.sql
2018-02-07 15:32:17,557: Parsing materializations/table.sql
2018-02-07 15:32:17,579: Parsing materializations/view.sql
2018-02-07 15:32:17,595: Parsing materializations/wrapper.sql
2018-02-07 15:32:17,601: Parsing schema_tests/accepted_values.sql
2018-02-07 15:32:17,607: Parsing schema_tests/not_null.sql
2018-02-07 15:32:17,611: Parsing schema_tests/relationships.sql
2018-02-07 15:32:17,617: Parsing schema_tests/unique.sql
2018-02-07 15:32:17,687: Parsing model.seo_audit.accounts_proc
2018-02-07 15:32:17,691: Parsing model.seo_audit.all_dates
2018-02-07 15:32:17,693: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:32:17,696: Acquiring new bigquery connection "master".
2018-02-07 15:32:17,697: Opening a new connection (0 currently allocated)
2018-02-07 15:32:17,703: Parsing model.seo_audit.agg_all
2018-02-07 15:32:17,708: Parsing model.seo_audit.agg_indicative
2018-02-07 15:32:17,712: Parsing model.seo_audit.agg_stats
2018-02-07 15:32:17,717: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:32:17,720: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:32:17,722: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:32:17,725: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:32:17,726: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:32:17,729: Parsing model.seo_audit.ga_proc
2018-02-07 15:32:17,732: Parsing model.seo_audit.ga_stats
2018-02-07 15:32:17,733: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:32:17,735: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:32:17,737: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:32:17,739: Parsing model.seo_audit.moz_proc
2018-02-07 15:32:17,742: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:32:17,745: Parsing model.seo_audit.search_console_history
2018-02-07 15:32:17,748: Parsing model.seo_audit.search_console_proc
2018-02-07 15:32:17,750: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:32:17,753: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:32:17,754: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:32:17,757: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:32:17,759: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:32:17,763: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:32:17,765: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:32:17,767: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:32:17,769: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:32:17,781: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:32:17,789: 
2018-02-07 15:32:19,081: 15:32:19 | Concurrency: 4 threads (target='dev')
2018-02-07 15:32:19,081: 15:32:19 | 
2018-02-07 15:32:19,271: 15:32:19 | 1 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:32:19,272: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:32:19,272: 15:32:19 | 2 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:32:19,277: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:32:19,272: 15:32:19 | 3 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:32:19,277: Compiling model.seo_audit.all_dates
2018-02-07 15:32:19,277: Compiling model.seo_audit.accounts_proc
2018-02-07 15:32:19,282: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:32:19,287: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:32:19,288: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:32:19,288: Opening a new connection (1 currently allocated)
2018-02-07 15:32:19,289: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:32:19,339: Opening a new connection (2 currently allocated)
2018-02-07 15:32:19,340: Acquiring new bigquery connection "all_dates".
2018-02-07 15:32:19,395: Opening a new connection (3 currently allocated)
2018-02-07 15:32:19,938: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url, '?')[SAFE_ORDINAL(2)] as query_string,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:32:19,979: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:32:19,984: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:32:20,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a70b898>]}
2018-02-07 15:32:20,187: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a799f98>]}
2018-02-07 15:32:20,209: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7996d8>]}
2018-02-07 15:32:20,382: 15:32:20 | 2 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.89s]
2018-02-07 15:32:20,670: 15:32:20 | 3 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.91s]
2018-02-07 15:32:20,905: 15:32:20 | 1 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.94s]
2018-02-07 15:32:20,906: 15:32:20 | 4 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 15:32:20,906: 15:32:20 | 5 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 15:32:20,906: 15:32:20 | 6 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 15:32:20,907: 15:32:20 | 7 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 15:32:20,907: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:32:20,907: Compiling model.seo_audit.ga_proc
2018-02-07 15:32:20,907: Compiling model.seo_audit.search_console_proc
2018-02-07 15:32:20,907: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:32:20,915: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:32:20,920: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:32:20,925: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:32:20,932: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:32:20,936: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:32:20,936: Re-using an available connection from the pool.
2018-02-07 15:32:20,938: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:32:20,939: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:32:20,940: Re-using an available connection from the pool.
2018-02-07 15:32:20,940: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:32:20,941: Re-using an available connection from the pool.
2018-02-07 15:32:20,943: Opening a new connection (4 currently allocated)
2018-02-07 15:32:21,156: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:32:21,208: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:32:21,243: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:32:21,430: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7207f0>]}
2018-02-07 15:32:21,481: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:32:21,499: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a70b748>]}
2018-02-07 15:32:21,563: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a787a20>]}
2018-02-07 15:32:21,642: 15:32:21 | 4 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.52s]
2018-02-07 15:32:21,645: 15:32:21 | 8 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 15:32:21,645: Compiling model.seo_audit.moz_proc
2018-02-07 15:32:21,659: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:32:21,660: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:32:21,660: Re-using an available connection from the pool.
2018-02-07 15:32:21,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072956d8>]}
2018-02-07 15:32:21,870: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:32:21,943: 15:32:21 | 7 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.59s]
2018-02-07 15:32:21,944: 15:32:21 | 9 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 15:32:21,945: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:32:21,955: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:32:21,958: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:32:21,958: Re-using an available connection from the pool.
2018-02-07 15:32:22,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7c17b8>]}
2018-02-07 15:32:22,209: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:32:22,254: 15:32:22 | 6 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.66s]
2018-02-07 15:32:22,255: 15:32:22 | 10 of 29 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-07 15:32:22,255: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:32:22,266: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:32:22,270: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:32:22,270: Re-using an available connection from the pool.
2018-02-07 15:32:22,486: 15:32:22 | 5 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.92s]
2018-02-07 15:32:22,487: 15:32:22 | 11 of 29 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-07 15:32:22,488: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:32:22,499: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:32:22,500: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:32:22,505: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:32:22,505: Re-using an available connection from the pool.
2018-02-07 15:32:22,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a70b748>]}
2018-02-07 15:32:22,693: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:32:22,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a787a20>]}
2018-02-07 15:32:22,785: 15:32:22 | 8 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.56s]
2018-02-07 15:32:22,786: 15:32:22 | 12 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 15:32:22,788: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:32:22,801: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:32:22,803: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:32:22,803: Re-using an available connection from the pool.
2018-02-07 15:32:22,925: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  path_count,
  first_path,
  second_last_path,
  last_path,
  query_string,
  split(last_path,'.')[SAFE_ORDINAL(2)] as filename,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:32:23,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072956d8>]}
2018-02-07 15:32:23,126: 15:32:23 | 9 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.64s]
2018-02-07 15:32:23,127: 15:32:23 | 13 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 15:32:23,127: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:32:23,139: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:32:23,143: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:32:23,143: Re-using an available connection from the pool.
2018-02-07 15:32:23,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7a58>]}
2018-02-07 15:32:23,365: 15:32:23 | 10 of 29 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.51s]
2018-02-07 15:32:23,372: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:32:23,584: 15:32:23 | 11 of 29 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.57s]
2018-02-07 15:32:23,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7e80>]}
2018-02-07 15:32:23,806: 15:32:23 | 12 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.49s]
2018-02-07 15:32:24,099: 15:32:24 | 13 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.56s]
2018-02-07 15:32:24,100: 15:32:24 | 14 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:32:24,101: Compiling model.seo_audit.ga_stats
2018-02-07 15:32:24,100: 15:32:24 | 15 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:32:24,107: Compiling model.seo_audit.search_console_history
2018-02-07 15:32:24,100: 15:32:24 | 16 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:32:24,115: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:32:24,116: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:32:24,100: 15:32:24 | 17 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:32:24,116: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:32:24,116: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:32:24,122: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:32:24,127: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:32:24,128: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:32:24,129: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:32:24,130: Re-using an available connection from the pool.
2018-02-07 15:32:24,131: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:32:24,132: Re-using an available connection from the pool.
2018-02-07 15:32:24,133: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:32:24,138: Re-using an available connection from the pool.
2018-02-07 15:32:24,142: Re-using an available connection from the pool.
2018-02-07 15:32:24,509: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:32:24,518: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:32:24,520: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:32:24,521: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:32:24,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7e80>]}
2018-02-07 15:32:24,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7b1c50>]}
2018-02-07 15:32:24,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a729550>]}
2018-02-07 15:32:24,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a720c18>]}
2018-02-07 15:32:25,185: 15:32:25 | 15 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.76s]
2018-02-07 15:32:25,186: 15:32:25 | 18 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:32:25,187: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:32:25,197: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:32:25,198: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:32:25,199: Re-using an available connection from the pool.
2018-02-07 15:32:25,410: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:32:25,488: 15:32:25 | 17 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.75s]
2018-02-07 15:32:25,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7e80>]}
2018-02-07 15:32:25,790: 15:32:25 | 14 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.78s]
2018-02-07 15:32:26,003: 15:32:26 | 16 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.76s]
2018-02-07 15:32:26,261: 15:32:26 | 18 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.53s]
2018-02-07 15:32:26,263: 15:32:26 | 19 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 15:32:26,264: Compiling model.seo_audit.deepcrawl_class
2018-02-07 15:32:26,263: 15:32:26 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:32:26,263: 15:32:26 | 21 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:32:26,274: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 15:32:26,274: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:32:26,274: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:32:26,280: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:32:26,286: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:32:26,286: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 15:32:26,287: Re-using an available connection from the pool.
2018-02-07 15:32:26,290: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:32:26,295: Re-using an available connection from the pool.
2018-02-07 15:32:26,291: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:32:26,302: Re-using an available connection from the pool.
2018-02-07 15:32:26,502: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 15:32:26,553: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:32:26,575: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:32:26,888: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a723dd8>]}
2018-02-07 15:32:26,901: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7c5fd0>]}
2018-02-07 15:32:26,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a720e80>]}
2018-02-07 15:32:27,112: 15:32:27 | 19 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.62s]
2018-02-07 15:32:27,404: 15:32:27 | 21 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.63s]
2018-02-07 15:32:27,723: 15:32:27 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-07 15:32:27,724: 15:32:27 | 22 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:32:27,725: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:32:27,724: 15:32:27 | 23 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:32:27,734: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:32:27,724: 15:32:27 | 24 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:32:27,734: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:32:27,724: 15:32:27 | 25 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 15:32:27,734: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:32:27,740: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:32:27,740: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:32:27,745: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:32:27,746: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:32:27,755: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 15:32:27,756: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:32:27,757: Re-using an available connection from the pool.
2018-02-07 15:32:27,757: Re-using an available connection from the pool.
2018-02-07 15:32:27,762: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 15:32:27,762: Re-using an available connection from the pool.
2018-02-07 15:32:27,769: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:32:27,771: Re-using an available connection from the pool.
2018-02-07 15:32:27,863: Model SQL (deepcrawl_classification_stats):
SELECT
first_path,
filename,
query_string,
classification,
count,
sum(count) OVER (PARTITION BY classification) total_classified,
count/total_classified as pct_classified
FROM 
(

	SELECT
	first_path,
	filename,
	query_string,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, filename, query_String, classification
)
2018-02-07 15:32:27,971: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:32:27,981: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:32:28,002: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:32:28,273: Bad request while running:
SELECT
first_path,
filename,
query_string,
classification,
count,
sum(count) OVER (PARTITION BY classification) total_classified,
count/total_classified as pct_classified
FROM 
(

	SELECT
	first_path,
	filename,
	query_string,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, filename, query_String, classification
)
2018-02-07 15:32:28,274: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: total_classified at [8:7]
2018-02-07 15:32:28,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a720320>]}
2018-02-07 15:32:28,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7e80>]}
2018-02-07 15:32:28,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7b1b00>]}
2018-02-07 15:32:28,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a720e10>]}
2018-02-07 15:32:28,559: 15:32:28 | 25 of 29 ERROR creating view model seo_audit_dev.deepcrawl_classification_stats [ERROR in 0.53s]
2018-02-07 15:32:28,788: 15:32:28 | 22 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.61s]
2018-02-07 15:32:29,071: 15:32:29 | 24 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.63s]
2018-02-07 15:32:29,287: 15:32:29 | 23 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.65s]
2018-02-07 15:32:29,288: 15:32:29 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 15:32:29,288: Compiling model.seo_audit.agg_indicative
2018-02-07 15:32:29,295: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 15:32:29,296: Acquiring new bigquery connection "agg_indicative".
2018-02-07 15:32:29,297: Re-using an available connection from the pool.
2018-02-07 15:32:29,617: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 15:32:30,005: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7c1160>]}
2018-02-07 15:32:30,290: 15:32:30 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.72s]
2018-02-07 15:32:30,291: 15:32:30 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:32:30,291: Compiling model.seo_audit.agg_stats
2018-02-07 15:32:30,301: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:32:30,302: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:32:30,302: Re-using an available connection from the pool.
2018-02-07 15:32:30,515: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:32:31,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7b1b00>]}
2018-02-07 15:32:31,468: 15:32:31 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.87s]
2018-02-07 15:32:31,468: 15:32:31 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:32:31,469: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:32:31,478: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:32:31,480: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:32:31,480: Re-using an available connection from the pool.
2018-02-07 15:32:31,723: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:32:32,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7c1160>]}
2018-02-07 15:32:32,620: 15:32:32 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.83s]
2018-02-07 15:32:32,620: 15:32:32 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 15:32:32,621: Compiling model.seo_audit.agg_all
2018-02-07 15:32:32,631: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 15:32:32,631: Acquiring new bigquery connection "agg_all".
2018-02-07 15:32:32,631: Re-using an available connection from the pool.
2018-02-07 15:32:32,858: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 15:32:33,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c7c5d9b-f21c-4d3b-804a-7a5d4fcdbe96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b7a58>]}
2018-02-07 15:32:34,154: 15:32:34 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.19s]
2018-02-07 15:32:34,252: 15:32:34 | 
2018-02-07 15:32:34,252: 15:32:34 | Finished running 29 view models in 15.17s.
2018-02-07 15:32:34,253: Connection 'master' was left open.
2018-02-07 15:32:34,253: 
2018-02-07 15:32:34,253: Completed with 1 errors:
2018-02-07 15:32:34,253: 
2018-02-07 15:32:34,254: Database Error in model deepcrawl_classification_stats (models/base-adp/deepcrawl/deepcrawl_classification_stats.sql)
2018-02-07 15:32:34,254:   Unrecognized name: total_classified at [8:7]
2018-02-07 15:32:34,254:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_classification_stats.sql
2018-02-07 15:32:34,255: 
Done. PASS=28 ERROR=1 SKIP=0 TOTAL=29
2018-02-07 15:32:34,255: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6ec358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c6c358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a7994a8>]}
2018-02-07 15:32:34,541: Flushing usage events
2018-02-07 15:33:26,309: Tracking: tracking
2018-02-07 15:33:26,310: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10870a7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10870a668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10870aa20>]}
2018-02-07 15:33:27,040: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:33:27,057: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:33:27,059: Parsing core.sql
2018-02-07 15:33:27,075: Parsing adapters/bigquery.sql
2018-02-07 15:33:27,084: Parsing adapters/common.sql
2018-02-07 15:33:27,100: Parsing adapters/postgres.sql
2018-02-07 15:33:27,104: Parsing adapters/redshift.sql
2018-02-07 15:33:27,122: Parsing etc/get_custom_schema.sql
2018-02-07 15:33:27,127: Parsing materializations/archive.sql
2018-02-07 15:33:27,157: Parsing materializations/bigquery.sql
2018-02-07 15:33:27,170: Parsing materializations/helpers.sql
2018-02-07 15:33:27,185: Parsing materializations/incremental.sql
2018-02-07 15:33:27,217: Parsing materializations/table.sql
2018-02-07 15:33:27,235: Parsing materializations/view.sql
2018-02-07 15:33:27,249: Parsing materializations/wrapper.sql
2018-02-07 15:33:27,253: Parsing schema_tests/accepted_values.sql
2018-02-07 15:33:27,256: Parsing schema_tests/not_null.sql
2018-02-07 15:33:27,257: Parsing schema_tests/relationships.sql
2018-02-07 15:33:27,260: Parsing schema_tests/unique.sql
2018-02-07 15:33:27,267: Parsing model.seo_audit.accounts_proc
2018-02-07 15:33:27,270: Parsing model.seo_audit.all_dates
2018-02-07 15:33:27,271: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:33:27,273: Acquiring new bigquery connection "master".
2018-02-07 15:33:27,273: Opening a new connection (0 currently allocated)
2018-02-07 15:33:27,275: Parsing model.seo_audit.agg_all
2018-02-07 15:33:27,277: Parsing model.seo_audit.agg_indicative
2018-02-07 15:33:27,279: Parsing model.seo_audit.agg_stats
2018-02-07 15:33:27,284: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:33:27,287: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:33:27,290: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:33:27,293: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:33:27,294: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:33:27,296: Parsing model.seo_audit.ga_proc
2018-02-07 15:33:27,299: Parsing model.seo_audit.ga_stats
2018-02-07 15:33:27,300: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:33:27,303: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:33:27,305: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:33:27,307: Parsing model.seo_audit.moz_proc
2018-02-07 15:33:27,310: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:33:27,313: Parsing model.seo_audit.search_console_history
2018-02-07 15:33:27,314: Parsing model.seo_audit.search_console_proc
2018-02-07 15:33:27,317: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:33:27,320: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:33:27,322: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:33:27,324: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:33:27,327: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:33:27,330: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:33:27,332: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:33:27,334: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:33:27,336: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:33:27,349: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:33:27,367: 
2018-02-07 15:33:28,064: 15:33:28 | Concurrency: 4 threads (target='dev')
2018-02-07 15:33:28,064: 15:33:28 | 
2018-02-07 15:33:28,240: 15:33:28 | 1 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:33:28,241: Compiling model.seo_audit.all_dates
2018-02-07 15:33:28,241: 15:33:28 | 2 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:33:28,245: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:33:28,241: 15:33:28 | 3 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:33:28,246: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:33:28,245: Compiling model.seo_audit.accounts_proc
2018-02-07 15:33:28,250: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:33:28,256: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:33:28,257: Acquiring new bigquery connection "all_dates".
2018-02-07 15:33:28,257: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:33:28,258: Opening a new connection (1 currently allocated)
2018-02-07 15:33:28,258: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:33:28,260: Opening a new connection (2 currently allocated)
2018-02-07 15:33:28,314: Opening a new connection (3 currently allocated)
2018-02-07 15:33:28,818: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url, '?')[SAFE_ORDINAL(2)] as query_string,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:33:28,829: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:33:28,882: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:33:29,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088b0588>]}
2018-02-07 15:33:29,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088bfa58>]}
2018-02-07 15:33:29,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10884ff60>]}
2018-02-07 15:33:29,325: 15:33:29 | 2 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.79s]
2018-02-07 15:33:29,599: 15:33:29 | 1 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.82s]
2018-02-07 15:33:29,898: 15:33:29 | 3 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.83s]
2018-02-07 15:33:29,899: 15:33:29 | 4 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 15:33:29,900: 15:33:29 | 5 of 29 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-07 15:33:29,900: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:33:29,900: 15:33:29 | 6 of 29 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-07 15:33:29,901: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:33:29,900: 15:33:29 | 7 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 15:33:29,909: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:33:29,909: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:33:29,915: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:33:29,915: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:33:29,924: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:33:29,936: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:33:29,938: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:33:29,938: Re-using an available connection from the pool.
2018-02-07 15:33:29,940: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:33:29,940: Re-using an available connection from the pool.
2018-02-07 15:33:29,942: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:33:29,942: Re-using an available connection from the pool.
2018-02-07 15:33:29,944: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:33:29,948: Opening a new connection (4 currently allocated)
2018-02-07 15:33:30,209: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:33:30,211: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:33:30,250: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:33:30,474: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  path_count,
  first_path,
  second_last_path,
  last_path,
  query_string,
  split(last_path,'.')[SAFE_ORDINAL(2)] as filename,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:33:30,565: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883d588>]}
2018-02-07 15:33:30,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088bf6a0>]}
2018-02-07 15:33:30,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10884f748>]}
2018-02-07 15:33:30,802: 15:33:30 | 7 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.65s]
2018-02-07 15:33:30,806: 15:33:30 | 8 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 15:33:30,808: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:33:30,818: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:33:30,819: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:33:30,819: Re-using an available connection from the pool.
2018-02-07 15:33:30,824: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088b0828>]}
2018-02-07 15:33:31,026: 15:33:31 | 4 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.67s]
2018-02-07 15:33:31,026: 15:33:31 | 9 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 15:33:31,027: Compiling model.seo_audit.search_console_proc
2018-02-07 15:33:31,035: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:33:31,035: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:33:31,041: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:33:31,042: Re-using an available connection from the pool.
2018-02-07 15:33:31,237: 15:33:31 | 5 of 29 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.67s]
2018-02-07 15:33:31,237: 15:33:31 | 10 of 29 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-07 15:33:31,240: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:33:31,242: Compiling model.seo_audit.moz_proc
2018-02-07 15:33:31,253: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:33:31,255: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:33:31,256: Re-using an available connection from the pool.
2018-02-07 15:33:31,325: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e65c0>]}
2018-02-07 15:33:31,451: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:33:31,463: 15:33:31 | 6 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.92s]
2018-02-07 15:33:31,464: 15:33:31 | 11 of 29 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-07 15:33:31,465: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:33:31,474: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:33:31,476: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:33:31,476: Re-using an available connection from the pool.
2018-02-07 15:33:31,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088bf6a0>]}
2018-02-07 15:33:31,700: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:33:31,745: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10884f748>]}
2018-02-07 15:33:31,819: 15:33:31 | 8 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.52s]
2018-02-07 15:33:31,820: 15:33:31 | 12 of 29 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-07 15:33:31,820: Compiling model.seo_audit.ga_proc
2018-02-07 15:33:31,831: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:33:31,834: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:33:31,834: Re-using an available connection from the pool.
2018-02-07 15:33:32,009: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087edf98>]}
2018-02-07 15:33:32,026: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:33:32,126: 15:33:32 | 9 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.51s]
2018-02-07 15:33:32,128: 15:33:32 | 13 of 29 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-07 15:33:32,130: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:33:32,140: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:33:32,141: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:33:32,141: Re-using an available connection from the pool.
2018-02-07 15:33:32,313: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d8320>]}
2018-02-07 15:33:32,377: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:33:32,444: 15:33:32 | 10 of 29 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.50s]
2018-02-07 15:33:32,688: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6b38>]}
2018-02-07 15:33:32,731: 15:33:32 | 11 of 29 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.54s]
2018-02-07 15:33:33,036: 15:33:33 | 12 of 29 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.49s]
2018-02-07 15:33:33,333: 15:33:33 | 13 of 29 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.56s]
2018-02-07 15:33:33,334: 15:33:33 | 14 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:33:33,336: Compiling model.seo_audit.search_console_history
2018-02-07 15:33:33,335: 15:33:33 | 15 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:33:33,345: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:33:33,335: 15:33:33 | 16 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:33:33,335: 15:33:33 | 17 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:33:33,346: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:33:33,346: Compiling model.seo_audit.ga_stats
2018-02-07 15:33:33,347: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:33:33,360: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:33:33,363: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:33:33,380: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:33:33,380: Re-using an available connection from the pool.
2018-02-07 15:33:33,363: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:33:33,384: Re-using an available connection from the pool.
2018-02-07 15:33:33,378: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:33:33,372: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:33:33,389: Re-using an available connection from the pool.
2018-02-07 15:33:33,394: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:33:33,397: Re-using an available connection from the pool.
2018-02-07 15:33:33,628: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:33:33,629: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:33:33,643: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:33:33,660: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:33:34,071: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d84a8>]}
2018-02-07 15:33:34,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6470>]}
2018-02-07 15:33:34,119: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ab6a0>]}
2018-02-07 15:33:34,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6dd8>]}
2018-02-07 15:33:34,287: 15:33:34 | 14 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.73s]
2018-02-07 15:33:34,288: 15:33:34 | 18 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:33:34,290: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:33:34,301: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:33:34,303: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:33:34,303: Re-using an available connection from the pool.
2018-02-07 15:33:34,529: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:33:34,617: 15:33:34 | 15 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.76s]
2018-02-07 15:33:34,852: 15:33:34 | 17 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.77s]
2018-02-07 15:33:34,879: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10884f748>]}
2018-02-07 15:33:35,147: 15:33:35 | 16 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.81s]
2018-02-07 15:33:35,357: 15:33:35 | 18 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.59s]
2018-02-07 15:33:35,357: 15:33:35 | 19 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:33:35,358: 15:33:35 | 20 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:33:35,358: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:33:35,358: 15:33:35 | 21 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 15:33:35,359: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:33:35,365: Compiling model.seo_audit.deepcrawl_class
2018-02-07 15:33:35,367: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:33:35,379: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:33:35,379: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 15:33:35,381: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:33:35,381: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:33:35,381: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 15:33:35,382: Re-using an available connection from the pool.
2018-02-07 15:33:35,382: Re-using an available connection from the pool.
2018-02-07 15:33:35,383: Re-using an available connection from the pool.
2018-02-07 15:33:35,582: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 15:33:35,597: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:33:35,608: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:33:35,966: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6470>]}
2018-02-07 15:33:35,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e64e0>]}
2018-02-07 15:33:36,026: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d8470>]}
2018-02-07 15:33:36,277: 15:33:36 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.61s]
2018-02-07 15:33:36,590: 15:33:36 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.61s]
2018-02-07 15:33:36,883: 15:33:36 | 21 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.66s]
2018-02-07 15:33:36,884: 15:33:36 | 22 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:33:36,885: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:33:36,884: 15:33:36 | 23 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:33:36,894: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:33:36,885: 15:33:36 | 24 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:33:36,885: 15:33:36 | 25 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 15:33:36,895: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:33:36,895: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:33:36,895: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:33:36,901: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:33:36,902: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:33:36,907: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:33:36,912: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 15:33:36,912: Re-using an available connection from the pool.
2018-02-07 15:33:36,913: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:33:36,914: Re-using an available connection from the pool.
2018-02-07 15:33:36,915: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 15:33:36,916: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:33:36,916: Re-using an available connection from the pool.
2018-02-07 15:33:36,936: Re-using an available connection from the pool.
2018-02-07 15:33:37,029: Model SQL (deepcrawl_classification_stats):
SELECT
first_path,
filename,
query_string,
classification,
count,
sum(count) OVER (PARTITION BY classification) total_classified,
count/sum(count) OVER (PARTITION BY classification) as pct_classified
FROM 
(

	SELECT
	first_path,
	filename,
	query_string,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, filename, query_String, classification
)
2018-02-07 15:33:37,120: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:33:37,123: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:33:37,157: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:33:37,384: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d8b00>]}
2018-02-07 15:33:37,437: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10884f748>]}
2018-02-07 15:33:37,524: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d8470>]}
2018-02-07 15:33:37,528: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10880c668>]}
2018-02-07 15:33:37,616: 15:33:37 | 25 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.49s]
2018-02-07 15:33:37,833: 15:33:37 | 22 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.55s]
2018-02-07 15:33:38,057: 15:33:38 | 24 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.63s]
2018-02-07 15:33:38,350: 15:33:38 | 23 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.63s]
2018-02-07 15:33:38,350: 15:33:38 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 15:33:38,351: Compiling model.seo_audit.agg_indicative
2018-02-07 15:33:38,357: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 15:33:38,358: Acquiring new bigquery connection "agg_indicative".
2018-02-07 15:33:38,359: Re-using an available connection from the pool.
2018-02-07 15:33:38,563: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 15:33:39,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108841208>]}
2018-02-07 15:33:39,334: 15:33:39 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.71s]
2018-02-07 15:33:39,335: 15:33:39 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:33:39,335: Compiling model.seo_audit.agg_stats
2018-02-07 15:33:39,344: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:33:39,345: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:33:39,345: Re-using an available connection from the pool.
2018-02-07 15:33:39,695: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:33:40,415: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6470>]}
2018-02-07 15:33:40,800: 15:33:40 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 1.08s]
2018-02-07 15:33:40,801: 15:33:40 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:33:40,802: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:33:40,811: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:33:40,812: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:33:40,812: Re-using an available connection from the pool.
2018-02-07 15:33:41,025: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:33:41,700: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108841208>]}
2018-02-07 15:33:42,032: 15:33:42 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.90s]
2018-02-07 15:33:42,033: 15:33:42 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 15:33:42,033: Compiling model.seo_audit.agg_all
2018-02-07 15:33:42,042: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 15:33:42,043: Acquiring new bigquery connection "agg_all".
2018-02-07 15:33:42,043: Re-using an available connection from the pool.
2018-02-07 15:33:42,242: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 15:33:43,247: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f8e0cb37-6d4c-40c9-8977-01d82a180ecc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088e6470>]}
2018-02-07 15:33:43,492: 15:33:43 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.21s]
2018-02-07 15:33:43,536: 15:33:43 | 
2018-02-07 15:33:43,536: 15:33:43 | Finished running 29 view models in 15.47s.
2018-02-07 15:33:43,536: Connection 'master' was left open.
2018-02-07 15:33:43,537: 
2018-02-07 15:33:43,537: Completed successfully
2018-02-07 15:33:43,537: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 15:33:43,538: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d9748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d98d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d9780>]}
2018-02-07 15:33:43,748: Flushing usage events
2018-02-07 15:44:37,379: Tracking: tracking
2018-02-07 15:44:37,382: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fed30f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fed38d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fed3a58>]}
2018-02-07 15:44:38,220: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:44:38,239: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:44:38,243: Parsing core.sql
2018-02-07 15:44:38,268: Parsing adapters/bigquery.sql
2018-02-07 15:44:38,277: Parsing adapters/common.sql
2018-02-07 15:44:38,297: Parsing adapters/postgres.sql
2018-02-07 15:44:38,303: Parsing adapters/redshift.sql
2018-02-07 15:44:38,323: Parsing etc/get_custom_schema.sql
2018-02-07 15:44:38,330: Parsing materializations/archive.sql
2018-02-07 15:44:38,367: Parsing materializations/bigquery.sql
2018-02-07 15:44:38,384: Parsing materializations/helpers.sql
2018-02-07 15:44:38,402: Parsing materializations/incremental.sql
2018-02-07 15:44:38,449: Parsing materializations/table.sql
2018-02-07 15:44:38,480: Parsing materializations/view.sql
2018-02-07 15:44:38,581: Parsing materializations/wrapper.sql
2018-02-07 15:44:38,590: Parsing schema_tests/accepted_values.sql
2018-02-07 15:44:38,604: Parsing schema_tests/not_null.sql
2018-02-07 15:44:38,622: Parsing schema_tests/relationships.sql
2018-02-07 15:44:38,632: Parsing schema_tests/unique.sql
2018-02-07 15:44:38,691: Parsing model.seo_audit.accounts_proc
2018-02-07 15:44:38,694: Parsing model.seo_audit.all_dates
2018-02-07 15:44:38,695: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:44:38,698: Acquiring new bigquery connection "master".
2018-02-07 15:44:38,698: Opening a new connection (0 currently allocated)
2018-02-07 15:44:38,702: Parsing model.seo_audit.agg_all
2018-02-07 15:44:38,705: Parsing model.seo_audit.agg_indicative
2018-02-07 15:44:38,707: Parsing model.seo_audit.agg_stats
2018-02-07 15:44:38,713: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:44:38,718: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:44:38,722: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:44:38,728: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:44:38,730: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:44:38,732: Parsing model.seo_audit.ga_proc
2018-02-07 15:44:38,735: Parsing model.seo_audit.ga_stats
2018-02-07 15:44:38,739: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:44:38,743: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:44:38,746: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:44:38,748: Parsing model.seo_audit.moz_proc
2018-02-07 15:44:38,750: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:44:38,753: Parsing model.seo_audit.search_console_history
2018-02-07 15:44:38,755: Parsing model.seo_audit.search_console_proc
2018-02-07 15:44:38,758: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:44:38,760: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:44:38,762: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:44:38,765: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:44:38,767: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:44:38,770: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:44:38,772: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:44:38,774: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:44:38,776: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:44:38,788: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:44:38,796: 
2018-02-07 15:44:40,002: 15:44:40 | Concurrency: 4 threads (target='dev')
2018-02-07 15:44:40,003: 15:44:40 | 
2018-02-07 15:44:40,230: 15:44:40 | 1 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:44:40,230: Compiling model.seo_audit.all_dates
2018-02-07 15:44:40,230: 15:44:40 | 2 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:44:40,235: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:44:40,230: 15:44:40 | 3 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:44:40,236: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:44:40,236: Compiling model.seo_audit.accounts_proc
2018-02-07 15:44:40,241: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:44:40,247: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:44:40,250: Acquiring new bigquery connection "all_dates".
2018-02-07 15:44:40,250: Opening a new connection (1 currently allocated)
2018-02-07 15:44:40,252: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:44:40,253: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:44:40,309: Opening a new connection (2 currently allocated)
2018-02-07 15:44:40,319: Opening a new connection (3 currently allocated)
2018-02-07 15:44:40,853: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:44:40,895: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:44:40,900: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:44:41,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007e780>]}
2018-02-07 15:44:41,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100765f8>]}
2018-02-07 15:44:41,135: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110029d30>]}
2018-02-07 15:44:41,398: 15:44:41 | 1 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.87s]
2018-02-07 15:44:41,697: 15:44:41 | 3 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.87s]
2018-02-07 15:44:41,985: 15:44:41 | 2 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.90s]
2018-02-07 15:44:41,986: 15:44:41 | 4 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 15:44:41,987: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:44:41,986: 15:44:41 | 5 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 15:44:41,987: 15:44:41 | 6 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 15:44:41,987: 15:44:41 | 7 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 15:44:41,998: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:44:41,998: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:44:41,998: Compiling model.seo_audit.search_console_proc
2018-02-07 15:44:41,999: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:44:42,005: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:44:42,010: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:44:42,016: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:44:42,019: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:44:42,020: Re-using an available connection from the pool.
2018-02-07 15:44:42,021: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:44:42,022: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:44:42,023: Re-using an available connection from the pool.
2018-02-07 15:44:42,024: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:44:42,027: Re-using an available connection from the pool.
2018-02-07 15:44:42,029: Opening a new connection (4 currently allocated)
2018-02-07 15:44:42,327: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:44:42,371: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:44:42,374: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:44:42,589: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:44:42,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100aa6d8>]}
2018-02-07 15:44:42,686: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007ea20>]}
2018-02-07 15:44:42,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11000cc18>]}
2018-02-07 15:44:42,883: 15:44:42 | 7 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.68s]
2018-02-07 15:44:42,884: 15:44:42 | 8 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 15:44:42,884: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:44:42,895: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:44:42,900: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:44:42,901: Re-using an available connection from the pool.
2018-02-07 15:44:42,920: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110029470>]}
2018-02-07 15:44:43,116: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:44:43,192: 15:44:43 | 4 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.70s]
2018-02-07 15:44:43,193: 15:44:43 | 9 of 29 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-07 15:44:43,193: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:44:43,211: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:44:43,214: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:44:43,214: Re-using an available connection from the pool.
2018-02-07 15:44:43,433: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:44:43,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100aa6d8>]}
2018-02-07 15:44:43,529: 15:44:43 | 5 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.70s]
2018-02-07 15:44:43,531: 15:44:43 | 10 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 15:44:43,533: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:44:43,540: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:44:43,541: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:44:43,541: Re-using an available connection from the pool.
2018-02-07 15:44:43,738: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007ea20>]}
2018-02-07 15:44:43,753: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  second_last_path,
  last_path,
  query_string,
  split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url_trimmed, '?')[SAFE_ORDINAL(2)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:44:43,817: 15:44:43 | 6 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.92s]
2018-02-07 15:44:43,818: 15:44:43 | 11 of 29 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-07 15:44:43,820: Compiling model.seo_audit.moz_proc
2018-02-07 15:44:43,828: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:44:43,830: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:44:43,830: Re-using an available connection from the pool.
2018-02-07 15:44:43,987: Bad request while running:
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  second_last_path,
  last_path,
  query_string,
  split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url_trimmed, '?')[SAFE_ORDINAL(2)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:44:43,988: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: second_last_path at [64:3]
2018-02-07 15:44:43,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11009a1d0>]}
2018-02-07 15:44:44,031: 15:44:44 | 8 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.58s]
2018-02-07 15:44:44,032: 15:44:44 | 12 of 29 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-07 15:44:44,032: Compiling model.seo_audit.ga_proc
2018-02-07 15:44:44,042: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:44:44,046: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:44:44,047: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:44:44,047: Re-using an available connection from the pool.
2018-02-07 15:44:44,272: 15:44:44 | 9 of 29 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.54s]
2018-02-07 15:44:44,274: 15:44:44 | 13 of 29 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-07 15:44:44,276: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:44:44,285: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:44:44,290: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:44:44,294: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:44:44,295: Re-using an available connection from the pool.
2018-02-07 15:44:44,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa1f60>]}
2018-02-07 15:44:44,518: 15:44:44 | 10 of 29 ERROR creating view model seo_audit_dev.deepcrawl_class_proc [ERROR in 0.46s]
2018-02-07 15:44:44,558: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:44:44,561: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110029470>]}
2018-02-07 15:44:44,722: 15:44:44 | 11 of 29 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.53s]
2018-02-07 15:44:44,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffb7f28>]}
2018-02-07 15:44:45,007: 15:44:45 | 12 of 29 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.53s]
2018-02-07 15:44:45,293: 15:44:45 | 13 of 29 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.57s]
2018-02-07 15:44:45,295: 15:44:45 | 14 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:44:45,295: 15:44:45 | 15 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:44:45,296: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:44:45,295: 15:44:45 | 16 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:44:45,295: 15:44:45 | 17 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:44:45,296: Compiling model.seo_audit.search_console_history
2018-02-07 15:44:45,302: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:44:45,305: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:44:45,305: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:44:45,312: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:44:45,322: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:44:45,334: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:44:45,335: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:44:45,338: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:44:45,338: Re-using an available connection from the pool.
2018-02-07 15:44:45,339: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:44:45,340: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:44:45,340: Re-using an available connection from the pool.
2018-02-07 15:44:45,343: Re-using an available connection from the pool.
2018-02-07 15:44:45,344: Re-using an available connection from the pool.
2018-02-07 15:44:45,589: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:44:45,602: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:44:45,619: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:44:45,622: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:44:45,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffd4470>]}
2018-02-07 15:44:45,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11000c4a8>]}
2018-02-07 15:44:45,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11000ca58>]}
2018-02-07 15:44:45,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110009860>]}
2018-02-07 15:44:46,227: 15:44:46 | 14 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.69s]
2018-02-07 15:44:46,228: 15:44:46 | 18 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:44:46,230: Compiling model.seo_audit.ga_stats
2018-02-07 15:44:46,241: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:44:46,244: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:44:46,245: Re-using an available connection from the pool.
2018-02-07 15:44:46,495: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:44:46,510: 15:44:46 | 15 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.69s]
2018-02-07 15:44:46,752: 15:44:46 | 16 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.69s]
2018-02-07 15:44:46,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffd4470>]}
2018-02-07 15:44:47,035: 15:44:47 | 17 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.69s]
2018-02-07 15:44:47,244: 15:44:47 | 18 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.61s]
2018-02-07 15:44:47,244: 15:44:47 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:44:47,245: 15:44:47 | 20 of 29 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-07 15:44:47,245: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:44:47,245: 15:44:47 | 21 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:44:47,252: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:44:47,256: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:44:47,258: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:44:47,259: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:44:47,259: Re-using an available connection from the pool.
2018-02-07 15:44:47,261: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:44:47,261: Re-using an available connection from the pool.
2018-02-07 15:44:47,478: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:44:47,510: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:44:47,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110029470>]}
2018-02-07 15:44:47,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100b5128>]}
2018-02-07 15:44:48,215: 15:44:48 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.71s]
2018-02-07 15:44:48,508: 15:44:48 | 21 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.71s]
2018-02-07 15:44:48,509: 15:44:48 | 22 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:44:48,509: 15:44:48 | 23 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:44:48,509: 15:44:48 | 24 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:44:48,510: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:44:48,510: 15:44:48 | 25 of 29 SKIP relation seo_audit_dev.deepcrawl_classification_stats.. [SKIP]
2018-02-07 15:44:48,510: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:44:48,510: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:44:48,519: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:44:48,525: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:44:48,529: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:44:48,531: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:44:48,531: Re-using an available connection from the pool.
2018-02-07 15:44:48,532: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:44:48,533: Re-using an available connection from the pool.
2018-02-07 15:44:48,537: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:44:48,537: Re-using an available connection from the pool.
2018-02-07 15:44:48,750: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:44:48,755: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:44:48,783: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:44:49,165: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffd4470>]}
2018-02-07 15:44:49,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100ae748>]}
2018-02-07 15:44:49,176: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fffcbe0>]}
2018-02-07 15:44:49,391: 15:44:49 | 22 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.66s]
2018-02-07 15:44:49,588: 15:44:49 | 24 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.66s]
2018-02-07 15:44:49,815: 15:44:49 | 23 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.67s]
2018-02-07 15:44:49,816: 15:44:49 | 26 of 29 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-07 15:44:49,816: 15:44:49 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:44:49,817: Compiling model.seo_audit.agg_stats
2018-02-07 15:44:49,830: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:44:49,830: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:44:49,831: Re-using an available connection from the pool.
2018-02-07 15:44:50,067: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:44:57,266: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fffcbe0>]}
2018-02-07 15:44:57,513: 15:44:57 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 7.45s]
2018-02-07 15:44:57,514: 15:44:57 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:44:57,514: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:44:57,523: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:44:57,524: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:44:57,524: Re-using an available connection from the pool.
2018-02-07 15:44:57,770: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:44:58,415: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98dbc640-de9d-489d-88ee-3923cf1d103f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1100768d0>]}
2018-02-07 15:44:58,630: 15:44:58 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.90s]
2018-02-07 15:44:58,631: 15:44:58 | 29 of 29 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-07 15:44:58,681: 15:44:58 | 
2018-02-07 15:44:58,681: 15:44:58 | Finished running 29 view models in 18.68s.
2018-02-07 15:44:58,681: Connection 'master' was left open.
2018-02-07 15:44:58,682: 
2018-02-07 15:44:58,682: Completed with 1 errors:
2018-02-07 15:44:58,682: 
2018-02-07 15:44:58,682: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-07 15:44:58,682:   Unrecognized name: second_last_path at [64:3]
2018-02-07 15:44:58,682:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-07 15:44:58,683: 
Done. PASS=24 ERROR=1 SKIP=4 TOTAL=29
2018-02-07 15:44:58,683: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffd6358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa1828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa16d8>]}
2018-02-07 15:44:58,918: Flushing usage events
2018-02-07 15:45:48,444: Tracking: tracking
2018-02-07 15:45:48,446: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1497f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d149668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d149a20>]}
2018-02-07 15:45:49,226: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:45:49,253: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:45:49,258: Parsing core.sql
2018-02-07 15:45:49,281: Parsing adapters/bigquery.sql
2018-02-07 15:45:49,290: Parsing adapters/common.sql
2018-02-07 15:45:49,307: Parsing adapters/postgres.sql
2018-02-07 15:45:49,312: Parsing adapters/redshift.sql
2018-02-07 15:45:49,335: Parsing etc/get_custom_schema.sql
2018-02-07 15:45:49,343: Parsing materializations/archive.sql
2018-02-07 15:45:49,380: Parsing materializations/bigquery.sql
2018-02-07 15:45:49,407: Parsing materializations/helpers.sql
2018-02-07 15:45:49,425: Parsing materializations/incremental.sql
2018-02-07 15:45:49,459: Parsing materializations/table.sql
2018-02-07 15:45:49,483: Parsing materializations/view.sql
2018-02-07 15:45:49,511: Parsing materializations/wrapper.sql
2018-02-07 15:45:49,517: Parsing schema_tests/accepted_values.sql
2018-02-07 15:45:49,526: Parsing schema_tests/not_null.sql
2018-02-07 15:45:49,531: Parsing schema_tests/relationships.sql
2018-02-07 15:45:49,539: Parsing schema_tests/unique.sql
2018-02-07 15:45:49,584: Parsing model.seo_audit.accounts_proc
2018-02-07 15:45:49,587: Parsing model.seo_audit.all_dates
2018-02-07 15:45:49,589: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:45:49,591: Acquiring new bigquery connection "master".
2018-02-07 15:45:49,591: Opening a new connection (0 currently allocated)
2018-02-07 15:45:49,595: Parsing model.seo_audit.agg_all
2018-02-07 15:45:49,598: Parsing model.seo_audit.agg_indicative
2018-02-07 15:45:49,601: Parsing model.seo_audit.agg_stats
2018-02-07 15:45:49,610: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:45:49,614: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:45:49,616: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:45:49,619: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:45:49,620: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:45:49,623: Parsing model.seo_audit.ga_proc
2018-02-07 15:45:49,625: Parsing model.seo_audit.ga_stats
2018-02-07 15:45:49,627: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:45:49,629: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:45:49,631: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:45:49,633: Parsing model.seo_audit.moz_proc
2018-02-07 15:45:49,635: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:45:49,639: Parsing model.seo_audit.search_console_history
2018-02-07 15:45:49,640: Parsing model.seo_audit.search_console_proc
2018-02-07 15:45:49,643: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:45:49,645: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:45:49,647: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:45:49,649: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:45:49,652: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:45:49,654: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:45:49,657: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:45:49,658: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:45:49,661: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:45:49,670: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:45:49,677: 
2018-02-07 15:45:50,451: 15:45:50 | Concurrency: 4 threads (target='dev')
2018-02-07 15:45:50,451: 15:45:50 | 
2018-02-07 15:45:50,641: 15:45:50 | 1 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:45:50,641: Compiling model.seo_audit.accounts_proc
2018-02-07 15:45:50,649: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:45:50,642: 15:45:50 | 2 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:45:50,650: Compiling model.seo_audit.all_dates
2018-02-07 15:45:50,657: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:45:50,642: 15:45:50 | 3 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:45:50,657: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:45:50,672: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:45:50,672: Opening a new connection (1 currently allocated)
2018-02-07 15:45:50,753: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:45:50,757: Acquiring new bigquery connection "all_dates".
2018-02-07 15:45:50,758: Opening a new connection (2 currently allocated)
2018-02-07 15:45:50,818: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:45:50,822: Opening a new connection (3 currently allocated)
2018-02-07 15:45:51,295: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:45:51,306: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:45:51,314: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:45:51,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2adcf8>]}
2018-02-07 15:45:51,521: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fc9e8>]}
2018-02-07 15:45:51,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fcc88>]}
2018-02-07 15:45:51,672: 15:45:51 | 2 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.82s]
2018-02-07 15:45:51,995: 15:45:51 | 1 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.88s]
2018-02-07 15:45:52,296: 15:45:52 | 3 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.88s]
2018-02-07 15:45:52,297: 15:45:52 | 4 of 29 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-07 15:45:52,298: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:45:52,297: 15:45:52 | 5 of 29 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-07 15:45:52,309: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:45:52,297: 15:45:52 | 6 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 15:45:52,309: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:45:52,298: 15:45:52 | 7 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 15:45:52,310: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:45:52,317: Compiling model.seo_audit.search_console_proc
2018-02-07 15:45:52,321: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:45:52,347: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:45:52,355: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:45:52,359: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:45:52,359: Re-using an available connection from the pool.
2018-02-07 15:45:52,363: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:45:52,364: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:45:52,364: Re-using an available connection from the pool.
2018-02-07 15:45:52,365: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:45:52,368: Re-using an available connection from the pool.
2018-02-07 15:45:52,369: Opening a new connection (4 currently allocated)
2018-02-07 15:45:52,464: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(url_trimmed, '?')[SAFE_ORDINAL(2)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:45:52,627: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:45:52,788: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fc630>]}
2018-02-07 15:45:52,892: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:45:52,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c5e48>]}
2018-02-07 15:45:52,916: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:45:53,000: 15:45:53 | 4 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.49s]
2018-02-07 15:45:53,001: 15:45:53 | 8 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 15:45:53,002: Compiling model.seo_audit.moz_proc
2018-02-07 15:45:53,013: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:45:53,021: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:45:53,021: Re-using an available connection from the pool.
2018-02-07 15:45:53,234: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2ad198>]}
2018-02-07 15:45:53,239: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:45:53,252: 15:45:53 | 6 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.60s]
2018-02-07 15:45:53,253: 15:45:53 | 9 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 15:45:53,254: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:45:53,265: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:45:53,268: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:45:53,268: Re-using an available connection from the pool.
2018-02-07 15:45:53,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:45:53,471: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:45:53,500: 15:45:53 | 7 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.92s]
2018-02-07 15:45:53,502: 15:45:53 | 10 of 29 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-07 15:45:53,503: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:45:53,513: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:45:53,516: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:45:53,517: Re-using an available connection from the pool.
2018-02-07 15:45:53,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fc630>]}
2018-02-07 15:45:53,746: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:45:53,756: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c5e48>]}
2018-02-07 15:45:53,791: 15:45:53 | 5 of 29 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.97s]
2018-02-07 15:45:53,792: 15:45:53 | 11 of 29 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-07 15:45:53,793: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:45:53,804: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:45:53,807: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:45:53,808: Re-using an available connection from the pool.
2018-02-07 15:45:54,018: 15:45:54 | 8 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.54s]
2018-02-07 15:45:54,020: 15:45:54 | 12 of 29 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-07 15:45:54,022: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:45:54,022: Compiling model.seo_audit.ga_proc
2018-02-07 15:45:54,034: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:45:54,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c1160>]}
2018-02-07 15:45:54,037: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:45:54,037: Re-using an available connection from the pool.
2018-02-07 15:45:54,260: 15:45:54 | 9 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.50s]
2018-02-07 15:45:54,261: 15:45:54 | 13 of 29 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-07 15:45:54,262: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:45:54,276: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:45:54,279: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:45:54,279: Re-using an available connection from the pool.
2018-02-07 15:45:54,282: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:45:54,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:45:54,526: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:45:54,533: 15:45:54 | 10 of 29 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.53s]
2018-02-07 15:45:54,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d22bf98>]}
2018-02-07 15:45:54,866: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c5e48>]}
2018-02-07 15:45:54,926: 15:45:54 | 11 of 29 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.62s]
2018-02-07 15:45:55,149: 15:45:55 | 12 of 29 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.64s]
2018-02-07 15:45:55,375: 15:45:55 | 13 of 29 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.60s]
2018-02-07 15:45:55,376: 15:45:55 | 14 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:45:55,377: 15:45:55 | 15 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:45:55,377: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:45:55,377: 15:45:55 | 16 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:45:55,378: 15:45:55 | 17 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:45:55,378: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:45:55,385: Compiling model.seo_audit.search_console_history
2018-02-07 15:45:55,386: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:45:55,386: Compiling model.seo_audit.ga_stats
2018-02-07 15:45:55,391: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:45:55,396: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:45:55,401: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:45:55,401: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:45:55,403: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:45:55,403: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:45:55,404: Re-using an available connection from the pool.
2018-02-07 15:45:55,404: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:45:55,405: Re-using an available connection from the pool.
2018-02-07 15:45:55,406: Re-using an available connection from the pool.
2018-02-07 15:45:55,407: Re-using an available connection from the pool.
2018-02-07 15:45:55,618: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:45:55,620: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:45:55,627: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:45:55,630: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:45:55,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:45:55,929: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d320b00>]}
2018-02-07 15:45:55,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d24eba8>]}
2018-02-07 15:45:56,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c5e48>]}
2018-02-07 15:45:56,193: 15:45:56 | 14 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.55s]
2018-02-07 15:45:56,194: 15:45:56 | 18 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:45:56,196: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:45:56,208: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:45:56,211: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:45:56,211: Re-using an available connection from the pool.
2018-02-07 15:45:56,444: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:45:56,493: 15:45:56 | 17 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.54s]
2018-02-07 15:45:56,712: 15:45:56 | 16 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.57s]
2018-02-07 15:45:56,743: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:45:56,981: 15:45:56 | 15 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.66s]
2018-02-07 15:45:57,291: 15:45:57 | 18 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.55s]
2018-02-07 15:45:57,292: 15:45:57 | 19 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 15:45:57,292: Compiling model.seo_audit.deepcrawl_class
2018-02-07 15:45:57,293: 15:45:57 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:45:57,298: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 15:45:57,298: 15:45:57 | 21 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:45:57,298: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:45:57,298: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:45:57,303: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:45:57,309: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:45:57,310: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:45:57,311: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 15:45:57,311: Re-using an available connection from the pool.
2018-02-07 15:45:57,312: Re-using an available connection from the pool.
2018-02-07 15:45:57,314: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:45:57,314: Re-using an available connection from the pool.
2018-02-07 15:45:57,505: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:45:57,523: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 15:45:57,535: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:45:57,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3201d0>]}
2018-02-07 15:45:57,879: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d356ba8>]}
2018-02-07 15:45:57,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2ca4e0>]}
2018-02-07 15:45:58,089: 15:45:58 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.58s]
2018-02-07 15:45:58,335: 15:45:58 | 21 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.58s]
2018-02-07 15:45:58,665: 15:45:58 | 19 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.60s]
2018-02-07 15:45:58,666: 15:45:58 | 22 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:45:58,666: 15:45:58 | 23 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:45:58,667: 15:45:58 | 24 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 15:45:58,667: 15:45:58 | 25 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:45:58,667: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:45:58,667: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:45:58,667: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:45:58,668: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:45:58,679: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:45:58,680: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:45:58,685: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 15:45:58,690: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:45:58,691: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 15:45:58,691: Re-using an available connection from the pool.
2018-02-07 15:45:58,692: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:45:58,693: Re-using an available connection from the pool.
2018-02-07 15:45:58,693: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:45:58,693: Re-using an available connection from the pool.
2018-02-07 15:45:58,695: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:45:58,700: Re-using an available connection from the pool.
2018-02-07 15:45:58,874: Model SQL (deepcrawl_classification_stats):
SELECT
first_path,
filename,
query_string,
classification,
count,
sum(count) OVER (PARTITION BY classification) total_classified,
count/sum(count) OVER (PARTITION BY classification) as pct_classified
FROM 
(

	SELECT
	first_path,
	filename,
	query_string,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, filename, query_String, classification
)
2018-02-07 15:45:58,891: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:45:58,912: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:45:58,916: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:45:59,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:45:59,282: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d327710>]}
2018-02-07 15:45:59,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d327b00>]}
2018-02-07 15:45:59,321: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2ad470>]}
2018-02-07 15:45:59,526: 15:45:59 | 22 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.60s]
2018-02-07 15:45:59,822: 15:45:59 | 24 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.61s]
2018-02-07 15:46:00,033: 15:46:00 | 25 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.65s]
2018-02-07 15:46:00,325: 15:46:00 | 23 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.65s]
2018-02-07 15:46:00,326: 15:46:00 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 15:46:00,326: Compiling model.seo_audit.agg_indicative
2018-02-07 15:46:00,331: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 15:46:00,332: Acquiring new bigquery connection "agg_indicative".
2018-02-07 15:46:00,333: Re-using an available connection from the pool.
2018-02-07 15:46:00,597: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 15:46:01,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2ca4e0>]}
2018-02-07 15:46:01,448: 15:46:01 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.92s]
2018-02-07 15:46:01,449: 15:46:01 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:46:01,449: Compiling model.seo_audit.agg_stats
2018-02-07 15:46:01,458: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:46:01,458: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:46:01,459: Re-using an available connection from the pool.
2018-02-07 15:46:01,667: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:46:02,364: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:46:02,655: 15:46:02 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.91s]
2018-02-07 15:46:02,656: 15:46:02 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:46:02,656: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:46:02,666: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:46:02,667: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:46:02,667: Re-using an available connection from the pool.
2018-02-07 15:46:02,905: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:46:03,501: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2ca4e0>]}
2018-02-07 15:46:03,731: 15:46:03 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.84s]
2018-02-07 15:46:03,734: 15:46:03 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 15:46:03,734: Compiling model.seo_audit.agg_all
2018-02-07 15:46:03,744: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 15:46:03,746: Acquiring new bigquery connection "agg_all".
2018-02-07 15:46:03,746: Re-using an available connection from the pool.
2018-02-07 15:46:03,944: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 15:46:04,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75b650ab-0fa0-451d-bc55-ac831999077e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d217b00>]}
2018-02-07 15:46:05,156: 15:46:05 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.18s]
2018-02-07 15:46:05,235: 15:46:05 | 
2018-02-07 15:46:05,236: 15:46:05 | Finished running 29 view models in 14.79s.
2018-02-07 15:46:05,236: Connection 'master' was left open.
2018-02-07 15:46:05,236: 
2018-02-07 15:46:05,236: Completed successfully
2018-02-07 15:46:05,237: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 15:46:05,238: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1bf400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fc278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2fcb00>]}
2018-02-07 15:46:05,530: Flushing usage events
2018-02-07 15:58:41,708: Tracking: tracking
2018-02-07 15:58:41,716: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cca7c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cca7e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cca7fd0>]}
2018-02-07 15:58:42,852: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 15:58:42,886: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 15:58:42,892: Parsing core.sql
2018-02-07 15:58:42,912: Parsing adapters/bigquery.sql
2018-02-07 15:58:42,921: Parsing adapters/common.sql
2018-02-07 15:58:42,952: Parsing adapters/postgres.sql
2018-02-07 15:58:42,959: Parsing adapters/redshift.sql
2018-02-07 15:58:43,004: Parsing etc/get_custom_schema.sql
2018-02-07 15:58:43,016: Parsing materializations/archive.sql
2018-02-07 15:58:43,092: Parsing materializations/bigquery.sql
2018-02-07 15:58:43,152: Parsing materializations/helpers.sql
2018-02-07 15:58:43,220: Parsing materializations/incremental.sql
2018-02-07 15:58:43,288: Parsing materializations/table.sql
2018-02-07 15:58:43,329: Parsing materializations/view.sql
2018-02-07 15:58:43,360: Parsing materializations/wrapper.sql
2018-02-07 15:58:43,370: Parsing schema_tests/accepted_values.sql
2018-02-07 15:58:43,378: Parsing schema_tests/not_null.sql
2018-02-07 15:58:43,382: Parsing schema_tests/relationships.sql
2018-02-07 15:58:43,387: Parsing schema_tests/unique.sql
2018-02-07 15:58:43,419: Parsing model.seo_audit.accounts_proc
2018-02-07 15:58:43,422: Parsing model.seo_audit.all_dates
2018-02-07 15:58:43,424: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 15:58:43,427: Acquiring new bigquery connection "master".
2018-02-07 15:58:43,428: Opening a new connection (0 currently allocated)
2018-02-07 15:58:43,434: Parsing model.seo_audit.agg_all
2018-02-07 15:58:43,438: Parsing model.seo_audit.agg_indicative
2018-02-07 15:58:43,442: Parsing model.seo_audit.agg_stats
2018-02-07 15:58:43,448: Parsing model.seo_audit.agg_stats_client
2018-02-07 15:58:43,451: Parsing model.seo_audit.deepcrawl_class
2018-02-07 15:58:43,455: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 15:58:43,458: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:58:43,462: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 15:58:43,464: Parsing model.seo_audit.ga_proc
2018-02-07 15:58:43,469: Parsing model.seo_audit.ga_stats
2018-02-07 15:58:43,472: Parsing model.seo_audit.majestic_domain_history
2018-02-07 15:58:43,475: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 15:58:43,478: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 15:58:43,481: Parsing model.seo_audit.moz_proc
2018-02-07 15:58:43,485: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 15:58:43,489: Parsing model.seo_audit.search_console_history
2018-02-07 15:58:43,491: Parsing model.seo_audit.search_console_proc
2018-02-07 15:58:43,496: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 15:58:43,501: Parsing model.seo_audit.search_console_stats_url
2018-02-07 15:58:43,504: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 15:58:43,510: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 15:58:43,513: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 15:58:43,518: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 15:58:43,522: Parsing model.seo_audit.semrush_url_history
2018-02-07 15:58:43,525: Parsing model.seo_audit.semrush_url_stats
2018-02-07 15:58:43,528: Parsing model.seo_audit.sitemap_proc
2018-02-07 15:58:43,543: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 15:58:43,555: 
2018-02-07 15:58:44,845: 15:58:44 | Concurrency: 4 threads (target='dev')
2018-02-07 15:58:44,845: 15:58:44 | 
2018-02-07 15:58:45,044: 15:58:45 | 1 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 15:58:45,045: 15:58:45 | 2 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 15:58:45,045: Compiling model.seo_audit.accounts_proc
2018-02-07 15:58:45,045: 15:58:45 | 3 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 15:58:45,045: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 15:58:45,052: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 15:58:45,052: Compiling model.seo_audit.all_dates
2018-02-07 15:58:45,058: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 15:58:45,063: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 15:58:45,066: Acquiring new bigquery connection "accounts_proc".
2018-02-07 15:58:45,066: Opening a new connection (1 currently allocated)
2018-02-07 15:58:45,067: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 15:58:45,067: Acquiring new bigquery connection "all_dates".
2018-02-07 15:58:45,069: Opening a new connection (2 currently allocated)
2018-02-07 15:58:45,127: Opening a new connection (3 currently allocated)
2018-02-07 15:58:45,684: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 15:58:45,689: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 15:58:45,722: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 15:58:45,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfb38>]}
2018-02-07 15:58:45,938: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce52dd8>]}
2018-02-07 15:58:45,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce529e8>]}
2018-02-07 15:58:46,266: 15:58:46 | 3 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.88s]
2018-02-07 15:58:46,484: 15:58:46 | 2 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.89s]
2018-02-07 15:58:46,840: 15:58:46 | 1 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.90s]
2018-02-07 15:58:46,841: 15:58:46 | 4 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 15:58:46,841: Compiling model.seo_audit.moz_proc
2018-02-07 15:58:46,841: 15:58:46 | 5 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 15:58:46,850: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 15:58:46,850: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 15:58:46,841: 15:58:46 | 6 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 15:58:46,841: 15:58:46 | 7 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 15:58:46,865: Compiling model.seo_audit.ga_proc
2018-02-07 15:58:46,862: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 15:58:46,864: Acquiring new bigquery connection "moz_proc".
2018-02-07 15:58:46,901: Re-using an available connection from the pool.
2018-02-07 15:58:46,863: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 15:58:46,909: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 15:58:46,911: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 15:58:46,880: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 15:58:46,914: Re-using an available connection from the pool.
2018-02-07 15:58:46,919: Acquiring new bigquery connection "ga_proc".
2018-02-07 15:58:46,925: Re-using an available connection from the pool.
2018-02-07 15:58:46,920: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 15:58:46,928: Opening a new connection (4 currently allocated)
2018-02-07 15:58:47,189: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:58:47,202: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 15:58:47,209: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 15:58:47,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfb38>]}
2018-02-07 15:58:47,517: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce52470>]}
2018-02-07 15:58:47,534: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce52908>]}
2018-02-07 15:58:47,626: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 15:58:47,887: 15:58:47 | 7 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.65s]
2018-02-07 15:58:47,888: 15:58:47 | 8 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 15:58:47,891: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 15:58:47,908: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 15:58:47,910: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 15:58:47,910: Re-using an available connection from the pool.
2018-02-07 15:58:47,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce66668>]}
2018-02-07 15:58:48,119: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 15:58:48,165: 15:58:48 | 5 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.67s]
2018-02-07 15:58:48,166: 15:58:48 | 9 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 15:58:48,167: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 15:58:48,184: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 15:58:48,188: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 15:58:48,188: Re-using an available connection from the pool.
2018-02-07 15:58:48,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdcb588>]}
2018-02-07 15:58:48,435: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:58:48,489: 15:58:48 | 4 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.69s]
2018-02-07 15:58:48,489: 15:58:48 | 10 of 29 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-07 15:58:48,490: Compiling model.seo_audit.sitemap_proc
2018-02-07 15:58:48,497: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 15:58:48,500: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 15:58:48,501: Re-using an available connection from the pool.
2018-02-07 15:58:48,685: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 15:58:48,728: 15:58:48 | 6 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 1.11s]
2018-02-07 15:58:48,731: 15:58:48 | 11 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 15:58:48,732: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 15:58:48,748: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 15:58:48,753: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 15:58:48,753: Re-using an available connection from the pool.
2018-02-07 15:58:48,787: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce52470>]}
2018-02-07 15:58:48,950: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 15:58:48,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cebf748>]}
2018-02-07 15:58:48,982: 15:58:48 | 8 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.49s]
2018-02-07 15:58:48,992: 15:58:48 | 12 of 29 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-07 15:58:48,993: Compiling model.seo_audit.search_console_proc
2018-02-07 15:58:49,006: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 15:58:49,010: Acquiring new bigquery connection "search_console_proc".
2018-02-07 15:58:49,010: Re-using an available connection from the pool.
2018-02-07 15:58:49,220: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 15:58:49,230: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce66668>]}
2018-02-07 15:58:49,271: 15:58:49 | 9 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.62s]
2018-02-07 15:58:49,275: 15:58:49 | 13 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 15:58:49,278: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 15:58:49,297: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 15:58:49,302: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 15:58:49,303: Re-using an available connection from the pool.
2018-02-07 15:58:49,524: 15:58:49 | 10 of 29 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.47s]
2018-02-07 15:58:49,786: 15:58:49 | 11 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.50s]
2018-02-07 15:58:49,839: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd769b0>]}
2018-02-07 15:58:49,886: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 15:58:50,056: 15:58:50 | 12 of 29 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.85s]
2018-02-07 15:58:50,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdff160>]}
2018-02-07 15:58:50,587: 15:58:50 | 13 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.93s]
2018-02-07 15:58:50,588: 15:58:50 | 14 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 15:58:50,588: 15:58:50 | 15 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 15:58:50,589: Compiling model.seo_audit.ga_stats
2018-02-07 15:58:50,588: 15:58:50 | 16 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 15:58:50,589: Compiling model.seo_audit.semrush_url_history
2018-02-07 15:58:50,588: 15:58:50 | 17 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 15:58:50,604: Compiling model.seo_audit.majestic_domain_history
2018-02-07 15:58:50,598: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 15:58:50,615: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 15:58:50,598: Compiling model.seo_audit.search_console_history
2018-02-07 15:58:50,620: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 15:58:50,623: Acquiring new bigquery connection "ga_stats".
2018-02-07 15:58:50,635: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 15:58:50,640: Re-using an available connection from the pool.
2018-02-07 15:58:50,639: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 15:58:50,637: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 15:58:50,641: Acquiring new bigquery connection "search_console_history".
2018-02-07 15:58:50,643: Re-using an available connection from the pool.
2018-02-07 15:58:50,646: Re-using an available connection from the pool.
2018-02-07 15:58:50,653: Re-using an available connection from the pool.
2018-02-07 15:58:50,858: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 15:58:50,861: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 15:58:50,877: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 15:58:50,908: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 15:58:51,171: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfda0>]}
2018-02-07 15:58:51,178: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce66f28>]}
2018-02-07 15:58:51,200: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdedf98>]}
2018-02-07 15:58:51,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce8c748>]}
2018-02-07 15:58:51,407: 15:58:51 | 17 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-07 15:58:51,409: 15:58:51 | 18 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 15:58:51,409: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 15:58:51,423: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 15:58:51,431: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 15:58:51,431: Re-using an available connection from the pool.
2018-02-07 15:58:51,649: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 15:58:51,670: 15:58:51 | 15 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.59s]
2018-02-07 15:58:51,913: 15:58:51 | 14 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.61s]
2018-02-07 15:58:52,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfda0>]}
2018-02-07 15:58:52,129: 15:58:52 | 16 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.63s]
2018-02-07 15:58:52,385: 15:58:52 | 18 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.60s]
2018-02-07 15:58:52,385: 15:58:52 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 15:58:52,386: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 15:58:52,385: 15:58:52 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 15:58:52,386: 15:58:52 | 21 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 15:58:52,392: Compiling model.seo_audit.search_console_stats_url
2018-02-07 15:58:52,395: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 15:58:52,395: Compiling model.seo_audit.deepcrawl_class
2018-02-07 15:58:52,401: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 15:58:52,411: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 15:58:52,412: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 15:58:52,412: Re-using an available connection from the pool.
2018-02-07 15:58:52,415: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 15:58:52,417: Re-using an available connection from the pool.
2018-02-07 15:58:52,420: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 15:58:52,421: Re-using an available connection from the pool.
2018-02-07 15:58:52,625: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 15:58:52,643: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 15:58:52,645: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 15:58:52,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdac6a0>]}
2018-02-07 15:58:53,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceabf28>]}
2018-02-07 15:58:53,034: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfb38>]}
2018-02-07 15:58:53,223: 15:58:53 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.55s]
2018-02-07 15:58:53,441: 15:58:53 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.62s]
2018-02-07 15:58:53,739: 15:58:53 | 21 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.64s]
2018-02-07 15:58:53,740: 15:58:53 | 22 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 15:58:53,740: 15:58:53 | 23 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 15:58:53,740: 15:58:53 | 24 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 15:58:53,740: 15:58:53 | 25 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 15:58:53,741: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 15:58:53,741: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 15:58:53,741: Compiling model.seo_audit.semrush_url_stats
2018-02-07 15:58:53,741: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 15:58:53,746: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 15:58:53,756: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 15:58:53,763: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 15:58:53,770: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 15:58:53,771: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 15:58:53,772: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 15:58:53,773: Re-using an available connection from the pool.
2018-02-07 15:58:53,773: Re-using an available connection from the pool.
2018-02-07 15:58:53,775: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 15:58:53,775: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 15:58:53,776: Re-using an available connection from the pool.
2018-02-07 15:58:53,780: Re-using an available connection from the pool.
2018-02-07 15:58:53,970: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_classified
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-07 15:58:53,974: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:58:53,982: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 15:58:53,992: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 15:58:54,338: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce668d0>]}
2018-02-07 15:58:54,350: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce77b38>]}
2018-02-07 15:58:54,368: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdac6a0>]}
2018-02-07 15:58:54,488: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cda9400>]}
2018-02-07 15:58:54,595: 15:58:54 | 24 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.60s]
2018-02-07 15:58:54,836: 15:58:54 | 25 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.61s]
2018-02-07 15:58:55,097: 15:58:55 | 23 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.63s]
2018-02-07 15:58:55,339: 15:58:55 | 22 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.75s]
2018-02-07 15:58:55,340: 15:58:55 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 15:58:55,340: Compiling model.seo_audit.agg_indicative
2018-02-07 15:58:55,349: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 15:58:55,351: Acquiring new bigquery connection "agg_indicative".
2018-02-07 15:58:55,351: Re-using an available connection from the pool.
2018-02-07 15:58:55,552: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 15:58:55,963: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddfb38>]}
2018-02-07 15:58:56,211: 15:58:56 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.62s]
2018-02-07 15:58:56,212: 15:58:56 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 15:58:56,213: Compiling model.seo_audit.agg_stats
2018-02-07 15:58:56,226: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 15:58:56,226: Acquiring new bigquery connection "agg_stats".
2018-02-07 15:58:56,227: Re-using an available connection from the pool.
2018-02-07 15:58:56,424: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 15:58:57,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cda9400>]}
2018-02-07 15:58:58,109: 15:58:58 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-07 15:58:58,110: 15:58:58 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 15:58:58,111: Compiling model.seo_audit.agg_stats_client
2018-02-07 15:58:58,121: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 15:58:58,121: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 15:58:58,122: Re-using an available connection from the pool.
2018-02-07 15:58:58,335: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 15:58:58,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdffcf8>]}
2018-02-07 15:58:59,343: 15:58:59 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.88s]
2018-02-07 15:58:59,343: 15:58:59 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 15:58:59,344: Compiling model.seo_audit.agg_all
2018-02-07 15:58:59,353: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 15:58:59,356: Acquiring new bigquery connection "agg_all".
2018-02-07 15:58:59,356: Re-using an available connection from the pool.
2018-02-07 15:58:59,542: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 15:59:00,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7747451b-0f55-47f2-8b48-2c3a18406439', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cda9400>]}
2018-02-07 15:59:00,646: 15:59:00 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.02s]
2018-02-07 15:59:00,756: 15:59:00 | 
2018-02-07 15:59:00,756: 15:59:00 | Finished running 29 view models in 15.91s.
2018-02-07 15:59:00,757: Connection 'master' was left open.
2018-02-07 15:59:00,757: 
2018-02-07 15:59:00,757: Completed successfully
2018-02-07 15:59:00,758: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 15:59:00,758: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdac2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd76518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd765f8>]}
2018-02-07 15:59:01,308: Flushing usage events
2018-02-07 16:04:03,727: Tracking: tracking
2018-02-07 16:04:03,730: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111672c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111672e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111672fd0>]}
2018-02-07 16:04:04,391: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 16:04:04,407: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 16:04:04,412: Parsing core.sql
2018-02-07 16:04:04,439: Parsing adapters/bigquery.sql
2018-02-07 16:04:04,449: Parsing adapters/common.sql
2018-02-07 16:04:04,469: Parsing adapters/postgres.sql
2018-02-07 16:04:04,473: Parsing adapters/redshift.sql
2018-02-07 16:04:04,515: Parsing etc/get_custom_schema.sql
2018-02-07 16:04:04,528: Parsing materializations/archive.sql
2018-02-07 16:04:04,592: Parsing materializations/bigquery.sql
2018-02-07 16:04:04,630: Parsing materializations/helpers.sql
2018-02-07 16:04:04,661: Parsing materializations/incremental.sql
2018-02-07 16:04:04,726: Parsing materializations/table.sql
2018-02-07 16:04:04,761: Parsing materializations/view.sql
2018-02-07 16:04:04,791: Parsing materializations/wrapper.sql
2018-02-07 16:04:04,799: Parsing schema_tests/accepted_values.sql
2018-02-07 16:04:04,805: Parsing schema_tests/not_null.sql
2018-02-07 16:04:04,810: Parsing schema_tests/relationships.sql
2018-02-07 16:04:04,816: Parsing schema_tests/unique.sql
2018-02-07 16:04:04,880: Parsing model.seo_audit.accounts_proc
2018-02-07 16:04:04,883: Parsing model.seo_audit.all_dates
2018-02-07 16:04:04,885: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 16:04:04,888: Acquiring new bigquery connection "master".
2018-02-07 16:04:04,888: Opening a new connection (0 currently allocated)
2018-02-07 16:04:04,900: Parsing model.seo_audit.agg_all
2018-02-07 16:04:04,906: Parsing model.seo_audit.agg_indicative
2018-02-07 16:04:04,910: Parsing model.seo_audit.agg_stats
2018-02-07 16:04:04,917: Parsing model.seo_audit.agg_stats_client
2018-02-07 16:04:04,923: Parsing model.seo_audit.deepcrawl_class
2018-02-07 16:04:04,926: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 16:04:04,933: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:04:04,935: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 16:04:04,938: Parsing model.seo_audit.ga_proc
2018-02-07 16:04:04,943: Parsing model.seo_audit.ga_stats
2018-02-07 16:04:04,946: Parsing model.seo_audit.majestic_domain_history
2018-02-07 16:04:04,949: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 16:04:04,954: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 16:04:04,958: Parsing model.seo_audit.moz_proc
2018-02-07 16:04:04,964: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 16:04:04,968: Parsing model.seo_audit.search_console_history
2018-02-07 16:04:04,970: Parsing model.seo_audit.search_console_proc
2018-02-07 16:04:04,973: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 16:04:04,979: Parsing model.seo_audit.search_console_stats_url
2018-02-07 16:04:04,984: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 16:04:04,988: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 16:04:04,992: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 16:04:04,999: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 16:04:05,002: Parsing model.seo_audit.semrush_url_history
2018-02-07 16:04:05,004: Parsing model.seo_audit.semrush_url_stats
2018-02-07 16:04:05,006: Parsing model.seo_audit.sitemap_proc
2018-02-07 16:04:05,023: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 16:04:05,059: 
2018-02-07 16:04:06,336: 16:04:06 | Concurrency: 4 threads (target='dev')
2018-02-07 16:04:06,336: 16:04:06 | 
2018-02-07 16:04:06,615: 16:04:06 | 1 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 16:04:06,616: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 16:04:06,615: 16:04:06 | 2 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 16:04:06,626: Compiling model.seo_audit.all_dates
2018-02-07 16:04:06,625: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 16:04:06,615: 16:04:06 | 3 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 16:04:06,634: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 16:04:06,634: Compiling model.seo_audit.accounts_proc
2018-02-07 16:04:06,645: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 16:04:06,646: Acquiring new bigquery connection "all_dates".
2018-02-07 16:04:06,646: Opening a new connection (1 currently allocated)
2018-02-07 16:04:06,647: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 16:04:06,648: Acquiring new bigquery connection "accounts_proc".
2018-02-07 16:04:06,715: Opening a new connection (2 currently allocated)
2018-02-07 16:04:06,722: Opening a new connection (3 currently allocated)
2018-02-07 16:04:07,478: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 16:04:07,518: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 16:04:07,523: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 16:04:07,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117abc50>]}
2018-02-07 16:04:07,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117ab320>]}
2018-02-07 16:04:07,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111818f28>]}
2018-02-07 16:04:07,904: 16:04:07 | 2 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.04s]
2018-02-07 16:04:08,215: 16:04:08 | 3 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.09s]
2018-02-07 16:04:08,482: 16:04:08 | 1 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.25s]
2018-02-07 16:04:08,483: 16:04:08 | 4 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 16:04:08,484: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 16:04:08,483: 16:04:08 | 5 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 16:04:08,492: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 16:04:08,483: 16:04:08 | 6 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 16:04:08,492: Compiling model.seo_audit.moz_proc
2018-02-07 16:04:08,484: 16:04:08 | 7 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 16:04:08,493: Compiling model.seo_audit.search_console_proc
2018-02-07 16:04:08,500: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 16:04:08,501: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 16:04:08,507: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 16:04:08,537: Re-using an available connection from the pool.
2018-02-07 16:04:08,511: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 16:04:08,534: Acquiring new bigquery connection "moz_proc".
2018-02-07 16:04:08,546: Re-using an available connection from the pool.
2018-02-07 16:04:08,537: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 16:04:08,554: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 16:04:08,554: Re-using an available connection from the pool.
2018-02-07 16:04:08,560: Acquiring new bigquery connection "search_console_proc".
2018-02-07 16:04:08,560: Opening a new connection (4 currently allocated)
2018-02-07 16:04:08,804: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:04:08,906: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 16:04:08,918: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:04:09,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111818f28>]}
2018-02-07 16:04:09,208: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111773a90>]}
2018-02-07 16:04:09,218: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11182f358>]}
2018-02-07 16:04:09,222: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:04:09,343: 16:04:09 | 5 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.58s]
2018-02-07 16:04:09,343: 16:04:09 | 8 of 29 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-07 16:04:09,344: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 16:04:09,354: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 16:04:09,359: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 16:04:09,360: Re-using an available connection from the pool.
2018-02-07 16:04:09,575: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11179f400>]}
2018-02-07 16:04:09,577: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 16:04:09,591: 16:04:09 | 4 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.72s]
2018-02-07 16:04:09,593: 16:04:09 | 9 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 16:04:09,593: Compiling model.seo_audit.ga_proc
2018-02-07 16:04:09,606: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 16:04:09,609: Acquiring new bigquery connection "ga_proc".
2018-02-07 16:04:09,614: Re-using an available connection from the pool.
2018-02-07 16:04:09,853: 16:04:09 | 7 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.72s]
2018-02-07 16:04:09,858: 16:04:09 | 10 of 29 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-07 16:04:09,861: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 16:04:09,888: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 16:04:09,889: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 16:04:09,889: Re-using an available connection from the pool.
2018-02-07 16:04:09,907: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 16:04:09,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111818f28>]}
2018-02-07 16:04:10,115: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:04:10,149: 16:04:10 | 6 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 1.08s]
2018-02-07 16:04:10,153: 16:04:10 | 11 of 29 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-07 16:04:10,155: Compiling model.seo_audit.sitemap_proc
2018-02-07 16:04:10,176: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 16:04:10,179: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111773a90>]}
2018-02-07 16:04:10,181: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 16:04:10,181: Re-using an available connection from the pool.
2018-02-07 16:04:10,386: 16:04:10 | 8 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.56s]
2018-02-07 16:04:10,399: 16:04:10 | 12 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 16:04:10,400: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 16:04:10,418: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 16:04:10,423: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 16:04:10,424: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 16:04:10,424: Re-using an available connection from the pool.
2018-02-07 16:04:10,480: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111848208>]}
2018-02-07 16:04:10,657: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 16:04:10,717: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11179f400>]}
2018-02-07 16:04:10,735: 16:04:10 | 9 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.59s]
2018-02-07 16:04:10,736: 16:04:10 | 13 of 29 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-07 16:04:10,736: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 16:04:10,752: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 16:04:10,760: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 16:04:10,760: Re-using an available connection from the pool.
2018-02-07 16:04:10,947: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117409e8>]}
2018-02-07 16:04:10,987: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 16:04:10,997: 16:04:10 | 10 of 29 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.62s]
2018-02-07 16:04:11,207: 16:04:11 | 11 of 29 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.56s]
2018-02-07 16:04:11,267: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111773a90>]}
2018-02-07 16:04:11,497: 16:04:11 | 12 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.55s]
2018-02-07 16:04:11,749: 16:04:11 | 13 of 29 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.53s]
2018-02-07 16:04:11,750: 16:04:11 | 14 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 16:04:11,751: Compiling model.seo_audit.majestic_domain_history
2018-02-07 16:04:11,758: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 16:04:11,756: 16:04:11 | 15 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 16:04:11,758: Compiling model.seo_audit.semrush_url_history
2018-02-07 16:04:11,757: 16:04:11 | 16 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 16:04:11,764: Compiling model.seo_audit.search_console_history
2018-02-07 16:04:11,757: 16:04:11 | 17 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 16:04:11,774: Compiling model.seo_audit.ga_stats
2018-02-07 16:04:11,768: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 16:04:11,806: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 16:04:11,810: Acquiring new bigquery connection "ga_stats".
2018-02-07 16:04:11,810: Re-using an available connection from the pool.
2018-02-07 16:04:11,816: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 16:04:11,819: Acquiring new bigquery connection "search_console_history".
2018-02-07 16:04:11,819: Re-using an available connection from the pool.
2018-02-07 16:04:11,774: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 16:04:11,835: Re-using an available connection from the pool.
2018-02-07 16:04:11,837: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 16:04:11,837: Re-using an available connection from the pool.
2018-02-07 16:04:12,036: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 16:04:12,045: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 16:04:12,062: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 16:04:12,080: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 16:04:12,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11182f588>]}
2018-02-07 16:04:12,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11179f518>]}
2018-02-07 16:04:12,468: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111850be0>]}
2018-02-07 16:04:12,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118287b8>]}
2018-02-07 16:04:12,767: 16:04:12 | 17 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.69s]
2018-02-07 16:04:12,767: 16:04:12 | 18 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 16:04:12,768: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 16:04:12,775: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 16:04:12,779: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 16:04:12,780: Re-using an available connection from the pool.
2018-02-07 16:04:12,977: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 16:04:12,987: 16:04:12 | 16 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.70s]
2018-02-07 16:04:13,294: 16:04:13 | 15 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.71s]
2018-02-07 16:04:13,317: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118186d8>]}
2018-02-07 16:04:13,500: 16:04:13 | 14 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.72s]
2018-02-07 16:04:13,798: 16:04:13 | 18 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.55s]
2018-02-07 16:04:13,799: 16:04:13 | 19 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 16:04:13,799: Compiling model.seo_audit.search_console_stats_url
2018-02-07 16:04:13,805: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 16:04:13,799: 16:04:13 | 20 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 16:04:13,799: 16:04:13 | 21 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 16:04:13,805: Compiling model.seo_audit.deepcrawl_class
2018-02-07 16:04:13,805: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 16:04:13,812: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 16:04:13,816: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 16:04:13,834: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 16:04:13,831: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 16:04:13,839: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 16:04:13,831: Re-using an available connection from the pool.
2018-02-07 16:04:13,852: Re-using an available connection from the pool.
2018-02-07 16:04:13,853: Re-using an available connection from the pool.
2018-02-07 16:04:14,072: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 16:04:14,078: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 16:04:14,092: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 16:04:14,357: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111828d30>]}
2018-02-07 16:04:14,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111776748>]}
2018-02-07 16:04:14,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117ab390>]}
2018-02-07 16:04:14,724: 16:04:14 | 21 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.55s]
2018-02-07 16:04:15,094: 16:04:15 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.64s]
2018-02-07 16:04:15,386: 16:04:15 | 20 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.66s]
2018-02-07 16:04:15,387: 16:04:15 | 22 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 16:04:15,387: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:04:15,397: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 16:04:15,395: 16:04:15 | 23 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 16:04:15,397: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 16:04:15,395: 16:04:15 | 24 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 16:04:15,395: 16:04:15 | 25 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 16:04:15,403: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 16:04:15,403: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 16:04:15,404: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 16:04:15,404: Compiling model.seo_audit.semrush_url_stats
2018-02-07 16:04:15,410: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 16:04:15,410: Re-using an available connection from the pool.
2018-02-07 16:04:15,421: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 16:04:15,425: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 16:04:15,429: Re-using an available connection from the pool.
2018-02-07 16:04:15,433: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 16:04:15,433: Re-using an available connection from the pool.
2018-02-07 16:04:15,444: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 16:04:15,444: Re-using an available connection from the pool.
2018-02-07 16:04:15,677: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_classified
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-07 16:04:15,682: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 16:04:15,708: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:04:15,727: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:04:16,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111818198>]}
2018-02-07 16:04:16,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111860ef0>]}
2018-02-07 16:04:16,081: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111850ac8>]}
2018-02-07 16:04:16,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117ab7b8>]}
2018-02-07 16:04:16,267: 16:04:16 | 23 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.64s]
2018-02-07 16:04:16,593: 16:04:16 | 25 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.67s]
2018-02-07 16:04:16,802: 16:04:16 | 24 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.68s]
2018-02-07 16:04:17,114: 16:04:17 | 22 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.79s]
2018-02-07 16:04:17,115: 16:04:17 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 16:04:17,115: Compiling model.seo_audit.agg_indicative
2018-02-07 16:04:17,121: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 16:04:17,122: Acquiring new bigquery connection "agg_indicative".
2018-02-07 16:04:17,122: Re-using an available connection from the pool.
2018-02-07 16:04:17,323: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 16:04:17,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117ab390>]}
2018-02-07 16:04:17,932: 16:04:17 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.58s]
2018-02-07 16:04:17,933: 16:04:17 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 16:04:17,933: Compiling model.seo_audit.agg_stats
2018-02-07 16:04:17,950: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 16:04:17,951: Acquiring new bigquery connection "agg_stats".
2018-02-07 16:04:17,952: Re-using an available connection from the pool.
2018-02-07 16:04:18,147: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 16:04:18,707: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117b1438>]}
2018-02-07 16:04:18,989: 16:04:18 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.77s]
2018-02-07 16:04:18,990: 16:04:18 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 16:04:18,990: Compiling model.seo_audit.agg_stats_client
2018-02-07 16:04:18,998: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 16:04:18,999: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 16:04:18,999: Re-using an available connection from the pool.
2018-02-07 16:04:19,217: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 16:04:20,045: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11179f518>]}
2018-02-07 16:04:20,384: 16:04:20 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.05s]
2018-02-07 16:04:20,385: 16:04:20 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 16:04:20,385: Compiling model.seo_audit.agg_all
2018-02-07 16:04:20,394: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 16:04:20,394: Acquiring new bigquery connection "agg_all".
2018-02-07 16:04:20,395: Re-using an available connection from the pool.
2018-02-07 16:04:20,601: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 16:04:21,358: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '21a782f3-c292-435a-8cc0-6816eccf13b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117b1438>]}
2018-02-07 16:04:22,768: 16:04:22 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.97s]
2018-02-07 16:04:22,785: 16:04:22 | 
2018-02-07 16:04:22,785: 16:04:22 | Finished running 29 view models in 16.46s.
2018-02-07 16:04:22,785: Connection 'master' was left open.
2018-02-07 16:04:22,786: 
2018-02-07 16:04:22,786: Completed successfully
2018-02-07 16:04:22,786: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 16:04:22,786: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117762b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111672c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11182f978>]}
2018-02-07 16:04:23,075: Flushing usage events
2018-02-07 16:13:22,796: Tracking: tracking
2018-02-07 16:13:22,799: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10591e320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10591e588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10591ed68>]}
2018-02-07 16:13:23,621: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 16:13:23,638: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 16:13:23,645: Parsing core.sql
2018-02-07 16:13:23,673: Parsing adapters/bigquery.sql
2018-02-07 16:13:23,685: Parsing adapters/common.sql
2018-02-07 16:13:23,708: Parsing adapters/postgres.sql
2018-02-07 16:13:23,717: Parsing adapters/redshift.sql
2018-02-07 16:13:23,742: Parsing etc/get_custom_schema.sql
2018-02-07 16:13:23,750: Parsing materializations/archive.sql
2018-02-07 16:13:23,783: Parsing materializations/bigquery.sql
2018-02-07 16:13:23,809: Parsing materializations/helpers.sql
2018-02-07 16:13:23,835: Parsing materializations/incremental.sql
2018-02-07 16:13:23,869: Parsing materializations/table.sql
2018-02-07 16:13:23,898: Parsing materializations/view.sql
2018-02-07 16:13:23,920: Parsing materializations/wrapper.sql
2018-02-07 16:13:23,931: Parsing schema_tests/accepted_values.sql
2018-02-07 16:13:23,940: Parsing schema_tests/not_null.sql
2018-02-07 16:13:23,945: Parsing schema_tests/relationships.sql
2018-02-07 16:13:23,953: Parsing schema_tests/unique.sql
2018-02-07 16:13:24,021: Parsing model.seo_audit.accounts_proc
2018-02-07 16:13:24,023: Parsing model.seo_audit.all_dates
2018-02-07 16:13:24,024: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 16:13:24,026: Acquiring new bigquery connection "master".
2018-02-07 16:13:24,027: Opening a new connection (0 currently allocated)
2018-02-07 16:13:24,034: Parsing model.seo_audit.agg_all
2018-02-07 16:13:24,038: Parsing model.seo_audit.agg_indicative
2018-02-07 16:13:24,040: Parsing model.seo_audit.agg_stats
2018-02-07 16:13:24,045: Parsing model.seo_audit.agg_stats_client
2018-02-07 16:13:24,049: Parsing model.seo_audit.deepcrawl_class
2018-02-07 16:13:24,052: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 16:13:24,054: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:13:24,056: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 16:13:24,058: Parsing model.seo_audit.ga_proc
2018-02-07 16:13:24,061: Parsing model.seo_audit.ga_stats
2018-02-07 16:13:24,063: Parsing model.seo_audit.majestic_domain_history
2018-02-07 16:13:24,065: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 16:13:24,067: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 16:13:24,069: Parsing model.seo_audit.moz_proc
2018-02-07 16:13:24,072: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 16:13:24,075: Parsing model.seo_audit.search_console_history
2018-02-07 16:13:24,077: Parsing model.seo_audit.search_console_proc
2018-02-07 16:13:24,079: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 16:13:24,084: Parsing model.seo_audit.search_console_stats_url
2018-02-07 16:13:24,087: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 16:13:24,091: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 16:13:24,094: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 16:13:24,098: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 16:13:24,102: Parsing model.seo_audit.semrush_url_history
2018-02-07 16:13:24,105: Parsing model.seo_audit.semrush_url_stats
2018-02-07 16:13:24,107: Parsing model.seo_audit.sitemap_proc
2018-02-07 16:13:24,119: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 16:13:24,127: 
2018-02-07 16:13:25,434: 16:13:25 | Concurrency: 4 threads (target='dev')
2018-02-07 16:13:25,434: 16:13:25 | 
2018-02-07 16:13:25,643: 16:13:25 | 1 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 16:13:25,644: Compiling model.seo_audit.all_dates
2018-02-07 16:13:25,643: 16:13:25 | 3 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 16:13:25,643: 16:13:25 | 2 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 16:13:25,652: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 16:13:25,652: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 16:13:25,652: Compiling model.seo_audit.accounts_proc
2018-02-07 16:13:25,657: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 16:13:25,664: Acquiring new bigquery connection "all_dates".
2018-02-07 16:13:25,665: Opening a new connection (1 currently allocated)
2018-02-07 16:13:25,663: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 16:13:25,752: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 16:13:25,752: Opening a new connection (2 currently allocated)
2018-02-07 16:13:25,839: Acquiring new bigquery connection "accounts_proc".
2018-02-07 16:13:25,840: Opening a new connection (3 currently allocated)
2018-02-07 16:13:26,331: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 16:13:26,333: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 16:13:26,355: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 16:13:26,551: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a4ccf8>]}
2018-02-07 16:13:26,557: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105addcc0>]}
2018-02-07 16:13:26,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a585c0>]}
2018-02-07 16:13:27,070: 16:13:27 | 1 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.91s]
2018-02-07 16:13:27,354: 16:13:27 | 3 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.90s]
2018-02-07 16:13:27,573: 16:13:27 | 2 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.98s]
2018-02-07 16:13:27,574: 16:13:27 | 4 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 16:13:27,575: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 16:13:27,574: 16:13:27 | 5 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 16:13:27,582: Compiling model.seo_audit.ga_proc
2018-02-07 16:13:27,592: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 16:13:27,594: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 16:13:27,574: 16:13:27 | 6 of 29 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-07 16:13:27,594: Compiling model.seo_audit.search_console_proc
2018-02-07 16:13:27,600: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 16:13:27,575: 16:13:27 | 7 of 29 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-07 16:13:27,601: Compiling model.seo_audit.moz_proc
2018-02-07 16:13:27,607: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 16:13:27,609: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 16:13:27,610: Acquiring new bigquery connection "search_console_proc".
2018-02-07 16:13:27,610: Re-using an available connection from the pool.
2018-02-07 16:13:27,612: Acquiring new bigquery connection "moz_proc".
2018-02-07 16:13:27,613: Acquiring new bigquery connection "ga_proc".
2018-02-07 16:13:27,614: Re-using an available connection from the pool.
2018-02-07 16:13:27,620: Re-using an available connection from the pool.
2018-02-07 16:13:27,621: Opening a new connection (4 currently allocated)
2018-02-07 16:13:27,837: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 16:13:27,847: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:13:27,915: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:13:28,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a65dd8>]}
2018-02-07 16:13:28,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ac7080>]}
2018-02-07 16:13:28,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a43b38>]}
2018-02-07 16:13:28,222: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 16:13:28,370: 16:13:28 | 4 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.57s]
2018-02-07 16:13:28,371: 16:13:28 | 8 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 16:13:28,372: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 16:13:28,385: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 16:13:28,388: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 16:13:28,389: Re-using an available connection from the pool.
2018-02-07 16:13:28,592: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 16:13:28,595: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a4ccf8>]}
2018-02-07 16:13:28,686: 16:13:28 | 6 of 29 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.56s]
2018-02-07 16:13:28,689: 16:13:28 | 9 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 16:13:28,690: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 16:13:28,697: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 16:13:28,698: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 16:13:28,698: Re-using an available connection from the pool.
2018-02-07 16:13:28,822: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a65dd8>]}
2018-02-07 16:13:28,900: 16:13:28 | 7 of 29 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.59s]
2018-02-07 16:13:28,902: 16:13:28 | 10 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 16:13:28,902: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 16:13:28,905: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:13:28,923: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 16:13:28,929: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 16:13:28,929: Re-using an available connection from the pool.
2018-02-07 16:13:29,146: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 16:13:29,233: 16:13:29 | 5 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 1.01s]
2018-02-07 16:13:29,234: 16:13:29 | 11 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 16:13:29,235: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 16:13:29,243: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 16:13:29,245: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 16:13:29,245: Re-using an available connection from the pool.
2018-02-07 16:13:29,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ac7080>]}
2018-02-07 16:13:29,431: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b42f28>]}
2018-02-07 16:13:29,472: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|signup|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 16:13:29,558: 16:13:29 | 8 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.45s]
2018-02-07 16:13:29,560: 16:13:29 | 12 of 29 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-07 16:13:29,564: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 16:13:29,573: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 16:13:29,574: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 16:13:29,574: Re-using an available connection from the pool.
2018-02-07 16:13:29,773: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a4ccf8>]}
2018-02-07 16:13:29,803: 16:13:29 | 9 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.58s]
2018-02-07 16:13:29,804: 16:13:29 | 13 of 29 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-07 16:13:29,805: Compiling model.seo_audit.sitemap_proc
2018-02-07 16:13:29,814: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:13:29,832: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 16:13:29,834: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 16:13:29,835: Re-using an available connection from the pool.
2018-02-07 16:13:30,061: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 16:13:30,138: 16:13:30 | 10 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.53s]
2018-02-07 16:13:30,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a4ce48>]}
2018-02-07 16:13:30,328: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ef908>]}
2018-02-07 16:13:30,374: 16:13:30 | 11 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.54s]
2018-02-07 16:13:30,588: 16:13:30 | 12 of 29 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.59s]
2018-02-07 16:13:30,804: 16:13:30 | 13 of 29 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.52s]
2018-02-07 16:13:30,805: 16:13:30 | 14 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 16:13:30,806: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 16:13:30,805: 16:13:30 | 15 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 16:13:30,816: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 16:13:30,805: 16:13:30 | 16 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 16:13:30,816: Compiling model.seo_audit.majestic_domain_history
2018-02-07 16:13:30,805: 16:13:30 | 17 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 16:13:30,817: Compiling model.seo_audit.ga_stats
2018-02-07 16:13:30,822: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 16:13:30,822: Compiling model.seo_audit.semrush_url_history
2018-02-07 16:13:30,827: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 16:13:30,834: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 16:13:30,835: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 16:13:30,837: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 16:13:30,837: Re-using an available connection from the pool.
2018-02-07 16:13:30,838: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 16:13:30,848: Re-using an available connection from the pool.
2018-02-07 16:13:30,842: Acquiring new bigquery connection "ga_stats".
2018-02-07 16:13:30,854: Re-using an available connection from the pool.
2018-02-07 16:13:30,857: Re-using an available connection from the pool.
2018-02-07 16:13:31,066: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 16:13:31,072: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 16:13:31,100: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 16:13:31,113: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 16:13:31,471: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a585c0>]}
2018-02-07 16:13:31,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b057f0>]}
2018-02-07 16:13:31,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a43cc0>]}
2018-02-07 16:13:31,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a583c8>]}
2018-02-07 16:13:31,803: 16:13:31 | 16 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.65s]
2018-02-07 16:13:31,804: 16:13:31 | 18 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 16:13:31,805: Compiling model.seo_audit.search_console_history
2018-02-07 16:13:31,815: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 16:13:31,817: Acquiring new bigquery connection "search_console_history".
2018-02-07 16:13:31,817: Re-using an available connection from the pool.
2018-02-07 16:13:32,027: 16:13:32 | 14 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.67s]
2018-02-07 16:13:32,039: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 16:13:32,328: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a585c0>]}
2018-02-07 16:13:32,331: 16:13:32 | 15 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.66s]
2018-02-07 16:13:32,543: 16:13:32 | 17 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.66s]
2018-02-07 16:13:32,831: 16:13:32 | 18 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.52s]
2018-02-07 16:13:32,832: 16:13:32 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 16:13:32,832: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 16:13:32,832: 16:13:32 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 16:13:32,838: Compiling model.seo_audit.search_console_stats_url
2018-02-07 16:13:32,844: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 16:13:32,832: 16:13:32 | 21 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 16:13:32,847: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 16:13:32,847: Compiling model.seo_audit.deepcrawl_class
2018-02-07 16:13:32,853: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 16:13:32,853: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 16:13:32,854: Re-using an available connection from the pool.
2018-02-07 16:13:32,855: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 16:13:32,855: Re-using an available connection from the pool.
2018-02-07 16:13:32,857: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 16:13:32,857: Re-using an available connection from the pool.
2018-02-07 16:13:33,091: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 16:13:33,093: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 16:13:33,109: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_above_avg_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 16:13:33,505: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b05a20>]}
2018-02-07 16:13:33,511: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ef908>]}
2018-02-07 16:13:33,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b05dd8>]}
2018-02-07 16:13:33,817: 16:13:33 | 21 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.66s]
2018-02-07 16:13:34,108: 16:13:34 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.68s]
2018-02-07 16:13:34,405: 16:13:34 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.72s]
2018-02-07 16:13:34,406: 16:13:34 | 22 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 16:13:34,407: Compiling model.seo_audit.semrush_url_stats
2018-02-07 16:13:34,406: 16:13:34 | 23 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 16:13:34,413: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 16:13:34,406: 16:13:34 | 24 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 16:13:34,413: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:13:34,407: 16:13:34 | 25 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 16:13:34,414: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 16:13:34,419: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 16:13:34,420: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 16:13:34,420: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 16:13:34,431: Re-using an available connection from the pool.
2018-02-07 16:13:34,425: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 16:13:34,435: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 16:13:34,441: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 16:13:34,442: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 16:13:34,446: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 16:13:34,446: Re-using an available connection from the pool.
2018-02-07 16:13:34,447: Re-using an available connection from the pool.
2018-02-07 16:13:34,457: Re-using an available connection from the pool.
2018-02-07 16:13:34,657: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 16:13:34,665: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:13:34,740: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-07 16:13:34,741: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:13:35,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ae97f0>]}
2018-02-07 16:13:35,108: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a435c0>]}
2018-02-07 16:13:35,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a1bfd0>]}
2018-02-07 16:13:35,189: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a09a90>]}
2018-02-07 16:13:35,285: 16:13:35 | 25 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.65s]
2018-02-07 16:13:35,503: 16:13:35 | 22 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.70s]
2018-02-07 16:13:36,006: 16:13:36 | 23 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.71s]
2018-02-07 16:13:36,231: 16:13:36 | 24 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.77s]
2018-02-07 16:13:36,232: 16:13:36 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 16:13:36,233: Compiling model.seo_audit.agg_indicative
2018-02-07 16:13:36,241: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 16:13:36,242: Acquiring new bigquery connection "agg_indicative".
2018-02-07 16:13:36,242: Re-using an available connection from the pool.
2018-02-07 16:13:36,434: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 16:13:36,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a58828>]}
2018-02-07 16:13:37,195: 16:13:37 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.68s]
2018-02-07 16:13:37,196: 16:13:37 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 16:13:37,197: Compiling model.seo_audit.agg_stats
2018-02-07 16:13:37,209: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 16:13:37,210: Acquiring new bigquery connection "agg_stats".
2018-02-07 16:13:37,210: Re-using an available connection from the pool.
2018-02-07 16:13:37,403: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 16:13:38,120: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a09a90>]}
2018-02-07 16:13:38,423: 16:13:38 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.92s]
2018-02-07 16:13:38,424: 16:13:38 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 16:13:38,424: Compiling model.seo_audit.agg_stats_client
2018-02-07 16:13:38,433: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 16:13:38,434: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 16:13:38,434: Re-using an available connection from the pool.
2018-02-07 16:13:38,637: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 16:13:39,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a58828>]}
2018-02-07 16:13:39,702: 16:13:39 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.97s]
2018-02-07 16:13:39,702: 16:13:39 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 16:13:39,703: Compiling model.seo_audit.agg_all
2018-02-07 16:13:39,714: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 16:13:39,714: Acquiring new bigquery connection "agg_all".
2018-02-07 16:13:39,715: Re-using an available connection from the pool.
2018-02-07 16:13:39,925: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 16:13:40,933: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30f3b633-ae2b-4211-ba72-442fc7d26bff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a09a90>]}
2018-02-07 16:13:41,295: 16:13:41 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.23s]
2018-02-07 16:13:41,337: 16:13:41 | 
2018-02-07 16:13:41,338: 16:13:41 | Finished running 29 view models in 15.90s.
2018-02-07 16:13:41,338: Connection 'master' was left open.
2018-02-07 16:13:41,338: 
2018-02-07 16:13:41,338: Completed successfully
2018-02-07 16:13:41,339: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 16:13:41,339: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105996048>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ef470>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ef550>]}
2018-02-07 16:13:41,732: Flushing usage events
2018-02-07 16:20:00,058: Tracking: tracking
2018-02-07 16:20:00,061: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ef2da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ef2908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ef2f60>]}
2018-02-07 16:20:01,267: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 16:20:01,288: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 16:20:01,298: Parsing core.sql
2018-02-07 16:20:01,322: Parsing adapters/bigquery.sql
2018-02-07 16:20:01,330: Parsing adapters/common.sql
2018-02-07 16:20:01,350: Parsing adapters/postgres.sql
2018-02-07 16:20:01,359: Parsing adapters/redshift.sql
2018-02-07 16:20:01,388: Parsing etc/get_custom_schema.sql
2018-02-07 16:20:01,397: Parsing materializations/archive.sql
2018-02-07 16:20:01,433: Parsing materializations/bigquery.sql
2018-02-07 16:20:01,455: Parsing materializations/helpers.sql
2018-02-07 16:20:01,474: Parsing materializations/incremental.sql
2018-02-07 16:20:01,506: Parsing materializations/table.sql
2018-02-07 16:20:01,528: Parsing materializations/view.sql
2018-02-07 16:20:01,546: Parsing materializations/wrapper.sql
2018-02-07 16:20:01,555: Parsing schema_tests/accepted_values.sql
2018-02-07 16:20:01,562: Parsing schema_tests/not_null.sql
2018-02-07 16:20:01,566: Parsing schema_tests/relationships.sql
2018-02-07 16:20:01,571: Parsing schema_tests/unique.sql
2018-02-07 16:20:01,694: Parsing model.seo_audit.accounts_proc
2018-02-07 16:20:01,699: Parsing model.seo_audit.all_dates
2018-02-07 16:20:01,701: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 16:20:01,705: Acquiring new bigquery connection "master".
2018-02-07 16:20:01,705: Opening a new connection (0 currently allocated)
2018-02-07 16:20:01,710: Parsing model.seo_audit.agg_all
2018-02-07 16:20:01,713: Parsing model.seo_audit.agg_indicative
2018-02-07 16:20:01,715: Parsing model.seo_audit.agg_stats
2018-02-07 16:20:01,720: Parsing model.seo_audit.agg_stats_client
2018-02-07 16:20:01,723: Parsing model.seo_audit.deepcrawl_class
2018-02-07 16:20:01,726: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 16:20:01,729: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:20:01,731: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 16:20:01,733: Parsing model.seo_audit.ga_proc
2018-02-07 16:20:01,736: Parsing model.seo_audit.ga_stats
2018-02-07 16:20:01,737: Parsing model.seo_audit.majestic_domain_history
2018-02-07 16:20:01,739: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 16:20:01,742: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 16:20:01,744: Parsing model.seo_audit.moz_proc
2018-02-07 16:20:01,747: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 16:20:01,750: Parsing model.seo_audit.search_console_history
2018-02-07 16:20:01,751: Parsing model.seo_audit.search_console_proc
2018-02-07 16:20:01,754: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 16:20:01,758: Parsing model.seo_audit.search_console_stats_url
2018-02-07 16:20:01,761: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 16:20:01,763: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 16:20:01,766: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 16:20:01,768: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 16:20:01,770: Parsing model.seo_audit.semrush_url_history
2018-02-07 16:20:01,772: Parsing model.seo_audit.semrush_url_stats
2018-02-07 16:20:01,774: Parsing model.seo_audit.sitemap_proc
2018-02-07 16:20:01,785: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 16:20:01,791: 
2018-02-07 16:20:02,940: 16:20:02 | Concurrency: 4 threads (target='dev')
2018-02-07 16:20:02,940: 16:20:02 | 
2018-02-07 16:20:03,124: 16:20:03 | 1 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 16:20:03,125: Compiling model.seo_audit.all_dates
2018-02-07 16:20:03,129: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 16:20:03,125: 16:20:03 | 2 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 16:20:03,125: 16:20:03 | 3 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 16:20:03,130: Compiling model.seo_audit.accounts_proc
2018-02-07 16:20:03,130: Acquiring new bigquery connection "all_dates".
2018-02-07 16:20:03,130: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 16:20:03,135: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 16:20:03,135: Opening a new connection (1 currently allocated)
2018-02-07 16:20:03,140: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 16:20:03,143: Acquiring new bigquery connection "accounts_proc".
2018-02-07 16:20:03,144: Opening a new connection (2 currently allocated)
2018-02-07 16:20:03,144: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 16:20:03,252: Opening a new connection (3 currently allocated)
2018-02-07 16:20:03,773: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 16:20:03,781: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 16:20:03,789: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 16:20:03,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10502ef98>]}
2018-02-07 16:20:03,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050b96a0>]}
2018-02-07 16:20:03,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105041748>]}
2018-02-07 16:20:04,193: 16:20:04 | 1 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.82s]
2018-02-07 16:20:04,431: 16:20:04 | 2 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.86s]
2018-02-07 16:20:04,645: 16:20:04 | 3 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.86s]
2018-02-07 16:20:04,646: 16:20:04 | 4 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 16:20:04,646: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 16:20:04,646: 16:20:04 | 5 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 16:20:04,652: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 16:20:04,646: 16:20:04 | 6 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 16:20:04,653: Compiling model.seo_audit.ga_proc
2018-02-07 16:20:04,646: 16:20:04 | 7 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 16:20:04,653: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 16:20:04,662: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 16:20:04,662: Compiling model.seo_audit.sitemap_proc
2018-02-07 16:20:04,670: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 16:20:04,690: Re-using an available connection from the pool.
2018-02-07 16:20:04,671: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 16:20:04,693: Acquiring new bigquery connection "ga_proc".
2018-02-07 16:20:04,690: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 16:20:04,695: Re-using an available connection from the pool.
2018-02-07 16:20:04,700: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 16:20:04,701: Re-using an available connection from the pool.
2018-02-07 16:20:04,703: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 16:20:04,706: Opening a new connection (4 currently allocated)
2018-02-07 16:20:04,912: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:20:04,997: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 16:20:05,013: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 16:20:05,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105041b70>]}
2018-02-07 16:20:05,271: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 16:20:05,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104feef98>]}
2018-02-07 16:20:05,371: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050753c8>]}
2018-02-07 16:20:05,524: 16:20:05 | 4 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.59s]
2018-02-07 16:20:05,525: 16:20:05 | 8 of 29 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-07 16:20:05,526: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 16:20:05,539: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 16:20:05,541: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 16:20:05,541: Re-using an available connection from the pool.
2018-02-07 16:20:05,592: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105075080>]}
2018-02-07 16:20:05,751: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 16:20:05,831: 16:20:05 | 5 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.64s]
2018-02-07 16:20:05,833: 16:20:05 | 9 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 16:20:05,833: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 16:20:05,844: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 16:20:05,849: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 16:20:05,851: Re-using an available connection from the pool.
2018-02-07 16:20:06,065: 16:20:06 | 6 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.72s]
2018-02-07 16:20:06,066: 16:20:06 | 10 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 16:20:06,067: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 16:20:06,074: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 16:20:06,076: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 16:20:06,078: Re-using an available connection from the pool.
2018-02-07 16:20:06,080: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105041b70>]}
2018-02-07 16:20:06,085: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 16:20:06,274: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 16:20:06,300: 16:20:06 | 7 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.93s]
2018-02-07 16:20:06,300: 16:20:06 | 11 of 29 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-07 16:20:06,300: Compiling model.seo_audit.moz_proc
2018-02-07 16:20:06,317: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 16:20:06,319: Acquiring new bigquery connection "moz_proc".
2018-02-07 16:20:06,320: Re-using an available connection from the pool.
2018-02-07 16:20:06,423: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:06,519: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:20:06,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105041828>]}
2018-02-07 16:20:06,584: 16:20:06 | 8 of 29 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.55s]
2018-02-07 16:20:06,585: 16:20:06 | 12 of 29 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-07 16:20:06,586: Compiling model.seo_audit.search_console_proc
2018-02-07 16:20:06,594: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 16:20:06,599: Acquiring new bigquery connection "search_console_proc".
2018-02-07 16:20:06,599: Re-using an available connection from the pool.
2018-02-07 16:20:06,799: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051243c8>]}
2018-02-07 16:20:06,808: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:20:06,843: 16:20:06 | 9 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.59s]
2018-02-07 16:20:06,844: 16:20:06 | 13 of 29 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-07 16:20:06,844: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 16:20:06,851: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 16:20:06,855: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 16:20:06,856: Re-using an available connection from the pool.
2018-02-07 16:20:07,044: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:20:07,088: 16:20:07 | 10 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.50s]
2018-02-07 16:20:07,101: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105124128>]}
2018-02-07 16:20:07,313: 16:20:07 | 11 of 29 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.50s]
2018-02-07 16:20:07,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:07,537: 16:20:07 | 12 of 29 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.52s]
2018-02-07 16:20:07,836: 16:20:07 | 13 of 29 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.49s]
2018-02-07 16:20:07,837: 16:20:07 | 14 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 16:20:07,838: Compiling model.seo_audit.search_console_history
2018-02-07 16:20:07,838: 16:20:07 | 15 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 16:20:07,844: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 16:20:07,838: 16:20:07 | 16 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 16:20:07,861: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 16:20:07,861: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 16:20:07,862: Compiling model.seo_audit.majestic_domain_history
2018-02-07 16:20:07,838: 16:20:07 | 17 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 16:20:07,869: Compiling model.seo_audit.ga_stats
2018-02-07 16:20:07,869: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 16:20:07,885: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 16:20:07,887: Re-using an available connection from the pool.
2018-02-07 16:20:07,870: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 16:20:07,891: Re-using an available connection from the pool.
2018-02-07 16:20:07,880: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 16:20:07,884: Acquiring new bigquery connection "search_console_history".
2018-02-07 16:20:07,901: Acquiring new bigquery connection "ga_stats".
2018-02-07 16:20:07,901: Re-using an available connection from the pool.
2018-02-07 16:20:07,908: Re-using an available connection from the pool.
2018-02-07 16:20:08,094: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 16:20:08,100: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 16:20:08,114: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 16:20:08,125: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 16:20:08,376: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050f0630>]}
2018-02-07 16:20:08,424: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10502ef98>]}
2018-02-07 16:20:08,462: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050cfd30>]}
2018-02-07 16:20:08,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105000358>]}
2018-02-07 16:20:08,585: 16:20:08 | 16 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.51s]
2018-02-07 16:20:08,586: 16:20:08 | 18 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 16:20:08,586: Compiling model.seo_audit.semrush_url_history
2018-02-07 16:20:08,599: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 16:20:08,601: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 16:20:08,602: Re-using an available connection from the pool.
2018-02-07 16:20:08,853: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 16:20:08,942: 16:20:08 | 15 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.58s]
2018-02-07 16:20:09,155: 16:20:09 | 17 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.59s]
2018-02-07 16:20:09,235: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050753c8>]}
2018-02-07 16:20:09,406: 16:20:09 | 14 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.64s]
2018-02-07 16:20:09,836: 16:20:09 | 18 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.65s]
2018-02-07 16:20:09,837: 16:20:09 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 16:20:09,838: 16:20:09 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 16:20:09,838: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 16:20:09,838: 16:20:09 | 21 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 16:20:09,838: Compiling model.seo_audit.search_console_stats_url
2018-02-07 16:20:09,848: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 16:20:09,849: Compiling model.seo_audit.deepcrawl_class
2018-02-07 16:20:09,853: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 16:20:09,860: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 16:20:09,862: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 16:20:09,862: Re-using an available connection from the pool.
2018-02-07 16:20:09,863: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 16:20:09,863: Re-using an available connection from the pool.
2018-02-07 16:20:09,866: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 16:20:09,868: Re-using an available connection from the pool.
2018-02-07 16:20:10,087: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 16:20:10,093: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when flag_form_submit = 1 then 'lead_generation'
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 16:20:10,097: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 16:20:10,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:10,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10502ef98>]}
2018-02-07 16:20:10,454: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105075128>]}
2018-02-07 16:20:10,749: 16:20:10 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.58s]
2018-02-07 16:20:11,057: 16:20:11 | 21 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.60s]
2018-02-07 16:20:11,363: 16:20:11 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.62s]
2018-02-07 16:20:11,364: 16:20:11 | 22 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 16:20:11,365: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:20:11,364: 16:20:11 | 23 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 16:20:11,371: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 16:20:11,364: 16:20:11 | 24 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 16:20:11,378: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 16:20:11,380: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 16:20:11,364: 16:20:11 | 25 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 16:20:11,380: Compiling model.seo_audit.semrush_url_stats
2018-02-07 16:20:11,381: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 16:20:11,386: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 16:20:11,386: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 16:20:11,391: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 16:20:11,392: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 16:20:11,392: Re-using an available connection from the pool.
2018-02-07 16:20:11,393: Re-using an available connection from the pool.
2018-02-07 16:20:11,396: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 16:20:11,396: Re-using an available connection from the pool.
2018-02-07 16:20:11,397: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 16:20:11,407: Re-using an available connection from the pool.
2018-02-07 16:20:11,603: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-07 16:20:11,612: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:20:11,613: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 16:20:11,639: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:20:11,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050b9a20>]}
2018-02-07 16:20:12,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050753c8>]}
2018-02-07 16:20:12,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050b9978>]}
2018-02-07 16:20:12,052: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:12,261: 16:20:12 | 25 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.58s]
2018-02-07 16:20:12,562: 16:20:12 | 22 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.64s]
2018-02-07 16:20:12,881: 16:20:12 | 24 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.66s]
2018-02-07 16:20:13,177: 16:20:13 | 23 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.68s]
2018-02-07 16:20:13,178: 16:20:13 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 16:20:13,178: Compiling model.seo_audit.agg_indicative
2018-02-07 16:20:13,187: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 16:20:13,188: Acquiring new bigquery connection "agg_indicative".
2018-02-07 16:20:13,188: Re-using an available connection from the pool.
2018-02-07 16:20:13,376: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 16:20:13,802: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105000358>]}
2018-02-07 16:20:14,122: 16:20:14 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.62s]
2018-02-07 16:20:14,123: 16:20:14 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 16:20:14,124: Compiling model.seo_audit.agg_stats
2018-02-07 16:20:14,137: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 16:20:14,138: Acquiring new bigquery connection "agg_stats".
2018-02-07 16:20:14,138: Re-using an available connection from the pool.
2018-02-07 16:20:14,333: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 16:20:14,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:15,184: 16:20:15 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.81s]
2018-02-07 16:20:15,185: 16:20:15 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 16:20:15,185: Compiling model.seo_audit.agg_stats_client
2018-02-07 16:20:15,194: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 16:20:15,195: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 16:20:15,195: Re-using an available connection from the pool.
2018-02-07 16:20:15,412: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 16:20:16,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050754e0>]}
2018-02-07 16:20:16,261: 16:20:16 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.85s]
2018-02-07 16:20:16,262: 16:20:16 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 16:20:16,262: Compiling model.seo_audit.agg_all
2018-02-07 16:20:16,271: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 16:20:16,272: Acquiring new bigquery connection "agg_all".
2018-02-07 16:20:16,273: Re-using an available connection from the pool.
2018-02-07 16:20:16,462: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 16:20:17,206: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4489813-3f4e-416d-b16d-cb089dcb9c6a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101aad630>]}
2018-02-07 16:20:17,503: 16:20:17 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.94s]
2018-02-07 16:20:17,566: 16:20:17 | 
2018-02-07 16:20:17,567: 16:20:17 | Finished running 29 view models in 14.63s.
2018-02-07 16:20:17,567: Connection 'master' was left open.
2018-02-07 16:20:17,567: 
2018-02-07 16:20:17,568: Completed successfully
2018-02-07 16:20:17,568: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 16:20:17,568: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fd96d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fd9860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fd9710>]}
2018-02-07 16:20:17,861: Flushing usage events
2018-02-07 16:21:45,599: Tracking: tracking
2018-02-07 16:21:45,601: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af1c7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af1cf98>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af1ca20>]}
2018-02-07 16:21:46,345: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-07 16:21:46,366: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-07 16:21:46,371: Parsing core.sql
2018-02-07 16:21:46,391: Parsing adapters/bigquery.sql
2018-02-07 16:21:46,403: Parsing adapters/common.sql
2018-02-07 16:21:46,420: Parsing adapters/postgres.sql
2018-02-07 16:21:46,427: Parsing adapters/redshift.sql
2018-02-07 16:21:46,452: Parsing etc/get_custom_schema.sql
2018-02-07 16:21:46,462: Parsing materializations/archive.sql
2018-02-07 16:21:46,505: Parsing materializations/bigquery.sql
2018-02-07 16:21:46,526: Parsing materializations/helpers.sql
2018-02-07 16:21:46,554: Parsing materializations/incremental.sql
2018-02-07 16:21:46,596: Parsing materializations/table.sql
2018-02-07 16:21:46,623: Parsing materializations/view.sql
2018-02-07 16:21:46,653: Parsing materializations/wrapper.sql
2018-02-07 16:21:46,659: Parsing schema_tests/accepted_values.sql
2018-02-07 16:21:46,668: Parsing schema_tests/not_null.sql
2018-02-07 16:21:46,672: Parsing schema_tests/relationships.sql
2018-02-07 16:21:46,678: Parsing schema_tests/unique.sql
2018-02-07 16:21:46,716: Parsing model.seo_audit.accounts_proc
2018-02-07 16:21:46,719: Parsing model.seo_audit.all_dates
2018-02-07 16:21:46,720: Parsing model.seo_audit.mappings_ga_proc
2018-02-07 16:21:46,723: Acquiring new bigquery connection "master".
2018-02-07 16:21:46,723: Opening a new connection (0 currently allocated)
2018-02-07 16:21:46,727: Parsing model.seo_audit.agg_all
2018-02-07 16:21:46,733: Parsing model.seo_audit.agg_indicative
2018-02-07 16:21:46,736: Parsing model.seo_audit.agg_stats
2018-02-07 16:21:46,741: Parsing model.seo_audit.agg_stats_client
2018-02-07 16:21:46,746: Parsing model.seo_audit.deepcrawl_class
2018-02-07 16:21:46,750: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-07 16:21:46,753: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:21:46,756: Parsing model.seo_audit.deepcrawl_proc
2018-02-07 16:21:46,758: Parsing model.seo_audit.ga_proc
2018-02-07 16:21:46,762: Parsing model.seo_audit.ga_stats
2018-02-07 16:21:46,765: Parsing model.seo_audit.majestic_domain_history
2018-02-07 16:21:46,768: Parsing model.seo_audit.majestic_domain_proc
2018-02-07 16:21:46,771: Parsing model.seo_audit.majestic_domain_stats
2018-02-07 16:21:46,773: Parsing model.seo_audit.moz_proc
2018-02-07 16:21:46,776: Parsing model.seo_audit.screamingfrog_proc
2018-02-07 16:21:46,782: Parsing model.seo_audit.search_console_history
2018-02-07 16:21:46,784: Parsing model.seo_audit.search_console_proc
2018-02-07 16:21:46,787: Parsing model.seo_audit.search_console_stats_keyword
2018-02-07 16:21:46,790: Parsing model.seo_audit.search_console_stats_url
2018-02-07 16:21:46,792: Parsing model.seo_audit.semrush_domain_proc
2018-02-07 16:21:46,796: Parsing model.seo_audit.semrush_keyword_history
2018-02-07 16:21:46,800: Parsing model.seo_audit.semrush_keyword_proc
2018-02-07 16:21:46,803: Parsing model.seo_audit.semrush_keyword_stats
2018-02-07 16:21:46,806: Parsing model.seo_audit.semrush_url_history
2018-02-07 16:21:46,808: Parsing model.seo_audit.semrush_url_stats
2018-02-07 16:21:46,812: Parsing model.seo_audit.sitemap_proc
2018-02-07 16:21:46,824: Found 29 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-07 16:21:46,836: 
2018-02-07 16:21:47,990: 16:21:47 | Concurrency: 4 threads (target='dev')
2018-02-07 16:21:47,991: 16:21:47 | 
2018-02-07 16:21:48,164: 16:21:48 | 1 of 29 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-07 16:21:48,164: Compiling model.seo_audit.all_dates
2018-02-07 16:21:48,164: 16:21:48 | 2 of 29 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-07 16:21:48,168: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-07 16:21:48,164: 16:21:48 | 3 of 29 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-07 16:21:48,169: Compiling model.seo_audit.deepcrawl_proc
2018-02-07 16:21:48,169: Compiling model.seo_audit.accounts_proc
2018-02-07 16:21:48,173: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-07 16:21:48,179: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-07 16:21:48,180: Acquiring new bigquery connection "all_dates".
2018-02-07 16:21:48,180: Opening a new connection (1 currently allocated)
2018-02-07 16:21:48,183: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-07 16:21:48,238: Acquiring new bigquery connection "accounts_proc".
2018-02-07 16:21:48,241: Opening a new connection (2 currently allocated)
2018-02-07 16:21:48,302: Opening a new connection (3 currently allocated)
2018-02-07 16:21:48,773: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-07 16:21:48,786: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-07 16:21:48,816: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-07 16:21:48,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0d16a0>]}
2018-02-07 16:21:48,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0f07f0>]}
2018-02-07 16:21:49,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b035a58>]}
2018-02-07 16:21:49,276: 16:21:49 | 1 of 29 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.80s]
2018-02-07 16:21:49,488: 16:21:49 | 3 of 29 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.80s]
2018-02-07 16:21:49,819: 16:21:49 | 2 of 29 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.86s]
2018-02-07 16:21:49,820: 16:21:49 | 4 of 29 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-07 16:21:49,820: 16:21:49 | 5 of 29 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-07 16:21:49,820: Compiling model.seo_audit.sitemap_proc
2018-02-07 16:21:49,820: 16:21:49 | 6 of 29 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-07 16:21:49,821: Compiling model.seo_audit.mappings_ga_proc
2018-02-07 16:21:49,820: 16:21:49 | 7 of 29 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-07 16:21:49,827: Compiling model.seo_audit.screamingfrog_proc
2018-02-07 16:21:49,829: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-07 16:21:49,837: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-07 16:21:49,837: Compiling model.seo_audit.semrush_domain_proc
2018-02-07 16:21:49,846: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-07 16:21:49,854: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-07 16:21:49,856: Acquiring new bigquery connection "sitemap_proc".
2018-02-07 16:21:49,856: Re-using an available connection from the pool.
2018-02-07 16:21:49,857: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-07 16:21:49,858: Re-using an available connection from the pool.
2018-02-07 16:21:49,859: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-07 16:21:49,862: Re-using an available connection from the pool.
2018-02-07 16:21:49,860: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-07 16:21:49,870: Opening a new connection (4 currently allocated)
2018-02-07 16:21:50,097: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-07 16:21:50,109: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-07 16:21:50,117: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-07 16:21:50,363: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b024710>]}
2018-02-07 16:21:50,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0899b0>]}
2018-02-07 16:21:50,386: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:21:50,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0d16a0>]}
2018-02-07 16:21:50,675: 16:21:50 | 4 of 29 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.54s]
2018-02-07 16:21:50,676: 16:21:50 | 8 of 29 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-07 16:21:50,676: Compiling model.seo_audit.semrush_keyword_proc
2018-02-07 16:21:50,686: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-07 16:21:50,689: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-07 16:21:50,690: Re-using an available connection from the pool.
2018-02-07 16:21:50,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0cb160>]}
2018-02-07 16:21:50,907: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:21:51,003: 16:21:51 | 5 of 29 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.55s]
2018-02-07 16:21:51,004: 16:21:51 | 9 of 29 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-07 16:21:51,004: Compiling model.seo_audit.ga_proc
2018-02-07 16:21:51,010: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-07 16:21:51,015: Acquiring new bigquery connection "ga_proc".
2018-02-07 16:21:51,016: Re-using an available connection from the pool.
2018-02-07 16:21:51,200: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-07 16:21:51,258: 16:21:51 | 6 of 29 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.57s]
2018-02-07 16:21:51,259: 16:21:51 | 10 of 29 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-07 16:21:51,262: Compiling model.seo_audit.majestic_domain_proc
2018-02-07 16:21:51,272: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-07 16:21:51,273: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-07 16:21:51,273: Re-using an available connection from the pool.
2018-02-07 16:21:51,379: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b024710>]}
2018-02-07 16:21:51,501: 16:21:51 | 7 of 29 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.86s]
2018-02-07 16:21:51,502: 16:21:51 | 11 of 29 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-07 16:21:51,502: Compiling model.seo_audit.search_console_proc
2018-02-07 16:21:51,512: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-07 16:21:51,516: Acquiring new bigquery connection "search_console_proc".
2018-02-07 16:21:51,516: Re-using an available connection from the pool.
2018-02-07 16:21:51,567: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-07 16:21:51,921: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-07 16:21:51,922: 16:21:51 | 8 of 29 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.70s]
2018-02-07 16:21:51,923: 16:21:51 | 12 of 29 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-07 16:21:51,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0cbe48>]}
2018-02-07 16:21:51,926: Compiling model.seo_audit.moz_proc
2018-02-07 16:21:51,936: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-07 16:21:51,938: Acquiring new bigquery connection "moz_proc".
2018-02-07 16:21:51,939: Re-using an available connection from the pool.
2018-02-07 16:21:51,983: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0d16a0>]}
2018-02-07 16:21:52,155: 16:21:52 | 9 of 29 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.92s]
2018-02-07 16:21:52,156: 16:21:52 | 13 of 29 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-07 16:21:52,158: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-07 16:21:52,168: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-07 16:21:52,170: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-07 16:21:52,172: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-07 16:21:52,172: Re-using an available connection from the pool.
2018-02-07 16:21:52,228: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b005e48>]}
2018-02-07 16:21:52,398: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-07 16:21:52,473: 16:21:52 | 10 of 29 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.72s]
2018-02-07 16:21:52,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b024710>]}
2018-02-07 16:21:52,692: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b117e10>]}
2018-02-07 16:21:52,764: 16:21:52 | 11 of 29 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.72s]
2018-02-07 16:21:53,129: 16:21:53 | 12 of 29 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.56s]
2018-02-07 16:21:53,420: 16:21:53 | 13 of 29 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.53s]
2018-02-07 16:21:53,421: 16:21:53 | 14 of 29 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-07 16:21:53,422: Compiling model.seo_audit.majestic_domain_history
2018-02-07 16:21:53,421: 16:21:53 | 15 of 29 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-07 16:21:53,427: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-07 16:21:53,428: Compiling model.seo_audit.ga_stats
2018-02-07 16:21:53,421: 16:21:53 | 16 of 29 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-07 16:21:53,422: 16:21:53 | 17 of 29 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-07 16:21:53,430: Acquiring new bigquery connection "majestic_domain_history".
2018-02-07 16:21:53,437: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-07 16:21:53,437: Compiling model.seo_audit.semrush_keyword_history
2018-02-07 16:21:53,437: Compiling model.seo_audit.search_console_history
2018-02-07 16:21:53,437: Re-using an available connection from the pool.
2018-02-07 16:21:53,464: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-07 16:21:53,469: Acquiring new bigquery connection "search_console_history".
2018-02-07 16:21:53,470: Re-using an available connection from the pool.
2018-02-07 16:21:53,493: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-07 16:21:53,499: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-07 16:21:53,500: Re-using an available connection from the pool.
2018-02-07 16:21:53,512: Acquiring new bigquery connection "ga_stats".
2018-02-07 16:21:53,512: Re-using an available connection from the pool.
2018-02-07 16:21:53,669: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-07 16:21:53,720: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-07 16:21:53,748: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-07 16:21:53,802: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-07 16:21:53,994: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b035a58>]}
2018-02-07 16:21:54,101: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b11da58>]}
2018-02-07 16:21:54,189: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b11d940>]}
2018-02-07 16:21:54,255: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afed9b0>]}
2018-02-07 16:21:54,293: 16:21:54 | 14 of 29 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-07 16:21:54,297: 16:21:54 | 18 of 29 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-07 16:21:54,299: Compiling model.seo_audit.semrush_url_history
2018-02-07 16:21:54,309: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-07 16:21:54,311: Acquiring new bigquery connection "semrush_url_history".
2018-02-07 16:21:54,311: Re-using an available connection from the pool.
2018-02-07 16:21:54,513: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-07 16:21:54,542: 16:21:54 | 15 of 29 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.67s]
2018-02-07 16:21:54,820: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b035a58>]}
2018-02-07 16:21:54,853: 16:21:54 | 17 of 29 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.75s]
2018-02-07 16:21:55,115: 16:21:55 | 16 of 29 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.82s]
2018-02-07 16:21:55,381: 16:21:55 | 18 of 29 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.52s]
2018-02-07 16:21:55,382: 16:21:55 | 19 of 29 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-07 16:21:55,383: Compiling model.seo_audit.search_console_stats_keyword
2018-02-07 16:21:55,382: 16:21:55 | 20 of 29 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-07 16:21:55,390: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-07 16:21:55,382: 16:21:55 | 21 of 29 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-07 16:21:55,390: Compiling model.seo_audit.search_console_stats_url
2018-02-07 16:21:55,390: Compiling model.seo_audit.deepcrawl_class
2018-02-07 16:21:55,396: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-07 16:21:55,403: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-07 16:21:55,404: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-07 16:21:55,404: Re-using an available connection from the pool.
2018-02-07 16:21:55,407: Acquiring new bigquery connection "search_console_stats_url".
2018-02-07 16:21:55,408: Acquiring new bigquery connection "deepcrawl_class".
2018-02-07 16:21:55,409: Re-using an available connection from the pool.
2018-02-07 16:21:55,417: Re-using an available connection from the pool.
2018-02-07 16:21:55,651: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-07 16:21:55,656: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-07 16:21:55,665: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-07 16:21:55,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b045d30>]}
2018-02-07 16:21:55,996: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0db3c8>]}
2018-02-07 16:21:56,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b045f98>]}
2018-02-07 16:21:56,236: 16:21:56 | 20 of 29 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.55s]
2018-02-07 16:21:56,450: 16:21:56 | 19 of 29 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.61s]
2018-02-07 16:21:56,769: 16:21:56 | 21 of 29 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.64s]
2018-02-07 16:21:56,770: 16:21:56 | 22 of 29 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-07 16:21:56,771: Compiling model.seo_audit.semrush_url_stats
2018-02-07 16:21:56,770: 16:21:56 | 23 of 29 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-07 16:21:56,779: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-07 16:21:56,770: 16:21:56 | 24 of 29 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-07 16:21:56,780: Compiling model.seo_audit.semrush_keyword_stats
2018-02-07 16:21:56,770: 16:21:56 | 25 of 29 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-07 16:21:56,780: Compiling model.seo_audit.majestic_domain_stats
2018-02-07 16:21:56,785: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-07 16:21:56,786: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-07 16:21:56,790: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-07 16:21:56,791: Acquiring new bigquery connection "semrush_url_stats".
2018-02-07 16:21:56,803: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-07 16:21:56,804: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-07 16:21:56,804: Re-using an available connection from the pool.
2018-02-07 16:21:56,805: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-07 16:21:56,806: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-07 16:21:56,806: Re-using an available connection from the pool.
2018-02-07 16:21:56,812: Re-using an available connection from the pool.
2018-02-07 16:21:56,814: Re-using an available connection from the pool.
2018-02-07 16:21:56,997: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:21:57,019: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-07 16:21:57,021: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-07 16:21:57,060: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-07 16:21:57,333: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b035a58>]}
2018-02-07 16:21:57,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0dbbe0>]}
2018-02-07 16:21:57,416: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b089b70>]}
2018-02-07 16:21:57,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0f0d68>]}
2018-02-07 16:21:57,641: 16:21:57 | 22 of 29 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.56s]
2018-02-07 16:21:57,893: 16:21:57 | 24 of 29 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.59s]
2018-02-07 16:21:58,196: 16:21:58 | 23 of 29 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.64s]
2018-02-07 16:21:58,525: 16:21:58 | 25 of 29 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.69s]
2018-02-07 16:21:58,526: 16:21:58 | 26 of 29 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-07 16:21:58,526: Compiling model.seo_audit.agg_indicative
2018-02-07 16:21:58,535: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-07 16:21:58,536: Acquiring new bigquery connection "agg_indicative".
2018-02-07 16:21:58,536: Re-using an available connection from the pool.
2018-02-07 16:21:58,740: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-07 16:21:59,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b045f98>]}
2018-02-07 16:21:59,384: 16:21:59 | 26 of 29 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.65s]
2018-02-07 16:21:59,385: 16:21:59 | 27 of 29 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-07 16:21:59,385: Compiling model.seo_audit.agg_stats
2018-02-07 16:21:59,398: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-07 16:21:59,399: Acquiring new bigquery connection "agg_stats".
2018-02-07 16:21:59,399: Re-using an available connection from the pool.
2018-02-07 16:21:59,597: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-07 16:22:00,234: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0dbbe0>]}
2018-02-07 16:22:00,522: 16:22:00 | 27 of 29 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.85s]
2018-02-07 16:22:00,523: 16:22:00 | 28 of 29 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-07 16:22:00,523: Compiling model.seo_audit.agg_stats_client
2018-02-07 16:22:00,531: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-07 16:22:00,532: Acquiring new bigquery connection "agg_stats_client".
2018-02-07 16:22:00,532: Re-using an available connection from the pool.
2018-02-07 16:22:00,764: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-07 16:22:01,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0f0198>]}
2018-02-07 16:22:01,766: 16:22:01 | 28 of 29 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.01s]
2018-02-07 16:22:01,767: 16:22:01 | 29 of 29 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-07 16:22:01,767: Compiling model.seo_audit.agg_all
2018-02-07 16:22:01,777: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-07 16:22:01,778: Acquiring new bigquery connection "agg_all".
2018-02-07 16:22:01,778: Re-using an available connection from the pool.
2018-02-07 16:22:01,967: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-07 16:22:02,966: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea0d5774-4fcb-4e5d-bab1-16be05e46971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b0dbbe0>]}
2018-02-07 16:22:03,254: 16:22:03 | 29 of 29 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.20s]
2018-02-07 16:22:03,337: 16:22:03 | 
2018-02-07 16:22:03,337: 16:22:03 | Finished running 29 view models in 15.35s.
2018-02-07 16:22:03,337: Connection 'master' was left open.
2018-02-07 16:22:03,337: 
2018-02-07 16:22:03,338: Completed successfully
2018-02-07 16:22:03,338: 
Done. PASS=29 ERROR=0 SKIP=0 TOTAL=29
2018-02-07 16:22:03,338: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afed7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afed518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afed5f8>]}
2018-02-07 16:22:03,632: Flushing usage events
2018-02-08 09:16:39,165: Tracking: tracking
2018-02-08 09:16:39,170: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108121710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108121cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108121048>]}
2018-02-08 09:16:39,958: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:16:39,975: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:16:39,979: Parsing core.sql
2018-02-08 09:16:40,005: Parsing adapters/bigquery.sql
2018-02-08 09:16:40,013: Parsing adapters/common.sql
2018-02-08 09:16:40,029: Parsing adapters/postgres.sql
2018-02-08 09:16:40,035: Parsing adapters/redshift.sql
2018-02-08 09:16:40,068: Parsing etc/get_custom_schema.sql
2018-02-08 09:16:40,076: Parsing materializations/archive.sql
2018-02-08 09:16:40,107: Parsing materializations/bigquery.sql
2018-02-08 09:16:40,123: Parsing materializations/helpers.sql
2018-02-08 09:16:40,147: Parsing materializations/incremental.sql
2018-02-08 09:16:40,174: Parsing materializations/table.sql
2018-02-08 09:16:40,194: Parsing materializations/view.sql
2018-02-08 09:16:40,212: Parsing materializations/wrapper.sql
2018-02-08 09:16:40,220: Parsing schema_tests/accepted_values.sql
2018-02-08 09:16:40,228: Parsing schema_tests/not_null.sql
2018-02-08 09:16:40,234: Parsing schema_tests/relationships.sql
2018-02-08 09:16:40,241: Parsing schema_tests/unique.sql
2018-02-08 09:16:40,375: Parsing model.seo_audit.accounts_proc
2018-02-08 09:16:40,379: Parsing model.seo_audit.all_dates
2018-02-08 09:16:40,381: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:16:40,385: Acquiring new bigquery connection "master".
2018-02-08 09:16:40,385: Opening a new connection (0 currently allocated)
2018-02-08 09:16:40,395: Parsing model.seo_audit.agg_all
2018-02-08 09:16:40,399: Parsing model.seo_audit.agg_indicative
2018-02-08 09:16:40,402: Parsing model.seo_audit.agg_stats
2018-02-08 09:16:40,407: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:16:40,409: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:16:40,412: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:16:40,415: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:16:40,417: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:16:40,421: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:16:40,425: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:16:40,427: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:16:40,429: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:16:40,430: Parsing model.seo_audit.ga_proc
2018-02-08 09:16:40,433: Parsing model.seo_audit.ga_stats
2018-02-08 09:16:40,435: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:16:40,437: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:16:40,439: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:16:40,441: Parsing model.seo_audit.moz_proc
2018-02-08 09:16:40,445: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:16:40,448: Parsing model.seo_audit.search_console_history
2018-02-08 09:16:40,449: Parsing model.seo_audit.search_console_proc
2018-02-08 09:16:40,452: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:16:40,455: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:16:40,456: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:16:40,459: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:16:40,461: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:16:40,464: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:16:40,466: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:16:40,468: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:16:40,470: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:16:40,484: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:16:40,498: 
2018-02-08 09:16:41,701: 09:16:41 | Concurrency: 4 threads (target='dev')
2018-02-08 09:16:41,701: 09:16:41 | 
2018-02-08 09:16:41,900: 09:16:41 | 1 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:16:41,900: Compiling model.seo_audit.all_dates
2018-02-08 09:16:41,904: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:16:41,904: 09:16:41 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:16:41,905: Compiling model.seo_audit.accounts_proc
2018-02-08 09:16:41,904: 09:16:41 | 3 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:16:41,910: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:16:41,910: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:16:41,915: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:16:41,915: Acquiring new bigquery connection "all_dates".
2018-02-08 09:16:41,916: Opening a new connection (1 currently allocated)
2018-02-08 09:16:41,918: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:16:41,920: Opening a new connection (2 currently allocated)
2018-02-08 09:16:42,040: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:16:42,042: Opening a new connection (3 currently allocated)
2018-02-08 09:16:42,530: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:16:42,535: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:16:42,541: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:16:42,782: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082f1b38>]}
2018-02-08 09:16:42,782: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108303d68>]}
2018-02-08 09:16:42,784: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082d17b8>]}
2018-02-08 09:16:42,987: 09:16:42 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.88s]
2018-02-08 09:16:43,198: 09:16:43 | 3 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.87s]
2018-02-08 09:16:43,490: 09:16:43 | 1 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.88s]
2018-02-08 09:16:43,491: 09:16:43 | 4 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:16:43,492: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:16:43,491: 09:16:43 | 5 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:16:43,491: 09:16:43 | 6 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:16:43,503: Compiling model.seo_audit.moz_proc
2018-02-08 09:16:43,503: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:16:43,491: 09:16:43 | 7 of 33 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 09:16:43,503: Compiling model.seo_audit.search_console_proc
2018-02-08 09:16:43,515: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:16:43,515: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:16:43,526: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:16:43,539: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:16:43,541: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:16:43,542: Re-using an available connection from the pool.
2018-02-08 09:16:43,546: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:16:43,546: Re-using an available connection from the pool.
2018-02-08 09:16:43,549: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:16:43,550: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:16:43,550: Re-using an available connection from the pool.
2018-02-08 09:16:43,557: Opening a new connection (4 currently allocated)
2018-02-08 09:16:43,752: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:16:43,767: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:16:43,820: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:16:44,022: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:16:44,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082439b0>]}
2018-02-08 09:16:44,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108243780>]}
2018-02-08 09:16:44,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108314a20>]}
2018-02-08 09:16:44,336: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082f1a90>]}
2018-02-08 09:16:44,399: 09:16:44 | 4 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.61s]
2018-02-08 09:16:44,400: 09:16:44 | 8 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:16:44,400: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:16:44,410: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:16:44,412: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:16:44,413: Re-using an available connection from the pool.
2018-02-08 09:16:44,619: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:16:44,735: 09:16:44 | 6 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.63s]
2018-02-08 09:16:44,736: 09:16:44 | 9 of 33 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:16:44,737: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:16:44,747: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:16:44,749: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:16:44,749: Re-using an available connection from the pool.
2018-02-08 09:16:44,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10832f160>]}
2018-02-08 09:16:44,961: 09:16:44 | 5 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.63s]
2018-02-08 09:16:44,962: 09:16:44 | 10 of 33 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 09:16:44,962: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:16:44,970: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:16:44,973: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:16:44,973: Re-using an available connection from the pool.
2018-02-08 09:16:44,982: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:16:45,201: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:16:45,288: 09:16:45 | 7 of 33 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.82s]
2018-02-08 09:16:45,289: 09:16:45 | 11 of 33 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 09:16:45,292: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:16:45,303: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:16:45,304: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:16:45,304: Re-using an available connection from the pool.
2018-02-08 09:16:45,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108243780>]}
2018-02-08 09:16:45,504: 09:16:45 | 8 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.54s]
2018-02-08 09:16:45,505: 09:16:45 | 12 of 33 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 09:16:45,506: Compiling model.seo_audit.ga_proc
2018-02-08 09:16:45,520: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:16:45,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081efe80>]}
2018-02-08 09:16:45,525: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:16:45,525: Re-using an available connection from the pool.
2018-02-08 09:16:45,534: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:16:45,722: 09:16:45 | 9 of 33 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.64s]
2018-02-08 09:16:45,723: 09:16:45 | 13 of 33 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 09:16:45,723: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:16:45,728: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:16:45,733: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:16:45,734: Re-using an available connection from the pool.
2018-02-08 09:16:45,777: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:16:45,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108207b00>]}
2018-02-08 09:16:45,932: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:16:46,028: 09:16:46 | 10 of 33 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.56s]
2018-02-08 09:16:46,066: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082fdc50>]}
2018-02-08 09:16:46,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108303e48>]}
2018-02-08 09:16:46,313: 09:16:46 | 11 of 33 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.53s]
2018-02-08 09:16:46,615: 09:16:46 | 12 of 33 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.56s]
2018-02-08 09:16:46,827: 09:16:46 | 13 of 33 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.53s]
2018-02-08 09:16:46,828: 09:16:46 | 14 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:16:46,829: Compiling model.seo_audit.ga_stats
2018-02-08 09:16:46,829: 09:16:46 | 15 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:16:46,838: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:16:46,829: 09:16:46 | 16 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:16:46,839: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:16:46,829: 09:16:46 | 17 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:16:46,839: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:16:46,844: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:16:46,845: Compiling model.seo_audit.search_console_history
2018-02-08 09:16:46,845: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:16:46,862: Re-using an available connection from the pool.
2018-02-08 09:16:46,851: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:16:46,862: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:16:46,868: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:16:46,869: Re-using an available connection from the pool.
2018-02-08 09:16:46,872: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:16:46,872: Re-using an available connection from the pool.
2018-02-08 09:16:46,879: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:16:46,880: Re-using an available connection from the pool.
2018-02-08 09:16:47,075: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:16:47,085: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:16:47,090: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:16:47,091: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:16:47,378: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082666d8>]}
2018-02-08 09:16:47,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082fdd68>]}
2018-02-08 09:16:47,416: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108222f28>]}
2018-02-08 09:16:47,425: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10825ad30>]}
2018-02-08 09:16:47,671: 09:16:47 | 17 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.53s]
2018-02-08 09:16:47,672: 09:16:47 | 18 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:16:47,674: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:16:47,685: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:16:47,688: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:16:47,688: Re-using an available connection from the pool.
2018-02-08 09:16:47,889: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:16:47,899: 09:16:47 | 16 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.57s]
2018-02-08 09:16:48,187: 09:16:48 | 15 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.58s]
2018-02-08 09:16:48,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108257a58>]}
2018-02-08 09:16:48,404: 09:16:48 | 14 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.60s]
2018-02-08 09:16:48,744: 09:16:48 | 18 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.52s]
2018-02-08 09:16:48,745: 09:16:48 | 19 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:16:48,745: 09:16:48 | 20 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:16:48,745: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:16:48,746: 09:16:48 | 21 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:16:48,746: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:16:48,753: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:16:48,754: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:16:48,764: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:16:48,764: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:16:48,766: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:16:48,766: Re-using an available connection from the pool.
2018-02-08 09:16:48,767: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:16:48,767: Re-using an available connection from the pool.
2018-02-08 09:16:48,771: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:16:48,772: Re-using an available connection from the pool.
2018-02-08 09:16:48,944: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:16:48,972: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:16:48,987: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:16:49,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082f1a90>]}
2018-02-08 09:16:49,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081efe80>]}
2018-02-08 09:16:49,378: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082666d8>]}
2018-02-08 09:16:49,623: 09:16:49 | 20 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.57s]
2018-02-08 09:16:49,821: 09:16:49 | 19 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.58s]
2018-02-08 09:16:50,109: 09:16:50 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.63s]
2018-02-08 09:16:50,110: 09:16:50 | 22 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:16:50,110: 09:16:50 | 23 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:16:50,111: 09:16:50 | 24 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:16:50,111: 09:16:50 | 25 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:16:50,111: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:16:50,111: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:16:50,111: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:16:50,112: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:16:50,123: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:16:50,123: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:16:50,128: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:16:50,134: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:16:50,135: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:16:50,136: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:16:50,136: Re-using an available connection from the pool.
2018-02-08 09:16:50,136: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:16:50,137: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:16:50,139: Re-using an available connection from the pool.
2018-02-08 09:16:50,139: Re-using an available connection from the pool.
2018-02-08 09:16:50,140: Re-using an available connection from the pool.
2018-02-08 09:16:50,341: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:16:50,347: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:16:50,359: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:16:50,381: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:16:50,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082f1a90>]}
2018-02-08 09:16:50,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108257a58>]}
2018-02-08 09:16:50,921: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108303f98>]}
2018-02-08 09:16:50,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082fdef0>]}
2018-02-08 09:16:51,175: 09:16:51 | 23 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.81s]
2018-02-08 09:16:51,492: 09:16:51 | 22 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.81s]
2018-02-08 09:16:51,707: 09:16:51 | 25 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.81s]
2018-02-08 09:16:52,001: 09:16:52 | 24 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.81s]
2018-02-08 09:16:52,002: 09:16:52 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:16:52,002: 09:16:52 | 27 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:16:52,003: 09:16:52 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:16:52,003: 09:16:52 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:16:52,003: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:16:52,003: Compiling model.seo_audit.agg_indicative
2018-02-08 09:16:52,004: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:16:52,004: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:16:52,021: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:16:52,022: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:16:52,023: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:16:52,027: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:16:52,029: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:16:52,029: Re-using an available connection from the pool.
2018-02-08 09:16:52,030: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:16:52,030: Re-using an available connection from the pool.
2018-02-08 09:16:52,031: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:16:52,032: Re-using an available connection from the pool.
2018-02-08 09:16:52,033: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:16:52,033: Re-using an available connection from the pool.
2018-02-08 09:16:52,120: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:16:52,125: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:16:52,138: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:16:52,308: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:16:52,655: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082666d8>]}
2018-02-08 09:16:52,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082d17b8>]}
2018-02-08 09:16:52,657: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108314fd0>]}
2018-02-08 09:16:52,755: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082d1438>]}
2018-02-08 09:16:52,941: 09:16:52 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.65s]
2018-02-08 09:16:53,146: 09:16:53 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.65s]
2018-02-08 09:16:53,437: 09:16:53 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.65s]
2018-02-08 09:16:53,648: 09:16:53 | 27 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.75s]
2018-02-08 09:16:53,648: 09:16:53 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:16:53,649: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:16:53,659: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:16:53,660: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:16:53,660: Re-using an available connection from the pool.
2018-02-08 09:16:53,752: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass
classification,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:16:53,856: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass
classification,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:16:53,857: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Unexpected identifier "classification" at [23:1]
2018-02-08 09:16:53,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108309fd0>]}
2018-02-08 09:16:54,150: 09:16:54 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.21s]
2018-02-08 09:16:54,151: 09:16:54 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:16:54,151: Compiling model.seo_audit.agg_stats
2018-02-08 09:16:54,164: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:16:54,165: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:16:54,165: Re-using an available connection from the pool.
2018-02-08 09:16:54,343: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:16:54,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082666d8>]}
2018-02-08 09:16:55,212: 09:16:55 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.78s]
2018-02-08 09:16:55,212: 09:16:55 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:16:55,213: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:16:55,222: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:16:55,223: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:16:55,223: Re-using an available connection from the pool.
2018-02-08 09:16:55,457: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:16:56,191: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081efe80>]}
2018-02-08 09:16:56,486: 09:16:56 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.98s]
2018-02-08 09:16:56,487: 09:16:56 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:16:56,488: Compiling model.seo_audit.agg_all
2018-02-08 09:16:56,496: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:16:56,497: Acquiring new bigquery connection "agg_all".
2018-02-08 09:16:56,497: Re-using an available connection from the pool.
2018-02-08 09:16:56,705: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:16:57,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '744ca3bb-dc39-454a-b07f-8eef329b791e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082666d8>]}
2018-02-08 09:16:57,981: 09:16:57 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.28s]
2018-02-08 09:16:58,069: 09:16:58 | 
2018-02-08 09:16:58,069: 09:16:58 | Finished running 33 view models in 16.37s.
2018-02-08 09:16:58,069: Connection 'master' was left open.
2018-02-08 09:16:58,069: 
2018-02-08 09:16:58,069: Completed with 1 errors:
2018-02-08 09:16:58,070: 
2018-02-08 09:16:58,070: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:16:58,070:   Syntax error: Unexpected identifier "classification" at [23:1]
2018-02-08 09:16:58,070:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:16:58,070: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:16:58,071: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081ef780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081eff60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081ef4e0>]}
2018-02-08 09:16:58,308: Flushing usage events
2018-02-08 09:17:32,296: Tracking: tracking
2018-02-08 09:17:32,298: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137d7710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137d7cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137d7048>]}
2018-02-08 09:17:32,670: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:17:32,691: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:17:32,694: Parsing core.sql
2018-02-08 09:17:32,713: Parsing adapters/bigquery.sql
2018-02-08 09:17:32,720: Parsing adapters/common.sql
2018-02-08 09:17:32,736: Parsing adapters/postgres.sql
2018-02-08 09:17:32,741: Parsing adapters/redshift.sql
2018-02-08 09:17:32,761: Parsing etc/get_custom_schema.sql
2018-02-08 09:17:32,773: Parsing materializations/archive.sql
2018-02-08 09:17:32,812: Parsing materializations/bigquery.sql
2018-02-08 09:17:32,833: Parsing materializations/helpers.sql
2018-02-08 09:17:32,855: Parsing materializations/incremental.sql
2018-02-08 09:17:32,889: Parsing materializations/table.sql
2018-02-08 09:17:32,914: Parsing materializations/view.sql
2018-02-08 09:17:32,931: Parsing materializations/wrapper.sql
2018-02-08 09:17:32,937: Parsing schema_tests/accepted_values.sql
2018-02-08 09:17:32,945: Parsing schema_tests/not_null.sql
2018-02-08 09:17:32,951: Parsing schema_tests/relationships.sql
2018-02-08 09:17:32,958: Parsing schema_tests/unique.sql
2018-02-08 09:17:33,011: Parsing model.seo_audit.accounts_proc
2018-02-08 09:17:33,015: Parsing model.seo_audit.all_dates
2018-02-08 09:17:33,016: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:17:33,018: Acquiring new bigquery connection "master".
2018-02-08 09:17:33,018: Opening a new connection (0 currently allocated)
2018-02-08 09:17:33,023: Parsing model.seo_audit.agg_all
2018-02-08 09:17:33,026: Parsing model.seo_audit.agg_indicative
2018-02-08 09:17:33,028: Parsing model.seo_audit.agg_stats
2018-02-08 09:17:33,032: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:17:33,035: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:17:33,038: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:17:33,040: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:17:33,043: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:17:33,045: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:17:33,048: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:17:33,050: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:17:33,051: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:17:33,053: Parsing model.seo_audit.ga_proc
2018-02-08 09:17:33,056: Parsing model.seo_audit.ga_stats
2018-02-08 09:17:33,058: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:17:33,060: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:17:33,062: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:17:33,064: Parsing model.seo_audit.moz_proc
2018-02-08 09:17:33,066: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:17:33,069: Parsing model.seo_audit.search_console_history
2018-02-08 09:17:33,071: Parsing model.seo_audit.search_console_proc
2018-02-08 09:17:33,073: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:17:33,078: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:17:33,081: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:17:33,085: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:17:33,088: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:17:33,091: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:17:33,093: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:17:33,095: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:17:33,097: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:17:33,107: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:17:33,115: 
2018-02-08 09:17:33,818: 09:17:33 | Concurrency: 4 threads (target='dev')
2018-02-08 09:17:33,818: 09:17:33 | 
2018-02-08 09:17:34,003: 09:17:34 | 1 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:17:34,003: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:17:34,003: 09:17:34 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:17:34,008: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:17:34,003: 09:17:34 | 3 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:17:34,008: Compiling model.seo_audit.accounts_proc
2018-02-08 09:17:34,008: Compiling model.seo_audit.all_dates
2018-02-08 09:17:34,013: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:17:34,017: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:17:34,018: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:17:34,018: Opening a new connection (1 currently allocated)
2018-02-08 09:17:34,019: Acquiring new bigquery connection "all_dates".
2018-02-08 09:17:34,021: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:17:34,080: Opening a new connection (2 currently allocated)
2018-02-08 09:17:34,089: Opening a new connection (3 currently allocated)
2018-02-08 09:17:34,578: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:17:34,643: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:17:34,649: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:17:34,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113989da0>]}
2018-02-08 09:17:34,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138da2e8>]}
2018-02-08 09:17:34,855: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139b3c88>]}
2018-02-08 09:17:35,101: 09:17:35 | 1 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.80s]
2018-02-08 09:17:35,322: 09:17:35 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.85s]
2018-02-08 09:17:35,577: 09:17:35 | 3 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.85s]
2018-02-08 09:17:35,578: 09:17:35 | 4 of 33 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:17:35,579: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:17:35,588: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:17:35,578: 09:17:35 | 5 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:17:35,588: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:17:35,578: 09:17:35 | 6 of 33 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 09:17:35,594: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:17:35,579: 09:17:35 | 7 of 33 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 09:17:35,594: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:17:35,594: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:17:35,595: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:17:35,610: Re-using an available connection from the pool.
2018-02-08 09:17:35,606: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:17:35,610: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:17:35,616: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:17:35,600: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:17:35,622: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:17:35,622: Re-using an available connection from the pool.
2018-02-08 09:17:35,624: Re-using an available connection from the pool.
2018-02-08 09:17:35,632: Opening a new connection (4 currently allocated)
2018-02-08 09:17:35,830: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:17:35,884: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:17:35,924: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:17:36,153: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139b3da0>]}
2018-02-08 09:17:36,182: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:17:36,186: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcb38>]}
2018-02-08 09:17:36,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930128>]}
2018-02-08 09:17:36,423: 09:17:36 | 4 of 33 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.57s]
2018-02-08 09:17:36,425: 09:17:36 | 8 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:17:36,425: Compiling model.seo_audit.moz_proc
2018-02-08 09:17:36,437: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:17:36,439: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:17:36,439: Re-using an available connection from the pool.
2018-02-08 09:17:36,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139aee48>]}
2018-02-08 09:17:36,637: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:17:36,649: 09:17:36 | 5 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.60s]
2018-02-08 09:17:36,650: 09:17:36 | 9 of 33 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 09:17:36,650: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:17:36,661: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:17:36,664: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:17:36,664: Re-using an available connection from the pool.
2018-02-08 09:17:36,867: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:17:36,918: 09:17:36 | 7 of 33 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.61s]
2018-02-08 09:17:36,918: 09:17:36 | 10 of 33 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 09:17:36,919: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:17:36,924: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:17:36,929: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcf98>]}
2018-02-08 09:17:36,930: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:17:36,931: Re-using an available connection from the pool.
2018-02-08 09:17:37,121: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:17:37,184: 09:17:37 | 6 of 33 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 1.00s]
2018-02-08 09:17:37,185: 09:17:37 | 11 of 33 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 09:17:37,186: Compiling model.seo_audit.ga_proc
2018-02-08 09:17:37,199: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:17:37,202: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:17:37,202: Re-using an available connection from the pool.
2018-02-08 09:17:37,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcb38>]}
2018-02-08 09:17:37,420: 09:17:37 | 8 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.50s]
2018-02-08 09:17:37,421: 09:17:37 | 12 of 33 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 09:17:37,421: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:17:37,433: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:17:37,435: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:17:37,438: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:17:37,438: Re-using an available connection from the pool.
2018-02-08 09:17:37,617: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138a6eb8>]}
2018-02-08 09:17:37,654: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:17:37,667: 09:17:37 | 9 of 33 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.57s]
2018-02-08 09:17:37,669: 09:17:37 | 13 of 33 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 09:17:37,671: Compiling model.seo_audit.search_console_proc
2018-02-08 09:17:37,678: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:17:37,681: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:17:37,681: Re-using an available connection from the pool.
2018-02-08 09:17:37,880: 09:17:37 | 10 of 33 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.70s]
2018-02-08 09:17:37,890: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:17:38,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcf98>]}
2018-02-08 09:17:38,049: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139b3198>]}
2018-02-08 09:17:38,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcb38>]}
2018-02-08 09:17:38,238: 09:17:38 | 12 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.61s]
2018-02-08 09:17:38,538: 09:17:38 | 11 of 33 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.86s]
2018-02-08 09:17:38,857: 09:17:38 | 13 of 33 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.51s]
2018-02-08 09:17:38,858: 09:17:38 | 14 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:17:38,858: 09:17:38 | 15 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:17:38,858: 09:17:38 | 16 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:17:38,859: 09:17:38 | 17 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:17:38,859: Compiling model.seo_audit.search_console_history
2018-02-08 09:17:38,859: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:17:38,859: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:17:38,859: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:17:38,875: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:17:38,878: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:17:38,890: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:17:38,890: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:17:38,892: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:17:38,893: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:17:38,893: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:17:38,894: Re-using an available connection from the pool.
2018-02-08 09:17:38,894: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:17:38,895: Re-using an available connection from the pool.
2018-02-08 09:17:38,896: Re-using an available connection from the pool.
2018-02-08 09:17:38,897: Re-using an available connection from the pool.
2018-02-08 09:17:39,084: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:17:39,118: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:17:39,122: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:17:39,132: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:17:39,448: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113910438>]}
2018-02-08 09:17:39,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138a6eb8>]}
2018-02-08 09:17:39,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139cd1d0>]}
2018-02-08 09:17:39,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930128>]}
2018-02-08 09:17:40,114: 09:17:40 | 17 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.59s]
2018-02-08 09:17:40,115: 09:17:40 | 18 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:17:40,116: Compiling model.seo_audit.ga_stats
2018-02-08 09:17:40,127: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:17:40,130: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:17:40,130: Re-using an available connection from the pool.
2018-02-08 09:17:40,328: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:17:40,346: 09:17:40 | 14 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.62s]
2018-02-08 09:17:40,627: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113910438>]}
2018-02-08 09:17:40,672: 09:17:40 | 16 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.62s]
2018-02-08 09:17:40,924: 09:17:40 | 15 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.62s]
2018-02-08 09:17:41,225: 09:17:41 | 18 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.51s]
2018-02-08 09:17:41,226: 09:17:41 | 19 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:17:41,226: 09:17:41 | 20 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:17:41,226: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:17:41,227: 09:17:41 | 21 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:17:41,227: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:17:41,237: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:17:41,238: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:17:41,250: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:17:41,250: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:17:41,252: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:17:41,252: Re-using an available connection from the pool.
2018-02-08 09:17:41,252: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:17:41,252: Re-using an available connection from the pool.
2018-02-08 09:17:41,256: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:17:41,258: Re-using an available connection from the pool.
2018-02-08 09:17:41,473: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:17:41,482: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:17:41,494: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:17:41,910: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139cd828>]}
2018-02-08 09:17:41,912: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcb38>]}
2018-02-08 09:17:41,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930eb8>]}
2018-02-08 09:17:42,119: 09:17:42 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.67s]
2018-02-08 09:17:42,341: 09:17:42 | 19 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.69s]
2018-02-08 09:17:42,631: 09:17:42 | 20 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.69s]
2018-02-08 09:17:42,632: 09:17:42 | 22 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:17:42,632: 09:17:42 | 23 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:17:42,633: 09:17:42 | 24 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:17:42,633: 09:17:42 | 25 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:17:42,633: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:17:42,633: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:17:42,634: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:17:42,634: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:17:42,650: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:17:42,664: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:17:42,668: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:17:42,672: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:17:42,675: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:17:42,676: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:17:42,677: Re-using an available connection from the pool.
2018-02-08 09:17:42,677: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:17:42,678: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:17:42,678: Re-using an available connection from the pool.
2018-02-08 09:17:42,680: Re-using an available connection from the pool.
2018-02-08 09:17:42,680: Re-using an available connection from the pool.
2018-02-08 09:17:42,875: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:17:42,877: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:17:42,896: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:17:42,918: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:17:43,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113910438>]}
2018-02-08 09:17:43,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138bcb38>]}
2018-02-08 09:17:43,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138fba58>]}
2018-02-08 09:17:43,350: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113989e48>]}
2018-02-08 09:17:43,533: 09:17:43 | 22 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.61s]
2018-02-08 09:17:43,738: 09:17:43 | 23 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.61s]
2018-02-08 09:17:43,998: 09:17:43 | 24 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.61s]
2018-02-08 09:17:44,382: 09:17:44 | 25 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.72s]
2018-02-08 09:17:44,383: 09:17:44 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:17:44,383: 09:17:44 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:17:44,383: 09:17:44 | 28 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:17:44,384: 09:17:44 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:17:44,384: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:17:44,384: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:17:44,385: Compiling model.seo_audit.agg_indicative
2018-02-08 09:17:44,385: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:17:44,402: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:17:44,402: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:17:44,405: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:17:44,411: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:17:44,413: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:17:44,413: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:17:44,414: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:17:44,414: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:17:44,414: Re-using an available connection from the pool.
2018-02-08 09:17:44,415: Re-using an available connection from the pool.
2018-02-08 09:17:44,415: Re-using an available connection from the pool.
2018-02-08 09:17:44,418: Re-using an available connection from the pool.
2018-02-08 09:17:44,609: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:17:44,624: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:17:44,628: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:17:44,695: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:17:45,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930eb8>]}
2018-02-08 09:17:45,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139bbc88>]}
2018-02-08 09:17:45,190: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139bb550>]}
2018-02-08 09:17:45,191: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139bbe48>]}
2018-02-08 09:17:45,412: 09:17:45 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.80s]
2018-02-08 09:17:45,695: 09:17:45 | 28 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.80s]
2018-02-08 09:17:46,003: 09:17:46 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.81s]
2018-02-08 09:17:46,311: 09:17:46 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.81s]
2018-02-08 09:17:46,312: 09:17:46 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:17:46,312: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:17:46,321: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:17:46,322: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:17:46,323: Re-using an available connection from the pool.
2018-02-08 09:17:46,401: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass
classification,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:17:46,501: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass
classification,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:17:46,501: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Unexpected identifier "classification" at [23:1]
2018-02-08 09:17:46,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113910438>]}
2018-02-08 09:17:46,728: 09:17:46 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.19s]
2018-02-08 09:17:46,729: 09:17:46 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:17:46,729: Compiling model.seo_audit.agg_stats
2018-02-08 09:17:46,742: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:17:46,743: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:17:46,743: Re-using an available connection from the pool.
2018-02-08 09:17:46,936: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:17:47,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930eb8>]}
2018-02-08 09:17:47,827: 09:17:47 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.81s]
2018-02-08 09:17:47,828: 09:17:47 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:17:47,828: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:17:47,839: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:17:47,840: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:17:47,840: Re-using an available connection from the pool.
2018-02-08 09:17:48,032: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:17:48,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113910438>]}
2018-02-08 09:17:48,972: 09:17:48 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.84s]
2018-02-08 09:17:48,973: 09:17:48 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:17:48,973: Compiling model.seo_audit.agg_all
2018-02-08 09:17:48,983: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:17:48,984: Acquiring new bigquery connection "agg_all".
2018-02-08 09:17:48,984: Re-using an available connection from the pool.
2018-02-08 09:17:49,181: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:17:49,996: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07bab76c-8e24-4eea-91f8-bc5b6497ceb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113930eb8>]}
2018-02-08 09:17:50,206: 09:17:50 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.02s]
2018-02-08 09:17:50,302: 09:17:50 | 
2018-02-08 09:17:50,302: 09:17:50 | Finished running 33 view models in 16.49s.
2018-02-08 09:17:50,302: Connection 'master' was left open.
2018-02-08 09:17:50,303: 
2018-02-08 09:17:50,303: Completed with 1 errors:
2018-02-08 09:17:50,303: 
2018-02-08 09:17:50,304: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:17:50,304:   Syntax error: Unexpected identifier "classification" at [23:1]
2018-02-08 09:17:50,304:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:17:50,305: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:17:50,305: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138a67b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138a6518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1138a65f8>]}
2018-02-08 09:17:50,569: Flushing usage events
2018-02-08 09:18:24,467: Tracking: tracking
2018-02-08 09:18:24,468: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cccfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ccceb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ccce80>]}
2018-02-08 09:18:24,750: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:18:24,764: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:18:24,769: Parsing core.sql
2018-02-08 09:18:24,788: Parsing adapters/bigquery.sql
2018-02-08 09:18:24,794: Parsing adapters/common.sql
2018-02-08 09:18:24,807: Parsing adapters/postgres.sql
2018-02-08 09:18:24,809: Parsing adapters/redshift.sql
2018-02-08 09:18:24,827: Parsing etc/get_custom_schema.sql
2018-02-08 09:18:24,832: Parsing materializations/archive.sql
2018-02-08 09:18:24,863: Parsing materializations/bigquery.sql
2018-02-08 09:18:24,876: Parsing materializations/helpers.sql
2018-02-08 09:18:24,897: Parsing materializations/incremental.sql
2018-02-08 09:18:24,927: Parsing materializations/table.sql
2018-02-08 09:18:24,946: Parsing materializations/view.sql
2018-02-08 09:18:24,960: Parsing materializations/wrapper.sql
2018-02-08 09:18:24,963: Parsing schema_tests/accepted_values.sql
2018-02-08 09:18:24,966: Parsing schema_tests/not_null.sql
2018-02-08 09:18:24,968: Parsing schema_tests/relationships.sql
2018-02-08 09:18:24,970: Parsing schema_tests/unique.sql
2018-02-08 09:18:24,978: Parsing model.seo_audit.accounts_proc
2018-02-08 09:18:24,980: Parsing model.seo_audit.all_dates
2018-02-08 09:18:24,981: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:18:24,984: Acquiring new bigquery connection "master".
2018-02-08 09:18:24,984: Opening a new connection (0 currently allocated)
2018-02-08 09:18:24,985: Parsing model.seo_audit.agg_all
2018-02-08 09:18:24,988: Parsing model.seo_audit.agg_indicative
2018-02-08 09:18:24,990: Parsing model.seo_audit.agg_stats
2018-02-08 09:18:24,994: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:18:24,998: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:18:25,001: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:18:25,004: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:18:25,006: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:18:25,008: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:18:25,011: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:18:25,013: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:18:25,014: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:18:25,016: Parsing model.seo_audit.ga_proc
2018-02-08 09:18:25,018: Parsing model.seo_audit.ga_stats
2018-02-08 09:18:25,020: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:18:25,022: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:18:25,025: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:18:25,027: Parsing model.seo_audit.moz_proc
2018-02-08 09:18:25,029: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:18:25,032: Parsing model.seo_audit.search_console_history
2018-02-08 09:18:25,034: Parsing model.seo_audit.search_console_proc
2018-02-08 09:18:25,036: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:18:25,039: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:18:25,041: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:18:25,043: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:18:25,046: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:18:25,048: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:18:25,050: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:18:25,052: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:18:25,054: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:18:25,065: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:18:25,073: 
2018-02-08 09:18:25,429: 09:18:25 | Concurrency: 4 threads (target='dev')
2018-02-08 09:18:25,429: 09:18:25 | 
2018-02-08 09:18:25,658: 09:18:25 | 1 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:18:25,659: Compiling model.seo_audit.accounts_proc
2018-02-08 09:18:25,669: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:18:25,671: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:18:25,671: Opening a new connection (1 currently allocated)
2018-02-08 09:18:25,659: 09:18:25 | 2 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:18:25,659: 09:18:25 | 3 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:18:25,674: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:18:25,800: Compiling model.seo_audit.all_dates
2018-02-08 09:18:25,808: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:18:25,819: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:18:25,821: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:18:25,821: Acquiring new bigquery connection "all_dates".
2018-02-08 09:18:25,821: Opening a new connection (2 currently allocated)
2018-02-08 09:18:25,824: Opening a new connection (3 currently allocated)
2018-02-08 09:18:26,323: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:18:26,345: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:18:26,379: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:18:26,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e82470>]}
2018-02-08 09:18:26,534: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e824e0>]}
2018-02-08 09:18:26,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e82630>]}
2018-02-08 09:18:26,746: 09:18:26 | 1 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.87s]
2018-02-08 09:18:26,985: 09:18:26 | 2 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.86s]
2018-02-08 09:18:27,297: 09:18:27 | 3 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.74s]
2018-02-08 09:18:27,298: 09:18:27 | 4 of 33 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 09:18:27,298: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:18:27,311: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:18:27,304: 09:18:27 | 5 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:18:27,312: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:18:27,304: 09:18:27 | 6 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:18:27,323: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:18:27,305: 09:18:27 | 7 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:18:27,334: Compiling model.seo_audit.search_console_proc
2018-02-08 09:18:27,331: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:18:27,334: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:18:27,347: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:18:27,357: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:18:27,358: Re-using an available connection from the pool.
2018-02-08 09:18:27,359: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:18:27,360: Re-using an available connection from the pool.
2018-02-08 09:18:27,364: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:18:27,365: Re-using an available connection from the pool.
2018-02-08 09:18:27,374: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:18:27,375: Opening a new connection (4 currently allocated)
2018-02-08 09:18:27,564: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:18:27,568: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:18:27,589: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:18:27,855: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e04da0>]}
2018-02-08 09:18:27,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e049b0>]}
2018-02-08 09:18:27,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e827f0>]}
2018-02-08 09:18:28,062: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:18:28,072: 09:18:28 | 7 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.52s]
2018-02-08 09:18:28,073: 09:18:28 | 8 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:18:28,073: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:18:28,093: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:18:28,095: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:18:28,095: Re-using an available connection from the pool.
2018-02-08 09:18:28,345: 09:18:28 | 5 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.57s]
2018-02-08 09:18:28,350: 09:18:28 | 9 of 33 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 09:18:28,352: Compiling model.seo_audit.ga_proc
2018-02-08 09:18:28,365: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:18:28,366: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:18:28,367: Re-using an available connection from the pool.
2018-02-08 09:18:28,371: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:18:28,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111eab940>]}
2018-02-08 09:18:28,575: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:18:28,594: 09:18:28 | 4 of 33 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.59s]
2018-02-08 09:18:28,601: 09:18:28 | 10 of 33 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 09:18:28,603: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:18:28,613: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:18:28,617: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:18:28,617: Re-using an available connection from the pool.
2018-02-08 09:18:28,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e04da0>]}
2018-02-08 09:18:28,844: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:18:28,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ee02b0>]}
2018-02-08 09:18:28,904: 09:18:28 | 6 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 1.16s]
2018-02-08 09:18:28,905: 09:18:28 | 11 of 33 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 09:18:28,905: Compiling model.seo_audit.moz_proc
2018-02-08 09:18:28,914: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:18:28,916: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:18:28,917: Re-using an available connection from the pool.
2018-02-08 09:18:29,147: 09:18:29 | 8 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.63s]
2018-02-08 09:18:29,148: 09:18:29 | 12 of 33 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 09:18:29,149: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:18:29,160: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:18:29,163: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:18:29,167: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:18:29,170: Re-using an available connection from the pool.
2018-02-08 09:18:29,171: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e04208>]}
2018-02-08 09:18:29,379: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:18:29,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111db0ba8>]}
2018-02-08 09:18:29,467: 09:18:29 | 9 of 33 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.51s]
2018-02-08 09:18:29,468: 09:18:29 | 13 of 33 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 09:18:29,468: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:18:29,483: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:18:29,486: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:18:29,487: Re-using an available connection from the pool.
2018-02-08 09:18:29,644: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111db0ef0>]}
2018-02-08 09:18:29,707: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:18:29,716: 09:18:29 | 10 of 33 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.57s]
2018-02-08 09:18:29,924: 09:18:29 | 11 of 33 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.54s]
2018-02-08 09:18:30,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e82748>]}
2018-02-08 09:18:30,131: 09:18:30 | 12 of 33 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.50s]
2018-02-08 09:18:30,379: 09:18:30 | 13 of 33 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.64s]
2018-02-08 09:18:30,380: 09:18:30 | 14 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:18:30,381: Compiling model.seo_audit.ga_stats
2018-02-08 09:18:30,381: 09:18:30 | 15 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:18:30,382: 09:18:30 | 16 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:18:30,382: 09:18:30 | 17 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:18:30,388: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:18:30,393: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:18:30,394: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:18:30,394: Compiling model.seo_audit.search_console_history
2018-02-08 09:18:30,401: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:18:30,438: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:18:30,439: Re-using an available connection from the pool.
2018-02-08 09:18:30,410: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:18:30,455: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:18:30,435: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:18:30,458: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:18:30,458: Re-using an available connection from the pool.
2018-02-08 09:18:30,465: Re-using an available connection from the pool.
2018-02-08 09:18:30,436: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:18:30,474: Re-using an available connection from the pool.
2018-02-08 09:18:30,661: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:18:30,675: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:18:30,682: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:18:30,744: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:18:30,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ea7160>]}
2018-02-08 09:18:31,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111eabf60>]}
2018-02-08 09:18:31,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e049b0>]}
2018-02-08 09:18:31,121: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e82748>]}
2018-02-08 09:18:31,209: 09:18:31 | 14 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.61s]
2018-02-08 09:18:31,209: 09:18:31 | 18 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:18:31,209: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:18:31,221: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:18:31,224: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:18:31,224: Re-using an available connection from the pool.
2018-02-08 09:18:31,407: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:18:31,433: 09:18:31 | 17 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.61s]
2018-02-08 09:18:31,639: 09:18:31 | 16 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.66s]
2018-02-08 09:18:31,708: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ea7160>]}
2018-02-08 09:18:31,865: 09:18:31 | 15 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.73s]
2018-02-08 09:18:32,077: 09:18:32 | 18 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.50s]
2018-02-08 09:18:32,077: 09:18:32 | 19 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:18:32,078: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:18:32,077: 09:18:32 | 20 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:18:32,089: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:18:32,078: 09:18:32 | 21 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:18:32,089: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:18:32,099: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:18:32,099: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:18:32,109: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:18:32,110: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:18:32,113: Re-using an available connection from the pool.
2018-02-08 09:18:32,112: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:18:32,117: Re-using an available connection from the pool.
2018-02-08 09:18:32,113: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:18:32,122: Re-using an available connection from the pool.
2018-02-08 09:18:32,309: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:18:32,358: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:18:32,360: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:18:32,662: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e827f0>]}
2018-02-08 09:18:32,709: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111db0ef0>]}
2018-02-08 09:18:32,746: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e04208>]}
2018-02-08 09:18:32,961: 09:18:32 | 20 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.57s]
2018-02-08 09:18:33,165: 09:18:33 | 19 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.63s]
2018-02-08 09:18:33,460: 09:18:33 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-08 09:18:33,460: 09:18:33 | 22 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:18:33,461: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:18:33,460: 09:18:33 | 23 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:18:33,468: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:18:33,477: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:18:33,477: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:18:33,461: 09:18:33 | 24 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:18:33,461: 09:18:33 | 25 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:18:33,478: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:18:33,479: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:18:33,479: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:18:33,480: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:18:33,487: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:18:33,489: Re-using an available connection from the pool.
2018-02-08 09:18:33,501: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:18:33,503: Re-using an available connection from the pool.
2018-02-08 09:18:33,514: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:18:33,514: Re-using an available connection from the pool.
2018-02-08 09:18:33,521: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:18:33,527: Re-using an available connection from the pool.
2018-02-08 09:18:33,717: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:18:33,760: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:18:33,764: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:18:33,779: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:18:34,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ea7160>]}
2018-02-08 09:18:34,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e98080>]}
2018-02-08 09:18:34,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e987f0>]}
2018-02-08 09:18:34,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111db0ef0>]}
2018-02-08 09:18:34,444: 09:18:34 | 22 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.78s]
2018-02-08 09:18:34,728: 09:18:34 | 25 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.76s]
2018-02-08 09:18:34,932: 09:18:34 | 24 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.76s]
2018-02-08 09:18:35,245: 09:18:35 | 23 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.77s]
2018-02-08 09:18:35,245: 09:18:35 | 26 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:18:35,246: Compiling model.seo_audit.agg_indicative
2018-02-08 09:18:35,246: 09:18:35 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:18:35,252: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:18:35,259: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:18:35,261: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:18:35,246: 09:18:35 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:18:35,246: 09:18:35 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:18:35,262: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:18:35,262: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:18:35,262: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:18:35,268: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:18:35,269: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:18:35,269: Re-using an available connection from the pool.
2018-02-08 09:18:35,275: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:18:35,276: Re-using an available connection from the pool.
2018-02-08 09:18:35,280: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:18:35,280: Re-using an available connection from the pool.
2018-02-08 09:18:35,288: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:18:35,307: Re-using an available connection from the pool.
2018-02-08 09:18:35,467: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:18:35,526: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:18:35,529: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:18:35,557: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:18:35,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ea7668>]}
2018-02-08 09:18:35,983: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e01e48>]}
2018-02-08 09:18:36,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e01908>]}
2018-02-08 09:18:36,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e0bef0>]}
2018-02-08 09:18:36,194: 09:18:36 | 26 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.73s]
2018-02-08 09:18:36,496: 09:18:36 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.73s]
2018-02-08 09:18:36,706: 09:18:36 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.81s]
2018-02-08 09:18:36,997: 09:18:36 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.88s]
2018-02-08 09:18:36,997: 09:18:36 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:18:36,997: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:18:37,006: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:18:37,007: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:18:37,007: Re-using an available connection from the pool.
2018-02-08 09:18:37,108: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:18:37,475: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.classification query_string_rule,
c.pct_of_classification query_string_pct_of_classification,
c.pct_of_value query_string_pct_of_value,
c.classification filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.classification first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:18:37,476: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Column name filename is ambiguous at [19:13]
2018-02-08 09:18:37,476: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111eabd68>]}
2018-02-08 09:18:37,687: 09:18:37 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.48s]
2018-02-08 09:18:37,688: 09:18:37 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:18:37,688: Compiling model.seo_audit.agg_stats
2018-02-08 09:18:37,706: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:18:37,707: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:18:37,707: Re-using an available connection from the pool.
2018-02-08 09:18:37,962: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:18:38,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e6c550>]}
2018-02-08 09:18:38,804: 09:18:38 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.91s]
2018-02-08 09:18:38,804: 09:18:38 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:18:38,804: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:18:38,809: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:18:38,810: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:18:38,810: Re-using an available connection from the pool.
2018-02-08 09:18:39,057: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:18:39,693: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ec9048>]}
2018-02-08 09:18:40,011: 09:18:40 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.89s]
2018-02-08 09:18:40,012: 09:18:40 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:18:40,012: Compiling model.seo_audit.agg_all
2018-02-08 09:18:40,020: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:18:40,021: Acquiring new bigquery connection "agg_all".
2018-02-08 09:18:40,021: Re-using an available connection from the pool.
2018-02-08 09:18:40,253: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:18:41,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d5c821e-3ee8-4de1-a26b-3b8fda3a5902', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111e016d8>]}
2018-02-08 09:18:41,902: 09:18:41 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.15s]
2018-02-08 09:18:41,963: 09:18:41 | 
2018-02-08 09:18:41,963: 09:18:41 | Finished running 33 view models in 16.54s.
2018-02-08 09:18:41,963: Connection 'master' was left open.
2018-02-08 09:18:41,963: 
2018-02-08 09:18:41,963: Completed with 1 errors:
2018-02-08 09:18:41,964: 
2018-02-08 09:18:41,964: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:18:41,964:   Column name filename is ambiguous at [19:13]
2018-02-08 09:18:41,964:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:18:41,964: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:18:41,965: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d9a6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d9a828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111d9a6d8>]}
2018-02-08 09:18:42,377: Flushing usage events
2018-02-08 09:22:36,737: Tracking: tracking
2018-02-08 09:22:36,739: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f199668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f1994a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f199b00>]}
2018-02-08 09:22:37,482: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:22:37,500: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:22:37,504: Parsing core.sql
2018-02-08 09:22:37,525: Parsing adapters/bigquery.sql
2018-02-08 09:22:37,536: Parsing adapters/common.sql
2018-02-08 09:22:37,559: Parsing adapters/postgres.sql
2018-02-08 09:22:37,565: Parsing adapters/redshift.sql
2018-02-08 09:22:37,597: Parsing etc/get_custom_schema.sql
2018-02-08 09:22:37,605: Parsing materializations/archive.sql
2018-02-08 09:22:37,646: Parsing materializations/bigquery.sql
2018-02-08 09:22:37,664: Parsing materializations/helpers.sql
2018-02-08 09:22:37,684: Parsing materializations/incremental.sql
2018-02-08 09:22:37,718: Parsing materializations/table.sql
2018-02-08 09:22:37,739: Parsing materializations/view.sql
2018-02-08 09:22:37,758: Parsing materializations/wrapper.sql
2018-02-08 09:22:37,764: Parsing schema_tests/accepted_values.sql
2018-02-08 09:22:37,772: Parsing schema_tests/not_null.sql
2018-02-08 09:22:37,778: Parsing schema_tests/relationships.sql
2018-02-08 09:22:37,788: Parsing schema_tests/unique.sql
2018-02-08 09:22:37,842: Parsing model.seo_audit.accounts_proc
2018-02-08 09:22:37,844: Parsing model.seo_audit.all_dates
2018-02-08 09:22:37,845: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:22:37,849: Acquiring new bigquery connection "master".
2018-02-08 09:22:37,849: Opening a new connection (0 currently allocated)
2018-02-08 09:22:37,856: Parsing model.seo_audit.agg_all
2018-02-08 09:22:37,859: Parsing model.seo_audit.agg_indicative
2018-02-08 09:22:37,862: Parsing model.seo_audit.agg_stats
2018-02-08 09:22:37,872: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:22:37,878: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:22:37,882: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:22:37,887: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:22:37,893: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:22:37,895: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:22:37,899: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:22:37,903: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:22:37,905: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:22:37,908: Parsing model.seo_audit.ga_proc
2018-02-08 09:22:37,912: Parsing model.seo_audit.ga_stats
2018-02-08 09:22:37,916: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:22:37,920: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:22:37,924: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:22:37,930: Parsing model.seo_audit.moz_proc
2018-02-08 09:22:37,938: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:22:37,944: Parsing model.seo_audit.search_console_history
2018-02-08 09:22:37,948: Parsing model.seo_audit.search_console_proc
2018-02-08 09:22:37,955: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:22:37,965: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:22:37,969: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:22:37,973: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:22:37,977: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:22:37,979: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:22:37,983: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:22:37,989: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:22:37,992: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:22:38,010: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:22:38,025: 
2018-02-08 09:22:39,223: 09:22:39 | Concurrency: 4 threads (target='dev')
2018-02-08 09:22:39,223: 09:22:39 | 
2018-02-08 09:22:39,508: 09:22:39 | 1 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:22:39,509: Compiling model.seo_audit.all_dates
2018-02-08 09:22:39,509: 09:22:39 | 2 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:22:39,513: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:22:39,513: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:22:39,509: 09:22:39 | 3 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:22:39,520: Compiling model.seo_audit.accounts_proc
2018-02-08 09:22:39,525: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:22:39,527: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:22:39,533: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:22:39,534: Opening a new connection (1 currently allocated)
2018-02-08 09:22:39,535: Acquiring new bigquery connection "all_dates".
2018-02-08 09:22:39,536: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:22:39,538: Opening a new connection (2 currently allocated)
2018-02-08 09:22:39,616: Opening a new connection (3 currently allocated)
2018-02-08 09:22:40,175: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:22:40,186: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:22:40,223: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:22:40,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355a20>]}
2018-02-08 09:22:40,428: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3556a0>]}
2018-02-08 09:22:40,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355048>]}
2018-02-08 09:22:40,690: 09:22:40 | 1 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.88s]
2018-02-08 09:22:40,975: 09:22:40 | 3 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.91s]
2018-02-08 09:22:41,275: 09:22:41 | 2 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.93s]
2018-02-08 09:22:41,276: 09:22:41 | 4 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:22:41,276: Compiling model.seo_audit.search_console_proc
2018-02-08 09:22:41,286: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:22:41,282: 09:22:41 | 5 of 33 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:22:41,287: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:22:41,287: 09:22:41 | 6 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:22:41,294: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:22:41,293: 09:22:41 | 7 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:22:41,300: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:22:41,326: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:22:41,344: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:22:41,344: Re-using an available connection from the pool.
2018-02-08 09:22:41,347: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:22:41,338: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:22:41,353: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:22:41,355: Re-using an available connection from the pool.
2018-02-08 09:22:41,363: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:22:41,366: Re-using an available connection from the pool.
2018-02-08 09:22:41,374: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:22:41,375: Opening a new connection (4 currently allocated)
2018-02-08 09:22:41,654: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:22:41,708: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:22:41,743: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:22:41,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f36e7b8>]}
2018-02-08 09:22:42,012: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:22:42,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:42,081: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2cf4e0>]}
2018-02-08 09:22:42,188: 09:22:42 | 7 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.68s]
2018-02-08 09:22:42,190: 09:22:42 | 8 of 33 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 09:22:42,190: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:22:42,202: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:22:42,205: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:22:42,205: Re-using an available connection from the pool.
2018-02-08 09:22:42,388: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2c3f60>]}
2018-02-08 09:22:42,440: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:22:42,518: 09:22:42 | 5 of 33 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.75s]
2018-02-08 09:22:42,519: 09:22:42 | 9 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:22:42,520: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:22:42,527: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:22:42,531: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:22:42,532: Re-using an available connection from the pool.
2018-02-08 09:22:42,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f36e7b8>]}
2018-02-08 09:22:42,764: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:22:42,780: 09:22:42 | 4 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.81s]
2018-02-08 09:22:42,781: 09:22:42 | 10 of 33 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 09:22:42,781: Compiling model.seo_audit.ga_proc
2018-02-08 09:22:42,795: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:22:42,799: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:22:42,799: Re-using an available connection from the pool.
2018-02-08 09:22:43,004: 09:22:43 | 6 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 1.09s]
2018-02-08 09:22:43,004: 09:22:43 | 11 of 33 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 09:22:43,004: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:22:43,011: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:22:43,015: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:22:43,021: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:22:43,021: Re-using an available connection from the pool.
2018-02-08 09:22:43,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:43,235: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:22:43,297: 09:22:43 | 8 of 33 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.56s]
2018-02-08 09:22:43,298: 09:22:43 | 12 of 33 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 09:22:43,301: Compiling model.seo_audit.moz_proc
2018-02-08 09:22:43,313: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:22:43,315: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2cf4e0>]}
2018-02-08 09:22:43,316: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:22:43,317: Re-using an available connection from the pool.
2018-02-08 09:22:43,564: 09:22:43 | 9 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.59s]
2018-02-08 09:22:43,569: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:22:43,565: 09:22:43 | 13 of 33 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 09:22:43,574: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:22:43,581: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:22:43,583: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f38f0f0>]}
2018-02-08 09:22:43,584: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:22:43,585: Re-using an available connection from the pool.
2018-02-08 09:22:43,796: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:22:43,819: 09:22:43 | 10 of 33 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.53s]
2018-02-08 09:22:43,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355048>]}
2018-02-08 09:22:44,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:44,110: 09:22:44 | 11 of 33 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.58s]
2018-02-08 09:22:44,372: 09:22:44 | 12 of 33 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.58s]
2018-02-08 09:22:44,641: 09:22:44 | 13 of 33 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.52s]
2018-02-08 09:22:44,642: 09:22:44 | 14 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:22:44,643: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:22:44,642: 09:22:44 | 15 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:22:44,642: 09:22:44 | 16 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:22:44,653: Compiling model.seo_audit.ga_stats
2018-02-08 09:22:44,653: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:22:44,653: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:22:44,659: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:22:44,642: 09:22:44 | 17 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:22:44,667: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:22:44,668: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:22:44,669: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:22:44,704: Re-using an available connection from the pool.
2018-02-08 09:22:44,692: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:22:44,700: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:22:44,719: Re-using an available connection from the pool.
2018-02-08 09:22:44,721: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:22:44,721: Re-using an available connection from the pool.
2018-02-08 09:22:44,670: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:22:44,725: Re-using an available connection from the pool.
2018-02-08 09:22:44,958: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:22:44,963: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:22:44,982: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:22:45,261: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355630>]}
2018-02-08 09:22:45,281: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2d24e0>]}
2018-02-08 09:22:45,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f279048>]}
2018-02-08 09:22:45,555: 09:22:45 | 14 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.62s]
2018-02-08 09:22:45,556: 09:22:45 | 18 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:22:45,556: Compiling model.seo_audit.search_console_history
2018-02-08 09:22:45,562: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:22:45,564: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:22:45,565: Re-using an available connection from the pool.
2018-02-08 09:22:45,769: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:22:45,882: 09:22:45 | 15 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.63s]
2018-02-08 09:22:46,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355630>]}
2018-02-08 09:22:46,180: 09:22:46 | 16 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.64s]
2018-02-08 09:22:46,473: 09:22:46 | 18 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.59s]
2018-02-08 09:22:46,724: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:22:47,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355278>]}
2018-02-08 09:22:47,321: 09:22:47 | 17 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 2.41s]
2018-02-08 09:22:47,322: 09:22:47 | 19 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:22:47,322: 09:22:47 | 20 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:22:47,323: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:22:47,323: 09:22:47 | 21 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:22:47,323: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:22:47,331: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:22:47,331: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:22:47,343: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:22:47,344: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:22:47,345: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:22:47,345: Re-using an available connection from the pool.
2018-02-08 09:22:47,346: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:22:47,347: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:22:47,348: Re-using an available connection from the pool.
2018-02-08 09:22:47,353: Re-using an available connection from the pool.
2018-02-08 09:22:47,576: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:22:47,580: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:22:47,589: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:22:47,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3699e8>]}
2018-02-08 09:22:47,993: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:47,998: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f379668>]}
2018-02-08 09:22:48,232: 09:22:48 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.66s]
2018-02-08 09:22:48,548: 09:22:48 | 19 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.67s]
2018-02-08 09:22:48,849: 09:22:48 | 20 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.67s]
2018-02-08 09:22:48,850: 09:22:48 | 22 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:22:48,851: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:22:48,862: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:22:48,850: 09:22:48 | 23 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:22:48,862: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:22:48,850: 09:22:48 | 25 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:22:48,850: 09:22:48 | 24 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:22:48,876: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:22:48,871: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:22:48,876: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:22:48,926: Re-using an available connection from the pool.
2018-02-08 09:22:48,874: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:22:48,935: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:22:48,936: Re-using an available connection from the pool.
2018-02-08 09:22:48,926: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:22:48,914: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:22:48,944: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:22:48,944: Re-using an available connection from the pool.
2018-02-08 09:22:48,951: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:22:48,952: Re-using an available connection from the pool.
2018-02-08 09:22:49,149: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:22:49,177: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:22:49,210: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:22:49,221: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:22:49,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355278>]}
2018-02-08 09:22:49,568: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3422e8>]}
2018-02-08 09:22:49,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f379c88>]}
2018-02-08 09:22:49,672: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f379a58>]}
2018-02-08 09:22:49,787: 09:22:49 | 22 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.64s]
2018-02-08 09:22:50,067: 09:22:50 | 25 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.70s]
2018-02-08 09:22:50,388: 09:22:50 | 23 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-08 09:22:50,674: 09:22:50 | 24 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.80s]
2018-02-08 09:22:50,675: 09:22:50 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:22:50,676: 09:22:50 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:22:50,677: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:22:50,676: 09:22:50 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:22:50,676: 09:22:50 | 29 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:22:50,677: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:22:50,687: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:22:50,687: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:22:50,687: Compiling model.seo_audit.agg_indicative
2018-02-08 09:22:50,693: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:22:50,699: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:22:50,705: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:22:50,706: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:22:50,706: Re-using an available connection from the pool.
2018-02-08 09:22:50,708: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:22:50,708: Re-using an available connection from the pool.
2018-02-08 09:22:50,708: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:22:50,708: Re-using an available connection from the pool.
2018-02-08 09:22:50,724: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:22:50,724: Re-using an available connection from the pool.
2018-02-08 09:22:50,929: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:22:50,954: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:22:50,957: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:22:50,975: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:22:51,367: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2c3550>]}
2018-02-08 09:22:51,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f36e908>]}
2018-02-08 09:22:51,410: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3692b0>]}
2018-02-08 09:22:51,439: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2c39e8>]}
2018-02-08 09:22:51,655: 09:22:51 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.69s]
2018-02-08 09:22:51,954: 09:22:51 | 29 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.69s]
2018-02-08 09:22:52,288: 09:22:52 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.72s]
2018-02-08 09:22:52,488: 09:22:52 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.76s]
2018-02-08 09:22:52,489: 09:22:52 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:22:52,489: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:22:52,499: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:22:52,500: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:22:52,500: Re-using an available connection from the pool.
2018-02-08 09:22:52,596: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.file_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:22:52,946: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.file_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:22:52,947: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Name file_path not found inside d at [16:3]
2018-02-08 09:22:52,947: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f355048>]}
2018-02-08 09:22:53,281: 09:22:53 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.46s]
2018-02-08 09:22:53,282: 09:22:53 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:22:53,283: Compiling model.seo_audit.agg_stats
2018-02-08 09:22:53,300: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:22:53,302: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:22:53,302: Re-using an available connection from the pool.
2018-02-08 09:22:53,505: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:22:54,073: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:54,299: 09:22:54 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.79s]
2018-02-08 09:22:54,299: 09:22:54 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:22:54,300: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:22:54,309: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:22:54,310: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:22:54,310: Re-using an available connection from the pool.
2018-02-08 09:22:54,518: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:22:55,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f36e7b8>]}
2018-02-08 09:22:55,391: 09:22:55 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.77s]
2018-02-08 09:22:55,391: 09:22:55 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:22:55,392: Compiling model.seo_audit.agg_all
2018-02-08 09:22:55,402: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:22:55,403: Acquiring new bigquery connection "agg_all".
2018-02-08 09:22:55,404: Re-using an available connection from the pool.
2018-02-08 09:22:55,944: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:22:56,802: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e324d9fe-c60b-4b28-88af-64beb32d2b6e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3002e8>]}
2018-02-08 09:22:57,022: 09:22:57 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.41s]
2018-02-08 09:22:57,121: 09:22:57 | 
2018-02-08 09:22:57,121: 09:22:57 | Finished running 33 view models in 17.90s.
2018-02-08 09:22:57,122: Connection 'master' was left open.
2018-02-08 09:22:57,122: 
2018-02-08 09:22:57,122: Completed with 1 errors:
2018-02-08 09:22:57,123: 
2018-02-08 09:22:57,123: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:22:57,123:   Name file_path not found inside d at [16:3]
2018-02-08 09:22:57,123:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:22:57,124: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:22:57,124: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f266748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2668d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f266780>]}
2018-02-08 09:22:57,424: Flushing usage events
2018-02-08 09:23:47,717: Tracking: tracking
2018-02-08 09:23:47,720: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d2278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d2d68>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d2eb8>]}
2018-02-08 09:23:48,437: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:23:48,468: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:23:48,485: Parsing core.sql
2018-02-08 09:23:48,517: Parsing adapters/bigquery.sql
2018-02-08 09:23:48,530: Parsing adapters/common.sql
2018-02-08 09:23:48,550: Parsing adapters/postgres.sql
2018-02-08 09:23:48,556: Parsing adapters/redshift.sql
2018-02-08 09:23:48,597: Parsing etc/get_custom_schema.sql
2018-02-08 09:23:48,611: Parsing materializations/archive.sql
2018-02-08 09:23:48,671: Parsing materializations/bigquery.sql
2018-02-08 09:23:48,690: Parsing materializations/helpers.sql
2018-02-08 09:23:48,719: Parsing materializations/incremental.sql
2018-02-08 09:23:48,756: Parsing materializations/table.sql
2018-02-08 09:23:48,815: Parsing materializations/view.sql
2018-02-08 09:23:48,847: Parsing materializations/wrapper.sql
2018-02-08 09:23:48,862: Parsing schema_tests/accepted_values.sql
2018-02-08 09:23:48,869: Parsing schema_tests/not_null.sql
2018-02-08 09:23:48,873: Parsing schema_tests/relationships.sql
2018-02-08 09:23:48,878: Parsing schema_tests/unique.sql
2018-02-08 09:23:48,925: Parsing model.seo_audit.accounts_proc
2018-02-08 09:23:48,928: Parsing model.seo_audit.all_dates
2018-02-08 09:23:48,929: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:23:48,932: Acquiring new bigquery connection "master".
2018-02-08 09:23:48,932: Opening a new connection (0 currently allocated)
2018-02-08 09:23:48,937: Parsing model.seo_audit.agg_all
2018-02-08 09:23:48,941: Parsing model.seo_audit.agg_indicative
2018-02-08 09:23:48,946: Parsing model.seo_audit.agg_stats
2018-02-08 09:23:48,953: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:23:48,957: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:23:48,963: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:23:48,967: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:23:48,970: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:23:48,974: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:23:48,978: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:23:48,982: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:23:48,984: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:23:48,987: Parsing model.seo_audit.ga_proc
2018-02-08 09:23:48,992: Parsing model.seo_audit.ga_stats
2018-02-08 09:23:48,994: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:23:48,997: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:23:49,001: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:23:49,005: Parsing model.seo_audit.moz_proc
2018-02-08 09:23:49,010: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:23:49,015: Parsing model.seo_audit.search_console_history
2018-02-08 09:23:49,017: Parsing model.seo_audit.search_console_proc
2018-02-08 09:23:49,021: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:23:49,025: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:23:49,027: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:23:49,031: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:23:49,034: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:23:49,038: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:23:49,042: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:23:49,047: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:23:49,051: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:23:49,073: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:23:49,086: 
2018-02-08 09:23:50,004: 09:23:50 | Concurrency: 4 threads (target='dev')
2018-02-08 09:23:50,004: 09:23:50 | 
2018-02-08 09:23:50,329: 09:23:50 | 1 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:23:50,329: Compiling model.seo_audit.accounts_proc
2018-02-08 09:23:50,340: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:23:50,336: 09:23:50 | 2 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:23:50,337: 09:23:50 | 3 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:23:50,341: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:23:50,341: Compiling model.seo_audit.all_dates
2018-02-08 09:23:50,349: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:23:50,355: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:23:50,359: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:23:50,360: Opening a new connection (1 currently allocated)
2018-02-08 09:23:50,361: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:23:50,366: Opening a new connection (2 currently allocated)
2018-02-08 09:23:50,439: Acquiring new bigquery connection "all_dates".
2018-02-08 09:23:50,512: Opening a new connection (3 currently allocated)
2018-02-08 09:23:51,126: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:23:51,132: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:23:51,178: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:23:51,321: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105311ef0>]}
2018-02-08 09:23:51,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105306898>]}
2018-02-08 09:23:51,431: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105311dd8>]}
2018-02-08 09:23:51,574: 09:23:51 | 2 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.98s]
2018-02-08 09:23:51,860: 09:23:51 | 1 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.01s]
2018-02-08 09:23:52,098: 09:23:52 | 3 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.09s]
2018-02-08 09:23:52,099: 09:23:52 | 4 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:23:52,100: Compiling model.seo_audit.search_console_proc
2018-02-08 09:23:52,106: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:23:52,099: 09:23:52 | 5 of 33 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 09:23:52,106: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:23:52,100: 09:23:52 | 6 of 33 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 09:23:52,100: 09:23:52 | 7 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:23:52,113: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:23:52,113: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:23:52,113: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:23:52,120: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:23:52,136: Re-using an available connection from the pool.
2018-02-08 09:23:52,121: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:23:52,135: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:23:52,143: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:23:52,142: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:23:52,146: Re-using an available connection from the pool.
2018-02-08 09:23:52,147: Re-using an available connection from the pool.
2018-02-08 09:23:52,150: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:23:52,156: Opening a new connection (4 currently allocated)
2018-02-08 09:23:52,375: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:23:52,395: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:23:52,428: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:23:52,658: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:23:52,701: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105306748>]}
2018-02-08 09:23:52,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053111d0>]}
2018-02-08 09:23:52,815: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053115c0>]}
2018-02-08 09:23:52,910: 09:23:52 | 6 of 33 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.59s]
2018-02-08 09:23:52,910: 09:23:52 | 8 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:23:52,910: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:23:52,925: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:23:52,930: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:23:52,930: Re-using an available connection from the pool.
2018-02-08 09:23:52,954: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053069e8>]}
2018-02-08 09:23:53,151: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:23:53,203: 09:23:53 | 5 of 33 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.62s]
2018-02-08 09:23:53,205: 09:23:53 | 9 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:23:53,207: Compiling model.seo_audit.moz_proc
2018-02-08 09:23:53,217: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:23:53,218: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:23:53,219: Re-using an available connection from the pool.
2018-02-08 09:23:53,431: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:23:53,511: 09:23:53 | 4 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.72s]
2018-02-08 09:23:53,514: 09:23:53 | 10 of 33 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 09:23:53,515: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:23:53,528: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:23:53,529: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:23:53,529: Re-using an available connection from the pool.
2018-02-08 09:23:53,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105306748>]}
2018-02-08 09:23:53,705: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:23:53,738: 09:23:53 | 7 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.84s]
2018-02-08 09:23:53,739: 09:23:53 | 11 of 33 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 09:23:53,740: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:23:53,752: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:23:53,755: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105356e10>]}
2018-02-08 09:23:53,756: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:23:53,756: Re-using an available connection from the pool.
2018-02-08 09:23:53,969: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:23:53,992: 09:23:53 | 8 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.63s]
2018-02-08 09:23:53,993: 09:23:53 | 12 of 33 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 09:23:53,993: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:23:53,999: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:23:54,002: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:23:54,003: Re-using an available connection from the pool.
2018-02-08 09:23:54,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101f09e10>]}
2018-02-08 09:23:54,241: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:23:54,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105306b38>]}
2018-02-08 09:23:54,334: 09:23:54 | 9 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.55s]
2018-02-08 09:23:54,335: 09:23:54 | 13 of 33 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 09:23:54,335: Compiling model.seo_audit.ga_proc
2018-02-08 09:23:54,343: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:23:54,346: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:23:54,347: Re-using an available connection from the pool.
2018-02-08 09:23:54,563: 09:23:54 | 10 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.50s]
2018-02-08 09:23:54,566: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:23:54,570: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289ef98>]}
2018-02-08 09:23:54,862: 09:23:54 | 11 of 33 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.51s]
2018-02-08 09:23:54,942: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105339dd8>]}
2018-02-08 09:23:55,102: 09:23:55 | 12 of 33 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.58s]
2018-02-08 09:23:55,323: 09:23:55 | 13 of 33 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.61s]
2018-02-08 09:23:55,324: 09:23:55 | 14 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:23:55,325: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:23:55,324: 09:23:55 | 15 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:23:55,332: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:23:55,339: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:23:55,325: 09:23:55 | 16 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:23:55,340: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:23:55,341: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:23:55,346: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:23:55,325: 09:23:55 | 17 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:23:55,347: Compiling model.seo_audit.search_console_history
2018-02-08 09:23:55,352: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:23:55,353: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:23:55,355: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:23:55,356: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:23:55,356: Re-using an available connection from the pool.
2018-02-08 09:23:55,357: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:23:55,369: Re-using an available connection from the pool.
2018-02-08 09:23:55,374: Re-using an available connection from the pool.
2018-02-08 09:23:55,380: Re-using an available connection from the pool.
2018-02-08 09:23:55,587: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:23:55,590: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:23:55,611: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:23:55,616: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:23:55,849: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:23:55,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105339ba8>]}
2018-02-08 09:23:55,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105335c50>]}
2018-02-08 09:23:55,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101fa64a8>]}
2018-02-08 09:23:56,065: 09:23:56 | 15 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.52s]
2018-02-08 09:23:56,065: 09:23:56 | 18 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:23:56,066: Compiling model.seo_audit.ga_stats
2018-02-08 09:23:56,073: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:23:56,076: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:23:56,077: Re-using an available connection from the pool.
2018-02-08 09:23:56,304: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:23:56,336: 09:23:56 | 14 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.55s]
2018-02-08 09:23:56,562: 09:23:56 | 17 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.61s]
2018-02-08 09:23:56,641: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:23:56,777: 09:23:56 | 16 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.64s]
2018-02-08 09:23:57,085: 09:23:57 | 18 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.57s]
2018-02-08 09:23:57,086: 09:23:57 | 19 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:23:57,086: 09:23:57 | 20 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:23:57,087: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:23:57,087: 09:23:57 | 21 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:23:57,087: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:23:57,097: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:23:57,097: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:23:57,112: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:23:57,114: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:23:57,115: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:23:57,116: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:23:57,116: Re-using an available connection from the pool.
2018-02-08 09:23:57,117: Re-using an available connection from the pool.
2018-02-08 09:23:57,118: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:23:57,123: Re-using an available connection from the pool.
2018-02-08 09:23:57,336: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:23:57,337: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:23:57,345: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:23:57,671: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105339dd8>]}
2018-02-08 09:23:57,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10535c3c8>]}
2018-02-08 09:23:57,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10535c908>]}
2018-02-08 09:23:57,972: 09:23:57 | 19 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.58s]
2018-02-08 09:23:58,210: 09:23:58 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.67s]
2018-02-08 09:23:58,485: 09:23:58 | 20 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.74s]
2018-02-08 09:23:58,487: 09:23:58 | 22 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:23:58,488: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:23:58,487: 09:23:58 | 23 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:23:58,495: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:23:58,487: 09:23:58 | 24 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:23:58,498: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:23:58,488: 09:23:58 | 25 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:23:58,507: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:23:58,507: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:23:58,508: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:23:58,509: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:23:58,529: Re-using an available connection from the pool.
2018-02-08 09:23:58,527: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:23:58,536: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:23:58,537: Re-using an available connection from the pool.
2018-02-08 09:23:58,528: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:23:58,556: Re-using an available connection from the pool.
2018-02-08 09:23:58,522: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:23:58,584: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:23:58,585: Re-using an available connection from the pool.
2018-02-08 09:23:58,826: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:23:58,837: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:23:58,855: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:23:58,910: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:23:59,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101fa6fd0>]}
2018-02-08 09:23:59,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:23:59,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289ef98>]}
2018-02-08 09:23:59,307: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105339908>]}
2018-02-08 09:23:59,435: 09:23:59 | 24 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-08 09:23:59,638: 09:23:59 | 22 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.74s]
2018-02-08 09:23:59,878: 09:23:59 | 25 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.79s]
2018-02-08 09:24:00,116: 09:24:00 | 23 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.81s]
2018-02-08 09:24:00,117: 09:24:00 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:24:00,117: 09:24:00 | 27 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:24:00,118: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:24:00,117: 09:24:00 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:24:00,124: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:24:00,118: Compiling model.seo_audit.agg_indicative
2018-02-08 09:24:00,131: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:24:00,139: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:24:00,117: 09:24:00 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:24:00,144: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:24:00,145: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:24:00,146: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:24:00,152: Re-using an available connection from the pool.
2018-02-08 09:24:00,158: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:24:00,161: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:24:00,162: Re-using an available connection from the pool.
2018-02-08 09:24:00,169: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:24:00,170: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:24:00,172: Re-using an available connection from the pool.
2018-02-08 09:24:00,174: Re-using an available connection from the pool.
2018-02-08 09:24:00,412: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:24:00,430: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:24:00,435: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:24:00,494: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:24:00,876: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105306b38>]}
2018-02-08 09:24:00,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101fc7160>]}
2018-02-08 09:24:00,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10288fa20>]}
2018-02-08 09:24:00,940: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:24:01,131: 09:24:01 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.76s]
2018-02-08 09:24:01,471: 09:24:01 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.73s]
2018-02-08 09:24:01,755: 09:24:01 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.77s]
2018-02-08 09:24:02,072: 09:24:02 | 27 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.82s]
2018-02-08 09:24:02,073: 09:24:02 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:24:02,073: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:24:02,079: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:24:02,080: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:24:02,080: Re-using an available connection from the pool.
2018-02-08 09:24:02,162: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:24:02,489: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` d
ON (  a.classification = d.classification )
2018-02-08 09:24:02,490: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Name first_path not found inside d at [16:3]
2018-02-08 09:24:02,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10535c390>]}
2018-02-08 09:24:02,790: 09:24:02 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.42s]
2018-02-08 09:24:02,791: 09:24:02 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:24:02,791: Compiling model.seo_audit.agg_stats
2018-02-08 09:24:02,804: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:24:02,805: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:24:02,805: Re-using an available connection from the pool.
2018-02-08 09:24:02,974: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:24:03,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:24:03,841: 09:24:03 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-08 09:24:03,841: 09:24:03 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:24:03,842: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:24:03,847: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:24:03,847: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:24:03,847: Re-using an available connection from the pool.
2018-02-08 09:24:04,036: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:24:04,638: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101fc7160>]}
2018-02-08 09:24:04,965: 09:24:04 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.80s]
2018-02-08 09:24:04,965: 09:24:04 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:24:04,966: Compiling model.seo_audit.agg_all
2018-02-08 09:24:04,976: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:24:04,977: Acquiring new bigquery connection "agg_all".
2018-02-08 09:24:04,977: Re-using an available connection from the pool.
2018-02-08 09:24:05,164: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:24:05,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8b725d90-1ad4-4cad-a63e-00ef065811f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10289eeb8>]}
2018-02-08 09:24:06,192: 09:24:06 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.97s]
2018-02-08 09:24:06,270: 09:24:06 | 
2018-02-08 09:24:06,270: 09:24:06 | Finished running 33 view models in 16.27s.
2018-02-08 09:24:06,270: Connection 'master' was left open.
2018-02-08 09:24:06,271: 
2018-02-08 09:24:06,271: Completed with 1 errors:
2018-02-08 09:24:06,271: 
2018-02-08 09:24:06,272: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:24:06,272:   Name first_path not found inside d at [16:3]
2018-02-08 09:24:06,272:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:24:06,273: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:24:06,273: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101fa9208>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101ef04e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101ef05c0>]}
2018-02-08 09:24:06,549: Flushing usage events
2018-02-08 09:25:31,111: Tracking: tracking
2018-02-08 09:25:31,116: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10536f710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10536fcf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10536f048>]}
2018-02-08 09:25:31,903: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:25:31,933: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:25:31,942: Parsing core.sql
2018-02-08 09:25:31,972: Parsing adapters/bigquery.sql
2018-02-08 09:25:31,980: Parsing adapters/common.sql
2018-02-08 09:25:32,009: Parsing adapters/postgres.sql
2018-02-08 09:25:32,015: Parsing adapters/redshift.sql
2018-02-08 09:25:32,040: Parsing etc/get_custom_schema.sql
2018-02-08 09:25:32,050: Parsing materializations/archive.sql
2018-02-08 09:25:32,099: Parsing materializations/bigquery.sql
2018-02-08 09:25:32,120: Parsing materializations/helpers.sql
2018-02-08 09:25:32,146: Parsing materializations/incremental.sql
2018-02-08 09:25:32,188: Parsing materializations/table.sql
2018-02-08 09:25:32,218: Parsing materializations/view.sql
2018-02-08 09:25:32,243: Parsing materializations/wrapper.sql
2018-02-08 09:25:32,251: Parsing schema_tests/accepted_values.sql
2018-02-08 09:25:32,261: Parsing schema_tests/not_null.sql
2018-02-08 09:25:32,266: Parsing schema_tests/relationships.sql
2018-02-08 09:25:32,272: Parsing schema_tests/unique.sql
2018-02-08 09:25:32,302: Parsing model.seo_audit.accounts_proc
2018-02-08 09:25:32,306: Parsing model.seo_audit.all_dates
2018-02-08 09:25:32,307: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:25:32,311: Acquiring new bigquery connection "master".
2018-02-08 09:25:32,311: Opening a new connection (0 currently allocated)
2018-02-08 09:25:32,316: Parsing model.seo_audit.agg_all
2018-02-08 09:25:32,319: Parsing model.seo_audit.agg_indicative
2018-02-08 09:25:32,323: Parsing model.seo_audit.agg_stats
2018-02-08 09:25:32,331: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:25:32,334: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:25:32,338: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:25:32,341: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:25:32,345: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:25:32,348: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:25:32,364: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:25:32,368: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:25:32,371: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:25:32,374: Parsing model.seo_audit.ga_proc
2018-02-08 09:25:32,379: Parsing model.seo_audit.ga_stats
2018-02-08 09:25:32,382: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:25:32,385: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:25:32,389: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:25:32,391: Parsing model.seo_audit.moz_proc
2018-02-08 09:25:32,395: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:25:32,398: Parsing model.seo_audit.search_console_history
2018-02-08 09:25:32,400: Parsing model.seo_audit.search_console_proc
2018-02-08 09:25:32,403: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:25:32,407: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:25:32,409: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:25:32,412: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:25:32,415: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:25:32,419: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:25:32,422: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:25:32,424: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:25:32,426: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:25:32,439: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:25:32,451: 
2018-02-08 09:25:33,196: 09:25:33 | Concurrency: 4 threads (target='dev')
2018-02-08 09:25:33,196: 09:25:33 | 
2018-02-08 09:25:33,422: 09:25:33 | 1 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:25:33,422: Compiling model.seo_audit.all_dates
2018-02-08 09:25:33,432: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:25:33,431: 09:25:33 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:25:33,434: Acquiring new bigquery connection "all_dates".
2018-02-08 09:25:33,431: 09:25:33 | 3 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:25:33,434: Compiling model.seo_audit.accounts_proc
2018-02-08 09:25:33,434: Opening a new connection (1 currently allocated)
2018-02-08 09:25:33,435: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:25:33,446: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:25:33,456: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:25:33,522: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:25:33,523: Opening a new connection (2 currently allocated)
2018-02-08 09:25:33,526: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:25:33,527: Opening a new connection (3 currently allocated)
2018-02-08 09:25:34,044: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:25:34,096: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:25:34,110: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:25:34,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10551bb70>]}
2018-02-08 09:25:34,283: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054eb7f0>]}
2018-02-08 09:25:34,304: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054eb588>]}
2018-02-08 09:25:34,468: 09:25:34 | 1 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.84s]
2018-02-08 09:25:34,705: 09:25:34 | 3 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.85s]
2018-02-08 09:25:34,925: 09:25:34 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.87s]
2018-02-08 09:25:34,926: 09:25:34 | 4 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:25:34,927: Compiling model.seo_audit.moz_proc
2018-02-08 09:25:34,926: 09:25:34 | 5 of 33 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 09:25:34,940: Compiling model.seo_audit.ga_proc
2018-02-08 09:25:34,926: 09:25:34 | 6 of 33 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 09:25:34,927: 09:25:34 | 7 of 33 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 09:25:34,950: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:25:34,940: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:25:34,951: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:25:34,951: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:25:34,980: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:25:34,981: Re-using an available connection from the pool.
2018-02-08 09:25:34,991: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:25:34,997: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:25:34,997: Re-using an available connection from the pool.
2018-02-08 09:25:35,002: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:25:35,006: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:25:35,006: Re-using an available connection from the pool.
2018-02-08 09:25:35,014: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:25:35,015: Opening a new connection (4 currently allocated)
2018-02-08 09:25:35,229: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:25:35,230: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:25:35,236: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:25:35,515: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054ab080>]}
2018-02-08 09:25:35,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105491128>]}
2018-02-08 09:25:35,577: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:25:35,634: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10551bb38>]}
2018-02-08 09:25:35,729: 09:25:35 | 6 of 33 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.56s]
2018-02-08 09:25:35,730: 09:25:35 | 8 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:25:35,730: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:25:35,743: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:25:35,747: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:25:35,747: Re-using an available connection from the pool.
2018-02-08 09:25:35,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105576940>]}
2018-02-08 09:25:35,935: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:25:36,014: 09:25:36 | 4 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.61s]
2018-02-08 09:25:36,016: 09:25:36 | 9 of 33 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 09:25:36,016: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:25:36,031: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:25:36,034: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:25:36,034: Re-using an available connection from the pool.
2018-02-08 09:25:36,313: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:25:36,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105583160>]}
2018-02-08 09:25:36,325: 09:25:36 | 7 of 33 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.68s]
2018-02-08 09:25:36,329: 09:25:36 | 10 of 33 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 09:25:36,330: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:25:36,346: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:25:36,348: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:25:36,348: Re-using an available connection from the pool.
2018-02-08 09:25:36,583: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:25:36,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054ac7b8>]}
2018-02-08 09:25:36,667: 09:25:36 | 5 of 33 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.96s]
2018-02-08 09:25:36,668: 09:25:36 | 11 of 33 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 09:25:36,669: Compiling model.seo_audit.search_console_proc
2018-02-08 09:25:36,689: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:25:36,692: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:25:36,692: Re-using an available connection from the pool.
2018-02-08 09:25:36,896: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:25:36,920: 09:25:36 | 8 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.59s]
2018-02-08 09:25:36,925: 09:25:36 | 12 of 33 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 09:25:36,927: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:25:36,941: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:25:36,942: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:25:36,943: Re-using an available connection from the pool.
2018-02-08 09:25:37,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101f126a0>]}
2018-02-08 09:25:37,154: 09:25:37 | 9 of 33 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.62s]
2018-02-08 09:25:37,157: 09:25:37 | 13 of 33 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 09:25:37,159: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:25:37,172: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:25:37,175: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:25:37,175: Re-using an available connection from the pool.
2018-02-08 09:25:37,192: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054eb6d8>]}
2018-02-08 09:25:37,346: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:25:37,378: 09:25:37 | 10 of 33 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.70s]
2018-02-08 09:25:37,396: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:25:37,610: 09:25:37 | 11 of 33 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.52s]
2018-02-08 09:25:37,628: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054732b0>]}
2018-02-08 09:25:37,722: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054e8a90>]}
2018-02-08 09:25:37,840: 09:25:37 | 12 of 33 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.70s]
2018-02-08 09:25:38,050: 09:25:38 | 13 of 33 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.56s]
2018-02-08 09:25:38,051: 09:25:38 | 14 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:25:38,051: Compiling model.seo_audit.search_console_history
2018-02-08 09:25:38,065: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:25:38,067: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:25:38,068: Re-using an available connection from the pool.
2018-02-08 09:25:38,059: 09:25:38 | 15 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:25:38,077: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:25:38,111: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:25:38,114: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:25:38,114: Re-using an available connection from the pool.
2018-02-08 09:25:38,074: 09:25:38 | 16 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:25:38,125: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:25:38,089: 09:25:38 | 17 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:25:38,134: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:25:38,176: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:25:38,177: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:25:38,177: Re-using an available connection from the pool.
2018-02-08 09:25:38,184: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:25:38,193: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:25:38,195: Re-using an available connection from the pool.
2018-02-08 09:25:38,329: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:25:38,382: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:25:38,433: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:25:38,444: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:25:38,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054732b0>]}
2018-02-08 09:25:38,679: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105557710>]}
2018-02-08 09:25:38,738: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054abb00>]}
2018-02-08 09:25:38,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054ab978>]}
2018-02-08 09:25:38,918: 09:25:38 | 14 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.58s]
2018-02-08 09:25:38,919: 09:25:38 | 18 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:25:38,920: Compiling model.seo_audit.ga_stats
2018-02-08 09:25:38,933: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:25:38,935: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:25:38,935: Re-using an available connection from the pool.
2018-02-08 09:25:39,127: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:25:39,144: 09:25:39 | 17 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.54s]
2018-02-08 09:25:39,398: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054732b0>]}
2018-02-08 09:25:39,416: 09:25:39 | 16 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.61s]
2018-02-08 09:25:39,631: 09:25:39 | 15 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.67s]
2018-02-08 09:25:39,856: 09:25:39 | 18 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.48s]
2018-02-08 09:25:39,856: 09:25:39 | 19 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:25:39,857: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:25:39,857: 09:25:39 | 20 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:25:39,864: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:25:39,873: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:25:39,857: 09:25:39 | 21 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:25:39,880: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:25:39,880: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:25:39,890: Re-using an available connection from the pool.
2018-02-08 09:25:39,878: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:25:39,896: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:25:39,896: Re-using an available connection from the pool.
2018-02-08 09:25:39,890: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:25:39,908: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:25:39,908: Re-using an available connection from the pool.
2018-02-08 09:25:40,124: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:25:40,128: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:25:40,152: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:25:40,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054e8a90>]}
2018-02-08 09:25:40,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054915f8>]}
2018-02-08 09:25:40,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10551b470>]}
2018-02-08 09:25:40,679: 09:25:40 | 19 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.57s]
2018-02-08 09:25:40,929: 09:25:40 | 21 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.59s]
2018-02-08 09:25:41,129: 09:25:41 | 20 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.63s]
2018-02-08 09:25:41,130: 09:25:41 | 22 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:25:41,130: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:25:41,137: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:25:41,130: 09:25:41 | 23 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:25:41,130: 09:25:41 | 24 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:25:41,130: 09:25:41 | 25 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:25:41,138: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:25:41,138: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:25:41,138: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:25:41,139: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:25:41,146: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:25:41,154: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:25:41,177: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:25:41,166: Re-using an available connection from the pool.
2018-02-08 09:25:41,172: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:25:41,175: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:25:41,181: Re-using an available connection from the pool.
2018-02-08 09:25:41,181: Re-using an available connection from the pool.
2018-02-08 09:25:41,184: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:25:41,185: Re-using an available connection from the pool.
2018-02-08 09:25:41,393: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:25:41,398: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:25:41,405: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:25:41,453: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:25:41,755: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105566b38>]}
2018-02-08 09:25:41,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054ac7b8>]}
2018-02-08 09:25:41,781: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105576f28>]}
2018-02-08 09:25:41,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054abe48>]}
2018-02-08 09:25:41,984: 09:25:41 | 25 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.62s]
2018-02-08 09:25:42,211: 09:25:42 | 24 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.63s]
2018-02-08 09:25:42,496: 09:25:42 | 22 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.65s]
2018-02-08 09:25:42,826: 09:25:42 | 23 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.67s]
2018-02-08 09:25:42,827: 09:25:42 | 26 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:25:42,828: Compiling model.seo_audit.agg_indicative
2018-02-08 09:25:42,827: 09:25:42 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:25:42,833: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:25:42,827: 09:25:42 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:25:42,833: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:25:42,827: 09:25:42 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:25:42,834: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:25:42,839: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:25:42,840: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:25:42,840: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:25:42,847: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:25:42,879: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:25:42,879: Re-using an available connection from the pool.
2018-02-08 09:25:42,863: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:25:42,893: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:25:42,866: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:25:42,894: Re-using an available connection from the pool.
2018-02-08 09:25:42,909: Re-using an available connection from the pool.
2018-02-08 09:25:42,917: Re-using an available connection from the pool.
2018-02-08 09:25:43,116: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:25:43,120: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:25:43,123: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:25:43,128: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:25:43,608: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055405f8>]}
2018-02-08 09:25:43,609: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105576d30>]}
2018-02-08 09:25:43,611: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054e8a90>]}
2018-02-08 09:25:43,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105566f60>]}
2018-02-08 09:25:43,898: 09:25:43 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.77s]
2018-02-08 09:25:44,195: 09:25:44 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.77s]
2018-02-08 09:25:44,490: 09:25:44 | 26 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.78s]
2018-02-08 09:25:44,694: 09:25:44 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.84s]
2018-02-08 09:25:44,694: 09:25:44 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:25:44,694: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:25:44,701: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:25:44,702: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:25:44,702: Re-using an available connection from the pool.
2018-02-08 09:25:44,785: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:25:45,191: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case when ( filename != filename_rule and filename_pct_of_value < .3 ) then 1
	when ( query_string != query_string_rule and query_string_pct_of_value < .3 ) then 1
	when ( first_path != first_path_rule and first_path_pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:25:45,193: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Column name filename is ambiguous at [19:13]
2018-02-08 09:25:45,193: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054733c8>]}
2018-02-08 09:25:45,430: 09:25:45 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.50s]
2018-02-08 09:25:45,431: 09:25:45 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:25:45,431: Compiling model.seo_audit.agg_stats
2018-02-08 09:25:45,441: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:25:45,442: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:25:45,442: Re-using an available connection from the pool.
2018-02-08 09:25:45,636: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:25:46,221: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054e8a90>]}
2018-02-08 09:25:46,465: 09:25:46 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.79s]
2018-02-08 09:25:46,465: 09:25:46 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:25:46,465: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:25:46,473: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:25:46,474: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:25:46,474: Re-using an available connection from the pool.
2018-02-08 09:25:46,667: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:25:47,231: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054733c8>]}
2018-02-08 09:25:47,437: 09:25:47 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.77s]
2018-02-08 09:25:47,439: 09:25:47 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:25:47,439: Compiling model.seo_audit.agg_all
2018-02-08 09:25:47,449: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:25:47,450: Acquiring new bigquery connection "agg_all".
2018-02-08 09:25:47,450: Re-using an available connection from the pool.
2018-02-08 09:25:47,673: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:25:48,492: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab7fcfe8-78e8-4e73-8eb7-001a2c3ecdde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054e8a90>]}
2018-02-08 09:25:48,719: 09:25:48 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.05s]
2018-02-08 09:25:48,808: 09:25:48 | 
2018-02-08 09:25:48,808: 09:25:48 | Finished running 33 view models in 15.61s.
2018-02-08 09:25:48,808: Connection 'master' was left open.
2018-02-08 09:25:48,808: 
2018-02-08 09:25:48,808: Completed with 1 errors:
2018-02-08 09:25:48,808: 
2018-02-08 09:25:48,809: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:25:48,809:   Column name filename is ambiguous at [19:13]
2018-02-08 09:25:48,809:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:25:48,809: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:25:48,810: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10543d7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10543d518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10543d5f8>]}
2018-02-08 09:25:49,035: Flushing usage events
2018-02-08 09:29:22,997: Tracking: tracking
2018-02-08 09:29:23,000: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108425668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084254a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108425b00>]}
2018-02-08 09:29:23,757: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:29:23,778: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:29:23,785: Parsing core.sql
2018-02-08 09:29:23,817: Parsing adapters/bigquery.sql
2018-02-08 09:29:23,829: Parsing adapters/common.sql
2018-02-08 09:29:23,853: Parsing adapters/postgres.sql
2018-02-08 09:29:23,859: Parsing adapters/redshift.sql
2018-02-08 09:29:23,885: Parsing etc/get_custom_schema.sql
2018-02-08 09:29:23,893: Parsing materializations/archive.sql
2018-02-08 09:29:23,936: Parsing materializations/bigquery.sql
2018-02-08 09:29:23,952: Parsing materializations/helpers.sql
2018-02-08 09:29:23,972: Parsing materializations/incremental.sql
2018-02-08 09:29:24,000: Parsing materializations/table.sql
2018-02-08 09:29:24,023: Parsing materializations/view.sql
2018-02-08 09:29:24,040: Parsing materializations/wrapper.sql
2018-02-08 09:29:24,046: Parsing schema_tests/accepted_values.sql
2018-02-08 09:29:24,052: Parsing schema_tests/not_null.sql
2018-02-08 09:29:24,057: Parsing schema_tests/relationships.sql
2018-02-08 09:29:24,062: Parsing schema_tests/unique.sql
2018-02-08 09:29:24,128: Parsing model.seo_audit.accounts_proc
2018-02-08 09:29:24,132: Parsing model.seo_audit.all_dates
2018-02-08 09:29:24,134: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:29:24,136: Acquiring new bigquery connection "master".
2018-02-08 09:29:24,136: Opening a new connection (0 currently allocated)
2018-02-08 09:29:24,143: Parsing model.seo_audit.agg_all
2018-02-08 09:29:24,146: Parsing model.seo_audit.agg_indicative
2018-02-08 09:29:24,149: Parsing model.seo_audit.agg_stats
2018-02-08 09:29:24,153: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:29:24,156: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:29:24,159: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:29:24,162: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:29:24,164: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:29:24,167: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:29:24,171: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:29:24,173: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:29:24,176: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:29:24,181: Parsing model.seo_audit.ga_proc
2018-02-08 09:29:24,185: Parsing model.seo_audit.ga_stats
2018-02-08 09:29:24,187: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:29:24,189: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:29:24,191: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:29:24,194: Parsing model.seo_audit.moz_proc
2018-02-08 09:29:24,196: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:29:24,200: Parsing model.seo_audit.search_console_history
2018-02-08 09:29:24,202: Parsing model.seo_audit.search_console_proc
2018-02-08 09:29:24,204: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:29:24,207: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:29:24,209: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:29:24,212: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:29:24,215: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:29:24,220: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:29:24,224: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:29:24,227: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:29:24,230: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:29:24,244: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:29:24,254: 
2018-02-08 09:29:26,573: 09:29:26 | Concurrency: 4 threads (target='dev')
2018-02-08 09:29:26,573: 09:29:26 | 
2018-02-08 09:29:26,806: 09:29:26 | 1 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:29:26,806: 09:29:26 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:29:26,806: Compiling model.seo_audit.all_dates
2018-02-08 09:29:26,806: 09:29:26 | 3 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:29:26,807: Compiling model.seo_audit.accounts_proc
2018-02-08 09:29:26,811: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:29:26,811: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:29:26,817: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:29:26,822: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:29:26,826: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:29:26,826: Opening a new connection (1 currently allocated)
2018-02-08 09:29:26,827: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:29:26,827: Acquiring new bigquery connection "all_dates".
2018-02-08 09:29:26,829: Opening a new connection (2 currently allocated)
2018-02-08 09:29:26,885: Opening a new connection (3 currently allocated)
2018-02-08 09:29:27,419: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:29:27,441: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:29:27,446: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:29:27,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10854a278>]}
2018-02-08 09:29:27,658: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085df710>]}
2018-02-08 09:29:27,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085df780>]}
2018-02-08 09:29:27,883: 09:29:27 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.84s]
2018-02-08 09:29:28,100: 09:29:28 | 1 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.85s]
2018-02-08 09:29:28,310: 09:29:28 | 3 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.99s]
2018-02-08 09:29:28,311: 09:29:28 | 4 of 33 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 09:29:28,312: Compiling model.seo_audit.ga_proc
2018-02-08 09:29:28,311: 09:29:28 | 5 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:29:28,323: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:29:28,312: 09:29:28 | 6 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:29:28,324: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:29:28,312: 09:29:28 | 7 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:29:28,324: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:29:28,332: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:29:28,332: Compiling model.seo_audit.moz_proc
2018-02-08 09:29:28,337: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:29:28,338: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:29:28,353: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:29:28,355: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:29:28,357: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:29:28,357: Re-using an available connection from the pool.
2018-02-08 09:29:28,359: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:29:28,363: Re-using an available connection from the pool.
2018-02-08 09:29:28,367: Re-using an available connection from the pool.
2018-02-08 09:29:28,370: Opening a new connection (4 currently allocated)
2018-02-08 09:29:28,575: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:29:28,595: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:29:28,688: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:29:28,901: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3fd0>]}
2018-02-08 09:29:28,950: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085a44e0>]}
2018-02-08 09:29:28,962: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:29:29,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086019e8>]}
2018-02-08 09:29:29,141: 09:29:29 | 6 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.58s]
2018-02-08 09:29:29,143: 09:29:29 | 8 of 33 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 09:29:29,145: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:29:29,156: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:29:29,157: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:29:29,157: Re-using an available connection from the pool.
2018-02-08 09:29:29,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108601a90>]}
2018-02-08 09:29:29,357: 09:29:29 | 4 of 33 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.64s]
2018-02-08 09:29:29,358: 09:29:29 | 9 of 33 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:29:29,359: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:29:29,366: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:29:29,367: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:29:29,372: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:29:29,373: Re-using an available connection from the pool.
2018-02-08 09:29:29,578: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:29:29,607: 09:29:29 | 5 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.68s]
2018-02-08 09:29:29,608: 09:29:29 | 10 of 33 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 09:29:29,608: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:29:29,617: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:29:29,620: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:29:29,620: Re-using an available connection from the pool.
2018-02-08 09:29:29,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3fd0>]}
2018-02-08 09:29:29,824: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:29:29,849: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085a44e0>]}
2018-02-08 09:29:29,899: 09:29:29 | 7 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.96s]
2018-02-08 09:29:29,901: 09:29:29 | 11 of 33 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 09:29:29,901: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:29:29,912: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:29:29,917: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:29:29,917: Re-using an available connection from the pool.
2018-02-08 09:29:30,117: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:29:30,124: 09:29:30 | 8 of 33 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.58s]
2018-02-08 09:29:30,125: 09:29:30 | 12 of 33 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 09:29:30,125: Compiling model.seo_audit.search_console_proc
2018-02-08 09:29:30,131: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:29:30,135: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:29:30,137: Re-using an available connection from the pool.
2018-02-08 09:29:30,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085cf470>]}
2018-02-08 09:29:30,339: 09:29:30 | 9 of 33 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.49s]
2018-02-08 09:29:30,340: 09:29:30 | 13 of 33 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 09:29:30,340: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:29:30,347: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:29:30,349: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:29:30,349: Re-using an available connection from the pool.
2018-02-08 09:29:30,385: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:29:30,408: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fcd6a0>]}
2018-02-08 09:29:30,526: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:29:30,601: 09:29:30 | 10 of 33 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.53s]
2018-02-08 09:29:30,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3fd0>]}
2018-02-08 09:29:30,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085a43c8>]}
2018-02-08 09:29:30,922: 09:29:30 | 11 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.51s]
2018-02-08 09:29:31,127: 09:29:31 | 12 of 33 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.56s]
2018-02-08 09:29:31,351: 09:29:31 | 13 of 33 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.50s]
2018-02-08 09:29:31,352: 09:29:31 | 14 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:29:31,353: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:29:31,353: 09:29:31 | 15 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:29:31,353: 09:29:31 | 16 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:29:31,363: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:29:31,364: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:29:31,353: 09:29:31 | 17 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:29:31,364: Compiling model.seo_audit.ga_stats
2018-02-08 09:29:31,370: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:29:31,370: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:29:31,371: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:29:31,375: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:29:31,380: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:29:31,380: Re-using an available connection from the pool.
2018-02-08 09:29:31,382: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:29:31,386: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:29:31,389: Re-using an available connection from the pool.
2018-02-08 09:29:31,389: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:29:31,390: Re-using an available connection from the pool.
2018-02-08 09:29:31,394: Re-using an available connection from the pool.
2018-02-08 09:29:31,582: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:29:31,601: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:29:31,622: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:29:31,629: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:29:31,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10863c828>]}
2018-02-08 09:29:31,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085b3cc0>]}
2018-02-08 09:29:31,906: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108601240>]}
2018-02-08 09:29:32,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085cf9e8>]}
2018-02-08 09:29:32,167: 09:29:32 | 15 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.53s]
2018-02-08 09:29:32,169: 09:29:32 | 18 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:29:32,170: Compiling model.seo_audit.search_console_history
2018-02-08 09:29:32,177: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:29:32,180: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:29:32,180: Re-using an available connection from the pool.
2018-02-08 09:29:32,390: 09:29:32 | 14 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.55s]
2018-02-08 09:29:32,407: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:29:32,595: 09:29:32 | 17 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.54s]
2018-02-08 09:29:32,683: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085f26d8>]}
2018-02-08 09:29:32,802: 09:29:32 | 16 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.64s]
2018-02-08 09:29:33,063: 09:29:33 | 18 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.51s]
2018-02-08 09:29:33,064: 09:29:33 | 19 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:29:33,064: 09:29:33 | 20 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:29:33,064: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:29:33,064: 09:29:33 | 21 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:29:33,065: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:29:33,074: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:29:33,074: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:29:33,079: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:29:33,084: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:29:33,086: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:29:33,087: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:29:33,089: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:29:33,089: Re-using an available connection from the pool.
2018-02-08 09:29:33,089: Re-using an available connection from the pool.
2018-02-08 09:29:33,090: Re-using an available connection from the pool.
2018-02-08 09:29:33,289: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:29:33,294: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:29:33,309: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:29:33,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fcd6a0>]}
2018-02-08 09:29:33,661: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085cfef0>]}
2018-02-08 09:29:33,691: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10854a198>]}
2018-02-08 09:29:34,066: 09:29:34 | 19 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.59s]
2018-02-08 09:29:34,278: 09:29:34 | 20 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.60s]
2018-02-08 09:29:34,480: 09:29:34 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.62s]
2018-02-08 09:29:34,480: 09:29:34 | 22 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:29:34,481: 09:29:34 | 23 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:29:34,481: 09:29:34 | 24 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:29:34,481: 09:29:34 | 25 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:29:34,482: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:29:34,482: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:29:34,482: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:29:34,482: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:29:34,491: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:29:34,497: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:29:34,502: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:29:34,506: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:29:34,508: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:29:34,509: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:29:34,509: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:29:34,510: Re-using an available connection from the pool.
2018-02-08 09:29:34,510: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:29:34,511: Re-using an available connection from the pool.
2018-02-08 09:29:34,512: Re-using an available connection from the pool.
2018-02-08 09:29:34,513: Re-using an available connection from the pool.
2018-02-08 09:29:34,723: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:29:34,727: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:29:34,736: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:29:34,743: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:29:35,140: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10852a4e0>]}
2018-02-08 09:29:35,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10863cba8>]}
2018-02-08 09:29:35,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10861db38>]}
2018-02-08 09:29:35,177: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085df358>]}
2018-02-08 09:29:35,365: 09:29:35 | 25 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.66s]
2018-02-08 09:29:35,593: 09:29:35 | 24 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.66s]
2018-02-08 09:29:35,876: 09:29:35 | 23 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.67s]
2018-02-08 09:29:36,168: 09:29:36 | 22 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.70s]
2018-02-08 09:29:36,169: 09:29:36 | 26 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:29:36,169: 09:29:36 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:29:36,170: Compiling model.seo_audit.agg_indicative
2018-02-08 09:29:36,169: 09:29:36 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:29:36,170: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:29:36,169: 09:29:36 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:29:36,177: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:29:36,182: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:29:36,188: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:29:36,191: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:29:36,199: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:29:36,204: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:29:36,205: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:29:36,205: Re-using an available connection from the pool.
2018-02-08 09:29:36,206: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:29:36,207: Re-using an available connection from the pool.
2018-02-08 09:29:36,208: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:29:36,208: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:29:36,210: Re-using an available connection from the pool.
2018-02-08 09:29:36,215: Re-using an available connection from the pool.
2018-02-08 09:29:36,450: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:29:36,459: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:29:36,464: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:29:36,496: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:29:36,888: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10854a198>]}
2018-02-08 09:29:36,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085df518>]}
2018-02-08 09:29:36,991: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085a4a90>]}
2018-02-08 09:29:37,101: 09:29:37 | 26 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.72s]
2018-02-08 09:29:37,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085a4f28>]}
2018-02-08 09:29:37,327: 09:29:37 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.80s]
2018-02-08 09:29:37,530: 09:29:37 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.81s]
2018-02-08 09:29:37,743: 09:29:37 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 1.12s]
2018-02-08 09:29:37,743: 09:29:37 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:29:37,744: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:29:37,753: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:29:37,754: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:29:37,754: Re-using an available connection from the pool.
2018-02-08 09:29:37,846: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case 
	when ( a.query_string != b.query_string and b.pct_of_value < .3 ) then 1
	when ( a.filename != c.filename and c.pct_of_value < .3 ) then 1
	when ( a.first_path != d.first_path and d.pct_of_value < .3 ) then 1
	else 0 end as reclass,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:29:38,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085cfef0>]}
2018-02-08 09:29:38,728: 09:29:38 | 30 of 33 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 0.77s]
2018-02-08 09:29:38,729: 09:29:38 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:29:38,729: Compiling model.seo_audit.agg_stats
2018-02-08 09:29:38,744: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:29:38,747: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:29:38,748: Re-using an available connection from the pool.
2018-02-08 09:29:38,954: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:29:39,570: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085190b8>]}
2018-02-08 09:29:39,806: 09:29:39 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.84s]
2018-02-08 09:29:39,807: 09:29:39 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:29:39,808: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:29:39,819: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:29:39,820: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:29:39,820: Re-using an available connection from the pool.
2018-02-08 09:29:40,034: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:29:40,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10859fcc0>]}
2018-02-08 09:29:40,902: 09:29:40 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.86s]
2018-02-08 09:29:40,903: 09:29:40 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:29:40,904: Compiling model.seo_audit.agg_all
2018-02-08 09:29:40,912: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:29:40,917: Acquiring new bigquery connection "agg_all".
2018-02-08 09:29:40,917: Re-using an available connection from the pool.
2018-02-08 09:29:41,115: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:29:42,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f892e87-6b67-4e22-b554-5dd3362fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085190b8>]}
2018-02-08 09:29:42,233: 09:29:42 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.11s]
2018-02-08 09:29:42,286: 09:29:42 | 
2018-02-08 09:29:42,286: 09:29:42 | Finished running 33 view models in 15.72s.
2018-02-08 09:29:42,286: Connection 'master' was left open.
2018-02-08 09:29:42,286: 
2018-02-08 09:29:42,286: Completed successfully
2018-02-08 09:29:42,287: 
Done. PASS=33 ERROR=0 SKIP=0 TOTAL=33
2018-02-08 09:29:42,287: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f3748>]}
2018-02-08 09:29:42,509: Flushing usage events
2018-02-08 09:33:12,938: Tracking: tracking
2018-02-08 09:33:12,941: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf677b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf67710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf6bf28>]}
2018-02-08 09:33:13,737: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:33:13,756: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:33:13,762: Parsing core.sql
2018-02-08 09:33:13,785: Parsing adapters/bigquery.sql
2018-02-08 09:33:13,793: Parsing adapters/common.sql
2018-02-08 09:33:13,814: Parsing adapters/postgres.sql
2018-02-08 09:33:13,821: Parsing adapters/redshift.sql
2018-02-08 09:33:13,846: Parsing etc/get_custom_schema.sql
2018-02-08 09:33:13,856: Parsing materializations/archive.sql
2018-02-08 09:33:13,897: Parsing materializations/bigquery.sql
2018-02-08 09:33:13,917: Parsing materializations/helpers.sql
2018-02-08 09:33:13,942: Parsing materializations/incremental.sql
2018-02-08 09:33:13,982: Parsing materializations/table.sql
2018-02-08 09:33:14,010: Parsing materializations/view.sql
2018-02-08 09:33:14,035: Parsing materializations/wrapper.sql
2018-02-08 09:33:14,041: Parsing schema_tests/accepted_values.sql
2018-02-08 09:33:14,047: Parsing schema_tests/not_null.sql
2018-02-08 09:33:14,051: Parsing schema_tests/relationships.sql
2018-02-08 09:33:14,058: Parsing schema_tests/unique.sql
2018-02-08 09:33:14,147: Parsing model.seo_audit.accounts_proc
2018-02-08 09:33:14,152: Parsing model.seo_audit.all_dates
2018-02-08 09:33:14,154: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:33:14,159: Acquiring new bigquery connection "master".
2018-02-08 09:33:14,159: Opening a new connection (0 currently allocated)
2018-02-08 09:33:14,165: Parsing model.seo_audit.agg_all
2018-02-08 09:33:14,170: Parsing model.seo_audit.agg_indicative
2018-02-08 09:33:14,175: Parsing model.seo_audit.agg_stats
2018-02-08 09:33:14,183: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:33:14,187: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:33:14,190: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:33:14,193: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:33:14,196: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:33:14,198: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:33:14,201: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:33:14,203: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:33:14,205: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:33:14,207: Parsing model.seo_audit.ga_proc
2018-02-08 09:33:14,210: Parsing model.seo_audit.ga_stats
2018-02-08 09:33:14,211: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:33:14,214: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:33:14,216: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:33:14,218: Parsing model.seo_audit.moz_proc
2018-02-08 09:33:14,221: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:33:14,225: Parsing model.seo_audit.search_console_history
2018-02-08 09:33:14,226: Parsing model.seo_audit.search_console_proc
2018-02-08 09:33:14,230: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:33:14,232: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:33:14,234: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:33:14,236: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:33:14,239: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:33:14,242: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:33:14,244: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:33:14,246: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:33:14,248: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:33:14,260: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:33:14,268: 
2018-02-08 09:33:15,412: 09:33:15 | Concurrency: 4 threads (target='dev')
2018-02-08 09:33:15,412: 09:33:15 | 
2018-02-08 09:33:15,640: 09:33:15 | 1 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:33:15,640: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:33:15,640: 09:33:15 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:33:15,647: Compiling model.seo_audit.accounts_proc
2018-02-08 09:33:15,640: 09:33:15 | 3 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:33:15,648: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:33:15,655: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:33:15,656: Compiling model.seo_audit.all_dates
2018-02-08 09:33:15,661: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:33:15,662: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:33:15,663: Opening a new connection (1 currently allocated)
2018-02-08 09:33:15,668: Acquiring new bigquery connection "all_dates".
2018-02-08 09:33:15,668: Opening a new connection (2 currently allocated)
2018-02-08 09:33:15,669: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:33:15,731: Opening a new connection (3 currently allocated)
2018-02-08 09:33:16,278: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:33:16,318: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:33:16,416: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:33:16,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0a3940>]}
2018-02-08 09:33:16,552: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124668>]}
2018-02-08 09:33:16,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124630>]}
2018-02-08 09:33:16,735: 09:33:16 | 3 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.84s]
2018-02-08 09:33:17,038: 09:33:17 | 1 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.91s]
2018-02-08 09:33:17,267: 09:33:17 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.96s]
2018-02-08 09:33:17,268: 09:33:17 | 4 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:33:17,269: Compiling model.seo_audit.search_console_proc
2018-02-08 09:33:17,268: 09:33:17 | 5 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:33:17,275: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:33:17,276: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:33:17,268: 09:33:17 | 6 of 33 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:33:17,268: 09:33:17 | 7 of 33 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 09:33:17,285: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:33:17,286: Compiling model.seo_audit.moz_proc
2018-02-08 09:33:17,287: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:33:17,287: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:33:17,298: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:33:17,298: Re-using an available connection from the pool.
2018-02-08 09:33:17,299: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:33:17,320: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:33:17,323: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:33:17,323: Re-using an available connection from the pool.
2018-02-08 09:33:17,325: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:33:17,332: Re-using an available connection from the pool.
2018-02-08 09:33:17,338: Opening a new connection (4 currently allocated)
2018-02-08 09:33:17,557: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:33:17,560: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:33:17,605: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:33:17,764: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:33:17,842: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124da0>]}
2018-02-08 09:33:17,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0399e8>]}
2018-02-08 09:33:17,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124828>]}
2018-02-08 09:33:18,149: 09:33:18 | 6 of 33 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.56s]
2018-02-08 09:33:18,150: 09:33:18 | 8 of 33 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 09:33:18,151: Compiling model.seo_audit.ga_proc
2018-02-08 09:33:18,163: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:33:18,165: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:33:18,165: Re-using an available connection from the pool.
2018-02-08 09:33:18,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124390>]}
2018-02-08 09:33:18,347: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:33:18,406: 09:33:18 | 4 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.58s]
2018-02-08 09:33:18,407: 09:33:18 | 9 of 33 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 09:33:18,407: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:33:18,412: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:33:18,416: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:33:18,416: Re-using an available connection from the pool.
2018-02-08 09:33:18,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d124da0>]}
2018-02-08 09:33:18,667: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:33:18,742: 09:33:18 | 5 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.64s]
2018-02-08 09:33:18,743: 09:33:18 | 10 of 33 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 09:33:18,747: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:33:18,757: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:33:18,758: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:33:18,759: Re-using an available connection from the pool.
2018-02-08 09:33:18,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0399e8>]}
2018-02-08 09:33:18,979: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:33:18,996: 09:33:18 | 7 of 33 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.92s]
2018-02-08 09:33:18,997: 09:33:18 | 11 of 33 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 09:33:18,998: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:33:19,004: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:33:19,006: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:33:19,006: Re-using an available connection from the pool.
2018-02-08 09:33:19,203: 09:33:19 | 8 of 33 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.50s]
2018-02-08 09:33:19,203: 09:33:19 | 12 of 33 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 09:33:19,204: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:33:19,210: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:33:19,214: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:33:19,214: Re-using an available connection from the pool.
2018-02-08 09:33:19,216: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:33:19,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d16da20>]}
2018-02-08 09:33:19,426: 09:33:19 | 9 of 33 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.55s]
2018-02-08 09:33:19,427: 09:33:19 | 13 of 33 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 09:33:19,428: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:33:19,446: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:33:19,448: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:33:19,448: Re-using an available connection from the pool.
2018-02-08 09:33:19,502: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:33:19,511: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d050b70>]}
2018-02-08 09:33:19,667: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:33:19,684: 09:33:19 | 10 of 33 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.54s]
2018-02-08 09:33:19,806: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d14cb00>]}
2018-02-08 09:33:19,959: 09:33:19 | 11 of 33 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.51s]
2018-02-08 09:33:19,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0399e8>]}
2018-02-08 09:33:20,188: 09:33:20 | 12 of 33 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.60s]
2018-02-08 09:33:21,310: 09:33:21 | 13 of 33 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.56s]
2018-02-08 09:33:21,311: 09:33:21 | 14 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:33:21,312: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:33:21,311: 09:33:21 | 15 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:33:21,312: 09:33:21 | 16 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:33:21,324: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:33:21,312: 09:33:21 | 17 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:33:21,324: Compiling model.seo_audit.ga_stats
2018-02-08 09:33:21,324: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:33:21,331: Compiling model.seo_audit.search_console_history
2018-02-08 09:33:21,335: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:33:21,342: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:33:21,351: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:33:21,352: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:33:21,354: Re-using an available connection from the pool.
2018-02-08 09:33:21,352: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:33:21,357: Re-using an available connection from the pool.
2018-02-08 09:33:21,358: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:33:21,359: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:33:21,360: Re-using an available connection from the pool.
2018-02-08 09:33:21,365: Re-using an available connection from the pool.
2018-02-08 09:33:21,578: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:33:21,583: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:33:21,585: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:33:21,639: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:33:21,883: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1457f0>]}
2018-02-08 09:33:21,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d145470>]}
2018-02-08 09:33:21,925: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1455c0>]}
2018-02-08 09:33:21,925: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1240b8>]}
2018-02-08 09:33:22,093: 09:33:22 | 17 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.55s]
2018-02-08 09:33:22,094: 09:33:22 | 18 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:33:22,095: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:33:22,105: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:33:22,107: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:33:22,107: Re-using an available connection from the pool.
2018-02-08 09:33:22,400: 09:33:22 | 14 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.59s]
2018-02-08 09:33:22,405: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:33:22,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1457f0>]}
2018-02-08 09:33:22,730: 09:33:22 | 16 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.60s]
2018-02-08 09:33:23,025: 09:33:23 | 15 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.60s]
2018-02-08 09:33:23,369: 09:33:23 | 18 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.60s]
2018-02-08 09:33:23,370: 09:33:23 | 19 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:33:23,371: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:33:23,371: 09:33:23 | 20 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:33:23,378: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:33:23,371: 09:33:23 | 21 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:33:23,384: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:33:23,385: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:33:23,385: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:33:23,391: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:33:23,392: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:33:23,392: Re-using an available connection from the pool.
2018-02-08 09:33:23,393: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:33:23,393: Re-using an available connection from the pool.
2018-02-08 09:33:23,396: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:33:23,396: Re-using an available connection from the pool.
2018-02-08 09:33:23,603: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:33:23,640: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:33:23,642: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:33:24,006: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0a3ac8>]}
2018-02-08 09:33:24,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1457f0>]}
2018-02-08 09:33:24,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d153c88>]}
2018-02-08 09:33:24,258: 09:33:24 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.62s]
2018-02-08 09:33:24,590: 09:33:24 | 20 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.63s]
2018-02-08 09:33:24,875: 09:33:24 | 19 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.64s]
2018-02-08 09:33:24,876: 09:33:24 | 22 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:33:24,876: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:33:24,876: 09:33:24 | 23 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:33:24,883: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:33:24,876: 09:33:24 | 24 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:33:24,891: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:33:24,891: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:33:24,876: 09:33:24 | 25 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:33:24,892: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:33:24,899: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:33:24,902: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:33:24,911: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:33:24,918: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:33:24,918: Re-using an available connection from the pool.
2018-02-08 09:33:24,912: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:33:24,933: Re-using an available connection from the pool.
2018-02-08 09:33:24,933: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:33:24,946: Re-using an available connection from the pool.
2018-02-08 09:33:24,945: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:33:24,959: Re-using an available connection from the pool.
2018-02-08 09:33:25,183: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:33:25,187: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:33:25,195: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:33:25,204: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:33:25,647: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d153160>]}
2018-02-08 09:33:25,648: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d16d0b8>]}
2018-02-08 09:33:25,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d145240>]}
2018-02-08 09:33:25,650: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d095208>]}
2018-02-08 09:33:25,930: 09:33:25 | 24 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.76s]
2018-02-08 09:33:26,220: 09:33:26 | 23 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.76s]
2018-02-08 09:33:26,548: 09:33:26 | 25 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.75s]
2018-02-08 09:33:26,763: 09:33:26 | 22 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.77s]
2018-02-08 09:33:26,764: 09:33:26 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:33:26,765: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:33:26,765: 09:33:26 | 28 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:33:26,764: 09:33:26 | 27 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:33:26,771: Compiling model.seo_audit.agg_indicative
2018-02-08 09:33:26,765: 09:33:26 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:33:26,774: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:33:26,774: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:33:26,780: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:33:26,781: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:33:26,793: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:33:26,793: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:33:26,795: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:33:26,797: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:33:26,798: Re-using an available connection from the pool.
2018-02-08 09:33:26,799: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:33:26,804: Re-using an available connection from the pool.
2018-02-08 09:33:26,808: Re-using an available connection from the pool.
2018-02-08 09:33:26,814: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:33:26,815: Re-using an available connection from the pool.
2018-02-08 09:33:27,004: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:33:27,007: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:33:27,016: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:33:27,034: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:33:27,492: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1154e0>]}
2018-02-08 09:33:27,494: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1156d8>]}
2018-02-08 09:33:27,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d050fd0>]}
2018-02-08 09:33:27,501: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06dda0>]}
2018-02-08 09:33:27,713: 09:33:27 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.71s]
2018-02-08 09:33:28,002: 09:33:28 | 28 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.72s]
2018-02-08 09:33:28,301: 09:33:28 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.73s]
2018-02-08 09:33:28,597: 09:33:28 | 27 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.73s]
2018-02-08 09:33:28,598: 09:33:28 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:33:28,598: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:33:28,609: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:33:28,610: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:33:28,610: Re-using an available connection from the pool.
2018-02-08 09:33:28,784: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case 
	when ( ( a.query_string != b.query_string ) and b.pct_of_value < .3 ) then 1
	when ( ( a.filename != c.filename ) and c.pct_of_value < .3 ) then 1
	when ( ( a.first_path != d.first_path ) and d.pct_of_value < .3 ) then 1
	else 0 end as reclass,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:33:29,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d095208>]}
2018-02-08 09:33:29,674: 09:33:29 | 30 of 33 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 0.87s]
2018-02-08 09:33:29,675: 09:33:29 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:33:29,675: Compiling model.seo_audit.agg_stats
2018-02-08 09:33:29,691: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:33:29,692: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:33:29,693: Re-using an available connection from the pool.
2018-02-08 09:33:29,892: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:33:30,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06dda0>]}
2018-02-08 09:33:30,770: 09:33:30 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.89s]
2018-02-08 09:33:30,771: 09:33:30 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:33:30,772: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:33:30,784: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:33:30,785: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:33:30,785: Re-using an available connection from the pool.
2018-02-08 09:33:30,977: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:33:31,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1458d0>]}
2018-02-08 09:33:31,916: 09:33:31 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.88s]
2018-02-08 09:33:31,917: 09:33:31 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:33:31,917: Compiling model.seo_audit.agg_all
2018-02-08 09:33:31,927: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:33:31,928: Acquiring new bigquery connection "agg_all".
2018-02-08 09:33:31,928: Re-using an available connection from the pool.
2018-02-08 09:33:32,120: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:33:32,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '88f159ee-867e-4dc4-aae7-03347024d24f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06dda0>]}
2018-02-08 09:33:33,121: 09:33:33 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.00s]
2018-02-08 09:33:33,188: 09:33:33 | 
2018-02-08 09:33:33,188: 09:33:33 | Finished running 33 view models in 17.78s.
2018-02-08 09:33:33,188: Connection 'master' was left open.
2018-02-08 09:33:33,188: 
2018-02-08 09:33:33,189: Completed successfully
2018-02-08 09:33:33,189: 
Done. PASS=33 ERROR=0 SKIP=0 TOTAL=33
2018-02-08 09:33:33,189: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0702e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d039550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d039630>]}
2018-02-08 09:33:33,476: Flushing usage events
2018-02-08 09:35:38,550: Tracking: tracking
2018-02-08 09:35:38,553: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a44668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a444a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a44b00>]}
2018-02-08 09:35:39,331: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:35:39,349: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:35:39,356: Parsing core.sql
2018-02-08 09:35:39,382: Parsing adapters/bigquery.sql
2018-02-08 09:35:39,389: Parsing adapters/common.sql
2018-02-08 09:35:39,407: Parsing adapters/postgres.sql
2018-02-08 09:35:39,412: Parsing adapters/redshift.sql
2018-02-08 09:35:39,433: Parsing etc/get_custom_schema.sql
2018-02-08 09:35:39,442: Parsing materializations/archive.sql
2018-02-08 09:35:39,476: Parsing materializations/bigquery.sql
2018-02-08 09:35:39,493: Parsing materializations/helpers.sql
2018-02-08 09:35:39,521: Parsing materializations/incremental.sql
2018-02-08 09:35:39,556: Parsing materializations/table.sql
2018-02-08 09:35:39,583: Parsing materializations/view.sql
2018-02-08 09:35:39,600: Parsing materializations/wrapper.sql
2018-02-08 09:35:39,606: Parsing schema_tests/accepted_values.sql
2018-02-08 09:35:39,614: Parsing schema_tests/not_null.sql
2018-02-08 09:35:39,622: Parsing schema_tests/relationships.sql
2018-02-08 09:35:39,629: Parsing schema_tests/unique.sql
2018-02-08 09:35:39,693: Parsing model.seo_audit.accounts_proc
2018-02-08 09:35:39,697: Parsing model.seo_audit.all_dates
2018-02-08 09:35:39,699: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:35:39,702: Acquiring new bigquery connection "master".
2018-02-08 09:35:39,702: Opening a new connection (0 currently allocated)
2018-02-08 09:35:39,708: Parsing model.seo_audit.agg_all
2018-02-08 09:35:39,713: Parsing model.seo_audit.agg_indicative
2018-02-08 09:35:39,718: Parsing model.seo_audit.agg_stats
2018-02-08 09:35:39,723: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:35:39,726: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:35:39,729: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:35:39,732: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:35:39,735: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:35:39,737: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:35:39,740: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:35:39,742: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:35:39,744: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:35:39,746: Parsing model.seo_audit.ga_proc
2018-02-08 09:35:39,750: Parsing model.seo_audit.ga_stats
2018-02-08 09:35:39,751: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:35:39,753: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:35:39,756: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:35:39,758: Parsing model.seo_audit.moz_proc
2018-02-08 09:35:39,760: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:35:39,764: Parsing model.seo_audit.search_console_history
2018-02-08 09:35:39,766: Parsing model.seo_audit.search_console_proc
2018-02-08 09:35:39,769: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:35:39,772: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:35:39,773: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:35:39,776: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:35:39,779: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:35:39,784: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:35:39,788: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:35:39,791: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:35:39,794: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:35:39,810: Found 33 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:35:39,819: 
2018-02-08 09:35:40,641: 09:35:40 | Concurrency: 4 threads (target='dev')
2018-02-08 09:35:40,642: 09:35:40 | 
2018-02-08 09:35:40,841: 09:35:40 | 1 of 33 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:35:40,842: Compiling model.seo_audit.all_dates
2018-02-08 09:35:40,845: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:35:40,841: 09:35:40 | 2 of 33 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:35:40,846: Compiling model.seo_audit.accounts_proc
2018-02-08 09:35:40,847: Acquiring new bigquery connection "all_dates".
2018-02-08 09:35:40,842: 09:35:40 | 3 of 33 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:35:40,852: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:35:40,852: Opening a new connection (1 currently allocated)
2018-02-08 09:35:40,852: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:35:40,857: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:35:40,861: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:35:40,861: Opening a new connection (2 currently allocated)
2018-02-08 09:35:40,918: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:35:40,921: Opening a new connection (3 currently allocated)
2018-02-08 09:35:41,445: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:35:41,454: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:35:41,506: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:35:41,652: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c02748>]}
2018-02-08 09:35:41,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b806d8>]}
2018-02-08 09:35:41,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c02710>]}
2018-02-08 09:35:42,032: 09:35:42 | 2 of 33 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.81s]
2018-02-08 09:35:42,330: 09:35:42 | 1 of 33 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.82s]
2018-02-08 09:35:42,627: 09:35:42 | 3 of 33 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.86s]
2018-02-08 09:35:42,628: 09:35:42 | 4 of 33 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 09:35:42,629: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:35:42,629: 09:35:42 | 5 of 33 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:35:42,636: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:35:42,629: 09:35:42 | 6 of 33 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 09:35:42,644: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:35:42,646: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:35:42,629: 09:35:42 | 7 of 33 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:35:42,647: Compiling model.seo_audit.ga_proc
2018-02-08 09:35:42,647: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:35:42,652: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:35:42,654: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:35:42,659: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:35:42,660: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:35:42,661: Re-using an available connection from the pool.
2018-02-08 09:35:42,661: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:35:42,662: Re-using an available connection from the pool.
2018-02-08 09:35:42,674: Re-using an available connection from the pool.
2018-02-08 09:35:42,676: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:35:42,676: Opening a new connection (4 currently allocated)
2018-02-08 09:35:42,874: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:35:42,893: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:35:42,919: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:35:43,156: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:35:43,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf03c8>]}
2018-02-08 09:35:43,209: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c271d0>]}
2018-02-08 09:35:43,218: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c14550>]}
2018-02-08 09:35:43,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c14470>]}
2018-02-08 09:35:43,479: 09:35:43 | 6 of 33 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.54s]
2018-02-08 09:35:43,480: 09:35:43 | 8 of 33 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:35:43,481: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:35:43,495: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:35:43,498: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:35:43,499: Re-using an available connection from the pool.
2018-02-08 09:35:43,717: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:35:43,723: 09:35:43 | 5 of 33 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.57s]
2018-02-08 09:35:43,724: 09:35:43 | 9 of 33 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:35:43,724: Compiling model.seo_audit.search_console_proc
2018-02-08 09:35:43,729: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:35:43,733: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:35:43,733: Re-using an available connection from the pool.
2018-02-08 09:35:43,960: 09:35:43 | 4 of 33 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.59s]
2018-02-08 09:35:43,961: 09:35:43 | 10 of 33 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 09:35:43,961: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:35:43,969: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:35:43,970: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:35:43,975: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:35:43,975: Re-using an available connection from the pool.
2018-02-08 09:35:44,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf03c8>]}
2018-02-08 09:35:44,171: 09:35:44 | 7 of 33 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.81s]
2018-02-08 09:35:44,172: 09:35:44 | 11 of 33 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 09:35:44,173: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:35:44,173: Compiling model.seo_audit.moz_proc
2018-02-08 09:35:44,182: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:35:44,186: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:35:44,187: Re-using an available connection from the pool.
2018-02-08 09:35:44,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c27208>]}
2018-02-08 09:35:44,422: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:35:44,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c3c8d0>]}
2018-02-08 09:35:44,522: 09:35:44 | 8 of 33 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.52s]
2018-02-08 09:35:44,523: 09:35:44 | 12 of 33 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 09:35:44,523: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:35:44,533: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:35:44,542: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:35:44,542: Re-using an available connection from the pool.
2018-02-08 09:35:44,739: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:35:44,743: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c3c1d0>]}
2018-02-08 09:35:44,744: 09:35:44 | 9 of 33 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.53s]
2018-02-08 09:35:44,747: 09:35:44 | 13 of 33 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 09:35:44,747: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:35:44,753: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:35:44,755: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:35:44,755: Re-using an available connection from the pool.
2018-02-08 09:35:44,964: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:35:45,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b26c50>]}
2018-02-08 09:35:45,128: 09:35:45 | 10 of 33 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.51s]
2018-02-08 09:35:45,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bb0390>]}
2018-02-08 09:35:45,447: 09:35:45 | 11 of 33 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.57s]
2018-02-08 09:35:45,742: 09:35:45 | 12 of 33 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.52s]
2018-02-08 09:35:46,005: 09:35:46 | 13 of 33 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.50s]
2018-02-08 09:35:46,006: 09:35:46 | 14 of 33 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:35:46,007: 09:35:46 | 15 of 33 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:35:46,007: 09:35:46 | 16 of 33 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:35:46,008: Compiling model.seo_audit.search_console_history
2018-02-08 09:35:46,007: 09:35:46 | 17 of 33 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:35:46,008: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:35:46,008: Compiling model.seo_audit.ga_stats
2018-02-08 09:35:46,015: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:35:46,015: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:35:46,019: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:35:46,024: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:35:46,029: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:35:46,031: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:35:46,031: Re-using an available connection from the pool.
2018-02-08 09:35:46,032: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:35:46,033: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:35:46,033: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:35:46,033: Re-using an available connection from the pool.
2018-02-08 09:35:46,035: Re-using an available connection from the pool.
2018-02-08 09:35:46,036: Re-using an available connection from the pool.
2018-02-08 09:35:46,244: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:35:46,264: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:35:46,276: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:35:46,283: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:35:46,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c22080>]}
2018-02-08 09:35:46,655: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b81940>]}
2018-02-08 09:35:46,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf09b0>]}
2018-02-08 09:35:46,745: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bb0cc0>]}
2018-02-08 09:35:46,960: 09:35:46 | 16 of 33 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.65s]
2018-02-08 09:35:46,962: 09:35:46 | 18 of 33 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:35:46,964: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:35:46,974: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:35:46,975: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:35:46,975: Re-using an available connection from the pool.
2018-02-08 09:35:47,182: 09:35:47 | 15 of 33 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.65s]
2018-02-08 09:35:47,192: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:35:47,446: 09:35:47 | 17 of 33 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.68s]
2018-02-08 09:35:47,532: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c27860>]}
2018-02-08 09:35:47,734: 09:35:47 | 14 of 33 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.74s]
2018-02-08 09:35:48,065: 09:35:48 | 18 of 33 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-08 09:35:48,066: 09:35:48 | 19 of 33 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:35:48,067: 09:35:48 | 20 of 33 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:35:48,067: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:35:48,067: 09:35:48 | 21 of 33 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:35:48,068: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:35:48,074: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:35:48,074: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:35:48,081: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:35:48,087: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:35:48,088: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:35:48,088: Re-using an available connection from the pool.
2018-02-08 09:35:48,090: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:35:48,090: Re-using an available connection from the pool.
2018-02-08 09:35:48,091: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:35:48,092: Re-using an available connection from the pool.
2018-02-08 09:35:48,308: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:35:48,314: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:35:48,318: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:35:48,700: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b4afd0>]}
2018-02-08 09:35:48,709: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c14240>]}
2018-02-08 09:35:48,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf09b0>]}
2018-02-08 09:35:48,915: 09:35:48 | 19 of 33 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.63s]
2018-02-08 09:35:49,208: 09:35:49 | 20 of 33 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.64s]
2018-02-08 09:35:49,442: 09:35:49 | 21 of 33 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.69s]
2018-02-08 09:35:49,443: 09:35:49 | 22 of 33 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:35:49,443: 09:35:49 | 23 of 33 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:35:49,444: 09:35:49 | 24 of 33 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:35:49,444: 09:35:49 | 25 of 33 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:35:49,444: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:35:49,444: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:35:49,445: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:35:49,445: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:35:49,467: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:35:49,469: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:35:49,474: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:35:49,475: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:35:49,477: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:35:49,478: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:35:49,478: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:35:49,479: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:35:49,479: Re-using an available connection from the pool.
2018-02-08 09:35:49,480: Re-using an available connection from the pool.
2018-02-08 09:35:49,481: Re-using an available connection from the pool.
2018-02-08 09:35:49,481: Re-using an available connection from the pool.
2018-02-08 09:35:49,699: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:35:49,700: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:35:49,720: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:35:50,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c227f0>]}
2018-02-08 09:35:50,113: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf00f0>]}
2018-02-08 09:35:50,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bf06d8>]}
2018-02-08 09:35:50,411: 09:35:50 | 23 of 33 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.59s]
2018-02-08 09:35:50,708: 09:35:50 | 24 of 33 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.67s]
2018-02-08 09:35:50,953: 09:35:50 | 25 of 33 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.70s]
2018-02-08 09:35:57,621: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:35:58,024: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b81940>]}
2018-02-08 09:35:58,269: 09:35:58 | 22 of 33 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 8.58s]
2018-02-08 09:35:58,270: 09:35:58 | 26 of 33 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:35:58,270: 09:35:58 | 27 of 33 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:35:58,271: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:35:58,270: 09:35:58 | 28 of 33 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:35:58,270: 09:35:58 | 29 of 33 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:35:58,271: Compiling model.seo_audit.agg_indicative
2018-02-08 09:35:58,279: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:35:58,279: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:35:58,279: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:35:58,285: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:35:58,291: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:35:58,297: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:35:58,298: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:35:58,298: Re-using an available connection from the pool.
2018-02-08 09:35:58,300: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:35:58,301: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:35:58,301: Re-using an available connection from the pool.
2018-02-08 09:35:58,301: Re-using an available connection from the pool.
2018-02-08 09:35:58,303: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:35:58,310: Re-using an available connection from the pool.
2018-02-08 09:35:58,501: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:35:58,520: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:35:58,526: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:35:58,532: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:35:58,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b80ba8>]}
2018-02-08 09:35:58,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b80da0>]}
2018-02-08 09:35:58,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c22080>]}
2018-02-08 09:35:59,196: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bb0390>]}
2018-02-08 09:35:59,242: 09:35:59 | 27 of 33 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.67s]
2018-02-08 09:35:59,577: 09:35:59 | 29 of 33 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.69s]
2018-02-08 09:35:59,876: 09:35:59 | 28 of 33 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.70s]
2018-02-08 09:36:00,174: 09:36:00 | 26 of 33 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.93s]
2018-02-08 09:36:00,175: 09:36:00 | 30 of 33 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:36:00,175: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:36:00,187: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:36:00,189: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:36:00,189: Re-using an available connection from the pool.
2018-02-08 09:36:00,384: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case 
	when ( ( a.query_string != b.query_string ) and a.pct_of_value < .3 ) then 1
	when ( ( a.filename != c.filename ) and a.pct_of_value < .3 ) then 1
	when ( ( a.first_path != d.first_path ) and a.pct_of_value < .3 ) then 1
	else 0 end as reclass,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:36:00,733: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
b.pct_of_classification query_string_pct_of_classification,
b.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
c.pct_of_classification filename_pct_of_classification,
c.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
c.pct_of_classification first_path_pct_of_classification,
c.pct_of_value first_path_pct_of_value,
case 
	when ( ( a.query_string != b.query_string ) and a.pct_of_value < .3 ) then 1
	when ( ( a.filename != c.filename ) and a.pct_of_value < .3 ) then 1
	when ( ( a.first_path != d.first_path ) and a.pct_of_value < .3 ) then 1
	else 0 end as reclass,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
2018-02-08 09:36:00,733: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Name pct_of_value not found inside a at [20:59]
2018-02-08 09:36:00,733: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b80748>]}
2018-02-08 09:36:00,945: 09:36:00 | 30 of 33 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.56s]
2018-02-08 09:36:00,946: 09:36:00 | 31 of 33 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:36:00,947: Compiling model.seo_audit.agg_stats
2018-02-08 09:36:00,960: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:36:00,960: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:36:00,961: Re-using an available connection from the pool.
2018-02-08 09:36:01,169: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:36:01,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b69b00>]}
2018-02-08 09:36:02,213: 09:36:02 | 31 of 33 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.96s]
2018-02-08 09:36:02,213: 09:36:02 | 32 of 33 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:36:02,214: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:36:02,223: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:36:02,224: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:36:02,225: Re-using an available connection from the pool.
2018-02-08 09:36:02,446: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:36:03,127: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bb0390>]}
2018-02-08 09:36:03,345: 09:36:03 | 32 of 33 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.91s]
2018-02-08 09:36:03,346: 09:36:03 | 33 of 33 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:36:03,346: Compiling model.seo_audit.agg_all
2018-02-08 09:36:03,356: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:36:03,357: Acquiring new bigquery connection "agg_all".
2018-02-08 09:36:03,358: Re-using an available connection from the pool.
2018-02-08 09:36:03,573: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:36:04,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85c4210b-63ce-4906-b640-3711b9d64fc6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b69b00>]}
2018-02-08 09:36:04,728: 09:36:04 | 33 of 33 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.08s]
2018-02-08 09:36:04,744: 09:36:04 | 
2018-02-08 09:36:04,744: 09:36:04 | Finished running 33 view models in 24.11s.
2018-02-08 09:36:04,744: Connection 'master' was left open.
2018-02-08 09:36:04,745: 
2018-02-08 09:36:04,745: Completed with 1 errors:
2018-02-08 09:36:04,745: 
2018-02-08 09:36:04,745: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 09:36:04,746:   Name pct_of_value not found inside a at [20:59]
2018-02-08 09:36:04,746:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 09:36:04,746: 
Done. PASS=32 ERROR=1 SKIP=0 TOTAL=33
2018-02-08 09:36:04,747: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b12908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b12668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b12748>]}
2018-02-08 09:36:05,045: Flushing usage events
2018-02-08 09:49:22,892: Tracking: tracking
2018-02-08 09:49:22,896: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127c2da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127c2f98>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127c2a20>]}
2018-02-08 09:49:24,299: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 09:49:24,319: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 09:49:24,327: Parsing core.sql
2018-02-08 09:49:24,355: Parsing adapters/bigquery.sql
2018-02-08 09:49:24,363: Parsing adapters/common.sql
2018-02-08 09:49:24,381: Parsing adapters/postgres.sql
2018-02-08 09:49:24,387: Parsing adapters/redshift.sql
2018-02-08 09:49:24,412: Parsing etc/get_custom_schema.sql
2018-02-08 09:49:24,421: Parsing materializations/archive.sql
2018-02-08 09:49:24,455: Parsing materializations/bigquery.sql
2018-02-08 09:49:24,472: Parsing materializations/helpers.sql
2018-02-08 09:49:24,494: Parsing materializations/incremental.sql
2018-02-08 09:49:24,527: Parsing materializations/table.sql
2018-02-08 09:49:24,552: Parsing materializations/view.sql
2018-02-08 09:49:24,569: Parsing materializations/wrapper.sql
2018-02-08 09:49:24,575: Parsing schema_tests/accepted_values.sql
2018-02-08 09:49:24,581: Parsing schema_tests/not_null.sql
2018-02-08 09:49:24,585: Parsing schema_tests/relationships.sql
2018-02-08 09:49:24,591: Parsing schema_tests/unique.sql
2018-02-08 09:49:24,702: Parsing model.seo_audit.accounts_proc
2018-02-08 09:49:24,707: Parsing model.seo_audit.all_dates
2018-02-08 09:49:24,709: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 09:49:24,713: Acquiring new bigquery connection "master".
2018-02-08 09:49:24,714: Opening a new connection (0 currently allocated)
2018-02-08 09:49:24,717: Parsing model.seo_audit.agg_all
2018-02-08 09:49:24,719: Parsing model.seo_audit.agg_indicative
2018-02-08 09:49:24,723: Parsing model.seo_audit.agg_stats
2018-02-08 09:49:24,729: Parsing model.seo_audit.agg_stats_client
2018-02-08 09:49:24,733: Parsing model.seo_audit.deepcrawl_class
2018-02-08 09:49:24,736: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 09:49:24,739: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 09:49:24,741: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 09:49:24,744: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 09:49:24,747: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:49:24,752: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 09:49:24,756: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 09:49:24,763: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:49:24,766: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:49:24,768: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:49:24,770: Parsing model.seo_audit.ga_proc
2018-02-08 09:49:24,773: Parsing model.seo_audit.ga_stats
2018-02-08 09:49:24,775: Parsing model.seo_audit.majestic_domain_history
2018-02-08 09:49:24,777: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 09:49:24,781: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 09:49:24,784: Parsing model.seo_audit.moz_proc
2018-02-08 09:49:24,788: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 09:49:24,792: Parsing model.seo_audit.search_console_history
2018-02-08 09:49:24,794: Parsing model.seo_audit.search_console_proc
2018-02-08 09:49:24,797: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 09:49:24,801: Parsing model.seo_audit.search_console_stats_url
2018-02-08 09:49:24,804: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 09:49:24,807: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 09:49:24,810: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 09:49:24,813: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 09:49:24,816: Parsing model.seo_audit.semrush_url_history
2018-02-08 09:49:24,818: Parsing model.seo_audit.semrush_url_stats
2018-02-08 09:49:24,820: Parsing model.seo_audit.sitemap_proc
2018-02-08 09:49:24,836: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 09:49:24,847: 
2018-02-08 09:49:26,104: 09:49:26 | Concurrency: 4 threads (target='dev')
2018-02-08 09:49:26,104: 09:49:26 | 
2018-02-08 09:49:26,362: 09:49:26 | 1 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 09:49:26,363: Compiling model.seo_audit.accounts_proc
2018-02-08 09:49:26,368: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 09:49:26,363: 09:49:26 | 2 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 09:49:26,363: 09:49:26 | 3 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 09:49:26,369: Compiling model.seo_audit.all_dates
2018-02-08 09:49:26,369: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 09:49:26,373: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 09:49:26,378: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 09:49:26,380: Acquiring new bigquery connection "accounts_proc".
2018-02-08 09:49:26,380: Opening a new connection (1 currently allocated)
2018-02-08 09:49:26,382: Acquiring new bigquery connection "all_dates".
2018-02-08 09:49:26,382: Opening a new connection (2 currently allocated)
2018-02-08 09:49:26,437: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 09:49:26,485: Opening a new connection (3 currently allocated)
2018-02-08 09:49:26,974: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 09:49:26,979: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 09:49:27,046: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 09:49:27,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112900cc0>]}
2018-02-08 09:49:27,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112950780>]}
2018-02-08 09:49:27,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112950518>]}
2018-02-08 09:49:27,431: 09:49:27 | 3 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.85s]
2018-02-08 09:49:27,673: 09:49:27 | 1 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.86s]
2018-02-08 09:49:27,964: 09:49:27 | 2 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.89s]
2018-02-08 09:49:27,965: 09:49:27 | 4 of 36 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 09:49:27,966: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 09:49:27,966: 09:49:27 | 5 of 36 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 09:49:27,973: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 09:49:27,981: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 09:49:27,982: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 09:49:27,966: 09:49:27 | 6 of 36 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 09:49:27,966: 09:49:27 | 7 of 36 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 09:49:27,984: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 09:49:27,984: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 09:49:27,984: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 09:49:27,985: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 09:49:27,990: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 09:49:27,990: Re-using an available connection from the pool.
2018-02-08 09:49:27,997: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 09:49:27,998: Re-using an available connection from the pool.
2018-02-08 09:49:28,008: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 09:49:28,009: Re-using an available connection from the pool.
2018-02-08 09:49:28,010: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 09:49:28,010: Opening a new connection (4 currently allocated)
2018-02-08 09:49:28,214: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 09:49:28,229: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 09:49:28,272: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 09:49:28,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128f9cc0>]}
2018-02-08 09:49:28,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947828>]}
2018-02-08 09:49:28,571: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112900ef0>]}
2018-02-08 09:49:28,582: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:49:28,721: 09:49:28 | 5 of 36 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.53s]
2018-02-08 09:49:28,722: 09:49:28 | 8 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 09:49:28,722: Compiling model.seo_audit.moz_proc
2018-02-08 09:49:28,729: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 09:49:28,732: Acquiring new bigquery connection "moz_proc".
2018-02-08 09:49:28,733: Re-using an available connection from the pool.
2018-02-08 09:49:28,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112986208>]}
2018-02-08 09:49:28,951: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 09:49:29,026: 09:49:29 | 7 of 36 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.55s]
2018-02-08 09:49:29,027: 09:49:29 | 9 of 36 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 09:49:29,027: Compiling model.seo_audit.search_console_proc
2018-02-08 09:49:29,035: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 09:49:29,038: Acquiring new bigquery connection "search_console_proc".
2018-02-08 09:49:29,038: Re-using an available connection from the pool.
2018-02-08 09:49:29,257: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:49:29,296: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112950e80>]}
2018-02-08 09:49:29,299: 09:49:29 | 4 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.61s]
2018-02-08 09:49:29,300: 09:49:29 | 10 of 36 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 09:49:29,300: Compiling model.seo_audit.sitemap_proc
2018-02-08 09:49:29,309: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 09:49:29,311: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 09:49:29,311: Re-using an available connection from the pool.
2018-02-08 09:49:29,526: 09:49:29 | 6 of 36 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.88s]
2018-02-08 09:49:29,527: 09:49:29 | 11 of 36 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 09:49:29,527: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 09:49:29,535: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 09:49:29,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128939b0>]}
2018-02-08 09:49:29,539: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 09:49:29,540: Re-using an available connection from the pool.
2018-02-08 09:49:29,607: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 09:49:29,740: 09:49:29 | 8 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.57s]
2018-02-08 09:49:29,742: 09:49:29 | 12 of 36 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 09:49:29,743: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 09:49:29,750: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 09:49:29,751: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 09:49:29,754: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 09:49:29,754: Re-using an available connection from the pool.
2018-02-08 09:49:29,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112950c50>]}
2018-02-08 09:49:29,959: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 09:49:30,030: 09:49:30 | 9 of 36 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.51s]
2018-02-08 09:49:30,031: 09:49:30 | 13 of 36 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 09:49:30,031: Compiling model.seo_audit.ga_proc
2018-02-08 09:49:30,040: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 09:49:30,046: Acquiring new bigquery connection "ga_proc".
2018-02-08 09:49:30,047: Re-using an available connection from the pool.
2018-02-08 09:49:30,048: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129bd6a0>]}
2018-02-08 09:49:30,286: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 09:49:30,409: 09:49:30 | 10 of 36 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.62s]
2018-02-08 09:49:30,614: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128939b0>]}
2018-02-08 09:49:30,694: 09:49:30 | 11 of 36 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.52s]
2018-02-08 09:49:30,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112900fd0>]}
2018-02-08 09:49:30,939: 09:49:30 | 13 of 36 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.58s]
2018-02-08 09:49:31,246: 09:49:31 | 12 of 36 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 1.08s]
2018-02-08 09:49:31,247: 09:49:31 | 14 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 09:49:31,248: Compiling model.seo_audit.semrush_url_history
2018-02-08 09:49:31,248: 09:49:31 | 15 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 09:49:31,258: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 09:49:31,248: 09:49:31 | 16 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 09:49:31,259: Compiling model.seo_audit.ga_stats
2018-02-08 09:49:31,248: 09:49:31 | 17 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 09:49:31,259: Compiling model.seo_audit.search_console_history
2018-02-08 09:49:31,268: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 09:49:31,269: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 09:49:31,284: Re-using an available connection from the pool.
2018-02-08 09:49:31,269: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 09:49:31,283: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 09:49:31,278: Acquiring new bigquery connection "ga_stats".
2018-02-08 09:49:31,302: Re-using an available connection from the pool.
2018-02-08 09:49:31,306: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 09:49:31,302: Acquiring new bigquery connection "search_console_history".
2018-02-08 09:49:31,306: Re-using an available connection from the pool.
2018-02-08 09:49:31,315: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 09:49:31,316: Re-using an available connection from the pool.
2018-02-08 09:49:31,510: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 09:49:31,533: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 09:49:31,541: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 09:49:31,580: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 09:49:31,778: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112900cc0>]}
2018-02-08 09:49:31,822: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128aa240>]}
2018-02-08 09:49:31,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290a128>]}
2018-02-08 09:49:31,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947828>]}
2018-02-08 09:49:32,020: 09:49:32 | 14 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.53s]
2018-02-08 09:49:32,024: 09:49:32 | 18 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 09:49:32,026: Compiling model.seo_audit.majestic_domain_history
2018-02-08 09:49:32,034: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 09:49:32,035: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 09:49:32,036: Re-using an available connection from the pool.
2018-02-08 09:49:32,269: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 09:49:32,271: 09:49:32 | 15 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.56s]
2018-02-08 09:49:32,513: 09:49:32 | 17 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.58s]
2018-02-08 09:49:32,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290a860>]}
2018-02-08 09:49:32,788: 09:49:32 | 16 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.64s]
2018-02-08 09:49:32,998: 09:49:32 | 18 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-08 09:49:32,999: 09:49:32 | 19 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 09:49:32,999: 09:49:32 | 20 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 09:49:33,000: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 09:49:33,000: 09:49:33 | 21 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 09:49:32,999: Compiling model.seo_audit.search_console_stats_url
2018-02-08 09:49:33,007: Compiling model.seo_audit.deepcrawl_class
2018-02-08 09:49:33,010: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 09:49:33,024: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 09:49:33,025: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 09:49:33,026: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 09:49:33,026: Re-using an available connection from the pool.
2018-02-08 09:49:33,028: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 09:49:33,028: Re-using an available connection from the pool.
2018-02-08 09:49:33,029: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 09:49:33,030: Re-using an available connection from the pool.
2018-02-08 09:49:33,250: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 09:49:33,264: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 09:49:33,273: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 09:49:33,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128f1eb8>]}
2018-02-08 09:49:33,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129af2b0>]}
2018-02-08 09:49:33,664: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128f1320>]}
2018-02-08 09:49:33,950: 09:49:33 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.66s]
2018-02-08 09:49:34,189: 09:49:34 | 19 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.66s]
2018-02-08 09:49:34,397: 09:49:34 | 21 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.66s]
2018-02-08 09:49:34,398: 09:49:34 | 22 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 09:49:34,399: Compiling model.seo_audit.semrush_url_stats
2018-02-08 09:49:34,398: 09:49:34 | 23 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 09:49:34,410: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 09:49:34,399: 09:49:34 | 24 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 09:49:34,410: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 09:49:34,399: 09:49:34 | 25 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 09:49:34,411: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 09:49:34,417: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 09:49:34,419: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 09:49:34,430: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 09:49:34,437: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 09:49:34,454: Re-using an available connection from the pool.
2018-02-08 09:49:34,450: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 09:49:34,453: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 09:49:34,452: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 09:49:34,464: Re-using an available connection from the pool.
2018-02-08 09:49:34,465: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 09:49:34,466: Re-using an available connection from the pool.
2018-02-08 09:49:34,473: Re-using an available connection from the pool.
2018-02-08 09:49:34,681: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:49:34,706: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 09:49:34,714: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 09:49:34,719: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 09:49:35,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128f1e48>]}
2018-02-08 09:49:35,116: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947e80>]}
2018-02-08 09:49:35,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11296f2e8>]}
2018-02-08 09:49:35,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947dd8>]}
2018-02-08 09:49:35,264: 09:49:35 | 25 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.64s]
2018-02-08 09:49:35,483: 09:49:35 | 22 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.72s]
2018-02-08 09:49:35,715: 09:49:35 | 24 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-08 09:49:35,956: 09:49:35 | 23 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.81s]
2018-02-08 09:49:35,957: 09:49:35 | 26 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 09:49:35,958: 09:49:35 | 27 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 09:49:35,958: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 09:49:35,958: 09:49:35 | 28 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 09:49:35,959: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 09:49:35,958: 09:49:35 | 29 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 09:49:35,966: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 09:49:35,967: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 09:49:35,972: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 09:49:35,972: Compiling model.seo_audit.agg_indicative
2018-02-08 09:49:35,977: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 09:49:35,982: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 09:49:35,983: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 09:49:35,983: Re-using an available connection from the pool.
2018-02-08 09:49:35,985: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 09:49:35,986: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 09:49:35,986: Re-using an available connection from the pool.
2018-02-08 09:49:35,988: Acquiring new bigquery connection "agg_indicative".
2018-02-08 09:49:35,991: Re-using an available connection from the pool.
2018-02-08 09:49:35,993: Re-using an available connection from the pool.
2018-02-08 09:49:36,104: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 09:49:36,196: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:49:36,211: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 09:49:36,213: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:49:36,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947dd8>]}
2018-02-08 09:49:36,604: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128c88d0>]}
2018-02-08 09:49:36,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129475f8>]}
2018-02-08 09:49:36,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947438>]}
2018-02-08 09:49:36,805: 09:49:36 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.63s]
2018-02-08 09:49:36,806: 09:49:36 | 30 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 09:49:36,807: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 09:49:36,815: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 09:49:36,817: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 09:49:36,817: Re-using an available connection from the pool.
2018-02-08 09:49:36,902: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 09:49:37,034: 09:49:37 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.65s]
2018-02-08 09:49:37,036: 09:49:37 | 31 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 09:49:37,039: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 09:49:37,048: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 09:49:37,050: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 09:49:37,050: Re-using an available connection from the pool.
2018-02-08 09:49:37,133: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 09:49:37,326: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112947dd8>]}
2018-02-08 09:49:37,348: 09:49:37 | 29 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.66s]
2018-02-08 09:49:37,349: 09:49:37 | 32 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 09:49:37,351: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 09:49:37,363: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 09:49:37,364: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 09:49:37,364: Re-using an available connection from the pool.
2018-02-08 09:49:37,573: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 09:49:37,652: 09:49:37 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.73s]
2018-02-08 09:49:37,659: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128c88d0>]}
2018-02-08 09:49:37,945: 09:49:37 | 30 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.52s]
2018-02-08 09:49:38,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290a358>]}
2018-02-08 09:49:38,296: 09:49:38 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.62s]
2018-02-08 09:49:38,510: 09:49:38 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.66s]
2018-02-08 09:49:38,511: 09:49:38 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 09:49:38,511: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 09:49:38,523: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 09:49:38,524: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 09:49:38,525: Re-using an available connection from the pool.
2018-02-08 09:49:38,631: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case 
	when ( ( a.query_string != b.query_string ) and e.pct_of_value < .3 ) then 1
	when ( ( a.filename != c.filename ) and f.pct_of_value < .3 ) then 1
	when ( ( a.first_path != d.first_path ) and g.pct_of_value < .3 ) then 1
	else 0 end as reclass,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 09:49:39,676: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128939b0>]}
2018-02-08 09:49:39,998: 09:49:39 | 33 of 36 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.16s]
2018-02-08 09:49:39,999: 09:49:39 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 09:49:39,999: Compiling model.seo_audit.agg_stats
2018-02-08 09:49:40,010: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 09:49:40,011: Acquiring new bigquery connection "agg_stats".
2018-02-08 09:49:40,011: Re-using an available connection from the pool.
2018-02-08 09:49:40,253: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 09:49:40,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290a358>]}
2018-02-08 09:49:41,112: 09:49:41 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.79s]
2018-02-08 09:49:41,113: 09:49:41 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 09:49:41,113: Compiling model.seo_audit.agg_stats_client
2018-02-08 09:49:41,123: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 09:49:41,124: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 09:49:41,124: Re-using an available connection from the pool.
2018-02-08 09:49:41,371: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 09:49:42,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128939b0>]}
2018-02-08 09:49:42,381: 09:49:42 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.04s]
2018-02-08 09:49:42,382: 09:49:42 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 09:49:42,382: Compiling model.seo_audit.agg_all
2018-02-08 09:49:42,393: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 09:49:42,395: Acquiring new bigquery connection "agg_all".
2018-02-08 09:49:42,395: Re-using an available connection from the pool.
2018-02-08 09:49:42,612: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 09:49:43,365: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea560ab6-2a7f-4697-8d9d-90eedda9842e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11290a358>]}
2018-02-08 09:49:43,582: 09:49:43 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.98s]
2018-02-08 09:49:43,596: 09:49:43 | 
2018-02-08 09:49:43,597: 09:49:43 | Finished running 36 view models in 17.50s.
2018-02-08 09:49:43,597: Connection 'master' was left open.
2018-02-08 09:49:43,597: 
2018-02-08 09:49:43,598: Completed successfully
2018-02-08 09:49:43,598: 
Done. PASS=36 ERROR=0 SKIP=0 TOTAL=36
2018-02-08 09:49:43,599: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112893828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112893fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128937b8>]}
2018-02-08 09:49:43,916: Flushing usage events
2018-02-08 10:01:56,003: Tracking: tracking
2018-02-08 10:01:56,005: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057614a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105747ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105747dd8>]}
2018-02-08 10:01:56,767: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:01:56,783: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:01:56,787: Parsing core.sql
2018-02-08 10:01:56,812: Parsing adapters/bigquery.sql
2018-02-08 10:01:56,823: Parsing adapters/common.sql
2018-02-08 10:01:56,845: Parsing adapters/postgres.sql
2018-02-08 10:01:56,853: Parsing adapters/redshift.sql
2018-02-08 10:01:56,881: Parsing etc/get_custom_schema.sql
2018-02-08 10:01:56,895: Parsing materializations/archive.sql
2018-02-08 10:01:56,934: Parsing materializations/bigquery.sql
2018-02-08 10:01:56,951: Parsing materializations/helpers.sql
2018-02-08 10:01:56,971: Parsing materializations/incremental.sql
2018-02-08 10:01:57,000: Parsing materializations/table.sql
2018-02-08 10:01:57,021: Parsing materializations/view.sql
2018-02-08 10:01:57,050: Parsing materializations/wrapper.sql
2018-02-08 10:01:57,058: Parsing schema_tests/accepted_values.sql
2018-02-08 10:01:57,065: Parsing schema_tests/not_null.sql
2018-02-08 10:01:57,070: Parsing schema_tests/relationships.sql
2018-02-08 10:01:57,075: Parsing schema_tests/unique.sql
2018-02-08 10:01:57,180: Parsing model.seo_audit.accounts_proc
2018-02-08 10:01:57,185: Parsing model.seo_audit.all_dates
2018-02-08 10:01:57,187: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:01:57,190: Acquiring new bigquery connection "master".
2018-02-08 10:01:57,190: Opening a new connection (0 currently allocated)
2018-02-08 10:01:57,197: Parsing model.seo_audit.agg_all
2018-02-08 10:01:57,202: Parsing model.seo_audit.agg_indicative
2018-02-08 10:01:57,207: Parsing model.seo_audit.agg_stats
2018-02-08 10:01:57,216: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:01:57,221: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:01:57,223: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:01:57,226: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:01:57,228: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:01:57,230: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:01:57,231: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:01:57,234: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:01:57,237: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:01:57,245: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:01:57,248: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:01:57,250: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:01:57,252: Parsing model.seo_audit.ga_proc
2018-02-08 10:01:57,255: Parsing model.seo_audit.ga_stats
2018-02-08 10:01:57,257: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:01:57,259: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:01:57,264: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:01:57,267: Parsing model.seo_audit.moz_proc
2018-02-08 10:01:57,270: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:01:57,275: Parsing model.seo_audit.search_console_history
2018-02-08 10:01:57,276: Parsing model.seo_audit.search_console_proc
2018-02-08 10:01:57,279: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:01:57,282: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:01:57,284: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:01:57,286: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:01:57,289: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:01:57,292: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:01:57,294: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:01:57,296: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:01:57,298: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:01:57,318: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:01:57,332: 
2018-02-08 10:01:58,508: 10:01:58 | Concurrency: 4 threads (target='dev')
2018-02-08 10:01:58,508: 10:01:58 | 
2018-02-08 10:01:58,721: 10:01:58 | 1 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:01:58,722: Compiling model.seo_audit.all_dates
2018-02-08 10:01:58,721: 10:01:58 | 2 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:01:58,721: 10:01:58 | 3 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:01:58,726: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:01:58,726: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:01:58,726: Compiling model.seo_audit.accounts_proc
2018-02-08 10:01:58,731: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:01:58,737: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:01:58,738: Acquiring new bigquery connection "all_dates".
2018-02-08 10:01:58,738: Opening a new connection (1 currently allocated)
2018-02-08 10:01:58,740: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:01:58,743: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:01:58,793: Opening a new connection (2 currently allocated)
2018-02-08 10:01:58,799: Opening a new connection (3 currently allocated)
2018-02-08 10:01:59,384: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:01:59,394: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:01:59,397: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:01:59,579: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059379e8>]}
2018-02-08 10:01:59,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942c88>]}
2018-02-08 10:01:59,627: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937e10>]}
2018-02-08 10:01:59,792: 10:01:59 | 1 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.86s]
2018-02-08 10:01:59,997: 10:01:59 | 2 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.90s]
2018-02-08 10:02:00,346: 10:02:00 | 3 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.90s]
2018-02-08 10:02:00,347: 10:02:00 | 4 of 36 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 10:02:00,348: 10:02:00 | 5 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:02:00,348: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:02:00,348: 10:02:00 | 6 of 36 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:02:00,349: Compiling model.seo_audit.moz_proc
2018-02-08 10:02:00,348: 10:02:00 | 7 of 36 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 10:02:00,361: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:02:00,361: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:02:00,372: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:02:00,372: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:02:00,382: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:02:00,391: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:02:00,392: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:02:00,393: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:02:00,394: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:02:00,394: Re-using an available connection from the pool.
2018-02-08 10:02:00,394: Re-using an available connection from the pool.
2018-02-08 10:02:00,395: Re-using an available connection from the pool.
2018-02-08 10:02:00,403: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:02:00,405: Opening a new connection (4 currently allocated)
2018-02-08 10:02:00,617: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:02:00,648: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:02:00,670: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:02:00,883: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:02:00,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059493c8>]}
2018-02-08 10:02:00,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937cc0>]}
2018-02-08 10:02:00,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059157b8>]}
2018-02-08 10:02:01,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937550>]}
2018-02-08 10:02:01,220: 10:02:01 | 5 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.57s]
2018-02-08 10:02:01,222: 10:02:01 | 8 of 36 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 10:02:01,225: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:02:01,239: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:02:01,242: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:02:01,242: Re-using an available connection from the pool.
2018-02-08 10:02:01,438: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:02:01,606: 10:02:01 | 6 of 36 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.57s]
2018-02-08 10:02:01,607: 10:02:01 | 9 of 36 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:02:01,608: Compiling model.seo_audit.ga_proc
2018-02-08 10:02:01,622: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:02:01,627: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:02:01,627: Re-using an available connection from the pool.
2018-02-08 10:02:01,743: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10597f908>]}
2018-02-08 10:02:01,898: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:02:01,909: 10:02:01 | 4 of 36 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.59s]
2018-02-08 10:02:01,910: 10:02:01 | 10 of 36 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 10:02:01,910: Compiling model.seo_audit.search_console_proc
2018-02-08 10:02:01,917: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:02:01,923: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:02:01,923: Re-using an available connection from the pool.
2018-02-08 10:02:02,119: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:02:02,140: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059497f0>]}
2018-02-08 10:02:02,174: 10:02:02 | 7 of 36 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.81s]
2018-02-08 10:02:02,175: 10:02:02 | 11 of 36 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 10:02:02,175: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:02:02,183: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:02:02,187: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:02:02,188: Re-using an available connection from the pool.
2018-02-08 10:02:02,404: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:02:02,421: 10:02:02 | 8 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.52s]
2018-02-08 10:02:02,422: 10:02:02 | 12 of 36 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 10:02:02,422: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:02:02,430: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:02:02,434: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:02:02,434: Re-using an available connection from the pool.
2018-02-08 10:02:02,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058550b8>]}
2018-02-08 10:02:02,608: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:02:02,639: 10:02:02 | 9 of 36 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.53s]
2018-02-08 10:02:02,640: 10:02:02 | 13 of 36 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 10:02:02,640: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:02:02,650: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:02:02,652: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:02:02,653: Re-using an available connection from the pool.
2018-02-08 10:02:02,856: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:02:02,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830ac8>]}
2018-02-08 10:02:02,945: 10:02:02 | 10 of 36 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.56s]
2018-02-08 10:02:03,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059497f0>]}
2018-02-08 10:02:03,202: 10:02:03 | 11 of 36 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.76s]
2018-02-08 10:02:03,601: 10:02:03 | 13 of 36 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.48s]
2018-02-08 10:02:04,468: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10589c8d0>]}
2018-02-08 10:02:04,675: 10:02:04 | 12 of 36 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 2.05s]
2018-02-08 10:02:04,676: 10:02:04 | 14 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:02:04,676: Compiling model.seo_audit.search_console_history
2018-02-08 10:02:04,690: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:02:04,683: 10:02:04 | 15 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:02:04,690: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:02:04,683: 10:02:04 | 16 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:02:04,704: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:02:04,702: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:02:04,720: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:02:04,720: Re-using an available connection from the pool.
2018-02-08 10:02:04,704: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:02:04,728: Re-using an available connection from the pool.
2018-02-08 10:02:04,683: 10:02:04 | 17 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:02:04,733: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:02:04,719: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:02:04,749: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:02:04,752: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:02:04,753: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:02:04,753: Re-using an available connection from the pool.
2018-02-08 10:02:04,753: Re-using an available connection from the pool.
2018-02-08 10:02:04,952: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:02:04,954: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:02:04,978: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:02:05,002: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:02:05,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942ef0>]}
2018-02-08 10:02:05,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942f98>]}
2018-02-08 10:02:05,338: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10588edd8>]}
2018-02-08 10:02:05,403: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10589cf98>]}
2018-02-08 10:02:05,527: 10:02:05 | 17 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.56s]
2018-02-08 10:02:05,529: 10:02:05 | 18 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:02:05,531: Compiling model.seo_audit.ga_stats
2018-02-08 10:02:05,537: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:02:05,539: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:02:05,539: Re-using an available connection from the pool.
2018-02-08 10:02:05,741: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:02:05,787: 10:02:05 | 15 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.60s]
2018-02-08 10:02:06,052: 10:02:06 | 16 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.63s]
2018-02-08 10:02:06,133: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10597f160>]}
2018-02-08 10:02:06,324: 10:02:06 | 14 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.73s]
2018-02-08 10:02:06,722: 10:02:06 | 18 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.60s]
2018-02-08 10:02:06,722: 10:02:06 | 19 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:02:06,723: 10:02:06 | 20 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:02:06,723: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:02:06,723: 10:02:06 | 21 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:02:06,723: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:02:06,729: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:02:06,729: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:02:06,734: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:02:06,741: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:02:06,742: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:02:06,742: Re-using an available connection from the pool.
2018-02-08 10:02:06,745: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:02:06,746: Re-using an available connection from the pool.
2018-02-08 10:02:06,747: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:02:06,748: Re-using an available connection from the pool.
2018-02-08 10:02:06,940: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:02:06,945: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:02:06,951: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:02:07,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10589ab70>]}
2018-02-08 10:02:07,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942ef0>]}
2018-02-08 10:02:07,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937ba8>]}
2018-02-08 10:02:07,652: 10:02:07 | 19 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.62s]
2018-02-08 10:02:08,006: 10:02:08 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.62s]
2018-02-08 10:02:08,292: 10:02:08 | 21 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.61s]
2018-02-08 10:02:08,294: 10:02:08 | 22 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:02:08,295: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:02:08,294: 10:02:08 | 23 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:02:08,304: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:02:08,294: 10:02:08 | 24 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:02:08,305: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:02:08,295: 10:02:08 | 25 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:02:08,305: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:02:08,311: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:02:08,312: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:02:08,312: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:02:08,318: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:02:08,318: Re-using an available connection from the pool.
2018-02-08 10:02:08,325: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:02:08,338: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:02:08,346: Re-using an available connection from the pool.
2018-02-08 10:02:08,348: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:02:08,352: Re-using an available connection from the pool.
2018-02-08 10:02:08,351: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:02:08,368: Re-using an available connection from the pool.
2018-02-08 10:02:08,566: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:02:08,570: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:02:08,577: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:02:08,582: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:02:08,977: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830ac8>]}
2018-02-08 10:02:08,978: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105921898>]}
2018-02-08 10:02:08,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942c50>]}
2018-02-08 10:02:09,205: 10:02:09 | 22 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.68s]
2018-02-08 10:02:09,498: 10:02:09 | 25 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.67s]
2018-02-08 10:02:09,615: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059157b8>]}
2018-02-08 10:02:09,796: 10:02:09 | 23 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.69s]
2018-02-08 10:02:10,081: 10:02:10 | 24 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 1.31s]
2018-02-08 10:02:10,082: 10:02:10 | 26 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:02:10,083: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:02:10,082: 10:02:10 | 27 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:02:10,090: Compiling model.seo_audit.agg_indicative
2018-02-08 10:02:10,098: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:02:10,083: 10:02:10 | 28 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:02:10,100: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:02:10,083: 10:02:10 | 29 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:02:10,101: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:02:10,101: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:02:10,102: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:02:10,107: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:02:10,113: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:02:10,115: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:02:10,115: Re-using an available connection from the pool.
2018-02-08 10:02:10,117: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:02:10,121: Re-using an available connection from the pool.
2018-02-08 10:02:10,120: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:02:10,124: Re-using an available connection from the pool.
2018-02-08 10:02:10,132: Re-using an available connection from the pool.
2018-02-08 10:02:10,316: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:02:10,348: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:02:10,357: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:02:10,369: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:02:10,836: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830f98>]}
2018-02-08 10:02:10,839: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937c88>]}
2018-02-08 10:02:10,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937908>]}
2018-02-08 10:02:10,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105937898>]}
2018-02-08 10:02:11,216: 10:02:11 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.75s]
2018-02-08 10:02:11,217: 10:02:11 | 30 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:02:11,218: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:02:11,226: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:02:11,227: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:02:11,228: Re-using an available connection from the pool.
2018-02-08 10:02:11,453: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:02:11,551: 10:02:11 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.74s]
2018-02-08 10:02:11,552: 10:02:11 | 31 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:02:11,552: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:02:11,565: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:02:11,568: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:02:11,568: Re-using an available connection from the pool.
2018-02-08 10:02:11,760: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:02:11,863: 10:02:11 | 29 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.75s]
2018-02-08 10:02:11,865: 10:02:11 | 32 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:02:11,867: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:02:11,872: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:02:11,874: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:02:11,874: Re-using an available connection from the pool.
2018-02-08 10:02:11,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830f98>]}
2018-02-08 10:02:12,101: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:02:12,178: 10:02:12 | 27 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.75s]
2018-02-08 10:02:12,234: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105942048>]}
2018-02-08 10:02:12,407: 10:02:12 | 30 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.66s]
2018-02-08 10:02:12,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105959cc0>]}
2018-02-08 10:02:12,614: 10:02:12 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.68s]
2018-02-08 10:02:12,912: 10:02:12 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.60s]
2018-02-08 10:02:12,913: 10:02:12 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:02:12,914: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:02:12,928: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:02:12,929: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:02:12,929: Re-using an available connection from the pool.
2018-02-08 10:02:13,135: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as 'reclass_query_string',
case when ( a.filename = c.filename ) then null else 1 end as 'reclass_filename', 
case when ( a.first_path = c.first_path ) then null else 1 end as 'reclass_first_path',
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:02:13,346: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as 'reclass_query_string',
case when ( a.filename = c.filename ) then null else 1 end as 'reclass_filename', 
case when ( a.first_path = c.first_path ) then null else 1 end as 'reclass_first_path',
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:02:13,346: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Unexpected string literal 'reclass_query_string' at [19:71]
2018-02-08 10:02:13,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059420b8>]}
2018-02-08 10:02:13,642: 10:02:13 | 33 of 36 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.43s]
2018-02-08 10:02:13,643: 10:02:13 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:02:13,644: Compiling model.seo_audit.agg_stats
2018-02-08 10:02:13,655: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:02:13,656: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:02:13,656: Re-using an available connection from the pool.
2018-02-08 10:02:13,833: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:02:14,402: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10588ea90>]}
2018-02-08 10:02:14,733: 10:02:14 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.76s]
2018-02-08 10:02:14,733: 10:02:14 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:02:14,734: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:02:14,740: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:02:14,741: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:02:14,741: Re-using an available connection from the pool.
2018-02-08 10:02:14,931: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:02:15,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105959710>]}
2018-02-08 10:02:15,735: 10:02:15 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.71s]
2018-02-08 10:02:15,736: 10:02:15 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:02:15,736: Compiling model.seo_audit.agg_all
2018-02-08 10:02:15,743: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:02:15,744: Acquiring new bigquery connection "agg_all".
2018-02-08 10:02:15,744: Re-using an available connection from the pool.
2018-02-08 10:02:15,926: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:02:16,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '46ed94d4-075e-43c1-bc92-f283a787d4b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10588ea90>]}
2018-02-08 10:02:17,109: 10:02:17 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.08s]
2018-02-08 10:02:17,144: 10:02:17 | 
2018-02-08 10:02:17,145: 10:02:17 | Finished running 36 view models in 18.64s.
2018-02-08 10:02:17,145: Connection 'master' was left open.
2018-02-08 10:02:17,145: 
2018-02-08 10:02:17,145: Completed with 1 errors:
2018-02-08 10:02:17,146: 
2018-02-08 10:02:17,146: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 10:02:17,146:   Syntax error: Unexpected string literal 'reclass_query_string' at [19:71]
2018-02-08 10:02:17,147:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 10:02:17,147: 
Done. PASS=35 ERROR=1 SKIP=0 TOTAL=36
2018-02-08 10:02:17,147: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105830748>]}
2018-02-08 10:02:17,441: Flushing usage events
2018-02-08 10:04:49,014: Tracking: tracking
2018-02-08 10:04:49,017: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ee0710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ee0cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ee0048>]}
2018-02-08 10:04:49,736: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:04:49,763: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:04:49,770: Parsing core.sql
2018-02-08 10:04:49,801: Parsing adapters/bigquery.sql
2018-02-08 10:04:49,816: Parsing adapters/common.sql
2018-02-08 10:04:49,844: Parsing adapters/postgres.sql
2018-02-08 10:04:49,863: Parsing adapters/redshift.sql
2018-02-08 10:04:49,894: Parsing etc/get_custom_schema.sql
2018-02-08 10:04:49,904: Parsing materializations/archive.sql
2018-02-08 10:04:49,948: Parsing materializations/bigquery.sql
2018-02-08 10:04:49,970: Parsing materializations/helpers.sql
2018-02-08 10:04:49,997: Parsing materializations/incremental.sql
2018-02-08 10:04:50,047: Parsing materializations/table.sql
2018-02-08 10:04:50,088: Parsing materializations/view.sql
2018-02-08 10:04:50,115: Parsing materializations/wrapper.sql
2018-02-08 10:04:50,131: Parsing schema_tests/accepted_values.sql
2018-02-08 10:04:50,139: Parsing schema_tests/not_null.sql
2018-02-08 10:04:50,147: Parsing schema_tests/relationships.sql
2018-02-08 10:04:50,153: Parsing schema_tests/unique.sql
2018-02-08 10:04:50,225: Parsing model.seo_audit.accounts_proc
2018-02-08 10:04:50,229: Parsing model.seo_audit.all_dates
2018-02-08 10:04:50,232: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:04:50,237: Acquiring new bigquery connection "master".
2018-02-08 10:04:50,238: Opening a new connection (0 currently allocated)
2018-02-08 10:04:50,244: Parsing model.seo_audit.agg_all
2018-02-08 10:04:50,247: Parsing model.seo_audit.agg_indicative
2018-02-08 10:04:50,249: Parsing model.seo_audit.agg_stats
2018-02-08 10:04:50,256: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:04:50,261: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:04:50,265: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:04:50,269: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:04:50,273: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:04:50,277: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:04:50,280: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:04:50,283: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:04:50,286: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:04:50,293: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:04:50,300: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:04:50,303: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:04:50,308: Parsing model.seo_audit.ga_proc
2018-02-08 10:04:50,312: Parsing model.seo_audit.ga_stats
2018-02-08 10:04:50,314: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:04:50,316: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:04:50,319: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:04:50,322: Parsing model.seo_audit.moz_proc
2018-02-08 10:04:50,326: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:04:50,337: Parsing model.seo_audit.search_console_history
2018-02-08 10:04:50,340: Parsing model.seo_audit.search_console_proc
2018-02-08 10:04:50,345: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:04:50,351: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:04:50,353: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:04:50,356: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:04:50,361: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:04:50,366: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:04:50,369: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:04:50,371: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:04:50,376: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:04:50,395: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:04:50,429: 
2018-02-08 10:04:51,503: 10:04:51 | Concurrency: 4 threads (target='dev')
2018-02-08 10:04:51,503: 10:04:51 | 
2018-02-08 10:04:51,772: 10:04:51 | 1 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:04:51,772: 10:04:51 | 2 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:04:51,773: Compiling model.seo_audit.all_dates
2018-02-08 10:04:51,773: 10:04:51 | 3 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:04:51,773: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:04:51,777: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:04:51,777: Compiling model.seo_audit.accounts_proc
2018-02-08 10:04:51,781: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:04:51,787: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:04:51,788: Acquiring new bigquery connection "all_dates".
2018-02-08 10:04:51,788: Opening a new connection (1 currently allocated)
2018-02-08 10:04:51,790: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:04:51,791: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:04:51,846: Opening a new connection (2 currently allocated)
2018-02-08 10:04:51,918: Opening a new connection (3 currently allocated)
2018-02-08 10:04:52,459: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:04:52,460: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:04:52,486: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:04:52,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080027b8>]}
2018-02-08 10:04:52,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10808dc88>]}
2018-02-08 10:04:52,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080c5438>]}
2018-02-08 10:04:52,944: 10:04:52 | 1 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.87s]
2018-02-08 10:04:53,194: 10:04:53 | 3 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.90s]
2018-02-08 10:04:53,495: 10:04:53 | 2 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.94s]
2018-02-08 10:04:53,496: 10:04:53 | 4 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:04:53,497: Compiling model.seo_audit.moz_proc
2018-02-08 10:04:53,511: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:04:53,505: 10:04:53 | 5 of 36 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 10:04:53,512: 10:04:53 | 6 of 36 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 10:04:53,513: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:04:53,513: 10:04:53 | 7 of 36 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:04:53,527: Compiling model.seo_audit.search_console_proc
2018-02-08 10:04:53,528: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:04:53,549: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:04:53,549: Re-using an available connection from the pool.
2018-02-08 10:04:53,544: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:04:53,514: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:04:53,562: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:04:53,547: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:04:53,578: Re-using an available connection from the pool.
2018-02-08 10:04:53,579: Re-using an available connection from the pool.
2018-02-08 10:04:53,611: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:04:53,612: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:04:53,613: Opening a new connection (4 currently allocated)
2018-02-08 10:04:53,866: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:04:53,877: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:04:53,977: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:04:54,164: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108002748>]}
2018-02-08 10:04:54,221: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:04:54,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080d6320>]}
2018-02-08 10:04:54,379: 10:04:54 | 4 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.67s]
2018-02-08 10:04:54,379: 10:04:54 | 8 of 36 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 10:04:54,381: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:04:54,387: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:04:54,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:04:54,395: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:04:54,395: Re-using an available connection from the pool.
2018-02-08 10:04:54,512: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10808deb8>]}
2018-02-08 10:04:54,602: 10:04:54 | 7 of 36 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.75s]
2018-02-08 10:04:54,603: 10:04:54 | 9 of 36 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 10:04:54,603: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:04:54,609: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:04:54,612: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:04:54,618: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:04:54,618: Re-using an available connection from the pool.
2018-02-08 10:04:54,856: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:04:54,924: 10:04:54 | 5 of 36 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.88s]
2018-02-08 10:04:54,925: 10:04:54 | 10 of 36 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 10:04:54,926: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:04:54,937: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:04:54,938: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108002748>]}
2018-02-08 10:04:54,941: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:04:54,941: Re-using an available connection from the pool.
2018-02-08 10:04:55,131: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:04:55,159: 10:04:55 | 6 of 36 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 1.00s]
2018-02-08 10:04:55,160: 10:04:55 | 11 of 36 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 10:04:55,160: Compiling model.seo_audit.ga_proc
2018-02-08 10:04:55,166: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:04:55,169: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:04:55,169: Re-using an available connection from the pool.
2018-02-08 10:04:55,175: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc6b00>]}
2018-02-08 10:04:55,364: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:04:55,370: 10:04:55 | 8 of 36 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.56s]
2018-02-08 10:04:55,370: 10:04:55 | 12 of 36 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:04:55,371: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:04:55,376: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:04:55,378: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:04:55,379: Re-using an available connection from the pool.
2018-02-08 10:04:55,408: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:04:55,599: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:04:55,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107faee80>]}
2018-02-08 10:04:55,688: 10:04:55 | 9 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.57s]
2018-02-08 10:04:55,689: 10:04:55 | 13 of 36 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 10:04:55,690: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:04:55,699: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:04:55,700: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:04:55,701: Re-using an available connection from the pool.
2018-02-08 10:04:55,887: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10808d2e8>]}
2018-02-08 10:04:55,918: 10:04:55 | 10 of 36 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.48s]
2018-02-08 10:04:55,935: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:04:56,206: 10:04:56 | 11 of 36 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.51s]
2018-02-08 10:04:56,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc6b00>]}
2018-02-08 10:04:56,421: 10:04:56 | 12 of 36 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.52s]
2018-02-08 10:04:56,629: 10:04:56 | 13 of 36 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.52s]
2018-02-08 10:04:56,630: 10:04:56 | 14 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:04:56,631: Compiling model.seo_audit.search_console_history
2018-02-08 10:04:56,630: 10:04:56 | 15 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:04:56,641: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:04:56,630: 10:04:56 | 16 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:04:56,641: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:04:56,631: 10:04:56 | 17 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:04:56,642: Compiling model.seo_audit.ga_stats
2018-02-08 10:04:56,650: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:04:56,650: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:04:56,651: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:04:56,687: Re-using an available connection from the pool.
2018-02-08 10:04:56,661: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:04:56,695: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:04:56,695: Re-using an available connection from the pool.
2018-02-08 10:04:56,686: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:04:56,680: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:04:56,711: Re-using an available connection from the pool.
2018-02-08 10:04:56,701: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:04:56,716: Re-using an available connection from the pool.
2018-02-08 10:04:56,911: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:04:56,916: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:04:56,935: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:04:56,997: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:04:57,221: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108002f98>]}
2018-02-08 10:04:57,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080c5eb8>]}
2018-02-08 10:04:57,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fc61d0>]}
2018-02-08 10:04:57,279: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108095eb8>]}
2018-02-08 10:04:57,538: 10:04:57 | 16 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.58s]
2018-02-08 10:04:57,540: 10:04:57 | 18 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:04:57,540: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:04:57,547: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:04:57,549: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:04:57,549: Re-using an available connection from the pool.
2018-02-08 10:04:57,770: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:04:57,870: 10:04:57 | 15 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.60s]
2018-02-08 10:04:58,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108002f98>]}
2018-02-08 10:04:58,188: 10:04:58 | 14 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.62s]
2018-02-08 10:04:58,512: 10:04:58 | 17 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.63s]
2018-02-08 10:04:58,844: 10:04:58 | 18 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.51s]
2018-02-08 10:04:58,845: 10:04:58 | 19 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:04:58,846: 10:04:58 | 20 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:04:58,846: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:04:58,846: 10:04:58 | 21 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:04:58,846: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:04:58,853: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:04:58,857: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:04:58,869: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:04:58,873: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:04:58,874: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:04:58,874: Re-using an available connection from the pool.
2018-02-08 10:04:58,875: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:04:58,877: Re-using an available connection from the pool.
2018-02-08 10:04:58,877: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:04:58,880: Re-using an available connection from the pool.
2018-02-08 10:04:59,062: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:04:59,080: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:04:59,104: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:04:59,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108018780>]}
2018-02-08 10:04:59,381: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108095cc0>]}
2018-02-08 10:04:59,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:04:59,667: 10:04:59 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.50s]
2018-02-08 10:04:59,958: 10:04:59 | 21 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.53s]
2018-02-08 10:05:00,204: 10:05:00 | 19 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.63s]
2018-02-08 10:05:00,205: 10:05:00 | 22 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:05:00,206: 10:05:00 | 23 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:05:00,206: 10:05:00 | 24 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:05:00,206: 10:05:00 | 25 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:05:00,207: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:05:00,207: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:05:00,207: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:05:00,207: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:05:00,221: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:05:00,226: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:05:00,226: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:05:00,231: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:05:00,233: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:05:00,233: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:05:00,234: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:05:00,234: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:05:00,234: Re-using an available connection from the pool.
2018-02-08 10:05:00,235: Re-using an available connection from the pool.
2018-02-08 10:05:00,235: Re-using an available connection from the pool.
2018-02-08 10:05:00,237: Re-using an available connection from the pool.
2018-02-08 10:05:00,411: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:05:00,438: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:05:00,449: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:05:00,454: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:05:00,807: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108002f98>]}
2018-02-08 10:05:00,818: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fe4eb8>]}
2018-02-08 10:05:00,820: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104add0b8>]}
2018-02-08 10:05:00,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080cd8d0>]}
2018-02-08 10:05:01,148: 10:05:01 | 22 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.60s]
2018-02-08 10:05:01,363: 10:05:01 | 23 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.61s]
2018-02-08 10:05:01,670: 10:05:01 | 25 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.61s]
2018-02-08 10:05:01,881: 10:05:01 | 24 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.62s]
2018-02-08 10:05:01,882: 10:05:01 | 26 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:05:01,883: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:05:01,892: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:05:01,882: 10:05:01 | 27 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:05:01,882: 10:05:01 | 28 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:05:01,893: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:05:01,893: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:05:01,882: 10:05:01 | 29 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:05:01,898: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:05:01,902: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:05:01,903: Compiling model.seo_audit.agg_indicative
2018-02-08 10:05:01,903: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:05:01,912: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:05:01,913: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:05:01,915: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:05:01,915: Re-using an available connection from the pool.
2018-02-08 10:05:01,917: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:05:01,921: Re-using an available connection from the pool.
2018-02-08 10:05:01,925: Re-using an available connection from the pool.
2018-02-08 10:05:01,930: Re-using an available connection from the pool.
2018-02-08 10:05:02,128: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:05:02,141: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:05:02,144: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:05:02,187: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:05:02,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080cd588>]}
2018-02-08 10:05:02,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080cdb70>]}
2018-02-08 10:05:02,577: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:05:02,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104add9b0>]}
2018-02-08 10:05:02,736: 10:05:02 | 29 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.62s]
2018-02-08 10:05:02,736: 10:05:02 | 30 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:05:02,738: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:05:02,749: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:05:02,753: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:05:02,753: Re-using an available connection from the pool.
2018-02-08 10:05:03,002: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:05:03,011: 10:05:03 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.68s]
2018-02-08 10:05:03,012: 10:05:03 | 31 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:05:03,014: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:05:03,022: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:05:03,024: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:05:03,024: Re-using an available connection from the pool.
2018-02-08 10:05:03,212: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:05:03,303: 10:05:03 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.69s]
2018-02-08 10:05:03,304: 10:05:03 | 32 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:05:03,305: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:05:03,311: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:05:03,314: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:05:03,315: Re-using an available connection from the pool.
2018-02-08 10:05:03,543: 10:05:03 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.72s]
2018-02-08 10:05:03,551: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:05:03,620: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108018860>]}
2018-02-08 10:05:03,692: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080cdb70>]}
2018-02-08 10:05:03,834: 10:05:03 | 30 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.88s]
2018-02-08 10:05:03,953: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:05:04,173: 10:05:04 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.68s]
2018-02-08 10:05:04,397: 10:05:04 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.65s]
2018-02-08 10:05:04,398: 10:05:04 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:05:04,399: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:05:04,409: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:05:04,410: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:05:04,410: Re-using an available connection from the pool.
2018-02-08 10:05:04,500: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as reclass_query_string,
case when ( a.filename = c.filename ) then null else 1 end as reclass_filename, 
case when ( a.first_path = c.first_path ) then null else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:05:04,930: Bad request while running:
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as reclass_query_string,
case when ( a.filename = c.filename ) then null else 1 end as reclass_filename, 
case when ( a.first_path = c.first_path ) then null else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:05:04,930: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Name first_path not found inside c at [21:30]
2018-02-08 10:05:04,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080eda58>]}
2018-02-08 10:05:05,238: 10:05:05 | 33 of 36 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.53s]
2018-02-08 10:05:05,238: 10:05:05 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:05:05,239: Compiling model.seo_audit.agg_stats
2018-02-08 10:05:05,249: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:05:05,250: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:05:05,250: Re-using an available connection from the pool.
2018-02-08 10:05:05,455: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:05:06,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:05:06,337: 10:05:06 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.81s]
2018-02-08 10:05:06,338: 10:05:06 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:05:06,338: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:05:06,347: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:05:06,349: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:05:06,349: Re-using an available connection from the pool.
2018-02-08 10:05:06,558: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:05:07,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080cd8d0>]}
2018-02-08 10:05:07,441: 10:05:07 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.80s]
2018-02-08 10:05:07,441: 10:05:07 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:05:07,442: Compiling model.seo_audit.agg_all
2018-02-08 10:05:07,452: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:05:07,454: Acquiring new bigquery connection "agg_all".
2018-02-08 10:05:07,454: Re-using an available connection from the pool.
2018-02-08 10:05:07,665: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:05:08,487: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '18264649-21a8-4571-bf4b-2aa300de15c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080bdb38>]}
2018-02-08 10:05:08,702: 10:05:08 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.04s]
2018-02-08 10:05:08,754: 10:05:08 | 
2018-02-08 10:05:08,754: 10:05:08 | Finished running 36 view models in 17.26s.
2018-02-08 10:05:08,754: Connection 'master' was left open.
2018-02-08 10:05:08,754: 
2018-02-08 10:05:08,754: Completed with 1 errors:
2018-02-08 10:05:08,755: 
2018-02-08 10:05:08,755: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 10:05:08,755:   Name first_path not found inside c at [21:30]
2018-02-08 10:05:08,755:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 10:05:08,755: 
Done. PASS=35 ERROR=1 SKIP=0 TOTAL=36
2018-02-08 10:05:08,755: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fe4278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107faef60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fae4e0>]}
2018-02-08 10:05:09,054: Flushing usage events
2018-02-08 10:08:12,224: Tracking: tracking
2018-02-08 10:08:12,227: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d2a710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d2acf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d2a048>]}
2018-02-08 10:08:13,071: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:08:13,099: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:08:13,106: Parsing core.sql
2018-02-08 10:08:13,137: Parsing adapters/bigquery.sql
2018-02-08 10:08:13,144: Parsing adapters/common.sql
2018-02-08 10:08:13,164: Parsing adapters/postgres.sql
2018-02-08 10:08:13,172: Parsing adapters/redshift.sql
2018-02-08 10:08:13,207: Parsing etc/get_custom_schema.sql
2018-02-08 10:08:13,217: Parsing materializations/archive.sql
2018-02-08 10:08:13,261: Parsing materializations/bigquery.sql
2018-02-08 10:08:13,277: Parsing materializations/helpers.sql
2018-02-08 10:08:13,308: Parsing materializations/incremental.sql
2018-02-08 10:08:13,343: Parsing materializations/table.sql
2018-02-08 10:08:13,369: Parsing materializations/view.sql
2018-02-08 10:08:13,392: Parsing materializations/wrapper.sql
2018-02-08 10:08:13,398: Parsing schema_tests/accepted_values.sql
2018-02-08 10:08:13,403: Parsing schema_tests/not_null.sql
2018-02-08 10:08:13,408: Parsing schema_tests/relationships.sql
2018-02-08 10:08:13,425: Parsing schema_tests/unique.sql
2018-02-08 10:08:13,514: Parsing model.seo_audit.accounts_proc
2018-02-08 10:08:13,519: Parsing model.seo_audit.all_dates
2018-02-08 10:08:13,521: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:08:13,525: Acquiring new bigquery connection "master".
2018-02-08 10:08:13,525: Opening a new connection (0 currently allocated)
2018-02-08 10:08:13,532: Parsing model.seo_audit.agg_all
2018-02-08 10:08:13,537: Parsing model.seo_audit.agg_indicative
2018-02-08 10:08:13,541: Parsing model.seo_audit.agg_stats
2018-02-08 10:08:13,547: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:08:13,549: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:08:13,552: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:08:13,555: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:08:13,557: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:08:13,559: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:08:13,560: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:08:13,563: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:08:13,567: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:08:13,574: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:08:13,576: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:08:13,578: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:08:13,580: Parsing model.seo_audit.ga_proc
2018-02-08 10:08:13,583: Parsing model.seo_audit.ga_stats
2018-02-08 10:08:13,585: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:08:13,586: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:08:13,589: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:08:13,592: Parsing model.seo_audit.moz_proc
2018-02-08 10:08:13,594: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:08:13,597: Parsing model.seo_audit.search_console_history
2018-02-08 10:08:13,599: Parsing model.seo_audit.search_console_proc
2018-02-08 10:08:13,602: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:08:13,605: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:08:13,606: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:08:13,609: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:08:13,612: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:08:13,615: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:08:13,618: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:08:13,620: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:08:13,622: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:08:13,637: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:08:13,646: 
2018-02-08 10:08:15,986: 10:08:15 | Concurrency: 4 threads (target='dev')
2018-02-08 10:08:15,986: 10:08:15 | 
2018-02-08 10:08:16,182: 10:08:16 | 1 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:08:16,182: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:08:16,187: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:08:16,182: 10:08:16 | 2 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:08:16,182: 10:08:16 | 3 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:08:16,188: Compiling model.seo_audit.accounts_proc
2018-02-08 10:08:16,188: Compiling model.seo_audit.all_dates
2018-02-08 10:08:16,193: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:08:16,197: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:08:16,198: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:08:16,198: Opening a new connection (1 currently allocated)
2018-02-08 10:08:16,201: Acquiring new bigquery connection "all_dates".
2018-02-08 10:08:16,255: Opening a new connection (2 currently allocated)
2018-02-08 10:08:16,259: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:08:16,308: Opening a new connection (3 currently allocated)
2018-02-08 10:08:16,732: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:08:16,750: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:08:16,763: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:08:16,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ed97f0>]}
2018-02-08 10:08:16,950: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f11080>]}
2018-02-08 10:08:16,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:17,185: 10:08:17 | 3 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.75s]
2018-02-08 10:08:17,395: 10:08:17 | 2 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.76s]
2018-02-08 10:08:17,713: 10:08:17 | 1 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.78s]
2018-02-08 10:08:17,714: 10:08:17 | 4 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:08:17,715: Compiling model.seo_audit.moz_proc
2018-02-08 10:08:17,714: 10:08:17 | 5 of 36 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:08:17,720: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:08:17,714: 10:08:17 | 6 of 36 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:08:17,730: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:08:17,732: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:08:17,733: Compiling model.seo_audit.ga_proc
2018-02-08 10:08:17,715: 10:08:17 | 7 of 36 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 10:08:17,739: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:08:17,739: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:08:17,740: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:08:17,748: Re-using an available connection from the pool.
2018-02-08 10:08:17,747: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:08:17,748: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:08:17,750: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:08:17,752: Re-using an available connection from the pool.
2018-02-08 10:08:17,754: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:08:17,757: Re-using an available connection from the pool.
2018-02-08 10:08:17,758: Opening a new connection (4 currently allocated)
2018-02-08 10:08:17,987: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:08:18,038: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:08:18,053: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:08:18,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d7f0>]}
2018-02-08 10:08:18,328: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:08:18,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f11e80>]}
2018-02-08 10:08:18,340: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ed97f0>]}
2018-02-08 10:08:18,550: 10:08:18 | 4 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.61s]
2018-02-08 10:08:18,552: 10:08:18 | 8 of 36 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:08:18,552: Compiling model.seo_audit.search_console_proc
2018-02-08 10:08:18,567: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:08:18,572: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:08:18,573: Re-using an available connection from the pool.
2018-02-08 10:08:18,612: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f349e8>]}
2018-02-08 10:08:19,724: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:08:19,725: 10:08:19 | 6 of 36 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.60s]
2018-02-08 10:08:19,729: 10:08:19 | 9 of 36 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:08:19,733: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:08:19,746: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:08:19,751: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:08:19,752: Re-using an available connection from the pool.
2018-02-08 10:08:19,960: 10:08:19 | 5 of 36 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.62s]
2018-02-08 10:08:19,965: 10:08:19 | 10 of 36 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:08:19,965: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:08:19,975: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:08:19,977: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:08:19,977: Re-using an available connection from the pool.
2018-02-08 10:08:19,993: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:08:20,117: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d7f0>]}
2018-02-08 10:08:20,154: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)] as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:08:20,197: 10:08:20 | 7 of 36 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.87s]
2018-02-08 10:08:20,198: 10:08:20 | 11 of 36 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 10:08:20,199: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:08:20,211: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:08:20,215: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:08:20,216: Re-using an available connection from the pool.
2018-02-08 10:08:20,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f11e80>]}
2018-02-08 10:08:20,410: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:08:20,470: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df99b0>]}
2018-02-08 10:08:20,519: 10:08:20 | 8 of 36 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 1.56s]
2018-02-08 10:08:20,520: 10:08:20 | 12 of 36 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:08:20,520: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:08:20,527: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:08:20,529: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:08:20,531: Re-using an available connection from the pool.
2018-02-08 10:08:20,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4ddd8>]}
2018-02-08 10:08:20,717: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:08:20,828: 10:08:20 | 9 of 36 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.51s]
2018-02-08 10:08:20,829: 10:08:20 | 13 of 36 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:08:20,829: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:08:20,840: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:08:20,844: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:08:20,844: Re-using an available connection from the pool.
2018-02-08 10:08:20,977: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d7f0>]}
2018-02-08 10:08:21,079: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:08:21,186: 10:08:21 | 10 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.50s]
2018-02-08 10:08:21,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f11e80>]}
2018-02-08 10:08:21,474: 10:08:21 | 11 of 36 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.51s]
2018-02-08 10:08:21,718: 10:08:21 | 12 of 36 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.46s]
2018-02-08 10:08:21,947: 10:08:21 | 13 of 36 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.53s]
2018-02-08 10:08:21,947: 10:08:21 | 14 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:08:21,948: 10:08:21 | 15 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:08:21,948: 10:08:21 | 16 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:08:21,948: 10:08:21 | 17 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:08:21,949: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:08:21,949: Compiling model.seo_audit.ga_stats
2018-02-08 10:08:21,949: Compiling model.seo_audit.search_console_history
2018-02-08 10:08:21,949: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:08:21,961: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:08:21,961: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:08:21,966: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:08:21,970: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:08:21,972: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:08:21,972: Re-using an available connection from the pool.
2018-02-08 10:08:21,973: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:08:21,974: Re-using an available connection from the pool.
2018-02-08 10:08:21,974: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:08:21,975: Re-using an available connection from the pool.
2018-02-08 10:08:21,975: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:08:21,976: Re-using an available connection from the pool.
2018-02-08 10:08:22,251: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:08:22,278: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:08:22,285: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:08:22,298: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:08:22,543: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ee92e8>]}
2018-02-08 10:08:22,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f11080>]}
2018-02-08 10:08:22,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e62d68>]}
2018-02-08 10:08:22,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:22,852: 10:08:22 | 17 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.59s]
2018-02-08 10:08:22,854: 10:08:22 | 18 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:08:22,856: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:08:22,864: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:08:22,865: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:08:22,865: Re-using an available connection from the pool.
2018-02-08 10:08:23,044: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:08:23,072: 10:08:23 | 15 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.62s]
2018-02-08 10:08:23,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f08898>]}
2018-02-08 10:08:23,372: 10:08:23 | 16 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.63s]
2018-02-08 10:08:23,601: 10:08:23 | 14 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.66s]
2018-02-08 10:08:23,825: 10:08:23 | 18 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.50s]
2018-02-08 10:08:23,826: 10:08:23 | 19 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:08:23,826: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:08:23,826: 10:08:23 | 20 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:08:23,838: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:08:23,826: 10:08:23 | 21 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:08:23,838: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:08:23,839: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:08:23,850: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:08:23,865: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:08:23,866: Re-using an available connection from the pool.
2018-02-08 10:08:23,872: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:08:23,875: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:08:23,876: Re-using an available connection from the pool.
2018-02-08 10:08:23,879: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:08:23,879: Re-using an available connection from the pool.
2018-02-08 10:08:24,087: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:08:24,124: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:08:24,140: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:08:24,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef9860>]}
2018-02-08 10:08:24,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f20fd0>]}
2018-02-08 10:08:24,485: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:24,718: 10:08:24 | 21 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.56s]
2018-02-08 10:08:25,331: 10:08:25 | 19 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.65s]
2018-02-08 10:08:25,547: 10:08:25 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.65s]
2018-02-08 10:08:25,548: 10:08:25 | 22 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:08:25,549: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:08:25,557: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:08:25,549: 10:08:25 | 23 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:08:25,557: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:08:25,549: 10:08:25 | 24 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:08:25,563: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:08:25,562: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:08:25,571: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:08:25,549: 10:08:25 | 25 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:08:25,572: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:08:25,573: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:08:25,573: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:08:25,573: Re-using an available connection from the pool.
2018-02-08 10:08:25,589: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:08:25,596: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:08:25,600: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:08:25,600: Re-using an available connection from the pool.
2018-02-08 10:08:25,603: Re-using an available connection from the pool.
2018-02-08 10:08:25,606: Re-using an available connection from the pool.
2018-02-08 10:08:25,791: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:08:25,810: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:08:25,815: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:08:25,826: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:08:26,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ed9f60>]}
2018-02-08 10:08:26,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f08940>]}
2018-02-08 10:08:26,244: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f08780>]}
2018-02-08 10:08:26,297: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef99e8>]}
2018-02-08 10:08:26,560: 10:08:26 | 24 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.68s]
2018-02-08 10:08:26,895: 10:08:26 | 25 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.67s]
2018-02-08 10:08:27,192: 10:08:27 | 22 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.70s]
2018-02-08 10:08:27,475: 10:08:27 | 23 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.74s]
2018-02-08 10:08:27,476: 10:08:27 | 26 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:08:27,476: 10:08:27 | 27 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:08:27,477: 10:08:27 | 28 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:08:27,477: 10:08:27 | 29 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:08:27,477: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:08:27,477: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:08:27,478: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:08:27,478: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:08:27,488: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:08:27,489: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:08:27,494: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:08:27,498: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:08:27,502: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:08:27,502: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:08:27,503: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:08:27,504: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:08:27,504: Re-using an available connection from the pool.
2018-02-08 10:08:27,504: Re-using an available connection from the pool.
2018-02-08 10:08:27,505: Re-using an available connection from the pool.
2018-02-08 10:08:27,505: Re-using an available connection from the pool.
2018-02-08 10:08:27,729: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:08:27,747: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:08:27,749: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:08:27,799: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:08:28,494: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f08a90>]}
2018-02-08 10:08:28,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ee9048>]}
2018-02-08 10:08:28,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:28,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ee9908>]}
2018-02-08 10:08:28,722: 10:08:28 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 1.02s]
2018-02-08 10:08:28,723: 10:08:28 | 30 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:08:28,724: Compiling model.seo_audit.agg_indicative
2018-02-08 10:08:28,736: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:08:28,739: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:08:28,741: Re-using an available connection from the pool.
2018-02-08 10:08:28,944: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:08:28,955: 10:08:28 | 29 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 1.02s]
2018-02-08 10:08:28,957: 10:08:28 | 31 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:08:28,964: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:08:28,975: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:08:28,977: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:08:28,977: Re-using an available connection from the pool.
2018-02-08 10:08:29,150: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:08:29,199: 10:08:29 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 1.02s]
2018-02-08 10:08:29,201: 10:08:29 | 32 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:08:29,203: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:08:29,210: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:08:29,211: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:08:29,211: Re-using an available connection from the pool.
2018-02-08 10:08:29,410: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:08:29,420: 10:08:29 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 1.03s]
2018-02-08 10:08:29,694: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f0bb70>]}
2018-02-08 10:08:29,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f0bc88>]}
2018-02-08 10:08:29,906: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:29,985: 10:08:29 | 30 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.97s]
2018-02-08 10:08:30,195: 10:08:30 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.80s]
2018-02-08 10:08:30,494: 10:08:30 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.70s]
2018-02-08 10:08:30,495: 10:08:30 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:08:30,495: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:08:30,506: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:08:30,506: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:08:30,507: Re-using an available connection from the pool.
2018-02-08 10:08:30,588: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as reclass_query_string,
case when ( a.filename = c.filename ) then null else 1 end as reclass_filename, 
case when ( a.first_path = d.first_path ) then null else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:08:31,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e0fe80>]}
2018-02-08 10:08:31,997: 10:08:31 | 33 of 36 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.21s]
2018-02-08 10:08:31,997: 10:08:31 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:08:31,998: Compiling model.seo_audit.agg_stats
2018-02-08 10:08:32,008: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:08:32,009: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:08:32,009: Re-using an available connection from the pool.
2018-02-08 10:08:32,190: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:08:32,726: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:32,936: 10:08:32 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.73s]
2018-02-08 10:08:32,937: 10:08:32 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:08:32,937: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:08:32,946: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:08:32,948: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:08:32,948: Re-using an available connection from the pool.
2018-02-08 10:08:33,168: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:08:33,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e0fe80>]}
2018-02-08 10:08:34,032: 10:08:34 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.77s]
2018-02-08 10:08:34,032: 10:08:34 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:08:34,033: Compiling model.seo_audit.agg_all
2018-02-08 10:08:34,040: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:08:34,041: Acquiring new bigquery connection "agg_all".
2018-02-08 10:08:34,041: Re-using an available connection from the pool.
2018-02-08 10:08:34,256: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:08:35,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a73d170f-a760-4d51-bbb8-1c5ab3eb79f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4d518>]}
2018-02-08 10:08:35,474: 10:08:35 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.22s]
2018-02-08 10:08:35,548: 10:08:35 | 
2018-02-08 10:08:35,548: 10:08:35 | Finished running 36 view models in 19.56s.
2018-02-08 10:08:35,548: Connection 'master' was left open.
2018-02-08 10:08:35,549: 
2018-02-08 10:08:35,549: Completed successfully
2018-02-08 10:08:35,549: 
Done. PASS=36 ERROR=0 SKIP=0 TOTAL=36
2018-02-08 10:08:35,549: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e2f2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df9518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109df95f8>]}
2018-02-08 10:08:35,782: Flushing usage events
2018-02-08 10:13:56,308: Tracking: tracking
2018-02-08 10:13:56,311: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f836da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f836908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f836f60>]}
2018-02-08 10:13:57,063: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:13:57,082: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:13:57,089: Parsing core.sql
2018-02-08 10:13:57,113: Parsing adapters/bigquery.sql
2018-02-08 10:13:57,126: Parsing adapters/common.sql
2018-02-08 10:13:57,151: Parsing adapters/postgres.sql
2018-02-08 10:13:57,158: Parsing adapters/redshift.sql
2018-02-08 10:13:57,178: Parsing etc/get_custom_schema.sql
2018-02-08 10:13:57,189: Parsing materializations/archive.sql
2018-02-08 10:13:57,224: Parsing materializations/bigquery.sql
2018-02-08 10:13:57,244: Parsing materializations/helpers.sql
2018-02-08 10:13:57,263: Parsing materializations/incremental.sql
2018-02-08 10:13:57,300: Parsing materializations/table.sql
2018-02-08 10:13:57,327: Parsing materializations/view.sql
2018-02-08 10:13:57,352: Parsing materializations/wrapper.sql
2018-02-08 10:13:57,358: Parsing schema_tests/accepted_values.sql
2018-02-08 10:13:57,366: Parsing schema_tests/not_null.sql
2018-02-08 10:13:57,372: Parsing schema_tests/relationships.sql
2018-02-08 10:13:57,380: Parsing schema_tests/unique.sql
2018-02-08 10:13:57,509: Parsing model.seo_audit.accounts_proc
2018-02-08 10:13:57,515: Parsing model.seo_audit.all_dates
2018-02-08 10:13:57,517: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:13:57,522: Acquiring new bigquery connection "master".
2018-02-08 10:13:57,522: Opening a new connection (0 currently allocated)
2018-02-08 10:13:57,531: Parsing model.seo_audit.agg_all
2018-02-08 10:13:57,537: Parsing model.seo_audit.agg_indicative
2018-02-08 10:13:57,541: Parsing model.seo_audit.agg_stats
2018-02-08 10:13:57,546: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:13:57,550: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:13:57,553: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:13:57,556: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:13:57,557: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:13:57,560: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:13:57,563: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:13:57,565: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:13:57,567: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:13:57,572: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:13:57,574: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:13:57,576: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:13:57,578: Parsing model.seo_audit.ga_proc
2018-02-08 10:13:57,581: Parsing model.seo_audit.ga_stats
2018-02-08 10:13:57,583: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:13:57,585: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:13:57,588: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:13:57,590: Parsing model.seo_audit.moz_proc
2018-02-08 10:13:57,593: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:13:57,596: Parsing model.seo_audit.search_console_history
2018-02-08 10:13:57,598: Parsing model.seo_audit.search_console_proc
2018-02-08 10:13:57,601: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:13:57,604: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:13:57,606: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:13:57,608: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:13:57,611: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:13:57,615: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:13:57,617: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:13:57,619: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:13:57,621: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:13:57,635: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:13:57,646: 
2018-02-08 10:13:58,738: 10:13:58 | Concurrency: 4 threads (target='dev')
2018-02-08 10:13:58,738: 10:13:58 | 
2018-02-08 10:13:58,964: 10:13:58 | 1 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:13:58,964: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:13:58,971: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:13:58,964: 10:13:58 | 2 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:13:58,964: 10:13:58 | 3 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:13:58,971: Compiling model.seo_audit.accounts_proc
2018-02-08 10:13:58,972: Compiling model.seo_audit.all_dates
2018-02-08 10:13:58,977: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:13:58,983: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:13:58,984: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:13:58,984: Opening a new connection (1 currently allocated)
2018-02-08 10:13:58,985: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:13:58,986: Acquiring new bigquery connection "all_dates".
2018-02-08 10:13:58,989: Opening a new connection (2 currently allocated)
2018-02-08 10:13:59,160: Opening a new connection (3 currently allocated)
2018-02-08 10:13:59,637: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:13:59,639: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:13:59,697: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:13:59,874: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9ceb00>]}
2018-02-08 10:13:59,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa10198>]}
2018-02-08 10:13:59,887: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9ce940>]}
2018-02-08 10:14:00,094: 10:14:00 | 3 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.90s]
2018-02-08 10:14:00,319: 10:14:00 | 2 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.91s]
2018-02-08 10:14:00,616: 10:14:00 | 1 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.92s]
2018-02-08 10:14:00,617: 10:14:00 | 4 of 36 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 10:14:00,618: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:14:00,626: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:14:00,625: 10:14:00 | 5 of 36 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:14:00,626: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:14:00,625: 10:14:00 | 6 of 36 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:14:00,633: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:14:00,633: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:14:00,625: 10:14:00 | 7 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:14:00,635: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:14:00,643: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:14:00,643: Compiling model.seo_audit.moz_proc
2018-02-08 10:14:00,643: Re-using an available connection from the pool.
2018-02-08 10:14:00,657: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:14:00,659: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:14:00,659: Re-using an available connection from the pool.
2018-02-08 10:14:00,666: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:14:00,668: Re-using an available connection from the pool.
2018-02-08 10:14:00,670: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:14:00,670: Opening a new connection (4 currently allocated)
2018-02-08 10:14:00,933: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:14:01,005: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:14:01,024: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:14:01,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa03208>]}
2018-02-08 10:14:01,301: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3eef0>]}
2018-02-08 10:14:01,306: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:14:01,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f98ae10>]}
2018-02-08 10:14:01,549: 10:14:01 | 4 of 36 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.63s]
2018-02-08 10:14:01,550: 10:14:01 | 8 of 36 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 10:14:01,551: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:14:01,563: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:14:01,566: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:14:01,566: Re-using an available connection from the pool.
2018-02-08 10:14:01,592: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d60f0>]}
2018-02-08 10:14:01,764: 10:14:01 | 7 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.66s]
2018-02-08 10:14:01,767: 10:14:01 | 9 of 36 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:14:01,768: Compiling model.seo_audit.search_console_proc
2018-02-08 10:14:01,776: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:14:01,779: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:14:01,779: Re-using an available connection from the pool.
2018-02-08 10:14:01,783: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:14:01,967: 10:14:01 | 6 of 36 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.67s]
2018-02-08 10:14:01,968: 10:14:01 | 10 of 36 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 10:14:01,971: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:14:01,984: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:14:01,985: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:14:01,985: Re-using an available connection from the pool.
2018-02-08 10:14:02,008: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:14:02,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d6710>]}
2018-02-08 10:14:02,203: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:14:02,276: 10:14:02 | 5 of 36 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.97s]
2018-02-08 10:14:02,278: 10:14:02 | 11 of 36 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:14:02,279: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:14:02,292: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:14:02,296: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:14:02,296: Re-using an available connection from the pool.
2018-02-08 10:14:02,309: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3f5630>]}
2018-02-08 10:14:02,482: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f931c18>]}
2018-02-08 10:14:02,534: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:14:02,547: 10:14:02 | 8 of 36 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.51s]
2018-02-08 10:14:02,548: 10:14:02 | 12 of 36 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 10:14:02,550: Compiling model.seo_audit.ga_proc
2018-02-08 10:14:02,559: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:14:02,561: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:14:02,561: Re-using an available connection from the pool.
2018-02-08 10:14:02,752: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:14:02,780: 10:14:02 | 9 of 36 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.54s]
2018-02-08 10:14:02,781: 10:14:02 | 13 of 36 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:14:02,781: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:14:02,791: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:14:02,793: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:14:02,794: Re-using an available connection from the pool.
2018-02-08 10:14:02,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9dacc0>]}
2018-02-08 10:14:03,023: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:14:03,040: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa10a90>]}
2018-02-08 10:14:03,108: 10:14:03 | 10 of 36 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.51s]
2018-02-08 10:14:03,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3f5630>]}
2018-02-08 10:14:03,693: 10:14:03 | 11 of 36 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.58s]
2018-02-08 10:14:04,025: 10:14:04 | 12 of 36 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.49s]
2018-02-08 10:14:04,330: 10:14:04 | 13 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.58s]
2018-02-08 10:14:04,331: 10:14:04 | 14 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:14:04,332: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:14:04,331: 10:14:04 | 15 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:14:04,338: Compiling model.seo_audit.ga_stats
2018-02-08 10:14:04,343: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:14:04,331: 10:14:04 | 16 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:14:04,345: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:14:04,332: 10:14:04 | 17 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:14:04,345: Compiling model.seo_audit.search_console_history
2018-02-08 10:14:04,346: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:14:04,352: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:14:04,365: Re-using an available connection from the pool.
2018-02-08 10:14:04,362: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:14:04,372: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:14:04,372: Re-using an available connection from the pool.
2018-02-08 10:14:04,364: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:14:04,379: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:14:04,380: Re-using an available connection from the pool.
2018-02-08 10:14:04,362: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:14:04,391: Re-using an available connection from the pool.
2018-02-08 10:14:04,578: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:14:04,605: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:14:04,610: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:14:04,632: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:14:04,881: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa102b0>]}
2018-02-08 10:14:04,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f94d668>]}
2018-02-08 10:14:04,931: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa10a90>]}
2018-02-08 10:14:04,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f98a400>]}
2018-02-08 10:14:05,181: 10:14:05 | 16 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.54s]
2018-02-08 10:14:05,181: 10:14:05 | 18 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:14:05,182: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:14:05,188: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:14:05,191: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:14:05,191: Re-using an available connection from the pool.
2018-02-08 10:14:05,401: 10:14:05 | 14 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.58s]
2018-02-08 10:14:05,438: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:14:05,620: 10:14:05 | 17 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.58s]
2018-02-08 10:14:05,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa102b0>]}
2018-02-08 10:14:05,834: 10:14:05 | 15 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.64s]
2018-02-08 10:14:06,036: 10:14:06 | 18 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.58s]
2018-02-08 10:14:06,037: 10:14:06 | 19 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:14:06,037: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:14:06,037: 10:14:06 | 20 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:14:06,037: 10:14:06 | 21 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:14:06,043: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:14:06,043: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:14:06,043: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:14:06,049: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:14:06,056: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:14:06,057: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:14:06,057: Re-using an available connection from the pool.
2018-02-08 10:14:06,058: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:14:06,059: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:14:06,060: Re-using an available connection from the pool.
2018-02-08 10:14:06,062: Re-using an available connection from the pool.
2018-02-08 10:14:06,245: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:14:06,283: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:14:06,327: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:14:06,629: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3f5630>]}
2018-02-08 10:14:06,850: 10:14:06 | 19 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.59s]
2018-02-08 10:14:07,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3ec50>]}
2018-02-08 10:14:07,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa03c50>]}
2018-02-08 10:14:07,304: 10:14:07 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.99s]
2018-02-08 10:14:07,746: 10:14:07 | 21 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.99s]
2018-02-08 10:14:07,747: 10:14:07 | 22 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:14:07,747: 10:14:07 | 23 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:14:07,747: 10:14:07 | 24 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:14:07,748: 10:14:07 | 25 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:14:07,748: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:14:07,748: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:14:07,749: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:14:07,749: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:14:07,764: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:14:07,771: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:14:07,777: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:14:07,778: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:14:07,781: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:14:07,782: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:14:07,782: Re-using an available connection from the pool.
2018-02-08 10:14:07,783: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:14:07,783: Re-using an available connection from the pool.
2018-02-08 10:14:07,784: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:14:07,785: Re-using an available connection from the pool.
2018-02-08 10:14:07,795: Re-using an available connection from the pool.
2018-02-08 10:14:08,004: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:14:08,028: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:14:08,037: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:14:08,090: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:14:08,774: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f98a710>]}
2018-02-08 10:14:08,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f995be0>]}
2018-02-08 10:14:08,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9ce828>]}
2018-02-08 10:14:08,783: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9ce940>]}
2018-02-08 10:14:09,048: 10:14:09 | 25 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 1.02s]
2018-02-08 10:14:09,344: 10:14:09 | 22 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 1.03s]
2018-02-08 10:14:09,643: 10:14:09 | 23 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 1.03s]
2018-02-08 10:14:09,875: 10:14:09 | 24 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 1.03s]
2018-02-08 10:14:09,876: 10:14:09 | 26 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:14:09,877: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:14:09,877: 10:14:09 | 27 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:14:09,883: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:14:09,877: 10:14:09 | 28 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:14:09,889: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:14:09,890: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:14:09,877: 10:14:09 | 29 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:14:09,890: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:14:09,891: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:14:09,896: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:14:09,901: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:14:09,902: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:14:09,903: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:14:09,903: Re-using an available connection from the pool.
2018-02-08 10:14:09,904: Re-using an available connection from the pool.
2018-02-08 10:14:09,916: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:14:09,916: Re-using an available connection from the pool.
2018-02-08 10:14:09,930: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:14:09,932: Re-using an available connection from the pool.
2018-02-08 10:14:10,134: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:14:10,136: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:14:10,141: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:14:10,158: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:14:10,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f995be0>]}
2018-02-08 10:14:10,842: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa66048>]}
2018-02-08 10:14:10,842: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d6898>]}
2018-02-08 10:14:10,843: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d60b8>]}
2018-02-08 10:14:11,139: 10:14:11 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.96s]
2018-02-08 10:14:11,140: 10:14:11 | 30 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:14:11,140: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:14:11,150: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:14:11,151: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:14:11,153: Re-using an available connection from the pool.
2018-02-08 10:14:11,360: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:14:11,375: 10:14:11 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.96s]
2018-02-08 10:14:11,378: 10:14:11 | 31 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:14:11,380: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:14:11,392: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:14:11,394: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:14:11,394: Re-using an available connection from the pool.
2018-02-08 10:14:11,600: 10:14:11 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.95s]
2018-02-08 10:14:11,601: 10:14:11 | 32 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:14:11,601: Compiling model.seo_audit.agg_indicative
2018-02-08 10:14:11,611: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:14:11,616: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:14:11,616: Re-using an available connection from the pool.
2018-02-08 10:14:11,626: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:14:11,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f995be0>]}
2018-02-08 10:14:11,842: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:14:11,863: 10:14:11 | 29 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.95s]
2018-02-08 10:14:12,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f98a8d0>]}
2018-02-08 10:14:12,118: 10:14:12 | 30 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.69s]
2018-02-08 10:14:12,299: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d6a90>]}
2018-02-08 10:14:12,337: 10:14:12 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.66s]
2018-02-08 10:14:12,679: 10:14:12 | 32 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.70s]
2018-02-08 10:14:12,680: 10:14:12 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:14:12,680: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:14:12,691: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:14:12,694: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:14:12,694: Re-using an available connection from the pool.
2018-02-08 10:14:12,896: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( a.query_string = b.query_string ) then null else 1 end as reclass_query_string,
case when ( a.filename = c.filename ) then null else 1 end as reclass_filename, 
case when ( a.first_path = d.first_path ) then null else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	f.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:14:13,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f9d63c8>]}
2018-02-08 10:14:14,119: 10:14:14 | 33 of 36 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.20s]
2018-02-08 10:14:14,120: 10:14:14 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:14:14,120: Compiling model.seo_audit.agg_stats
2018-02-08 10:14:14,136: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:14:14,137: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:14:14,137: Re-using an available connection from the pool.
2018-02-08 10:14:14,347: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:14:14,921: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f94d668>]}
2018-02-08 10:14:15,131: 10:14:15 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-08 10:14:15,132: 10:14:15 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:14:15,133: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:14:15,143: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:14:15,145: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:14:15,145: Re-using an available connection from the pool.
2018-02-08 10:14:15,352: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:14:15,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa23cc0>]}
2018-02-08 10:14:16,155: 10:14:16 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.81s]
2018-02-08 10:14:16,156: 10:14:16 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:14:16,157: Compiling model.seo_audit.agg_all
2018-02-08 10:14:16,165: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:14:16,166: Acquiring new bigquery connection "agg_all".
2018-02-08 10:14:16,166: Re-using an available connection from the pool.
2018-02-08 10:14:16,380: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:14:17,688: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea255af6-8ac1-4b74-bc84-1f2060d43775', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f94d668>]}
2018-02-08 10:14:17,974: 10:14:17 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.53s]
2018-02-08 10:14:18,078: 10:14:18 | 
2018-02-08 10:14:18,078: 10:14:18 | Finished running 36 view models in 19.34s.
2018-02-08 10:14:18,078: Connection 'master' was left open.
2018-02-08 10:14:18,079: 
2018-02-08 10:14:18,079: Completed successfully
2018-02-08 10:14:18,079: 
Done. PASS=36 ERROR=0 SKIP=0 TOTAL=36
2018-02-08 10:14:18,080: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f91e898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f91e5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f91e6d8>]}
2018-02-08 10:14:18,299: Flushing usage events
2018-02-08 10:27:43,777: Tracking: tracking
2018-02-08 10:27:43,780: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a10710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a10cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a10048>]}
2018-02-08 10:27:44,637: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:27:44,655: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:27:44,662: Parsing core.sql
2018-02-08 10:27:44,688: Parsing adapters/bigquery.sql
2018-02-08 10:27:44,701: Parsing adapters/common.sql
2018-02-08 10:27:44,718: Parsing adapters/postgres.sql
2018-02-08 10:27:44,724: Parsing adapters/redshift.sql
2018-02-08 10:27:44,746: Parsing etc/get_custom_schema.sql
2018-02-08 10:27:44,754: Parsing materializations/archive.sql
2018-02-08 10:27:44,789: Parsing materializations/bigquery.sql
2018-02-08 10:27:44,808: Parsing materializations/helpers.sql
2018-02-08 10:27:44,836: Parsing materializations/incremental.sql
2018-02-08 10:27:44,867: Parsing materializations/table.sql
2018-02-08 10:27:44,896: Parsing materializations/view.sql
2018-02-08 10:27:44,913: Parsing materializations/wrapper.sql
2018-02-08 10:27:44,918: Parsing schema_tests/accepted_values.sql
2018-02-08 10:27:44,924: Parsing schema_tests/not_null.sql
2018-02-08 10:27:44,928: Parsing schema_tests/relationships.sql
2018-02-08 10:27:44,934: Parsing schema_tests/unique.sql
2018-02-08 10:27:45,064: Parsing model.seo_audit.accounts_proc
2018-02-08 10:27:45,069: Parsing model.seo_audit.all_dates
2018-02-08 10:27:45,071: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:27:45,075: Acquiring new bigquery connection "master".
2018-02-08 10:27:45,075: Opening a new connection (0 currently allocated)
2018-02-08 10:27:45,087: Parsing model.seo_audit.agg_all
2018-02-08 10:27:45,092: Parsing model.seo_audit.agg_indicative
2018-02-08 10:27:45,096: Parsing model.seo_audit.agg_stats
2018-02-08 10:27:45,106: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:27:45,112: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:27:45,116: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:27:45,119: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:27:45,120: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:27:45,122: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:27:45,124: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:27:45,128: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:27:45,132: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:27:45,138: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:27:45,140: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:27:45,142: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:27:45,144: Parsing model.seo_audit.ga_proc
2018-02-08 10:27:45,147: Parsing model.seo_audit.ga_stats
2018-02-08 10:27:45,148: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:27:45,150: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:27:45,153: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:27:45,155: Parsing model.seo_audit.moz_proc
2018-02-08 10:27:45,158: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:27:45,162: Parsing model.seo_audit.search_console_history
2018-02-08 10:27:45,163: Parsing model.seo_audit.search_console_proc
2018-02-08 10:27:45,166: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:27:45,169: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:27:45,171: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:27:45,173: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:27:45,177: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:27:45,180: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:27:45,182: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:27:45,184: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:27:45,186: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:27:45,200: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:27:45,209: 
2018-02-08 10:27:46,475: 10:27:46 | Concurrency: 4 threads (target='dev')
2018-02-08 10:27:46,476: 10:27:46 | 
2018-02-08 10:27:46,696: 10:27:46 | 1 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:27:46,697: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:27:46,696: 10:27:46 | 2 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:27:46,704: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:27:46,696: 10:27:46 | 3 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:27:46,704: Compiling model.seo_audit.all_dates
2018-02-08 10:27:46,704: Compiling model.seo_audit.accounts_proc
2018-02-08 10:27:46,709: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:27:46,715: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:27:46,716: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:27:46,716: Opening a new connection (1 currently allocated)
2018-02-08 10:27:46,719: Acquiring new bigquery connection "all_dates".
2018-02-08 10:27:46,720: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:27:46,774: Opening a new connection (2 currently allocated)
2018-02-08 10:27:46,783: Opening a new connection (3 currently allocated)
2018-02-08 10:27:47,301: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:27:47,309: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:27:47,327: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:27:47,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bc22b0>]}
2018-02-08 10:27:47,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bc2208>]}
2018-02-08 10:27:47,568: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b33b38>]}
2018-02-08 10:27:47,776: 10:27:47 | 2 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.79s]
2018-02-08 10:27:48,075: 10:27:48 | 3 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.82s]
2018-02-08 10:27:48,364: 10:27:48 | 1 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.87s]
2018-02-08 10:27:48,365: 10:27:48 | 4 of 36 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:27:48,366: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:27:48,366: 10:27:48 | 5 of 36 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:27:48,379: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:27:48,379: Compiling model.seo_audit.ga_proc
2018-02-08 10:27:48,366: 10:27:48 | 6 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:27:48,366: 10:27:48 | 7 of 36 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 10:27:48,386: Compiling model.seo_audit.moz_proc
2018-02-08 10:27:48,390: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:27:48,390: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:27:48,391: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:27:48,400: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:27:48,413: Re-using an available connection from the pool.
2018-02-08 10:27:48,421: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:27:48,423: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:27:48,428: Re-using an available connection from the pool.
2018-02-08 10:27:48,437: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:27:48,441: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:27:48,441: Re-using an available connection from the pool.
2018-02-08 10:27:48,446: Opening a new connection (4 currently allocated)
2018-02-08 10:27:48,646: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:27:48,658: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:27:48,736: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:27:48,932: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:27:48,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bf7da0>]}
2018-02-08 10:27:49,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b336d8>]}
2018-02-08 10:27:49,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bf75f8>]}
2018-02-08 10:27:49,271: 10:27:49 | 5 of 36 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.57s]
2018-02-08 10:27:49,273: 10:27:49 | 8 of 36 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:27:49,276: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:27:49,286: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:27:49,289: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:27:49,289: Re-using an available connection from the pool.
2018-02-08 10:27:49,508: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:27:49,592: 10:27:49 | 4 of 36 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.63s]
2018-02-08 10:27:49,593: 10:27:49 | 9 of 36 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 10:27:49,594: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:27:49,605: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:27:49,607: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:27:49,607: Re-using an available connection from the pool.
2018-02-08 10:27:49,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bf7da0>]}
2018-02-08 10:27:49,816: 10:27:49 | 6 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.82s]
2018-02-08 10:27:49,816: 10:27:49 | 10 of 36 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:27:49,816: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:27:49,826: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:27:49,829: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:27:49,831: Re-using an available connection from the pool.
2018-02-08 10:27:49,883: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:27:50,079: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:27:50,138: 10:27:50 | 8 of 36 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.52s]
2018-02-08 10:27:50,139: 10:27:50 | 11 of 36 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 10:27:50,139: Compiling model.seo_audit.search_console_proc
2018-02-08 10:27:50,149: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:27:50,152: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:27:50,153: Re-using an available connection from the pool.
2018-02-08 10:27:50,236: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bc2518>]}
2018-02-08 10:27:50,370: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:27:50,533: 10:27:50 | 9 of 36 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.64s]
2018-02-08 10:27:50,534: 10:27:50 | 12 of 36 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:27:50,534: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:27:50,544: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:27:50,545: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:27:50,545: Re-using an available connection from the pool.
2018-02-08 10:27:50,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110beebe0>]}
2018-02-08 10:27:50,770: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:27:50,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110beea58>]}
2018-02-08 10:27:50,954: 10:27:50 | 11 of 36 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.53s]
2018-02-08 10:27:50,956: 10:27:50 | 13 of 36 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 10:27:50,959: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:27:50,967: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:27:50,969: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:27:50,969: Re-using an available connection from the pool.
2018-02-08 10:27:51,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b33a20>]}
2018-02-08 10:27:51,192: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:27:51,274: 10:27:51 | 7 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 2.42s]
2018-02-08 10:27:51,499: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b46c50>]}
2018-02-08 10:27:51,666: 10:27:51 | 12 of 36 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.50s]
2018-02-08 10:27:51,888: 10:27:51 | 13 of 36 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.54s]
2018-02-08 10:27:52,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:27:52,802: 10:27:52 | 10 of 36 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 2.69s]
2018-02-08 10:27:52,803: 10:27:52 | 14 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:27:52,803: Compiling model.seo_audit.search_console_history
2018-02-08 10:27:52,812: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:27:52,808: 10:27:52 | 15 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:27:52,812: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:27:52,808: 10:27:52 | 16 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:27:52,820: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:27:52,820: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:27:52,808: 10:27:52 | 17 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:27:52,822: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:27:52,837: Re-using an available connection from the pool.
2018-02-08 10:27:52,824: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:27:52,836: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:27:52,835: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:27:52,837: Re-using an available connection from the pool.
2018-02-08 10:27:52,842: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:27:52,854: Re-using an available connection from the pool.
2018-02-08 10:27:52,857: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:27:52,864: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:27:52,865: Re-using an available connection from the pool.
2018-02-08 10:27:53,029: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:27:53,067: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:27:53,068: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:27:53,087: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:27:53,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b33b38>]}
2018-02-08 10:27:53,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c0b630>]}
2018-02-08 10:27:53,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b46c50>]}
2018-02-08 10:27:53,378: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c0ba20>]}
2018-02-08 10:27:53,558: 10:27:53 | 14 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.52s]
2018-02-08 10:27:53,559: 10:27:53 | 18 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:27:53,561: Compiling model.seo_audit.ga_stats
2018-02-08 10:27:53,571: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:27:53,573: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:27:53,574: Re-using an available connection from the pool.
2018-02-08 10:27:53,774: 10:27:53 | 15 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.55s]
2018-02-08 10:27:53,780: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:27:54,055: 10:27:54 | 16 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.55s]
2018-02-08 10:27:54,206: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b33b38>]}
2018-02-08 10:27:54,279: 10:27:54 | 17 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.54s]
2018-02-08 10:27:54,497: 10:27:54 | 18 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.65s]
2018-02-08 10:27:54,498: 10:27:54 | 19 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:27:54,498: 10:27:54 | 20 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:27:54,499: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:27:54,498: 10:27:54 | 21 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:27:54,499: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:27:54,507: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:27:54,507: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:27:54,512: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:27:54,518: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:27:54,519: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:27:54,520: Re-using an available connection from the pool.
2018-02-08 10:27:54,521: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:27:54,521: Re-using an available connection from the pool.
2018-02-08 10:27:54,522: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:27:54,524: Re-using an available connection from the pool.
2018-02-08 10:27:54,724: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:27:54,733: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:27:54,739: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:27:55,066: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:27:55,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6be6a0>]}
2018-02-08 10:27:55,127: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be3cf8>]}
2018-02-08 10:27:55,377: 10:27:55 | 20 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.57s]
2018-02-08 10:27:55,609: 10:27:55 | 21 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.56s]
2018-02-08 10:27:55,819: 10:27:55 | 19 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.63s]
2018-02-08 10:27:55,820: 10:27:55 | 22 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:27:55,821: 10:27:55 | 23 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:27:55,821: 10:27:55 | 24 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:27:55,821: 10:27:55 | 25 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:27:55,822: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:27:55,822: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:27:55,822: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:27:55,822: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:27:55,837: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:27:55,839: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:27:55,844: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:27:55,849: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:27:55,851: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:27:55,852: Re-using an available connection from the pool.
2018-02-08 10:27:55,852: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:27:55,853: Re-using an available connection from the pool.
2018-02-08 10:27:55,855: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:27:55,856: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:27:55,858: Re-using an available connection from the pool.
2018-02-08 10:27:55,860: Re-using an available connection from the pool.
2018-02-08 10:27:56,066: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:27:56,073: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:27:56,084: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:27:56,112: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:27:56,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be3cf8>]}
2018-02-08 10:27:56,504: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b33b38>]}
2018-02-08 10:27:56,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be37b8>]}
2018-02-08 10:27:56,513: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be3898>]}
2018-02-08 10:27:56,810: 10:27:56 | 23 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.68s]
2018-02-08 10:27:57,135: 10:27:57 | 22 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.68s]
2018-02-08 10:27:57,387: 10:27:57 | 24 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.69s]
2018-02-08 10:27:57,613: 10:27:57 | 25 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.69s]
2018-02-08 10:27:57,614: 10:27:57 | 26 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:27:57,615: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:27:57,615: 10:27:57 | 27 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:27:57,626: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:27:57,615: 10:27:57 | 28 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:27:57,626: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:27:57,615: 10:27:57 | 29 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:27:57,627: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:27:57,633: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:27:57,635: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:27:57,648: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:27:57,651: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:27:57,663: Re-using an available connection from the pool.
2018-02-08 10:27:57,659: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:27:57,661: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:27:57,669: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:27:57,670: Re-using an available connection from the pool.
2018-02-08 10:27:57,671: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:27:57,672: Re-using an available connection from the pool.
2018-02-08 10:27:57,678: Re-using an available connection from the pool.
2018-02-08 10:27:57,920: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:27:57,921: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:27:57,928: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:27:57,929: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:27:58,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be3cf8>]}
2018-02-08 10:27:58,345: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110be3550>]}
2018-02-08 10:27:58,387: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:27:58,399: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bffb70>]}
2018-02-08 10:27:58,660: 10:27:58 | 29 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.71s]
2018-02-08 10:27:58,661: 10:27:58 | 30 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:27:58,663: Compiling model.seo_audit.agg_indicative
2018-02-08 10:27:58,673: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:27:58,676: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:27:58,676: Re-using an available connection from the pool.
2018-02-08 10:27:58,908: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:27:58,926: 10:27:58 | 28 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.72s]
2018-02-08 10:27:58,927: 10:27:58 | 31 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:27:58,928: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:27:58,935: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:27:58,938: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:27:58,938: Re-using an available connection from the pool.
2018-02-08 10:27:59,125: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:27:59,146: 10:27:59 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.77s]
2018-02-08 10:27:59,147: 10:27:59 | 32 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:27:59,148: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:27:59,155: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:27:59,159: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:27:59,159: Re-using an available connection from the pool.
2018-02-08 10:27:59,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bffe80>]}
2018-02-08 10:27:59,352: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:27:59,444: 10:27:59 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.77s]
2018-02-08 10:27:59,602: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bff860>]}
2018-02-08 10:27:59,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:27:59,777: 10:27:59 | 30 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.66s]
2018-02-08 10:28:00,069: 10:28:00 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.67s]
2018-02-08 10:28:00,373: 10:28:00 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.59s]
2018-02-08 10:28:00,374: 10:28:00 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:28:00,374: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:28:00,387: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:28:00,388: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:28:00,388: Re-using an available connection from the pool.
2018-02-08 10:28:00,602: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is not null and ( a.query_string = b.query_string ) ) then null else 1 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename = c.filename ) ) then null else 1 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path = d.first_path ) ) then null else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:28:01,820: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b46c50>]}
2018-02-08 10:28:02,058: 10:28:02 | 33 of 36 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.45s]
2018-02-08 10:28:02,058: 10:28:02 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:28:02,058: Compiling model.seo_audit.agg_stats
2018-02-08 10:28:02,068: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:28:02,069: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:28:02,069: Re-using an available connection from the pool.
2018-02-08 10:28:02,288: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:28:02,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:28:03,114: 10:28:03 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.81s]
2018-02-08 10:28:03,115: 10:28:03 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:28:03,115: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:28:03,124: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:28:03,126: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:28:03,126: Re-using an available connection from the pool.
2018-02-08 10:28:03,304: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:28:03,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b46c50>]}
2018-02-08 10:28:04,105: 10:28:04 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.78s]
2018-02-08 10:28:04,105: 10:28:04 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:28:04,106: Compiling model.seo_audit.agg_all
2018-02-08 10:28:04,116: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:28:04,118: Acquiring new bigquery connection "agg_all".
2018-02-08 10:28:04,118: Re-using an available connection from the pool.
2018-02-08 10:28:04,319: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:28:05,201: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d3e442-2d83-4b51-884f-4369fdc65fb0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af5f60>]}
2018-02-08 10:28:05,491: 10:28:05 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.10s]
2018-02-08 10:28:05,518: 10:28:05 | 
2018-02-08 10:28:05,519: 10:28:05 | Finished running 36 view models in 19.04s.
2018-02-08 10:28:05,519: Connection 'master' was left open.
2018-02-08 10:28:05,519: 
2018-02-08 10:28:05,520: Completed successfully
2018-02-08 10:28:05,520: 
Done. PASS=36 ERROR=0 SKIP=0 TOTAL=36
2018-02-08 10:28:05,520: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b15278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110adf518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110adf5f8>]}
2018-02-08 10:28:05,854: Flushing usage events
2018-02-08 10:29:45,006: Tracking: tracking
2018-02-08 10:29:45,009: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109465668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094654a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109465b00>]}
2018-02-08 10:29:45,825: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:29:45,852: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:29:45,859: Parsing core.sql
2018-02-08 10:29:45,877: Parsing adapters/bigquery.sql
2018-02-08 10:29:45,885: Parsing adapters/common.sql
2018-02-08 10:29:45,904: Parsing adapters/postgres.sql
2018-02-08 10:29:45,912: Parsing adapters/redshift.sql
2018-02-08 10:29:45,952: Parsing etc/get_custom_schema.sql
2018-02-08 10:29:45,965: Parsing materializations/archive.sql
2018-02-08 10:29:46,008: Parsing materializations/bigquery.sql
2018-02-08 10:29:46,024: Parsing materializations/helpers.sql
2018-02-08 10:29:46,044: Parsing materializations/incremental.sql
2018-02-08 10:29:46,079: Parsing materializations/table.sql
2018-02-08 10:29:46,101: Parsing materializations/view.sql
2018-02-08 10:29:46,118: Parsing materializations/wrapper.sql
2018-02-08 10:29:46,124: Parsing schema_tests/accepted_values.sql
2018-02-08 10:29:46,130: Parsing schema_tests/not_null.sql
2018-02-08 10:29:46,135: Parsing schema_tests/relationships.sql
2018-02-08 10:29:46,141: Parsing schema_tests/unique.sql
2018-02-08 10:29:46,224: Parsing model.seo_audit.accounts_proc
2018-02-08 10:29:46,229: Parsing model.seo_audit.all_dates
2018-02-08 10:29:46,231: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:29:46,235: Acquiring new bigquery connection "master".
2018-02-08 10:29:46,235: Opening a new connection (0 currently allocated)
2018-02-08 10:29:46,240: Parsing model.seo_audit.agg_all
2018-02-08 10:29:46,243: Parsing model.seo_audit.agg_indicative
2018-02-08 10:29:46,245: Parsing model.seo_audit.agg_stats
2018-02-08 10:29:46,250: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:29:46,253: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:29:46,256: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:29:46,259: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:29:46,261: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:29:46,262: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:29:46,264: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:29:46,266: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:29:46,268: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:29:46,273: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:29:46,275: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:29:46,276: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:29:46,279: Parsing model.seo_audit.ga_proc
2018-02-08 10:29:46,281: Parsing model.seo_audit.ga_stats
2018-02-08 10:29:46,284: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:29:46,286: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:29:46,289: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:29:46,291: Parsing model.seo_audit.moz_proc
2018-02-08 10:29:46,294: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:29:46,297: Parsing model.seo_audit.search_console_history
2018-02-08 10:29:46,298: Parsing model.seo_audit.search_console_proc
2018-02-08 10:29:46,301: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:29:46,304: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:29:46,306: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:29:46,308: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:29:46,311: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:29:46,314: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:29:46,316: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:29:46,318: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:29:46,320: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:29:46,334: Found 36 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:29:46,347: 
2018-02-08 10:29:46,766: 10:29:46 | Concurrency: 4 threads (target='dev')
2018-02-08 10:29:46,766: 10:29:46 | 
2018-02-08 10:29:47,031: 10:29:47 | 1 of 36 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:29:47,031: Compiling model.seo_audit.all_dates
2018-02-08 10:29:47,031: 10:29:47 | 2 of 36 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:29:47,035: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:29:47,031: 10:29:47 | 3 of 36 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:29:47,035: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:29:47,036: Compiling model.seo_audit.accounts_proc
2018-02-08 10:29:47,040: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:29:47,045: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:29:47,046: Acquiring new bigquery connection "all_dates".
2018-02-08 10:29:47,047: Opening a new connection (1 currently allocated)
2018-02-08 10:29:47,103: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:29:47,103: Opening a new connection (2 currently allocated)
2018-02-08 10:29:47,105: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:29:47,149: Opening a new connection (3 currently allocated)
2018-02-08 10:29:47,599: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:29:47,603: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:29:47,623: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:29:47,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c5c0>]}
2018-02-08 10:29:47,804: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1096240f0>]}
2018-02-08 10:29:47,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109624668>]}
2018-02-08 10:29:47,985: 10:29:47 | 1 of 36 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.74s]
2018-02-08 10:29:48,208: 10:29:48 | 3 of 36 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.77s]
2018-02-08 10:29:48,497: 10:29:48 | 2 of 36 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.84s]
2018-02-08 10:29:48,498: 10:29:48 | 4 of 36 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 10:29:48,499: 10:29:48 | 5 of 36 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:29:48,499: 10:29:48 | 6 of 36 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:29:48,499: 10:29:48 | 7 of 36 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:29:48,500: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:29:48,500: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:29:48,500: Compiling model.seo_audit.search_console_proc
2018-02-08 10:29:48,500: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:29:48,512: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:29:48,522: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:29:48,529: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:29:48,535: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:29:48,540: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:29:48,541: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:29:48,541: Re-using an available connection from the pool.
2018-02-08 10:29:48,541: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:29:48,543: Re-using an available connection from the pool.
2018-02-08 10:29:48,544: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:29:48,544: Re-using an available connection from the pool.
2018-02-08 10:29:48,547: Opening a new connection (4 currently allocated)
2018-02-08 10:29:48,735: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:29:48,753: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:29:48,758: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:29:49,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c518>]}
2018-02-08 10:29:49,033: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:29:49,078: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109639b38>]}
2018-02-08 10:29:49,120: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109624ef0>]}
2018-02-08 10:29:49,260: 10:29:49 | 5 of 36 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.53s]
2018-02-08 10:29:49,261: 10:29:49 | 8 of 36 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:29:49,263: Compiling model.seo_audit.moz_proc
2018-02-08 10:29:49,276: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:29:49,280: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:29:49,280: Re-using an available connection from the pool.
2018-02-08 10:29:49,487: 10:29:49 | 4 of 36 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.58s]
2018-02-08 10:29:49,488: 10:29:49 | 9 of 36 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 10:29:49,489: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:29:49,497: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:29:49,502: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:29:49,509: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:29:49,511: Re-using an available connection from the pool.
2018-02-08 10:29:49,710: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:29:49,715: 10:29:49 | 7 of 36 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.62s]
2018-02-08 10:29:49,715: 10:29:49 | 10 of 36 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:29:49,716: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:29:49,724: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:29:49,725: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:29:49,726: Re-using an available connection from the pool.
2018-02-08 10:29:49,789: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109624668>]}
2018-02-08 10:29:49,790: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109635898>]}
2018-02-08 10:29:49,911: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:29:49,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:49,998: 10:29:49 | 8 of 36 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.53s]
2018-02-08 10:29:49,999: 10:29:49 | 11 of 36 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:29:49,999: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:29:50,007: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:29:50,010: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:29:50,012: Re-using an available connection from the pool.
2018-02-08 10:29:50,215: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:29:50,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109533ac8>]}
2018-02-08 10:29:50,258: 10:29:50 | 6 of 36 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 1.29s]
2018-02-08 10:29:50,259: 10:29:50 | 12 of 36 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 10:29:50,260: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:29:50,266: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:29:50,268: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:29:50,268: Re-using an available connection from the pool.
2018-02-08 10:29:50,483: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:29:50,494: 10:29:50 | 9 of 36 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.47s]
2018-02-08 10:29:50,495: 10:29:50 | 13 of 36 START view model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 10:29:50,496: Compiling model.seo_audit.ga_proc
2018-02-08 10:29:50,510: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:29:50,512: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:29:50,512: Re-using an available connection from the pool.
2018-02-08 10:29:50,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1060076a0>]}
2018-02-08 10:29:50,713: 10:29:50 | 10 of 36 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.51s]
2018-02-08 10:29:50,743: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:29:50,775: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c518>]}
2018-02-08 10:29:50,999: 10:29:50 | 11 of 36 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.57s]
2018-02-08 10:29:51,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:51,214: 10:29:51 | 12 of 36 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.52s]
2018-02-08 10:29:51,423: 10:29:51 | 13 of 36 OK created view model seo_audit_dev.ga_proc................. [CREATE VIEW in 0.57s]
2018-02-08 10:29:51,424: 10:29:51 | 14 of 36 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:29:51,425: 10:29:51 | 15 of 36 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:29:51,425: 10:29:51 | 16 of 36 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:29:51,425: 10:29:51 | 17 of 36 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:29:51,426: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:29:51,426: Compiling model.seo_audit.ga_stats
2018-02-08 10:29:51,426: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:29:51,426: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:29:51,443: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:29:51,443: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:29:51,452: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:29:51,459: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:29:51,461: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:29:51,462: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:29:51,462: Re-using an available connection from the pool.
2018-02-08 10:29:51,462: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:29:51,463: Re-using an available connection from the pool.
2018-02-08 10:29:51,463: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:29:51,464: Re-using an available connection from the pool.
2018-02-08 10:29:51,469: Re-using an available connection from the pool.
2018-02-08 10:29:51,669: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:29:51,689: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:29:51,723: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:29:51,731: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:29:52,128: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095589e8>]}
2018-02-08 10:29:52,130: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109546c50>]}
2018-02-08 10:29:52,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:52,132: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109558e10>]}
2018-02-08 10:29:52,370: 10:29:52 | 16 of 36 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.70s]
2018-02-08 10:29:52,371: 10:29:52 | 18 of 36 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:29:52,372: Compiling model.seo_audit.search_console_history
2018-02-08 10:29:52,381: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:29:52,382: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:29:52,382: Re-using an available connection from the pool.
2018-02-08 10:29:52,584: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:29:52,591: 10:29:52 | 15 of 36 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.70s]
2018-02-08 10:29:52,797: 10:29:52 | 14 of 36 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.70s]
2018-02-08 10:29:52,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095589e8>]}
2018-02-08 10:29:53,009: 10:29:53 | 17 of 36 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.71s]
2018-02-08 10:29:53,207: 10:29:53 | 18 of 36 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.49s]
2018-02-08 10:29:53,208: 10:29:53 | 19 of 36 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:29:53,209: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:29:53,208: 10:29:53 | 20 of 36 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:29:53,214: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:29:53,208: 10:29:53 | 21 of 36 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:29:53,213: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:29:53,220: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:29:53,220: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:29:53,229: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:29:53,229: Re-using an available connection from the pool.
2018-02-08 10:29:53,227: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:29:53,231: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:29:53,231: Re-using an available connection from the pool.
2018-02-08 10:29:53,234: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:29:53,235: Re-using an available connection from the pool.
2018-02-08 10:29:53,414: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:29:53,428: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:29:53,452: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:29:53,733: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959c438>]}
2018-02-08 10:29:53,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109617d30>]}
2018-02-08 10:29:54,042: 10:29:54 | 21 of 36 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.51s]
2018-02-08 10:29:54,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095589e8>]}
2018-02-08 10:29:54,370: 10:29:54 | 19 of 36 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.61s]
2018-02-08 10:29:54,578: 10:29:54 | 20 of 36 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 1.10s]
2018-02-08 10:29:54,578: 10:29:54 | 22 of 36 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:29:54,579: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:29:54,585: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:29:54,578: 10:29:54 | 23 of 36 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:29:54,578: 10:29:54 | 24 of 36 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:29:54,585: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:29:54,579: 10:29:54 | 25 of 36 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:29:54,585: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:29:54,592: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:29:54,592: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:29:54,592: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:29:54,602: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:29:54,620: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:29:54,602: Re-using an available connection from the pool.
2018-02-08 10:29:54,623: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:29:54,630: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:29:54,630: Re-using an available connection from the pool.
2018-02-08 10:29:54,603: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:29:54,637: Re-using an available connection from the pool.
2018-02-08 10:29:54,661: Re-using an available connection from the pool.
2018-02-08 10:29:54,872: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:29:54,874: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:29:54,881: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:29:54,883: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:29:55,287: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959c438>]}
2018-02-08 10:29:55,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109624ef0>]}
2018-02-08 10:29:55,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:55,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c5c0>]}
2018-02-08 10:29:55,587: 10:29:55 | 23 of 36 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.70s]
2018-02-08 10:29:55,804: 10:29:55 | 25 of 36 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.70s]
2018-02-08 10:29:56,113: 10:29:56 | 22 of 36 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.71s]
2018-02-08 10:29:56,443: 10:29:56 | 24 of 36 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.72s]
2018-02-08 10:29:56,443: 10:29:56 | 26 of 36 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:29:56,444: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:29:56,443: 10:29:56 | 27 of 36 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:29:56,452: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:29:56,453: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:29:56,444: 10:29:56 | 28 of 36 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:29:56,454: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:29:56,461: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:29:56,461: Compiling model.seo_audit.agg_indicative
2018-02-08 10:29:56,444: 10:29:56 | 29 of 36 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:29:56,466: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:29:56,461: Re-using an available connection from the pool.
2018-02-08 10:29:56,489: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:29:56,494: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:29:56,494: Re-using an available connection from the pool.
2018-02-08 10:29:56,500: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:29:56,502: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:29:56,502: Re-using an available connection from the pool.
2018-02-08 10:29:56,509: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:29:56,509: Re-using an available connection from the pool.
2018-02-08 10:29:56,716: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:29:56,721: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:29:56,730: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:29:56,762: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:29:57,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:57,255: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959ca20>]}
2018-02-08 10:29:57,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109654c50>]}
2018-02-08 10:29:57,296: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109654908>]}
2018-02-08 10:29:57,574: 10:29:57 | 26 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.79s]
2018-02-08 10:29:57,575: 10:29:57 | 30 of 36 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:29:57,576: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:29:57,589: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:29:57,593: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:29:57,593: Re-using an available connection from the pool.
2018-02-08 10:29:57,806: 10:29:57 | 28 of 36 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.79s]
2018-02-08 10:29:57,808: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:29:57,808: 10:29:57 | 31 of 36 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:29:57,816: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:29:57,827: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:29:57,829: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:29:57,829: Re-using an available connection from the pool.
2018-02-08 10:29:58,058: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:29:58,088: 10:29:58 | 27 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.80s]
2018-02-08 10:29:58,089: 10:29:58 | 32 of 36 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:29:58,089: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:29:58,101: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:29:58,105: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:29:58,105: Re-using an available connection from the pool.
2018-02-08 10:29:58,298: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:29:58,317: 10:29:58 | 29 of 36 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.83s]
2018-02-08 10:29:58,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959f9e8>]}
2018-02-08 10:29:58,557: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109624b70>]}
2018-02-08 10:29:58,693: 10:29:58 | 30 of 36 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.82s]
2018-02-08 10:29:58,741: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959cd30>]}
2018-02-08 10:29:58,989: 10:29:58 | 31 of 36 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.74s]
2018-02-08 10:29:59,200: 10:29:59 | 32 of 36 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.65s]
2018-02-08 10:29:59,201: 10:29:59 | 33 of 36 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:29:59,201: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:29:59,213: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:29:59,214: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:29:59,214: Re-using an available connection from the pool.
2018-02-08 10:29:59,421: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is null or ( a.query_string = b.query_string ) ) then 0 else 1 end as reclass_query_string,
case when ( c.filename is null or ( a.filename = c.filename ) ) then 0 else 1 end as reclass_filename, 
case when ( d.first_path is null or (a.first_path = d.first_path ) ) then 0 else 1 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:30:00,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c5c0>]}
2018-02-08 10:30:00,714: 10:30:00 | 33 of 36 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.22s]
2018-02-08 10:30:00,715: 10:30:00 | 34 of 36 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:30:00,715: Compiling model.seo_audit.agg_stats
2018-02-08 10:30:00,732: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:30:00,733: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:30:00,733: Re-using an available connection from the pool.
2018-02-08 10:30:00,936: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:30:01,512: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095902e8>]}
2018-02-08 10:30:01,722: 10:30:01 | 34 of 36 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-08 10:30:01,723: 10:30:01 | 35 of 36 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:30:01,723: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:30:01,733: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:30:01,735: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:30:01,735: Re-using an available connection from the pool.
2018-02-08 10:30:01,925: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:30:02,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10964c5c0>]}
2018-02-08 10:30:02,872: 10:30:02 | 35 of 36 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.93s]
2018-02-08 10:30:02,873: 10:30:02 | 36 of 36 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:30:02,873: Compiling model.seo_audit.agg_all
2018-02-08 10:30:02,882: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:30:02,883: Acquiring new bigquery connection "agg_all".
2018-02-08 10:30:02,883: Re-using an available connection from the pool.
2018-02-08 10:30:03,065: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:30:03,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b26613b8-338f-4155-9612-9be7ee8849ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095902e8>]}
2018-02-08 10:30:04,084: 10:30:04 | 36 of 36 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.01s]
2018-02-08 10:30:04,162: 10:30:04 | 
2018-02-08 10:30:04,162: 10:30:04 | Finished running 36 view models in 17.39s.
2018-02-08 10:30:04,162: Connection 'master' was left open.
2018-02-08 10:30:04,163: 
2018-02-08 10:30:04,163: Completed successfully
2018-02-08 10:30:04,163: 
Done. PASS=36 ERROR=0 SKIP=0 TOTAL=36
2018-02-08 10:30:04,164: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109533710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109533898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109533748>]}
2018-02-08 10:30:04,401: Flushing usage events
2018-02-08 10:47:30,783: Tracking: tracking
2018-02-08 10:47:30,787: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10636e710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10636ecf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10636e048>]}
2018-02-08 10:47:31,617: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:47:31,641: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:47:31,645: Parsing core.sql
2018-02-08 10:47:31,670: Parsing adapters/bigquery.sql
2018-02-08 10:47:31,682: Parsing adapters/common.sql
2018-02-08 10:47:31,701: Parsing adapters/postgres.sql
2018-02-08 10:47:31,708: Parsing adapters/redshift.sql
2018-02-08 10:47:31,734: Parsing etc/get_custom_schema.sql
2018-02-08 10:47:31,747: Parsing materializations/archive.sql
2018-02-08 10:47:31,778: Parsing materializations/bigquery.sql
2018-02-08 10:47:31,802: Parsing materializations/helpers.sql
2018-02-08 10:47:31,823: Parsing materializations/incremental.sql
2018-02-08 10:47:31,854: Parsing materializations/table.sql
2018-02-08 10:47:31,880: Parsing materializations/view.sql
2018-02-08 10:47:31,907: Parsing materializations/wrapper.sql
2018-02-08 10:47:31,915: Parsing schema_tests/accepted_values.sql
2018-02-08 10:47:31,924: Parsing schema_tests/not_null.sql
2018-02-08 10:47:31,931: Parsing schema_tests/relationships.sql
2018-02-08 10:47:31,938: Parsing schema_tests/unique.sql
2018-02-08 10:47:32,060: Parsing model.seo_audit.accounts_proc
2018-02-08 10:47:32,065: Parsing model.seo_audit.all_dates
2018-02-08 10:47:32,067: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:47:32,072: Acquiring new bigquery connection "master".
2018-02-08 10:47:32,072: Opening a new connection (0 currently allocated)
2018-02-08 10:47:32,080: Parsing model.seo_audit.agg_all
2018-02-08 10:47:32,085: Parsing model.seo_audit.agg_indicative
2018-02-08 10:47:32,089: Parsing model.seo_audit.agg_stats
2018-02-08 10:47:32,095: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:47:32,098: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:47:32,103: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:47:32,106: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:47:32,108: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:47:32,110: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:47:32,112: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:47:32,114: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:47:32,117: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:47:32,119: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:47:32,124: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:47:32,127: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:47:32,129: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:47:32,131: Parsing model.seo_audit.ga_proc
2018-02-08 10:47:32,134: Parsing model.seo_audit.ga_stats
2018-02-08 10:47:32,135: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:47:32,137: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:47:32,140: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:47:32,143: Parsing model.seo_audit.moz_proc
2018-02-08 10:47:32,145: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:47:32,148: Parsing model.seo_audit.search_console_history
2018-02-08 10:47:32,150: Parsing model.seo_audit.search_console_proc
2018-02-08 10:47:32,152: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:47:32,155: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:47:32,156: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:47:32,159: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:47:32,162: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:47:32,164: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:47:32,166: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:47:32,169: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:47:32,171: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:47:32,183: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:47:32,192: 
2018-02-08 10:47:33,410: 10:47:33 | Concurrency: 4 threads (target='dev')
2018-02-08 10:47:33,410: 10:47:33 | 
2018-02-08 10:47:33,659: 10:47:33 | 1 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:47:33,659: Compiling model.seo_audit.accounts_proc
2018-02-08 10:47:33,665: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:47:33,660: 10:47:33 | 2 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:47:33,665: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:47:33,670: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:47:33,660: 10:47:33 | 3 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:47:33,670: Compiling model.seo_audit.all_dates
2018-02-08 10:47:33,675: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:47:33,676: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:47:33,676: Opening a new connection (1 currently allocated)
2018-02-08 10:47:33,677: Acquiring new bigquery connection "all_dates".
2018-02-08 10:47:33,679: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:47:33,679: Opening a new connection (2 currently allocated)
2018-02-08 10:47:33,780: Opening a new connection (3 currently allocated)
2018-02-08 10:47:34,331: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:47:34,331: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:47:34,333: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:47:34,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10652eb00>]}
2018-02-08 10:47:34,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10654dfd0>]}
2018-02-08 10:47:34,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064e40f0>]}
2018-02-08 10:47:34,872: 10:47:34 | 1 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.88s]
2018-02-08 10:47:35,186: 10:47:35 | 3 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.87s]
2018-02-08 10:47:35,475: 10:47:35 | 2 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.88s]
2018-02-08 10:47:35,477: 10:47:35 | 4 of 37 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:47:35,477: 10:47:35 | 5 of 37 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:47:35,477: 10:47:35 | 6 of 37 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:47:35,478: 10:47:35 | 7 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:47:35,478: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:47:35,478: Compiling model.seo_audit.moz_proc
2018-02-08 10:47:35,478: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:47:35,479: Compiling model.seo_audit.ga_proc
2018-02-08 10:47:35,494: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:47:35,494: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:47:35,500: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:47:35,506: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:47:35,510: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:47:35,510: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:47:35,511: Re-using an available connection from the pool.
2018-02-08 10:47:35,511: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:47:35,512: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:47:35,513: Re-using an available connection from the pool.
2018-02-08 10:47:35,515: Re-using an available connection from the pool.
2018-02-08 10:47:35,515: Opening a new connection (4 currently allocated)
2018-02-08 10:47:35,784: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:47:35,788: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:47:35,791: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:47:35,942: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:47:36,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064e4b00>]}
2018-02-08 10:47:36,144: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651f4a8>]}
2018-02-08 10:47:36,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651fba8>]}
2018-02-08 10:47:36,300: 10:47:36 | 5 of 37 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.61s]
2018-02-08 10:47:36,301: 10:47:36 | 8 of 37 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:47:36,303: Compiling model.seo_audit.search_console_proc
2018-02-08 10:47:36,315: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:47:36,321: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:47:36,321: Re-using an available connection from the pool.
2018-02-08 10:47:36,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064e4e48>]}
2018-02-08 10:47:36,538: 10:47:36 | 6 of 37 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.67s]
2018-02-08 10:47:36,539: 10:47:36 | 9 of 37 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 10:47:36,540: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:47:36,548: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:47:36,550: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:47:36,550: Re-using an available connection from the pool.
2018-02-08 10:47:36,557: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:47:36,818: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:47:36,864: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:36,868: 10:47:36 | 4 of 37 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.76s]
2018-02-08 10:47:36,869: 10:47:36 | 10 of 37 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 10:47:36,871: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:47:36,883: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:47:36,885: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:47:36,885: Re-using an available connection from the pool.
2018-02-08 10:47:37,111: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:47:37,183: 10:47:37 | 7 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 1.01s]
2018-02-08 10:47:37,184: 10:47:37 | 11 of 37 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:47:37,186: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:47:37,195: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:47:37,197: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:47:37,198: Re-using an available connection from the pool.
2018-02-08 10:47:37,222: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10301a6a0>]}
2018-02-08 10:47:37,431: 10:47:37 | 8 of 37 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.56s]
2018-02-08 10:47:37,432: 10:47:37 | 12 of 37 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:47:37,433: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:47:37,440: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:47:37,449: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:47:37,455: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:47:37,455: Re-using an available connection from the pool.
2018-02-08 10:47:37,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3d30>]}
2018-02-08 10:47:37,686: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:47:37,685: 10:47:37 | 9 of 37 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.68s]
2018-02-08 10:47:37,687: 10:47:37 | 13 of 37 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:47:37,688: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:47:37,695: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:47:37,700: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:47:37,701: Re-using an available connection from the pool.
2018-02-08 10:47:37,725: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106470748>]}
2018-02-08 10:47:37,900: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:47:37,905: 10:47:37 | 10 of 37 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.60s]
2018-02-08 10:47:37,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:38,127: 10:47:38 | 11 of 37 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.54s]
2018-02-08 10:47:38,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10301a6a0>]}
2018-02-08 10:47:38,339: 10:47:38 | 12 of 37 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.53s]
2018-02-08 10:47:38,646: 10:47:38 | 13 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.64s]
2018-02-08 10:47:38,647: 10:47:38 | 14 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:47:38,647: 10:47:38 | 15 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:47:38,647: 10:47:38 | 16 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:47:38,647: 10:47:38 | 17 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:47:38,648: Compiling model.seo_audit.search_console_history
2018-02-08 10:47:38,648: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:47:38,648: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:47:38,648: Compiling model.seo_audit.ga_stats
2018-02-08 10:47:38,662: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:47:38,664: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:47:38,670: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:47:38,674: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:47:38,675: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:47:38,675: Re-using an available connection from the pool.
2018-02-08 10:47:38,676: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:47:38,677: Re-using an available connection from the pool.
2018-02-08 10:47:38,679: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:47:38,679: Re-using an available connection from the pool.
2018-02-08 10:47:38,682: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:47:38,683: Re-using an available connection from the pool.
2018-02-08 10:47:38,862: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:47:38,872: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:47:38,909: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:47:38,927: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:47:39,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064ad470>]}
2018-02-08 10:47:39,254: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10652e2b0>]}
2018-02-08 10:47:39,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3d30>]}
2018-02-08 10:47:39,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10652ef28>]}
2018-02-08 10:47:39,559: 10:47:39 | 14 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.60s]
2018-02-08 10:47:39,560: 10:47:39 | 18 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:47:39,561: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:47:39,571: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:47:39,575: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:47:39,575: Re-using an available connection from the pool.
2018-02-08 10:47:39,809: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:47:39,894: 10:47:39 | 16 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.61s]
2018-02-08 10:47:40,258: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064ad470>]}
2018-02-08 10:47:40,507: 10:47:40 | 15 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.61s]
2018-02-08 10:47:40,739: 10:47:40 | 17 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.68s]
2018-02-08 10:47:40,954: 10:47:40 | 18 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.70s]
2018-02-08 10:47:40,955: 10:47:40 | 19 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:47:40,956: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:47:40,955: 10:47:40 | 20 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:47:40,962: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:47:40,955: 10:47:40 | 21 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:47:40,968: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:47:40,972: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:47:40,974: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:47:40,982: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:47:40,983: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:47:40,983: Re-using an available connection from the pool.
2018-02-08 10:47:40,984: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:47:40,984: Re-using an available connection from the pool.
2018-02-08 10:47:40,988: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:47:40,988: Re-using an available connection from the pool.
2018-02-08 10:47:41,185: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:47:41,204: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:47:41,252: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:47:41,608: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10643ceb8>]}
2018-02-08 10:47:41,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10654dc88>]}
2018-02-08 10:47:41,615: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10301a6a0>]}
2018-02-08 10:47:41,915: 10:47:41 | 21 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.64s]
2018-02-08 10:47:42,127: 10:47:42 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.65s]
2018-02-08 10:47:42,546: 10:47:42 | 19 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.66s]
2018-02-08 10:47:42,547: 10:47:42 | 22 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:47:42,547: 10:47:42 | 23 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:47:42,547: 10:47:42 | 24 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:47:42,548: 10:47:42 | 25 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:47:42,548: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:47:42,548: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:47:42,548: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:47:42,549: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:47:42,564: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:47:42,575: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:47:42,577: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:47:42,578: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:47:42,580: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:47:42,580: Re-using an available connection from the pool.
2018-02-08 10:47:42,581: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:47:42,582: Re-using an available connection from the pool.
2018-02-08 10:47:42,583: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:47:42,584: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:47:42,584: Re-using an available connection from the pool.
2018-02-08 10:47:42,588: Re-using an available connection from the pool.
2018-02-08 10:47:42,801: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:47:42,823: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:47:43,244: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:47:43,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10654d940>]}
2018-02-08 10:47:43,377: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:47:43,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064ad470>]}
2018-02-08 10:47:43,586: 10:47:43 | 24 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.73s]
2018-02-08 10:47:43,679: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651fc88>]}
2018-02-08 10:47:43,807: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:43,886: 10:47:43 | 22 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 1.00s]
2018-02-08 10:47:44,186: 10:47:44 | 25 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 1.13s]
2018-02-08 10:47:44,474: 10:47:44 | 23 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 1.26s]
2018-02-08 10:47:44,475: 10:47:44 | 26 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:47:44,476: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:47:44,475: 10:47:44 | 27 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:47:44,482: Compiling model.seo_audit.agg_indicative
2018-02-08 10:47:44,490: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:47:44,495: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:47:44,475: 10:47:44 | 28 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:47:44,496: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:47:44,475: 10:47:44 | 29 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:47:44,502: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:47:44,516: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:47:44,516: Re-using an available connection from the pool.
2018-02-08 10:47:44,522: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:47:44,523: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:47:44,530: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:47:44,530: Re-using an available connection from the pool.
2018-02-08 10:47:44,525: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:47:44,543: Re-using an available connection from the pool.
2018-02-08 10:47:44,547: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:47:44,547: Re-using an available connection from the pool.
2018-02-08 10:47:44,733: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:47:44,744: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:47:44,758: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:47:44,792: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:47:45,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651f978>]}
2018-02-08 10:47:45,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106564ef0>]}
2018-02-08 10:47:45,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651fc88>]}
2018-02-08 10:47:45,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10301a6a0>]}
2018-02-08 10:47:45,497: 10:47:45 | 27 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.71s]
2018-02-08 10:47:45,500: 10:47:45 | 30 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:47:45,502: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:47:45,512: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:47:45,513: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:47:45,513: Re-using an available connection from the pool.
2018-02-08 10:47:45,781: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:47:45,885: 10:47:45 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.69s]
2018-02-08 10:47:45,887: 10:47:45 | 31 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:47:45,887: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:47:45,896: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:47:45,900: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:47:45,902: Re-using an available connection from the pool.
2018-02-08 10:47:46,114: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:47:46,137: 10:47:46 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.70s]
2018-02-08 10:47:46,137: 10:47:46 | 32 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:47:46,138: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:47:46,145: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:47:46,147: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:47:46,148: Re-using an available connection from the pool.
2018-02-08 10:47:46,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651f978>]}
2018-02-08 10:47:46,336: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:47:46,377: 10:47:46 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.72s]
2018-02-08 10:47:46,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10652e7b8>]}
2018-02-08 10:47:46,670: 10:47:46 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.80s]
2018-02-08 10:47:46,880: 10:47:46 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.71s]
2018-02-08 10:47:46,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10651fc88>]}
2018-02-08 10:47:47,180: 10:47:47 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.82s]
2018-02-08 10:47:47,180: 10:47:47 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 10:47:47,181: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:47:47,192: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 10:47:47,195: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 10:47:47,195: Re-using an available connection from the pool.
2018-02-08 10:47:47,287: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:47:48,671: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:48,891: 10:47:48 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 1.49s]
2018-02-08 10:47:48,892: 10:47:48 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:47:48,892: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:47:48,898: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:47:48,898: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:47:48,898: Re-using an available connection from the pool.
2018-02-08 10:47:49,090: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:47:49,179: Bad request while running:
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:47:49,179: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Syntax error: Unexpected identifier "class" at [30:48]
2018-02-08 10:47:49,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10657ccf8>]}
2018-02-08 10:47:49,479: 10:47:49 | 34 of 37 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.29s]
2018-02-08 10:47:49,480: 10:47:49 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:47:49,480: Compiling model.seo_audit.agg_stats
2018-02-08 10:47:49,490: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:47:49,490: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:47:49,491: Re-using an available connection from the pool.
2018-02-08 10:47:49,697: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:47:50,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:50,522: 10:47:50 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.83s]
2018-02-08 10:47:50,523: 10:47:50 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:47:50,523: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:47:50,531: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:47:50,532: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:47:50,532: Re-using an available connection from the pool.
2018-02-08 10:47:50,723: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:47:51,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10301a6a0>]}
2018-02-08 10:47:51,618: 10:47:51 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.86s]
2018-02-08 10:47:51,619: 10:47:51 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:47:51,619: Compiling model.seo_audit.agg_all
2018-02-08 10:47:51,631: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:47:51,632: Acquiring new bigquery connection "agg_all".
2018-02-08 10:47:51,632: Re-using an available connection from the pool.
2018-02-08 10:47:51,852: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:47:52,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4b7f0e2-cabc-42da-81ed-f03b6839358d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064a3ac8>]}
2018-02-08 10:47:53,167: 10:47:53 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.33s]
2018-02-08 10:47:53,202: 10:47:53 | 
2018-02-08 10:47:53,203: 10:47:53 | Finished running 37 view models in 19.79s.
2018-02-08 10:47:53,203: Connection 'master' was left open.
2018-02-08 10:47:53,203: 
2018-02-08 10:47:53,204: Completed with 1 errors:
2018-02-08 10:47:53,204: 
2018-02-08 10:47:53,205: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 10:47:53,205:   Syntax error: Unexpected identifier "class" at [30:48]
2018-02-08 10:47:53,205:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 10:47:53,206: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 10:47:53,206: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10643c7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10643c518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10636ea90>]}
2018-02-08 10:47:53,515: Flushing usage events
2018-02-08 10:51:09,677: Tracking: tracking
2018-02-08 10:51:09,679: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113471278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113471e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113474fd0>]}
2018-02-08 10:51:10,474: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:51:10,494: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:51:10,500: Parsing core.sql
2018-02-08 10:51:10,522: Parsing adapters/bigquery.sql
2018-02-08 10:51:10,531: Parsing adapters/common.sql
2018-02-08 10:51:10,558: Parsing adapters/postgres.sql
2018-02-08 10:51:10,568: Parsing adapters/redshift.sql
2018-02-08 10:51:10,596: Parsing etc/get_custom_schema.sql
2018-02-08 10:51:10,606: Parsing materializations/archive.sql
2018-02-08 10:51:10,653: Parsing materializations/bigquery.sql
2018-02-08 10:51:10,682: Parsing materializations/helpers.sql
2018-02-08 10:51:10,717: Parsing materializations/incremental.sql
2018-02-08 10:51:10,773: Parsing materializations/table.sql
2018-02-08 10:51:10,860: Parsing materializations/view.sql
2018-02-08 10:51:10,957: Parsing materializations/wrapper.sql
2018-02-08 10:51:10,972: Parsing schema_tests/accepted_values.sql
2018-02-08 10:51:10,984: Parsing schema_tests/not_null.sql
2018-02-08 10:51:10,994: Parsing schema_tests/relationships.sql
2018-02-08 10:51:11,007: Parsing schema_tests/unique.sql
2018-02-08 10:51:11,073: Parsing model.seo_audit.accounts_proc
2018-02-08 10:51:11,079: Parsing model.seo_audit.all_dates
2018-02-08 10:51:11,080: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:51:11,085: Acquiring new bigquery connection "master".
2018-02-08 10:51:11,085: Opening a new connection (0 currently allocated)
2018-02-08 10:51:11,091: Parsing model.seo_audit.agg_all
2018-02-08 10:51:11,096: Parsing model.seo_audit.agg_indicative
2018-02-08 10:51:11,102: Parsing model.seo_audit.agg_stats
2018-02-08 10:51:11,113: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:51:11,117: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:51:11,131: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:51:11,164: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:51:11,182: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:51:11,187: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:51:11,189: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:51:11,193: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:51:11,201: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:51:11,206: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:51:11,237: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:51:11,246: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:51:11,251: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:51:11,273: Parsing model.seo_audit.ga_proc
2018-02-08 10:51:11,299: Parsing model.seo_audit.ga_stats
2018-02-08 10:51:11,308: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:51:11,320: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:51:11,341: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:51:11,354: Parsing model.seo_audit.moz_proc
2018-02-08 10:51:11,385: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:51:11,395: Parsing model.seo_audit.search_console_history
2018-02-08 10:51:11,399: Parsing model.seo_audit.search_console_proc
2018-02-08 10:51:11,404: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:51:11,410: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:51:11,415: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:51:11,420: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:51:11,427: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:51:11,433: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:51:11,439: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:51:11,445: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:51:11,451: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:51:11,495: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:51:11,626: 
2018-02-08 10:51:12,196: 10:51:12 | Concurrency: 4 threads (target='dev')
2018-02-08 10:51:12,197: 10:51:12 | 
2018-02-08 10:51:12,644: 10:51:12 | 1 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:51:12,644: Compiling model.seo_audit.all_dates
2018-02-08 10:51:12,651: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:51:12,645: 10:51:12 | 2 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:51:12,645: 10:51:12 | 3 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:51:12,652: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:51:12,652: Compiling model.seo_audit.accounts_proc
2018-02-08 10:51:12,662: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:51:12,670: Acquiring new bigquery connection "all_dates".
2018-02-08 10:51:12,674: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:51:12,675: Opening a new connection (1 currently allocated)
2018-02-08 10:51:12,680: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:51:12,681: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:51:12,684: Opening a new connection (2 currently allocated)
2018-02-08 10:51:12,831: Opening a new connection (3 currently allocated)
2018-02-08 10:51:13,435: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:51:13,452: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:51:13,461: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:51:13,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361ab70>]}
2018-02-08 10:51:13,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113659f60>]}
2018-02-08 10:51:13,688: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a7f0>]}
2018-02-08 10:51:13,904: 10:51:13 | 1 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 1.04s]
2018-02-08 10:51:14,107: 10:51:14 | 3 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.03s]
2018-02-08 10:51:14,340: 10:51:14 | 2 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.04s]
2018-02-08 10:51:14,340: 10:51:14 | 4 of 37 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 10:51:14,341: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:51:14,341: 10:51:14 | 5 of 37 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 10:51:14,348: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:51:14,341: 10:51:14 | 6 of 37 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:51:14,349: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:51:14,341: 10:51:14 | 7 of 37 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 10:51:14,349: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:51:14,355: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:51:14,355: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:51:14,363: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:51:14,364: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:51:14,370: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:51:14,380: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:51:14,380: Re-using an available connection from the pool.
2018-02-08 10:51:14,381: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:51:14,382: Re-using an available connection from the pool.
2018-02-08 10:51:14,388: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:51:14,388: Re-using an available connection from the pool.
2018-02-08 10:51:14,398: Opening a new connection (4 currently allocated)
2018-02-08 10:51:14,628: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:51:14,650: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:51:14,651: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:51:14,912: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:51:14,935: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113626c18>]}
2018-02-08 10:51:14,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a828>]}
2018-02-08 10:51:14,952: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113626e10>]}
2018-02-08 10:51:15,160: 10:51:15 | 5 of 37 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.59s]
2018-02-08 10:51:15,162: 10:51:15 | 8 of 37 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:51:15,164: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:51:15,175: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:51:15,178: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:51:15,179: Re-using an available connection from the pool.
2018-02-08 10:51:15,201: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a320>]}
2018-02-08 10:51:15,404: 10:51:15 | 6 of 37 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.60s]
2018-02-08 10:51:15,408: 10:51:15 | 9 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:51:15,410: Compiling model.seo_audit.ga_proc
2018-02-08 10:51:15,425: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:51:15,426: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:51:15,433: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:51:15,433: Re-using an available connection from the pool.
2018-02-08 10:51:15,646: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:51:15,669: 10:51:15 | 4 of 37 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.61s]
2018-02-08 10:51:15,670: 10:51:15 | 10 of 37 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 10:51:15,671: Compiling model.seo_audit.moz_proc
2018-02-08 10:51:15,689: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:51:15,691: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:51:15,692: Re-using an available connection from the pool.
2018-02-08 10:51:15,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113626c18>]}
2018-02-08 10:51:15,906: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:51:15,936: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a828>]}
2018-02-08 10:51:15,950: 10:51:15 | 7 of 37 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.85s]
2018-02-08 10:51:15,951: 10:51:15 | 11 of 37 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 10:51:15,951: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:51:15,959: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:51:15,961: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:51:15,961: Re-using an available connection from the pool.
2018-02-08 10:51:16,167: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:51:16,191: 10:51:16 | 8 of 37 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.55s]
2018-02-08 10:51:16,191: 10:51:16 | 12 of 37 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 10:51:16,192: Compiling model.seo_audit.search_console_proc
2018-02-08 10:51:16,197: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:51:16,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113558f28>]}
2018-02-08 10:51:16,203: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:51:16,204: Re-using an available connection from the pool.
2018-02-08 10:51:16,450: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113659cc0>]}
2018-02-08 10:51:16,459: 10:51:16 | 9 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.53s]
2018-02-08 10:51:16,461: 10:51:16 | 13 of 37 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:51:16,464: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:51:16,473: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:51:16,478: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:51:16,485: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:51:16,487: Re-using an available connection from the pool.
2018-02-08 10:51:16,793: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:51:16,815: 10:51:16 | 10 of 37 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.53s]
2018-02-08 10:51:16,866: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113576be0>]}
2018-02-08 10:51:17,122: 10:51:17 | 11 of 37 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.50s]
2018-02-08 10:51:17,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11001c6a0>]}
2018-02-08 10:51:17,410: 10:51:17 | 12 of 37 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.67s]
2018-02-08 10:51:17,737: 10:51:17 | 13 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.68s]
2018-02-08 10:51:17,738: 10:51:17 | 14 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:51:17,739: Compiling model.seo_audit.search_console_history
2018-02-08 10:51:17,748: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:51:17,738: 10:51:17 | 15 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:51:17,748: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:51:17,759: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:51:17,739: 10:51:17 | 16 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:51:17,760: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:51:17,763: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:51:17,777: Re-using an available connection from the pool.
2018-02-08 10:51:17,739: 10:51:17 | 17 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:51:17,782: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:51:17,777: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:51:17,774: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:51:17,795: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:51:17,796: Re-using an available connection from the pool.
2018-02-08 10:51:17,803: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:51:17,804: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:51:17,805: Re-using an available connection from the pool.
2018-02-08 10:51:17,807: Re-using an available connection from the pool.
2018-02-08 10:51:17,980: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:51:18,014: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:51:18,042: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:51:18,049: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:51:18,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361aa20>]}
2018-02-08 10:51:18,352: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113543a58>]}
2018-02-08 10:51:18,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11364e080>]}
2018-02-08 10:51:18,411: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113558f28>]}
2018-02-08 10:51:18,583: 10:51:18 | 16 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.51s]
2018-02-08 10:51:18,584: 10:51:18 | 18 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:51:18,585: Compiling model.seo_audit.ga_stats
2018-02-08 10:51:18,597: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:51:18,600: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:51:18,600: Re-using an available connection from the pool.
2018-02-08 10:51:18,839: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:51:18,876: 10:51:18 | 15 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.60s]
2018-02-08 10:51:19,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11364ed68>]}
2018-02-08 10:51:19,221: 10:51:19 | 17 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.60s]
2018-02-08 10:51:19,557: 10:51:19 | 14 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.67s]
2018-02-08 10:51:19,804: 10:51:19 | 18 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.60s]
2018-02-08 10:51:19,805: 10:51:19 | 19 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:51:19,806: 10:51:19 | 20 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:51:19,806: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:51:19,806: 10:51:19 | 21 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:51:19,807: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:51:19,813: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:51:19,816: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:51:19,821: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:51:19,825: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:51:19,826: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:51:19,827: Re-using an available connection from the pool.
2018-02-08 10:51:19,828: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:51:19,828: Re-using an available connection from the pool.
2018-02-08 10:51:19,830: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:51:19,830: Re-using an available connection from the pool.
2018-02-08 10:51:20,067: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:51:20,069: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:51:20,122: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:51:20,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113660860>]}
2018-02-08 10:51:20,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113626c18>]}
2018-02-08 10:51:20,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11364eda0>]}
2018-02-08 10:51:20,796: 10:51:20 | 21 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.75s]
2018-02-08 10:51:21,019: 10:51:21 | 19 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.76s]
2018-02-08 10:51:21,304: 10:51:21 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.76s]
2018-02-08 10:51:21,305: 10:51:21 | 22 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:51:21,306: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:51:21,306: 10:51:21 | 23 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:51:21,315: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:51:21,315: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:51:21,306: 10:51:21 | 24 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:51:21,306: 10:51:21 | 25 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:51:21,320: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:51:21,321: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:51:21,321: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:51:21,322: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:51:21,346: Re-using an available connection from the pool.
2018-02-08 10:51:21,328: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:51:21,355: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:51:21,355: Re-using an available connection from the pool.
2018-02-08 10:51:21,346: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:51:21,351: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:51:21,363: Re-using an available connection from the pool.
2018-02-08 10:51:21,366: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:51:21,369: Re-using an available connection from the pool.
2018-02-08 10:51:21,596: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:51:21,610: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:51:21,640: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:51:21,641: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:51:22,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a630>]}
2018-02-08 10:51:22,104: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113543a58>]}
2018-02-08 10:51:22,106: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11361a8d0>]}
2018-02-08 10:51:22,110: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11366bda0>]}
2018-02-08 10:51:22,381: 10:51:22 | 22 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.80s]
2018-02-08 10:51:22,708: 10:51:22 | 23 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.79s]
2018-02-08 10:51:22,947: 10:51:22 | 24 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.78s]
2018-02-08 10:51:23,161: 10:51:23 | 25 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.79s]
2018-02-08 10:51:23,162: 10:51:23 | 26 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:51:23,163: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:51:23,170: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:51:23,162: 10:51:23 | 27 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:51:23,171: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:51:23,175: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:51:23,162: 10:51:23 | 28 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:51:23,176: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:51:23,181: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:51:23,162: 10:51:23 | 29 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:51:23,183: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:51:23,183: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:51:23,184: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:51:23,184: Re-using an available connection from the pool.
2018-02-08 10:51:23,190: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:51:23,194: Re-using an available connection from the pool.
2018-02-08 10:51:23,195: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:51:23,198: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:51:23,198: Re-using an available connection from the pool.
2018-02-08 10:51:23,211: Re-using an available connection from the pool.
2018-02-08 10:51:24,157: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:51:24,158: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:51:24,169: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:51:24,174: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:51:24,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11001c6a0>]}
2018-02-08 10:51:24,987: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136592e8>]}
2018-02-08 10:51:25,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113678f98>]}
2018-02-08 10:51:25,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113659630>]}
2018-02-08 10:51:25,284: 10:51:25 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 1.82s]
2018-02-08 10:51:25,286: 10:51:25 | 30 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:51:25,289: Compiling model.seo_audit.agg_indicative
2018-02-08 10:51:25,300: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:51:25,301: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:51:25,301: Re-using an available connection from the pool.
2018-02-08 10:51:25,609: 10:51:25 | 27 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 1.82s]
2018-02-08 10:51:25,610: 10:51:25 | 31 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:51:25,610: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:51:25,622: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:51:25,625: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:51:25,626: Re-using an available connection from the pool.
2018-02-08 10:51:25,830: 10:51:25 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 1.86s]
2018-02-08 10:51:25,832: 10:51:25 | 32 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:51:25,834: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:51:25,840: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:51:25,843: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:51:25,843: Re-using an available connection from the pool.
2018-02-08 10:51:26,064: 10:51:26 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 1.89s]
2018-02-08 10:51:26,200: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:51:26,224: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:51:26,709: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:51:27,100: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11001c6a0>]}
2018-02-08 10:51:27,101: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113645898>]}
2018-02-08 10:51:27,457: 10:51:27 | 30 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 1.81s]
2018-02-08 10:51:27,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113645fd0>]}
2018-02-08 10:51:27,739: 10:51:27 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 1.49s]
2018-02-08 10:51:28,049: 10:51:28 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 1.83s]
2018-02-08 10:51:28,050: 10:51:28 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 10:51:28,051: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:51:28,065: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 10:51:28,067: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 10:51:28,068: Re-using an available connection from the pool.
2018-02-08 10:51:29,009: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:51:30,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113543a58>]}
2018-02-08 10:51:30,784: 10:51:30 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 2.42s]
2018-02-08 10:51:30,785: 10:51:30 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:51:30,785: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:51:30,793: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:51:30,794: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:51:30,794: Re-using an available connection from the pool.
2018-02-08 10:51:31,228: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:51:32,019: Bad request while running:
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:51:32,020: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: flag_form_submit at [29:14]
2018-02-08 10:51:32,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136262b0>]}
2018-02-08 10:51:32,319: 10:51:32 | 34 of 37 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 1.24s]
2018-02-08 10:51:32,320: 10:51:32 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:51:32,320: Compiling model.seo_audit.agg_stats
2018-02-08 10:51:32,335: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:51:32,336: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:51:32,336: Re-using an available connection from the pool.
2018-02-08 10:51:33,265: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:51:34,267: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113543a58>]}
2018-02-08 10:51:34,592: 10:51:34 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 1.95s]
2018-02-08 10:51:34,593: 10:51:34 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:51:34,593: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:51:34,602: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:51:34,603: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:51:34,604: Re-using an available connection from the pool.
2018-02-08 10:51:35,570: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:51:36,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113660320>]}
2018-02-08 10:51:36,898: 10:51:36 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 2.06s]
2018-02-08 10:51:36,899: 10:51:36 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:51:36,900: Compiling model.seo_audit.agg_all
2018-02-08 10:51:36,910: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:51:36,911: Acquiring new bigquery connection "agg_all".
2018-02-08 10:51:36,911: Re-using an available connection from the pool.
2018-02-08 10:51:38,536: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:51:39,718: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8aa87506-d6bb-4c90-8f9b-dc5313080cbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113543a58>]}
2018-02-08 10:51:39,956: 10:51:39 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 2.82s]
2018-02-08 10:51:40,007: 10:51:40 | 
2018-02-08 10:51:40,008: 10:51:40 | Finished running 37 view models in 27.82s.
2018-02-08 10:51:40,008: Connection 'master' was left open.
2018-02-08 10:51:40,008: 
2018-02-08 10:51:40,008: Completed with 1 errors:
2018-02-08 10:51:40,009: 
2018-02-08 10:51:40,009: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 10:51:40,009:   Unrecognized name: flag_form_submit at [29:14]
2018-02-08 10:51:40,009:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 10:51:40,009: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 10:51:40,010: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113579358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113471278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113645470>]}
2018-02-08 10:51:40,265: Flushing usage events
2018-02-08 10:53:19,616: Tracking: tracking
2018-02-08 10:53:19,619: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c2eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c2dd8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c2fd0>]}
2018-02-08 10:53:20,353: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:53:20,373: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:53:20,381: Parsing core.sql
2018-02-08 10:53:20,412: Parsing adapters/bigquery.sql
2018-02-08 10:53:20,424: Parsing adapters/common.sql
2018-02-08 10:53:20,441: Parsing adapters/postgres.sql
2018-02-08 10:53:20,447: Parsing adapters/redshift.sql
2018-02-08 10:53:20,468: Parsing etc/get_custom_schema.sql
2018-02-08 10:53:20,476: Parsing materializations/archive.sql
2018-02-08 10:53:20,512: Parsing materializations/bigquery.sql
2018-02-08 10:53:20,529: Parsing materializations/helpers.sql
2018-02-08 10:53:20,547: Parsing materializations/incremental.sql
2018-02-08 10:53:20,575: Parsing materializations/table.sql
2018-02-08 10:53:20,597: Parsing materializations/view.sql
2018-02-08 10:53:20,619: Parsing materializations/wrapper.sql
2018-02-08 10:53:20,628: Parsing schema_tests/accepted_values.sql
2018-02-08 10:53:20,639: Parsing schema_tests/not_null.sql
2018-02-08 10:53:20,644: Parsing schema_tests/relationships.sql
2018-02-08 10:53:20,652: Parsing schema_tests/unique.sql
2018-02-08 10:53:20,735: Parsing model.seo_audit.accounts_proc
2018-02-08 10:53:20,741: Parsing model.seo_audit.all_dates
2018-02-08 10:53:20,743: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:53:20,747: Acquiring new bigquery connection "master".
2018-02-08 10:53:20,747: Opening a new connection (0 currently allocated)
2018-02-08 10:53:20,754: Parsing model.seo_audit.agg_all
2018-02-08 10:53:20,757: Parsing model.seo_audit.agg_indicative
2018-02-08 10:53:20,759: Parsing model.seo_audit.agg_stats
2018-02-08 10:53:20,764: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:53:20,767: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:53:20,770: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:53:20,773: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:53:20,774: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:53:20,776: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:53:20,778: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:53:20,780: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:53:20,782: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:53:20,785: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:53:20,790: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:53:20,792: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:53:20,794: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:53:20,796: Parsing model.seo_audit.ga_proc
2018-02-08 10:53:20,798: Parsing model.seo_audit.ga_stats
2018-02-08 10:53:20,800: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:53:20,802: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:53:20,805: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:53:20,807: Parsing model.seo_audit.moz_proc
2018-02-08 10:53:20,810: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:53:20,813: Parsing model.seo_audit.search_console_history
2018-02-08 10:53:20,815: Parsing model.seo_audit.search_console_proc
2018-02-08 10:53:20,818: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:53:20,820: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:53:20,822: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:53:20,825: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:53:20,828: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:53:20,831: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:53:20,833: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:53:20,835: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:53:20,839: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:53:20,856: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:53:20,868: 
2018-02-08 10:53:22,535: 10:53:22 | Concurrency: 4 threads (target='dev')
2018-02-08 10:53:22,536: 10:53:22 | 
2018-02-08 10:53:22,733: 10:53:22 | 1 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:53:22,733: Compiling model.seo_audit.accounts_proc
2018-02-08 10:53:22,733: 10:53:22 | 2 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:53:22,740: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:53:22,740: Compiling model.seo_audit.all_dates
2018-02-08 10:53:22,733: 10:53:22 | 3 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:53:22,745: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:53:22,745: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:53:22,746: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:53:22,756: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:53:22,757: Acquiring new bigquery connection "all_dates".
2018-02-08 10:53:22,757: Opening a new connection (1 currently allocated)
2018-02-08 10:53:22,763: Opening a new connection (2 currently allocated)
2018-02-08 10:53:22,764: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:53:22,908: Opening a new connection (3 currently allocated)
2018-02-08 10:53:23,398: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:53:23,407: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:53:23,413: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:53:23,605: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4a90>]}
2018-02-08 10:53:23,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5f28>]}
2018-02-08 10:53:23,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e35c0>]}
2018-02-08 10:53:23,843: 10:53:23 | 2 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.87s]
2018-02-08 10:53:24,067: 10:53:24 | 1 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.90s]
2018-02-08 10:53:24,368: 10:53:24 | 3 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.92s]
2018-02-08 10:53:24,369: 10:53:24 | 4 of 37 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:53:24,369: 10:53:24 | 5 of 37 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 10:53:24,370: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:53:24,369: 10:53:24 | 6 of 37 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:53:24,370: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:53:24,369: 10:53:24 | 7 of 37 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 10:53:24,377: Compiling model.seo_audit.moz_proc
2018-02-08 10:53:24,383: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:53:24,391: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:53:24,391: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:53:24,396: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:53:24,406: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:53:24,407: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:53:24,408: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:53:24,408: Re-using an available connection from the pool.
2018-02-08 10:53:24,409: Re-using an available connection from the pool.
2018-02-08 10:53:24,412: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:53:24,413: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:53:24,415: Re-using an available connection from the pool.
2018-02-08 10:53:24,420: Opening a new connection (4 currently allocated)
2018-02-08 10:53:24,640: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:53:24,652: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_article,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:53:24,708: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:53:24,963: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4a90>]}
2018-02-08 10:53:24,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a68cf8>]}
2018-02-08 10:53:24,994: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:53:25,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5828>]}
2018-02-08 10:53:25,181: 10:53:25 | 5 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.59s]
2018-02-08 10:53:25,183: 10:53:25 | 8 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:53:25,185: Compiling model.seo_audit.ga_proc
2018-02-08 10:53:25,197: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:53:25,199: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:53:25,199: Re-using an available connection from the pool.
2018-02-08 10:53:25,247: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4828>]}
2018-02-08 10:53:25,389: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:53:25,426: 10:53:25 | 6 of 37 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.60s]
2018-02-08 10:53:25,427: 10:53:25 | 9 of 37 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 10:53:25,428: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:53:25,436: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:53:25,440: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:53:25,440: Re-using an available connection from the pool.
2018-02-08 10:53:25,650: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4a90>]}
2018-02-08 10:53:25,654: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:53:25,655: 10:53:25 | 4 of 37 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 0.66s]
2018-02-08 10:53:25,656: 10:53:25 | 10 of 37 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 10:53:25,656: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:53:25,665: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:53:25,669: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:53:25,669: Re-using an available connection from the pool.
2018-02-08 10:53:25,893: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:53:25,927: 10:53:25 | 7 of 37 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.86s]
2018-02-08 10:53:25,928: 10:53:25 | 11 of 37 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 10:53:25,928: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:53:25,940: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:53:25,943: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:53:25,943: Re-using an available connection from the pool.
2018-02-08 10:53:25,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059aca20>]}
2018-02-08 10:53:26,144: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:53:26,153: 10:53:26 | 8 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.46s]
2018-02-08 10:53:26,153: 10:53:26 | 12 of 37 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 10:53:26,154: Compiling model.seo_audit.search_console_proc
2018-02-08 10:53:26,159: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:53:26,163: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:53:26,163: Re-using an available connection from the pool.
2018-02-08 10:53:26,187: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105979978>]}
2018-02-08 10:53:26,383: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:53:26,385: 10:53:26 | 9 of 37 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.53s]
2018-02-08 10:53:26,387: 10:53:26 | 13 of 37 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:53:26,389: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:53:26,395: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:53:26,396: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:53:26,396: Re-using an available connection from the pool.
2018-02-08 10:53:26,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4828>]}
2018-02-08 10:53:26,602: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:53:26,612: 10:53:26 | 10 of 37 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.53s]
2018-02-08 10:53:26,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ac9e8>]}
2018-02-08 10:53:26,852: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059aca20>]}
2018-02-08 10:53:26,909: 10:53:26 | 11 of 37 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.59s]
2018-02-08 10:53:27,162: 10:53:27 | 12 of 37 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.51s]
2018-02-08 10:53:27,469: 10:53:27 | 13 of 37 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.46s]
2018-02-08 10:53:27,470: 10:53:27 | 14 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:53:27,470: 10:53:27 | 15 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:53:27,471: 10:53:27 | 16 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:53:27,471: 10:53:27 | 17 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:53:27,471: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:53:27,472: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:53:27,472: Compiling model.seo_audit.ga_stats
2018-02-08 10:53:27,472: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:53:27,483: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:53:27,488: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:53:27,493: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:53:27,498: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:53:27,499: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:53:27,499: Re-using an available connection from the pool.
2018-02-08 10:53:27,502: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:53:27,502: Re-using an available connection from the pool.
2018-02-08 10:53:27,504: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:53:27,505: Re-using an available connection from the pool.
2018-02-08 10:53:27,507: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:53:27,507: Re-using an available connection from the pool.
2018-02-08 10:53:27,726: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:53:27,735: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:53:27,741: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:53:27,774: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:53:28,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5e80>]}
2018-02-08 10:53:28,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e35c0>]}
2018-02-08 10:53:28,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a68f98>]}
2018-02-08 10:53:28,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d80f0>]}
2018-02-08 10:53:28,282: 10:53:28 | 17 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.57s]
2018-02-08 10:53:28,283: 10:53:28 | 18 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:53:28,284: Compiling model.seo_audit.search_console_history
2018-02-08 10:53:28,293: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:53:28,296: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:53:28,297: Re-using an available connection from the pool.
2018-02-08 10:53:28,486: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:53:28,519: 10:53:28 | 16 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.58s]
2018-02-08 10:53:28,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5e80>]}
2018-02-08 10:53:28,809: 10:53:28 | 15 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.61s]
2018-02-08 10:53:29,031: 10:53:29 | 14 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.70s]
2018-02-08 10:53:29,263: 10:53:29 | 18 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.47s]
2018-02-08 10:53:29,264: 10:53:29 | 19 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:53:29,265: 10:53:29 | 20 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:53:29,265: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:53:29,265: 10:53:29 | 21 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:53:29,265: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:53:29,272: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:53:29,273: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:53:29,286: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:53:29,295: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:53:29,296: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:53:29,296: Re-using an available connection from the pool.
2018-02-08 10:53:29,297: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:53:29,297: Re-using an available connection from the pool.
2018-02-08 10:53:29,301: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:53:29,301: Re-using an available connection from the pool.
2018-02-08 10:53:29,496: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:53:29,511: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:53:29,517: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_article,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:53:29,808: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a82668>]}
2018-02-08 10:53:29,815: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059d4828>]}
2018-02-08 10:53:29,941: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105979978>]}
2018-02-08 10:53:30,067: 10:53:30 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.54s]
2018-02-08 10:53:30,306: 10:53:30 | 19 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.55s]
2018-02-08 10:53:30,598: 10:53:30 | 21 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.67s]
2018-02-08 10:53:30,599: 10:53:30 | 22 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:53:30,600: 10:53:30 | 23 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:53:30,600: 10:53:30 | 24 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:53:30,600: 10:53:30 | 25 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:53:30,601: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:53:30,601: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:53:30,601: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:53:30,601: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:53:30,614: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:53:30,619: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:53:30,619: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:53:30,624: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:53:30,625: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:53:30,627: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:53:30,627: Re-using an available connection from the pool.
2018-02-08 10:53:30,627: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:53:30,629: Re-using an available connection from the pool.
2018-02-08 10:53:30,630: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:53:30,632: Re-using an available connection from the pool.
2018-02-08 10:53:30,634: Re-using an available connection from the pool.
2018-02-08 10:53:30,830: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:53:30,833: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:53:30,837: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:53:30,857: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:53:31,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105aad390>]}
2018-02-08 10:53:31,206: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5e80>]}
2018-02-08 10:53:31,222: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a8c320>]}
2018-02-08 10:53:31,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a91d68>]}
2018-02-08 10:53:31,388: 10:53:31 | 24 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.57s]
2018-02-08 10:53:31,621: 10:53:31 | 22 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.61s]
2018-02-08 10:53:31,860: 10:53:31 | 23 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.62s]
2018-02-08 10:53:32,187: 10:53:32 | 25 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.66s]
2018-02-08 10:53:32,187: 10:53:32 | 26 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:53:32,188: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:53:32,188: 10:53:32 | 27 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:53:32,188: 10:53:32 | 28 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:53:32,197: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:53:32,198: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:53:32,188: 10:53:32 | 29 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:53:32,198: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:53:32,205: Compiling model.seo_audit.agg_indicative
2018-02-08 10:53:32,207: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:53:32,231: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:53:32,231: Re-using an available connection from the pool.
2018-02-08 10:53:32,216: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:53:32,241: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:53:32,218: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:53:32,249: Re-using an available connection from the pool.
2018-02-08 10:53:32,248: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:53:32,251: Re-using an available connection from the pool.
2018-02-08 10:53:32,246: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:53:32,260: Re-using an available connection from the pool.
2018-02-08 10:53:32,433: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:53:32,461: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:53:32,471: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:53:32,485: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:53:32,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a91f60>]}
2018-02-08 10:53:32,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e3d30>]}
2018-02-08 10:53:32,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a9a8d0>]}
2018-02-08 10:53:32,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105979978>]}
2018-02-08 10:53:33,261: 10:53:33 | 27 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.76s]
2018-02-08 10:53:33,262: 10:53:33 | 30 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:53:33,265: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:53:33,277: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:53:33,279: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:53:33,279: Re-using an available connection from the pool.
2018-02-08 10:53:33,465: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:53:33,499: 10:53:33 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.77s]
2018-02-08 10:53:33,503: 10:53:33 | 31 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:53:33,504: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:53:33,512: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:53:33,514: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:53:33,514: Re-using an available connection from the pool.
2018-02-08 10:53:33,740: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:53:33,837: 10:53:33 | 29 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.76s]
2018-02-08 10:53:33,839: 10:53:33 | 32 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:53:33,841: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:53:33,852: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:53:33,853: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:53:33,853: Re-using an available connection from the pool.
2018-02-08 10:53:33,963: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a60128>]}
2018-02-08 10:53:34,060: 10:53:34 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.79s]
2018-02-08 10:53:34,066: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:53:34,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059ac9e8>]}
2018-02-08 10:53:34,276: 10:53:34 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.70s]
2018-02-08 10:53:34,486: 10:53:34 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.74s]
2018-02-08 10:53:34,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5f28>]}
2018-02-08 10:53:34,744: 10:53:34 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.68s]
2018-02-08 10:53:34,744: 10:53:34 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 10:53:34,745: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:53:34,754: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 10:53:34,755: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 10:53:34,755: Re-using an available connection from the pool.
2018-02-08 10:53:34,956: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:53:35,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105992f28>]}
2018-02-08 10:53:36,313: 10:53:36 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 1.20s]
2018-02-08 10:53:36,314: 10:53:36 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:53:36,314: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:53:36,324: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:53:36,325: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:53:36,325: Re-using an available connection from the pool.
2018-02-08 10:53:36,406: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_article,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:53:37,635: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5f28>]}
2018-02-08 10:53:37,877: 10:53:37 | 34 of 37 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.32s]
2018-02-08 10:53:37,878: 10:53:37 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:53:37,878: Compiling model.seo_audit.agg_stats
2018-02-08 10:53:37,891: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:53:37,892: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:53:37,892: Re-using an available connection from the pool.
2018-02-08 10:53:38,081: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:53:38,682: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105992f28>]}
2018-02-08 10:53:38,917: 10:53:38 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.80s]
2018-02-08 10:53:38,917: 10:53:38 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:53:38,917: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:53:38,923: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:53:38,926: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:53:38,926: Re-using an available connection from the pool.
2018-02-08 10:53:39,115: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:53:39,709: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059e5f28>]}
2018-02-08 10:53:40,017: 10:53:40 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.79s]
2018-02-08 10:53:40,018: 10:53:40 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:53:40,018: Compiling model.seo_audit.agg_all
2018-02-08 10:53:40,029: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:53:40,030: Acquiring new bigquery connection "agg_all".
2018-02-08 10:53:40,030: Re-using an available connection from the pool.
2018-02-08 10:53:40,229: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:53:41,089: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cdb702bc-69b2-4973-b4e5-97f5176ba586', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105992f28>]}
2018-02-08 10:53:41,610: 10:53:41 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.07s]
2018-02-08 10:53:41,676: 10:53:41 | 
2018-02-08 10:53:41,677: 10:53:41 | Finished running 37 view models in 19.14s.
2018-02-08 10:53:41,677: Connection 'master' was left open.
2018-02-08 10:53:41,677: 
2018-02-08 10:53:41,678: Completed successfully
2018-02-08 10:53:41,678: 
Done. PASS=37 ERROR=0 SKIP=0 TOTAL=37
2018-02-08 10:53:41,678: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059794e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059795c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c2eb8>]}
2018-02-08 10:53:42,087: Flushing usage events
2018-02-08 10:58:38,114: Tracking: tracking
2018-02-08 10:58:38,118: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107485278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107485e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107489fd0>]}
2018-02-08 10:58:38,885: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 10:58:38,907: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 10:58:38,915: Parsing core.sql
2018-02-08 10:58:38,940: Parsing adapters/bigquery.sql
2018-02-08 10:58:38,950: Parsing adapters/common.sql
2018-02-08 10:58:38,972: Parsing adapters/postgres.sql
2018-02-08 10:58:38,977: Parsing adapters/redshift.sql
2018-02-08 10:58:38,998: Parsing etc/get_custom_schema.sql
2018-02-08 10:58:39,010: Parsing materializations/archive.sql
2018-02-08 10:58:39,044: Parsing materializations/bigquery.sql
2018-02-08 10:58:39,060: Parsing materializations/helpers.sql
2018-02-08 10:58:39,079: Parsing materializations/incremental.sql
2018-02-08 10:58:39,107: Parsing materializations/table.sql
2018-02-08 10:58:39,128: Parsing materializations/view.sql
2018-02-08 10:58:39,145: Parsing materializations/wrapper.sql
2018-02-08 10:58:39,151: Parsing schema_tests/accepted_values.sql
2018-02-08 10:58:39,157: Parsing schema_tests/not_null.sql
2018-02-08 10:58:39,161: Parsing schema_tests/relationships.sql
2018-02-08 10:58:39,167: Parsing schema_tests/unique.sql
2018-02-08 10:58:39,239: Parsing model.seo_audit.accounts_proc
2018-02-08 10:58:39,243: Parsing model.seo_audit.all_dates
2018-02-08 10:58:39,245: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 10:58:39,248: Acquiring new bigquery connection "master".
2018-02-08 10:58:39,248: Opening a new connection (0 currently allocated)
2018-02-08 10:58:39,254: Parsing model.seo_audit.agg_all
2018-02-08 10:58:39,258: Parsing model.seo_audit.agg_indicative
2018-02-08 10:58:39,260: Parsing model.seo_audit.agg_stats
2018-02-08 10:58:39,265: Parsing model.seo_audit.agg_stats_client
2018-02-08 10:58:39,268: Parsing model.seo_audit.deepcrawl_class
2018-02-08 10:58:39,271: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 10:58:39,274: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:58:39,275: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:58:39,277: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:58:39,278: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:58:39,281: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 10:58:39,283: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 10:58:39,285: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:58:39,290: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:58:39,292: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:58:39,294: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:58:39,296: Parsing model.seo_audit.ga_proc
2018-02-08 10:58:39,298: Parsing model.seo_audit.ga_stats
2018-02-08 10:58:39,300: Parsing model.seo_audit.majestic_domain_history
2018-02-08 10:58:39,302: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 10:58:39,305: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 10:58:39,307: Parsing model.seo_audit.moz_proc
2018-02-08 10:58:39,309: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 10:58:39,312: Parsing model.seo_audit.search_console_history
2018-02-08 10:58:39,314: Parsing model.seo_audit.search_console_proc
2018-02-08 10:58:39,316: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 10:58:39,319: Parsing model.seo_audit.search_console_stats_url
2018-02-08 10:58:39,320: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 10:58:39,323: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 10:58:39,326: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 10:58:39,329: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 10:58:39,331: Parsing model.seo_audit.semrush_url_history
2018-02-08 10:58:39,333: Parsing model.seo_audit.semrush_url_stats
2018-02-08 10:58:39,335: Parsing model.seo_audit.sitemap_proc
2018-02-08 10:58:39,353: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 10:58:39,373: 
2018-02-08 10:58:40,582: 10:58:40 | Concurrency: 4 threads (target='dev')
2018-02-08 10:58:40,582: 10:58:40 | 
2018-02-08 10:58:40,787: 10:58:40 | 1 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 10:58:40,788: Compiling model.seo_audit.all_dates
2018-02-08 10:58:40,787: 10:58:40 | 2 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 10:58:40,792: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 10:58:40,788: 10:58:40 | 3 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 10:58:40,792: Compiling model.seo_audit.accounts_proc
2018-02-08 10:58:40,792: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 10:58:40,798: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 10:58:40,805: Acquiring new bigquery connection "all_dates".
2018-02-08 10:58:40,806: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 10:58:40,807: Opening a new connection (1 currently allocated)
2018-02-08 10:58:40,809: Acquiring new bigquery connection "accounts_proc".
2018-02-08 10:58:40,813: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 10:58:40,813: Opening a new connection (2 currently allocated)
2018-02-08 10:58:40,879: Opening a new connection (3 currently allocated)
2018-02-08 10:58:41,544: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 10:58:41,545: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 10:58:41,547: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 10:58:41,729: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632b70>]}
2018-02-08 10:58:41,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632630>]}
2018-02-08 10:58:41,852: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076326d8>]}
2018-02-08 10:58:41,994: 10:58:41 | 1 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.94s]
2018-02-08 10:58:42,267: 10:58:42 | 3 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.03s]
2018-02-08 10:58:42,592: 10:58:42 | 2 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 1.06s]
2018-02-08 10:58:42,593: 10:58:42 | 4 of 37 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 10:58:42,594: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 10:58:42,593: 10:58:42 | 5 of 37 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 10:58:42,600: Compiling model.seo_audit.search_console_proc
2018-02-08 10:58:42,609: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 10:58:42,610: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 10:58:42,594: 10:58:42 | 6 of 37 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 10:58:42,610: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 10:58:42,615: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 10:58:42,594: 10:58:42 | 7 of 37 START view model seo_audit_dev.sitemap_proc.................. [RUN]
2018-02-08 10:58:42,616: Compiling model.seo_audit.sitemap_proc
2018-02-08 10:58:42,616: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 10:58:42,623: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 10:58:42,624: Acquiring new bigquery connection "search_console_proc".
2018-02-08 10:58:42,624: Re-using an available connection from the pool.
2018-02-08 10:58:42,624: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 10:58:42,625: Re-using an available connection from the pool.
2018-02-08 10:58:42,626: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 10:58:42,629: Re-using an available connection from the pool.
2018-02-08 10:58:42,639: Opening a new connection (4 currently allocated)
2018-02-08 10:58:42,847: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:58:42,880: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 10:58:42,882: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:58:43,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632630>]}
2018-02-08 10:58:43,175: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 10:58:43,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632b70>]}
2018-02-08 10:58:43,194: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632828>]}
2018-02-08 10:58:43,412: 10:58:43 | 6 of 37 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.55s]
2018-02-08 10:58:43,414: 10:58:43 | 8 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 10:58:43,416: Compiling model.seo_audit.ga_proc
2018-02-08 10:58:43,430: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 10:58:43,432: Acquiring new bigquery connection "ga_proc".
2018-02-08 10:58:43,432: Re-using an available connection from the pool.
2018-02-08 10:58:43,647: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 10:58:43,707: 10:58:43 | 5 of 37 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.59s]
2018-02-08 10:58:43,708: 10:58:43 | 9 of 37 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 10:58:43,709: Compiling model.seo_audit.moz_proc
2018-02-08 10:58:43,722: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 10:58:43,726: Acquiring new bigquery connection "moz_proc".
2018-02-08 10:58:43,726: Re-using an available connection from the pool.
2018-02-08 10:58:43,941: 10:58:43 | 4 of 37 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.60s]
2018-02-08 10:58:43,941: 10:58:43 | 10 of 37 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 10:58:43,941: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 10:58:43,948: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 10:58:43,950: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 10:58:43,953: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 10:58:43,954: Re-using an available connection from the pool.
2018-02-08 10:58:44,235: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 10:58:44,326: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632b70>]}
2018-02-08 10:58:44,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c5390>]}
2018-02-08 10:58:44,631: 10:58:44 | 9 of 37 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.62s]
2018-02-08 10:58:44,633: 10:58:44 | 11 of 37 START view model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 10:58:44,634: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 10:58:44,642: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 10:58:44,644: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 10:58:44,645: Re-using an available connection from the pool.
2018-02-08 10:58:44,866: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 10:58:44,870: 10:58:44 | 10 of 37 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.65s]
2018-02-08 10:58:44,871: 10:58:44 | 12 of 37 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 10:58:44,872: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 10:58:44,878: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 10:58:44,879: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 10:58:44,879: Re-using an available connection from the pool.
2018-02-08 10:58:45,103: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 10:58:45,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10756eef0>]}
2018-02-08 10:58:45,407: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c5390>]}
2018-02-08 10:58:45,476: 10:58:45 | 11 of 37 OK created view model seo_audit_dev.majestic_domain_proc.... [CREATE VIEW in 0.54s]
2018-02-08 10:58:45,477: 10:58:45 | 13 of 37 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 10:58:45,479: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 10:58:45,492: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 10:58:45,495: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 10:58:45,496: Re-using an available connection from the pool.
2018-02-08 10:58:45,606: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c56a0>]}
2018-02-08 10:58:45,704: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 10:58:45,705: 10:58:45 | 12 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.54s]
2018-02-08 10:58:45,920: 10:58:45 | 8 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 2.19s]
2018-02-08 10:58:46,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10756eef0>]}
2018-02-08 10:58:46,299: 10:58:46 | 13 of 37 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.56s]
2018-02-08 10:58:52,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558a20>]}
2018-02-08 10:58:52,824: 10:58:52 | 7 of 37 OK created view model seo_audit_dev.sitemap_proc............. [CREATE VIEW in 9.93s]
2018-02-08 10:58:52,824: 10:58:52 | 14 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 10:58:52,825: 10:58:52 | 15 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 10:58:52,825: 10:58:52 | 16 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 10:58:52,825: 10:58:52 | 17 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 10:58:52,825: Compiling model.seo_audit.search_console_history
2018-02-08 10:58:52,825: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 10:58:52,825: Compiling model.seo_audit.semrush_url_history
2018-02-08 10:58:52,825: Compiling model.seo_audit.majestic_domain_history
2018-02-08 10:58:52,830: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 10:58:52,838: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 10:58:52,844: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 10:58:52,849: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 10:58:52,850: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 10:58:52,850: Re-using an available connection from the pool.
2018-02-08 10:58:52,851: Acquiring new bigquery connection "search_console_history".
2018-02-08 10:58:52,852: Re-using an available connection from the pool.
2018-02-08 10:58:52,853: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 10:58:52,853: Re-using an available connection from the pool.
2018-02-08 10:58:52,856: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 10:58:52,856: Re-using an available connection from the pool.
2018-02-08 10:58:53,070: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 10:58:53,077: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 10:58:53,081: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 10:58:53,113: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 10:58:53,470: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107672f98>]}
2018-02-08 10:58:53,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10767c668>]}
2018-02-08 10:58:53,476: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107665f98>]}
2018-02-08 10:58:53,479: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c37b8>]}
2018-02-08 10:58:53,982: 10:58:53 | 17 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.64s]
2018-02-08 10:58:53,982: 10:58:53 | 18 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 10:58:53,983: Compiling model.seo_audit.ga_stats
2018-02-08 10:58:53,992: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 10:58:53,995: Acquiring new bigquery connection "ga_stats".
2018-02-08 10:58:53,996: Re-using an available connection from the pool.
2018-02-08 10:58:54,208: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 10:58:54,294: 10:58:54 | 16 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.65s]
2018-02-08 10:58:54,506: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10766cf98>]}
2018-02-08 10:58:54,534: 10:58:54 | 15 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.65s]
2018-02-08 10:58:54,770: 10:58:54 | 14 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.65s]
2018-02-08 10:58:55,094: 10:58:55 | 18 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.52s]
2018-02-08 10:58:55,095: 10:58:55 | 19 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 10:58:55,096: Compiling model.seo_audit.deepcrawl_class
2018-02-08 10:58:55,104: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 10:58:55,095: 10:58:55 | 20 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 10:58:55,096: 10:58:55 | 21 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 10:58:55,105: Compiling model.seo_audit.search_console_stats_url
2018-02-08 10:58:55,105: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 10:58:55,105: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 10:58:55,119: Re-using an available connection from the pool.
2018-02-08 10:58:55,111: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 10:58:55,119: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 10:58:55,122: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 10:58:55,125: Re-using an available connection from the pool.
2018-02-08 10:58:55,138: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 10:58:55,138: Re-using an available connection from the pool.
2018-02-08 10:58:55,323: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 10:58:55,352: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 10:58:55,369: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 10:58:55,647: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558a20>]}
2018-02-08 10:58:55,651: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076650b8>]}
2018-02-08 10:58:55,701: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c37b8>]}
2018-02-08 10:58:55,943: 10:58:55 | 19 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.55s]
2018-02-08 10:58:56,274: 10:58:56 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.55s]
2018-02-08 10:58:56,485: 10:58:56 | 21 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.60s]
2018-02-08 10:58:56,485: 10:58:56 | 22 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 10:58:56,486: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 10:58:56,493: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 10:58:56,485: 10:58:56 | 23 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 10:58:56,493: Compiling model.seo_audit.semrush_url_stats
2018-02-08 10:58:56,486: 10:58:56 | 24 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 10:58:56,486: 10:58:56 | 25 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 10:58:56,500: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 10:58:56,500: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 10:58:56,500: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 10:58:56,501: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 10:58:56,513: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 10:58:56,518: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 10:58:56,524: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 10:58:56,524: Re-using an available connection from the pool.
2018-02-08 10:58:56,525: Re-using an available connection from the pool.
2018-02-08 10:58:56,527: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 10:58:56,532: Re-using an available connection from the pool.
2018-02-08 10:58:56,528: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 10:58:56,535: Re-using an available connection from the pool.
2018-02-08 10:58:56,721: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:58:56,774: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 10:58:56,784: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 10:58:56,785: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 10:58:57,048: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558a20>]}
2018-02-08 10:58:57,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10765b828>]}
2018-02-08 10:58:57,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b4da0>]}
2018-02-08 10:58:57,358: 10:58:57 | 23 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.55s]
2018-02-08 10:58:57,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b4198>]}
2018-02-08 10:58:57,664: 10:58:57 | 22 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.60s]
2018-02-08 10:58:57,877: 10:58:57 | 25 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.65s]
2018-02-08 10:58:58,090: 10:58:58 | 24 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.89s]
2018-02-08 10:58:58,091: 10:58:58 | 26 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 10:58:58,092: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 10:58:58,102: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 10:58:58,092: 10:58:58 | 27 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 10:58:58,103: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 10:58:58,092: 10:58:58 | 28 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 10:58:58,092: 10:58:58 | 29 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 10:58:58,111: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 10:58:58,115: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 10:58:58,117: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 10:58:58,139: Re-using an available connection from the pool.
2018-02-08 10:58:58,117: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 10:58:58,147: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 10:58:58,139: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 10:58:58,158: Re-using an available connection from the pool.
2018-02-08 10:58:58,178: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 10:58:58,181: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 10:58:58,181: Re-using an available connection from the pool.
2018-02-08 10:58:58,189: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 10:58:58,189: Re-using an available connection from the pool.
2018-02-08 10:58:58,354: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:58:58,401: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 10:58:58,417: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:58:58,423: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 10:58:58,849: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558a20>]}
2018-02-08 10:58:58,907: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107632b70>]}
2018-02-08 10:58:58,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076328d0>]}
2018-02-08 10:58:59,159: 10:58:59 | 27 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.75s]
2018-02-08 10:58:59,159: 10:58:59 | 30 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 10:58:59,160: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 10:58:59,168: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 10:58:59,170: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 10:58:59,171: Re-using an available connection from the pool.
2018-02-08 10:58:59,392: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 10:58:59,468: 10:58:59 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.80s]
2018-02-08 10:58:59,469: 10:58:59 | 31 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 10:58:59,470: Compiling model.seo_audit.agg_indicative
2018-02-08 10:58:59,476: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 10:58:59,478: Acquiring new bigquery connection "agg_indicative".
2018-02-08 10:58:59,479: Re-using an available connection from the pool.
2018-02-08 10:58:59,666: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 10:58:59,774: 10:58:59 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.82s]
2018-02-08 10:58:59,775: 10:58:59 | 32 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 10:58:59,775: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 10:58:59,784: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 10:58:59,785: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 10:58:59,786: Re-using an available connection from the pool.
2018-02-08 10:59:00,005: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 10:59:00,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076328d0>]}
2018-02-08 10:59:00,751: 10:59:00 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.76s]
2018-02-08 10:59:01,348: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558a20>]}
2018-02-08 10:59:01,644: 10:59:01 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 2.19s]
2018-02-08 10:59:02,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10765b748>]}
2018-02-08 10:59:02,690: 10:59:02 | 31 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 3.01s]
2018-02-08 10:59:08,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c37b8>]}
2018-02-08 10:59:09,085: 10:59:09 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 10.73s]
2018-02-08 10:59:09,086: 10:59:09 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 10:59:09,086: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 10:59:09,100: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 10:59:09,102: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 10:59:09,102: Re-using an available connection from the pool.
2018-02-08 10:59:09,293: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_classification,
e.pct_of_value query_string_pct_of_value,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_classification,
f.pct_of_value filename_pct_of_value,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_classification,
g.pct_of_value first_path_pct_of_value,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path )
2018-02-08 10:59:10,468: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107665080>]}
2018-02-08 10:59:10,687: 10:59:10 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 1.38s]
2018-02-08 10:59:10,688: 10:59:10 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 10:59:10,688: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 10:59:10,694: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 10:59:10,695: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 10:59:10,695: Re-using an available connection from the pool.
2018-02-08 10:59:10,897: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_classification,
query_string_pct_of_value,
filename_rule,
filename_pct_of_classification,
filename_pct_of_value,
first_path_rule,
first_path_pct_of_classification,
first_path_pct_of_value,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null and class_schema != original_class then class_schema
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 10:59:12,167: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c37b8>]}
2018-02-08 10:59:12,400: 10:59:12 | 34 of 37 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.48s]
2018-02-08 10:59:12,401: 10:59:12 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 10:59:12,401: Compiling model.seo_audit.agg_stats
2018-02-08 10:59:12,416: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 10:59:12,418: Acquiring new bigquery connection "agg_stats".
2018-02-08 10:59:12,418: Re-using an available connection from the pool.
2018-02-08 10:59:12,630: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 10:59:15,022: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107665080>]}
2018-02-08 10:59:15,326: 10:59:15 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 2.62s]
2018-02-08 10:59:15,327: 10:59:15 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 10:59:15,327: Compiling model.seo_audit.agg_stats_client
2018-02-08 10:59:15,337: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 10:59:15,338: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 10:59:15,338: Re-using an available connection from the pool.
2018-02-08 10:59:15,541: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 10:59:16,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075c37b8>]}
2018-02-08 10:59:16,421: 10:59:16 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.87s]
2018-02-08 10:59:16,422: 10:59:16 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 10:59:16,423: Compiling model.seo_audit.agg_all
2018-02-08 10:59:16,432: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 10:59:16,433: Acquiring new bigquery connection "agg_all".
2018-02-08 10:59:16,434: Re-using an available connection from the pool.
2018-02-08 10:59:16,633: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 10:59:17,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43b8293c-1eca-433a-98f7-75892d433636', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107665080>]}
2018-02-08 10:59:17,550: 10:59:17 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.91s]
2018-02-08 10:59:17,653: 10:59:17 | 
2018-02-08 10:59:17,654: 10:59:17 | Finished running 37 view models in 37.07s.
2018-02-08 10:59:17,654: Connection 'master' was left open.
2018-02-08 10:59:17,654: 
2018-02-08 10:59:17,655: Completed successfully
2018-02-08 10:59:17,655: 
Done. PASS=37 ERROR=0 SKIP=0 TOTAL=37
2018-02-08 10:59:17,656: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107558588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075587f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075586a0>]}
2018-02-08 10:59:17,945: Flushing usage events
2018-02-08 11:40:48,046: Tracking: tracking
2018-02-08 11:40:48,050: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ae04a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ac6ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ac6dd8>]}
2018-02-08 11:40:48,818: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:40:48,835: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:40:48,839: Parsing core.sql
2018-02-08 11:40:48,859: Parsing adapters/bigquery.sql
2018-02-08 11:40:48,867: Parsing adapters/common.sql
2018-02-08 11:40:48,884: Parsing adapters/postgres.sql
2018-02-08 11:40:48,891: Parsing adapters/redshift.sql
2018-02-08 11:40:48,920: Parsing etc/get_custom_schema.sql
2018-02-08 11:40:48,932: Parsing materializations/archive.sql
2018-02-08 11:40:48,965: Parsing materializations/bigquery.sql
2018-02-08 11:40:48,982: Parsing materializations/helpers.sql
2018-02-08 11:40:49,000: Parsing materializations/incremental.sql
2018-02-08 11:40:49,036: Parsing materializations/table.sql
2018-02-08 11:40:49,069: Parsing materializations/view.sql
2018-02-08 11:40:49,088: Parsing materializations/wrapper.sql
2018-02-08 11:40:49,094: Parsing schema_tests/accepted_values.sql
2018-02-08 11:40:49,099: Parsing schema_tests/not_null.sql
2018-02-08 11:40:49,106: Parsing schema_tests/relationships.sql
2018-02-08 11:40:49,111: Parsing schema_tests/unique.sql
2018-02-08 11:40:49,233: Parsing model.seo_audit.accounts_proc
2018-02-08 11:40:49,238: Parsing model.seo_audit.all_dates
2018-02-08 11:40:49,241: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:40:49,244: Acquiring new bigquery connection "master".
2018-02-08 11:40:49,245: Opening a new connection (0 currently allocated)
2018-02-08 11:40:49,250: Parsing model.seo_audit.agg_all
2018-02-08 11:40:49,255: Parsing model.seo_audit.agg_indicative
2018-02-08 11:40:49,257: Parsing model.seo_audit.agg_stats
2018-02-08 11:40:49,262: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:40:49,266: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:40:49,269: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:40:49,278: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:40:49,281: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:40:49,283: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:40:49,285: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:40:49,288: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:40:49,291: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:40:49,293: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:40:49,300: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:40:49,302: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:40:49,304: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:40:49,306: Parsing model.seo_audit.ga_proc
2018-02-08 11:40:49,310: Parsing model.seo_audit.ga_stats
2018-02-08 11:40:49,313: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:40:49,316: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:40:49,319: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:40:49,321: Parsing model.seo_audit.moz_proc
2018-02-08 11:40:49,323: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:40:49,326: Parsing model.seo_audit.search_console_history
2018-02-08 11:40:49,328: Parsing model.seo_audit.search_console_proc
2018-02-08 11:40:49,332: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:40:49,335: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:40:49,337: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:40:49,340: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:40:49,345: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:40:49,349: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:40:49,353: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:40:49,356: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:40:49,359: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:40:49,378: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:40:49,392: 
2018-02-08 11:40:50,616: 11:40:50 | Concurrency: 4 threads (target='dev')
2018-02-08 11:40:50,616: 11:40:50 | 
2018-02-08 11:40:50,866: 11:40:50 | 1 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 11:40:50,866: 11:40:50 | 2 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 11:40:50,866: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:40:50,866: 11:40:50 | 3 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 11:40:50,866: Compiling model.seo_audit.all_dates
2018-02-08 11:40:50,872: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:40:50,872: Compiling model.seo_audit.accounts_proc
2018-02-08 11:40:50,876: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:40:50,883: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:40:50,885: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:40:50,886: Acquiring new bigquery connection "all_dates".
2018-02-08 11:40:50,886: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:40:50,886: Opening a new connection (1 currently allocated)
2018-02-08 11:40:50,888: Opening a new connection (2 currently allocated)
2018-02-08 11:40:50,955: Opening a new connection (3 currently allocated)
2018-02-08 11:40:51,559: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:40:51,592: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:40:51,601: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:40:51,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cc0eb8>]}
2018-02-08 11:40:51,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bc2198>]}
2018-02-08 11:40:51,884: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c88ba8>]}
2018-02-08 11:40:52,139: 11:40:52 | 2 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.94s]
2018-02-08 11:40:52,364: 11:40:52 | 3 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.95s]
2018-02-08 11:40:52,668: 11:40:52 | 1 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 1.02s]
2018-02-08 11:40:52,668: 11:40:52 | 4 of 37 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 11:40:52,669: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:40:52,669: 11:40:52 | 5 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 11:40:52,676: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:40:52,669: 11:40:52 | 6 of 37 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 11:40:52,677: Compiling model.seo_audit.ga_proc
2018-02-08 11:40:52,669: 11:40:52 | 7 of 37 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 11:40:52,677: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:40:52,685: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:40:52,685: Compiling model.seo_audit.search_console_proc
2018-02-08 11:40:52,692: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:40:52,715: Re-using an available connection from the pool.
2018-02-08 11:40:52,718: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:40:52,694: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:40:52,778: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:40:52,784: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:40:52,785: Re-using an available connection from the pool.
2018-02-08 11:40:52,786: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:40:52,786: Re-using an available connection from the pool.
2018-02-08 11:40:52,789: Opening a new connection (4 currently allocated)
2018-02-08 11:40:53,024: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:40:53,111: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:40:53,140: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:40:53,336: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bafac8>]}
2018-02-08 11:40:53,357: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:40:53,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ce59b0>]}
2018-02-08 11:40:53,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8cba8>]}
2018-02-08 11:40:53,643: 11:40:53 | 4 of 37 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.67s]
2018-02-08 11:40:53,646: 11:40:53 | 8 of 37 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 11:40:53,646: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:40:53,655: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:40:53,657: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:40:53,657: Re-using an available connection from the pool.
2018-02-08 11:40:53,698: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8c9e8>]}
2018-02-08 11:40:53,854: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:40:53,943: 11:40:53 | 7 of 37 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.76s]
2018-02-08 11:40:53,945: 11:40:53 | 9 of 37 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 11:40:53,947: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:40:53,960: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:40:53,963: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:40:53,963: Re-using an available connection from the pool.
2018-02-08 11:40:54,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bafac8>]}
2018-02-08 11:40:54,186: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:40:54,367: 11:40:54 | 6 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.79s]
2018-02-08 11:40:54,368: 11:40:54 | 10 of 37 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 11:40:54,370: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:40:54,384: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:40:54,387: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:40:54,388: Re-using an available connection from the pool.
2018-02-08 11:40:54,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c56e10>]}
2018-02-08 11:40:54,591: 11:40:54 | 5 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 1.02s]
2018-02-08 11:40:54,592: 11:40:54 | 11 of 37 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 11:40:54,593: Compiling model.seo_audit.moz_proc
2018-02-08 11:40:54,601: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:40:54,605: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:40:54,605: Re-using an available connection from the pool.
2018-02-08 11:40:54,611: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:40:54,842: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:40:54,887: 11:40:54 | 8 of 37 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.53s]
2018-02-08 11:40:54,888: 11:40:54 | 12 of 37 START view model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 11:40:54,888: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:40:54,899: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:40:54,904: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:40:54,904: Re-using an available connection from the pool.
2018-02-08 11:40:54,955: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:40:55,165: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:40:55,204: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c5d9b0>]}
2018-02-08 11:40:55,204: 11:40:55 | 9 of 37 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.53s]
2018-02-08 11:40:55,206: 11:40:55 | 13 of 37 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 11:40:55,208: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:40:55,221: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:40:55,223: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:40:55,223: Re-using an available connection from the pool.
2018-02-08 11:40:55,422: 11:40:55 | 10 of 37 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.59s]
2018-02-08 11:40:55,487: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:40:55,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bafac8>]}
2018-02-08 11:40:55,634: 11:40:55 | 11 of 37 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.61s]
2018-02-08 11:40:55,822: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c49d30>]}
2018-02-08 11:40:55,954: 11:40:55 | 12 of 37 OK created view model seo_audit_dev.mappings_ga_proc........ [CREATE VIEW in 0.66s]
2018-02-08 11:40:56,163: 11:40:56 | 13 of 37 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.61s]
2018-02-08 11:40:56,164: 11:40:56 | 14 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 11:40:56,165: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:40:56,165: 11:40:56 | 15 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 11:40:56,172: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:40:56,165: 11:40:56 | 16 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 11:40:56,180: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:40:56,181: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:40:56,165: 11:40:56 | 17 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 11:40:56,181: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:40:56,182: Compiling model.seo_audit.search_console_history
2018-02-08 11:40:56,187: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:40:56,187: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:40:56,191: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:40:56,192: Re-using an available connection from the pool.
2018-02-08 11:40:56,194: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:40:56,195: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:40:56,195: Re-using an available connection from the pool.
2018-02-08 11:40:56,198: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:40:56,201: Re-using an available connection from the pool.
2018-02-08 11:40:56,209: Re-using an available connection from the pool.
2018-02-08 11:40:56,406: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:40:56,419: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:40:56,433: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:40:56,446: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:40:56,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8c278>]}
2018-02-08 11:40:56,756: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb92b0>]}
2018-02-08 11:40:56,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c5d630>]}
2018-02-08 11:40:57,041: 11:40:57 | 17 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.53s]
2018-02-08 11:40:57,042: 11:40:57 | 18 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 11:40:57,044: Compiling model.seo_audit.ga_stats
2018-02-08 11:40:57,054: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:40:57,056: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:40:57,057: Re-using an available connection from the pool.
2018-02-08 11:40:57,269: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:40:57,282: 11:40:57 | 14 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.59s]
2018-02-08 11:40:57,496: 11:40:57 | 16 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.59s]
2018-02-08 11:40:57,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8c278>]}
2018-02-08 11:40:57,909: 11:40:57 | 18 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.55s]
2018-02-08 11:40:59,450: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:40:59,747: 11:40:59 | 15 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 3.28s]
2018-02-08 11:40:59,748: 11:40:59 | 19 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 11:40:59,749: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:40:59,748: 11:40:59 | 20 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 11:40:59,759: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:40:59,749: 11:40:59 | 21 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 11:40:59,760: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:40:59,760: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:40:59,765: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:40:59,766: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:40:59,772: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:40:59,772: Re-using an available connection from the pool.
2018-02-08 11:40:59,773: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:40:59,774: Re-using an available connection from the pool.
2018-02-08 11:40:59,775: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:40:59,784: Re-using an available connection from the pool.
2018-02-08 11:41:00,038: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:41:00,063: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:41:00,076: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:41:00,383: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ce5940>]}
2018-02-08 11:41:00,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c49d30>]}
2018-02-08 11:41:00,526: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cbf278>]}
2018-02-08 11:41:00,620: 11:41:00 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.62s]
2018-02-08 11:41:00,828: 11:41:00 | 19 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.67s]
2018-02-08 11:41:01,044: 11:41:01 | 21 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.77s]
2018-02-08 11:41:01,047: 11:41:01 | 22 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 11:41:01,047: 11:41:01 | 23 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:41:01,048: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:41:01,047: 11:41:01 | 24 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 11:41:01,048: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:41:01,047: 11:41:01 | 25 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 11:41:01,060: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:41:01,054: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:41:01,060: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:41:01,072: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:41:01,077: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:41:01,053: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:41:01,079: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:41:01,079: Re-using an available connection from the pool.
2018-02-08 11:41:01,084: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:41:01,085: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:41:01,089: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:41:01,092: Re-using an available connection from the pool.
2018-02-08 11:41:01,093: Re-using an available connection from the pool.
2018-02-08 11:41:01,094: Re-using an available connection from the pool.
2018-02-08 11:41:01,318: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:41:01,326: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:41:01,330: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:41:01,340: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:41:01,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:41:01,737: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cc07b8>]}
2018-02-08 11:41:01,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb95f8>]}
2018-02-08 11:41:01,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c8c5c0>]}
2018-02-08 11:41:01,937: 11:41:01 | 25 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.68s]
2018-02-08 11:41:02,146: 11:41:02 | 22 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.69s]
2018-02-08 11:41:02,453: 11:41:02 | 23 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.72s]
2018-02-08 11:41:02,691: 11:41:02 | 24 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.86s]
2018-02-08 11:41:02,691: 11:41:02 | 26 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 11:41:02,692: Compiling model.seo_audit.agg_indicative
2018-02-08 11:41:02,692: 11:41:02 | 27 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:41:02,698: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:41:02,692: 11:41:02 | 28 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 11:41:02,699: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:41:02,692: 11:41:02 | 29 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 11:41:02,699: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:41:02,704: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:41:02,704: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:41:02,711: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:41:02,713: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:41:02,722: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:41:02,723: Re-using an available connection from the pool.
2018-02-08 11:41:02,724: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:41:02,726: Re-using an available connection from the pool.
2018-02-08 11:41:02,735: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:41:02,737: Re-using an available connection from the pool.
2018-02-08 11:41:02,738: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:41:02,741: Re-using an available connection from the pool.
2018-02-08 11:41:02,965: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:41:02,967: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:41:02,972: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:41:03,013: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:41:03,341: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c49d30>]}
2018-02-08 11:41:03,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb9860>]}
2018-02-08 11:41:03,425: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c56518>]}
2018-02-08 11:41:03,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:41:03,658: 11:41:03 | 26 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.65s]
2018-02-08 11:41:03,659: 11:41:03 | 30 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:41:03,659: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:41:03,665: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:41:03,669: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:41:03,669: Re-using an available connection from the pool.
2018-02-08 11:41:03,892: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:41:03,948: 11:41:03 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.66s]
2018-02-08 11:41:03,950: 11:41:03 | 31 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 11:41:03,952: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:41:03,962: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:41:03,963: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:41:03,964: Re-using an available connection from the pool.
2018-02-08 11:41:04,202: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:41:04,267: 11:41:04 | 27 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.73s]
2018-02-08 11:41:04,268: 11:41:04 | 32 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:41:04,269: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:41:04,275: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:41:04,277: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:41:04,277: Re-using an available connection from the pool.
2018-02-08 11:41:04,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c49d30>]}
2018-02-08 11:41:04,511: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:41:04,568: 11:41:04 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.78s]
2018-02-08 11:41:04,770: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb9860>]}
2018-02-08 11:41:04,870: 11:41:04 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.77s]
2018-02-08 11:41:05,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c56518>]}
2018-02-08 11:41:05,161: 11:41:05 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.82s]
2018-02-08 11:41:05,449: 11:41:05 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.74s]
2018-02-08 11:41:05,450: 11:41:05 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 11:41:05,450: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:41:05,460: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:41:05,460: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:41:05,461: Re-using an available connection from the pool.
2018-02-08 11:41:05,671: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string class_query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:41:07,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c5d9b0>]}
2018-02-08 11:41:07,544: 11:41:07 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 1.89s]
2018-02-08 11:41:07,545: 11:41:07 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 11:41:07,545: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:41:07,555: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:41:07,556: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:41:07,556: Re-using an available connection from the pool.
2018-02-08 11:41:07,761: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:41:08,284: Bad request while running:
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:41:08,285: 400 POST https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit_dev/tables: Unrecognized name: query_string_rule; Did you mean query_string? at [10:1]
2018-02-08 11:41:08,285: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111cb9208>]}
2018-02-08 11:41:08,502: 11:41:08 | 34 of 37 ERROR creating view model seo_audit_dev.deepcrawl_reclass... [ERROR in 0.74s]
2018-02-08 11:41:08,503: 11:41:08 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 11:41:08,504: Compiling model.seo_audit.agg_stats
2018-02-08 11:41:08,516: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:41:08,517: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:41:08,517: Re-using an available connection from the pool.
2018-02-08 11:41:08,762: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:41:09,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:41:09,544: 11:41:09 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.76s]
2018-02-08 11:41:09,544: 11:41:09 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 11:41:09,545: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:41:09,556: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:41:09,558: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:41:09,558: Re-using an available connection from the pool.
2018-02-08 11:41:09,835: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:41:10,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bc2198>]}
2018-02-08 11:41:10,906: 11:41:10 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 1.06s]
2018-02-08 11:41:10,907: 11:41:10 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 11:41:10,907: Compiling model.seo_audit.agg_all
2018-02-08 11:41:10,918: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:41:10,919: Acquiring new bigquery connection "agg_all".
2018-02-08 11:41:10,919: Re-using an available connection from the pool.
2018-02-08 11:41:11,117: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:41:11,812: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cf241c9-acae-41dc-a410-5fb87a95de36', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7066a0>]}
2018-02-08 11:41:12,024: 11:41:12 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 0.90s]
2018-02-08 11:41:12,055: 11:41:12 | 
2018-02-08 11:41:12,055: 11:41:12 | Finished running 37 view models in 21.44s.
2018-02-08 11:41:12,056: Connection 'master' was left open.
2018-02-08 11:41:12,056: 
2018-02-08 11:41:12,056: Completed with 1 errors:
2018-02-08 11:41:12,056: 
2018-02-08 11:41:12,056: Database Error in model deepcrawl_reclass (models/base-adp/deepcrawl/deepcrawl_reclass.sql)
2018-02-08 11:41:12,057:   Unrecognized name: query_string_rule; Did you mean query_string? at [10:1]
2018-02-08 11:41:12,057:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_reclass.sql
2018-02-08 11:41:12,057: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 11:41:12,057: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111baf710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111baf898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111baf748>]}
2018-02-08 11:41:12,343: Flushing usage events
2018-02-08 11:42:11,257: Tracking: tracking
2018-02-08 11:42:11,259: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce69668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce694a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce69b00>]}
2018-02-08 11:42:11,986: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:42:12,004: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:42:12,006: Parsing core.sql
2018-02-08 11:42:12,024: Parsing adapters/bigquery.sql
2018-02-08 11:42:12,032: Parsing adapters/common.sql
2018-02-08 11:42:12,050: Parsing adapters/postgres.sql
2018-02-08 11:42:12,057: Parsing adapters/redshift.sql
2018-02-08 11:42:12,081: Parsing etc/get_custom_schema.sql
2018-02-08 11:42:12,089: Parsing materializations/archive.sql
2018-02-08 11:42:12,128: Parsing materializations/bigquery.sql
2018-02-08 11:42:12,147: Parsing materializations/helpers.sql
2018-02-08 11:42:12,169: Parsing materializations/incremental.sql
2018-02-08 11:42:12,201: Parsing materializations/table.sql
2018-02-08 11:42:12,233: Parsing materializations/view.sql
2018-02-08 11:42:12,253: Parsing materializations/wrapper.sql
2018-02-08 11:42:12,261: Parsing schema_tests/accepted_values.sql
2018-02-08 11:42:12,269: Parsing schema_tests/not_null.sql
2018-02-08 11:42:12,275: Parsing schema_tests/relationships.sql
2018-02-08 11:42:12,282: Parsing schema_tests/unique.sql
2018-02-08 11:42:12,325: Parsing model.seo_audit.accounts_proc
2018-02-08 11:42:12,330: Parsing model.seo_audit.all_dates
2018-02-08 11:42:12,333: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:42:12,336: Acquiring new bigquery connection "master".
2018-02-08 11:42:12,337: Opening a new connection (0 currently allocated)
2018-02-08 11:42:12,341: Parsing model.seo_audit.agg_all
2018-02-08 11:42:12,345: Parsing model.seo_audit.agg_indicative
2018-02-08 11:42:12,348: Parsing model.seo_audit.agg_stats
2018-02-08 11:42:12,352: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:42:12,355: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:42:12,358: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:42:12,361: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:42:12,362: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:42:12,364: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:42:12,366: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:42:12,368: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:42:12,370: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:42:12,372: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:42:12,378: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:42:12,380: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:42:12,382: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:42:12,383: Parsing model.seo_audit.ga_proc
2018-02-08 11:42:12,386: Parsing model.seo_audit.ga_stats
2018-02-08 11:42:12,388: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:42:12,390: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:42:12,392: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:42:12,394: Parsing model.seo_audit.moz_proc
2018-02-08 11:42:12,397: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:42:12,400: Parsing model.seo_audit.search_console_history
2018-02-08 11:42:12,401: Parsing model.seo_audit.search_console_proc
2018-02-08 11:42:12,404: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:42:12,407: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:42:12,409: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:42:12,411: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:42:12,414: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:42:12,417: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:42:12,419: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:42:12,421: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:42:12,423: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:42:12,435: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:42:12,444: 
2018-02-08 11:42:12,841: 11:42:12 | Concurrency: 4 threads (target='dev')
2018-02-08 11:42:12,841: 11:42:12 | 
2018-02-08 11:42:13,046: 11:42:13 | 1 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 11:42:13,046: Compiling model.seo_audit.all_dates
2018-02-08 11:42:13,050: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:42:13,046: 11:42:13 | 2 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 11:42:13,050: Compiling model.seo_audit.accounts_proc
2018-02-08 11:42:13,055: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:42:13,046: 11:42:13 | 3 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 11:42:13,055: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:42:13,060: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:42:13,061: Acquiring new bigquery connection "all_dates".
2018-02-08 11:42:13,061: Opening a new connection (1 currently allocated)
2018-02-08 11:42:13,062: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:42:13,064: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:42:13,065: Opening a new connection (2 currently allocated)
2018-02-08 11:42:13,159: Opening a new connection (3 currently allocated)
2018-02-08 11:42:13,693: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:42:13,698: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:42:13,714: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:42:13,954: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb908>]}
2018-02-08 11:42:13,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcbef0>]}
2018-02-08 11:42:13,982: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb240>]}
2018-02-08 11:42:14,258: 11:42:14 | 1 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.91s]
2018-02-08 11:42:14,547: 11:42:14 | 2 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.93s]
2018-02-08 11:42:14,820: 11:42:14 | 3 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.93s]
2018-02-08 11:42:14,821: 11:42:14 | 4 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 11:42:14,822: Compiling model.seo_audit.ga_proc
2018-02-08 11:42:14,821: 11:42:14 | 5 of 37 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 11:42:14,827: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:42:14,839: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:42:14,844: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:42:14,821: 11:42:14 | 6 of 37 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 11:42:14,844: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:42:14,853: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:42:14,821: 11:42:14 | 7 of 37 START view model seo_audit_dev.semrush_domain_proc........... [RUN]
2018-02-08 11:42:14,853: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:42:14,860: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:42:14,870: Re-using an available connection from the pool.
2018-02-08 11:42:14,869: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:42:14,868: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:42:14,881: Re-using an available connection from the pool.
2018-02-08 11:42:14,881: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:42:14,885: Re-using an available connection from the pool.
2018-02-08 11:42:14,900: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:42:14,904: Opening a new connection (4 currently allocated)
2018-02-08 11:42:15,148: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:42:15,169: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:42:15,181: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:42:15,497: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:42:15,540: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf4bc50>]}
2018-02-08 11:42:15,749: 11:42:15 | 7 of 37 OK created view model seo_audit_dev.semrush_domain_proc...... [CREATE VIEW in 0.69s]
2018-02-08 11:42:15,749: 11:42:15 | 8 of 37 START view model seo_audit_dev.screamingfrog_proc............ [RUN]
2018-02-08 11:42:15,750: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:42:15,761: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:42:15,763: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb4e0>]}
2018-02-08 11:42:15,766: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:42:15,767: Re-using an available connection from the pool.
2018-02-08 11:42:15,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d050550>]}
2018-02-08 11:42:15,980: 11:42:15 | 4 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.94s]
2018-02-08 11:42:15,980: 11:42:15 | 9 of 37 START view model seo_audit_dev.semrush_keyword_proc.......... [RUN]
2018-02-08 11:42:15,980: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:42:15,987: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:42:15,990: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:42:15,991: Re-using an available connection from the pool.
2018-02-08 11:42:15,995: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:42:16,208: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:42:16,287: 11:42:16 | 6 of 37 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.99s]
2018-02-08 11:42:16,288: 11:42:16 | 10 of 37 START view model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 11:42:16,288: Compiling model.seo_audit.search_console_proc
2018-02-08 11:42:16,299: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:42:16,301: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:42:16,301: Re-using an available connection from the pool.
2018-02-08 11:42:16,337: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06bd68>]}
2018-02-08 11:42:16,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:16,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d06b978>]}
2018-02-08 11:42:16,524: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:42:16,551: 11:42:16 | 5 of 37 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 1.51s]
2018-02-08 11:42:16,552: 11:42:16 | 11 of 37 START view model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 11:42:16,553: Compiling model.seo_audit.moz_proc
2018-02-08 11:42:16,564: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:42:16,566: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:42:16,566: Re-using an available connection from the pool.
2018-02-08 11:42:16,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d03b668>]}
2018-02-08 11:42:16,861: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:42:16,906: 11:42:16 | 8 of 37 OK created view model seo_audit_dev.screamingfrog_proc....... [CREATE VIEW in 0.68s]
2018-02-08 11:42:16,908: 11:42:16 | 12 of 37 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 11:42:16,909: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:42:16,922: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:42:16,925: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:42:16,925: Re-using an available connection from the pool.
2018-02-08 11:42:17,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf4bf98>]}
2018-02-08 11:42:17,150: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:42:17,213: 11:42:17 | 9 of 37 OK created view model seo_audit_dev.semrush_keyword_proc..... [CREATE VIEW in 0.52s]
2018-02-08 11:42:17,213: 11:42:17 | 13 of 37 START view model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 11:42:17,215: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:42:17,225: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:42:17,227: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:42:17,227: Re-using an available connection from the pool.
2018-02-08 11:42:17,453: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:42:17,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb4e0>]}
2018-02-08 11:42:17,523: 11:42:17 | 10 of 37 OK created view model seo_audit_dev.search_console_proc..... [CREATE VIEW in 0.53s]
2018-02-08 11:42:17,826: 11:42:17 | 11 of 37 OK created view model seo_audit_dev.moz_proc................ [CREATE VIEW in 0.59s]
2018-02-08 11:42:17,835: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb358>]}
2018-02-08 11:42:18,122: 11:42:18 | 12 of 37 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.55s]
2018-02-08 11:42:18,361: 11:42:18 | 13 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc.... [CREATE VIEW in 0.62s]
2018-02-08 11:42:18,362: 11:42:18 | 14 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 11:42:18,363: Compiling model.seo_audit.search_console_history
2018-02-08 11:42:18,363: 11:42:18 | 15 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 11:42:18,363: 11:42:18 | 16 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 11:42:18,363: 11:42:18 | 17 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 11:42:18,374: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:42:18,374: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:42:18,375: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:42:18,375: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:42:18,380: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:42:18,386: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:42:18,387: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:42:18,392: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:42:18,393: Re-using an available connection from the pool.
2018-02-08 11:42:18,394: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:42:18,395: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:42:18,395: Re-using an available connection from the pool.
2018-02-08 11:42:18,397: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:42:18,412: Re-using an available connection from the pool.
2018-02-08 11:42:18,415: Re-using an available connection from the pool.
2018-02-08 11:42:18,641: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:42:18,645: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:42:18,660: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:42:18,710: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:42:19,052: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d048e10>]}
2018-02-08 11:42:19,055: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb240>]}
2018-02-08 11:42:19,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb4e0>]}
2018-02-08 11:42:19,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfe3630>]}
2018-02-08 11:42:19,405: 11:42:19 | 16 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.68s]
2018-02-08 11:42:19,407: 11:42:19 | 18 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 11:42:19,407: Compiling model.seo_audit.ga_stats
2018-02-08 11:42:19,414: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:42:19,416: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:42:19,417: Re-using an available connection from the pool.
2018-02-08 11:42:19,628: 11:42:19 | 14 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 0.69s]
2018-02-08 11:42:19,854: 11:42:19 | 15 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.69s]
2018-02-08 11:42:19,973: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:42:20,083: 11:42:20 | 17 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.69s]
2018-02-08 11:42:20,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfe3be0>]}
2018-02-08 11:42:20,899: 11:42:20 | 18 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 1.27s]
2018-02-08 11:42:20,900: 11:42:20 | 19 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 11:42:20,900: 11:42:20 | 20 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 11:42:20,901: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:42:20,901: 11:42:20 | 21 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 11:42:20,901: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:42:20,912: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:42:20,912: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:42:20,922: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:42:20,922: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:42:20,923: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:42:20,924: Re-using an available connection from the pool.
2018-02-08 11:42:20,924: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:42:20,924: Re-using an available connection from the pool.
2018-02-08 11:42:20,928: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:42:20,928: Re-using an available connection from the pool.
2018-02-08 11:42:21,908: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:42:21,948: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:42:21,950: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:42:22,732: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d048780>]}
2018-02-08 11:42:22,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d023438>]}
2018-02-08 11:42:22,741: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:22,946: 11:42:22 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 1.83s]
2018-02-08 11:42:23,153: 11:42:23 | 21 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 1.83s]
2018-02-08 11:42:23,448: 11:42:23 | 19 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 1.84s]
2018-02-08 11:42:23,449: 11:42:23 | 22 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 11:42:23,449: 11:42:23 | 23 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:42:23,449: 11:42:23 | 24 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 11:42:23,449: 11:42:23 | 25 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 11:42:23,450: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:42:23,450: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:42:23,450: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:42:23,450: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:42:23,457: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:42:23,462: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:42:23,467: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:42:23,471: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:42:23,473: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:42:23,474: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:42:23,474: Re-using an available connection from the pool.
2018-02-08 11:42:23,475: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:42:23,477: Re-using an available connection from the pool.
2018-02-08 11:42:23,477: Re-using an available connection from the pool.
2018-02-08 11:42:23,481: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:42:23,481: Re-using an available connection from the pool.
2018-02-08 11:42:24,432: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:42:24,437: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:42:24,468: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:42:24,501: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:42:25,306: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfe3320>]}
2018-02-08 11:42:25,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d042710>]}
2018-02-08 11:42:25,309: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d023978>]}
2018-02-08 11:42:25,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfe3358>]}
2018-02-08 11:42:25,610: 11:42:25 | 24 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 1.86s]
2018-02-08 11:42:25,857: 11:42:25 | 25 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 1.86s]
2018-02-08 11:42:26,151: 11:42:26 | 22 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 1.86s]
2018-02-08 11:42:26,489: 11:42:26 | 23 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 1.86s]
2018-02-08 11:42:26,490: 11:42:26 | 26 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:42:26,491: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:42:26,497: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:42:26,491: 11:42:26 | 27 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:42:26,498: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:42:26,502: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:42:26,491: 11:42:26 | 28 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 11:42:26,491: 11:42:26 | 29 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:42:26,503: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:42:26,503: Compiling model.seo_audit.agg_indicative
2018-02-08 11:42:26,504: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:42:26,504: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:42:26,509: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:42:26,509: Re-using an available connection from the pool.
2018-02-08 11:42:26,518: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:42:26,520: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:42:26,520: Re-using an available connection from the pool.
2018-02-08 11:42:26,523: Re-using an available connection from the pool.
2018-02-08 11:42:26,531: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:42:26,531: Re-using an available connection from the pool.
2018-02-08 11:42:27,439: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:42:27,441: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:42:27,469: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:42:27,479: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:42:28,261: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcbef0>]}
2018-02-08 11:42:28,276: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfcb240>]}
2018-02-08 11:42:28,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:28,304: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cfe3320>]}
2018-02-08 11:42:28,479: 11:42:28 | 28 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 1.76s]
2018-02-08 11:42:28,479: 11:42:28 | 30 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 11:42:28,481: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:42:28,491: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:42:28,493: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:42:28,493: Re-using an available connection from the pool.
2018-02-08 11:42:28,783: 11:42:28 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 1.77s]
2018-02-08 11:42:28,783: 11:42:28 | 31 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 11:42:28,784: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:42:28,792: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:42:28,794: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:42:28,795: Re-using an available connection from the pool.
2018-02-08 11:42:29,095: 11:42:29 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 1.80s]
2018-02-08 11:42:29,097: 11:42:29 | 32 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 11:42:29,099: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:42:29,108: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:42:29,109: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:42:29,110: Re-using an available connection from the pool.
2018-02-08 11:42:29,398: 11:42:29 | 27 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 1.81s]
2018-02-08 11:42:29,419: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:42:29,438: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:42:29,898: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:42:30,316: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0236a0>]}
2018-02-08 11:42:30,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d050518>]}
2018-02-08 11:42:30,576: 11:42:30 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 1.83s]
2018-02-08 11:42:30,799: 11:42:30 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 1.54s]
2018-02-08 11:42:30,808: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:31,105: 11:42:31 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 1.71s]
2018-02-08 11:42:31,106: 11:42:31 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 11:42:31,107: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:42:31,119: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:42:31,120: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:42:31,121: Re-using an available connection from the pool.
2018-02-08 11:42:32,162: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:42:34,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d050860>]}
2018-02-08 11:42:34,824: 11:42:34 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 3.40s]
2018-02-08 11:42:34,825: 11:42:34 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 11:42:34,826: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:42:34,835: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:42:34,836: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:42:34,836: Re-using an available connection from the pool.
2018-02-08 11:42:35,294: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:42:37,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:37,557: 11:42:37 | 34 of 37 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 2.51s]
2018-02-08 11:42:37,557: 11:42:37 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 11:42:37,558: Compiling model.seo_audit.agg_stats
2018-02-08 11:42:37,572: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:42:37,574: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:42:37,574: Re-using an available connection from the pool.
2018-02-08 11:42:38,495: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:42:39,528: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d0234e0>]}
2018-02-08 11:42:39,754: 11:42:39 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 1.97s]
2018-02-08 11:42:39,755: 11:42:39 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 11:42:39,755: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:42:39,765: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:42:39,766: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:42:39,766: Re-using an available connection from the pool.
2018-02-08 11:42:40,713: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:42:41,881: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf70208>]}
2018-02-08 11:42:42,107: 11:42:42 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 2.13s]
2018-02-08 11:42:42,108: 11:42:42 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 11:42:42,108: Compiling model.seo_audit.agg_all
2018-02-08 11:42:42,117: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:42:42,118: Acquiring new bigquery connection "agg_all".
2018-02-08 11:42:42,118: Re-using an available connection from the pool.
2018-02-08 11:42:43,120: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:42:45,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '590b3bba-265e-4251-b7fc-df0eb2c0e3b2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d065f98>]}
2018-02-08 11:42:45,586: 11:42:45 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 3.12s]
2018-02-08 11:42:45,685: 11:42:45 | 
2018-02-08 11:42:45,686: 11:42:45 | Finished running 37 view models in 32.85s.
2018-02-08 11:42:45,686: Connection 'master' was left open.
2018-02-08 11:42:45,686: 
2018-02-08 11:42:45,687: Completed successfully
2018-02-08 11:42:45,687: 
Done. PASS=37 ERROR=0 SKIP=0 TOTAL=37
2018-02-08 11:42:45,687: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf38748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf388d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cf38780>]}
2018-02-08 11:42:45,954: Flushing usage events
2018-02-08 11:43:43,232: Tracking: tracking
2018-02-08 11:43:43,235: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c64710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c64cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c64048>]}
2018-02-08 11:43:44,136: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:43:44,162: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:43:44,166: Parsing core.sql
2018-02-08 11:43:44,195: Parsing adapters/bigquery.sql
2018-02-08 11:43:44,206: Parsing adapters/common.sql
2018-02-08 11:43:44,225: Parsing adapters/postgres.sql
2018-02-08 11:43:44,231: Parsing adapters/redshift.sql
2018-02-08 11:43:44,254: Parsing etc/get_custom_schema.sql
2018-02-08 11:43:44,267: Parsing materializations/archive.sql
2018-02-08 11:43:44,310: Parsing materializations/bigquery.sql
2018-02-08 11:43:44,327: Parsing materializations/helpers.sql
2018-02-08 11:43:44,346: Parsing materializations/incremental.sql
2018-02-08 11:43:44,381: Parsing materializations/table.sql
2018-02-08 11:43:44,404: Parsing materializations/view.sql
2018-02-08 11:43:44,431: Parsing materializations/wrapper.sql
2018-02-08 11:43:44,440: Parsing schema_tests/accepted_values.sql
2018-02-08 11:43:44,449: Parsing schema_tests/not_null.sql
2018-02-08 11:43:44,455: Parsing schema_tests/relationships.sql
2018-02-08 11:43:44,462: Parsing schema_tests/unique.sql
2018-02-08 11:43:44,522: Parsing model.seo_audit.accounts_proc
2018-02-08 11:43:44,526: Parsing model.seo_audit.all_dates
2018-02-08 11:43:44,528: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:43:44,531: Acquiring new bigquery connection "master".
2018-02-08 11:43:44,531: Opening a new connection (0 currently allocated)
2018-02-08 11:43:44,536: Parsing model.seo_audit.agg_all
2018-02-08 11:43:44,539: Parsing model.seo_audit.agg_indicative
2018-02-08 11:43:44,541: Parsing model.seo_audit.agg_stats
2018-02-08 11:43:44,547: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:43:44,549: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:43:44,552: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:43:44,554: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:43:44,556: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:43:44,558: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:43:44,559: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:43:44,562: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:43:44,564: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:43:44,566: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:43:44,572: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:43:44,574: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:43:44,576: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:43:44,578: Parsing model.seo_audit.ga_proc
2018-02-08 11:43:44,581: Parsing model.seo_audit.ga_stats
2018-02-08 11:43:44,583: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:43:44,585: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:43:44,587: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:43:44,589: Parsing model.seo_audit.moz_proc
2018-02-08 11:43:44,592: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:43:44,596: Parsing model.seo_audit.search_console_history
2018-02-08 11:43:44,599: Parsing model.seo_audit.search_console_proc
2018-02-08 11:43:44,603: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:43:44,606: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:43:44,608: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:43:44,611: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:43:44,614: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:43:44,616: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:43:44,618: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:43:44,620: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:43:44,622: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:43:44,635: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:43:44,646: 
2018-02-08 11:43:45,912: 11:43:45 | Concurrency: 4 threads (target='dev')
2018-02-08 11:43:45,913: 11:43:45 | 
2018-02-08 11:43:46,181: 11:43:46 | 1 of 37 START view model seo_audit_dev.accounts_proc................. [RUN]
2018-02-08 11:43:46,181: 11:43:46 | 2 of 37 START view model seo_audit_dev.all_dates..................... [RUN]
2018-02-08 11:43:46,182: Compiling model.seo_audit.accounts_proc
2018-02-08 11:43:46,182: 11:43:46 | 3 of 37 START view model seo_audit_dev.deepcrawl_proc................ [RUN]
2018-02-08 11:43:46,182: Compiling model.seo_audit.all_dates
2018-02-08 11:43:46,188: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:43:46,188: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:43:46,192: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:43:46,197: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:43:46,200: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:43:46,201: Opening a new connection (1 currently allocated)
2018-02-08 11:43:46,201: Acquiring new bigquery connection "all_dates".
2018-02-08 11:43:46,202: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:43:46,204: Opening a new connection (2 currently allocated)
2018-02-08 11:43:46,205: Opening a new connection (3 currently allocated)
2018-02-08 11:43:46,825: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:43:46,830: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:43:46,864: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:43:47,028: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e286a0>]}
2018-02-08 11:43:47,049: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e28668>]}
2018-02-08 11:43:47,084: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4f8d0>]}
2018-02-08 11:43:47,240: 11:43:47 | 1 of 37 OK created view model seo_audit_dev.accounts_proc............ [CREATE VIEW in 0.85s]
2018-02-08 11:43:47,486: 11:43:47 | 2 of 37 OK created view model seo_audit_dev.all_dates................ [CREATE VIEW in 0.87s]
2018-02-08 11:43:47,733: 11:43:47 | 3 of 37 OK created view model seo_audit_dev.deepcrawl_proc........... [CREATE VIEW in 0.90s]
2018-02-08 11:43:47,734: 11:43:47 | 4 of 37 START view model seo_audit_dev.moz_proc...................... [RUN]
2018-02-08 11:43:47,734: 11:43:47 | 5 of 37 START view model seo_audit_dev.ga_proc....................... [RUN]
2018-02-08 11:43:47,735: 11:43:47 | 6 of 37 START view model seo_audit_dev.mappings_ga_proc.............. [RUN]
2018-02-08 11:43:47,735: Compiling model.seo_audit.moz_proc
2018-02-08 11:43:47,735: 11:43:47 | 7 of 37 START view model seo_audit_dev.deepcrawl_class_proc.......... [RUN]
2018-02-08 11:43:47,735: Compiling model.seo_audit.ga_proc
2018-02-08 11:43:47,736: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:43:47,742: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:43:47,745: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:43:47,757: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:43:47,759: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:43:47,765: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:43:47,769: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:43:47,769: Re-using an available connection from the pool.
2018-02-08 11:43:47,770: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:43:47,770: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:43:47,771: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:43:47,771: Re-using an available connection from the pool.
2018-02-08 11:43:47,774: Re-using an available connection from the pool.
2018-02-08 11:43:47,775: Opening a new connection (4 currently allocated)
2018-02-08 11:43:48,001: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:43:48,075: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:43:48,087: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:43:48,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9dcf8>]}
2018-02-08 11:43:48,324: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:43:48,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4f8d0>]}
2018-02-08 11:43:48,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fdd8>]}
2018-02-08 11:43:48,586: 11:43:48 | 4 of 37 OK created view model seo_audit_dev.moz_proc................. [CREATE VIEW in 0.56s]
2018-02-08 11:43:48,587: 11:43:48 | 8 of 37 START view model seo_audit_dev.majestic_domain_proc.......... [RUN]
2018-02-08 11:43:48,587: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:43:48,594: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:43:48,596: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:43:48,597: Re-using an available connection from the pool.
2018-02-08 11:43:48,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9e160>]}
2018-02-08 11:43:48,801: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:43:48,808: 11:43:48 | 6 of 37 OK created view model seo_audit_dev.mappings_ga_proc......... [CREATE VIEW in 0.66s]
2018-02-08 11:43:48,809: 11:43:48 | 9 of 37 START view model seo_audit_dev.search_console_proc........... [RUN]
2018-02-08 11:43:48,809: Compiling model.seo_audit.search_console_proc
2018-02-08 11:43:48,817: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:43:48,820: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:43:48,820: Re-using an available connection from the pool.
2018-02-08 11:43:49,039: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:43:49,086: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e131d0>]}
2018-02-08 11:43:49,111: 11:43:49 | 7 of 37 OK created view model seo_audit_dev.deepcrawl_class_proc..... [CREATE VIEW in 0.68s]
2018-02-08 11:43:49,112: 11:43:49 | 10 of 37 START view model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 11:43:49,113: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:43:49,122: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:43:49,125: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:43:49,125: Re-using an available connection from the pool.
2018-02-08 11:43:49,334: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:43:49,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d8f7f0>]}
2018-02-08 11:43:49,363: 11:43:49 | 5 of 37 OK created view model seo_audit_dev.ga_proc.................. [CREATE VIEW in 0.89s]
2018-02-08 11:43:49,363: 11:43:49 | 11 of 37 START view model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 11:43:49,364: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:43:49,370: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:43:49,372: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:43:49,373: Re-using an available connection from the pool.
2018-02-08 11:43:49,632: 11:43:49 | 8 of 37 OK created view model seo_audit_dev.majestic_domain_proc..... [CREATE VIEW in 0.50s]
2018-02-08 11:43:49,633: 11:43:49 | 12 of 37 START view model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 11:43:49,635: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:43:49,638: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:43:49,650: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dbc2e8>]}
2018-02-08 11:43:49,656: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:43:49,659: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:43:49,659: Re-using an available connection from the pool.
2018-02-08 11:43:49,858: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:43:49,933: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9e160>]}
2018-02-08 11:43:49,942: 11:43:49 | 9 of 37 OK created view model seo_audit_dev.search_console_proc...... [CREATE VIEW in 0.55s]
2018-02-08 11:43:49,943: 11:43:49 | 13 of 37 START view model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 11:43:49,944: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:43:49,951: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:43:49,954: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:43:49,955: Re-using an available connection from the pool.
2018-02-08 11:43:50,168: 11:43:50 | 10 of 37 OK created view model seo_audit_dev.screamingfrog_proc...... [CREATE VIEW in 0.54s]
2018-02-08 11:43:50,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e131d0>]}
2018-02-08 11:43:50,185: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:43:50,399: 11:43:50 | 11 of 37 OK created view model seo_audit_dev.semrush_domain_proc..... [CREATE VIEW in 0.57s]
2018-02-08 11:43:50,548: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d8f7f0>]}
2018-02-08 11:43:50,719: 11:43:50 | 12 of 37 OK created view model seo_audit_dev.sitemap_proc............ [CREATE VIEW in 0.55s]
2018-02-08 11:43:50,939: 11:43:50 | 13 of 37 OK created view model seo_audit_dev.semrush_keyword_proc.... [CREATE VIEW in 0.60s]
2018-02-08 11:43:50,940: 11:43:50 | 14 of 37 START view model seo_audit_dev.semrush_url_history.......... [RUN]
2018-02-08 11:43:50,941: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:43:50,940: 11:43:50 | 15 of 37 START view model seo_audit_dev.search_console_history....... [RUN]
2018-02-08 11:43:50,947: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:43:50,940: 11:43:50 | 16 of 37 START view model seo_audit_dev.majestic_domain_history...... [RUN]
2018-02-08 11:43:50,947: Compiling model.seo_audit.search_console_history
2018-02-08 11:43:50,940: 11:43:50 | 17 of 37 START view model seo_audit_dev.semrush_keyword_history...... [RUN]
2018-02-08 11:43:50,948: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:43:50,954: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:43:50,954: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:43:50,962: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:43:50,988: Re-using an available connection from the pool.
2018-02-08 11:43:50,984: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:43:50,988: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:43:50,993: Re-using an available connection from the pool.
2018-02-08 11:43:50,964: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:43:50,993: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:43:50,999: Re-using an available connection from the pool.
2018-02-08 11:43:50,997: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:43:51,002: Re-using an available connection from the pool.
2018-02-08 11:43:51,223: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:43:51,228: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:43:51,268: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:43:51,619: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:43:51,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:43:51,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e362b0>]}
2018-02-08 11:43:51,629: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9e160>]}
2018-02-08 11:43:51,873: 11:43:51 | 16 of 37 OK created view model seo_audit_dev.majestic_domain_history. [CREATE VIEW in 0.67s]
2018-02-08 11:43:51,873: 11:43:51 | 18 of 37 START view model seo_audit_dev.ga_stats..................... [RUN]
2018-02-08 11:43:51,874: Compiling model.seo_audit.ga_stats
2018-02-08 11:43:51,887: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:43:51,890: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:43:51,890: Re-using an available connection from the pool.
2018-02-08 11:43:51,947: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fa90>]}
2018-02-08 11:43:52,123: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:43:52,124: 11:43:52 | 17 of 37 OK created view model seo_audit_dev.semrush_keyword_history. [CREATE VIEW in 0.67s]
2018-02-08 11:43:52,419: 11:43:52 | 14 of 37 OK created view model seo_audit_dev.semrush_url_history..... [CREATE VIEW in 0.69s]
2018-02-08 11:43:52,481: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:43:52,750: 11:43:52 | 15 of 37 OK created view model seo_audit_dev.search_console_history.. [CREATE VIEW in 1.00s]
2018-02-08 11:43:52,967: 11:43:52 | 18 of 37 OK created view model seo_audit_dev.ga_stats................ [CREATE VIEW in 0.61s]
2018-02-08 11:43:52,968: 11:43:52 | 19 of 37 START view model seo_audit_dev.deepcrawl_class.............. [RUN]
2018-02-08 11:43:52,968: 11:43:52 | 20 of 37 START view model seo_audit_dev.search_console_stats_keyword. [RUN]
2018-02-08 11:43:52,969: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:43:52,968: 11:43:52 | 21 of 37 START view model seo_audit_dev.search_console_stats_url..... [RUN]
2018-02-08 11:43:52,969: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:43:52,980: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:43:52,981: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:43:52,998: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:43:52,998: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:43:53,000: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:43:53,001: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:43:53,003: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:43:53,003: Re-using an available connection from the pool.
2018-02-08 11:43:53,004: Re-using an available connection from the pool.
2018-02-08 11:43:53,004: Re-using an available connection from the pool.
2018-02-08 11:43:53,228: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:43:53,231: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:43:53,243: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:43:53,664: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d320>]}
2018-02-08 11:43:53,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:43:53,673: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d8f7f0>]}
2018-02-08 11:43:54,597: 11:43:54 | 20 of 37 OK created view model seo_audit_dev.search_console_stats_keyword [CREATE VIEW in 0.69s]
2018-02-08 11:43:54,827: 11:43:54 | 21 of 37 OK created view model seo_audit_dev.search_console_stats_url [CREATE VIEW in 0.69s]
2018-02-08 11:43:55,064: 11:43:55 | 19 of 37 OK created view model seo_audit_dev.deepcrawl_class......... [CREATE VIEW in 0.70s]
2018-02-08 11:43:55,065: 11:43:55 | 22 of 37 START view model seo_audit_dev.semrush_keyword_stats........ [RUN]
2018-02-08 11:43:55,065: 11:43:55 | 23 of 37 START view model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:43:55,066: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:43:55,066: 11:43:55 | 24 of 37 START view model seo_audit_dev.majestic_domain_stats........ [RUN]
2018-02-08 11:43:55,066: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:43:55,066: 11:43:55 | 25 of 37 START view model seo_audit_dev.semrush_url_stats............ [RUN]
2018-02-08 11:43:55,073: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:43:55,073: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:43:55,081: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:43:55,081: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:43:55,089: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:43:55,099: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:43:55,100: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:43:55,104: Re-using an available connection from the pool.
2018-02-08 11:43:55,101: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:43:55,110: Re-using an available connection from the pool.
2018-02-08 11:43:55,103: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:43:55,104: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:43:55,121: Re-using an available connection from the pool.
2018-02-08 11:43:55,123: Re-using an available connection from the pool.
2018-02-08 11:43:55,341: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:43:55,344: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:43:55,353: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:43:55,357: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:43:55,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d49eb8>]}
2018-02-08 11:43:55,698: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dbc2e8>]}
2018-02-08 11:43:55,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dbc128>]}
2018-02-08 11:43:55,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d0b8>]}
2018-02-08 11:43:55,925: 11:43:55 | 22 of 37 OK created view model seo_audit_dev.semrush_keyword_stats... [CREATE VIEW in 0.60s]
2018-02-08 11:43:56,154: 11:43:56 | 25 of 37 OK created view model seo_audit_dev.semrush_url_stats....... [CREATE VIEW in 0.62s]
2018-02-08 11:43:56,373: 11:43:56 | 24 of 37 OK created view model seo_audit_dev.majestic_domain_stats... [CREATE VIEW in 0.65s]
2018-02-08 11:43:56,615: 11:43:56 | 23 of 37 OK created view model seo_audit_dev.deepcrawl_classification_stats [CREATE VIEW in 0.73s]
2018-02-08 11:43:56,616: 11:43:56 | 26 of 37 START view model seo_audit_dev.deepcrawl_rules_query_string. [RUN]
2018-02-08 11:43:56,617: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:43:56,617: 11:43:56 | 27 of 37 START view model seo_audit_dev.agg_indicative............... [RUN]
2018-02-08 11:43:56,623: Compiling model.seo_audit.agg_indicative
2018-02-08 11:43:56,631: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:43:56,633: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:43:56,617: 11:43:56 | 28 of 37 START view model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:43:56,633: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:43:56,638: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:43:56,617: 11:43:56 | 29 of 37 START view model seo_audit_dev.deepcrawl_rules_first_path... [RUN]
2018-02-08 11:43:56,638: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:43:56,643: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:43:56,644: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:43:56,645: Re-using an available connection from the pool.
2018-02-08 11:43:56,646: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:43:56,647: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:43:56,648: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:43:56,649: Re-using an available connection from the pool.
2018-02-08 11:43:56,659: Re-using an available connection from the pool.
2018-02-08 11:43:56,661: Re-using an available connection from the pool.
2018-02-08 11:43:56,886: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:43:56,893: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:43:56,895: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:43:56,896: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:43:57,352: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dbc128>]}
2018-02-08 11:43:57,353: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d8f7f0>]}
2018-02-08 11:43:57,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d870f0>]}
2018-02-08 11:43:57,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d87cf8>]}
2018-02-08 11:43:57,651: 11:43:57 | 27 of 37 OK created view model seo_audit_dev.agg_indicative.......... [CREATE VIEW in 0.73s]
2018-02-08 11:43:57,653: 11:43:57 | 30 of 37 START view model seo_audit_dev.deepcrawl_rules_filename..... [RUN]
2018-02-08 11:43:57,653: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:43:57,662: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:43:57,663: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:43:57,663: Re-using an available connection from the pool.
2018-02-08 11:43:57,888: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:43:57,888: 11:43:57 | 26 of 37 OK created view model seo_audit_dev.deepcrawl_rules_query_string [CREATE VIEW in 0.74s]
2018-02-08 11:43:57,889: 11:43:57 | 31 of 37 START view model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:43:57,891: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:43:57,897: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:43:57,900: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:43:57,900: Re-using an available connection from the pool.
2018-02-08 11:43:58,105: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:43:58,117: 11:43:58 | 29 of 37 OK created view model seo_audit_dev.deepcrawl_rules_first_path [CREATE VIEW in 0.72s]
2018-02-08 11:43:58,119: 11:43:58 | 32 of 37 START view model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:43:58,121: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:43:58,131: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:43:58,132: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:43:58,132: Re-using an available connection from the pool.
2018-02-08 11:43:58,252: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:43:58,335: 11:43:58 | 28 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE VIEW in 0.82s]
2018-02-08 11:43:58,390: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:43:58,533: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d8f7f0>]}
2018-02-08 11:43:58,537: 11:43:58 | 30 of 37 OK created view model seo_audit_dev.deepcrawl_rules_filename [CREATE VIEW in 0.60s]
2018-02-08 11:43:58,769: 11:43:58 | 31 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE VIEW in 0.64s]
2018-02-08 11:43:58,883: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104de8828>]}
2018-02-08 11:43:59,129: 11:43:59 | 32 of 37 OK created view model seo_audit_dev.deepcrawl_class_stats_filename [CREATE VIEW in 0.76s]
2018-02-08 11:43:59,130: 11:43:59 | 33 of 37 START view model seo_audit_dev.deepcrawl_reclass_proc....... [RUN]
2018-02-08 11:43:59,130: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:43:59,148: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:43:59,150: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:43:59,150: Re-using an available connection from the pool.
2018-02-08 11:43:59,375: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:44:01,037: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d0b8>]}
2018-02-08 11:44:01,392: 11:44:01 | 33 of 37 OK created view model seo_audit_dev.deepcrawl_reclass_proc.. [CREATE VIEW in 1.91s]
2018-02-08 11:44:01,393: 11:44:01 | 34 of 37 START view model seo_audit_dev.deepcrawl_reclass............ [RUN]
2018-02-08 11:44:01,393: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:44:01,401: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:44:01,401: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:44:01,401: Re-using an available connection from the pool.
2018-02-08 11:44:01,634: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:44:03,058: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:44:03,391: 11:44:03 | 34 of 37 OK created view model seo_audit_dev.deepcrawl_reclass....... [CREATE VIEW in 1.66s]
2018-02-08 11:44:03,392: 11:44:03 | 35 of 37 START view model seo_audit_dev.agg_stats.................... [RUN]
2018-02-08 11:44:03,392: Compiling model.seo_audit.agg_stats
2018-02-08 11:44:03,406: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:44:03,407: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:44:03,407: Re-using an available connection from the pool.
2018-02-08 11:44:03,639: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:44:04,315: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d0b8>]}
2018-02-08 11:44:04,572: 11:44:04 | 35 of 37 OK created view model seo_audit_dev.agg_stats............... [CREATE VIEW in 0.92s]
2018-02-08 11:44:04,573: 11:44:04 | 36 of 37 START view model seo_audit_dev.agg_stats_client............. [RUN]
2018-02-08 11:44:04,574: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:44:04,582: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:44:04,583: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:44:04,583: Re-using an available connection from the pool.
2018-02-08 11:44:04,824: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:44:05,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e4fba8>]}
2018-02-08 11:44:05,848: 11:44:05 | 36 of 37 OK created view model seo_audit_dev.agg_stats_client........ [CREATE VIEW in 0.96s]
2018-02-08 11:44:05,849: 11:44:05 | 37 of 37 START view model seo_audit_dev.agg_all...................... [RUN]
2018-02-08 11:44:05,850: Compiling model.seo_audit.agg_all
2018-02-08 11:44:05,861: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:44:05,862: Acquiring new bigquery connection "agg_all".
2018-02-08 11:44:05,862: Re-using an available connection from the pool.
2018-02-08 11:44:06,097: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:44:06,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '019339cc-2c10-45b0-972b-a3a07dfd0f9d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e13160>]}
2018-02-08 11:44:07,322: 11:44:07 | 37 of 37 OK created view model seo_audit_dev.agg_all................. [CREATE VIEW in 1.12s]
2018-02-08 11:44:07,356: 11:44:07 | 
2018-02-08 11:44:07,357: 11:44:07 | Finished running 37 view models in 21.45s.
2018-02-08 11:44:07,357: Connection 'master' was left open.
2018-02-08 11:44:07,357: 
2018-02-08 11:44:07,358: Completed successfully
2018-02-08 11:44:07,358: 
Done. PASS=37 ERROR=0 SKIP=0 TOTAL=37
2018-02-08 11:44:07,358: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d6a2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d33550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d33630>]}
2018-02-08 11:44:07,625: Flushing usage events
2018-02-08 11:46:09,700: Tracking: tracking
2018-02-08 11:46:09,703: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe15eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe15dd8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fe15fd0>]}
2018-02-08 11:46:10,527: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:46:10,544: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:46:10,551: Parsing core.sql
2018-02-08 11:46:10,575: Parsing adapters/bigquery.sql
2018-02-08 11:46:10,583: Parsing adapters/common.sql
2018-02-08 11:46:10,600: Parsing adapters/postgres.sql
2018-02-08 11:46:10,606: Parsing adapters/redshift.sql
2018-02-08 11:46:10,628: Parsing etc/get_custom_schema.sql
2018-02-08 11:46:10,636: Parsing materializations/archive.sql
2018-02-08 11:46:10,670: Parsing materializations/bigquery.sql
2018-02-08 11:46:10,686: Parsing materializations/helpers.sql
2018-02-08 11:46:10,704: Parsing materializations/incremental.sql
2018-02-08 11:46:10,739: Parsing materializations/table.sql
2018-02-08 11:46:10,762: Parsing materializations/view.sql
2018-02-08 11:46:10,782: Parsing materializations/wrapper.sql
2018-02-08 11:46:10,791: Parsing schema_tests/accepted_values.sql
2018-02-08 11:46:10,800: Parsing schema_tests/not_null.sql
2018-02-08 11:46:10,806: Parsing schema_tests/relationships.sql
2018-02-08 11:46:10,814: Parsing schema_tests/unique.sql
2018-02-08 11:46:10,871: Parsing model.seo_audit.accounts_proc
2018-02-08 11:46:10,874: Parsing model.seo_audit.all_dates
2018-02-08 11:46:10,875: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:46:10,877: Acquiring new bigquery connection "master".
2018-02-08 11:46:10,877: Opening a new connection (0 currently allocated)
2018-02-08 11:46:10,884: Parsing model.seo_audit.agg_all
2018-02-08 11:46:10,887: Parsing model.seo_audit.agg_indicative
2018-02-08 11:46:10,890: Parsing model.seo_audit.agg_stats
2018-02-08 11:46:10,894: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:46:10,897: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:46:10,900: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:46:10,903: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:46:10,905: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:46:10,907: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:46:10,908: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:46:10,911: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:46:10,913: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:46:10,915: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:46:10,921: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:46:10,923: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:46:10,925: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:46:10,927: Parsing model.seo_audit.ga_proc
2018-02-08 11:46:10,930: Parsing model.seo_audit.ga_stats
2018-02-08 11:46:10,931: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:46:10,933: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:46:10,936: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:46:10,938: Parsing model.seo_audit.moz_proc
2018-02-08 11:46:10,941: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:46:10,944: Parsing model.seo_audit.search_console_history
2018-02-08 11:46:10,946: Parsing model.seo_audit.search_console_proc
2018-02-08 11:46:10,948: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:46:10,951: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:46:10,953: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:46:10,956: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:46:10,958: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:46:10,961: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:46:10,963: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:46:10,966: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:46:10,968: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:46:10,983: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:46:10,994: 
2018-02-08 11:46:11,775: 11:46:11 | Concurrency: 4 threads (target='dev')
2018-02-08 11:46:11,776: 11:46:11 | 
2018-02-08 11:46:11,990: 11:46:11 | 1 of 37 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 11:46:11,991: 11:46:11 | 2 of 37 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 11:46:11,991: Compiling model.seo_audit.all_dates
2018-02-08 11:46:11,991: 11:46:11 | 3 of 37 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 11:46:11,991: Compiling model.seo_audit.accounts_proc
2018-02-08 11:46:11,996: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:46:11,996: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:46:12,000: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:46:12,006: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:46:12,007: Acquiring new bigquery connection "all_dates".
2018-02-08 11:46:12,007: Opening a new connection (1 currently allocated)
2018-02-08 11:46:12,009: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:46:12,009: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:46:12,011: Opening a new connection (2 currently allocated)
2018-02-08 11:46:12,067: Opening a new connection (3 currently allocated)
2018-02-08 11:46:13,273: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:46:13,279: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:46:13,280: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:46:15,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003ba20>]}
2018-02-08 11:46:15,485: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003ba58>]}
2018-02-08 11:46:15,762: 11:46:15 | 2 of 37 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.47s]
2018-02-08 11:46:15,987: 11:46:15 | 1 of 37 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 3.49s]
2018-02-08 11:46:16,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110061eb8>]}
2018-02-08 11:46:16,890: 11:46:16 | 3 of 37 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 4.57s]
2018-02-08 11:46:16,891: 11:46:16 | 4 of 37 START table model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 11:46:16,892: Compiling model.seo_audit.moz_proc
2018-02-08 11:46:16,891: 11:46:16 | 5 of 37 START table model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 11:46:16,899: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:46:16,908: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:46:16,910: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:46:16,892: 11:46:16 | 6 of 37 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 11:46:16,911: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:46:16,892: 11:46:16 | 7 of 37 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 11:46:16,922: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:46:16,922: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:46:16,929: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:46:16,929: Re-using an available connection from the pool.
2018-02-08 11:46:16,937: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:46:16,938: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:46:16,939: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:46:16,939: Re-using an available connection from the pool.
2018-02-08 11:46:16,941: Re-using an available connection from the pool.
2018-02-08 11:46:16,944: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:46:16,945: Opening a new connection (4 currently allocated)
2018-02-08 11:46:17,472: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:46:17,503: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:46:17,518: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:46:18,051: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:46:18,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110065e10>]}
2018-02-08 11:46:18,819: 11:46:18 | 5 of 37 OK created table model seo_audit_dev.semrush_keyword_proc.... [CREATE TABLE in 1.67s]
2018-02-08 11:46:18,820: 11:46:18 | 8 of 37 START table model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 11:46:18,820: Compiling model.seo_audit.search_console_proc
2018-02-08 11:46:18,832: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:46:18,835: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:46:18,836: Re-using an available connection from the pool.
2018-02-08 11:46:19,386: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:46:19,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110065710>]}
2018-02-08 11:46:20,055: 11:46:20 | 4 of 37 OK created table model seo_audit_dev.moz_proc................ [CREATE TABLE in 2.82s]
2018-02-08 11:46:20,055: 11:46:20 | 9 of 37 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 11:46:20,056: Compiling model.seo_audit.ga_proc
2018-02-08 11:46:20,069: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:46:20,071: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:46:20,072: Re-using an available connection from the pool.
2018-02-08 11:46:20,305: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11009a278>]}
2018-02-08 11:46:20,522: 11:46:20 | 7 of 37 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 3.38s]
2018-02-08 11:46:20,522: 11:46:20 | 10 of 37 START table model seo_audit_dev.sitemap_proc................ [RUN]
2018-02-08 11:46:20,523: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:46:20,534: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:46:20,535: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:46:20,535: Re-using an available connection from the pool.
2018-02-08 11:46:20,748: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:46:20,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fffba20>]}
2018-02-08 11:46:21,069: 11:46:21 | 6 of 37 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 3.87s]
2018-02-08 11:46:21,070: 11:46:21 | 11 of 37 START table model seo_audit_dev.mappings_ga_proc............ [RUN]
2018-02-08 11:46:21,071: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:46:21,071: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:46:21,082: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:46:21,086: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:46:21,086: Re-using an available connection from the pool.
2018-02-08 11:46:21,590: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:46:22,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110077f60>]}
2018-02-08 11:46:22,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110065710>]}
2018-02-08 11:46:22,971: 11:46:22 | 8 of 37 OK created table model seo_audit_dev.search_console_proc..... [CREATE TABLE in 3.84s]
2018-02-08 11:46:22,973: 11:46:22 | 12 of 37 START table model seo_audit_dev.deepcrawl_class_proc........ [RUN]
2018-02-08 11:46:22,973: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:46:22,984: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:46:22,986: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:46:22,987: Re-using an available connection from the pool.
2018-02-08 11:46:23,227: 11:46:23 | 9 of 37 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 2.86s]
2018-02-08 11:46:23,228: 11:46:23 | 13 of 37 START table model seo_audit_dev.majestic_domain_proc........ [RUN]
2018-02-08 11:46:23,228: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:46:23,239: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:46:23,247: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:46:23,247: Re-using an available connection from the pool.
2018-02-08 11:46:23,606: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:46:23,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fffba20>]}
2018-02-08 11:46:23,757: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:46:24,057: 11:46:24 | 11 of 37 OK created table model seo_audit_dev.mappings_ga_proc....... [CREATE TABLE in 2.68s]
2018-02-08 11:46:24,432: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa4710>]}
2018-02-08 11:46:24,755: 11:46:24 | 10 of 37 OK created table model seo_audit_dev.sitemap_proc........... [CREATE TABLE in 3.91s]
2018-02-08 11:46:25,816: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110077f60>]}
2018-02-08 11:46:25,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11009a048>]}
2018-02-08 11:46:26,138: 11:46:26 | 12 of 37 OK created table model seo_audit_dev.deepcrawl_class_proc... [CREATE TABLE in 2.84s]
2018-02-08 11:46:26,452: 11:46:26 | 13 of 37 OK created table model seo_audit_dev.majestic_domain_proc... [CREATE TABLE in 2.69s]
2018-02-08 11:46:26,453: 11:46:26 | 14 of 37 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 11:46:26,454: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:46:26,454: 11:46:26 | 15 of 37 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 11:46:26,464: Compiling model.seo_audit.ga_stats
2018-02-08 11:46:26,464: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:46:26,454: 11:46:26 | 17 of 37 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 11:46:26,454: 11:46:26 | 16 of 37 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 11:46:26,470: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:46:26,471: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:46:26,471: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:46:26,477: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:46:26,482: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:46:26,483: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:46:26,484: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:46:26,484: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:46:26,485: Re-using an available connection from the pool.
2018-02-08 11:46:26,485: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:46:26,486: Re-using an available connection from the pool.
2018-02-08 11:46:26,489: Re-using an available connection from the pool.
2018-02-08 11:46:26,490: Re-using an available connection from the pool.
2018-02-08 11:46:27,060: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:46:27,060: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:46:27,100: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:46:27,139: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:46:28,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fff8ba8>]}
2018-02-08 11:46:28,481: 11:46:28 | 15 of 37 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 1.69s]
2018-02-08 11:46:28,482: 11:46:28 | 18 of 37 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 11:46:28,482: Compiling model.seo_audit.search_console_history
2018-02-08 11:46:28,491: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:46:28,492: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:46:28,492: Re-using an available connection from the pool.
2018-02-08 11:46:28,991: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:46:29,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003b0f0>]}
2018-02-08 11:46:29,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11009ceb8>]}
2018-02-08 11:46:29,325: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11002d7b8>]}
2018-02-08 11:46:29,483: 11:46:29 | 16 of 37 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.79s]
2018-02-08 11:46:29,794: 11:46:29 | 17 of 37 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.82s]
2018-02-08 11:46:30,086: 11:46:30 | 14 of 37 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.87s]
2018-02-08 11:46:31,179: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fff8ba8>]}
2018-02-08 11:46:31,467: 11:46:31 | 18 of 37 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.70s]
2018-02-08 11:46:31,468: 11:46:31 | 19 of 37 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 11:46:31,468: 11:46:31 | 20 of 37 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 11:46:31,469: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:46:31,468: 11:46:31 | 21 of 37 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 11:46:31,469: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:46:31,476: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:46:31,478: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:46:31,484: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:46:31,488: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:46:31,490: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:46:31,490: Re-using an available connection from the pool.
2018-02-08 11:46:31,491: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:46:31,491: Re-using an available connection from the pool.
2018-02-08 11:46:31,492: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:46:31,492: Re-using an available connection from the pool.
2018-02-08 11:46:32,078: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:46:32,079: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:46:32,128: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:46:34,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11009a0f0>]}
2018-02-08 11:46:34,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1123f1400>]}
2018-02-08 11:46:34,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa4710>]}
2018-02-08 11:46:34,456: 11:46:34 | 20 of 37 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.77s]
2018-02-08 11:46:34,759: 11:46:34 | 21 of 37 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 2.78s]
2018-02-08 11:46:35,057: 11:46:35 | 19 of 37 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 2.84s]
2018-02-08 11:46:35,058: 11:46:35 | 22 of 37 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:46:35,058: 11:46:35 | 23 of 37 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 11:46:35,059: 11:46:35 | 24 of 37 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 11:46:35,059: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:46:35,059: 11:46:35 | 25 of 37 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 11:46:35,060: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:46:35,060: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:46:35,072: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:46:35,072: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:46:35,080: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:46:35,089: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:46:35,096: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:46:35,099: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:46:35,100: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:46:35,100: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:46:35,101: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:46:35,101: Re-using an available connection from the pool.
2018-02-08 11:46:35,102: Re-using an available connection from the pool.
2018-02-08 11:46:35,103: Re-using an available connection from the pool.
2018-02-08 11:46:35,105: Re-using an available connection from the pool.
2018-02-08 11:46:36,134: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:46:36,135: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:46:36,135: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:46:36,136: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:46:37,254: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fff8ba8>]}
2018-02-08 11:46:37,269: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1123f9978>]}
2018-02-08 11:46:37,562: 11:46:37 | 22 of 37 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 2.19s]
2018-02-08 11:46:37,793: 11:46:37 | 24 of 37 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 2.21s]
2018-02-08 11:46:38,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110065a58>]}
2018-02-08 11:46:38,633: 11:46:38 | 25 of 37 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 3.26s]
2018-02-08 11:46:41,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110062128>]}
2018-02-08 11:46:41,901: 11:46:41 | 23 of 37 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 6.54s]
2018-02-08 11:46:41,902: 11:46:41 | 26 of 37 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 11:46:41,902: 11:46:41 | 27 of 37 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 11:46:41,902: 11:46:41 | 28 of 37 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:46:41,903: 11:46:41 | 29 of 37 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:46:41,903: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:46:41,903: Compiling model.seo_audit.agg_indicative
2018-02-08 11:46:41,903: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:46:41,903: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:46:41,912: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:46:41,919: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:46:41,923: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:46:41,927: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:46:41,931: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:46:41,931: Re-using an available connection from the pool.
2018-02-08 11:46:41,932: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:46:41,932: Re-using an available connection from the pool.
2018-02-08 11:46:41,933: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:46:41,933: Re-using an available connection from the pool.
2018-02-08 11:46:41,936: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:46:41,938: Re-using an available connection from the pool.
2018-02-08 11:46:42,626: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:46:42,627: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:46:42,628: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:46:42,812: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:46:43,758: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007d828>]}
2018-02-08 11:46:43,983: 11:46:43 | 29 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 1.85s]
2018-02-08 11:46:43,983: 11:46:43 | 30 of 37 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 11:46:43,983: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:46:43,992: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:46:43,993: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:46:43,993: Re-using an available connection from the pool.
2018-02-08 11:46:44,686: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:46:44,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003b0f0>]}
2018-02-08 11:46:44,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003bc50>]}
2018-02-08 11:46:45,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ffa4710>]}
2018-02-08 11:46:45,061: 11:46:45 | 28 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 2.94s]
2018-02-08 11:46:45,062: 11:46:45 | 31 of 37 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:46:45,063: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:46:45,071: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:46:45,073: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:46:45,074: Re-using an available connection from the pool.
2018-02-08 11:46:45,302: 11:46:45 | 27 of 37 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 2.94s]
2018-02-08 11:46:45,302: 11:46:45 | 32 of 37 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 11:46:45,303: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:46:45,310: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:46:45,313: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:46:45,314: Re-using an available connection from the pool.
2018-02-08 11:46:45,595: 11:46:45 | 26 of 37 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 3.10s]
2018-02-08 11:46:45,619: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:46:45,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fff8ba8>]}
2018-02-08 11:46:45,845: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:46:46,060: 11:46:46 | 30 of 37 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.78s]
2018-02-08 11:46:46,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11003b0f0>]}
2018-02-08 11:46:46,985: 11:46:46 | 31 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 1.63s]
2018-02-08 11:46:47,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007d470>]}
2018-02-08 11:46:47,301: 11:46:47 | 32 of 37 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 1.70s]
2018-02-08 11:46:47,302: 11:46:47 | 33 of 37 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 11:46:47,302: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:46:47,315: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:46:47,315: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:46:47,315: Re-using an available connection from the pool.
2018-02-08 11:46:47,948: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:46:50,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110062128>]}
2018-02-08 11:46:50,417: 11:46:50 | 33 of 37 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 2.89s]
2018-02-08 11:46:50,417: 11:46:50 | 34 of 37 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 11:46:50,418: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:46:50,427: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:46:50,428: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:46:50,428: Re-using an available connection from the pool.
2018-02-08 11:46:51,733: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:46:52,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007d470>]}
2018-02-08 11:46:53,128: 11:46:53 | 34 of 37 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 2.41s]
2018-02-08 11:46:53,129: 11:46:53 | 35 of 37 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 11:46:53,129: Compiling model.seo_audit.agg_stats
2018-02-08 11:46:53,142: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:46:53,142: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:46:53,142: Re-using an available connection from the pool.
2018-02-08 11:46:53,821: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:46:56,004: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110061668>]}
2018-02-08 11:46:56,301: 11:46:56 | 35 of 37 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.88s]
2018-02-08 11:46:56,302: 11:46:56 | 36 of 37 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 11:46:56,302: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:46:56,310: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:46:56,311: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:46:56,311: Re-using an available connection from the pool.
2018-02-08 11:46:56,899: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:46:59,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11007d470>]}
2018-02-08 11:46:59,379: 11:46:59 | 36 of 37 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 2.76s]
2018-02-08 11:46:59,380: 11:46:59 | 37 of 37 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 11:46:59,380: Compiling model.seo_audit.agg_all
2018-02-08 11:46:59,390: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:46:59,391: Acquiring new bigquery connection "agg_all".
2018-02-08 11:46:59,391: Re-using an available connection from the pool.
2018-02-08 11:46:59,926: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:47:01,022: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
(sessions_30d-sessions_mom)/sessions_mom  sessions_mom_pct,
(leads_30d-leads_mom)/leads_mom  leads_mom_pct,
(transactions_30d-transactions_mom)/transactions_mom  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
(sessions_30d-sessions_yoy)/sessions_yoy  sessions_yoy_pct,
(leads_30d-leads_yoy)/leads_yoy  leads_yoy_pct,
(transactions_30d-transactions_yoy)/transactions_yoy  transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:47:01,022: 400 division by zero
2018-02-08 11:47:01,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c10ae3e9-837d-4503-8217-12793c95abe5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110061908>]}
2018-02-08 11:47:01,324: 11:47:01 | 37 of 37 ERROR creating table model seo_audit_dev.agg_all............ [ERROR in 1.64s]
2018-02-08 11:47:01,366: 11:47:01 | 
2018-02-08 11:47:01,366: 11:47:01 | Finished running 37 table models in 49.59s.
2018-02-08 11:47:01,366: Connection 'master' was left open.
2018-02-08 11:47:01,367: 
2018-02-08 11:47:01,367: Completed with 1 errors:
2018-02-08 11:47:01,367: 
2018-02-08 11:47:01,368: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-08 11:47:01,368:   division by zero
2018-02-08 11:47:01,368:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-08 11:47:01,368: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 11:47:01,369: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fece7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fece550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fece630>]}
2018-02-08 11:47:01,650: Flushing usage events
2018-02-08 11:49:11,198: Tracking: tracking
2018-02-08 11:49:11,201: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045b3668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045b34a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045b3b00>]}
2018-02-08 11:49:11,913: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:49:11,944: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:49:11,949: Parsing core.sql
2018-02-08 11:49:11,974: Parsing adapters/bigquery.sql
2018-02-08 11:49:11,984: Parsing adapters/common.sql
2018-02-08 11:49:12,006: Parsing adapters/postgres.sql
2018-02-08 11:49:12,013: Parsing adapters/redshift.sql
2018-02-08 11:49:12,049: Parsing etc/get_custom_schema.sql
2018-02-08 11:49:12,060: Parsing materializations/archive.sql
2018-02-08 11:49:12,112: Parsing materializations/bigquery.sql
2018-02-08 11:49:12,142: Parsing materializations/helpers.sql
2018-02-08 11:49:12,180: Parsing materializations/incremental.sql
2018-02-08 11:49:12,242: Parsing materializations/table.sql
2018-02-08 11:49:12,291: Parsing materializations/view.sql
2018-02-08 11:49:12,330: Parsing materializations/wrapper.sql
2018-02-08 11:49:12,340: Parsing schema_tests/accepted_values.sql
2018-02-08 11:49:12,349: Parsing schema_tests/not_null.sql
2018-02-08 11:49:12,354: Parsing schema_tests/relationships.sql
2018-02-08 11:49:12,362: Parsing schema_tests/unique.sql
2018-02-08 11:49:12,419: Parsing model.seo_audit.accounts_proc
2018-02-08 11:49:12,425: Parsing model.seo_audit.all_dates
2018-02-08 11:49:12,427: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:49:12,432: Acquiring new bigquery connection "master".
2018-02-08 11:49:12,432: Opening a new connection (0 currently allocated)
2018-02-08 11:49:12,441: Parsing model.seo_audit.agg_all
2018-02-08 11:49:12,447: Parsing model.seo_audit.agg_indicative
2018-02-08 11:49:12,452: Parsing model.seo_audit.agg_stats
2018-02-08 11:49:12,463: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:49:12,470: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:49:12,474: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:49:12,478: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:49:12,480: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:49:12,484: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:49:12,488: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:49:12,493: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:49:12,496: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:49:12,502: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:49:12,516: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:49:12,522: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:49:12,524: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:49:12,528: Parsing model.seo_audit.ga_proc
2018-02-08 11:49:12,534: Parsing model.seo_audit.ga_stats
2018-02-08 11:49:12,539: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:49:12,544: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:49:12,549: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:49:12,554: Parsing model.seo_audit.moz_proc
2018-02-08 11:49:12,557: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:49:12,563: Parsing model.seo_audit.search_console_history
2018-02-08 11:49:12,568: Parsing model.seo_audit.search_console_proc
2018-02-08 11:49:12,573: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:49:12,595: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:49:12,608: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:49:12,614: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:49:12,621: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:49:12,626: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:49:12,631: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:49:12,635: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:49:12,640: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:49:12,676: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:49:12,719: 
2018-02-08 11:49:14,198: 11:49:14 | Concurrency: 4 threads (target='dev')
2018-02-08 11:49:14,198: 11:49:14 | 
2018-02-08 11:49:14,472: 11:49:14 | 1 of 37 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 11:49:14,473: 11:49:14 | 2 of 37 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 11:49:14,473: Compiling model.seo_audit.all_dates
2018-02-08 11:49:14,473: 11:49:14 | 3 of 37 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 11:49:14,473: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:49:14,479: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:49:14,479: Compiling model.seo_audit.accounts_proc
2018-02-08 11:49:14,486: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:49:14,493: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:49:14,494: Acquiring new bigquery connection "all_dates".
2018-02-08 11:49:14,494: Opening a new connection (1 currently allocated)
2018-02-08 11:49:14,497: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:49:14,499: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:49:14,585: Opening a new connection (2 currently allocated)
2018-02-08 11:49:14,592: Opening a new connection (3 currently allocated)
2018-02-08 11:49:15,910: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:49:15,915: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:49:15,998: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:49:17,106: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104798e80>]}
2018-02-08 11:49:17,336: 11:49:17 | 1 of 37 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 2.63s]
2018-02-08 11:49:18,081: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047586d8>]}
2018-02-08 11:49:18,193: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047582b0>]}
2018-02-08 11:49:18,372: 11:49:18 | 3 of 37 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.60s]
2018-02-08 11:49:18,586: 11:49:18 | 2 of 37 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.72s]
2018-02-08 11:49:18,587: 11:49:18 | 4 of 37 START table model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 11:49:18,588: Compiling model.seo_audit.moz_proc
2018-02-08 11:49:18,587: 11:49:18 | 5 of 37 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 11:49:18,594: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:49:18,588: 11:49:18 | 6 of 37 START table model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 11:49:18,603: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:49:18,588: 11:49:18 | 7 of 37 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 11:49:18,614: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:49:18,614: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:49:18,613: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:49:18,637: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:49:18,642: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:49:18,644: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:49:18,645: Re-using an available connection from the pool.
2018-02-08 11:49:18,646: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:49:18,649: Re-using an available connection from the pool.
2018-02-08 11:49:18,648: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:49:18,653: Re-using an available connection from the pool.
2018-02-08 11:49:18,665: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:49:18,667: Opening a new connection (4 currently allocated)
2018-02-08 11:49:19,196: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:49:19,229: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:49:19,246: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:49:19,549: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:49:21,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047589e8>]}
2018-02-08 11:49:21,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012e3fd0>]}
2018-02-08 11:49:21,432: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047657b8>]}
2018-02-08 11:49:21,657: 11:49:21 | 5 of 37 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 2.81s]
2018-02-08 11:49:21,657: 11:49:21 | 8 of 37 START table model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 11:49:21,658: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:49:21,672: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:49:21,675: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:49:21,676: Re-using an available connection from the pool.
2018-02-08 11:49:21,727: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a3dd8>]}
2018-02-08 11:49:22,007: 11:49:22 | 4 of 37 OK created table model seo_audit_dev.moz_proc................ [CREATE TABLE in 2.83s]
2018-02-08 11:49:22,008: 11:49:22 | 9 of 37 START table model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 11:49:22,008: Compiling model.seo_audit.search_console_proc
2018-02-08 11:49:22,017: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:49:22,022: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:49:22,022: Re-using an available connection from the pool.
2018-02-08 11:49:22,237: 11:49:22 | 7 of 37 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 2.82s]
2018-02-08 11:49:22,242: 11:49:22 | 10 of 37 START table model seo_audit_dev.sitemap_proc................ [RUN]
2018-02-08 11:49:22,245: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:49:22,268: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:49:22,270: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:49:22,271: Re-using an available connection from the pool.
2018-02-08 11:49:22,427: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:49:22,486: 11:49:22 | 6 of 37 OK created table model seo_audit_dev.majestic_domain_proc.... [CREATE TABLE in 3.11s]
2018-02-08 11:49:22,486: 11:49:22 | 11 of 37 START table model seo_audit_dev.semrush_keyword_proc........ [RUN]
2018-02-08 11:49:22,487: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:49:22,504: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:49:22,506: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:49:22,506: Re-using an available connection from the pool.
2018-02-08 11:49:22,519: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:49:22,807: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:49:23,098: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:49:24,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012f50f0>]}
2018-02-08 11:49:24,788: 11:49:24 | 8 of 37 OK created table model seo_audit_dev.mappings_ga_proc........ [CREATE TABLE in 2.93s]
2018-02-08 11:49:24,789: 11:49:24 | 12 of 37 START table model seo_audit_dev.deepcrawl_class_proc........ [RUN]
2018-02-08 11:49:24,789: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:49:24,796: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:49:24,797: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:49:24,797: Re-using an available connection from the pool.
2018-02-08 11:49:24,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:49:25,217: 11:49:25 | 10 of 37 OK created table model seo_audit_dev.sitemap_proc........... [CREATE TABLE in 2.72s]
2018-02-08 11:49:25,217: 11:49:25 | 13 of 37 START table model seo_audit_dev.ga_proc..................... [RUN]
2018-02-08 11:49:25,218: Compiling model.seo_audit.ga_proc
2018-02-08 11:49:25,227: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:49:25,229: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:49:25,229: Re-using an available connection from the pool.
2018-02-08 11:49:25,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f0f28>]}
2018-02-08 11:49:25,335: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:49:25,528: 11:49:25 | 11 of 37 OK created table model seo_audit_dev.semrush_keyword_proc... [CREATE TABLE in 2.79s]
2018-02-08 11:49:25,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012e3fd0>]}
2018-02-08 11:49:25,775: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:49:26,058: 11:49:26 | 9 of 37 OK created table model seo_audit_dev.search_console_proc..... [CREATE TABLE in 3.75s]
2018-02-08 11:49:27,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012f50f0>]}
2018-02-08 11:49:27,726: 11:49:27 | 12 of 37 OK created table model seo_audit_dev.deepcrawl_class_proc... [CREATE TABLE in 2.72s]
2018-02-08 11:49:27,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:49:28,251: 11:49:28 | 13 of 37 OK created table model seo_audit_dev.ga_proc................ [CREATE TABLE in 2.73s]
2018-02-08 11:49:28,253: 11:49:28 | 14 of 37 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 11:49:28,254: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:49:28,253: 11:49:28 | 15 of 37 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 11:49:28,261: Compiling model.seo_audit.ga_stats
2018-02-08 11:49:28,253: 11:49:28 | 16 of 37 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 11:49:28,268: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:49:28,271: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:49:28,272: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:49:28,254: 11:49:28 | 17 of 37 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 11:49:28,279: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:49:28,279: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:49:28,280: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:49:28,293: Re-using an available connection from the pool.
2018-02-08 11:49:28,292: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:49:28,310: Re-using an available connection from the pool.
2018-02-08 11:49:28,293: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:49:28,317: Re-using an available connection from the pool.
2018-02-08 11:49:28,304: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:49:28,332: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:49:28,332: Re-using an available connection from the pool.
2018-02-08 11:49:28,834: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:49:28,868: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:49:28,874: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:49:28,958: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:49:29,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047b51d0>]}
2018-02-08 11:49:30,128: 11:49:30 | 15 of 37 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 1.65s]
2018-02-08 11:49:30,128: 11:49:30 | 18 of 37 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 11:49:30,128: Compiling model.seo_audit.search_console_history
2018-02-08 11:49:30,133: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:49:30,133: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:49:30,133: Re-using an available connection from the pool.
2018-02-08 11:49:30,709: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:49:31,026: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1011db6a0>]}
2018-02-08 11:49:31,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104797518>]}
2018-02-08 11:49:31,130: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a3208>]}
2018-02-08 11:49:31,240: 11:49:31 | 14 of 37 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.77s]
2018-02-08 11:49:31,528: 11:49:31 | 16 of 37 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.76s]
2018-02-08 11:49:31,798: 11:49:31 | 17 of 37 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.85s]
2018-02-08 11:49:32,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047b8dd8>]}
2018-02-08 11:49:33,206: 11:49:33 | 18 of 37 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.77s]
2018-02-08 11:49:33,208: 11:49:33 | 19 of 37 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 11:49:33,208: 11:49:33 | 20 of 37 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 11:49:33,209: 11:49:33 | 21 of 37 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 11:49:33,210: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:49:33,211: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:49:33,212: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:49:33,293: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:49:33,291: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:49:33,303: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:49:33,305: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:49:33,307: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:49:33,307: Re-using an available connection from the pool.
2018-02-08 11:49:33,308: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:49:33,315: Re-using an available connection from the pool.
2018-02-08 11:49:33,319: Re-using an available connection from the pool.
2018-02-08 11:49:34,012: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:49:34,013: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:49:34,513: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:49:35,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:49:35,696: 11:49:35 | 19 of 37 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 2.26s]
2018-02-08 11:49:36,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047dc518>]}
2018-02-08 11:49:36,444: 11:49:36 | 20 of 37 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.96s]
2018-02-08 11:49:38,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10134fbe0>]}
2018-02-08 11:49:38,619: 11:49:38 | 21 of 37 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 5.07s]
2018-02-08 11:49:38,625: 11:49:38 | 22 of 37 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 11:49:38,626: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:49:38,641: 11:49:38 | 23 of 37 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:49:38,642: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:49:38,647: 11:49:38 | 24 of 37 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 11:49:38,647: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:49:38,667: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:49:38,679: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:49:38,676: 11:49:38 | 25 of 37 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 11:49:38,680: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:49:38,688: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:49:38,688: Re-using an available connection from the pool.
2018-02-08 11:49:38,700: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:49:38,701: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:49:38,704: Re-using an available connection from the pool.
2018-02-08 11:49:38,703: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:49:38,716: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:49:38,716: Re-using an available connection from the pool.
2018-02-08 11:49:38,725: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:49:38,725: Re-using an available connection from the pool.
2018-02-08 11:49:39,214: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:49:39,220: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:49:39,298: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:49:39,309: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:49:41,480: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a39e8>]}
2018-02-08 11:49:41,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a38d0>]}
2018-02-08 11:49:41,515: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a3cf8>]}
2018-02-08 11:49:41,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a3438>]}
2018-02-08 11:49:41,733: 11:49:41 | 25 of 37 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 2.80s]
2018-02-08 11:49:41,955: 11:49:41 | 22 of 37 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 2.88s]
2018-02-08 11:49:42,231: 11:49:42 | 23 of 37 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 2.87s]
2018-02-08 11:49:42,540: 11:49:42 | 24 of 37 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 3.00s]
2018-02-08 11:49:42,541: 11:49:42 | 26 of 37 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:49:42,542: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:49:42,548: 11:49:42 | 27 of 37 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 11:49:42,554: Compiling model.seo_audit.agg_indicative
2018-02-08 11:49:42,560: 11:49:42 | 28 of 37 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:49:42,561: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:49:42,565: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:49:42,572: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:49:42,566: 11:49:42 | 29 of 37 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:49:42,580: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:49:42,580: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:49:42,583: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:49:42,589: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:49:42,593: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:49:42,594: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:49:42,595: Re-using an available connection from the pool.
2018-02-08 11:49:42,596: Re-using an available connection from the pool.
2018-02-08 11:49:42,597: Re-using an available connection from the pool.
2018-02-08 11:49:42,602: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:49:42,602: Re-using an available connection from the pool.
2018-02-08 11:49:43,171: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:49:43,173: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:49:43,200: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:49:43,261: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:49:44,265: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047b1eb8>]}
2018-02-08 11:49:44,476: 11:49:44 | 28 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 1.70s]
2018-02-08 11:49:44,476: 11:49:44 | 30 of 37 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 11:49:44,476: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:49:44,485: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:49:44,486: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:49:44,486: Re-using an available connection from the pool.
2018-02-08 11:49:45,071: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:49:45,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047dc588>]}
2018-02-08 11:49:45,689: 11:49:45 | 26 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 2.83s]
2018-02-08 11:49:45,690: 11:49:45 | 31 of 37 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 11:49:45,690: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:49:45,700: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:49:45,701: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:49:45,701: Re-using an available connection from the pool.
2018-02-08 11:49:46,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047b1eb8>]}
2018-02-08 11:49:46,352: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:49:46,443: 11:49:46 | 30 of 37 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.67s]
2018-02-08 11:49:46,443: 11:49:46 | 32 of 37 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 11:49:46,445: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:49:46,460: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:49:46,465: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:49:46,466: Re-using an available connection from the pool.
2018-02-08 11:49:46,535: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f0390>]}
2018-02-08 11:49:46,751: 11:49:46 | 29 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 3.95s]
2018-02-08 11:49:46,968: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:49:47,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047d9128>]}
2018-02-08 11:49:47,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047b1e80>]}
2018-02-08 11:49:47,672: 11:49:47 | 31 of 37 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 1.75s]
2018-02-08 11:49:47,886: 11:49:47 | 27 of 37 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 4.93s]
2018-02-08 11:49:48,058: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:49:48,390: 11:49:48 | 32 of 37 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 1.61s]
2018-02-08 11:49:48,391: 11:49:48 | 33 of 37 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 11:49:48,391: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:49:48,423: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:49:48,424: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:49:48,424: Re-using an available connection from the pool.
2018-02-08 11:49:49,014: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:49:52,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012e3fd0>]}
2018-02-08 11:49:52,516: 11:49:52 | 33 of 37 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 3.86s]
2018-02-08 11:49:52,516: 11:49:52 | 34 of 37 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 11:49:52,517: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:49:52,524: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:49:52,525: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:49:52,525: Re-using an available connection from the pool.
2018-02-08 11:49:52,999: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:49:54,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:49:54,378: 11:49:54 | 34 of 37 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 1.56s]
2018-02-08 11:49:54,379: 11:49:54 | 35 of 37 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 11:49:54,379: Compiling model.seo_audit.agg_stats
2018-02-08 11:49:54,389: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:49:54,390: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:49:54,390: Re-using an available connection from the pool.
2018-02-08 11:49:54,944: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:49:57,099: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012e3fd0>]}
2018-02-08 11:49:57,387: 11:49:57 | 35 of 37 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.72s]
2018-02-08 11:49:57,388: 11:49:57 | 36 of 37 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 11:49:57,388: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:49:57,394: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:49:57,395: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:49:57,395: Re-using an available connection from the pool.
2018-02-08 11:49:57,915: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:50:00,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f4be0>]}
2018-02-08 11:50:00,850: 11:50:00 | 36 of 37 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 3.16s]
2018-02-08 11:50:00,850: 11:50:00 | 37 of 37 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 11:50:00,850: Compiling model.seo_audit.agg_all
2018-02-08 11:50:00,857: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:50:00,858: Acquiring new bigquery connection "agg_all".
2018-02-08 11:50:00,858: Re-using an available connection from the pool.
2018-02-08 11:50:01,175: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null sessions_mom_pct,
case when leads_mom > 0 (leads_30d-leads_mom)/leads_mom else null leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null  leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:50:01,175: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null sessions_mom_pct,
case when leads_mom > 0 (leads_30d-leads_mom)/leads_mom else null leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null  transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null  leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:50:01,175: 400 Syntax error: Unexpected identifier "sessions_mom_pct" at [38:84]
2018-02-08 11:50:01,176: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9db77835-4a94-443e-a682-e824268e3153', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047a3e48>]}
2018-02-08 11:50:01,490: 11:50:01 | 37 of 37 ERROR creating table model seo_audit_dev.agg_all............ [ERROR in 0.33s]
2018-02-08 11:50:01,567: 11:50:01 | 
2018-02-08 11:50:01,567: 11:50:01 | Finished running 37 table models in 47.38s.
2018-02-08 11:50:01,567: Connection 'master' was left open.
2018-02-08 11:50:01,568: 
2018-02-08 11:50:01,569: Completed with 1 errors:
2018-02-08 11:50:01,569: 
2018-02-08 11:50:01,569: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-08 11:50:01,569:   Syntax error: Unexpected identifier "sessions_mom_pct" at [38:84]
2018-02-08 11:50:01,570:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-08 11:50:01,570: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 11:50:01,571: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012d0748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012d08d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1012d0780>]}
2018-02-08 11:50:01,811: Flushing usage events
2018-02-08 11:50:47,126: Tracking: tracking
2018-02-08 11:50:47,129: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b3ab278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b3abe80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b3aefd0>]}
2018-02-08 11:50:47,962: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:50:47,979: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:50:47,985: Parsing core.sql
2018-02-08 11:50:48,005: Parsing adapters/bigquery.sql
2018-02-08 11:50:48,012: Parsing adapters/common.sql
2018-02-08 11:50:48,029: Parsing adapters/postgres.sql
2018-02-08 11:50:48,035: Parsing adapters/redshift.sql
2018-02-08 11:50:48,055: Parsing etc/get_custom_schema.sql
2018-02-08 11:50:48,067: Parsing materializations/archive.sql
2018-02-08 11:50:48,105: Parsing materializations/bigquery.sql
2018-02-08 11:50:48,121: Parsing materializations/helpers.sql
2018-02-08 11:50:48,145: Parsing materializations/incremental.sql
2018-02-08 11:50:48,174: Parsing materializations/table.sql
2018-02-08 11:50:48,200: Parsing materializations/view.sql
2018-02-08 11:50:48,220: Parsing materializations/wrapper.sql
2018-02-08 11:50:48,228: Parsing schema_tests/accepted_values.sql
2018-02-08 11:50:48,237: Parsing schema_tests/not_null.sql
2018-02-08 11:50:48,242: Parsing schema_tests/relationships.sql
2018-02-08 11:50:48,250: Parsing schema_tests/unique.sql
2018-02-08 11:50:48,305: Parsing model.seo_audit.accounts_proc
2018-02-08 11:50:48,308: Parsing model.seo_audit.all_dates
2018-02-08 11:50:48,310: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:50:48,312: Acquiring new bigquery connection "master".
2018-02-08 11:50:48,312: Opening a new connection (0 currently allocated)
2018-02-08 11:50:48,316: Parsing model.seo_audit.agg_all
2018-02-08 11:50:48,319: Parsing model.seo_audit.agg_indicative
2018-02-08 11:50:48,321: Parsing model.seo_audit.agg_stats
2018-02-08 11:50:48,326: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:50:48,329: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:50:48,332: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:50:48,336: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:50:48,339: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:50:48,343: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:50:48,345: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:50:48,348: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:50:48,350: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:50:48,352: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:50:48,358: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:50:48,360: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:50:48,362: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:50:48,364: Parsing model.seo_audit.ga_proc
2018-02-08 11:50:48,366: Parsing model.seo_audit.ga_stats
2018-02-08 11:50:48,368: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:50:48,370: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:50:48,373: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:50:48,375: Parsing model.seo_audit.moz_proc
2018-02-08 11:50:48,377: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:50:48,380: Parsing model.seo_audit.search_console_history
2018-02-08 11:50:48,382: Parsing model.seo_audit.search_console_proc
2018-02-08 11:50:48,384: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:50:48,387: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:50:48,388: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:50:48,391: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:50:48,394: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:50:48,397: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:50:48,399: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:50:48,401: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:50:48,403: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:50:48,415: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:50:48,424: 
2018-02-08 11:50:49,219: 11:50:49 | Concurrency: 4 threads (target='dev')
2018-02-08 11:50:49,219: 11:50:49 | 
2018-02-08 11:50:49,478: 11:50:49 | 1 of 37 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 11:50:49,478: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:50:49,484: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:50:49,478: 11:50:49 | 2 of 37 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 11:50:49,484: Compiling model.seo_audit.accounts_proc
2018-02-08 11:50:49,478: 11:50:49 | 3 of 37 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 11:50:49,491: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:50:49,491: Compiling model.seo_audit.all_dates
2018-02-08 11:50:49,497: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:50:49,499: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:50:49,500: Opening a new connection (1 currently allocated)
2018-02-08 11:50:49,500: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:50:49,509: Acquiring new bigquery connection "all_dates".
2018-02-08 11:50:49,509: Opening a new connection (2 currently allocated)
2018-02-08 11:50:49,566: Opening a new connection (3 currently allocated)
2018-02-08 11:50:50,687: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:50:50,697: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:50:50,721: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:50:52,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b58bf28>]}
2018-02-08 11:50:52,894: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809128>]}
2018-02-08 11:50:52,904: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b570320>]}
2018-02-08 11:50:53,195: 11:50:53 | 2 of 37 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.40s]
2018-02-08 11:50:53,450: 11:50:53 | 3 of 37 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 3.40s]
2018-02-08 11:50:53,707: 11:50:53 | 1 of 37 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.43s]
2018-02-08 11:50:53,708: 11:50:53 | 4 of 37 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 11:50:53,709: Compiling model.seo_audit.ga_proc
2018-02-08 11:50:53,709: 11:50:53 | 5 of 37 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 11:50:53,716: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:50:53,709: 11:50:53 | 6 of 37 START table model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 11:50:53,724: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:50:53,726: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:50:53,709: 11:50:53 | 7 of 37 START table model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 11:50:53,726: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:50:53,727: Compiling model.seo_audit.moz_proc
2018-02-08 11:50:53,732: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:50:53,737: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:50:53,738: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:50:53,739: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:50:53,740: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:50:53,740: Re-using an available connection from the pool.
2018-02-08 11:50:53,741: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:50:53,742: Re-using an available connection from the pool.
2018-02-08 11:50:53,749: Re-using an available connection from the pool.
2018-02-08 11:50:53,752: Opening a new connection (4 currently allocated)
2018-02-08 11:50:54,333: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:50:54,392: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:50:54,422: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:50:54,926: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:50:56,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5700b8>]}
2018-02-08 11:50:56,571: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b549518>]}
2018-02-08 11:50:56,585: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b570390>]}
2018-02-08 11:50:56,772: 11:50:56 | 4 of 37 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 2.85s]
2018-02-08 11:50:56,773: 11:50:56 | 8 of 37 START table model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 11:50:56,773: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:50:56,785: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:50:56,788: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:50:56,789: Re-using an available connection from the pool.
2018-02-08 11:50:57,088: 11:50:57 | 6 of 37 OK created table model seo_audit_dev.majestic_domain_proc.... [CREATE TABLE in 2.85s]
2018-02-08 11:50:57,091: 11:50:57 | 9 of 37 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 11:50:57,092: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:50:57,103: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:50:57,104: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:50:57,104: Re-using an available connection from the pool.
2018-02-08 11:50:57,247: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b58bd68>]}
2018-02-08 11:50:57,312: 11:50:57 | 5 of 37 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 2.87s]
2018-02-08 11:50:57,312: 11:50:57 | 10 of 37 START table model seo_audit_dev.mappings_ga_proc............ [RUN]
2018-02-08 11:50:57,319: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:50:57,327: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:50:57,330: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:50:57,330: Re-using an available connection from the pool.
2018-02-08 11:50:57,344: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:50:57,625: 11:50:57 | 7 of 37 OK created table model seo_audit_dev.moz_proc................ [CREATE TABLE in 3.52s]
2018-02-08 11:50:57,625: 11:50:57 | 11 of 37 START table model seo_audit_dev.semrush_keyword_proc........ [RUN]
2018-02-08 11:50:57,625: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:50:57,633: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:50:57,634: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:50:57,634: Re-using an available connection from the pool.
2018-02-08 11:50:57,668: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:50:58,072: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:50:58,257: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:50:59,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5700b8>]}
2018-02-08 11:50:59,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b58bcc0>]}
2018-02-08 11:50:59,853: 11:50:59 | 8 of 37 OK created table model seo_audit_dev.deepcrawl_class_proc.... [CREATE TABLE in 2.77s]
2018-02-08 11:50:59,854: 11:50:59 | 12 of 37 START table model seo_audit_dev.sitemap_proc................ [RUN]
2018-02-08 11:50:59,856: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:50:59,868: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:50:59,870: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:50:59,870: Re-using an available connection from the pool.
2018-02-08 11:51:00,174: 11:51:00 | 9 of 37 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 2.73s]
2018-02-08 11:51:00,182: 11:51:00 | 13 of 37 START table model seo_audit_dev.search_console_proc......... [RUN]
2018-02-08 11:51:00,182: Compiling model.seo_audit.search_console_proc
2018-02-08 11:51:00,191: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:51:00,196: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:51:00,196: Re-using an available connection from the pool.
2018-02-08 11:51:00,306: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809978>]}
2018-02-08 11:51:00,385: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:51:00,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809be0>]}
2018-02-08 11:51:00,627: 11:51:00 | 10 of 37 OK created table model seo_audit_dev.mappings_ga_proc....... [CREATE TABLE in 2.99s]
2018-02-08 11:51:00,835: 11:51:00 | 11 of 37 OK created table model seo_audit_dev.semrush_keyword_proc... [CREATE TABLE in 2.81s]
2018-02-08 11:51:00,902: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:51:02,591: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108817cf8>]}
2018-02-08 11:51:03,111: 11:51:03 | 12 of 37 OK created table model seo_audit_dev.sitemap_proc........... [CREATE TABLE in 2.74s]
2018-02-08 11:51:04,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809a20>]}
2018-02-08 11:51:04,451: 11:51:04 | 13 of 37 OK created table model seo_audit_dev.search_console_proc.... [CREATE TABLE in 3.97s]
2018-02-08 11:51:04,452: 11:51:04 | 14 of 37 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 11:51:04,453: 11:51:04 | 15 of 37 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 11:51:04,453: 11:51:04 | 16 of 37 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 11:51:04,454: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:51:04,453: 11:51:04 | 17 of 37 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 11:51:04,454: Compiling model.seo_audit.search_console_history
2018-02-08 11:51:04,454: Compiling model.seo_audit.ga_stats
2018-02-08 11:51:04,463: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:51:04,463: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:51:04,472: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:51:04,477: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:51:04,482: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:51:04,484: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:51:04,484: Re-using an available connection from the pool.
2018-02-08 11:51:04,485: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:51:04,485: Re-using an available connection from the pool.
2018-02-08 11:51:04,487: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:51:04,488: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:51:04,493: Re-using an available connection from the pool.
2018-02-08 11:51:04,495: Re-using an available connection from the pool.
2018-02-08 11:51:05,056: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:51:05,073: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:51:05,107: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:51:05,161: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:51:07,230: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4e63c8>]}
2018-02-08 11:51:07,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b58bb70>]}
2018-02-08 11:51:07,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883b438>]}
2018-02-08 11:51:07,389: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883b160>]}
2018-02-08 11:51:07,445: 11:51:07 | 14 of 37 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.78s]
2018-02-08 11:51:07,446: 11:51:07 | 18 of 37 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 11:51:07,448: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:51:07,460: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:51:07,462: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:51:07,462: Re-using an available connection from the pool.
2018-02-08 11:51:07,781: 11:51:07 | 16 of 37 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 2.80s]
2018-02-08 11:51:08,009: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:51:08,084: 11:51:08 | 15 of 37 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.83s]
2018-02-08 11:51:08,375: 11:51:08 | 17 of 37 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.93s]
2018-02-08 11:51:09,096: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4e63c8>]}
2018-02-08 11:51:09,383: 11:51:09 | 18 of 37 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 1.65s]
2018-02-08 11:51:09,384: 11:51:09 | 19 of 37 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 11:51:09,385: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:51:09,384: 11:51:09 | 20 of 37 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 11:51:09,391: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:51:09,402: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:51:09,385: 11:51:09 | 21 of 37 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 11:51:09,405: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:51:09,405: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:51:09,406: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:51:09,410: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:51:09,412: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:51:09,412: Re-using an available connection from the pool.
2018-02-08 11:51:09,414: Re-using an available connection from the pool.
2018-02-08 11:51:09,415: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:51:09,416: Re-using an available connection from the pool.
2018-02-08 11:51:09,952: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:51:09,968: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:51:09,969: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:51:12,177: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883b240>]}
2018-02-08 11:51:12,200: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5705f8>]}
2018-02-08 11:51:12,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809a20>]}
2018-02-08 11:51:12,463: 11:51:12 | 20 of 37 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 2.79s]
2018-02-08 11:51:12,672: 11:51:12 | 21 of 37 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 2.79s]
2018-02-08 11:51:12,964: 11:51:12 | 19 of 37 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.84s]
2018-02-08 11:51:12,965: 11:51:12 | 22 of 37 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 11:51:12,965: 11:51:12 | 23 of 37 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:51:12,965: 11:51:12 | 24 of 37 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 11:51:12,966: 11:51:12 | 25 of 37 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 11:51:12,966: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:51:12,966: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:51:12,966: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:51:12,966: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:51:12,981: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:51:12,982: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:51:12,987: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:51:12,993: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:51:12,994: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:51:12,995: Re-using an available connection from the pool.
2018-02-08 11:51:12,995: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:51:12,998: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:51:12,998: Re-using an available connection from the pool.
2018-02-08 11:51:12,999: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:51:13,000: Re-using an available connection from the pool.
2018-02-08 11:51:13,002: Re-using an available connection from the pool.
2018-02-08 11:51:13,691: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:51:13,693: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:51:13,694: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:51:13,694: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:51:14,789: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4e63c8>]}
2018-02-08 11:51:15,015: 11:51:15 | 22 of 37 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 1.82s]
2018-02-08 11:51:15,867: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47ca20>]}
2018-02-08 11:51:15,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b595400>]}
2018-02-08 11:51:15,889: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b516b38>]}
2018-02-08 11:51:16,089: 11:51:16 | 23 of 37 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 2.90s]
2018-02-08 11:51:16,380: 11:51:16 | 24 of 37 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 2.91s]
2018-02-08 11:51:16,687: 11:51:16 | 25 of 37 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 2.92s]
2018-02-08 11:51:16,688: 11:51:16 | 26 of 37 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:51:16,689: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:51:16,688: 11:51:16 | 27 of 37 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 11:51:16,696: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:51:16,689: 11:51:16 | 28 of 37 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:51:16,703: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:51:16,705: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:51:16,689: 11:51:16 | 29 of 37 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 11:51:16,705: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:51:16,706: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:51:16,710: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:51:16,711: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:51:16,716: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:51:16,717: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:51:16,717: Re-using an available connection from the pool.
2018-02-08 11:51:16,718: Re-using an available connection from the pool.
2018-02-08 11:51:16,718: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:51:16,720: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:51:16,721: Re-using an available connection from the pool.
2018-02-08 11:51:16,726: Re-using an available connection from the pool.
2018-02-08 11:51:17,370: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:51:17,371: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:51:17,371: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:51:17,372: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:51:18,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5815c0>]}
2018-02-08 11:51:18,485: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5702e8>]}
2018-02-08 11:51:19,056: 11:51:19 | 26 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 1.78s]
2018-02-08 11:51:19,058: 11:51:19 | 30 of 37 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 11:51:19,058: Compiling model.seo_audit.agg_indicative
2018-02-08 11:51:19,070: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:51:19,074: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:51:19,074: Re-using an available connection from the pool.
2018-02-08 11:51:19,290: 11:51:19 | 27 of 37 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 1.79s]
2018-02-08 11:51:19,290: 11:51:19 | 31 of 37 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:51:19,290: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:51:19,299: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:51:19,302: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:51:19,304: Re-using an available connection from the pool.
2018-02-08 11:51:19,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809a20>]}
2018-02-08 11:51:19,604: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108809978>]}
2018-02-08 11:51:19,625: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:51:19,821: 11:51:19 | 28 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 2.86s]
2018-02-08 11:51:19,822: 11:51:19 | 32 of 37 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 11:51:19,822: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:51:19,830: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:51:19,834: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:51:19,834: Re-using an available connection from the pool.
2018-02-08 11:51:19,852: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:51:20,048: 11:51:20 | 29 of 37 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 2.90s]
2018-02-08 11:51:20,640: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:51:21,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5491d0>]}
2018-02-08 11:51:21,838: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5815c0>]}
2018-02-08 11:51:22,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5880b8>]}
2018-02-08 11:51:22,048: 11:51:22 | 32 of 37 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.94s]
2018-02-08 11:51:22,280: 11:51:22 | 30 of 37 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 2.78s]
2018-02-08 11:51:22,801: 11:51:22 | 31 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 2.74s]
2018-02-08 11:51:22,802: 11:51:22 | 33 of 37 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 11:51:22,802: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:51:22,821: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:51:22,822: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:51:22,822: Re-using an available connection from the pool.
2018-02-08 11:51:23,606: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:51:26,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47ca20>]}
2018-02-08 11:51:27,153: 11:51:27 | 33 of 37 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 4.06s]
2018-02-08 11:51:27,154: 11:51:27 | 34 of 37 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 11:51:27,154: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:51:27,163: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:51:27,164: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:51:27,165: Re-using an available connection from the pool.
2018-02-08 11:51:27,807: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:51:28,902: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5880b8>]}
2018-02-08 11:51:29,193: 11:51:29 | 34 of 37 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 1.75s]
2018-02-08 11:51:29,194: 11:51:29 | 35 of 37 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 11:51:29,194: Compiling model.seo_audit.agg_stats
2018-02-08 11:51:29,207: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:51:29,208: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:51:29,208: Re-using an available connection from the pool.
2018-02-08 11:51:29,857: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:51:32,076: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47ca20>]}
2018-02-08 11:51:32,370: 11:51:32 | 35 of 37 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.88s]
2018-02-08 11:51:32,371: 11:51:32 | 36 of 37 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 11:51:32,372: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:51:32,382: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:51:32,382: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:51:32,382: Re-using an available connection from the pool.
2018-02-08 11:51:32,958: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:51:35,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5880b8>]}
2018-02-08 11:51:35,470: 11:51:35 | 36 of 37 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 2.79s]
2018-02-08 11:51:35,471: 11:51:35 | 37 of 37 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 11:51:35,471: Compiling model.seo_audit.agg_all
2018-02-08 11:51:35,479: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:51:35,480: Acquiring new bigquery connection "agg_all".
2018-02-08 11:51:35,480: Re-using an available connection from the pool.
2018-02-08 11:51:35,752: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:51:35,752: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:51:35,753: 400 Syntax error: Function call cannot be applied to this expression. Function calls require a path, e.g. a.b.c() at [39:25]
2018-02-08 11:51:35,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f23f941-c258-4077-8b20-45c9b184b165', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088390f0>]}
2018-02-08 11:51:36,054: 11:51:36 | 37 of 37 ERROR creating table model seo_audit_dev.agg_all............ [ERROR in 0.28s]
2018-02-08 11:51:36,158: 11:51:36 | 
2018-02-08 11:51:36,159: 11:51:36 | Finished running 37 table models in 46.94s.
2018-02-08 11:51:36,159: Connection 'master' was left open.
2018-02-08 11:51:36,160: 
2018-02-08 11:51:36,160: Completed with 1 errors:
2018-02-08 11:51:36,160: 
2018-02-08 11:51:36,160: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-08 11:51:36,160:   Syntax error: Function call cannot be applied to this expression. Function calls require a path, e.g. a.b.c() at [39:25]
2018-02-08 11:51:36,161:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-08 11:51:36,161: 
Done. PASS=36 ERROR=1 SKIP=0 TOTAL=37
2018-02-08 11:51:36,162: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47c588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47c7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47c6a0>]}
2018-02-08 11:51:36,388: Flushing usage events
2018-02-08 11:52:12,442: Tracking: tracking
2018-02-08 11:52:12,444: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048f4710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048f4cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048f4048>]}
2018-02-08 11:52:12,854: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 11:52:12,874: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 11:52:12,881: Parsing core.sql
2018-02-08 11:52:12,902: Parsing adapters/bigquery.sql
2018-02-08 11:52:12,914: Parsing adapters/common.sql
2018-02-08 11:52:12,937: Parsing adapters/postgres.sql
2018-02-08 11:52:12,945: Parsing adapters/redshift.sql
2018-02-08 11:52:12,972: Parsing etc/get_custom_schema.sql
2018-02-08 11:52:12,985: Parsing materializations/archive.sql
2018-02-08 11:52:13,022: Parsing materializations/bigquery.sql
2018-02-08 11:52:13,038: Parsing materializations/helpers.sql
2018-02-08 11:52:13,065: Parsing materializations/incremental.sql
2018-02-08 11:52:13,095: Parsing materializations/table.sql
2018-02-08 11:52:13,124: Parsing materializations/view.sql
2018-02-08 11:52:13,143: Parsing materializations/wrapper.sql
2018-02-08 11:52:13,149: Parsing schema_tests/accepted_values.sql
2018-02-08 11:52:13,155: Parsing schema_tests/not_null.sql
2018-02-08 11:52:13,160: Parsing schema_tests/relationships.sql
2018-02-08 11:52:13,167: Parsing schema_tests/unique.sql
2018-02-08 11:52:13,222: Parsing model.seo_audit.accounts_proc
2018-02-08 11:52:13,226: Parsing model.seo_audit.all_dates
2018-02-08 11:52:13,228: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 11:52:13,230: Acquiring new bigquery connection "master".
2018-02-08 11:52:13,230: Opening a new connection (0 currently allocated)
2018-02-08 11:52:13,237: Parsing model.seo_audit.agg_all
2018-02-08 11:52:13,241: Parsing model.seo_audit.agg_indicative
2018-02-08 11:52:13,245: Parsing model.seo_audit.agg_stats
2018-02-08 11:52:13,252: Parsing model.seo_audit.agg_stats_client
2018-02-08 11:52:13,255: Parsing model.seo_audit.deepcrawl_class
2018-02-08 11:52:13,258: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 11:52:13,261: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:52:13,263: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:52:13,265: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:52:13,267: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:52:13,269: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 11:52:13,272: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 11:52:13,274: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:52:13,280: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:52:13,282: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:52:13,284: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:52:13,286: Parsing model.seo_audit.ga_proc
2018-02-08 11:52:13,289: Parsing model.seo_audit.ga_stats
2018-02-08 11:52:13,293: Parsing model.seo_audit.majestic_domain_history
2018-02-08 11:52:13,295: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 11:52:13,300: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 11:52:13,304: Parsing model.seo_audit.moz_proc
2018-02-08 11:52:13,309: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 11:52:13,314: Parsing model.seo_audit.search_console_history
2018-02-08 11:52:13,316: Parsing model.seo_audit.search_console_proc
2018-02-08 11:52:13,319: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 11:52:13,321: Parsing model.seo_audit.search_console_stats_url
2018-02-08 11:52:13,323: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 11:52:13,326: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 11:52:13,329: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 11:52:13,331: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 11:52:13,334: Parsing model.seo_audit.semrush_url_history
2018-02-08 11:52:13,336: Parsing model.seo_audit.semrush_url_stats
2018-02-08 11:52:13,338: Parsing model.seo_audit.sitemap_proc
2018-02-08 11:52:13,350: Found 37 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 11:52:13,360: 
2018-02-08 11:52:13,768: 11:52:13 | Concurrency: 4 threads (target='dev')
2018-02-08 11:52:13,769: 11:52:13 | 
2018-02-08 11:52:14,048: 11:52:14 | 1 of 37 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 11:52:14,048: Compiling model.seo_audit.accounts_proc
2018-02-08 11:52:14,048: 11:52:14 | 2 of 37 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 11:52:14,053: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 11:52:14,048: 11:52:14 | 3 of 37 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 11:52:14,054: Compiling model.seo_audit.all_dates
2018-02-08 11:52:14,054: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 11:52:14,058: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 11:52:14,063: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 11:52:14,064: Acquiring new bigquery connection "accounts_proc".
2018-02-08 11:52:14,064: Opening a new connection (1 currently allocated)
2018-02-08 11:52:14,117: Acquiring new bigquery connection "all_dates".
2018-02-08 11:52:14,117: Opening a new connection (2 currently allocated)
2018-02-08 11:52:14,123: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 11:52:14,123: Opening a new connection (3 currently allocated)
2018-02-08 11:52:15,236: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 11:52:15,237: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 11:52:15,237: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 11:52:16,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f4a90>]}
2018-02-08 11:52:16,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ab7cc0>]}
2018-02-08 11:52:16,527: 11:52:16 | 1 of 37 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 2.27s]
2018-02-08 11:52:16,738: 11:52:16 | 2 of 37 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 2.27s]
2018-02-08 11:52:17,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ac3b00>]}
2018-02-08 11:52:17,730: 11:52:17 | 3 of 37 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.37s]
2018-02-08 11:52:17,731: 11:52:17 | 4 of 37 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 11:52:17,732: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 11:52:17,732: 11:52:17 | 5 of 37 START table model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 11:52:17,738: Compiling model.seo_audit.sitemap_proc
2018-02-08 11:52:17,747: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 11:52:17,750: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 11:52:17,732: 11:52:17 | 6 of 37 START table model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 11:52:17,751: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 11:52:17,756: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 11:52:17,732: 11:52:17 | 7 of 37 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 11:52:17,757: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 11:52:17,763: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 11:52:17,764: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 11:52:17,766: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 11:52:17,766: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 11:52:17,768: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 11:52:17,768: Re-using an available connection from the pool.
2018-02-08 11:52:17,771: Re-using an available connection from the pool.
2018-02-08 11:52:17,779: Re-using an available connection from the pool.
2018-02-08 11:52:17,784: Opening a new connection (4 currently allocated)
2018-02-08 11:52:18,396: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 11:52:18,411: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 11:52:18,429: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:52:18,811: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 11:52:20,581: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aecb38>]}
2018-02-08 11:52:20,590: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ab7400>]}
2018-02-08 11:52:20,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2c048>]}
2018-02-08 11:52:21,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2c470>]}
2018-02-08 11:52:21,285: 11:52:21 | 5 of 37 OK created table model seo_audit_dev.sitemap_proc............ [CREATE TABLE in 2.84s]
2018-02-08 11:52:21,286: 11:52:21 | 8 of 37 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 11:52:21,286: Compiling model.seo_audit.ga_proc
2018-02-08 11:52:21,292: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 11:52:21,295: Acquiring new bigquery connection "ga_proc".
2018-02-08 11:52:21,296: Re-using an available connection from the pool.
2018-02-08 11:52:21,547: 11:52:21 | 4 of 37 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 2.86s]
2018-02-08 11:52:21,547: 11:52:21 | 9 of 37 START table model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 11:52:21,547: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 11:52:21,559: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 11:52:21,569: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 11:52:21,570: Re-using an available connection from the pool.
2018-02-08 11:52:21,883: 11:52:21 | 7 of 37 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 2.86s]
2018-02-08 11:52:21,887: 11:52:21 | 10 of 37 START table model seo_audit_dev.moz_proc.................... [RUN]
2018-02-08 11:52:21,888: Compiling model.seo_audit.moz_proc
2018-02-08 11:52:21,904: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 11:52:21,907: Acquiring new bigquery connection "moz_proc".
2018-02-08 11:52:21,907: Re-using an available connection from the pool.
2018-02-08 11:52:21,987: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 11:52:22,130: 11:52:22 | 6 of 37 OK created table model seo_audit_dev.majestic_domain_proc.... [CREATE TABLE in 3.27s]
2018-02-08 11:52:22,131: 11:52:22 | 11 of 37 START table model seo_audit_dev.mappings_ga_proc............ [RUN]
2018-02-08 11:52:22,131: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 11:52:22,141: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 11:52:22,146: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 11:52:22,146: Re-using an available connection from the pool.
2018-02-08 11:52:22,306: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:52:23,138: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 11:52:23,620: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 11:52:24,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a19f98>]}
2018-02-08 11:52:24,547: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2cba8>]}
2018-02-08 11:52:24,835: 11:52:24 | 9 of 37 OK created table model seo_audit_dev.semrush_keyword_proc.... [CREATE TABLE in 2.95s]
2018-02-08 11:52:24,837: 11:52:24 | 12 of 37 START table model seo_audit_dev.deepcrawl_class_proc........ [RUN]
2018-02-08 11:52:24,837: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 11:52:24,847: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 11:52:24,850: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 11:52:24,850: Re-using an available connection from the pool.
2018-02-08 11:52:25,083: 11:52:25 | 8 of 37 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 3.26s]
2018-02-08 11:52:25,084: 11:52:25 | 13 of 37 START table model seo_audit_dev.search_console_proc......... [RUN]
2018-02-08 11:52:25,084: Compiling model.seo_audit.search_console_proc
2018-02-08 11:52:25,101: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 11:52:25,102: Acquiring new bigquery connection "search_console_proc".
2018-02-08 11:52:25,102: Re-using an available connection from the pool.
2018-02-08 11:52:25,374: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa7a58>]}
2018-02-08 11:52:25,404: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 11:52:25,617: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 11:52:25,738: 11:52:25 | 10 of 37 OK created table model seo_audit_dev.moz_proc............... [CREATE TABLE in 3.49s]
2018-02-08 11:52:25,795: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a19908>]}
2018-02-08 11:52:26,140: 11:52:26 | 11 of 37 OK created table model seo_audit_dev.mappings_ga_proc....... [CREATE TABLE in 3.66s]
2018-02-08 11:52:27,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ab7588>]}
2018-02-08 11:52:27,895: 11:52:27 | 12 of 37 OK created table model seo_audit_dev.deepcrawl_class_proc... [CREATE TABLE in 2.76s]
2018-02-08 11:52:28,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2cba8>]}
2018-02-08 11:52:29,169: 11:52:29 | 13 of 37 OK created table model seo_audit_dev.search_console_proc.... [CREATE TABLE in 3.78s]
2018-02-08 11:52:29,170: 11:52:29 | 14 of 37 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 11:52:29,170: Compiling model.seo_audit.search_console_history
2018-02-08 11:52:29,170: 11:52:29 | 15 of 37 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 11:52:29,177: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 11:52:29,177: Compiling model.seo_audit.ga_stats
2018-02-08 11:52:29,170: 11:52:29 | 16 of 37 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 11:52:29,170: 11:52:29 | 17 of 37 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 11:52:29,183: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 11:52:29,185: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 11:52:29,201: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 11:52:29,213: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 11:52:29,213: Re-using an available connection from the pool.
2018-02-08 11:52:29,187: Compiling model.seo_audit.majestic_domain_history
2018-02-08 11:52:29,203: Acquiring new bigquery connection "ga_stats".
2018-02-08 11:52:29,239: Re-using an available connection from the pool.
2018-02-08 11:52:29,253: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 11:52:29,255: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 11:52:29,256: Re-using an available connection from the pool.
2018-02-08 11:52:29,187: Acquiring new bigquery connection "search_console_history".
2018-02-08 11:52:29,263: Re-using an available connection from the pool.
2018-02-08 11:52:29,722: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 11:52:29,758: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 11:52:29,778: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 11:52:29,967: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 11:52:31,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b1b748>]}
2018-02-08 11:52:31,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ac3b00>]}
2018-02-08 11:52:31,961: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ab7588>]}
2018-02-08 11:52:32,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afb2b0>]}
2018-02-08 11:52:32,147: 11:52:32 | 16 of 37 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.74s]
2018-02-08 11:52:32,148: 11:52:32 | 18 of 37 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 11:52:32,149: Compiling model.seo_audit.semrush_url_history
2018-02-08 11:52:32,157: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 11:52:32,160: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 11:52:32,160: Re-using an available connection from the pool.
2018-02-08 11:52:32,502: 11:52:32 | 14 of 37 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.76s]
2018-02-08 11:52:32,746: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 11:52:32,801: 11:52:32 | 15 of 37 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 2.78s]
2018-02-08 11:52:33,346: 11:52:33 | 17 of 37 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.94s]
2018-02-08 11:52:34,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b1b748>]}
2018-02-08 11:52:35,224: 11:52:35 | 18 of 37 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.78s]
2018-02-08 11:52:35,225: 11:52:35 | 19 of 37 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 11:52:35,226: Compiling model.seo_audit.deepcrawl_class
2018-02-08 11:52:35,225: 11:52:35 | 20 of 37 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 11:52:35,233: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 11:52:35,225: 11:52:35 | 21 of 37 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 11:52:35,233: Compiling model.seo_audit.search_console_stats_url
2018-02-08 11:52:35,234: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 11:52:35,239: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 11:52:35,246: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 11:52:35,246: Re-using an available connection from the pool.
2018-02-08 11:52:35,250: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 11:52:35,251: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 11:52:35,251: Re-using an available connection from the pool.
2018-02-08 11:52:35,261: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 11:52:35,262: Re-using an available connection from the pool.
2018-02-08 11:52:35,901: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 11:52:35,905: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 11:52:35,960: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 11:52:38,083: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a5e0b8>]}
2018-02-08 11:52:38,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f4748>]}
2018-02-08 11:52:38,184: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a19eb8>]}
2018-02-08 11:52:38,304: 11:52:38 | 20 of 37 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 2.85s]
2018-02-08 11:52:38,587: 11:52:38 | 21 of 37 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.86s]
2018-02-08 11:52:38,813: 11:52:38 | 19 of 37 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 2.96s]
2018-02-08 11:52:38,813: 11:52:38 | 22 of 37 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 11:52:38,814: 11:52:38 | 23 of 37 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 11:52:38,814: 11:52:38 | 24 of 37 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 11:52:38,815: 11:52:38 | 25 of 37 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 11:52:38,815: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 11:52:38,815: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 11:52:38,815: Compiling model.seo_audit.semrush_url_stats
2018-02-08 11:52:38,815: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 11:52:38,832: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 11:52:38,834: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 11:52:38,836: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 11:52:38,840: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 11:52:38,842: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 11:52:38,842: Re-using an available connection from the pool.
2018-02-08 11:52:38,844: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 11:52:38,844: Re-using an available connection from the pool.
2018-02-08 11:52:38,846: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 11:52:38,846: Re-using an available connection from the pool.
2018-02-08 11:52:38,847: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 11:52:38,847: Re-using an available connection from the pool.
2018-02-08 11:52:39,487: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:52:39,562: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 11:52:39,563: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 11:52:39,612: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 11:52:40,597: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a29e48>]}
2018-02-08 11:52:40,892: 11:52:40 | 24 of 37 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 1.78s]
2018-02-08 11:52:41,741: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2c198>]}
2018-02-08 11:52:41,744: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f4748>]}
2018-02-08 11:52:41,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a2c128>]}
2018-02-08 11:52:42,057: 11:52:42 | 23 of 37 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 2.93s]
2018-02-08 11:52:42,270: 11:52:42 | 22 of 37 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 2.93s]
2018-02-08 11:52:42,575: 11:52:42 | 25 of 37 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 2.97s]
2018-02-08 11:52:42,576: 11:52:42 | 26 of 37 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 11:52:42,577: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 11:52:42,586: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 11:52:42,576: 11:52:42 | 27 of 37 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 11:52:42,586: Compiling model.seo_audit.agg_indicative
2018-02-08 11:52:42,597: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 11:52:42,576: 11:52:42 | 28 of 37 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 11:52:42,598: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 11:52:42,577: 11:52:42 | 29 of 37 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 11:52:42,600: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 11:52:42,601: Acquiring new bigquery connection "agg_indicative".
2018-02-08 11:52:42,610: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 11:52:42,610: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 11:52:42,610: Re-using an available connection from the pool.
2018-02-08 11:52:42,620: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 11:52:42,625: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 11:52:42,626: Re-using an available connection from the pool.
2018-02-08 11:52:42,629: Re-using an available connection from the pool.
2018-02-08 11:52:42,639: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 11:52:42,640: Re-using an available connection from the pool.
2018-02-08 11:52:43,180: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 11:52:43,181: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 11:52:43,200: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 11:52:43,224: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 11:52:44,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a19eb8>]}
2018-02-08 11:52:44,562: 11:52:44 | 26 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 1.69s]
2018-02-08 11:52:44,563: 11:52:44 | 30 of 37 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 11:52:44,563: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 11:52:44,570: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 11:52:44,571: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 11:52:44,571: Re-using an available connection from the pool.
2018-02-08 11:52:45,223: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:52:45,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f4748>]}
2018-02-08 11:52:45,415: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ae2d30>]}
2018-02-08 11:52:45,641: 11:52:45 | 28 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 2.73s]
2018-02-08 11:52:45,645: 11:52:45 | 31 of 37 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 11:52:45,647: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 11:52:45,652: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 11:52:45,653: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 11:52:45,653: Re-using an available connection from the pool.
2018-02-08 11:52:45,863: 11:52:45 | 29 of 37 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 2.80s]
2018-02-08 11:52:45,863: 11:52:45 | 32 of 37 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 11:52:45,864: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 11:52:45,870: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 11:52:45,872: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 11:52:45,872: Re-using an available connection from the pool.
2018-02-08 11:52:46,184: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:52:46,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a19eb8>]}
2018-02-08 11:52:46,469: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 11:52:46,612: 11:52:46 | 30 of 37 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 1.75s]
2018-02-08 11:52:47,281: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f4748>]}
2018-02-08 11:52:47,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ae2d30>]}
2018-02-08 11:52:47,587: 11:52:47 | 31 of 37 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 1.63s]
2018-02-08 11:52:47,618: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a5e550>]}
2018-02-08 11:52:47,798: 11:52:47 | 32 of 37 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.69s]
2018-02-08 11:52:48,199: 11:52:48 | 27 of 37 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 5.03s]
2018-02-08 11:52:48,200: 11:52:48 | 33 of 37 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 11:52:48,200: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 11:52:48,215: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 11:52:48,217: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 11:52:48,217: Re-using an available connection from the pool.
2018-02-08 11:52:48,806: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` j
ON (  a.first_path = j.first_path )
2018-02-08 11:52:52,114: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa7ac8>]}
2018-02-08 11:52:52,382: 11:52:52 | 33 of 37 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 3.91s]
2018-02-08 11:52:52,384: 11:52:52 | 34 of 37 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 11:52:52,384: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 11:52:52,393: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 11:52:52,394: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 11:52:52,395: Re-using an available connection from the pool.
2018-02-08 11:52:52,961: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when (reclass_query_string + reclass_filename + reclass_first_path) = 0 then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 11:52:54,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104a5e550>]}
2018-02-08 11:52:54,366: 11:52:54 | 34 of 37 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 1.68s]
2018-02-08 11:52:54,367: 11:52:54 | 35 of 37 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 11:52:54,367: Compiling model.seo_audit.agg_stats
2018-02-08 11:52:54,381: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 11:52:54,382: Acquiring new bigquery connection "agg_stats".
2018-02-08 11:52:54,382: Re-using an available connection from the pool.
2018-02-08 11:52:55,051: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 11:52:57,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa7ac8>]}
2018-02-08 11:52:57,510: 11:52:57 | 35 of 37 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.85s]
2018-02-08 11:52:57,511: 11:52:57 | 36 of 37 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 11:52:57,511: Compiling model.seo_audit.agg_stats_client
2018-02-08 11:52:57,518: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 11:52:57,519: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 11:52:57,519: Re-using an available connection from the pool.
2018-02-08 11:52:58,348: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 11:53:01,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ac3c18>]}
2018-02-08 11:53:01,923: 11:53:01 | 36 of 37 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 4.10s]
2018-02-08 11:53:01,924: 11:53:01 | 37 of 37 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 11:53:01,924: Compiling model.seo_audit.agg_all
2018-02-08 11:53:01,933: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 11:53:01,934: Acquiring new bigquery connection "agg_all".
2018-02-08 11:53:01,934: Re-using an available connection from the pool.
2018-02-08 11:53:02,433: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 11:53:05,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc384396-efe5-4a7c-a551-8b3024751144', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1015b2208>]}
2018-02-08 11:53:06,082: 11:53:06 | 37 of 37 OK created table model seo_audit_dev.agg_all................ [CREATE TABLE in 3.85s]
2018-02-08 11:53:06,152: 11:53:06 | 
2018-02-08 11:53:06,152: 11:53:06 | Finished running 37 table models in 52.39s.
2018-02-08 11:53:06,152: Connection 'master' was left open.
2018-02-08 11:53:06,152: 
2018-02-08 11:53:06,153: Completed successfully
2018-02-08 11:53:06,153: 
Done. PASS=37 ERROR=0 SKIP=0 TOTAL=37
2018-02-08 11:53:06,153: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1049f92b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048f4710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa7630>]}
2018-02-08 11:53:06,455: Flushing usage events
2018-02-08 12:05:45,491: Tracking: tracking
2018-02-08 12:05:45,494: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a83a278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a83ad68>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a83aeb8>]}
2018-02-08 12:05:46,268: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 12:05:46,292: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 12:05:46,301: Parsing core.sql
2018-02-08 12:05:46,331: Parsing adapters/bigquery.sql
2018-02-08 12:05:46,345: Parsing adapters/common.sql
2018-02-08 12:05:46,375: Parsing adapters/postgres.sql
2018-02-08 12:05:46,383: Parsing adapters/redshift.sql
2018-02-08 12:05:46,421: Parsing etc/get_custom_schema.sql
2018-02-08 12:05:46,434: Parsing materializations/archive.sql
2018-02-08 12:05:46,482: Parsing materializations/bigquery.sql
2018-02-08 12:05:46,505: Parsing materializations/helpers.sql
2018-02-08 12:05:46,534: Parsing materializations/incremental.sql
2018-02-08 12:05:46,575: Parsing materializations/table.sql
2018-02-08 12:05:46,605: Parsing materializations/view.sql
2018-02-08 12:05:46,625: Parsing materializations/wrapper.sql
2018-02-08 12:05:46,631: Parsing schema_tests/accepted_values.sql
2018-02-08 12:05:46,638: Parsing schema_tests/not_null.sql
2018-02-08 12:05:46,642: Parsing schema_tests/relationships.sql
2018-02-08 12:05:46,649: Parsing schema_tests/unique.sql
2018-02-08 12:05:46,711: Parsing model.seo_audit.accounts_proc
2018-02-08 12:05:46,715: Parsing model.seo_audit.all_dates
2018-02-08 12:05:46,717: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 12:05:46,720: Acquiring new bigquery connection "master".
2018-02-08 12:05:46,720: Opening a new connection (0 currently allocated)
2018-02-08 12:05:46,729: Parsing model.seo_audit.agg_all
2018-02-08 12:05:46,734: Parsing model.seo_audit.agg_indicative
2018-02-08 12:05:46,738: Parsing model.seo_audit.agg_stats
2018-02-08 12:05:46,746: Parsing model.seo_audit.agg_stats_client
2018-02-08 12:05:46,748: Parsing model.seo_audit.deepcrawl_class
2018-02-08 12:05:46,751: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 12:05:46,754: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:05:46,756: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:05:46,758: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:05:46,759: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:05:46,762: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 12:05:46,765: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 12:05:46,767: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:05:46,773: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:05:46,775: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:05:46,777: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:05:46,779: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:05:46,782: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:05:46,784: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:05:46,786: Parsing model.seo_audit.ga_proc
2018-02-08 12:05:46,789: Parsing model.seo_audit.ga_stats
2018-02-08 12:05:46,791: Parsing model.seo_audit.majestic_domain_history
2018-02-08 12:05:46,794: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 12:05:46,798: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 12:05:46,801: Parsing model.seo_audit.moz_proc
2018-02-08 12:05:46,804: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 12:05:46,808: Parsing model.seo_audit.search_console_history
2018-02-08 12:05:46,811: Parsing model.seo_audit.search_console_proc
2018-02-08 12:05:46,815: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 12:05:46,818: Parsing model.seo_audit.search_console_stats_url
2018-02-08 12:05:46,821: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 12:05:46,824: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 12:05:46,827: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 12:05:46,831: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 12:05:46,834: Parsing model.seo_audit.semrush_url_history
2018-02-08 12:05:46,836: Parsing model.seo_audit.semrush_url_stats
2018-02-08 12:05:46,838: Parsing model.seo_audit.sitemap_proc
2018-02-08 12:05:46,854: Found 40 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 12:05:46,868: 
2018-02-08 12:05:48,149: 12:05:48 | Concurrency: 4 threads (target='dev')
2018-02-08 12:05:48,150: 12:05:48 | 
2018-02-08 12:05:48,441: 12:05:48 | 1 of 40 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 12:05:48,441: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 12:05:48,441: 12:05:48 | 2 of 40 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 12:05:48,447: Compiling model.seo_audit.all_dates
2018-02-08 12:05:48,441: 12:05:48 | 3 of 40 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 12:05:48,454: Compiling model.seo_audit.accounts_proc
2018-02-08 12:05:48,459: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 12:05:48,460: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 12:05:48,462: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 12:05:48,464: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 12:05:48,465: Acquiring new bigquery connection "accounts_proc".
2018-02-08 12:05:48,465: Acquiring new bigquery connection "all_dates".
2018-02-08 12:05:48,465: Opening a new connection (1 currently allocated)
2018-02-08 12:05:48,468: Opening a new connection (2 currently allocated)
2018-02-08 12:05:48,470: Opening a new connection (3 currently allocated)
2018-02-08 12:05:49,918: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 12:05:49,928: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 12:05:49,956: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 12:05:51,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f94e0>]}
2018-02-08 12:05:51,240: 12:05:51 | 2 of 40 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 2.57s]
2018-02-08 12:05:52,114: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa2b748>]}
2018-02-08 12:05:52,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f9748>]}
2018-02-08 12:05:52,344: 12:05:52 | 3 of 40 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.66s]
2018-02-08 12:05:52,555: 12:05:52 | 1 of 40 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.76s]
2018-02-08 12:05:52,556: 12:05:52 | 4 of 40 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 12:05:52,557: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 12:05:52,556: 12:05:52 | 5 of 40 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 12:05:52,569: Compiling model.seo_audit.ga_proc
2018-02-08 12:05:52,570: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 12:05:52,556: 12:05:52 | 6 of 40 START table model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 12:05:52,557: 12:05:52 | 7 of 40 START table model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 12:05:52,577: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 12:05:52,578: Compiling model.seo_audit.search_console_proc
2018-02-08 12:05:52,578: Compiling model.seo_audit.sitemap_proc
2018-02-08 12:05:52,584: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 12:05:52,590: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 12:05:52,595: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 12:05:52,596: Acquiring new bigquery connection "search_console_proc".
2018-02-08 12:05:52,597: Acquiring new bigquery connection "ga_proc".
2018-02-08 12:05:52,598: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 12:05:52,599: Re-using an available connection from the pool.
2018-02-08 12:05:52,603: Re-using an available connection from the pool.
2018-02-08 12:05:52,609: Re-using an available connection from the pool.
2018-02-08 12:05:52,612: Opening a new connection (4 currently allocated)
2018-02-08 12:05:53,209: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:05:53,228: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 12:05:53,283: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 12:05:53,708: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 12:05:55,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9674e0>]}
2018-02-08 12:05:56,149: 12:05:56 | 7 of 40 OK created table model seo_audit_dev.sitemap_proc............ [CREATE TABLE in 3.32s]
2018-02-08 12:05:56,149: 12:05:56 | 8 of 40 START table model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 12:05:56,149: Compiling model.seo_audit.moz_proc
2018-02-08 12:05:56,156: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 12:05:56,157: Acquiring new bigquery connection "moz_proc".
2018-02-08 12:05:56,157: Re-using an available connection from the pool.
2018-02-08 12:05:56,500: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9b4320>]}
2018-02-08 12:05:56,591: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a967630>]}
2018-02-08 12:05:56,712: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:05:56,732: 12:05:56 | 6 of 40 OK created table model seo_audit_dev.search_console_proc..... [CREATE TABLE in 3.92s]
2018-02-08 12:05:56,733: 12:05:56 | 9 of 40 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 12:05:56,734: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 12:05:56,741: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 12:05:56,744: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 12:05:56,744: Re-using an available connection from the pool.
2018-02-08 12:05:56,945: 12:05:56 | 5 of 40 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 4.02s]
2018-02-08 12:05:56,946: 12:05:56 | 10 of 40 START table model seo_audit_dev.mappings_ga_proc............ [RUN]
2018-02-08 12:05:56,946: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 12:05:56,953: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 12:05:56,956: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 12:05:56,956: Re-using an available connection from the pool.
2018-02-08 12:05:57,343: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:05:57,531: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 12:05:57,667: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f92e8>]}
2018-02-08 12:05:57,899: 12:05:57 | 4 of 40 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 5.11s]
2018-02-08 12:05:57,899: 12:05:57 | 11 of 40 START table model seo_audit_dev.semrush_keyword_proc........ [RUN]
2018-02-08 12:05:57,900: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 12:05:57,910: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 12:05:57,911: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 12:05:57,911: Re-using an available connection from the pool.
2018-02-08 12:05:58,486: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:05:58,886: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9674e0>]}
2018-02-08 12:05:59,104: 12:05:59 | 8 of 40 OK created table model seo_audit_dev.moz_proc................ [CREATE TABLE in 2.74s]
2018-02-08 12:05:59,105: 12:05:59 | 12 of 40 START table model seo_audit_dev.deepcrawl_class_proc........ [RUN]
2018-02-08 12:05:59,105: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 12:05:59,115: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 12:05:59,115: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 12:05:59,115: Re-using an available connection from the pool.
2018-02-08 12:05:59,892: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:05:59,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a967a58>]}
2018-02-08 12:06:00,266: 12:06:00 | 9 of 40 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 3.16s]
2018-02-08 12:06:00,266: 12:06:00 | 13 of 40 START table model seo_audit_dev.majestic_domain_proc........ [RUN]
2018-02-08 12:06:00,267: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 12:06:00,275: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 12:06:00,276: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 12:06:00,276: Re-using an available connection from the pool.
2018-02-08 12:06:00,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a90b940>]}
2018-02-08 12:06:00,528: 12:06:00 | 11 of 40 OK created table model seo_audit_dev.semrush_keyword_proc... [CREATE TABLE in 2.41s]
2018-02-08 12:06:00,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a967630>]}
2018-02-08 12:06:00,833: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 12:06:01,052: 12:06:01 | 10 of 40 OK created table model seo_audit_dev.mappings_ga_proc....... [CREATE TABLE in 3.89s]
2018-02-08 12:06:02,043: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9674e0>]}
2018-02-08 12:06:02,291: 12:06:02 | 12 of 40 OK created table model seo_audit_dev.deepcrawl_class_proc... [CREATE TABLE in 2.94s]
2018-02-08 12:06:04,072: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa2bcc0>]}
2018-02-08 12:06:04,287: 12:06:04 | 13 of 40 OK created table model seo_audit_dev.majestic_domain_proc... [CREATE TABLE in 3.81s]
2018-02-08 12:06:04,288: 12:06:04 | 14 of 40 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 12:06:04,289: Compiling model.seo_audit.majestic_domain_history
2018-02-08 12:06:04,288: 12:06:04 | 15 of 40 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 12:06:04,298: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 12:06:04,298: Compiling model.seo_audit.semrush_url_history
2018-02-08 12:06:04,289: 12:06:04 | 16 of 40 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 12:06:04,309: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 12:06:04,309: Compiling model.seo_audit.search_console_history
2018-02-08 12:06:04,289: 12:06:04 | 17 of 40 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 12:06:04,318: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 12:06:04,318: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 12:06:04,319: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 12:06:04,337: Re-using an available connection from the pool.
2018-02-08 12:06:04,319: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 12:06:04,336: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 12:06:04,333: Acquiring new bigquery connection "search_console_history".
2018-02-08 12:06:04,341: Re-using an available connection from the pool.
2018-02-08 12:06:04,341: Re-using an available connection from the pool.
2018-02-08 12:06:04,354: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 12:06:04,354: Re-using an available connection from the pool.
2018-02-08 12:06:04,890: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 12:06:04,894: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 12:06:04,913: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 12:06:04,914: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 12:06:07,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa55c50>]}
2018-02-08 12:06:07,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f2ac8>]}
2018-02-08 12:06:07,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa22da0>]}
2018-02-08 12:06:07,123: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f9748>]}
2018-02-08 12:06:07,298: 12:06:07 | 16 of 40 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.76s]
2018-02-08 12:06:07,299: 12:06:07 | 18 of 40 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 12:06:07,299: Compiling model.seo_audit.ga_stats
2018-02-08 12:06:07,307: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 12:06:07,310: Acquiring new bigquery connection "ga_stats".
2018-02-08 12:06:07,311: Re-using an available connection from the pool.
2018-02-08 12:06:07,537: 12:06:07 | 15 of 40 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.78s]
2018-02-08 12:06:07,752: 12:06:07 | 17 of 40 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.78s]
2018-02-08 12:06:07,797: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 12:06:07,968: 12:06:07 | 14 of 40 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.83s]
2018-02-08 12:06:08,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa65dd8>]}
2018-02-08 12:06:09,110: 12:06:09 | 18 of 40 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 1.59s]
2018-02-08 12:06:09,111: 12:06:09 | 19 of 40 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 12:06:09,112: Compiling model.seo_audit.deepcrawl_class
2018-02-08 12:06:09,111: 12:06:09 | 20 of 40 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 12:06:09,112: 12:06:09 | 21 of 40 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 12:06:09,120: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 12:06:09,120: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 12:06:09,120: Compiling model.seo_audit.search_console_stats_url
2018-02-08 12:06:09,127: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 12:06:09,132: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 12:06:09,133: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 12:06:09,133: Re-using an available connection from the pool.
2018-02-08 12:06:09,135: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 12:06:09,135: Re-using an available connection from the pool.
2018-02-08 12:06:09,138: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 12:06:09,138: Re-using an available connection from the pool.
2018-02-08 12:06:09,688: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 12:06:09,689: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 12:06:09,690: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 12:06:11,853: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c47c88>]}
2018-02-08 12:06:11,861: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c47198>]}
2018-02-08 12:06:11,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c1f5f8>]}
2018-02-08 12:06:12,067: 12:06:12 | 19 of 40 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 2.74s]
2018-02-08 12:06:12,284: 12:06:12 | 20 of 40 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.74s]
2018-02-08 12:06:12,490: 12:06:12 | 21 of 40 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 2.87s]
2018-02-08 12:06:12,491: 12:06:12 | 22 of 40 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 12:06:12,492: Compiling model.seo_audit.semrush_url_stats
2018-02-08 12:06:12,491: 12:06:12 | 23 of 40 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 12:06:12,499: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 12:06:12,492: 12:06:12 | 24 of 40 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 12:06:12,509: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 12:06:12,511: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 12:06:12,512: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 12:06:12,492: 12:06:12 | 25 of 40 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 12:06:12,520: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 12:06:12,521: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:06:12,522: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 12:06:12,522: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 12:06:12,530: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 12:06:12,533: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 12:06:12,534: Re-using an available connection from the pool.
2018-02-08 12:06:12,534: Re-using an available connection from the pool.
2018-02-08 12:06:12,542: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 12:06:12,545: Re-using an available connection from the pool.
2018-02-08 12:06:12,554: Re-using an available connection from the pool.
2018-02-08 12:06:13,193: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 12:06:13,194: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 12:06:13,195: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:06:13,195: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:06:15,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c2fcc0>]}
2018-02-08 12:06:15,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c2f710>]}
2018-02-08 12:06:15,533: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c2ce10>]}
2018-02-08 12:06:15,606: 12:06:15 | 22 of 40 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 2.89s]
2018-02-08 12:06:15,792: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c2f978>]}
2018-02-08 12:06:15,845: 12:06:15 | 23 of 40 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 2.99s]
2018-02-08 12:06:16,055: 12:06:16 | 25 of 40 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 3.01s]
2018-02-08 12:06:16,276: 12:06:16 | 24 of 40 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 3.28s]
2018-02-08 12:06:16,277: 12:06:16 | 26 of 40 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 12:06:16,278: Compiling model.seo_audit.agg_indicative
2018-02-08 12:06:16,278: 12:06:16 | 27 of 40 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 12:06:16,288: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 12:06:16,278: 12:06:16 | 28 of 40 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 12:06:16,288: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:06:16,278: 12:06:16 | 29 of 40 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 12:06:16,289: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:06:16,294: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 12:06:16,294: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:06:16,299: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 12:06:16,300: Acquiring new bigquery connection "agg_indicative".
2018-02-08 12:06:16,308: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 12:06:16,312: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 12:06:16,310: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 12:06:16,314: Re-using an available connection from the pool.
2018-02-08 12:06:16,313: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 12:06:16,318: Re-using an available connection from the pool.
2018-02-08 12:06:16,322: Re-using an available connection from the pool.
2018-02-08 12:06:16,328: Re-using an available connection from the pool.
2018-02-08 12:06:16,850: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:06:16,853: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:06:16,918: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 12:06:16,935: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(classification) classification
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 12:06:17,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c47208>]}
2018-02-08 12:06:18,183: 12:06:18 | 28 of 40 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.67s]
2018-02-08 12:06:18,183: 12:06:18 | 30 of 40 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 12:06:18,184: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:06:18,191: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 12:06:18,192: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 12:06:18,192: Re-using an available connection from the pool.
2018-02-08 12:06:18,898: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 12:06:19,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9670f0>]}
2018-02-08 12:06:19,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c19b38>]}
2018-02-08 12:06:19,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa2b320>]}
2018-02-08 12:06:19,270: 12:06:19 | 27 of 40 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 2.75s]
2018-02-08 12:06:19,271: 12:06:19 | 31 of 40 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 12:06:19,272: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:06:19,282: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 12:06:19,285: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 12:06:19,285: Re-using an available connection from the pool.
2018-02-08 12:06:19,502: 12:06:19 | 29 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 2.78s]
2018-02-08 12:06:19,503: 12:06:19 | 32 of 40 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 12:06:19,505: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:06:19,513: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 12:06:19,514: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 12:06:19,514: Re-using an available connection from the pool.
2018-02-08 12:06:19,730: 12:06:19 | 26 of 40 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 2.83s]
2018-02-08 12:06:20,028: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:06:20,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa1e7b8>]}
2018-02-08 12:06:20,215: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 12:06:20,314: 12:06:20 | 30 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 1.89s]
2018-02-08 12:06:21,125: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a967a58>]}
2018-02-08 12:06:21,313: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa2bd68>]}
2018-02-08 12:06:21,372: 12:06:21 | 32 of 40 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 1.62s]
2018-02-08 12:06:21,902: 12:06:21 | 31 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 2.04s]
2018-02-08 12:06:21,903: 12:06:21 | 33 of 40 START table model seo_audit_dev.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-08 12:06:21,903: 12:06:21 | 34 of 40 START table model seo_audit_dev.deepcrawl_rules_filename_unclassified [RUN]
2018-02-08 12:06:21,903: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:06:21,904: 12:06:21 | 35 of 40 START table model seo_audit_dev.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-08 12:06:21,904: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:06:21,912: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-08 12:06:21,913: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:06:21,923: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-08 12:06:21,931: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-08 12:06:21,932: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-08 12:06:21,932: Re-using an available connection from the pool.
2018-02-08 12:06:21,938: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-08 12:06:21,938: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-08 12:06:21,939: Re-using an available connection from the pool.
2018-02-08 12:06:21,939: Re-using an available connection from the pool.
2018-02-08 12:06:22,320: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-08 12:06:22,327: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-08 12:06:22,369: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-08 12:06:23,389: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c1f780>]}
2018-02-08 12:06:23,412: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c1f898>]}
2018-02-08 12:06:23,470: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c07c50>]}
2018-02-08 12:06:23,631: 12:06:23 | 35 of 40 OK created table model seo_audit_dev.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.48s]
2018-02-08 12:06:23,865: 12:06:23 | 33 of 40 OK created table model seo_audit_dev.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.51s]
2018-02-08 12:06:24,085: 12:06:24 | 34 of 40 OK created table model seo_audit_dev.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.57s]
2018-02-08 12:06:24,086: 12:06:24 | 36 of 40 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 12:06:24,086: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:06:24,108: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 12:06:24,108: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 12:06:24,109: Re-using an available connection from the pool.
2018-02-08 12:06:24,753: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-08 12:06:28,452: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa1e6d8>]}
2018-02-08 12:06:29,037: 12:06:29 | 36 of 40 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 4.37s]
2018-02-08 12:06:29,038: 12:06:29 | 37 of 40 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 12:06:29,038: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 12:06:29,047: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 12:06:29,049: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 12:06:29,049: Re-using an available connection from the pool.
2018-02-08 12:06:29,673: Model SQL (deepcrawl_reclass):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as final_classification,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 12:06:30,754: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f2438>]}
2018-02-08 12:06:31,002: 12:06:31 | 37 of 40 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 1.72s]
2018-02-08 12:06:31,003: 12:06:31 | 38 of 40 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 12:06:31,003: Compiling model.seo_audit.agg_stats
2018-02-08 12:06:31,030: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 12:06:31,032: Acquiring new bigquery connection "agg_stats".
2018-02-08 12:06:31,032: Re-using an available connection from the pool.
2018-02-08 12:06:31,625: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 12:06:33,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c07d30>]}
2018-02-08 12:06:34,028: 12:06:34 | 38 of 40 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.80s]
2018-02-08 12:06:34,029: 12:06:34 | 39 of 40 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 12:06:34,029: Compiling model.seo_audit.agg_stats_client
2018-02-08 12:06:34,039: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 12:06:34,041: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 12:06:34,042: Re-using an available connection from the pool.
2018-02-08 12:06:34,567: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 12:06:58,662: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f2438>]}
2018-02-08 12:06:59,304: 12:06:59 | 39 of 40 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 24.63s]
2018-02-08 12:06:59,305: 12:06:59 | 40 of 40 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 12:06:59,305: Compiling model.seo_audit.agg_all
2018-02-08 12:06:59,316: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 12:06:59,317: Acquiring new bigquery connection "agg_all".
2018-02-08 12:06:59,318: Re-using an available connection from the pool.
2018-02-08 12:06:59,958: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
classification,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 12:07:02,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceb6b27e-d30e-4aca-9eb1-4943afb29ebc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9f22b0>]}
2018-02-08 12:07:02,455: 12:07:02 | 40 of 40 OK created table model seo_audit_dev.agg_all................ [CREATE TABLE in 2.85s]
2018-02-08 12:07:02,479: 12:07:02 | 
2018-02-08 12:07:02,479: 12:07:02 | Finished running 40 table models in 74.33s.
2018-02-08 12:07:02,480: Connection 'master' was left open.
2018-02-08 12:07:02,480: 
2018-02-08 12:07:02,480: Completed successfully
2018-02-08 12:07:02,480: 
Done. PASS=40 ERROR=0 SKIP=0 TOTAL=40
2018-02-08 12:07:02,481: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a83aac8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a90b4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a90b588>]}
2018-02-08 12:07:02,820: Flushing usage events
2018-02-08 12:30:47,925: Tracking: tracking
2018-02-08 12:30:47,929: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b71da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b71908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b71f60>]}
2018-02-08 12:30:48,680: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 12:30:48,701: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 12:30:48,705: Parsing core.sql
2018-02-08 12:30:48,726: Parsing adapters/bigquery.sql
2018-02-08 12:30:48,735: Parsing adapters/common.sql
2018-02-08 12:30:48,751: Parsing adapters/postgres.sql
2018-02-08 12:30:48,759: Parsing adapters/redshift.sql
2018-02-08 12:30:48,793: Parsing etc/get_custom_schema.sql
2018-02-08 12:30:48,800: Parsing materializations/archive.sql
2018-02-08 12:30:48,840: Parsing materializations/bigquery.sql
2018-02-08 12:30:48,859: Parsing materializations/helpers.sql
2018-02-08 12:30:48,880: Parsing materializations/incremental.sql
2018-02-08 12:30:48,913: Parsing materializations/table.sql
2018-02-08 12:30:48,939: Parsing materializations/view.sql
2018-02-08 12:30:48,957: Parsing materializations/wrapper.sql
2018-02-08 12:30:48,966: Parsing schema_tests/accepted_values.sql
2018-02-08 12:30:48,977: Parsing schema_tests/not_null.sql
2018-02-08 12:30:48,983: Parsing schema_tests/relationships.sql
2018-02-08 12:30:48,995: Parsing schema_tests/unique.sql
2018-02-08 12:30:49,045: Parsing model.seo_audit.accounts_proc
2018-02-08 12:30:49,049: Parsing model.seo_audit.all_dates
2018-02-08 12:30:49,051: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 12:30:49,054: Acquiring new bigquery connection "master".
2018-02-08 12:30:49,054: Opening a new connection (0 currently allocated)
2018-02-08 12:30:49,059: Parsing model.seo_audit.agg_all
2018-02-08 12:30:49,061: Parsing model.seo_audit.agg_indicative
2018-02-08 12:30:49,064: Parsing model.seo_audit.agg_stats
2018-02-08 12:30:49,070: Parsing model.seo_audit.agg_stats_client
2018-02-08 12:30:49,075: Parsing model.seo_audit.deepcrawl_class
2018-02-08 12:30:49,079: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 12:30:49,083: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:30:49,086: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:30:49,089: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:30:49,091: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:30:49,093: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 12:30:49,096: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 12:30:49,099: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:30:49,106: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:30:49,109: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:30:49,111: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:30:49,113: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:30:49,115: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:30:49,118: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:30:49,120: Parsing model.seo_audit.ga_proc
2018-02-08 12:30:49,124: Parsing model.seo_audit.ga_stats
2018-02-08 12:30:49,126: Parsing model.seo_audit.majestic_domain_history
2018-02-08 12:30:49,127: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 12:30:49,131: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 12:30:49,133: Parsing model.seo_audit.moz_proc
2018-02-08 12:30:49,136: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 12:30:49,141: Parsing model.seo_audit.search_console_history
2018-02-08 12:30:49,143: Parsing model.seo_audit.search_console_proc
2018-02-08 12:30:49,145: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 12:30:49,148: Parsing model.seo_audit.search_console_stats_url
2018-02-08 12:30:49,150: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 12:30:49,153: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 12:30:49,157: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 12:30:49,162: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 12:30:49,166: Parsing model.seo_audit.semrush_url_history
2018-02-08 12:30:49,169: Parsing model.seo_audit.semrush_url_stats
2018-02-08 12:30:49,172: Parsing model.seo_audit.sitemap_proc
2018-02-08 12:30:49,189: Found 40 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 12:30:49,199: 
2018-02-08 12:30:50,653: 12:30:50 | Concurrency: 4 threads (target='dev')
2018-02-08 12:30:50,653: 12:30:50 | 
2018-02-08 12:30:50,880: 12:30:50 | 1 of 40 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 12:30:50,880: 12:30:50 | 2 of 40 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 12:30:50,880: 12:30:50 | 3 of 40 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 12:30:50,881: Compiling model.seo_audit.accounts_proc
2018-02-08 12:30:50,881: Compiling model.seo_audit.all_dates
2018-02-08 12:30:50,881: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 12:30:50,886: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 12:30:50,890: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 12:30:50,894: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 12:30:50,898: Acquiring new bigquery connection "all_dates".
2018-02-08 12:30:50,898: Opening a new connection (1 currently allocated)
2018-02-08 12:30:50,899: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 12:30:50,900: Acquiring new bigquery connection "accounts_proc".
2018-02-08 12:30:50,901: Opening a new connection (2 currently allocated)
2018-02-08 12:30:50,955: Opening a new connection (3 currently allocated)
2018-02-08 12:30:51,972: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 12:30:52,011: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 12:30:52,105: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 12:30:54,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109db3898>]}
2018-02-08 12:30:54,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dd0b38>]}
2018-02-08 12:30:54,286: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dd0d30>]}
2018-02-08 12:30:54,366: 12:30:54 | 1 of 40 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.26s]
2018-02-08 12:30:54,673: 12:30:54 | 2 of 40 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 3.29s]
2018-02-08 12:30:54,921: 12:30:54 | 3 of 40 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.40s]
2018-02-08 12:30:54,922: 12:30:54 | 4 of 40 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 12:30:54,923: 12:30:54 | 5 of 40 START table model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 12:30:54,924: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 12:30:54,923: 12:30:54 | 6 of 40 START table model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 12:30:54,924: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 12:30:54,924: 12:30:54 | 7 of 40 START table model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 12:30:54,931: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 12:30:54,937: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 12:30:54,945: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 12:30:54,945: Compiling model.seo_audit.search_console_proc
2018-02-08 12:30:54,951: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 12:30:54,958: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 12:30:54,960: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 12:30:54,961: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 12:30:54,961: Re-using an available connection from the pool.
2018-02-08 12:30:54,962: Re-using an available connection from the pool.
2018-02-08 12:30:54,967: Acquiring new bigquery connection "search_console_proc".
2018-02-08 12:30:54,969: Re-using an available connection from the pool.
2018-02-08 12:30:54,970: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 12:30:54,971: Opening a new connection (4 currently allocated)
2018-02-08 12:30:55,516: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:30:55,582: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 12:30:55,654: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:30:55,960: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 12:30:57,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10683c630>]}
2018-02-08 12:30:58,048: 12:30:58 | 5 of 40 OK created table model seo_audit_dev.mappings_ga_proc........ [CREATE TABLE in 2.89s]
2018-02-08 12:30:58,049: 12:30:58 | 8 of 40 START table model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 12:30:58,049: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 12:30:58,057: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 12:30:58,059: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 12:30:58,059: Re-using an available connection from the pool.
2018-02-08 12:30:58,724: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:30:59,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dc7a58>]}
2018-02-08 12:30:59,266: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d4ac50>]}
2018-02-08 12:30:59,491: 12:30:59 | 7 of 40 OK created table model seo_audit_dev.search_console_proc..... [CREATE TABLE in 4.24s]
2018-02-08 12:30:59,492: 12:30:59 | 9 of 40 START table model seo_audit_dev.sitemap_proc................. [RUN]
2018-02-08 12:30:59,493: Compiling model.seo_audit.sitemap_proc
2018-02-08 12:30:59,515: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 12:30:59,519: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 12:30:59,521: Re-using an available connection from the pool.
2018-02-08 12:30:59,817: 12:30:59 | 6 of 40 OK created table model seo_audit_dev.majestic_domain_proc.... [CREATE TABLE in 4.33s]
2018-02-08 12:30:59,818: 12:30:59 | 10 of 40 START table model seo_audit_dev.moz_proc.................... [RUN]
2018-02-08 12:30:59,818: Compiling model.seo_audit.moz_proc
2018-02-08 12:30:59,835: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 12:30:59,837: Acquiring new bigquery connection "moz_proc".
2018-02-08 12:30:59,837: Re-using an available connection from the pool.
2018-02-08 12:30:59,879: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109da75c0>]}
2018-02-08 12:31:00,093: 12:31:00 | 4 of 40 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 4.96s]
2018-02-08 12:31:00,094: 12:31:00 | 11 of 40 START table model seo_audit_dev.deepcrawl_class_proc........ [RUN]
2018-02-08 12:31:00,094: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 12:31:00,101: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 12:31:00,102: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 12:31:00,102: Re-using an available connection from the pool.
2018-02-08 12:31:00,434: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:31:00,640: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:31:00,641: Bad request while running:
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:31:00,641: 400 Unrecognized name: client at [10:1]
2018-02-08 12:31:00,641: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d54208>]}
2018-02-08 12:31:00,654: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 12:31:00,945: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10683c630>]}
2018-02-08 12:31:00,955: 12:31:00 | 11 of 40 ERROR creating table model seo_audit_dev.deepcrawl_class_proc [ERROR in 0.55s]
2018-02-08 12:31:00,955: 12:31:00 | 12 of 40 START table model seo_audit_dev.ga_proc..................... [RUN]
2018-02-08 12:31:00,956: Compiling model.seo_audit.ga_proc
2018-02-08 12:31:00,962: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 12:31:00,965: Acquiring new bigquery connection "ga_proc".
2018-02-08 12:31:00,967: Re-using an available connection from the pool.
2018-02-08 12:31:01,196: 12:31:01 | 8 of 40 OK created table model seo_audit_dev.semrush_keyword_proc.... [CREATE TABLE in 2.90s]
2018-02-08 12:31:01,196: 12:31:01 | 13 of 40 START table model seo_audit_dev.screamingfrog_proc.......... [RUN]
2018-02-08 12:31:01,197: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 12:31:01,207: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 12:31:01,209: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 12:31:01,210: Re-using an available connection from the pool.
2018-02-08 12:31:01,696: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 12:31:02,134: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 12:31:02,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d48710>]}
2018-02-08 12:31:02,830: 12:31:02 | 10 of 40 OK created table model seo_audit_dev.moz_proc............... [CREATE TABLE in 2.78s]
2018-02-08 12:31:03,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dc7a58>]}
2018-02-08 12:31:04,227: 12:31:04 | 9 of 40 OK created table model seo_audit_dev.sitemap_proc............ [CREATE TABLE in 4.43s]
2018-02-08 12:31:04,368: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10683c630>]}
2018-02-08 12:31:04,700: 12:31:04 | 13 of 40 OK created table model seo_audit_dev.screamingfrog_proc..... [CREATE TABLE in 3.17s]
2018-02-08 12:31:08,182: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10683c630>]}
2018-02-08 12:31:08,428: 12:31:08 | 12 of 40 OK created table model seo_audit_dev.ga_proc................ [CREATE TABLE in 7.23s]
2018-02-08 12:31:08,429: 12:31:08 | 14 of 40 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 12:31:08,429: 12:31:08 | 15 of 40 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 12:31:08,429: 12:31:08 | 16 of 40 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 12:31:08,430: 12:31:08 | 17 of 40 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 12:31:08,430: Compiling model.seo_audit.majestic_domain_history
2018-02-08 12:31:08,430: Compiling model.seo_audit.search_console_history
2018-02-08 12:31:08,430: Compiling model.seo_audit.semrush_url_history
2018-02-08 12:31:08,431: Compiling model.seo_audit.ga_stats
2018-02-08 12:31:08,444: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 12:31:08,449: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 12:31:08,450: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 12:31:08,457: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 12:31:08,458: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 12:31:08,458: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 12:31:08,459: Acquiring new bigquery connection "search_console_history".
2018-02-08 12:31:08,459: Re-using an available connection from the pool.
2018-02-08 12:31:08,460: Acquiring new bigquery connection "ga_stats".
2018-02-08 12:31:08,461: Re-using an available connection from the pool.
2018-02-08 12:31:08,462: Re-using an available connection from the pool.
2018-02-08 12:31:08,464: Re-using an available connection from the pool.
2018-02-08 12:31:09,034: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 12:31:09,053: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 12:31:09,059: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 12:31:09,064: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 12:31:11,221: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068a5eb8>]}
2018-02-08 12:31:11,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e27f98>]}
2018-02-08 12:31:11,517: 12:31:11 | 17 of 40 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 2.79s]
2018-02-08 12:31:11,518: 12:31:11 | 18 of 40 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 12:31:11,518: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 12:31:11,526: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 12:31:11,529: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 12:31:11,530: Re-using an available connection from the pool.
2018-02-08 12:31:11,736: 12:31:11 | 14 of 40 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.81s]
2018-02-08 12:31:12,036: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 12:31:12,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068905f8>]}
2018-02-08 12:31:12,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109de82b0>]}
2018-02-08 12:31:12,605: 12:31:12 | 16 of 40 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 3.86s]
2018-02-08 12:31:12,882: 12:31:12 | 15 of 40 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 3.87s]
2018-02-08 12:31:15,282: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e27f98>]}
2018-02-08 12:31:15,493: 12:31:15 | 18 of 40 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 3.76s]
2018-02-08 12:31:15,494: 12:31:15 | 19 of 40 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-08 12:31:15,494: 12:31:15 | 20 of 40 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 12:31:15,494: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 12:31:15,494: 12:31:15 | 21 of 40 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 12:31:15,504: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 12:31:15,504: Compiling model.seo_audit.search_console_stats_url
2018-02-08 12:31:15,514: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 12:31:15,515: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 12:31:15,516: Re-using an available connection from the pool.
2018-02-08 12:31:15,517: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 12:31:15,520: Re-using an available connection from the pool.
2018-02-08 12:31:16,059: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 12:31:16,104: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 12:31:18,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e01b70>]}
2018-02-08 12:31:18,561: 12:31:18 | 20 of 40 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.73s]
2018-02-08 12:31:19,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10689a198>]}
2018-02-08 12:31:19,678: 12:31:19 | 21 of 40 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 3.89s]
2018-02-08 12:31:19,679: 12:31:19 | 22 of 40 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 12:31:19,680: Compiling model.seo_audit.semrush_url_stats
2018-02-08 12:31:19,689: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 12:31:19,685: 12:31:19 | 23 of 40 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 12:31:19,691: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 12:31:19,685: 12:31:19 | 24 of 40 SKIP relation seo_audit_dev.deepcrawl_classification_stats.. [SKIP]
2018-02-08 12:31:19,690: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 12:31:19,706: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 12:31:19,707: Re-using an available connection from the pool.
2018-02-08 12:31:19,686: 12:31:19 | 25 of 40 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 12:31:19,714: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 12:31:19,722: Re-using an available connection from the pool.
2018-02-08 12:31:19,716: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 12:31:19,766: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 12:31:19,770: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 12:31:19,770: Re-using an available connection from the pool.
2018-02-08 12:31:20,341: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 12:31:20,367: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:31:20,398: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:31:23,581: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c6e10>]}
2018-02-08 12:31:23,609: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2f60>]}
2018-02-08 12:31:23,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c24a8>]}
2018-02-08 12:31:23,786: 12:31:23 | 23 of 40 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 3.89s]
2018-02-08 12:31:24,107: 12:31:24 | 22 of 40 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 3.93s]
2018-02-08 12:31:24,404: 12:31:24 | 25 of 40 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 3.95s]
2018-02-08 12:31:24,405: 12:31:24 | 26 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_filename.. [SKIP]
2018-02-08 12:31:24,405: 12:31:24 | 27 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_first_path...... [SKIP]
2018-02-08 12:31:24,405: 12:31:24 | 28 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_query_string.... [SKIP]
2018-02-08 12:31:24,405: 12:31:24 | 29 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_filename........ [SKIP]
2018-02-08 12:31:24,405: 12:31:24 | 30 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_first_path [SKIP]
2018-02-08 12:31:24,406: 12:31:24 | 31 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_query_string [SKIP]
2018-02-08 12:31:24,407: 12:31:24 | 32 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-08 12:31:24,407: 12:31:24 | 33 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-08 12:31:24,407: 12:31:24 | 34 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-08 12:31:24,408: 12:31:24 | 35 of 40 SKIP relation seo_audit_dev.deepcrawl_reclass_proc.......... [SKIP]
2018-02-08 12:31:24,409: 12:31:24 | 36 of 40 SKIP relation seo_audit_dev.deepcrawl_reclass............... [SKIP]
2018-02-08 12:31:24,409: 12:31:24 | 37 of 40 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 12:31:24,409: Compiling model.seo_audit.agg_stats
2018-02-08 12:31:24,420: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 12:31:24,424: Acquiring new bigquery connection "agg_stats".
2018-02-08 12:31:24,424: Re-using an available connection from the pool.
2018-02-08 12:31:25,152: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 12:31:28,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2588>]}
2018-02-08 12:31:28,673: 12:31:28 | 37 of 40 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 3.98s]
2018-02-08 12:31:28,674: 12:31:28 | 38 of 40 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 12:31:28,674: Compiling model.seo_audit.agg_stats_client
2018-02-08 12:31:28,674: 12:31:28 | 39 of 40 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-08 12:31:28,683: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 12:31:28,685: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 12:31:28,686: Re-using an available connection from the pool.
2018-02-08 12:31:29,411: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 12:31:32,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a436310f-cf23-40e3-a1da-90780ed20f1a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c6e48>]}
2018-02-08 12:31:32,879: 12:31:32 | 38 of 40 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 3.98s]
2018-02-08 12:31:32,881: 12:31:32 | 40 of 40 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-08 12:31:32,967: 12:31:32 | 
2018-02-08 12:31:32,967: 12:31:32 | Finished running 40 table models in 42.31s.
2018-02-08 12:31:32,968: Connection 'master' was left open.
2018-02-08 12:31:32,968: 
2018-02-08 12:31:32,968: Completed with 1 errors:
2018-02-08 12:31:32,968: 
2018-02-08 12:31:32,969: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-08 12:31:32,969:   Unrecognized name: client at [10:1]
2018-02-08 12:31:32,969:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-08 12:31:32,969: 
Done. PASS=24 ERROR=1 SKIP=15 TOTAL=40
2018-02-08 12:31:32,970: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c596d8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c59860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c59710>]}
2018-02-08 12:31:33,285: Flushing usage events
2018-02-08 12:31:59,776: Tracking: tracking
2018-02-08 12:31:59,779: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f08d668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f08d4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f08db00>]}
2018-02-08 12:32:00,610: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 12:32:00,633: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 12:32:00,637: Parsing core.sql
2018-02-08 12:32:00,656: Parsing adapters/bigquery.sql
2018-02-08 12:32:00,666: Parsing adapters/common.sql
2018-02-08 12:32:00,683: Parsing adapters/postgres.sql
2018-02-08 12:32:00,688: Parsing adapters/redshift.sql
2018-02-08 12:32:00,715: Parsing etc/get_custom_schema.sql
2018-02-08 12:32:00,723: Parsing materializations/archive.sql
2018-02-08 12:32:00,762: Parsing materializations/bigquery.sql
2018-02-08 12:32:00,778: Parsing materializations/helpers.sql
2018-02-08 12:32:00,797: Parsing materializations/incremental.sql
2018-02-08 12:32:00,829: Parsing materializations/table.sql
2018-02-08 12:32:00,853: Parsing materializations/view.sql
2018-02-08 12:32:00,881: Parsing materializations/wrapper.sql
2018-02-08 12:32:00,886: Parsing schema_tests/accepted_values.sql
2018-02-08 12:32:00,892: Parsing schema_tests/not_null.sql
2018-02-08 12:32:00,897: Parsing schema_tests/relationships.sql
2018-02-08 12:32:00,904: Parsing schema_tests/unique.sql
2018-02-08 12:32:00,979: Parsing model.seo_audit.accounts_proc
2018-02-08 12:32:00,983: Parsing model.seo_audit.all_dates
2018-02-08 12:32:00,986: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 12:32:00,990: Acquiring new bigquery connection "master".
2018-02-08 12:32:00,990: Opening a new connection (0 currently allocated)
2018-02-08 12:32:00,995: Parsing model.seo_audit.agg_all
2018-02-08 12:32:01,000: Parsing model.seo_audit.agg_indicative
2018-02-08 12:32:01,003: Parsing model.seo_audit.agg_stats
2018-02-08 12:32:01,008: Parsing model.seo_audit.agg_stats_client
2018-02-08 12:32:01,011: Parsing model.seo_audit.deepcrawl_class
2018-02-08 12:32:01,014: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 12:32:01,017: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:32:01,018: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:32:01,020: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:32:01,022: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:32:01,024: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 12:32:01,027: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 12:32:01,030: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:32:01,037: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:32:01,039: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:32:01,040: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:32:01,042: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:32:01,044: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:32:01,046: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:32:01,048: Parsing model.seo_audit.ga_proc
2018-02-08 12:32:01,050: Parsing model.seo_audit.ga_stats
2018-02-08 12:32:01,052: Parsing model.seo_audit.majestic_domain_history
2018-02-08 12:32:01,053: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 12:32:01,056: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 12:32:01,059: Parsing model.seo_audit.moz_proc
2018-02-08 12:32:01,061: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 12:32:01,065: Parsing model.seo_audit.search_console_history
2018-02-08 12:32:01,066: Parsing model.seo_audit.search_console_proc
2018-02-08 12:32:01,069: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 12:32:01,072: Parsing model.seo_audit.search_console_stats_url
2018-02-08 12:32:01,073: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 12:32:01,076: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 12:32:01,079: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 12:32:01,082: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 12:32:01,084: Parsing model.seo_audit.semrush_url_history
2018-02-08 12:32:01,086: Parsing model.seo_audit.semrush_url_stats
2018-02-08 12:32:01,088: Parsing model.seo_audit.sitemap_proc
2018-02-08 12:32:01,104: Found 40 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 12:32:01,117: 
2018-02-08 12:32:01,769: 12:32:01 | Concurrency: 4 threads (target='dev')
2018-02-08 12:32:01,769: 12:32:01 | 
2018-02-08 12:32:01,978: 12:32:01 | 1 of 40 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 12:32:01,979: 12:32:01 | 2 of 40 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 12:32:01,979: Compiling model.seo_audit.all_dates
2018-02-08 12:32:01,979: 12:32:01 | 3 of 40 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 12:32:01,979: Compiling model.seo_audit.accounts_proc
2018-02-08 12:32:01,983: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 12:32:01,983: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 12:32:01,988: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 12:32:01,993: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 12:32:01,994: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 12:32:01,994: Opening a new connection (1 currently allocated)
2018-02-08 12:32:01,995: Acquiring new bigquery connection "all_dates".
2018-02-08 12:32:01,995: Acquiring new bigquery connection "accounts_proc".
2018-02-08 12:32:01,997: Opening a new connection (2 currently allocated)
2018-02-08 12:32:01,998: Opening a new connection (3 currently allocated)
2018-02-08 12:32:02,998: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 12:32:03,002: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 12:32:03,014: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 12:32:05,155: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2d4da0>]}
2018-02-08 12:32:05,389: 12:32:05 | 1 of 40 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 3.18s]
2018-02-08 12:32:06,317: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2d42e8>]}
2018-02-08 12:32:06,325: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28c2b0>]}
2018-02-08 12:32:11,804: 12:32:11 | 2 of 40 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 4.34s]
2018-02-08 12:32:12,086: 12:32:12 | 3 of 40 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 4.34s]
2018-02-08 12:32:12,087: 12:32:12 | 4 of 40 START table model seo_audit_dev.moz_proc..................... [RUN]
2018-02-08 12:32:12,087: 12:32:12 | 5 of 40 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 12:32:12,088: 12:32:12 | 6 of 40 START table model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 12:32:12,088: 12:32:12 | 7 of 40 START table model seo_audit_dev.semrush_domain_proc.......... [RUN]
2018-02-08 12:32:12,088: Compiling model.seo_audit.moz_proc
2018-02-08 12:32:12,088: Compiling model.seo_audit.ga_proc
2018-02-08 12:32:12,089: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 12:32:12,089: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 12:32:12,107: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 12:32:12,107: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 12:32:12,109: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 12:32:12,114: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 12:32:12,122: Acquiring new bigquery connection "moz_proc".
2018-02-08 12:32:12,122: Re-using an available connection from the pool.
2018-02-08 12:32:12,128: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 12:32:12,128: Re-using an available connection from the pool.
2018-02-08 12:32:12,129: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 12:32:12,132: Re-using an available connection from the pool.
2018-02-08 12:32:12,134: Acquiring new bigquery connection "ga_proc".
2018-02-08 12:32:12,137: Opening a new connection (4 currently allocated)
2018-02-08 12:32:12,639: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:32:12,679: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:32:12,747: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:32:13,342: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 12:32:14,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15bb00>]}
2018-02-08 12:32:14,849: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2373c8>]}
2018-02-08 12:32:14,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28d6d8>]}
2018-02-08 12:32:15,016: 12:32:15 | 4 of 40 OK created table model seo_audit_dev.moz_proc................ [CREATE TABLE in 2.71s]
2018-02-08 12:32:15,018: 12:32:15 | 8 of 40 START table model seo_audit_dev.screamingfrog_proc........... [RUN]
2018-02-08 12:32:15,018: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 12:32:15,030: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 12:32:15,033: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 12:32:15,034: Re-using an available connection from the pool.
2018-02-08 12:32:15,357: 12:32:15 | 6 of 40 OK created table model seo_audit_dev.semrush_keyword_proc.... [CREATE TABLE in 2.76s]
2018-02-08 12:32:15,359: 12:32:15 | 9 of 40 START table model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 12:32:15,361: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 12:32:15,372: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 12:32:15,374: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 12:32:15,374: Re-using an available connection from the pool.
2018-02-08 12:32:15,577: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 12:32:15,595: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2d40b8>]}
2018-02-08 12:32:15,597: 12:32:15 | 7 of 40 OK created table model seo_audit_dev.semrush_domain_proc..... [CREATE TABLE in 2.82s]
2018-02-08 12:32:15,598: 12:32:15 | 10 of 40 START table model seo_audit_dev.mappings_ga_proc............ [RUN]
2018-02-08 12:32:15,599: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 12:32:15,611: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 12:32:15,614: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 12:32:15,615: Re-using an available connection from the pool.
2018-02-08 12:32:15,679: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  client,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:32:15,680: Bad request while running:
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  client,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:32:15,680: 400 Unrecognized name: client at [73:3]
2018-02-08 12:32:15,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f30b898>]}
2018-02-08 12:32:15,924: 12:32:15 | 5 of 40 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 3.51s]
2018-02-08 12:32:15,926: 12:32:15 | 11 of 40 START table model seo_audit_dev.majestic_domain_proc........ [RUN]
2018-02-08 12:32:15,928: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 12:32:15,941: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 12:32:15,943: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 12:32:15,943: Re-using an available connection from the pool.
2018-02-08 12:32:16,158: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 12:32:16,229: 12:32:16 | 9 of 40 ERROR creating table model seo_audit_dev.deepcrawl_class_proc [ERROR in 0.32s]
2018-02-08 12:32:16,230: 12:32:16 | 12 of 40 START table model seo_audit_dev.sitemap_proc................ [RUN]
2018-02-08 12:32:16,230: Compiling model.seo_audit.sitemap_proc
2018-02-08 12:32:16,240: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 12:32:16,244: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 12:32:16,244: Re-using an available connection from the pool.
2018-02-08 12:32:16,497: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 12:32:16,791: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 12:32:17,754: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15bb00>]}
2018-02-08 12:32:17,972: 12:32:17 | 8 of 40 OK created table model seo_audit_dev.screamingfrog_proc...... [CREATE TABLE in 2.74s]
2018-02-08 12:32:17,972: 12:32:17 | 13 of 40 START table model seo_audit_dev.search_console_proc......... [RUN]
2018-02-08 12:32:17,973: Compiling model.seo_audit.search_console_proc
2018-02-08 12:32:17,982: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 12:32:17,985: Acquiring new bigquery connection "search_console_proc".
2018-02-08 12:32:17,985: Re-using an available connection from the pool.
2018-02-08 12:32:18,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f278d68>]}
2018-02-08 12:32:18,600: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:32:18,621: 12:32:18 | 10 of 40 OK created table model seo_audit_dev.mappings_ga_proc....... [CREATE TABLE in 2.72s]
2018-02-08 12:32:18,648: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2d40b8>]}
2018-02-08 12:32:18,939: 12:32:18 | 11 of 40 OK created table model seo_audit_dev.majestic_domain_proc... [CREATE TABLE in 2.72s]
2018-02-08 12:32:18,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28d0b8>]}
2018-02-08 12:32:19,321: 12:32:19 | 12 of 40 OK created table model seo_audit_dev.sitemap_proc........... [CREATE TABLE in 2.74s]
2018-02-08 12:32:21,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15bb00>]}
2018-02-08 12:32:22,120: 12:32:22 | 13 of 40 OK created table model seo_audit_dev.search_console_proc.... [CREATE TABLE in 3.91s]
2018-02-08 12:32:22,121: 12:32:22 | 14 of 40 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 12:32:22,121: 12:32:22 | 15 of 40 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 12:32:22,122: 12:32:22 | 16 of 40 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 12:32:22,122: 12:32:22 | 17 of 40 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 12:32:22,122: Compiling model.seo_audit.search_console_history
2018-02-08 12:32:22,123: Compiling model.seo_audit.majestic_domain_history
2018-02-08 12:32:22,123: Compiling model.seo_audit.ga_stats
2018-02-08 12:32:22,123: Compiling model.seo_audit.semrush_url_history
2018-02-08 12:32:22,137: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 12:32:22,136: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 12:32:22,141: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 12:32:22,146: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 12:32:22,147: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 12:32:22,148: Re-using an available connection from the pool.
2018-02-08 12:32:22,149: Acquiring new bigquery connection "ga_stats".
2018-02-08 12:32:22,150: Re-using an available connection from the pool.
2018-02-08 12:32:22,151: Acquiring new bigquery connection "search_console_history".
2018-02-08 12:32:22,152: Re-using an available connection from the pool.
2018-02-08 12:32:22,153: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 12:32:22,153: Re-using an available connection from the pool.
2018-02-08 12:32:22,666: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 12:32:22,706: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 12:32:22,715: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 12:32:22,726: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 12:32:24,816: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3094a8>]}
2018-02-08 12:32:24,869: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28c2b0>]}
2018-02-08 12:32:24,884: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c602278>]}
2018-02-08 12:32:24,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f278d68>]}
2018-02-08 12:32:25,038: 12:32:25 | 16 of 40 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 2.69s]
2018-02-08 12:32:25,039: 12:32:25 | 18 of 40 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 12:32:25,039: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 12:32:25,048: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 12:32:25,051: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 12:32:25,051: Re-using an available connection from the pool.
2018-02-08 12:32:25,270: 12:32:25 | 14 of 40 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.75s]
2018-02-08 12:32:25,577: 12:32:25 | 15 of 40 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.76s]
2018-02-08 12:32:25,597: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 12:32:25,795: 12:32:25 | 17 of 40 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.76s]
2018-02-08 12:32:27,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2fa8d0>]}
2018-02-08 12:32:27,969: 12:32:27 | 18 of 40 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.72s]
2018-02-08 12:32:27,969: 12:32:27 | 19 of 40 SKIP relation seo_audit_dev.deepcrawl_class................. [SKIP]
2018-02-08 12:32:27,970: 12:32:27 | 20 of 40 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 12:32:27,970: 12:32:27 | 21 of 40 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 12:32:27,971: Compiling model.seo_audit.search_console_stats_url
2018-02-08 12:32:27,971: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 12:32:27,978: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 12:32:27,983: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 12:32:27,985: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 12:32:27,985: Re-using an available connection from the pool.
2018-02-08 12:32:27,987: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 12:32:27,987: Re-using an available connection from the pool.
2018-02-08 12:32:28,599: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 12:32:28,604: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 12:32:30,790: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f278d68>]}
2018-02-08 12:32:30,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608c88>]}
2018-02-08 12:32:31,006: 12:32:31 | 21 of 40 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 2.82s]
2018-02-08 12:32:31,304: 12:32:31 | 20 of 40 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 2.82s]
2018-02-08 12:32:31,305: 12:32:31 | 22 of 40 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 12:32:31,306: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 12:32:31,305: 12:32:31 | 23 of 40 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 12:32:31,319: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 12:32:31,306: 12:32:31 | 24 of 40 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 12:32:31,319: Compiling model.seo_audit.semrush_url_stats
2018-02-08 12:32:31,306: 12:32:31 | 25 of 40 SKIP relation seo_audit_dev.deepcrawl_classification_stats.. [SKIP]
2018-02-08 12:32:31,320: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 12:32:31,330: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 12:32:31,332: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 12:32:31,347: Re-using an available connection from the pool.
2018-02-08 12:32:31,345: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 12:32:31,355: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 12:32:31,355: Re-using an available connection from the pool.
2018-02-08 12:32:31,352: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 12:32:31,357: Re-using an available connection from the pool.
2018-02-08 12:32:33,011: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 12:32:33,013: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:32:33,014: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:32:34,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f286860>]}
2018-02-08 12:32:34,492: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28d0b8>]}
2018-02-08 12:32:34,805: 12:32:34 | 22 of 40 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 3.18s]
2018-02-08 12:32:35,109: 12:32:35 | 24 of 40 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 3.17s]
2018-02-08 12:32:35,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f28d6d8>]}
2018-02-08 12:32:36,289: 12:32:36 | 23 of 40 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 4.65s]
2018-02-08 12:32:36,290: 12:32:36 | 26 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_filename.. [SKIP]
2018-02-08 12:32:36,290: 12:32:36 | 27 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_query_string [SKIP]
2018-02-08 12:32:36,291: 12:32:36 | 28 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_filename........ [SKIP]
2018-02-08 12:32:36,291: 12:32:36 | 29 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_first_path...... [SKIP]
2018-02-08 12:32:36,291: 12:32:36 | 30 of 40 SKIP relation seo_audit_dev.deepcrawl_class_stats_first_path [SKIP]
2018-02-08 12:32:36,292: 12:32:36 | 31 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_query_string.... [SKIP]
2018-02-08 12:32:36,294: 12:32:36 | 32 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-08 12:32:36,294: 12:32:36 | 33 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-08 12:32:36,295: 12:32:36 | 34 of 40 SKIP relation seo_audit_dev.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-08 12:32:36,295: 12:32:36 | 35 of 40 SKIP relation seo_audit_dev.deepcrawl_reclass_proc.......... [SKIP]
2018-02-08 12:32:36,296: 12:32:36 | 36 of 40 SKIP relation seo_audit_dev.deepcrawl_reclass............... [SKIP]
2018-02-08 12:32:36,296: 12:32:36 | 37 of 40 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 12:32:36,297: Compiling model.seo_audit.agg_stats
2018-02-08 12:32:36,305: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 12:32:36,308: Acquiring new bigquery connection "agg_stats".
2018-02-08 12:32:36,308: Re-using an available connection from the pool.
2018-02-08 12:32:38,122: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 12:32:39,611: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c608128>]}
2018-02-08 12:32:39,868: 12:32:39 | 37 of 40 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 3.31s]
2018-02-08 12:32:39,869: 12:32:39 | 38 of 40 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 12:32:39,869: 12:32:39 | 39 of 40 SKIP relation seo_audit_dev.agg_indicative.................. [SKIP]
2018-02-08 12:32:39,870: Compiling model.seo_audit.agg_stats_client
2018-02-08 12:32:39,880: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 12:32:39,881: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 12:32:39,882: Re-using an available connection from the pool.
2018-02-08 12:32:41,604: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 12:32:44,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98ee8772-28e8-48e7-942c-3bb9404933e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f2c8a90>]}
2018-02-08 12:32:44,753: 12:32:44 | 38 of 40 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 4.67s]
2018-02-08 12:32:44,754: 12:32:44 | 40 of 40 SKIP relation seo_audit_dev.agg_all......................... [SKIP]
2018-02-08 12:32:44,807: 12:32:44 | 
2018-02-08 12:32:44,807: 12:32:44 | Finished running 40 table models in 43.04s.
2018-02-08 12:32:44,808: Connection 'master' was left open.
2018-02-08 12:32:44,808: 
2018-02-08 12:32:44,808: Completed with 1 errors:
2018-02-08 12:32:44,808: 
2018-02-08 12:32:44,808: Database Error in model deepcrawl_class_proc (models/base-adp/deepcrawl/deepcrawl_class_proc.sql)
2018-02-08 12:32:44,808:   Unrecognized name: client at [73:3]
2018-02-08 12:32:44,808:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_class_proc.sql
2018-02-08 12:32:44,808: 
Done. PASS=24 ERROR=1 SKIP=15 TOTAL=40
2018-02-08 12:32:44,808: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15b748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15b8d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f15b780>]}
2018-02-08 12:32:45,020: Flushing usage events
2018-02-08 12:38:00,154: Tracking: tracking
2018-02-08 12:38:00,157: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8c278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8ce80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8ffd0>]}
2018-02-08 12:38:01,018: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-08 12:38:01,046: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-08 12:38:01,052: Parsing core.sql
2018-02-08 12:38:01,083: Parsing adapters/bigquery.sql
2018-02-08 12:38:01,093: Parsing adapters/common.sql
2018-02-08 12:38:01,116: Parsing adapters/postgres.sql
2018-02-08 12:38:01,124: Parsing adapters/redshift.sql
2018-02-08 12:38:01,156: Parsing etc/get_custom_schema.sql
2018-02-08 12:38:01,164: Parsing materializations/archive.sql
2018-02-08 12:38:01,195: Parsing materializations/bigquery.sql
2018-02-08 12:38:01,211: Parsing materializations/helpers.sql
2018-02-08 12:38:01,232: Parsing materializations/incremental.sql
2018-02-08 12:38:01,265: Parsing materializations/table.sql
2018-02-08 12:38:01,285: Parsing materializations/view.sql
2018-02-08 12:38:01,302: Parsing materializations/wrapper.sql
2018-02-08 12:38:01,308: Parsing schema_tests/accepted_values.sql
2018-02-08 12:38:01,314: Parsing schema_tests/not_null.sql
2018-02-08 12:38:01,319: Parsing schema_tests/relationships.sql
2018-02-08 12:38:01,326: Parsing schema_tests/unique.sql
2018-02-08 12:38:01,402: Parsing model.seo_audit.accounts_proc
2018-02-08 12:38:01,406: Parsing model.seo_audit.all_dates
2018-02-08 12:38:01,408: Parsing model.seo_audit.mappings_ga_proc
2018-02-08 12:38:01,410: Acquiring new bigquery connection "master".
2018-02-08 12:38:01,410: Opening a new connection (0 currently allocated)
2018-02-08 12:38:01,417: Parsing model.seo_audit.agg_all
2018-02-08 12:38:01,421: Parsing model.seo_audit.agg_indicative
2018-02-08 12:38:01,423: Parsing model.seo_audit.agg_stats
2018-02-08 12:38:01,427: Parsing model.seo_audit.agg_stats_client
2018-02-08 12:38:01,430: Parsing model.seo_audit.deepcrawl_class
2018-02-08 12:38:01,433: Parsing model.seo_audit.deepcrawl_class_proc
2018-02-08 12:38:01,436: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:38:01,438: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:38:01,440: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:38:01,442: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:38:01,445: Parsing model.seo_audit.deepcrawl_proc
2018-02-08 12:38:01,447: Parsing model.seo_audit.deepcrawl_reclass
2018-02-08 12:38:01,449: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:38:01,455: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:38:01,457: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:38:01,459: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:38:01,460: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:38:01,462: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:38:01,464: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:38:01,466: Parsing model.seo_audit.ga_proc
2018-02-08 12:38:01,468: Parsing model.seo_audit.ga_stats
2018-02-08 12:38:01,470: Parsing model.seo_audit.majestic_domain_history
2018-02-08 12:38:01,472: Parsing model.seo_audit.majestic_domain_proc
2018-02-08 12:38:01,475: Parsing model.seo_audit.majestic_domain_stats
2018-02-08 12:38:01,477: Parsing model.seo_audit.moz_proc
2018-02-08 12:38:01,479: Parsing model.seo_audit.screamingfrog_proc
2018-02-08 12:38:01,482: Parsing model.seo_audit.search_console_history
2018-02-08 12:38:01,484: Parsing model.seo_audit.search_console_proc
2018-02-08 12:38:01,486: Parsing model.seo_audit.search_console_stats_keyword
2018-02-08 12:38:01,489: Parsing model.seo_audit.search_console_stats_url
2018-02-08 12:38:01,491: Parsing model.seo_audit.semrush_domain_proc
2018-02-08 12:38:01,493: Parsing model.seo_audit.semrush_keyword_history
2018-02-08 12:38:01,496: Parsing model.seo_audit.semrush_keyword_proc
2018-02-08 12:38:01,498: Parsing model.seo_audit.semrush_keyword_stats
2018-02-08 12:38:01,501: Parsing model.seo_audit.semrush_url_history
2018-02-08 12:38:01,502: Parsing model.seo_audit.semrush_url_stats
2018-02-08 12:38:01,505: Parsing model.seo_audit.sitemap_proc
2018-02-08 12:38:01,517: Found 40 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-08 12:38:01,527: 
2018-02-08 12:38:02,808: 12:38:02 | Concurrency: 4 threads (target='dev')
2018-02-08 12:38:02,808: 12:38:02 | 
2018-02-08 12:38:03,389: 12:38:03 | 1 of 40 START table model seo_audit_dev.accounts_proc................ [RUN]
2018-02-08 12:38:03,389: Compiling model.seo_audit.accounts_proc
2018-02-08 12:38:03,394: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-08 12:38:03,389: 12:38:03 | 2 of 40 START table model seo_audit_dev.deepcrawl_proc............... [RUN]
2018-02-08 12:38:03,395: Compiling model.seo_audit.deepcrawl_proc
2018-02-08 12:38:03,389: 12:38:03 | 3 of 40 START table model seo_audit_dev.all_dates.................... [RUN]
2018-02-08 12:38:03,399: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-08 12:38:03,399: Compiling model.seo_audit.all_dates
2018-02-08 12:38:03,403: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-08 12:38:03,404: Acquiring new bigquery connection "accounts_proc".
2018-02-08 12:38:03,405: Opening a new connection (1 currently allocated)
2018-02-08 12:38:03,406: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-08 12:38:03,407: Acquiring new bigquery connection "all_dates".
2018-02-08 12:38:03,409: Opening a new connection (2 currently allocated)
2018-02-08 12:38:03,466: Opening a new connection (3 currently allocated)
2018-02-08 12:38:04,567: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-08 12:38:04,582: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-08 12:38:04,737: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url_trimmed,
  length(url) as url_length,
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-08 12:38:06,746: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ccaac8>]}
2018-02-08 12:38:06,782: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d52a90>]}
2018-02-08 12:38:06,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d45f98>]}
2018-02-08 12:38:06,980: 12:38:06 | 1 of 40 OK created table model seo_audit_dev.accounts_proc........... [CREATE TABLE in 3.36s]
2018-02-08 12:38:07,205: 12:38:07 | 3 of 40 OK created table model seo_audit_dev.all_dates............... [CREATE TABLE in 3.38s]
2018-02-08 12:38:07,435: 12:38:07 | 2 of 40 OK created table model seo_audit_dev.deepcrawl_proc.......... [CREATE TABLE in 3.52s]
2018-02-08 12:38:07,437: 12:38:07 | 4 of 40 START table model seo_audit_dev.search_console_proc.......... [RUN]
2018-02-08 12:38:07,437: 12:38:07 | 5 of 40 START table model seo_audit_dev.deepcrawl_class_proc......... [RUN]
2018-02-08 12:38:07,438: 12:38:07 | 6 of 40 START table model seo_audit_dev.semrush_keyword_proc......... [RUN]
2018-02-08 12:38:07,438: Compiling model.seo_audit.search_console_proc
2018-02-08 12:38:07,438: 12:38:07 | 7 of 40 START table model seo_audit_dev.mappings_ga_proc............. [RUN]
2018-02-08 12:38:07,439: Compiling model.seo_audit.deepcrawl_class_proc
2018-02-08 12:38:07,439: Compiling model.seo_audit.semrush_keyword_proc
2018-02-08 12:38:07,446: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-08 12:38:07,446: Compiling model.seo_audit.mappings_ga_proc
2018-02-08 12:38:07,456: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-08 12:38:07,457: Writing injected SQL for node "model.seo_audit.deepcrawl_class_proc"
2018-02-08 12:38:07,463: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-08 12:38:07,467: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-08 12:38:07,467: Re-using an available connection from the pool.
2018-02-08 12:38:07,468: Acquiring new bigquery connection "search_console_proc".
2018-02-08 12:38:07,468: Re-using an available connection from the pool.
2018-02-08 12:38:07,469: Acquiring new bigquery connection "deepcrawl_class_proc".
2018-02-08 12:38:07,469: Re-using an available connection from the pool.
2018-02-08 12:38:07,477: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-08 12:38:07,479: Opening a new connection (4 currently allocated)
2018-02-08 12:38:08,089: Model SQL (deepcrawl_class_proc):
select
url,
path_count,
ifnull(first_path, '') first_path,
ifnull(second_last_path, '') second_last_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
domain,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path

FROM 
 (
  SELECT
  url_trimmed url,
  ARRAY_LENGTH(SPLIT(url_trimmed, '/')) path_count,
  SPLIT(url_trimmed, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(2)] second_last_path,
  ARRAY_REVERSE(SPLIT(url_trimmed, '/'))[SAFE_ORDINAL(1)] last_path,
  split(split(url_trimmed, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)] as query_string,
  url_length,
  first_value(url_length) OVER w3 AS min_url_length,
  domain,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  canonical_url,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit
  FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  )
 WHERE url_length = min_url_length
2018-02-08 12:38:08,564: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:38:08,603: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-08 12:38:08,978: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-08 12:38:10,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76ef0>]}
2018-02-08 12:38:10,587: 12:38:10 | 5 of 40 OK created table model seo_audit_dev.deepcrawl_class_proc.... [CREATE TABLE in 2.85s]
2018-02-08 12:38:10,588: 12:38:10 | 8 of 40 START table model seo_audit_dev.ga_proc...................... [RUN]
2018-02-08 12:38:10,588: Compiling model.seo_audit.ga_proc
2018-02-08 12:38:10,598: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-08 12:38:10,600: Acquiring new bigquery connection "ga_proc".
2018-02-08 12:38:10,600: Re-using an available connection from the pool.
2018-02-08 12:38:10,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d705c0>]}
2018-02-08 12:38:11,026: 12:38:11 | 6 of 40 OK created table model seo_audit_dev.semrush_keyword_proc.... [CREATE TABLE in 3.33s]
2018-02-08 12:38:11,026: 12:38:11 | 9 of 40 START table model seo_audit_dev.majestic_domain_proc......... [RUN]
2018-02-08 12:38:11,026: Compiling model.seo_audit.majestic_domain_proc
2018-02-08 12:38:11,035: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-08 12:38:11,036: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-08 12:38:11,036: Re-using an available connection from the pool.
2018-02-08 12:38:11,138: Model SQL (ga_proc):
SELECT 
date,
unix_date,
account,
platform,
url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, source, medium

)

GROUP BY 
date, unix_date, account, platform, url
2018-02-08 12:38:11,246: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d70f60>]}
2018-02-08 12:38:11,545: 12:38:11 | 7 of 40 OK created table model seo_audit_dev.mappings_ga_proc........ [CREATE TABLE in 3.80s]
2018-02-08 12:38:11,545: 12:38:11 | 10 of 40 START table model seo_audit_dev.sitemap_proc................ [RUN]
2018-02-08 12:38:11,546: Compiling model.seo_audit.sitemap_proc
2018-02-08 12:38:11,556: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-08 12:38:11,557: Acquiring new bigquery connection "sitemap_proc".
2018-02-08 12:38:11,557: Re-using an available connection from the pool.
2018-02-08 12:38:11,595: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-08 12:38:12,151: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-08 12:38:13,299: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76ef0>]}
2018-02-08 12:38:13,519: 12:38:13 | 8 of 40 OK created table model seo_audit_dev.ga_proc................. [CREATE TABLE in 2.71s]
2018-02-08 12:38:13,519: 12:38:13 | 11 of 40 START table model seo_audit_dev.semrush_domain_proc......... [RUN]
2018-02-08 12:38:13,520: Compiling model.seo_audit.semrush_domain_proc
2018-02-08 12:38:13,530: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-08 12:38:13,531: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-08 12:38:13,532: Re-using an available connection from the pool.
2018-02-08 12:38:13,755: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d705c0>]}
2018-02-08 12:38:14,000: 12:38:14 | 9 of 40 OK created table model seo_audit_dev.majestic_domain_proc.... [CREATE TABLE in 2.73s]
2018-02-08 12:38:14,001: 12:38:14 | 12 of 40 START table model seo_audit_dev.moz_proc.................... [RUN]
2018-02-08 12:38:14,001: Compiling model.seo_audit.moz_proc
2018-02-08 12:38:14,011: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-08 12:38:14,013: Acquiring new bigquery connection "moz_proc".
2018-02-08 12:38:14,013: Re-using an available connection from the pool.
2018-02-08 12:38:14,083: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:38:14,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d84b00>]}
2018-02-08 12:38:14,655: 12:38:14 | 10 of 40 OK created table model seo_audit_dev.sitemap_proc........... [CREATE TABLE in 2.78s]
2018-02-08 12:38:14,655: 12:38:14 | 13 of 40 START table model seo_audit_dev.screamingfrog_proc.......... [RUN]
2018-02-08 12:38:14,656: Compiling model.seo_audit.screamingfrog_proc
2018-02-08 12:38:14,667: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-08 12:38:14,668: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-08 12:38:14,668: Re-using an available connection from the pool.
2018-02-08 12:38:14,747: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-08 12:38:15,892: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-08 12:38:16,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c95208>]}
2018-02-08 12:38:16,466: 12:38:16 | 11 of 40 OK created table model seo_audit_dev.semrush_domain_proc.... [CREATE TABLE in 2.73s]
2018-02-08 12:38:16,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d705c0>]}
2018-02-08 12:38:17,215: 12:38:17 | 12 of 40 OK created table model seo_audit_dev.moz_proc............... [CREATE TABLE in 2.92s]
2018-02-08 12:38:18,076: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d84b00>]}
2018-02-08 12:38:18,294: 12:38:18 | 13 of 40 OK created table model seo_audit_dev.screamingfrog_proc..... [CREATE TABLE in 3.42s]
2018-02-08 12:38:25,949: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1017356a0>]}
2018-02-08 12:38:26,161: 12:38:26 | 4 of 40 OK created table model seo_audit_dev.search_console_proc..... [CREATE TABLE in 18.51s]
2018-02-08 12:38:26,162: 12:38:26 | 14 of 40 START table model seo_audit_dev.semrush_keyword_history..... [RUN]
2018-02-08 12:38:26,163: Compiling model.seo_audit.semrush_keyword_history
2018-02-08 12:38:26,162: 12:38:26 | 15 of 40 START table model seo_audit_dev.majestic_domain_history..... [RUN]
2018-02-08 12:38:26,163: 12:38:26 | 16 of 40 START table model seo_audit_dev.semrush_url_history......... [RUN]
2018-02-08 12:38:26,170: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-08 12:38:26,171: Compiling model.seo_audit.majestic_domain_history
2018-02-08 12:38:26,163: 12:38:26 | 17 of 40 START table model seo_audit_dev.search_console_history...... [RUN]
2018-02-08 12:38:26,171: Compiling model.seo_audit.semrush_url_history
2018-02-08 12:38:26,176: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-08 12:38:26,176: Compiling model.seo_audit.search_console_history
2018-02-08 12:38:26,181: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-08 12:38:26,187: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-08 12:38:26,188: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-08 12:38:26,189: Re-using an available connection from the pool.
2018-02-08 12:38:26,189: Acquiring new bigquery connection "majestic_domain_history".
2018-02-08 12:38:26,190: Acquiring new bigquery connection "semrush_url_history".
2018-02-08 12:38:26,191: Acquiring new bigquery connection "search_console_history".
2018-02-08 12:38:26,192: Re-using an available connection from the pool.
2018-02-08 12:38:26,197: Re-using an available connection from the pool.
2018-02-08 12:38:26,201: Re-using an available connection from the pool.
2018-02-08 12:38:26,813: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-08 12:38:26,814: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-08 12:38:26,815: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-08 12:38:26,815: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-08 12:38:28,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d849e8>]}
2018-02-08 12:38:28,987: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76ef0>]}
2018-02-08 12:38:29,004: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c74ef0>]}
2018-02-08 12:38:29,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cc92b0>]}
2018-02-08 12:38:29,195: 12:38:29 | 17 of 40 OK created table model seo_audit_dev.search_console_history. [CREATE TABLE in 2.81s]
2018-02-08 12:38:29,197: 12:38:29 | 18 of 40 START table model seo_audit_dev.ga_stats.................... [RUN]
2018-02-08 12:38:29,199: Compiling model.seo_audit.ga_stats
2018-02-08 12:38:29,209: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-08 12:38:29,210: Acquiring new bigquery connection "ga_stats".
2018-02-08 12:38:29,210: Re-using an available connection from the pool.
2018-02-08 12:38:29,431: 12:38:29 | 15 of 40 OK created table model seo_audit_dev.majestic_domain_history [CREATE TABLE in 2.82s]
2018-02-08 12:38:29,637: 12:38:29 | 14 of 40 OK created table model seo_audit_dev.semrush_keyword_history [CREATE TABLE in 2.84s]
2018-02-08 12:38:29,713: Model SQL (ga_stats):
SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(sessions) OVER w2 as sessions_yoy,
sum(leads) OVER w2 as leads_yoy,
sum(transactions) OVER w2 as transactions_yoy
FROM `curious-domain-121318`.`seo_audit_dev`.`ga_proc`
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-08 12:38:29,914: 12:38:29 | 16 of 40 OK created table model seo_audit_dev.semrush_url_history.... [CREATE TABLE in 2.84s]
2018-02-08 12:38:31,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d849e8>]}
2018-02-08 12:38:32,163: 12:38:32 | 18 of 40 OK created table model seo_audit_dev.ga_stats............... [CREATE TABLE in 2.68s]
2018-02-08 12:38:32,164: 12:38:32 | 19 of 40 START table model seo_audit_dev.deepcrawl_class............. [RUN]
2018-02-08 12:38:32,164: 12:38:32 | 20 of 40 START table model seo_audit_dev.search_console_stats_url.... [RUN]
2018-02-08 12:38:32,164: Compiling model.seo_audit.deepcrawl_class
2018-02-08 12:38:32,165: 12:38:32 | 21 of 40 START table model seo_audit_dev.search_console_stats_keyword [RUN]
2018-02-08 12:38:32,165: Compiling model.seo_audit.search_console_stats_url
2018-02-08 12:38:32,171: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-08 12:38:32,171: Compiling model.seo_audit.search_console_stats_keyword
2018-02-08 12:38:32,175: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-08 12:38:32,181: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-08 12:38:32,182: Acquiring new bigquery connection "deepcrawl_class".
2018-02-08 12:38:32,183: Acquiring new bigquery connection "search_console_stats_url".
2018-02-08 12:38:32,185: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-08 12:38:32,185: Re-using an available connection from the pool.
2018-02-08 12:38:32,186: Re-using an available connection from the pool.
2018-02-08 12:38:32,186: Re-using an available connection from the pool.
2018-02-08 12:38:32,735: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
ORDER BY url asc, date desc
2018-02-08 12:38:32,762: Model SQL (deepcrawl_class):
SELECT 
url,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
a.account domain,
b.client client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	url,
	path_count,
  	first_path,
  	second_last_path,
  	last_path,
  	query_string,
  	filename,
	domain as account,
	'Deepcrawl' as platform,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	canonical_url,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_proc`
) a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
2018-02-08 12:38:32,786: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit_dev`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-08 12:38:35,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76ef0>]}
2018-02-08 12:38:35,314: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c95208>]}
2018-02-08 12:38:35,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1017356a0>]}
2018-02-08 12:38:35,535: 12:38:35 | 20 of 40 OK created table model seo_audit_dev.search_console_stats_url [CREATE TABLE in 3.15s]
2018-02-08 12:38:35,778: 12:38:35 | 21 of 40 OK created table model seo_audit_dev.search_console_stats_keyword [CREATE TABLE in 3.14s]
2018-02-08 12:38:36,013: 12:38:36 | 19 of 40 OK created table model seo_audit_dev.deepcrawl_class........ [CREATE TABLE in 3.15s]
2018-02-08 12:38:36,014: 12:38:36 | 22 of 40 START table model seo_audit_dev.semrush_keyword_stats....... [RUN]
2018-02-08 12:38:36,015: Compiling model.seo_audit.semrush_keyword_stats
2018-02-08 12:38:36,015: 12:38:36 | 23 of 40 START table model seo_audit_dev.deepcrawl_classification_stats [RUN]
2018-02-08 12:38:36,022: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-08 12:38:36,031: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-08 12:38:36,034: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-08 12:38:36,015: 12:38:36 | 24 of 40 START table model seo_audit_dev.semrush_url_stats........... [RUN]
2018-02-08 12:38:36,035: Compiling model.seo_audit.semrush_url_stats
2018-02-08 12:38:36,015: 12:38:36 | 25 of 40 START table model seo_audit_dev.majestic_domain_stats....... [RUN]
2018-02-08 12:38:36,040: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-08 12:38:36,040: Compiling model.seo_audit.majestic_domain_stats
2018-02-08 12:38:36,041: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-08 12:38:36,042: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-08 12:38:36,048: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-08 12:38:36,048: Re-using an available connection from the pool.
2018-02-08 12:38:36,049: Acquiring new bigquery connection "semrush_url_stats".
2018-02-08 12:38:36,051: Re-using an available connection from the pool.
2018-02-08 12:38:36,052: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-08 12:38:36,055: Re-using an available connection from the pool.
2018-02-08 12:38:36,060: Re-using an available connection from the pool.
2018-02-08 12:38:36,628: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-08 12:38:36,629: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-08 12:38:36,698: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:38:36,699: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit_dev`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-08 12:38:39,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76ef0>]}
2018-02-08 12:38:39,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102008a90>]}
2018-02-08 12:38:40,186: 12:38:40 | 22 of 40 OK created table model seo_audit_dev.semrush_keyword_stats.. [CREATE TABLE in 3.86s]
2018-02-08 12:38:40,503: 12:38:40 | 25 of 40 OK created table model seo_audit_dev.majestic_domain_stats.. [CREATE TABLE in 3.90s]
2018-02-08 12:38:40,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c74f98>]}
2018-02-08 12:38:41,053: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1020252e8>]}
2018-02-08 12:38:41,214: 12:38:41 | 23 of 40 OK created table model seo_audit_dev.deepcrawl_classification_stats [CREATE TABLE in 4.92s]
2018-02-08 12:38:41,454: 12:38:41 | 24 of 40 OK created table model seo_audit_dev.semrush_url_stats...... [CREATE TABLE in 5.02s]
2018-02-08 12:38:41,455: 12:38:41 | 26 of 40 START table model seo_audit_dev.deepcrawl_rules_filename.... [RUN]
2018-02-08 12:38:41,456: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-08 12:38:41,455: 12:38:41 | 27 of 40 START table model seo_audit_dev.deepcrawl_class_stats_query_string [RUN]
2018-02-08 12:38:41,462: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-08 12:38:41,467: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-08 12:38:41,468: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-08 12:38:41,455: 12:38:41 | 28 of 40 START table model seo_audit_dev.deepcrawl_class_stats_filename [RUN]
2018-02-08 12:38:41,469: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-08 12:38:41,473: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-08 12:38:41,456: 12:38:41 | 29 of 40 START table model seo_audit_dev.deepcrawl_rules_first_path.. [RUN]
2018-02-08 12:38:41,474: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-08 12:38:41,474: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-08 12:38:41,475: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-08 12:38:41,475: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-08 12:38:41,476: Re-using an available connection from the pool.
2018-02-08 12:38:41,480: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-08 12:38:41,480: Re-using an available connection from the pool.
2018-02-08 12:38:41,482: Re-using an available connection from the pool.
2018-02-08 12:38:41,489: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-08 12:38:41,489: Re-using an available connection from the pool.
2018-02-08 12:38:42,014: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:38:42,042: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-08 12:38:42,128: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:38:42,129: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-08 12:38:43,125: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d769e8>]}
2018-02-08 12:38:43,356: 12:38:43 | 29 of 40 OK created table model seo_audit_dev.deepcrawl_rules_first_path [CREATE TABLE in 1.65s]
2018-02-08 12:38:43,357: 12:38:43 | 30 of 40 START table model seo_audit_dev.deepcrawl_rules_query_string [RUN]
2018-02-08 12:38:43,357: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-08 12:38:43,364: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-08 12:38:43,365: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-08 12:38:43,365: Re-using an available connection from the pool.
2018-02-08 12:38:44,003: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-08 12:38:44,191: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102017be0>]}
2018-02-08 12:38:44,309: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76cc0>]}
2018-02-08 12:38:44,507: 12:38:44 | 27 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_query_string [CREATE TABLE in 2.73s]
2018-02-08 12:38:44,509: 12:38:44 | 31 of 40 START table model seo_audit_dev.deepcrawl_class_stats_first_path [RUN]
2018-02-08 12:38:44,511: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-08 12:38:44,521: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-08 12:38:44,522: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-08 12:38:44,522: Re-using an available connection from the pool.
2018-02-08 12:38:44,950: 12:38:44 | 28 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_filename [CREATE TABLE in 2.84s]
2018-02-08 12:38:45,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d769e8>]}
2018-02-08 12:38:45,098: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-08 12:38:45,391: 12:38:45 | 30 of 40 OK created table model seo_audit_dev.deepcrawl_rules_query_string [CREATE TABLE in 1.73s]
2018-02-08 12:38:45,769: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1017356a0>]}
2018-02-08 12:38:46,027: 12:38:46 | 26 of 40 OK created table model seo_audit_dev.deepcrawl_rules_filename [CREATE TABLE in 4.31s]
2018-02-08 12:38:46,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102011208>]}
2018-02-08 12:38:46,462: 12:38:46 | 31 of 40 OK created table model seo_audit_dev.deepcrawl_class_stats_first_path [CREATE TABLE in 1.73s]
2018-02-08 12:38:46,463: 12:38:46 | 32 of 40 START table model seo_audit_dev.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-08 12:38:46,464: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-08 12:38:46,464: 12:38:46 | 33 of 40 START table model seo_audit_dev.deepcrawl_rules_filename_unclassified [RUN]
2018-02-08 12:38:46,471: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-08 12:38:46,479: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-08 12:38:46,482: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-08 12:38:46,464: 12:38:46 | 34 of 40 START table model seo_audit_dev.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-08 12:38:46,482: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-08 12:38:46,491: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-08 12:38:46,493: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-08 12:38:46,494: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-08 12:38:46,494: Re-using an available connection from the pool.
2018-02-08 12:38:46,495: Re-using an available connection from the pool.
2018-02-08 12:38:46,496: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-08 12:38:46,500: Re-using an available connection from the pool.
2018-02-08 12:38:46,977: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-08 12:38:47,015: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-08 12:38:47,033: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-08 12:38:48,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102040630>]}
2018-02-08 12:38:48,096: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c95208>]}
2018-02-08 12:38:48,109: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1020082b0>]}
2018-02-08 12:38:48,357: 12:38:48 | 33 of 40 OK created table model seo_audit_dev.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.59s]
2018-02-08 12:38:48,646: 12:38:48 | 32 of 40 OK created table model seo_audit_dev.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.63s]
2018-02-08 12:38:48,954: 12:38:48 | 34 of 40 OK created table model seo_audit_dev.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.63s]
2018-02-08 12:38:48,955: 12:38:48 | 35 of 40 START table model seo_audit_dev.deepcrawl_reclass_proc...... [RUN]
2018-02-08 12:38:48,955: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-08 12:38:48,969: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-08 12:38:48,970: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-08 12:38:48,970: Re-using an available connection from the pool.
2018-02-08 12:38:49,519: Model SQL (deepcrawl_reclass_proc):
SELECT 
url,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
a.first_path first_path,
second_last_path,
last_path,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-08 12:38:51,691: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d849e8>]}
2018-02-08 12:38:51,956: 12:38:51 | 35 of 40 OK created table model seo_audit_dev.deepcrawl_reclass_proc. [CREATE TABLE in 2.74s]
2018-02-08 12:38:51,957: 12:38:51 | 36 of 40 START table model seo_audit_dev.deepcrawl_reclass........... [RUN]
2018-02-08 12:38:51,958: Compiling model.seo_audit.deepcrawl_reclass
2018-02-08 12:38:51,965: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-08 12:38:51,968: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-08 12:38:51,969: Re-using an available connection from the pool.
2018-02-08 12:38:52,560: Model SQL (deepcrawl_reclass):
SELECT 
url,
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
domain,
client,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
second_last_path,
last_path,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass_proc`
2018-02-08 12:38:53,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104da65c0>]}
2018-02-08 12:38:53,855: 12:38:53 | 36 of 40 OK created table model seo_audit_dev.deepcrawl_reclass...... [CREATE TABLE in 1.68s]
2018-02-08 12:38:53,855: 12:38:53 | 37 of 40 START table model seo_audit_dev.agg_stats................... [RUN]
2018-02-08 12:38:53,856: Compiling model.seo_audit.agg_stats
2018-02-08 12:38:53,869: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-08 12:38:53,870: Acquiring new bigquery connection "agg_stats".
2018-02-08 12:38:53,870: Re-using an available connection from the pool.
2018-02-08 12:38:54,463: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
sessions_yoy,
leads_yoy,
transactions_yoy
FROM  
  `curious-domain-121318`.`seo_audit_dev`.`ga_stats`
2018-02-08 12:38:56,618: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cca550>]}
2018-02-08 12:38:56,910: 12:38:56 | 37 of 40 OK created table model seo_audit_dev.agg_stats.............. [CREATE TABLE in 2.76s]
2018-02-08 12:38:56,911: 12:38:56 | 38 of 40 START table model seo_audit_dev.agg_indicative.............. [RUN]
2018-02-08 12:38:56,911: 12:38:56 | 39 of 40 START table model seo_audit_dev.agg_stats_client............ [RUN]
2018-02-08 12:38:56,912: Compiling model.seo_audit.agg_indicative
2018-02-08 12:38:56,912: Compiling model.seo_audit.agg_stats_client
2018-02-08 12:38:56,926: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-08 12:38:56,927: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-08 12:38:56,928: Acquiring new bigquery connection "agg_stats_client".
2018-02-08 12:38:56,929: Re-using an available connection from the pool.
2018-02-08 12:38:56,929: Acquiring new bigquery connection "agg_indicative".
2018-02-08 12:38:56,929: Re-using an available connection from the pool.
2018-02-08 12:38:57,459: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit_dev`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-08 12:38:57,541: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(canonical_url) canonical_url,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag
FROM `curious-domain-121318`.`seo_audit_dev`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-08 12:38:59,607: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102040cf8>]}
2018-02-08 12:38:59,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c74ef0>]}
2018-02-08 12:38:59,972: 12:38:59 | 39 of 40 OK created table model seo_audit_dev.agg_stats_client....... [CREATE TABLE in 2.70s]
2018-02-08 12:39:00,262: 12:39:00 | 38 of 40 OK created table model seo_audit_dev.agg_indicative......... [CREATE TABLE in 2.79s]
2018-02-08 12:39:00,263: 12:39:00 | 40 of 40 START table model seo_audit_dev.agg_all..................... [RUN]
2018-02-08 12:39:00,263: Compiling model.seo_audit.agg_all
2018-02-08 12:39:00,271: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-08 12:39:00,273: Acquiring new bigquery connection "agg_all".
2018-02-08 12:39:00,273: Re-using an available connection from the pool.
2018-02-08 12:39:00,896: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
domain,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
page_title_length,
description,
description_length,
indexable,
canonical_url,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
sessions_mom,
leads_mom,
transactions_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit_dev`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit_dev`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-08 12:39:03,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd00cf5d9-45c8-4ff6-995f-b7e3a18735c2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104cca550>]}
2018-02-08 12:39:03,717: 12:39:03 | 40 of 40 OK created table model seo_audit_dev.agg_all................ [CREATE TABLE in 2.81s]
2018-02-08 12:39:03,807: 12:39:03 | 
2018-02-08 12:39:03,807: 12:39:03 | Finished running 40 table models in 61.00s.
2018-02-08 12:39:03,808: Connection 'master' was left open.
2018-02-08 12:39:03,808: 
2018-02-08 12:39:03,808: Completed successfully
2018-02-08 12:39:03,809: 
Done. PASS=40 ERROR=0 SKIP=0 TOTAL=40
2018-02-08 12:39:03,809: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c95320>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c5e7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c5e6a0>]}
2018-02-08 12:39:04,035: Flushing usage events
