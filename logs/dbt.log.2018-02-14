2018-02-13 15:20:16,045: Tracking: tracking
2018-02-13 15:20:16,053: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103b5c5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103b5c390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054c19e8>]}
2018-02-13 15:20:16,855: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:20:16,873: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:20:16,878: Parsing core.sql
2018-02-13 15:20:16,900: Parsing adapters/bigquery.sql
2018-02-13 15:20:16,908: Parsing adapters/common.sql
2018-02-13 15:20:16,932: Parsing adapters/postgres.sql
2018-02-13 15:20:16,939: Parsing adapters/redshift.sql
2018-02-13 15:20:16,961: Parsing etc/get_custom_schema.sql
2018-02-13 15:20:16,970: Parsing materializations/archive.sql
2018-02-13 15:20:17,009: Parsing materializations/bigquery.sql
2018-02-13 15:20:17,044: Parsing materializations/helpers.sql
2018-02-13 15:20:17,078: Parsing materializations/incremental.sql
2018-02-13 15:20:17,117: Parsing materializations/table.sql
2018-02-13 15:20:17,150: Parsing materializations/view.sql
2018-02-13 15:20:17,213: Parsing materializations/wrapper.sql
2018-02-13 15:20:17,221: Parsing schema_tests/accepted_values.sql
2018-02-13 15:20:17,241: Parsing schema_tests/not_null.sql
2018-02-13 15:20:17,249: Parsing schema_tests/relationships.sql
2018-02-13 15:20:17,255: Parsing schema_tests/unique.sql
2018-02-13 15:20:17,372: Parsing model.seo_audit.actions
2018-02-13 15:20:17,384: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055ebc50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055eb780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055eba20>]}
2018-02-13 15:20:17,746: Encountered an error:
2018-02-13 15:20:17,746: Compilation Error in model actions (models/actions/actions.sql)
  Required var 'high_volume_keyword_threshold' not found in config:
  Vars supplied to actions = {
      "accounts": "`curious-domain-121318.seo_audit.accounts`",
      "brand_keywords": "('cifl', 'losers', 'coding is for losers')",
      "deepcrawl_pct_of_classification_rule": 0.9,
      "deepcrawl_pct_of_value_rule": 0.3,
      "ga": "`curious-domain-121318.seo_audit.ga`",
      "gsc": "`curious-domain-121318.seo_audit.gsc`",
      "majestic": "`curious-domain-121318.seo_audit.majestic`",
      "mappings_ga": "`curious-domain-121318.seo_audit.mappings_ga`",
      "moz": "`curious-domain-121318.seo_audit.moz`",
      "screamingfrog": "`curious-domain-121318.seo_audit.screamingfrog`",
      "semrush_domain": "`curious-domain-121318.seo_audit.semrush_domain`",
      "semrush_keyword": "`curious-domain-121318.seo_audit.semrush_keyword`",
      "sitemap": "`curious-domain-121318.seo_audit.sitemap`"
  }
2018-02-13 15:20:17,824: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 183, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 179, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 278, in compile
    root_project, all_projects)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 23, in load_all
    loader.load_all(root_project, all_projects, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 48, in load_all
    project, project_name, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 85, in load_project
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 338, in load_and_parse_sql
    return parse_sql_nodes(result, root_project, all_projects, tags, macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 282, in parse_sql_nodes
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 231, in parse_node
    capture_macros=True)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 171, in get_rendered
    return render_template(template, ctx, node)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 158, in render_template
    return template.render(ctx)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 76, in render
    return original_render(self, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 1008, in render
    return self.environment.handle_exception(exc_info, True)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 780, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/_compat.py", line 37, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 32, in top-level template code
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 204, in __call__
    self.assert_var_defined(var_name, default)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 188, in assert_var_defined
    self.model
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 115, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model actions (models/actions/actions.sql)
  Required var 'high_volume_keyword_threshold' not found in config:
  Vars supplied to actions = {
      "accounts": "`curious-domain-121318.seo_audit.accounts`",
      "brand_keywords": "('cifl', 'losers', 'coding is for losers')",
      "deepcrawl_pct_of_classification_rule": 0.9,
      "deepcrawl_pct_of_value_rule": 0.3,
      "ga": "`curious-domain-121318.seo_audit.ga`",
      "gsc": "`curious-domain-121318.seo_audit.gsc`",
      "majestic": "`curious-domain-121318.seo_audit.majestic`",
      "mappings_ga": "`curious-domain-121318.seo_audit.mappings_ga`",
      "moz": "`curious-domain-121318.seo_audit.moz`",
      "screamingfrog": "`curious-domain-121318.seo_audit.screamingfrog`",
      "semrush_domain": "`curious-domain-121318.seo_audit.semrush_domain`",
      "semrush_keyword": "`curious-domain-121318.seo_audit.semrush_keyword`",
      "sitemap": "`curious-domain-121318.seo_audit.sitemap`"
  }

2018-02-13 15:25:14,312: Tracking: tracking
2018-02-13 15:25:14,318: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10751b5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10751b390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108e9ee10>]}
2018-02-13 15:25:15,090: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:25:15,121: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:25:15,127: Parsing core.sql
2018-02-13 15:25:15,159: Parsing adapters/bigquery.sql
2018-02-13 15:25:15,167: Parsing adapters/common.sql
2018-02-13 15:25:15,196: Parsing adapters/postgres.sql
2018-02-13 15:25:15,203: Parsing adapters/redshift.sql
2018-02-13 15:25:15,243: Parsing etc/get_custom_schema.sql
2018-02-13 15:25:15,257: Parsing materializations/archive.sql
2018-02-13 15:25:15,325: Parsing materializations/bigquery.sql
2018-02-13 15:25:15,355: Parsing materializations/helpers.sql
2018-02-13 15:25:15,380: Parsing materializations/incremental.sql
2018-02-13 15:25:15,419: Parsing materializations/table.sql
2018-02-13 15:25:15,442: Parsing materializations/view.sql
2018-02-13 15:25:15,460: Parsing materializations/wrapper.sql
2018-02-13 15:25:15,465: Parsing schema_tests/accepted_values.sql
2018-02-13 15:25:15,471: Parsing schema_tests/not_null.sql
2018-02-13 15:25:15,477: Parsing schema_tests/relationships.sql
2018-02-13 15:25:15,484: Parsing schema_tests/unique.sql
2018-02-13 15:25:15,547: Parsing model.seo_audit.actions
2018-02-13 15:25:15,551: Acquiring new bigquery connection "master".
2018-02-13 15:25:15,551: Opening a new connection (0 currently allocated)
2018-02-13 15:25:15,557: Parsing model.seo_audit.accounts_proc
2018-02-13 15:25:15,563: Parsing model.seo_audit.all_dates
2018-02-13 15:25:15,566: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:25:15,573: Parsing model.seo_audit.agg_all
2018-02-13 15:25:15,581: Parsing model.seo_audit.agg_indicative
2018-02-13 15:25:15,585: Parsing model.seo_audit.agg_stats
2018-02-13 15:25:15,594: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:25:15,603: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:25:15,608: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:25:15,613: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:25:15,618: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:25:15,623: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:25:15,629: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:25:15,634: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:25:15,641: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:25:15,658: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:25:15,661: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:25:15,665: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:25:15,667: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:25:15,669: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:25:15,672: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:25:15,674: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:25:15,679: Parsing model.seo_audit.ga_proc
2018-02-13 15:25:15,684: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:25:15,687: Parsing model.seo_audit.ga_stats
2018-02-13 15:25:15,690: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:25:15,693: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:25:15,697: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:25:15,703: Parsing model.seo_audit.moz_proc
2018-02-13 15:25:15,709: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:25:15,715: Parsing model.seo_audit.search_console_history
2018-02-13 15:25:15,719: Parsing model.seo_audit.search_console_proc
2018-02-13 15:25:15,723: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:25:15,727: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:25:15,731: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:25:15,734: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:25:15,740: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:25:15,744: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:25:15,749: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:25:15,752: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:25:15,756: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:25:15,779: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:25:15,796: 
2018-02-13 15:25:17,050: 15:25:17 | Concurrency: 4 threads (target='prod')
2018-02-13 15:25:17,050: 15:25:17 | 
2018-02-13 15:25:17,647: 15:25:17 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:25:17,648: Compiling model.seo_audit.accounts_proc
2018-02-13 15:25:17,647: 15:25:17 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:25:17,660: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:25:17,660: Compiling model.seo_audit.all_dates
2018-02-13 15:25:17,648: 15:25:17 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:25:17,669: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:25:17,670: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:25:17,671: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:25:17,683: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:25:17,683: Opening a new connection (1 currently allocated)
2018-02-13 15:25:17,685: Acquiring new bigquery connection "all_dates".
2018-02-13 15:25:17,688: Opening a new connection (2 currently allocated)
2018-02-13 15:25:17,852: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:25:17,852: Opening a new connection (3 currently allocated)
2018-02-13 15:25:18,880: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:25:18,880: Bad request while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:25:18,880: 400 Unrecognized name: infinite_scroll at [43:11]
2018-02-13 15:25:18,880: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109069198>]}
2018-02-13 15:25:18,957: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:25:19,086: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:25:19,173: 15:25:19 | 3 of 42 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 1.21s]
2018-02-13 15:25:20,144: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fb0f60>]}
2018-02-13 15:25:20,445: 15:25:20 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.48s]
2018-02-13 15:25:21,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fb0da0>]}
2018-02-13 15:25:21,614: 15:25:21 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.69s]
2018-02-13 15:25:21,615: 15:25:21 | 4 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:25:21,616: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:25:21,615: 15:25:21 | 5 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:25:21,626: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:25:21,627: Compiling model.seo_audit.search_console_proc
2018-02-13 15:25:21,615: 15:25:21 | 6 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:25:21,616: 15:25:21 | 7 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:25:21,632: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:25:21,632: Compiling model.seo_audit.moz_proc
2018-02-13 15:25:21,633: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:25:21,633: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:25:21,640: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:25:21,661: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:25:21,647: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:25:21,648: Re-using an available connection from the pool.
2018-02-13 15:25:21,662: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:25:21,673: Re-using an available connection from the pool.
2018-02-13 15:25:21,649: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:25:21,690: Re-using an available connection from the pool.
2018-02-13 15:25:21,694: Opening a new connection (4 currently allocated)
2018-02-13 15:25:22,457: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:25:22,532: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:25:22,874: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:25:23,239: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:25:25,530: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10906c588>]}
2018-02-13 15:25:25,772: 15:25:25 | 7 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.90s]
2018-02-13 15:25:25,773: 15:25:25 | 8 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:25:25,773: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:25:25,781: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:25:25,782: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:25:25,782: Re-using an available connection from the pool.
2018-02-13 15:25:25,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fb0780>]}
2018-02-13 15:25:26,136: 15:25:26 | 4 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.26s]
2018-02-13 15:25:26,137: 15:25:26 | 9 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:25:26,137: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:25:26,145: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:25:26,146: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:25:26,146: Re-using an available connection from the pool.
2018-02-13 15:25:26,313: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109069e10>]}
2018-02-13 15:25:26,401: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:25:26,568: 15:25:26 | 5 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.69s]
2018-02-13 15:25:26,568: 15:25:26 | 10 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 15:25:26,568: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:25:26,575: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:25:26,578: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:25:26,578: Re-using an available connection from the pool.
2018-02-13 15:25:26,901: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:25:27,246: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:25:28,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10906c588>]}
2018-02-13 15:25:29,348: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fb0780>]}
2018-02-13 15:25:29,351: 15:25:29 | 8 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.08s]
2018-02-13 15:25:29,352: 15:25:29 | 11 of 42 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-02-13 15:25:29,352: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:25:29,365: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:25:29,368: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:25:29,369: Re-using an available connection from the pool.
2018-02-13 15:25:29,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109069e10>]}
2018-02-13 15:25:29,809: 15:25:29 | 9 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.21s]
2018-02-13 15:25:29,905: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1090798d0>]}
2018-02-13 15:25:30,127: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:25:30,185: 15:25:30 | 10 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.17s]
2018-02-13 15:25:30,535: 15:25:30 | 6 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 8.27s]
2018-02-13 15:25:32,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10906c588>]}
2018-02-13 15:25:32,814: 15:25:32 | 11 of 42 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 3.06s]
2018-02-13 15:25:32,815: 15:25:32 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:25:32,816: 15:25:32 | 13 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:25:32,816: 15:25:32 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:25:32,816: 15:25:32 | 15 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:25:32,817: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:25:32,817: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:25:32,817: Compiling model.seo_audit.search_console_history
2018-02-13 15:25:32,817: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:25:32,833: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:25:32,839: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:25:32,841: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:25:32,845: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:25:32,846: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:25:32,846: Re-using an available connection from the pool.
2018-02-13 15:25:32,848: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:25:32,848: Re-using an available connection from the pool.
2018-02-13 15:25:32,849: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:25:32,852: Re-using an available connection from the pool.
2018-02-13 15:25:32,859: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:25:32,860: Re-using an available connection from the pool.
2018-02-13 15:25:33,712: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:25:33,713: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:25:33,717: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:25:33,828: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:25:36,154: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fb0780>]}
2018-02-13 15:25:36,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fcb080>]}
2018-02-13 15:25:36,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109048710>]}
2018-02-13 15:25:36,490: 15:25:36 | 13 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.34s]
2018-02-13 15:25:36,491: 15:25:36 | 16 of 42 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-02-13 15:25:36,928: 15:25:36 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.39s]
2018-02-13 15:25:37,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b11ba8>]}
2018-02-13 15:25:37,797: 15:25:37 | 15 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.44s]
2018-02-13 15:25:38,141: 15:25:38 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.67s]
2018-02-13 15:25:38,142: 15:25:38 | 17 of 42 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-13 15:25:38,143: 15:25:38 | 18 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:25:38,143: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:25:38,143: 15:25:38 | 19 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:25:38,154: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:25:38,154: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:25:38,159: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:25:38,160: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:25:38,160: Re-using an available connection from the pool.
2018-02-13 15:25:38,162: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:25:38,163: Re-using an available connection from the pool.
2018-02-13 15:25:38,883: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:25:38,889: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:25:41,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109000518>]}
2018-02-13 15:25:41,244: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b044e0>]}
2018-02-13 15:25:41,776: 15:25:41 | 18 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.10s]
2018-02-13 15:25:42,084: 15:25:42 | 19 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.09s]
2018-02-13 15:25:42,085: 15:25:42 | 20 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:25:42,086: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:25:42,093: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:25:42,085: 15:25:42 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:25:42,094: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:25:42,085: 15:25:42 | 22 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:25:42,100: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:25:42,100: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:25:42,086: 15:25:42 | 23 of 42 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-02-13 15:25:42,101: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:25:42,106: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:25:42,107: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:25:42,108: Re-using an available connection from the pool.
2018-02-13 15:25:42,109: Re-using an available connection from the pool.
2018-02-13 15:25:42,113: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:25:42,115: Re-using an available connection from the pool.
2018-02-13 15:25:42,817: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:25:42,843: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:25:42,914: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:25:45,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b22c50>]}
2018-02-13 15:25:45,246: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b22470>]}
2018-02-13 15:25:45,668: 15:25:45 | 20 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.12s]
2018-02-13 15:25:46,328: 15:25:46 | 22 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.15s]
2018-02-13 15:25:48,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84ef0418-bf10-49e6-b471-015905c17276', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109000518>]}
2018-02-13 15:25:48,832: 15:25:48 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 6.45s]
2018-02-13 15:25:48,833: 15:25:48 | 24 of 42 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-02-13 15:25:48,833: 15:25:48 | 25 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-02-13 15:25:48,833: 15:25:48 | 26 of 42 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-02-13 15:25:48,834: 15:25:48 | 27 of 42 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-02-13 15:25:48,834: 15:25:48 | 28 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-02-13 15:25:48,834: 15:25:48 | 29 of 42 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-02-13 15:25:48,836: 15:25:48 | 30 of 42 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-13 15:25:48,837: 15:25:48 | 31 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-13 15:25:48,837: 15:25:48 | 32 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-13 15:25:48,838: 15:25:48 | 33 of 42 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-02-13 15:25:48,839: 15:25:48 | 34 of 42 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-02-13 15:25:48,840: 15:25:48 | 35 of 42 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-02-13 15:25:48,840: 15:25:48 | 36 of 42 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-02-13 15:25:48,841: 15:25:48 | 37 of 42 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-02-13 15:25:48,842: 15:25:48 | 38 of 42 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-02-13 15:25:48,843: 15:25:48 | 39 of 42 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-02-13 15:25:48,844: 15:25:48 | 40 of 42 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-02-13 15:25:48,845: 15:25:48 | 41 of 42 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-02-13 15:25:48,845: 15:25:48 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:25:48,944: 15:25:48 | 
2018-02-13 15:25:48,945: 15:25:48 | Finished running 42 table models in 31.90s.
2018-02-13 15:25:48,945: Connection 'master' was left open.
2018-02-13 15:25:48,945: 
2018-02-13 15:25:48,945: Completed with 1 errors:
2018-02-13 15:25:48,946: 
2018-02-13 15:25:48,946: Database Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-13 15:25:48,946:   Unrecognized name: infinite_scroll at [43:11]
2018-02-13 15:25:48,947:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_proc.sql
2018-02-13 15:25:48,947: 
Done. PASS=19 ERROR=1 SKIP=22 TOTAL=42
2018-02-13 15:25:48,947: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108f8d358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108f555f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108f556d8>]}
2018-02-13 15:25:49,191: Flushing usage events
2018-02-13 15:27:17,873: Tracking: tracking
2018-02-13 15:27:17,879: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec3eda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec3ee48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec3e9e8>]}
2018-02-13 15:27:18,698: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:27:18,722: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:27:18,728: Parsing core.sql
2018-02-13 15:27:18,747: Parsing adapters/bigquery.sql
2018-02-13 15:27:18,754: Parsing adapters/common.sql
2018-02-13 15:27:18,770: Parsing adapters/postgres.sql
2018-02-13 15:27:18,779: Parsing adapters/redshift.sql
2018-02-13 15:27:18,805: Parsing etc/get_custom_schema.sql
2018-02-13 15:27:18,817: Parsing materializations/archive.sql
2018-02-13 15:27:18,850: Parsing materializations/bigquery.sql
2018-02-13 15:27:18,865: Parsing materializations/helpers.sql
2018-02-13 15:27:18,883: Parsing materializations/incremental.sql
2018-02-13 15:27:18,916: Parsing materializations/table.sql
2018-02-13 15:27:18,941: Parsing materializations/view.sql
2018-02-13 15:27:18,958: Parsing materializations/wrapper.sql
2018-02-13 15:27:18,964: Parsing schema_tests/accepted_values.sql
2018-02-13 15:27:18,970: Parsing schema_tests/not_null.sql
2018-02-13 15:27:18,974: Parsing schema_tests/relationships.sql
2018-02-13 15:27:18,980: Parsing schema_tests/unique.sql
2018-02-13 15:27:19,043: Parsing model.seo_audit.actions
2018-02-13 15:27:19,048: Acquiring new bigquery connection "master".
2018-02-13 15:27:19,048: Opening a new connection (0 currently allocated)
2018-02-13 15:27:19,051: Parsing model.seo_audit.accounts_proc
2018-02-13 15:27:19,054: Parsing model.seo_audit.all_dates
2018-02-13 15:27:19,055: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:27:19,059: Parsing model.seo_audit.agg_all
2018-02-13 15:27:19,062: Parsing model.seo_audit.agg_indicative
2018-02-13 15:27:19,065: Parsing model.seo_audit.agg_stats
2018-02-13 15:27:19,070: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:27:19,073: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:27:19,075: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:27:19,076: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:27:19,078: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:27:19,080: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:27:19,082: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:27:19,084: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:27:19,086: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:27:19,093: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:27:19,094: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:27:19,096: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:27:19,098: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:27:19,099: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:27:19,101: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:27:19,103: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:27:19,106: Parsing model.seo_audit.ga_proc
2018-02-13 15:27:19,109: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:27:19,111: Parsing model.seo_audit.ga_stats
2018-02-13 15:27:19,114: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:27:19,115: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:27:19,118: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:27:19,120: Parsing model.seo_audit.moz_proc
2018-02-13 15:27:19,122: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:27:19,125: Parsing model.seo_audit.search_console_history
2018-02-13 15:27:19,127: Parsing model.seo_audit.search_console_proc
2018-02-13 15:27:19,130: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:27:19,132: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:27:19,134: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:27:19,136: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:27:19,139: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:27:19,141: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:27:19,144: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:27:19,146: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:27:19,148: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:27:19,160: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:27:19,173: 
2018-02-13 15:27:20,014: 15:27:20 | Concurrency: 4 threads (target='prod')
2018-02-13 15:27:20,014: 15:27:20 | 
2018-02-13 15:27:20,259: 15:27:20 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:27:20,259: Compiling model.seo_audit.accounts_proc
2018-02-13 15:27:20,259: 15:27:20 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:27:20,264: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:27:20,259: 15:27:20 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:27:20,264: Compiling model.seo_audit.all_dates
2018-02-13 15:27:20,264: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:27:20,268: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:27:20,273: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:27:20,277: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:27:20,278: Acquiring new bigquery connection "all_dates".
2018-02-13 15:27:20,278: Opening a new connection (1 currently allocated)
2018-02-13 15:27:20,279: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:27:20,281: Opening a new connection (2 currently allocated)
2018-02-13 15:27:20,337: Opening a new connection (3 currently allocated)
2018-02-13 15:27:21,155: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:27:21,156: Unhandled error while running:
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcrawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:27:21,156: 404 Not found: Table curious-domain-121318:seo_audit.deepcrawl_cifl
2018-02-13 15:27:21,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee00b70>]}
2018-02-13 15:27:21,408: 15:27:21 | 3 of 42 ERROR creating table model seo_audit.deepcrawl_proc.......... [ERROR in 0.89s]
2018-02-13 15:27:21,420: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:27:21,464: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:27:22,936: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc97f0>]}
2018-02-13 15:27:22,954: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc97b8>]}
2018-02-13 15:27:23,180: 15:27:23 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.68s]
2018-02-13 15:27:23,438: 15:27:23 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.69s]
2018-02-13 15:27:23,439: 15:27:23 | 4 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:27:23,440: 15:27:23 | 5 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:27:23,440: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:27:23,440: 15:27:23 | 6 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:27:23,441: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:27:23,440: 15:27:23 | 7 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:27:23,451: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:27:23,451: Compiling model.seo_audit.moz_proc
2018-02-13 15:27:23,464: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:27:23,470: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:27:23,481: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:27:23,488: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:27:23,494: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:27:23,495: Re-using an available connection from the pool.
2018-02-13 15:27:23,500: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:27:23,500: Re-using an available connection from the pool.
2018-02-13 15:27:23,502: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:27:23,503: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:27:23,504: Re-using an available connection from the pool.
2018-02-13 15:27:23,504: Opening a new connection (4 currently allocated)
2018-02-13 15:27:24,733: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:27:24,768: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:27:24,829: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:27:24,987: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:27:26,949: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed6fa90>]}
2018-02-13 15:27:26,959: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee00390>]}
2018-02-13 15:27:27,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc9668>]}
2018-02-13 15:27:27,275: 15:27:27 | 6 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.50s]
2018-02-13 15:27:27,276: 15:27:27 | 8 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:27:27,278: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:27:27,290: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:27:27,292: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:27:27,292: Re-using an available connection from the pool.
2018-02-13 15:27:27,599: 15:27:27 | 7 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 3.49s]
2018-02-13 15:27:27,601: 15:27:27 | 9 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:27:27,601: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:27:27,613: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:27:27,617: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:27:27,618: Re-using an available connection from the pool.
2018-02-13 15:27:27,922: 15:27:27 | 5 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.73s]
2018-02-13 15:27:27,922: 15:27:27 | 10 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:27:27,922: Compiling model.seo_audit.search_console_proc
2018-02-13 15:27:27,928: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:27:27,931: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:27:27,931: Re-using an available connection from the pool.
2018-02-13 15:27:28,390: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:27:28,467: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:27:28,910: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:27:29,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee22e48>]}
2018-02-13 15:27:29,757: 15:27:29 | 4 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 6.04s]
2018-02-13 15:27:29,758: 15:27:29 | 11 of 42 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-02-13 15:27:29,758: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:27:29,768: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:27:29,769: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:27:29,769: Re-using an available connection from the pool.
2018-02-13 15:27:30,497: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:27:30,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed6fa90>]}
2018-02-13 15:27:30,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc5208>]}
2018-02-13 15:27:30,921: 15:27:30 | 8 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.35s]
2018-02-13 15:27:31,215: 15:27:31 | 9 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.11s]
2018-02-13 15:27:32,281: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee13048>]}
2018-02-13 15:27:32,605: 15:27:32 | 10 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 4.36s]
2018-02-13 15:27:32,706: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee22e48>]}
2018-02-13 15:27:32,967: 15:27:32 | 11 of 42 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 2.95s]
2018-02-13 15:27:32,968: 15:27:32 | 12 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:27:32,969: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:27:32,969: 15:27:32 | 13 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:27:32,976: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:27:32,986: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:27:32,990: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:27:32,969: 15:27:32 | 14 of 42 SKIP relation seo_audit.deepcrawl_url_proc.................. [SKIP]
2018-02-13 15:27:32,993: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:27:32,993: Re-using an available connection from the pool.
2018-02-13 15:27:32,969: 15:27:32 | 15 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:27:32,995: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:27:32,995: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:27:32,996: Re-using an available connection from the pool.
2018-02-13 15:27:32,991: 15:27:32 | 16 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:27:33,009: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:27:33,013: Compiling model.seo_audit.search_console_history
2018-02-13 15:27:33,016: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:27:33,028: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:27:33,028: Re-using an available connection from the pool.
2018-02-13 15:27:33,031: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:27:33,032: Re-using an available connection from the pool.
2018-02-13 15:27:33,771: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:27:33,772: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:27:33,773: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:27:33,773: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:27:35,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b829518>]}
2018-02-13 15:27:35,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed35438>]}
2018-02-13 15:27:36,307: 15:27:36 | 15 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.98s]
2018-02-13 15:27:36,546: 15:27:36 | 12 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.02s]
2018-02-13 15:27:37,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b832f98>]}
2018-02-13 15:27:37,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee000b8>]}
2018-02-13 15:27:37,383: 15:27:37 | 13 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.11s]
2018-02-13 15:27:37,660: 15:27:37 | 16 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.10s]
2018-02-13 15:27:37,661: 15:27:37 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:27:37,662: 15:27:37 | 18 of 42 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-13 15:27:37,662: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:27:37,662: 15:27:37 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:27:37,669: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:27:37,678: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:27:37,685: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:27:37,686: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:27:37,687: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:27:37,687: Re-using an available connection from the pool.
2018-02-13 15:27:37,689: Re-using an available connection from the pool.
2018-02-13 15:27:39,001: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:27:39,008: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:27:41,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ee32668>]}
2018-02-13 15:27:41,495: 15:27:41 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.53s]
2018-02-13 15:27:43,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10edc5208>]}
2018-02-13 15:27:44,272: 15:27:44 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 5.77s]
2018-02-13 15:27:44,273: 15:27:44 | 20 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:27:44,274: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:27:44,274: 15:27:44 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:27:44,282: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:27:44,299: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:27:44,302: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:27:44,274: 15:27:44 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:27:44,303: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:27:44,274: 15:27:44 | 23 of 42 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-02-13 15:27:44,315: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:27:44,316: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:27:44,318: Re-using an available connection from the pool.
2018-02-13 15:27:44,317: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:27:44,327: Re-using an available connection from the pool.
2018-02-13 15:27:44,322: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:27:44,331: Re-using an available connection from the pool.
2018-02-13 15:27:45,566: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:27:45,566: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:27:45,575: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:27:47,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecfebe0>]}
2018-02-13 15:27:47,750: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed230f0>]}
2018-02-13 15:27:48,037: 15:27:48 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.44s]
2018-02-13 15:27:48,344: 15:27:48 | 20 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.48s]
2018-02-13 15:27:48,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d466a1-497d-4766-82ec-ad48fdc55228', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b82b278>]}
2018-02-13 15:27:49,131: 15:27:49 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 4.59s]
2018-02-13 15:27:49,132: 15:27:49 | 24 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-02-13 15:27:49,132: 15:27:49 | 25 of 42 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-02-13 15:27:49,132: 15:27:49 | 26 of 42 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-02-13 15:27:49,132: 15:27:49 | 27 of 42 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-02-13 15:27:49,132: 15:27:49 | 28 of 42 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-02-13 15:27:49,133: 15:27:49 | 29 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-02-13 15:27:49,134: 15:27:49 | 30 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-13 15:27:49,135: 15:27:49 | 31 of 42 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-13 15:27:49,135: 15:27:49 | 32 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-13 15:27:49,137: 15:27:49 | 33 of 42 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-02-13 15:27:49,138: 15:27:49 | 34 of 42 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-02-13 15:27:49,140: 15:27:49 | 35 of 42 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-02-13 15:27:49,140: 15:27:49 | 36 of 42 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-02-13 15:27:49,142: 15:27:49 | 37 of 42 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-02-13 15:27:49,142: 15:27:49 | 38 of 42 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-02-13 15:27:49,143: 15:27:49 | 39 of 42 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-02-13 15:27:49,145: 15:27:49 | 40 of 42 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-02-13 15:27:49,146: 15:27:49 | 41 of 42 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-02-13 15:27:49,147: 15:27:49 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:27:49,196: 15:27:49 | 
2018-02-13 15:27:49,196: 15:27:49 | Finished running 42 table models in 29.18s.
2018-02-13 15:27:49,196: Connection 'master' was left open.
2018-02-13 15:27:49,197: 
2018-02-13 15:27:49,197: Completed with 1 errors:
2018-02-13 15:27:49,197: 
2018-02-13 15:27:49,197: Runtime Error in model deepcrawl_proc (models/base-adp/deepcrawl/deepcrawl_proc.sql)
2018-02-13 15:27:49,197:   404 Not found: Table curious-domain-121318:seo_audit.deepcrawl_cifl
2018-02-13 15:27:49,198: 
Done. PASS=19 ERROR=1 SKIP=22 TOTAL=42
2018-02-13 15:27:49,198: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecfea20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ecfe780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed67d30>]}
2018-02-13 15:27:49,464: Flushing usage events
2018-02-13 15:30:32,668: Tracking: tracking
2018-02-13 15:30:32,671: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b7fdda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b7fde48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b7fd9e8>]}
2018-02-13 15:30:33,389: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:30:33,408: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:30:33,415: Parsing core.sql
2018-02-13 15:30:33,437: Parsing adapters/bigquery.sql
2018-02-13 15:30:33,445: Parsing adapters/common.sql
2018-02-13 15:30:33,467: Parsing adapters/postgres.sql
2018-02-13 15:30:33,472: Parsing adapters/redshift.sql
2018-02-13 15:30:33,499: Parsing etc/get_custom_schema.sql
2018-02-13 15:30:33,506: Parsing materializations/archive.sql
2018-02-13 15:30:33,543: Parsing materializations/bigquery.sql
2018-02-13 15:30:33,563: Parsing materializations/helpers.sql
2018-02-13 15:30:33,587: Parsing materializations/incremental.sql
2018-02-13 15:30:33,639: Parsing materializations/table.sql
2018-02-13 15:30:33,674: Parsing materializations/view.sql
2018-02-13 15:30:33,703: Parsing materializations/wrapper.sql
2018-02-13 15:30:33,708: Parsing schema_tests/accepted_values.sql
2018-02-13 15:30:33,719: Parsing schema_tests/not_null.sql
2018-02-13 15:30:33,723: Parsing schema_tests/relationships.sql
2018-02-13 15:30:33,731: Parsing schema_tests/unique.sql
2018-02-13 15:30:33,783: Parsing model.seo_audit.actions
2018-02-13 15:30:33,787: Acquiring new bigquery connection "master".
2018-02-13 15:30:33,788: Opening a new connection (0 currently allocated)
2018-02-13 15:30:33,794: Parsing model.seo_audit.accounts_proc
2018-02-13 15:30:33,799: Parsing model.seo_audit.all_dates
2018-02-13 15:30:33,802: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:30:33,807: Parsing model.seo_audit.agg_all
2018-02-13 15:30:33,813: Parsing model.seo_audit.agg_indicative
2018-02-13 15:30:33,817: Parsing model.seo_audit.agg_stats
2018-02-13 15:30:33,824: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:30:33,829: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:30:33,832: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:30:33,835: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:30:33,838: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:30:33,840: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:30:33,848: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:30:33,852: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:30:33,856: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:30:33,872: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:30:33,874: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:30:33,878: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:30:33,884: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:30:33,890: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:30:33,894: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:30:33,897: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:30:33,906: Parsing model.seo_audit.ga_proc
2018-02-13 15:30:33,914: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:30:33,920: Parsing model.seo_audit.ga_stats
2018-02-13 15:30:33,925: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:30:33,929: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:30:33,935: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:30:33,939: Parsing model.seo_audit.moz_proc
2018-02-13 15:30:33,944: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:30:33,952: Parsing model.seo_audit.search_console_history
2018-02-13 15:30:33,956: Parsing model.seo_audit.search_console_proc
2018-02-13 15:30:33,960: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:30:33,966: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:30:33,973: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:30:33,977: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:30:33,983: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:30:33,986: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:30:33,989: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:30:33,992: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:30:33,995: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:30:34,025: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:30:34,050: 
2018-02-13 15:30:34,888: 15:30:34 | Concurrency: 4 threads (target='prod')
2018-02-13 15:30:34,888: 15:30:34 | 
2018-02-13 15:30:35,265: 15:30:35 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:30:35,266: Compiling model.seo_audit.all_dates
2018-02-13 15:30:35,265: 15:30:35 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:30:35,274: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:30:35,266: 15:30:35 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:30:35,274: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:30:35,275: Compiling model.seo_audit.accounts_proc
2018-02-13 15:30:35,284: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:30:35,296: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:30:35,297: Acquiring new bigquery connection "all_dates".
2018-02-13 15:30:35,297: Opening a new connection (1 currently allocated)
2018-02-13 15:30:35,301: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:30:35,304: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:30:35,305: Opening a new connection (2 currently allocated)
2018-02-13 15:30:35,393: Opening a new connection (3 currently allocated)
2018-02-13 15:30:36,459: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:30:36,689: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:30:36,721: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:30:37,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b98e7f0>]}
2018-02-13 15:30:37,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b998eb8>]}
2018-02-13 15:30:38,049: 15:30:38 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.50s]
2018-02-13 15:30:38,928: 15:30:38 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.56s]
2018-02-13 15:30:38,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b98e7b8>]}
2018-02-13 15:30:39,777: 15:30:39 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.67s]
2018-02-13 15:30:39,778: 15:30:39 | 4 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:30:39,780: Compiling model.seo_audit.moz_proc
2018-02-13 15:30:39,779: 15:30:39 | 5 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:30:39,786: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:30:39,795: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:30:39,779: 15:30:39 | 6 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:30:39,797: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:30:39,779: 15:30:39 | 7 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:30:39,797: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:30:39,798: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:30:39,804: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:30:39,805: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:30:39,815: Re-using an available connection from the pool.
2018-02-13 15:30:39,806: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:30:39,814: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:30:39,816: Re-using an available connection from the pool.
2018-02-13 15:30:39,820: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:30:39,822: Re-using an available connection from the pool.
2018-02-13 15:30:39,833: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:30:39,833: Opening a new connection (4 currently allocated)
2018-02-13 15:30:40,575: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:30:40,606: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:30:40,757: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:30:41,362: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:30:42,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8f5da0>]}
2018-02-13 15:30:42,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90f320>]}
2018-02-13 15:30:43,082: 15:30:43 | 4 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.98s]
2018-02-13 15:30:43,082: 15:30:43 | 8 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:30:43,083: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:30:43,094: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:30:43,101: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:30:43,101: Re-using an available connection from the pool.
2018-02-13 15:30:43,440: 15:30:43 | 5 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.05s]
2018-02-13 15:30:43,440: 15:30:43 | 9 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:30:43,441: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:30:43,449: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:30:43,451: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:30:43,451: Re-using an available connection from the pool.
2018-02-13 15:30:43,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b923908>]}
2018-02-13 15:30:43,850: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:30:43,929: 15:30:43 | 7 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.87s]
2018-02-13 15:30:43,929: 15:30:43 | 10 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:30:43,929: Compiling model.seo_audit.search_console_proc
2018-02-13 15:30:43,935: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:30:43,939: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:30:43,940: Re-using an available connection from the pool.
2018-02-13 15:30:44,148: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:30:44,240: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083936d8>]}
2018-02-13 15:30:44,511: 15:30:44 | 6 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 4.44s]
2018-02-13 15:30:44,511: 15:30:44 | 11 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:30:44,512: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:30:44,521: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:30:44,522: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:30:44,523: Re-using an available connection from the pool.
2018-02-13 15:30:44,626: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:30:45,261: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:30:46,012: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b90f978>]}
2018-02-13 15:30:46,269: 15:30:46 | 8 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.93s]
2018-02-13 15:30:46,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b942208>]}
2018-02-13 15:30:46,612: 15:30:46 | 9 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.88s]
2018-02-13 15:30:47,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083936d8>]}
2018-02-13 15:30:47,737: 15:30:47 | 11 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.95s]
2018-02-13 15:30:47,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b923908>]}
2018-02-13 15:30:48,186: 15:30:48 | 10 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.98s]
2018-02-13 15:30:48,187: 15:30:48 | 12 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:30:48,188: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:30:48,193: 15:30:48 | 13 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:30:48,193: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:30:48,206: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:30:48,212: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:30:48,227: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:30:48,228: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:30:48,199: 15:30:48 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:30:48,199: 15:30:48 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:30:48,231: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:30:48,231: Compiling model.seo_audit.search_console_history
2018-02-13 15:30:48,238: Re-using an available connection from the pool.
2018-02-13 15:30:48,248: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:30:48,254: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:30:48,255: Re-using an available connection from the pool.
2018-02-13 15:30:48,257: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:30:48,259: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:30:48,260: Re-using an available connection from the pool.
2018-02-13 15:30:48,263: Re-using an available connection from the pool.
2018-02-13 15:30:48,843: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:30:48,873: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:30:48,896: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:30:48,914: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:30:51,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba11eb8>]}
2018-02-13 15:30:51,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c11f60>]}
2018-02-13 15:30:51,071: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9affd0>]}
2018-02-13 15:30:51,099: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9af048>]}
2018-02-13 15:30:51,260: 15:30:51 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.78s]
2018-02-13 15:30:51,264: 15:30:51 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:30:51,265: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:30:51,277: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:30:51,282: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:30:51,282: Re-using an available connection from the pool.
2018-02-13 15:30:51,596: 15:30:51 | 13 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.87s]
2018-02-13 15:30:51,609: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:30:51,609: Bad request while running:
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:30:51,609: 400 Syntax error: Unexpected keyword AS at [73:104]
2018-02-13 15:30:51,609: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c343c8>]}
2018-02-13 15:30:51,832: 15:30:51 | 12 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.88s]
2018-02-13 15:30:52,076: 15:30:52 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.87s]
2018-02-13 15:30:52,336: 15:30:52 | 16 of 42 ERROR creating table model seo_audit.deepcrawl_url_proc..... [ERROR in 0.34s]
2018-02-13 15:30:52,337: 15:30:52 | 17 of 42 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-13 15:30:52,338: 15:30:52 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:30:52,338: 15:30:52 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:30:52,338: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:30:52,339: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:30:52,348: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:30:52,361: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:30:52,362: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:30:52,362: Re-using an available connection from the pool.
2018-02-13 15:30:52,365: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:30:52,365: Re-using an available connection from the pool.
2018-02-13 15:30:52,954: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:30:52,965: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:30:55,137: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8f5400>]}
2018-02-13 15:30:55,144: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b9faa20>]}
2018-02-13 15:30:55,874: 15:30:55 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.80s]
2018-02-13 15:30:56,126: 15:30:56 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.81s]
2018-02-13 15:30:56,127: 15:30:56 | 20 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:30:56,127: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:30:56,127: 15:30:56 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:30:56,134: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:30:56,139: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:30:56,139: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:30:56,127: 15:30:56 | 22 of 42 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-02-13 15:30:56,127: 15:30:56 | 23 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:30:56,140: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:30:56,141: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:30:56,141: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:30:56,141: Re-using an available connection from the pool.
2018-02-13 15:30:56,147: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:30:56,147: Re-using an available connection from the pool.
2018-02-13 15:30:56,152: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:30:56,153: Re-using an available connection from the pool.
2018-02-13 15:30:56,725: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:30:56,796: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:30:56,871: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:30:58,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c34668>]}
2018-02-13 15:30:58,956: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c14a58>]}
2018-02-13 15:30:59,168: 15:30:59 | 20 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.80s]
2018-02-13 15:30:59,400: 15:30:59 | 23 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.81s]
2018-02-13 15:30:59,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3c91114-d909-4bcc-8458-6f827bccc2e4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c34ef0>]}
2018-02-13 15:30:59,772: 15:30:59 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.34s]
2018-02-13 15:30:59,773: 15:30:59 | 24 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-02-13 15:30:59,774: 15:30:59 | 25 of 42 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-02-13 15:30:59,774: 15:30:59 | 26 of 42 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-02-13 15:30:59,774: 15:30:59 | 27 of 42 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-02-13 15:30:59,774: 15:30:59 | 28 of 42 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-02-13 15:30:59,775: 15:30:59 | 29 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-02-13 15:30:59,777: 15:30:59 | 30 of 42 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-13 15:30:59,777: 15:30:59 | 31 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-13 15:30:59,778: 15:30:59 | 32 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-13 15:30:59,779: 15:30:59 | 33 of 42 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-02-13 15:30:59,780: 15:30:59 | 34 of 42 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-02-13 15:30:59,781: 15:30:59 | 35 of 42 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-02-13 15:30:59,781: 15:30:59 | 36 of 42 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-02-13 15:30:59,782: 15:30:59 | 37 of 42 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-02-13 15:30:59,783: 15:30:59 | 38 of 42 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-02-13 15:30:59,783: 15:30:59 | 39 of 42 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-02-13 15:30:59,784: 15:30:59 | 40 of 42 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-02-13 15:30:59,785: 15:30:59 | 41 of 42 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-02-13 15:30:59,786: 15:30:59 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:30:59,848: 15:30:59 | 
2018-02-13 15:30:59,848: 15:30:59 | Finished running 42 table models in 24.97s.
2018-02-13 15:30:59,848: Connection 'master' was left open.
2018-02-13 15:30:59,848: 
2018-02-13 15:30:59,849: Completed with 1 errors:
2018-02-13 15:30:59,849: 
2018-02-13 15:30:59,849: Database Error in model deepcrawl_url_proc (models/base-adp/deepcrawl/deepcrawl_url_proc.sql)
2018-02-13 15:30:59,850:   Syntax error: Unexpected keyword AS at [73:104]
2018-02-13 15:30:59,850:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_url_proc.sql
2018-02-13 15:30:59,850: 
Done. PASS=20 ERROR=1 SKIP=21 TOTAL=42
2018-02-13 15:30:59,851: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b863518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8bca20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8bc780>]}
2018-02-13 15:31:00,088: Flushing usage events
2018-02-13 15:32:57,214: Tracking: tracking
2018-02-13 15:32:57,217: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e9c92e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e9c9b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e9c9080>]}
2018-02-13 15:32:58,021: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:32:58,039: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:32:58,045: Parsing core.sql
2018-02-13 15:32:58,067: Parsing adapters/bigquery.sql
2018-02-13 15:32:58,074: Parsing adapters/common.sql
2018-02-13 15:32:58,100: Parsing adapters/postgres.sql
2018-02-13 15:32:58,106: Parsing adapters/redshift.sql
2018-02-13 15:32:58,131: Parsing etc/get_custom_schema.sql
2018-02-13 15:32:58,139: Parsing materializations/archive.sql
2018-02-13 15:32:58,195: Parsing materializations/bigquery.sql
2018-02-13 15:32:58,214: Parsing materializations/helpers.sql
2018-02-13 15:32:58,237: Parsing materializations/incremental.sql
2018-02-13 15:32:58,271: Parsing materializations/table.sql
2018-02-13 15:32:58,296: Parsing materializations/view.sql
2018-02-13 15:32:58,315: Parsing materializations/wrapper.sql
2018-02-13 15:32:58,323: Parsing schema_tests/accepted_values.sql
2018-02-13 15:32:58,332: Parsing schema_tests/not_null.sql
2018-02-13 15:32:58,338: Parsing schema_tests/relationships.sql
2018-02-13 15:32:58,345: Parsing schema_tests/unique.sql
2018-02-13 15:32:58,398: Parsing model.seo_audit.actions
2018-02-13 15:32:58,401: Acquiring new bigquery connection "master".
2018-02-13 15:32:58,402: Opening a new connection (0 currently allocated)
2018-02-13 15:32:58,405: Parsing model.seo_audit.accounts_proc
2018-02-13 15:32:58,408: Parsing model.seo_audit.all_dates
2018-02-13 15:32:58,410: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:32:58,414: Parsing model.seo_audit.agg_all
2018-02-13 15:32:58,417: Parsing model.seo_audit.agg_indicative
2018-02-13 15:32:58,419: Parsing model.seo_audit.agg_stats
2018-02-13 15:32:58,424: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:32:58,426: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:32:58,429: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:32:58,431: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:32:58,433: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:32:58,435: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:32:58,437: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:32:58,439: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:32:58,441: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:32:58,449: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:32:58,451: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:32:58,453: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:32:58,454: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:32:58,456: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:32:58,458: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:32:58,459: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:32:58,463: Parsing model.seo_audit.ga_proc
2018-02-13 15:32:58,467: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:32:58,469: Parsing model.seo_audit.ga_stats
2018-02-13 15:32:58,472: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:32:58,473: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:32:58,476: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:32:58,478: Parsing model.seo_audit.moz_proc
2018-02-13 15:32:58,481: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:32:58,484: Parsing model.seo_audit.search_console_history
2018-02-13 15:32:58,486: Parsing model.seo_audit.search_console_proc
2018-02-13 15:32:58,489: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:32:58,492: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:32:58,494: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:32:58,498: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:32:58,501: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:32:58,503: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:32:58,505: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:32:58,507: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:32:58,510: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:32:58,530: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:32:58,541: 
2018-02-13 15:32:59,814: 15:32:59 | Concurrency: 4 threads (target='prod')
2018-02-13 15:32:59,815: 15:32:59 | 
2018-02-13 15:33:00,153: 15:33:00 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:33:00,153: Compiling model.seo_audit.all_dates
2018-02-13 15:33:00,153: 15:33:00 | 2 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:33:00,153: 15:33:00 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:33:00,157: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:33:00,157: Compiling model.seo_audit.accounts_proc
2018-02-13 15:33:00,157: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:33:00,164: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:33:00,168: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:33:00,169: Acquiring new bigquery connection "all_dates".
2018-02-13 15:33:00,169: Opening a new connection (1 currently allocated)
2018-02-13 15:33:00,222: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:33:00,223: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:33:00,225: Opening a new connection (2 currently allocated)
2018-02-13 15:33:00,230: Opening a new connection (3 currently allocated)
2018-02-13 15:33:01,350: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:33:01,359: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:33:01,414: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:33:02,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eafb940>]}
2018-02-13 15:33:02,748: 15:33:02 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.32s]
2018-02-13 15:33:03,583: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eaf8198>]}
2018-02-13 15:33:03,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebd22b0>]}
2018-02-13 15:33:04,269: 15:33:04 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.43s]
2018-02-13 15:33:04,544: 15:33:04 | 2 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.63s]
2018-02-13 15:33:04,545: 15:33:04 | 4 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:33:04,546: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:33:04,545: 15:33:04 | 5 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:33:04,546: 15:33:04 | 6 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:33:04,556: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:33:04,557: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:33:04,546: 15:33:04 | 7 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:33:04,557: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:33:04,564: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:33:04,564: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:33:04,582: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:33:04,583: Re-using an available connection from the pool.
2018-02-13 15:33:04,581: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:33:04,570: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:33:04,591: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:33:04,577: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:33:04,593: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:33:04,595: Re-using an available connection from the pool.
2018-02-13 15:33:04,596: Re-using an available connection from the pool.
2018-02-13 15:33:04,596: Opening a new connection (4 currently allocated)
2018-02-13 15:33:05,240: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:33:05,280: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:33:05,371: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:33:05,625: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:33:07,410: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eafbac8>]}
2018-02-13 15:33:07,491: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb687b8>]}
2018-02-13 15:33:07,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eafb470>]}
2018-02-13 15:33:07,663: 15:33:07 | 5 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.85s]
2018-02-13 15:33:07,664: 15:33:07 | 8 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:33:07,665: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:33:07,676: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:33:07,680: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:33:07,680: Re-using an available connection from the pool.
2018-02-13 15:33:07,972: 15:33:07 | 7 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.93s]
2018-02-13 15:33:07,975: 15:33:07 | 9 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:33:07,976: Compiling model.seo_audit.moz_proc
2018-02-13 15:33:07,982: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:33:07,984: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:33:07,984: Re-using an available connection from the pool.
2018-02-13 15:33:08,364: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:33:08,608: 15:33:08 | 4 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.04s]
2018-02-13 15:33:08,608: 15:33:08 | 10 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:33:08,608: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:33:08,615: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:33:08,616: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:33:08,616: Re-using an available connection from the pool.
2018-02-13 15:33:08,923: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:33:08,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eaf88d0>]}
2018-02-13 15:33:09,219: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:33:09,304: 15:33:09 | 6 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.41s]
2018-02-13 15:33:09,305: 15:33:09 | 11 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:33:09,305: Compiling model.seo_audit.search_console_proc
2018-02-13 15:33:09,315: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:33:09,318: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:33:09,318: Re-using an available connection from the pool.
2018-02-13 15:33:09,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eafbac8>]}
2018-02-13 15:33:09,772: 15:33:09 | 8 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 1.82s]
2018-02-13 15:33:09,959: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:33:11,096: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebc6710>]}
2018-02-13 15:33:11,384: 15:33:11 | 9 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.12s]
2018-02-13 15:33:11,423: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebcdda0>]}
2018-02-13 15:33:11,694: 15:33:11 | 10 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.81s]
2018-02-13 15:33:13,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eaf88d0>]}
2018-02-13 15:33:13,557: 15:33:13 | 11 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.99s]
2018-02-13 15:33:13,558: 15:33:13 | 12 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:33:13,559: Compiling model.seo_audit.search_console_history
2018-02-13 15:33:13,558: 15:33:13 | 13 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:33:13,567: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:33:13,567: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:33:13,558: 15:33:13 | 14 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:33:13,558: 15:33:13 | 15 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:33:13,573: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:33:13,573: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:33:13,574: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:33:13,574: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:33:13,582: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:33:13,592: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:33:13,592: Re-using an available connection from the pool.
2018-02-13 15:33:13,593: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:33:13,595: Re-using an available connection from the pool.
2018-02-13 15:33:13,596: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:33:13,597: Re-using an available connection from the pool.
2018-02-13 15:33:13,607: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:33:13,609: Re-using an available connection from the pool.
2018-02-13 15:33:14,023: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else end 0 as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:33:14,023: Bad request while running:
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else end 0 as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:33:14,023: 400 Syntax error: Unexpected keyword END at [73:102]
2018-02-13 15:33:14,024: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ebcd588>]}
2018-02-13 15:33:14,182: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:33:14,300: 15:33:14 | 14 of 42 ERROR creating table model seo_audit.deepcrawl_url_proc..... [ERROR in 0.45s]
2018-02-13 15:33:14,300: 15:33:14 | 16 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:33:14,301: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:33:14,310: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:33:14,313: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:33:14,313: Re-using an available connection from the pool.
2018-02-13 15:33:14,316: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:33:14,346: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:33:15,036: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:33:16,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb896a0>]}
2018-02-13 15:33:16,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb74b00>]}
2018-02-13 15:33:16,655: 15:33:16 | 13 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.81s]
2018-02-13 15:33:16,917: 15:33:16 | 15 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.98s]
2018-02-13 15:33:17,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be257f0>]}
2018-02-13 15:33:17,480: 15:33:17 | 16 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.94s]
2018-02-13 15:33:18,743: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eafb518>]}
2018-02-13 15:33:18,986: 15:33:18 | 12 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 5.18s]
2018-02-13 15:33:18,987: 15:33:18 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:33:18,988: 15:33:18 | 18 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:33:18,988: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:33:18,988: 15:33:18 | 19 of 42 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-13 15:33:18,989: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:33:19,003: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:33:19,003: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:33:19,004: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:33:19,004: Re-using an available connection from the pool.
2018-02-13 15:33:19,005: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:33:19,005: Re-using an available connection from the pool.
2018-02-13 15:33:19,602: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:33:19,629: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:33:21,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eb74b70>]}
2018-02-13 15:33:21,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10eaf88d0>]}
2018-02-13 15:33:22,075: 15:33:22 | 18 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.82s]
2018-02-13 15:33:22,329: 15:33:22 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.84s]
2018-02-13 15:33:22,330: 15:33:22 | 20 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:33:22,330: 15:33:22 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:33:22,330: 15:33:22 | 22 of 42 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-02-13 15:33:22,330: 15:33:22 | 23 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:33:22,330: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:33:22,331: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:33:22,331: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:33:22,336: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:33:22,340: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:33:22,346: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:33:22,351: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:33:22,352: Re-using an available connection from the pool.
2018-02-13 15:33:22,353: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:33:22,353: Re-using an available connection from the pool.
2018-02-13 15:33:22,358: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:33:22,358: Re-using an available connection from the pool.
2018-02-13 15:33:23,012: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:33:23,153: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:33:23,479: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:33:25,184: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be42940>]}
2018-02-13 15:33:25,338: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be24a20>]}
2018-02-13 15:33:25,421: 15:33:25 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.85s]
2018-02-13 15:33:25,655: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f84168af-d8a1-4d77-98a8-9dfc1a8badee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be249e8>]}
2018-02-13 15:33:25,662: 15:33:25 | 20 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.01s]
2018-02-13 15:33:25,890: 15:33:25 | 23 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.32s]
2018-02-13 15:33:25,892: 15:33:25 | 24 of 42 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-02-13 15:33:25,892: 15:33:25 | 25 of 42 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-02-13 15:33:25,892: 15:33:25 | 26 of 42 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-02-13 15:33:25,892: 15:33:25 | 27 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-02-13 15:33:25,893: 15:33:25 | 28 of 42 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-02-13 15:33:25,893: 15:33:25 | 29 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-02-13 15:33:25,895: 15:33:25 | 30 of 42 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-13 15:33:25,896: 15:33:25 | 31 of 42 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-13 15:33:25,896: 15:33:25 | 32 of 42 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-13 15:33:25,897: 15:33:25 | 33 of 42 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-02-13 15:33:25,898: 15:33:25 | 34 of 42 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-02-13 15:33:25,898: 15:33:25 | 35 of 42 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-02-13 15:33:25,898: 15:33:25 | 36 of 42 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-02-13 15:33:25,899: 15:33:25 | 37 of 42 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-02-13 15:33:25,900: 15:33:25 | 38 of 42 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-02-13 15:33:25,901: 15:33:25 | 39 of 42 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-02-13 15:33:25,901: 15:33:25 | 40 of 42 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-02-13 15:33:25,901: 15:33:25 | 41 of 42 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-02-13 15:33:25,902: 15:33:25 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:33:25,994: 15:33:25 | 
2018-02-13 15:33:25,994: 15:33:25 | Finished running 42 table models in 26.18s.
2018-02-13 15:33:25,994: Connection 'master' was left open.
2018-02-13 15:33:25,994: 
2018-02-13 15:33:25,995: Completed with 1 errors:
2018-02-13 15:33:25,995: 
2018-02-13 15:33:25,995: Database Error in model deepcrawl_url_proc (models/base-adp/deepcrawl/deepcrawl_url_proc.sql)
2018-02-13 15:33:25,995:   Syntax error: Unexpected keyword END at [73:102]
2018-02-13 15:33:25,995:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_url_proc.sql
2018-02-13 15:33:25,996: 
Done. PASS=20 ERROR=1 SKIP=21 TOTAL=42
2018-02-13 15:33:25,996: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea9c6a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea9c828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea9c6d8>]}
2018-02-13 15:33:26,264: Flushing usage events
2018-02-13 15:35:31,687: Tracking: tracking
2018-02-13 15:35:31,692: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10744e2e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10744eb70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10744e080>]}
2018-02-13 15:35:32,488: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:35:32,507: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:35:32,511: Parsing core.sql
2018-02-13 15:35:32,528: Parsing adapters/bigquery.sql
2018-02-13 15:35:32,539: Parsing adapters/common.sql
2018-02-13 15:35:32,561: Parsing adapters/postgres.sql
2018-02-13 15:35:32,567: Parsing adapters/redshift.sql
2018-02-13 15:35:32,592: Parsing etc/get_custom_schema.sql
2018-02-13 15:35:32,601: Parsing materializations/archive.sql
2018-02-13 15:35:32,634: Parsing materializations/bigquery.sql
2018-02-13 15:35:32,655: Parsing materializations/helpers.sql
2018-02-13 15:35:32,679: Parsing materializations/incremental.sql
2018-02-13 15:35:32,717: Parsing materializations/table.sql
2018-02-13 15:35:32,739: Parsing materializations/view.sql
2018-02-13 15:35:32,762: Parsing materializations/wrapper.sql
2018-02-13 15:35:32,768: Parsing schema_tests/accepted_values.sql
2018-02-13 15:35:32,774: Parsing schema_tests/not_null.sql
2018-02-13 15:35:32,779: Parsing schema_tests/relationships.sql
2018-02-13 15:35:32,784: Parsing schema_tests/unique.sql
2018-02-13 15:35:32,821: Parsing model.seo_audit.actions
2018-02-13 15:35:32,826: Acquiring new bigquery connection "master".
2018-02-13 15:35:32,826: Opening a new connection (0 currently allocated)
2018-02-13 15:35:32,831: Parsing model.seo_audit.accounts_proc
2018-02-13 15:35:32,833: Parsing model.seo_audit.all_dates
2018-02-13 15:35:32,834: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:35:32,838: Parsing model.seo_audit.agg_all
2018-02-13 15:35:32,841: Parsing model.seo_audit.agg_indicative
2018-02-13 15:35:32,843: Parsing model.seo_audit.agg_stats
2018-02-13 15:35:32,850: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:35:32,852: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:35:32,854: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:35:32,856: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:35:32,858: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:35:32,859: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:35:32,862: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:35:32,864: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:35:32,867: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:35:32,873: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:35:32,876: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:35:32,880: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:35:32,884: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:35:32,887: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:35:32,891: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:35:32,894: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:35:32,901: Parsing model.seo_audit.ga_proc
2018-02-13 15:35:32,906: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:35:32,909: Parsing model.seo_audit.ga_stats
2018-02-13 15:35:32,911: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:35:32,913: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:35:32,916: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:35:32,919: Parsing model.seo_audit.moz_proc
2018-02-13 15:35:32,921: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:35:32,924: Parsing model.seo_audit.search_console_history
2018-02-13 15:35:32,926: Parsing model.seo_audit.search_console_proc
2018-02-13 15:35:32,929: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:35:32,932: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:35:32,934: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:35:32,937: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:35:32,939: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:35:32,942: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:35:32,944: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:35:32,947: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:35:32,950: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:35:32,972: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:35:32,985: 
2018-02-13 15:35:33,833: 15:35:33 | Concurrency: 4 threads (target='prod')
2018-02-13 15:35:33,834: 15:35:33 | 
2018-02-13 15:35:34,063: 15:35:34 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:35:34,063: Compiling model.seo_audit.accounts_proc
2018-02-13 15:35:34,063: 15:35:34 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:35:34,069: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:35:34,063: 15:35:34 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:35:34,069: Compiling model.seo_audit.all_dates
2018-02-13 15:35:34,070: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:35:34,074: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:35:34,080: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:35:34,081: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:35:34,083: Acquiring new bigquery connection "all_dates".
2018-02-13 15:35:34,083: Opening a new connection (1 currently allocated)
2018-02-13 15:35:34,085: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:35:34,149: Opening a new connection (2 currently allocated)
2018-02-13 15:35:34,154: Opening a new connection (3 currently allocated)
2018-02-13 15:35:35,223: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:35:35,263: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:35:35,263: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:35:37,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755a4e0>]}
2018-02-13 15:35:37,495: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b3e10>]}
2018-02-13 15:35:37,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755ab38>]}
2018-02-13 15:35:37,802: 15:35:37 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.37s]
2018-02-13 15:35:38,142: 15:35:38 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.42s]
2018-02-13 15:35:38,473: 15:35:38 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.45s]
2018-02-13 15:35:38,474: 15:35:38 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:35:38,475: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:35:38,486: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:35:38,474: 15:35:38 | 5 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:35:38,474: 15:35:38 | 6 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:35:38,474: 15:35:38 | 7 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:35:38,487: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:35:38,488: Compiling model.seo_audit.moz_proc
2018-02-13 15:35:38,488: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:35:38,499: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:35:38,523: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:35:38,525: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:35:38,525: Re-using an available connection from the pool.
2018-02-13 15:35:38,526: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:35:38,528: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:35:38,528: Re-using an available connection from the pool.
2018-02-13 15:35:38,535: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:35:38,537: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:35:38,538: Re-using an available connection from the pool.
2018-02-13 15:35:38,540: Opening a new connection (4 currently allocated)
2018-02-13 15:35:39,971: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:35:39,972: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:35:39,980: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:35:39,997: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:35:42,273: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f706d8>]}
2018-02-13 15:35:42,528: 15:35:42 | 7 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.78s]
2018-02-13 15:35:42,529: 15:35:42 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:35:42,529: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:35:42,535: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:35:42,536: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:35:42,537: Re-using an available connection from the pool.
2018-02-13 15:35:43,182: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:35:43,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755ab38>]}
2018-02-13 15:35:43,353: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107547048>]}
2018-02-13 15:35:43,472: 15:35:43 | 5 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.73s]
2018-02-13 15:35:43,474: 15:35:43 | 9 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:35:43,474: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:35:43,487: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:35:43,491: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:35:43,491: Re-using an available connection from the pool.
2018-02-13 15:35:43,744: 15:35:43 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.88s]
2018-02-13 15:35:43,744: 15:35:43 | 10 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 15:35:43,745: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:35:43,755: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:35:43,759: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:35:43,759: Re-using an available connection from the pool.
2018-02-13 15:35:44,095: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:35:44,467: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:35:45,365: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f706d8>]}
2018-02-13 15:35:45,618: 15:35:45 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.84s]
2018-02-13 15:35:45,618: 15:35:45 | 11 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:35:45,619: Compiling model.seo_audit.search_console_proc
2018-02-13 15:35:45,624: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:35:45,628: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:35:45,628: Re-using an available connection from the pool.
2018-02-13 15:35:46,181: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:35:46,526: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b3e10>]}
2018-02-13 15:35:46,629: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107547048>]}
2018-02-13 15:35:46,784: 15:35:46 | 6 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 8.04s]
2018-02-13 15:35:47,021: 15:35:47 | 10 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.88s]
2018-02-13 15:35:47,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755ab38>]}
2018-02-13 15:35:47,717: 15:35:47 | 9 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.99s]
2018-02-13 15:35:49,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f706d8>]}
2018-02-13 15:35:50,187: 15:35:50 | 11 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.85s]
2018-02-13 15:35:50,188: 15:35:50 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:35:50,189: 15:35:50 | 13 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:35:50,189: 15:35:50 | 14 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:35:50,189: 15:35:50 | 15 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:35:50,189: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:35:50,190: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:35:50,190: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:35:50,190: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:35:50,195: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:35:50,215: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:35:50,216: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:35:50,214: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:35:50,220: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:35:50,220: Re-using an available connection from the pool.
2018-02-13 15:35:50,222: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:35:50,224: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:35:50,225: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:35:50,225: Re-using an available connection from the pool.
2018-02-13 15:35:50,229: Re-using an available connection from the pool.
2018-02-13 15:35:50,229: Re-using an available connection from the pool.
2018-02-13 15:35:50,927: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:35:50,995: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:35:51,311: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:35:51,337: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:35:53,117: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107555cc0>]}
2018-02-13 15:35:53,368: 15:35:53 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.93s]
2018-02-13 15:35:53,368: 15:35:53 | 16 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:35:53,369: Compiling model.seo_audit.search_console_history
2018-02-13 15:35:53,377: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:35:53,378: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:35:53,378: Re-using an available connection from the pool.
2018-02-13 15:35:53,583: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075cb940>]}
2018-02-13 15:35:53,611: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10766c240>]}
2018-02-13 15:35:53,814: 15:35:53 | 14 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.39s]
2018-02-13 15:35:53,932: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:35:54,055: 15:35:54 | 13 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.42s]
2018-02-13 15:35:54,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104830390>]}
2018-02-13 15:35:54,492: 15:35:54 | 15 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.06s]
2018-02-13 15:35:56,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107555cc0>]}
2018-02-13 15:35:56,393: 15:35:56 | 16 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.78s]
2018-02-13 15:35:56,394: 15:35:56 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:35:56,395: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:35:56,394: 15:35:56 | 18 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:35:56,394: 15:35:56 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:35:56,400: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:35:56,401: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:35:56,401: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:35:56,407: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:35:56,414: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:35:56,414: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:35:56,414: Re-using an available connection from the pool.
2018-02-13 15:35:56,423: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:35:56,423: Re-using an available connection from the pool.
2018-02-13 15:35:56,427: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:35:56,429: Re-using an available connection from the pool.
2018-02-13 15:35:56,984: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:35:56,992: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:35:57,026: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:35:59,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f706d8>]}
2018-02-13 15:35:59,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10483a828>]}
2018-02-13 15:35:59,206: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104838cf8>]}
2018-02-13 15:35:59,381: 15:35:59 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.75s]
2018-02-13 15:35:59,618: 15:35:59 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.76s]
2018-02-13 15:35:59,869: 15:35:59 | 18 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.80s]
2018-02-13 15:35:59,870: 15:35:59 | 20 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:35:59,871: 15:35:59 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:35:59,871: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:35:59,871: 15:35:59 | 22 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:35:59,871: 15:35:59 | 23 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:35:59,872: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:35:59,883: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:35:59,883: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:35:59,884: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:35:59,891: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:35:59,923: Re-using an available connection from the pool.
2018-02-13 15:35:59,895: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:35:59,922: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:35:59,946: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:35:59,947: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:35:59,948: Re-using an available connection from the pool.
2018-02-13 15:35:59,950: Re-using an available connection from the pool.
2018-02-13 15:35:59,972: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:35:59,978: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:35:59,978: Re-using an available connection from the pool.
2018-02-13 15:36:00,451: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:36:00,614: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:36:00,620: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:36:00,665: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:36:02,785: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107555cc0>]}
2018-02-13 15:36:03,122: 15:36:03 | 20 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.91s]
2018-02-13 15:36:03,754: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107679208>]}
2018-02-13 15:36:03,912: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104838908>]}
2018-02-13 15:36:03,978: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b3e10>]}
2018-02-13 15:36:04,028: 15:36:04 | 23 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.87s]
2018-02-13 15:36:04,276: 15:36:04 | 22 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.03s]
2018-02-13 15:36:04,516: 15:36:04 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 4.11s]
2018-02-13 15:36:04,517: 15:36:04 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:36:04,518: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:36:04,517: 15:36:04 | 25 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:36:04,518: 15:36:04 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:36:04,526: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:36:04,527: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:36:04,518: 15:36:04 | 27 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:36:04,527: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:36:04,533: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:36:04,535: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:36:04,540: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:36:04,544: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:36:04,547: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:36:04,547: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:36:04,548: Re-using an available connection from the pool.
2018-02-13 15:36:04,548: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:36:04,549: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:36:04,549: Re-using an available connection from the pool.
2018-02-13 15:36:04,553: Re-using an available connection from the pool.
2018-02-13 15:36:04,565: Re-using an available connection from the pool.
2018-02-13 15:36:05,009: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:36:05,019: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:36:05,035: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:36:05,084: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:36:06,108: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107667f98>]}
2018-02-13 15:36:06,123: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1048383c8>]}
2018-02-13 15:36:06,394: 15:36:06 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.58s]
2018-02-13 15:36:06,395: 15:36:06 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:36:06,396: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:36:06,405: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:36:06,408: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:36:06,409: Re-using an available connection from the pool.
2018-02-13 15:36:06,681: 15:36:06 | 25 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.60s]
2018-02-13 15:36:06,682: 15:36:06 | 29 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:36:06,682: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:36:06,692: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:36:06,693: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:36:06,693: Re-using an available connection from the pool.
2018-02-13 15:36:06,842: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:36:07,151: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:36:07,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10766c2e8>]}
2018-02-13 15:36:07,357: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f706d8>]}
2018-02-13 15:36:07,522: 15:36:07 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.75s]
2018-02-13 15:36:07,793: 15:36:07 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.84s]
2018-02-13 15:36:07,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107643710>]}
2018-02-13 15:36:08,215: 15:36:08 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.53s]
2018-02-13 15:36:09,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10763b320>]}
2018-02-13 15:36:10,028: 15:36:10 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.66s]
2018-02-13 15:36:10,029: 15:36:10 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:36:10,030: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:36:10,030: 15:36:10 | 31 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:36:10,039: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:36:10,030: 15:36:10 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:36:10,039: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:36:10,040: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:36:10,045: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:36:10,050: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:36:10,051: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:36:10,052: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:36:10,052: Re-using an available connection from the pool.
2018-02-13 15:36:10,053: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:36:10,054: Re-using an available connection from the pool.
2018-02-13 15:36:10,056: Re-using an available connection from the pool.
2018-02-13 15:36:10,442: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:36:10,474: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:36:10,515: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:36:11,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10766c860>]}
2018-02-13 15:36:11,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076677b8>]}
2018-02-13 15:36:11,957: 15:36:11 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.66s]
2018-02-13 15:36:12,191: 15:36:12 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.85s]
2018-02-13 15:36:12,749: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075b3e10>]}
2018-02-13 15:36:13,315: 15:36:13 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.72s]
2018-02-13 15:36:13,315: 15:36:13 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:36:13,316: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:36:13,330: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:36:13,331: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:36:13,331: Re-using an available connection from the pool.
2018-02-13 15:36:14,015: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:36:17,294: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10763b320>]}
2018-02-13 15:36:17,548: 15:36:17 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.98s]
2018-02-13 15:36:17,549: 15:36:17 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:36:17,549: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:36:17,557: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:36:17,558: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:36:17,558: Re-using an available connection from the pool.
2018-02-13 15:36:18,180: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:36:19,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107521a90>]}
2018-02-13 15:36:19,527: 15:36:19 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.73s]
2018-02-13 15:36:19,528: 15:36:19 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:36:19,529: Compiling model.seo_audit.ga_proc
2018-02-13 15:36:19,528: 15:36:19 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:36:19,538: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:36:19,538: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:36:19,549: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:36:19,551: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:36:19,551: Re-using an available connection from the pool.
2018-02-13 15:36:19,554: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:36:19,554: Re-using an available connection from the pool.
2018-02-13 15:36:20,139: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:36:20,266: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:36:22,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076579b0>]}
2018-02-13 15:36:23,019: 15:36:23 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.79s]
2018-02-13 15:36:23,553: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107536f28>]}
2018-02-13 15:36:23,830: 15:36:23 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 4.02s]
2018-02-13 15:36:23,831: 15:36:23 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:36:23,831: Compiling model.seo_audit.agg_indicative
2018-02-13 15:36:23,837: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:36:23,838: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:36:23,838: Re-using an available connection from the pool.
2018-02-13 15:36:24,665: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:36:26,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107521a90>]}
2018-02-13 15:36:27,088: 15:36:27 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.00s]
2018-02-13 15:36:27,089: 15:36:27 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:36:27,089: Compiling model.seo_audit.ga_stats
2018-02-13 15:36:27,099: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:36:27,100: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:36:27,100: Re-using an available connection from the pool.
2018-02-13 15:36:27,831: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:36:30,016: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107536f28>]}
2018-02-13 15:36:30,263: 15:36:30 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.93s]
2018-02-13 15:36:30,264: 15:36:30 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:36:30,264: Compiling model.seo_audit.agg_stats
2018-02-13 15:36:30,274: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:36:30,275: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:36:30,275: Re-using an available connection from the pool.
2018-02-13 15:36:31,201: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:36:34,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107521a90>]}
2018-02-13 15:36:34,286: 15:36:34 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.75s]
2018-02-13 15:36:34,287: 15:36:34 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:36:34,288: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:36:34,297: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:36:34,298: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:36:34,298: Re-using an available connection from the pool.
2018-02-13 15:36:34,937: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:36:37,131: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107536f28>]}
2018-02-13 15:36:37,376: 15:36:37 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.84s]
2018-02-13 15:36:37,377: 15:36:37 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:36:37,377: Compiling model.seo_audit.agg_all
2018-02-13 15:36:37,385: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:36:37,386: Acquiring new bigquery connection "agg_all".
2018-02-13 15:36:37,386: Re-using an available connection from the pool.
2018-02-13 15:36:37,951: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url
	)
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:36:37,951: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
a.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url
	)
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:36:37,951: 400 Name canonical_url not found inside a at [94:11]
2018-02-13 15:36:37,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f2fff2c-c777-4135-81e2-7ea4bfe42668', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107636208>]}
2018-02-13 15:36:38,245: 15:36:38 | 41 of 42 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.57s]
2018-02-13 15:36:38,246: 15:36:38 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:36:38,277: 15:36:38 | 
2018-02-13 15:36:38,278: 15:36:38 | Finished running 42 table models in 64.45s.
2018-02-13 15:36:38,278: Connection 'master' was left open.
2018-02-13 15:36:38,278: 
2018-02-13 15:36:38,278: Completed with 1 errors:
2018-02-13 15:36:38,278: 
2018-02-13 15:36:38,279: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-13 15:36:38,279:   Name canonical_url not found inside a at [94:11]
2018-02-13 15:36:38,279:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-13 15:36:38,279: 
Done. PASS=40 ERROR=1 SKIP=1 TOTAL=42
2018-02-13 15:36:38,280: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107521860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107521710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075216d8>]}
2018-02-13 15:36:38,530: Flushing usage events
2018-02-13 15:39:54,738: Tracking: tracking
2018-02-13 15:39:54,744: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999dda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999de48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999d9e8>]}
2018-02-13 15:39:55,722: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:39:55,741: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:39:55,744: Parsing core.sql
2018-02-13 15:39:55,766: Parsing adapters/bigquery.sql
2018-02-13 15:39:55,774: Parsing adapters/common.sql
2018-02-13 15:39:55,797: Parsing adapters/postgres.sql
2018-02-13 15:39:55,806: Parsing adapters/redshift.sql
2018-02-13 15:39:55,846: Parsing etc/get_custom_schema.sql
2018-02-13 15:39:55,866: Parsing materializations/archive.sql
2018-02-13 15:39:55,916: Parsing materializations/bigquery.sql
2018-02-13 15:39:55,935: Parsing materializations/helpers.sql
2018-02-13 15:39:55,977: Parsing materializations/incremental.sql
2018-02-13 15:39:56,041: Parsing materializations/table.sql
2018-02-13 15:39:56,084: Parsing materializations/view.sql
2018-02-13 15:39:56,149: Parsing materializations/wrapper.sql
2018-02-13 15:39:56,155: Parsing schema_tests/accepted_values.sql
2018-02-13 15:39:56,166: Parsing schema_tests/not_null.sql
2018-02-13 15:39:56,170: Parsing schema_tests/relationships.sql
2018-02-13 15:39:56,178: Parsing schema_tests/unique.sql
2018-02-13 15:39:56,245: Parsing model.seo_audit.actions
2018-02-13 15:39:56,251: Acquiring new bigquery connection "master".
2018-02-13 15:39:56,251: Opening a new connection (0 currently allocated)
2018-02-13 15:39:56,257: Parsing model.seo_audit.accounts_proc
2018-02-13 15:39:56,262: Parsing model.seo_audit.all_dates
2018-02-13 15:39:56,264: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:39:56,270: Parsing model.seo_audit.agg_all
2018-02-13 15:39:56,275: Parsing model.seo_audit.agg_indicative
2018-02-13 15:39:56,281: Parsing model.seo_audit.agg_stats
2018-02-13 15:39:56,293: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:39:56,297: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:39:56,301: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:39:56,304: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:39:56,306: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:39:56,313: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:39:56,321: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:39:56,327: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:39:56,334: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:39:56,355: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:39:56,361: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:39:56,365: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:39:56,367: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:39:56,369: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:39:56,372: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:39:56,374: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:39:56,379: Parsing model.seo_audit.ga_proc
2018-02-13 15:39:56,387: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:39:56,391: Parsing model.seo_audit.ga_stats
2018-02-13 15:39:56,395: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:39:56,397: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:39:56,400: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:39:56,402: Parsing model.seo_audit.moz_proc
2018-02-13 15:39:56,405: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:39:56,408: Parsing model.seo_audit.search_console_history
2018-02-13 15:39:56,411: Parsing model.seo_audit.search_console_proc
2018-02-13 15:39:56,415: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:39:56,417: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:39:56,419: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:39:56,422: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:39:56,425: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:39:56,427: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:39:56,432: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:39:56,436: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:39:56,440: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:39:56,458: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:39:56,474: 
2018-02-13 15:39:57,901: 15:39:57 | Concurrency: 4 threads (target='prod')
2018-02-13 15:39:57,902: 15:39:57 | 
2018-02-13 15:39:58,249: 15:39:58 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:39:58,250: Compiling model.seo_audit.all_dates
2018-02-13 15:39:58,250: 15:39:58 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:39:58,254: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:39:58,250: 15:39:58 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:39:58,254: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:39:58,254: Compiling model.seo_audit.accounts_proc
2018-02-13 15:39:58,259: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:39:58,259: Acquiring new bigquery connection "all_dates".
2018-02-13 15:39:58,264: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:39:58,265: Opening a new connection (1 currently allocated)
2018-02-13 15:39:58,325: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:39:58,326: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:39:58,326: Opening a new connection (2 currently allocated)
2018-02-13 15:39:58,384: Opening a new connection (3 currently allocated)
2018-02-13 15:39:59,542: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:39:59,694: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:39:59,817: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:40:01,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b2c2e8>]}
2018-02-13 15:40:01,684: 15:40:01 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.12s]
2018-02-13 15:40:01,769: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b3aa20>]}
2018-02-13 15:40:02,091: 15:40:02 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.51s]
2018-02-13 15:40:02,392: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b24e10>]}
2018-02-13 15:40:02,809: 15:40:02 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 4.14s]
2018-02-13 15:40:02,810: 15:40:02 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:40:02,810: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:40:02,810: 15:40:02 | 5 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:40:02,818: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:40:02,819: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:40:02,810: 15:40:02 | 6 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:40:02,810: 15:40:02 | 7 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:40:02,826: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:40:02,826: Compiling model.seo_audit.moz_proc
2018-02-13 15:40:02,828: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:40:02,833: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:40:02,836: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:40:02,850: Re-using an available connection from the pool.
2018-02-13 15:40:02,853: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:40:02,855: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:40:02,856: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:40:02,858: Re-using an available connection from the pool.
2018-02-13 15:40:02,860: Re-using an available connection from the pool.
2018-02-13 15:40:02,861: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:40:02,863: Opening a new connection (4 currently allocated)
2018-02-13 15:40:03,656: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:40:03,713: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:40:03,733: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:40:04,075: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:40:05,859: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b3aeb8>]}
2018-02-13 15:40:05,983: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b81128>]}
2018-02-13 15:40:06,241: 15:40:06 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.05s]
2018-02-13 15:40:06,242: 15:40:06 | 8 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:40:06,243: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:40:06,255: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:40:06,258: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:40:06,258: Re-using an available connection from the pool.
2018-02-13 15:40:06,589: 15:40:06 | 5 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.16s]
2018-02-13 15:40:06,590: 15:40:06 | 9 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:40:06,590: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:40:06,599: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:40:06,602: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:40:06,602: Re-using an available connection from the pool.
2018-02-13 15:40:06,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ab1a20>]}
2018-02-13 15:40:06,988: 15:40:06 | 7 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.79s]
2018-02-13 15:40:06,988: 15:40:06 | 10 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 15:40:06,989: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:40:06,997: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:40:07,001: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:40:07,001: Re-using an available connection from the pool.
2018-02-13 15:40:07,299: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:40:07,300: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:40:07,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a840f0>]}
2018-02-13 15:40:07,862: 15:40:07 | 6 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 4.68s]
2018-02-13 15:40:07,862: 15:40:07 | 11 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:40:07,863: Compiling model.seo_audit.search_console_proc
2018-02-13 15:40:07,870: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:40:07,873: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:40:07,873: Re-using an available connection from the pool.
2018-02-13 15:40:08,021: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:40:08,511: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b1a208>]}
2018-02-13 15:40:08,608: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:40:08,881: 15:40:08 | 8 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.27s]
2018-02-13 15:40:09,582: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5978>]}
2018-02-13 15:40:09,878: 15:40:09 | 9 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.99s]
2018-02-13 15:40:10,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b2c160>]}
2018-02-13 15:40:10,591: 15:40:10 | 10 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.31s]
2018-02-13 15:40:12,952: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a840f0>]}
2018-02-13 15:40:13,241: 15:40:13 | 11 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 5.09s]
2018-02-13 15:40:13,243: 15:40:13 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:40:13,244: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:40:13,250: 15:40:13 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:40:13,244: 15:40:13 | 13 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:40:13,250: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:40:13,252: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:40:13,253: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:40:13,250: 15:40:13 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:40:13,257: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:40:13,264: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:40:13,264: Compiling model.seo_audit.search_console_history
2018-02-13 15:40:13,269: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:40:13,271: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:40:13,271: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:40:13,272: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:40:13,272: Re-using an available connection from the pool.
2018-02-13 15:40:13,273: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:40:13,273: Re-using an available connection from the pool.
2018-02-13 15:40:13,276: Re-using an available connection from the pool.
2018-02-13 15:40:13,279: Re-using an available connection from the pool.
2018-02-13 15:40:14,094: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:40:14,095: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:40:14,111: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:40:14,152: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:40:16,283: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bab780>]}
2018-02-13 15:40:16,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b3af28>]}
2018-02-13 15:40:16,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b24e10>]}
2018-02-13 15:40:16,574: 15:40:16 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.03s]
2018-02-13 15:40:16,576: 15:40:16 | 16 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:40:16,578: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:40:16,589: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:40:16,591: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:40:16,591: Re-using an available connection from the pool.
2018-02-13 15:40:16,945: 15:40:16 | 13 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.05s]
2018-02-13 15:40:17,253: 15:40:17 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.09s]
2018-02-13 15:40:17,317: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:40:17,494: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e3dbe0>]}
2018-02-13 15:40:17,849: 15:40:17 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.23s]
2018-02-13 15:40:19,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e30d30>]}
2018-02-13 15:40:19,959: 15:40:19 | 16 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.97s]
2018-02-13 15:40:19,960: 15:40:19 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:40:19,960: 15:40:19 | 18 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:40:19,960: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:40:19,960: 15:40:19 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:40:19,961: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:40:19,968: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:40:19,968: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:40:19,974: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:40:19,980: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:40:19,981: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:40:19,981: Re-using an available connection from the pool.
2018-02-13 15:40:19,983: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:40:19,983: Re-using an available connection from the pool.
2018-02-13 15:40:19,985: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:40:19,987: Re-using an available connection from the pool.
2018-02-13 15:40:20,721: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:40:20,812: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:40:20,814: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:40:23,022: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065326d8>]}
2018-02-13 15:40:23,028: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ac7240>]}
2018-02-13 15:40:23,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4ef60>]}
2018-02-13 15:40:23,592: 15:40:23 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.06s]
2018-02-13 15:40:23,968: 15:40:23 | 18 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.07s]
2018-02-13 15:40:24,414: 15:40:24 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 3.10s]
2018-02-13 15:40:24,415: 15:40:24 | 20 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:40:24,415: 15:40:24 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:40:24,415: 15:40:24 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:40:24,416: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:40:24,415: 15:40:24 | 23 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:40:24,416: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:40:24,416: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:40:24,427: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:40:24,427: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:40:24,437: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:40:24,444: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:40:24,452: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:40:24,454: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:40:24,459: Re-using an available connection from the pool.
2018-02-13 15:40:24,456: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:40:24,462: Re-using an available connection from the pool.
2018-02-13 15:40:24,459: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:40:24,465: Re-using an available connection from the pool.
2018-02-13 15:40:24,458: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:40:24,472: Re-using an available connection from the pool.
2018-02-13 15:40:25,224: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:40:25,230: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:40:25,249: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:40:25,307: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:40:26,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b2c2b0>]}
2018-02-13 15:40:26,939: 15:40:26 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.05s]
2018-02-13 15:40:27,553: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ab1908>]}
2018-02-13 15:40:27,558: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a5dbe0>]}
2018-02-13 15:40:27,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e30d30>]}
2018-02-13 15:40:28,078: 15:40:28 | 23 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.13s]
2018-02-13 15:40:28,319: 15:40:28 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.14s]
2018-02-13 15:40:28,657: 15:40:28 | 20 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.30s]
2018-02-13 15:40:28,658: 15:40:28 | 24 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:40:28,658: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:40:28,665: 15:40:28 | 25 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:40:28,665: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:40:28,671: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:40:28,672: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:40:28,672: 15:40:28 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:40:28,672: 15:40:28 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:40:28,673: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:40:28,673: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:40:28,674: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:40:28,678: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:40:28,679: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:40:28,683: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:40:28,684: Re-using an available connection from the pool.
2018-02-13 15:40:28,685: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:40:28,685: Re-using an available connection from the pool.
2018-02-13 15:40:28,686: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:40:28,688: Re-using an available connection from the pool.
2018-02-13 15:40:28,697: Re-using an available connection from the pool.
2018-02-13 15:40:29,355: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:40:29,356: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:40:29,386: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:40:29,429: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:40:31,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e307f0>]}
2018-02-13 15:40:31,705: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e13a20>]}
2018-02-13 15:40:31,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ab1f28>]}
2018-02-13 15:40:31,758: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5940>]}
2018-02-13 15:40:32,080: 15:40:32 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.02s]
2018-02-13 15:40:32,082: 15:40:32 | 28 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:40:32,085: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:40:32,095: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:40:32,096: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:40:32,097: Re-using an available connection from the pool.
2018-02-13 15:40:32,368: 15:40:32 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.03s]
2018-02-13 15:40:32,370: 15:40:32 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:40:32,370: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:40:32,377: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:40:32,380: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:40:32,381: Re-using an available connection from the pool.
2018-02-13 15:40:32,702: 15:40:32 | 25 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 3.05s]
2018-02-13 15:40:32,736: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:40:33,027: 15:40:33 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.10s]
2018-02-13 15:40:33,374: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:40:33,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b24080>]}
2018-02-13 15:40:34,254: 15:40:34 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.77s]
2018-02-13 15:40:34,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a70d68>]}
2018-02-13 15:40:35,216: 15:40:35 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.19s]
2018-02-13 15:40:35,217: 15:40:35 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:40:35,218: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:40:35,225: 15:40:35 | 31 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:40:35,225: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:40:35,232: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:40:35,236: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:40:35,238: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:40:35,239: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:40:35,236: 15:40:35 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:40:35,239: Re-using an available connection from the pool.
2018-02-13 15:40:35,239: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:40:35,240: Re-using an available connection from the pool.
2018-02-13 15:40:35,249: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:40:35,262: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:40:35,263: Re-using an available connection from the pool.
2018-02-13 15:40:36,035: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:40:36,074: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:40:36,502: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:40:37,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e01668>]}
2018-02-13 15:40:37,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e011d0>]}
2018-02-13 15:40:37,686: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ab1908>]}
2018-02-13 15:40:37,722: 15:40:37 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.92s]
2018-02-13 15:40:37,986: 15:40:37 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.00s]
2018-02-13 15:40:38,282: 15:40:38 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.47s]
2018-02-13 15:40:38,283: 15:40:38 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:40:38,283: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:40:38,293: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:40:38,293: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:40:38,294: Re-using an available connection from the pool.
2018-02-13 15:40:39,395: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:40:42,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a70d68>]}
2018-02-13 15:40:43,114: 15:40:43 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.51s]
2018-02-13 15:40:43,115: 15:40:43 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:40:43,116: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:40:43,124: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:40:43,125: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:40:43,125: Re-using an available connection from the pool.
2018-02-13 15:40:44,250: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:40:45,414: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5940>]}
2018-02-13 15:40:45,785: 15:40:45 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.30s]
2018-02-13 15:40:45,785: 15:40:45 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:40:45,786: 15:40:45 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:40:45,786: Compiling model.seo_audit.ga_proc
2018-02-13 15:40:45,786: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:40:45,805: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:40:45,810: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:40:45,814: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:40:45,814: Re-using an available connection from the pool.
2018-02-13 15:40:45,818: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:40:45,819: Re-using an available connection from the pool.
2018-02-13 15:40:46,560: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:40:46,602: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:40:48,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b245c0>]}
2018-02-13 15:40:49,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a70d68>]}
2018-02-13 15:40:49,091: 15:40:49 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.03s]
2018-02-13 15:40:49,419: 15:40:49 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.26s]
2018-02-13 15:40:49,420: 15:40:49 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:40:49,420: Compiling model.seo_audit.agg_indicative
2018-02-13 15:40:49,430: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:40:49,431: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:40:49,431: Re-using an available connection from the pool.
2018-02-13 15:40:50,204: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:40:52,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5940>]}
2018-02-13 15:40:52,731: 15:40:52 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.01s]
2018-02-13 15:40:52,731: 15:40:52 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:40:52,731: Compiling model.seo_audit.ga_stats
2018-02-13 15:40:52,737: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:40:52,738: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:40:52,738: Re-using an available connection from the pool.
2018-02-13 15:40:53,530: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:40:55,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a70d68>]}
2018-02-13 15:40:56,377: 15:40:56 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.02s]
2018-02-13 15:40:56,378: 15:40:56 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:40:56,378: Compiling model.seo_audit.agg_stats
2018-02-13 15:40:56,390: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:40:56,392: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:40:56,392: Re-using an available connection from the pool.
2018-02-13 15:40:57,445: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:40:59,908: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5940>]}
2018-02-13 15:41:00,273: 15:41:00 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.53s]
2018-02-13 15:41:00,274: 15:41:00 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:41:00,274: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:41:00,283: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:41:00,284: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:41:00,285: Re-using an available connection from the pool.
2018-02-13 15:41:00,998: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:41:03,304: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a70d68>]}
2018-02-13 15:41:03,620: 15:41:03 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 3.03s]
2018-02-13 15:41:03,621: 15:41:03 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:41:03,621: Compiling model.seo_audit.agg_all
2018-02-13 15:41:03,633: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:41:03,634: Acquiring new bigquery connection "agg_all".
2018-02-13 15:41:03,634: Re-using an available connection from the pool.
2018-02-13 15:41:04,059: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	)
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:41:04,059: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	)
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:41:04,059: 400 Unrecognized name: b at [94:9]
2018-02-13 15:41:04,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a86ba064-7530-489e-bca6-93b5859cac3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b6f3c8>]}
2018-02-13 15:41:04,447: 15:41:04 | 41 of 42 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.44s]
2018-02-13 15:41:04,448: 15:41:04 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:41:04,516: 15:41:04 | 
2018-02-13 15:41:04,517: 15:41:04 | Finished running 42 table models in 66.62s.
2018-02-13 15:41:04,517: Connection 'master' was left open.
2018-02-13 15:41:04,517: 
2018-02-13 15:41:04,517: Completed with 1 errors:
2018-02-13 15:41:04,517: 
2018-02-13 15:41:04,518: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-13 15:41:04,518:   Unrecognized name: b at [94:9]
2018-02-13 15:41:04,518:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-13 15:41:04,518: 
Done. PASS=40 ERROR=1 SKIP=1 TOTAL=42
2018-02-13 15:41:04,519: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a5da20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a5d780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ae5d30>]}
2018-02-13 15:41:04,778: Flushing usage events
2018-02-13 15:42:26,388: Tracking: tracking
2018-02-13 15:42:26,391: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098072e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109807b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109807080>]}
2018-02-13 15:42:27,240: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:42:27,261: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:42:27,267: Parsing core.sql
2018-02-13 15:42:27,289: Parsing adapters/bigquery.sql
2018-02-13 15:42:27,296: Parsing adapters/common.sql
2018-02-13 15:42:27,317: Parsing adapters/postgres.sql
2018-02-13 15:42:27,325: Parsing adapters/redshift.sql
2018-02-13 15:42:27,349: Parsing etc/get_custom_schema.sql
2018-02-13 15:42:27,357: Parsing materializations/archive.sql
2018-02-13 15:42:27,393: Parsing materializations/bigquery.sql
2018-02-13 15:42:27,412: Parsing materializations/helpers.sql
2018-02-13 15:42:27,439: Parsing materializations/incremental.sql
2018-02-13 15:42:27,473: Parsing materializations/table.sql
2018-02-13 15:42:27,498: Parsing materializations/view.sql
2018-02-13 15:42:27,517: Parsing materializations/wrapper.sql
2018-02-13 15:42:27,525: Parsing schema_tests/accepted_values.sql
2018-02-13 15:42:27,533: Parsing schema_tests/not_null.sql
2018-02-13 15:42:27,538: Parsing schema_tests/relationships.sql
2018-02-13 15:42:27,547: Parsing schema_tests/unique.sql
2018-02-13 15:42:27,630: Parsing model.seo_audit.actions
2018-02-13 15:42:27,635: Acquiring new bigquery connection "master".
2018-02-13 15:42:27,636: Opening a new connection (0 currently allocated)
2018-02-13 15:42:27,643: Parsing model.seo_audit.accounts_proc
2018-02-13 15:42:27,647: Parsing model.seo_audit.all_dates
2018-02-13 15:42:27,650: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:42:27,655: Parsing model.seo_audit.agg_all
2018-02-13 15:42:27,659: Parsing model.seo_audit.agg_indicative
2018-02-13 15:42:27,661: Parsing model.seo_audit.agg_stats
2018-02-13 15:42:27,666: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:42:27,668: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:42:27,670: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:42:27,672: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:42:27,674: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:42:27,675: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:42:27,678: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:42:27,680: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:42:27,683: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:42:27,691: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:42:27,693: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:42:27,695: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:42:27,697: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:42:27,698: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:42:27,700: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:42:27,702: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:42:27,705: Parsing model.seo_audit.ga_proc
2018-02-13 15:42:27,708: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:42:27,711: Parsing model.seo_audit.ga_stats
2018-02-13 15:42:27,713: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:42:27,715: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:42:27,717: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:42:27,719: Parsing model.seo_audit.moz_proc
2018-02-13 15:42:27,722: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:42:27,725: Parsing model.seo_audit.search_console_history
2018-02-13 15:42:27,727: Parsing model.seo_audit.search_console_proc
2018-02-13 15:42:27,729: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:42:27,732: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:42:27,733: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:42:27,736: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:42:27,739: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:42:27,741: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:42:27,744: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:42:27,746: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:42:27,748: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:42:27,772: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:42:27,802: 
2018-02-13 15:42:28,868: 15:42:28 | Concurrency: 4 threads (target='prod')
2018-02-13 15:42:28,869: 15:42:28 | 
2018-02-13 15:42:29,251: 15:42:29 | 1 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:42:29,251: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:42:29,251: 15:42:29 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:42:29,256: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:42:29,251: 15:42:29 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:42:29,257: Compiling model.seo_audit.all_dates
2018-02-13 15:42:29,257: Compiling model.seo_audit.accounts_proc
2018-02-13 15:42:29,261: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:42:29,265: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:42:29,266: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:42:29,267: Opening a new connection (1 currently allocated)
2018-02-13 15:42:29,268: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:42:29,268: Acquiring new bigquery connection "all_dates".
2018-02-13 15:42:29,270: Opening a new connection (2 currently allocated)
2018-02-13 15:42:29,322: Opening a new connection (3 currently allocated)
2018-02-13 15:42:30,530: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:42:30,532: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:42:30,652: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:42:32,864: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099b47f0>]}
2018-02-13 15:42:32,869: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109990588>]}
2018-02-13 15:42:32,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109987710>]}
2018-02-13 15:42:33,320: 15:42:33 | 1 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.61s]
2018-02-13 15:42:33,741: 15:42:33 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.61s]
2018-02-13 15:42:34,345: 15:42:34 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.69s]
2018-02-13 15:42:34,346: 15:42:34 | 4 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:42:34,347: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:42:34,346: 15:42:34 | 6 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:42:34,347: 15:42:34 | 7 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:42:34,346: 15:42:34 | 5 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:42:34,356: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:42:34,356: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:42:34,356: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:42:34,357: Compiling model.seo_audit.moz_proc
2018-02-13 15:42:34,375: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:42:34,387: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:42:34,388: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:42:34,407: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:42:34,418: Re-using an available connection from the pool.
2018-02-13 15:42:34,423: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:42:34,424: Re-using an available connection from the pool.
2018-02-13 15:42:34,428: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:42:34,435: Re-using an available connection from the pool.
2018-02-13 15:42:34,447: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:42:34,449: Opening a new connection (4 currently allocated)
2018-02-13 15:42:35,382: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:42:35,437: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:42:35,438: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:42:36,542: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:42:37,959: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109945be0>]}
2018-02-13 15:42:37,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099b4828>]}
2018-02-13 15:42:38,403: 15:42:38 | 6 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.60s]
2018-02-13 15:42:38,404: 15:42:38 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:42:38,404: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:42:38,410: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:42:38,413: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:42:38,414: Re-using an available connection from the pool.
2018-02-13 15:42:38,680: 15:42:38 | 5 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.63s]
2018-02-13 15:42:38,680: 15:42:38 | 9 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:42:38,680: Compiling model.seo_audit.search_console_proc
2018-02-13 15:42:38,691: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:42:38,695: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:42:38,695: Re-using an available connection from the pool.
2018-02-13 15:42:39,038: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:42:39,089: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099fd748>]}
2018-02-13 15:42:39,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f3b00>]}
2018-02-13 15:42:39,418: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:42:39,572: 15:42:39 | 4 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 4.74s]
2018-02-13 15:42:39,573: 15:42:39 | 10 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:42:39,573: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:42:39,578: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:42:39,581: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:42:39,581: Re-using an available connection from the pool.
2018-02-13 15:42:40,126: 15:42:40 | 7 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.79s]
2018-02-13 15:42:40,127: 15:42:40 | 11 of 42 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-02-13 15:42:40,127: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:42:40,139: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:42:40,141: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:42:40,141: Re-using an available connection from the pool.
2018-02-13 15:42:40,651: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:42:41,207: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:42:41,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109945be0>]}
2018-02-13 15:42:41,822: 15:42:41 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.92s]
2018-02-13 15:42:42,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109947ac8>]}
2018-02-13 15:42:42,673: 15:42:42 | 9 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.42s]
2018-02-13 15:42:43,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099fd748>]}
2018-02-13 15:42:43,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099fd978>]}
2018-02-13 15:42:43,824: 15:42:43 | 10 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 3.45s]
2018-02-13 15:42:44,252: 15:42:44 | 11 of 42 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 3.48s]
2018-02-13 15:42:44,253: 15:42:44 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:42:44,253: 15:42:44 | 13 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:42:44,253: 15:42:44 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:42:44,254: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:42:44,254: 15:42:44 | 15 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:42:44,254: Compiling model.seo_audit.search_console_history
2018-02-13 15:42:44,254: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:42:44,261: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:42:44,262: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:42:44,271: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:42:44,267: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:42:44,278: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:42:44,279: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:42:44,280: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:42:44,280: Re-using an available connection from the pool.
2018-02-13 15:42:44,281: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:42:44,283: Re-using an available connection from the pool.
2018-02-13 15:42:44,284: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:42:44,285: Re-using an available connection from the pool.
2018-02-13 15:42:44,287: Re-using an available connection from the pool.
2018-02-13 15:42:45,129: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:42:45,129: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:42:45,196: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:42:45,309: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:42:47,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109947dd8>]}
2018-02-13 15:42:47,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f0be0>]}
2018-02-13 15:42:47,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109987710>]}
2018-02-13 15:42:47,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a0d5f8>]}
2018-02-13 15:42:47,803: 15:42:47 | 15 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.14s]
2018-02-13 15:42:47,805: 15:42:47 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:42:47,807: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:42:47,821: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:42:47,828: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:42:47,828: Re-using an available connection from the pool.
2018-02-13 15:42:48,094: 15:42:48 | 13 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.16s]
2018-02-13 15:42:48,394: 15:42:48 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.17s]
2018-02-13 15:42:48,548: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:42:48,647: 15:42:48 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.31s]
2018-02-13 15:42:51,285: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109807898>]}
2018-02-13 15:42:51,633: 15:42:51 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.48s]
2018-02-13 15:42:51,634: 15:42:51 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:42:51,634: 15:42:51 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:42:51,635: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:42:51,635: 15:42:51 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:42:51,635: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:42:51,642: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:42:51,644: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:42:51,648: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:42:51,653: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:42:51,654: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:42:51,655: Re-using an available connection from the pool.
2018-02-13 15:42:51,656: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:42:51,656: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:42:51,656: Re-using an available connection from the pool.
2018-02-13 15:42:51,657: Re-using an available connection from the pool.
2018-02-13 15:42:52,344: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:42:52,412: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:42:52,658: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:42:54,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109945be0>]}
2018-02-13 15:42:54,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd8d470>]}
2018-02-13 15:42:54,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099df6a0>]}
2018-02-13 15:42:55,270: 15:42:55 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.06s]
2018-02-13 15:42:55,763: 15:42:55 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.28s]
2018-02-13 15:42:56,712: 15:42:56 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 3.32s]
2018-02-13 15:42:56,713: 15:42:56 | 20 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:42:56,714: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:42:56,714: 15:42:56 | 21 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:42:56,721: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:42:56,714: 15:42:56 | 22 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:42:56,728: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:42:56,729: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:42:56,714: 15:42:56 | 23 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:42:56,730: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:42:56,735: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:42:56,736: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:42:56,741: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:42:56,742: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:42:56,742: Re-using an available connection from the pool.
2018-02-13 15:42:56,743: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:42:56,744: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:42:56,745: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:42:56,745: Re-using an available connection from the pool.
2018-02-13 15:42:56,759: Re-using an available connection from the pool.
2018-02-13 15:42:56,764: Re-using an available connection from the pool.
2018-02-13 15:42:57,600: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:42:57,644: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:42:57,645: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:42:57,658: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:42:59,110: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109807898>]}
2018-02-13 15:42:59,510: 15:42:59 | 20 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.40s]
2018-02-13 15:43:00,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109947828>]}
2018-02-13 15:43:00,683: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f3b00>]}
2018-02-13 15:43:00,706: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd65828>]}
2018-02-13 15:43:01,232: 15:43:01 | 21 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.96s]
2018-02-13 15:43:01,601: 15:43:01 | 22 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.95s]
2018-02-13 15:43:01,995: 15:43:01 | 23 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.97s]
2018-02-13 15:43:01,996: 15:43:01 | 24 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:43:01,997: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:43:01,997: 15:43:01 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:43:02,007: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:43:01,997: 15:43:01 | 26 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:43:02,007: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:43:01,997: 15:43:01 | 27 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:43:02,008: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:43:02,016: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:43:02,016: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:43:02,016: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:43:02,022: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:43:02,022: Re-using an available connection from the pool.
2018-02-13 15:43:02,036: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:43:02,038: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:43:02,039: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:43:02,046: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:43:02,046: Re-using an available connection from the pool.
2018-02-13 15:43:02,048: Re-using an available connection from the pool.
2018-02-13 15:43:02,049: Re-using an available connection from the pool.
2018-02-13 15:43:04,881: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:43:04,926: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:43:04,952: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:43:05,003: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:43:06,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099df320>]}
2018-02-13 15:43:06,416: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109990b70>]}
2018-02-13 15:43:06,418: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990d400>]}
2018-02-13 15:43:06,743: 15:43:06 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 4.39s]
2018-02-13 15:43:06,745: 15:43:06 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:43:06,747: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:43:06,757: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:43:06,758: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:43:06,758: Re-using an available connection from the pool.
2018-02-13 15:43:07,439: 15:43:07 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 4.41s]
2018-02-13 15:43:07,440: 15:43:07 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:43:07,440: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:43:07,448: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:43:07,450: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:43:07,450: Re-using an available connection from the pool.
2018-02-13 15:43:07,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a13898>]}
2018-02-13 15:43:07,797: 15:43:07 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 4.41s]
2018-02-13 15:43:08,159: 15:43:08 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 5.79s]
2018-02-13 15:43:08,618: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:43:08,766: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:43:10,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10993ac88>]}
2018-02-13 15:43:10,154: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109930a90>]}
2018-02-13 15:43:10,397: 15:43:10 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.57s]
2018-02-13 15:43:10,640: 15:43:10 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.41s]
2018-02-13 15:43:10,641: 15:43:10 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:43:10,641: 15:43:10 | 31 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:43:10,642: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:43:10,642: 15:43:10 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:43:10,642: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:43:10,649: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:43:10,649: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:43:10,653: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:43:10,657: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:43:10,658: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:43:10,659: Re-using an available connection from the pool.
2018-02-13 15:43:10,659: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:43:10,659: Re-using an available connection from the pool.
2018-02-13 15:43:10,664: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:43:10,664: Re-using an available connection from the pool.
2018-02-13 15:43:11,570: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:43:11,591: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:43:11,593: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:43:12,682: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994e550>]}
2018-02-13 15:43:12,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a0de80>]}
2018-02-13 15:43:12,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f0dd8>]}
2018-02-13 15:43:13,060: 15:43:13 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.04s]
2018-02-13 15:43:13,547: 15:43:13 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.06s]
2018-02-13 15:43:14,089: 15:43:14 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.08s]
2018-02-13 15:43:14,090: 15:43:14 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:43:14,090: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:43:14,105: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:43:14,106: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:43:14,106: Re-using an available connection from the pool.
2018-02-13 15:43:15,244: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:43:17,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bd609e8>]}
2018-02-13 15:43:17,843: 15:43:17 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.43s]
2018-02-13 15:43:17,845: 15:43:17 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:43:17,845: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:43:17,853: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:43:17,854: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:43:17,854: Re-using an available connection from the pool.
2018-02-13 15:43:18,613: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:43:22,092: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994e550>]}
2018-02-13 15:43:22,564: 15:43:22 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 4.25s]
2018-02-13 15:43:22,565: 15:43:22 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:43:22,565: 15:43:22 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:43:22,566: Compiling model.seo_audit.ga_proc
2018-02-13 15:43:22,566: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:43:22,581: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:43:22,582: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:43:22,583: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:43:22,583: Re-using an available connection from the pool.
2018-02-13 15:43:22,583: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:43:22,584: Re-using an available connection from the pool.
2018-02-13 15:43:23,455: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:43:23,498: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:43:25,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990d400>]}
2018-02-13 15:43:25,729: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f0dd8>]}
2018-02-13 15:43:26,671: 15:43:26 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.14s]
2018-02-13 15:43:27,181: 15:43:27 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.16s]
2018-02-13 15:43:27,182: 15:43:27 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:43:27,182: Compiling model.seo_audit.agg_indicative
2018-02-13 15:43:27,192: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:43:27,193: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:43:27,193: Re-using an available connection from the pool.
2018-02-13 15:43:27,895: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:43:30,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994e550>]}
2018-02-13 15:43:30,527: 15:43:30 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.96s]
2018-02-13 15:43:30,528: 15:43:30 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:43:30,528: Compiling model.seo_audit.ga_stats
2018-02-13 15:43:30,537: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:43:30,538: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:43:30,539: Re-using an available connection from the pool.
2018-02-13 15:43:31,328: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:43:33,543: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098daac8>]}
2018-02-13 15:43:33,893: 15:43:33 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.01s]
2018-02-13 15:43:33,894: 15:43:33 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:43:33,894: Compiling model.seo_audit.agg_stats
2018-02-13 15:43:33,903: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:43:33,904: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:43:33,904: Re-using an available connection from the pool.
2018-02-13 15:43:35,162: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:43:37,408: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994e550>]}
2018-02-13 15:43:38,116: 15:43:38 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.51s]
2018-02-13 15:43:38,117: 15:43:38 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:43:38,117: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:43:38,127: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:43:38,129: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:43:38,129: Re-using an available connection from the pool.
2018-02-13 15:43:38,865: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:43:42,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098daac8>]}
2018-02-13 15:43:42,434: 15:43:42 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.03s]
2018-02-13 15:43:42,435: 15:43:42 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:43:42,435: Compiling model.seo_audit.agg_all
2018-02-13 15:43:42,443: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:43:42,444: Acquiring new bigquery connection "agg_all".
2018-02-13 15:43:42,444: Re-using an available connection from the pool.
2018-02-13 15:43:42,935: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	)
2018-02-13 15:43:42,935: Bad request while running:
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	)
2018-02-13 15:43:42,936: 400 Column name date is ambiguous at [2:1]
2018-02-13 15:43:42,936: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '173c1bc4-6ccf-45e9-927e-1e683fe6fafa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109930780>]}
2018-02-13 15:43:43,227: 15:43:43 | 41 of 42 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.50s]
2018-02-13 15:43:43,228: 15:43:43 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:43:43,301: 15:43:43 | 
2018-02-13 15:43:43,301: 15:43:43 | Finished running 42 table models in 74.44s.
2018-02-13 15:43:43,302: Connection 'master' was left open.
2018-02-13 15:43:43,302: 
2018-02-13 15:43:43,302: Completed with 1 errors:
2018-02-13 15:43:43,303: 
2018-02-13 15:43:43,303: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-13 15:43:43,303:   Column name date is ambiguous at [2:1]
2018-02-13 15:43:43,303:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-13 15:43:43,304: 
Done. PASS=40 ERROR=1 SKIP=1 TOTAL=42
2018-02-13 15:43:43,304: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098da898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098da748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098da710>]}
2018-02-13 15:43:43,579: Flushing usage events
2018-02-13 15:45:29,854: Tracking: tracking
2018-02-13 15:45:29,855: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1111765f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111176390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1128fee10>]}
2018-02-13 15:45:30,775: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:45:30,791: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:45:30,795: Parsing core.sql
2018-02-13 15:45:30,815: Parsing adapters/bigquery.sql
2018-02-13 15:45:30,824: Parsing adapters/common.sql
2018-02-13 15:45:30,842: Parsing adapters/postgres.sql
2018-02-13 15:45:30,850: Parsing adapters/redshift.sql
2018-02-13 15:45:30,871: Parsing etc/get_custom_schema.sql
2018-02-13 15:45:30,879: Parsing materializations/archive.sql
2018-02-13 15:45:30,912: Parsing materializations/bigquery.sql
2018-02-13 15:45:30,932: Parsing materializations/helpers.sql
2018-02-13 15:45:30,959: Parsing materializations/incremental.sql
2018-02-13 15:45:30,993: Parsing materializations/table.sql
2018-02-13 15:45:31,016: Parsing materializations/view.sql
2018-02-13 15:45:31,037: Parsing materializations/wrapper.sql
2018-02-13 15:45:31,045: Parsing schema_tests/accepted_values.sql
2018-02-13 15:45:31,052: Parsing schema_tests/not_null.sql
2018-02-13 15:45:31,056: Parsing schema_tests/relationships.sql
2018-02-13 15:45:31,061: Parsing schema_tests/unique.sql
2018-02-13 15:45:31,081: Parsing model.seo_audit.actions
2018-02-13 15:45:31,085: Acquiring new bigquery connection "master".
2018-02-13 15:45:31,085: Opening a new connection (0 currently allocated)
2018-02-13 15:45:31,087: Parsing model.seo_audit.accounts_proc
2018-02-13 15:45:31,089: Parsing model.seo_audit.all_dates
2018-02-13 15:45:31,090: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:45:31,094: Parsing model.seo_audit.agg_all
2018-02-13 15:45:31,097: Parsing model.seo_audit.agg_indicative
2018-02-13 15:45:31,099: Parsing model.seo_audit.agg_stats
2018-02-13 15:45:31,108: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:45:31,111: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:45:31,113: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:45:31,115: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:45:31,117: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:45:31,118: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:45:31,122: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:45:31,124: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:45:31,126: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:45:31,133: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:45:31,135: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:45:31,137: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:45:31,139: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:45:31,140: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:45:31,144: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:45:31,147: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:45:31,151: Parsing model.seo_audit.ga_proc
2018-02-13 15:45:31,154: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:45:31,157: Parsing model.seo_audit.ga_stats
2018-02-13 15:45:31,159: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:45:31,161: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:45:31,163: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:45:31,166: Parsing model.seo_audit.moz_proc
2018-02-13 15:45:31,168: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:45:31,171: Parsing model.seo_audit.search_console_history
2018-02-13 15:45:31,173: Parsing model.seo_audit.search_console_proc
2018-02-13 15:45:31,176: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:45:31,179: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:45:31,180: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:45:31,183: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:45:31,186: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:45:31,188: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:45:31,191: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:45:31,193: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:45:31,195: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:45:31,209: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:45:31,230: 
2018-02-13 15:45:33,041: 15:45:33 | Concurrency: 4 threads (target='prod')
2018-02-13 15:45:33,041: 15:45:33 | 
2018-02-13 15:45:33,443: 15:45:33 | 1 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:45:33,443: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:45:33,443: 15:45:33 | 2 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:45:33,448: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:45:33,443: 15:45:33 | 3 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:45:33,448: Compiling model.seo_audit.accounts_proc
2018-02-13 15:45:33,448: Compiling model.seo_audit.all_dates
2018-02-13 15:45:33,454: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:45:33,458: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:45:33,459: Acquiring new bigquery connection "all_dates".
2018-02-13 15:45:33,459: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:45:33,460: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:45:33,460: Opening a new connection (1 currently allocated)
2018-02-13 15:45:33,462: Opening a new connection (2 currently allocated)
2018-02-13 15:45:33,523: Opening a new connection (3 currently allocated)
2018-02-13 15:45:34,977: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:45:34,979: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:45:35,101: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:45:36,086: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aed860>]}
2018-02-13 15:45:36,385: 15:45:36 | 3 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.64s]
2018-02-13 15:45:37,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a92898>]}
2018-02-13 15:45:37,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a6a5c0>]}
2018-02-13 15:45:37,540: 15:45:37 | 2 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.75s]
2018-02-13 15:45:37,938: 15:45:37 | 1 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.85s]
2018-02-13 15:45:37,939: 15:45:37 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:45:37,940: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:45:37,940: 15:45:37 | 5 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:45:37,947: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:45:37,964: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:45:37,940: 15:45:37 | 6 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:45:37,965: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:45:37,965: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:45:37,940: 15:45:37 | 7 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:45:37,972: Compiling model.seo_audit.moz_proc
2018-02-13 15:45:37,997: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:45:37,997: Re-using an available connection from the pool.
2018-02-13 15:45:38,002: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:45:38,004: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:45:38,004: Re-using an available connection from the pool.
2018-02-13 15:45:38,009: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:45:38,011: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:45:38,011: Re-using an available connection from the pool.
2018-02-13 15:45:38,022: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:45:38,023: Opening a new connection (4 currently allocated)
2018-02-13 15:45:39,018: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:45:39,029: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:45:39,535: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:45:40,472: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:45:41,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a2afd0>]}
2018-02-13 15:45:41,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112afa0b8>]}
2018-02-13 15:45:41,520: 15:45:41 | 7 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.21s]
2018-02-13 15:45:41,522: 15:45:41 | 8 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:45:41,525: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:45:41,537: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:45:41,539: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:45:41,539: Re-using an available connection from the pool.
2018-02-13 15:45:41,776: 15:45:41 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.26s]
2018-02-13 15:45:41,777: 15:45:41 | 9 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:45:41,778: Compiling model.seo_audit.search_console_proc
2018-02-13 15:45:41,792: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:45:41,794: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:45:41,794: Re-using an available connection from the pool.
2018-02-13 15:45:42,276: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:45:42,683: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:45:42,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a2c0b8>]}
2018-02-13 15:45:43,024: 15:45:43 | 6 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.81s]
2018-02-13 15:45:43,024: 15:45:43 | 10 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 15:45:43,024: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:45:43,032: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:45:43,035: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:45:43,035: Re-using an available connection from the pool.
2018-02-13 15:45:43,692: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:45:44,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a2afd0>]}
2018-02-13 15:45:44,745: 15:45:44 | 8 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.92s]
2018-02-13 15:45:44,746: 15:45:44 | 11 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:45:44,747: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:45:44,757: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:45:44,759: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:45:44,759: Re-using an available connection from the pool.
2018-02-13 15:45:45,580: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:45:45,889: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a2c0b8>]}
2018-02-13 15:45:45,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112acfba8>]}
2018-02-13 15:45:46,154: 15:45:46 | 10 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.86s]
2018-02-13 15:45:46,391: 15:45:46 | 9 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.22s]
2018-02-13 15:45:47,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a2afd0>]}
2018-02-13 15:45:48,007: 15:45:48 | 11 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 3.02s]
2018-02-13 15:45:57,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129b4f98>]}
2018-02-13 15:45:57,357: 15:45:57 | 5 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 19.15s]
2018-02-13 15:45:57,358: 15:45:57 | 12 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:45:57,359: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:45:57,358: 15:45:57 | 13 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:45:57,366: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:45:57,376: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:45:57,378: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:45:57,359: 15:45:57 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:45:57,379: Compiling model.seo_audit.search_console_history
2018-02-13 15:45:57,383: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:45:57,359: 15:45:57 | 15 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:45:57,384: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:45:57,384: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:45:57,384: Re-using an available connection from the pool.
2018-02-13 15:45:57,390: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:45:57,391: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:45:57,392: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:45:57,393: Re-using an available connection from the pool.
2018-02-13 15:45:57,396: Re-using an available connection from the pool.
2018-02-13 15:45:57,406: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:45:57,406: Re-using an available connection from the pool.
2018-02-13 15:45:58,032: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:45:58,074: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:45:58,204: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:45:58,207: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:46:00,204: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112af8978>]}
2018-02-13 15:46:00,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:00,448: 15:46:00 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.82s]
2018-02-13 15:46:00,450: 15:46:00 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:46:00,452: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:46:00,467: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:46:00,472: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:46:00,472: Re-using an available connection from the pool.
2018-02-13 15:46:00,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129db0b8>]}
2018-02-13 15:46:00,493: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114e5abe0>]}
2018-02-13 15:46:00,719: 15:46:00 | 13 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.90s]
2018-02-13 15:46:00,950: 15:46:00 | 12 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.11s]
2018-02-13 15:46:01,212: 15:46:01 | 15 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.11s]
2018-02-13 15:46:01,418: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:46:03,663: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129db0b8>]}
2018-02-13 15:46:04,462: 15:46:04 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.21s]
2018-02-13 15:46:04,463: 15:46:04 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:46:04,464: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:46:04,463: 15:46:04 | 18 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:46:04,475: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:46:04,463: 15:46:04 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:46:04,474: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:46:04,483: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:46:04,483: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:46:04,490: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:46:04,491: Re-using an available connection from the pool.
2018-02-13 15:46:04,494: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:46:04,496: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:46:04,498: Re-using an available connection from the pool.
2018-02-13 15:46:04,497: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:46:04,505: Re-using an available connection from the pool.
2018-02-13 15:46:05,393: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:46:05,420: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:46:05,459: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:46:07,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a1d860>]}
2018-02-13 15:46:07,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114e39438>]}
2018-02-13 15:46:07,863: 15:46:07 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.15s]
2018-02-13 15:46:08,089: 15:46:08 | 18 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.15s]
2018-02-13 15:46:09,829: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112afac50>]}
2018-02-13 15:46:10,111: 15:46:10 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 5.35s]
2018-02-13 15:46:10,112: 15:46:10 | 20 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:46:10,113: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:46:10,113: 15:46:10 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:46:10,121: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:46:10,121: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:46:10,113: 15:46:10 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:46:10,127: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:46:10,113: 15:46:10 | 23 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:46:10,137: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:46:10,140: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:46:10,140: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:46:10,151: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:46:10,151: Re-using an available connection from the pool.
2018-02-13 15:46:10,177: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:46:10,182: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:46:10,182: Re-using an available connection from the pool.
2018-02-13 15:46:10,192: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:46:10,193: Re-using an available connection from the pool.
2018-02-13 15:46:10,207: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:46:10,208: Re-using an available connection from the pool.
2018-02-13 15:46:10,978: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:46:10,979: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:46:10,990: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:46:11,500: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:46:13,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129db0b8>]}
2018-02-13 15:46:13,340: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114f70a58>]}
2018-02-13 15:46:13,868: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114f70b00>]}
2018-02-13 15:46:14,370: 15:46:14 | 20 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.21s]
2018-02-13 15:46:15,418: 15:46:15 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.22s]
2018-02-13 15:46:15,744: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:15,921: 15:46:15 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.74s]
2018-02-13 15:46:16,412: 15:46:16 | 23 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 5.60s]
2018-02-13 15:46:16,413: 15:46:16 | 24 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:46:16,413: 15:46:16 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:46:16,414: 15:46:16 | 26 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:46:16,414: 15:46:16 | 27 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:46:16,414: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:46:16,414: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:46:16,415: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:46:16,415: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:46:16,429: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:46:16,435: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:46:16,435: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:46:16,440: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:46:16,442: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:46:16,442: Re-using an available connection from the pool.
2018-02-13 15:46:16,443: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:46:16,443: Re-using an available connection from the pool.
2018-02-13 15:46:16,444: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:46:16,444: Re-using an available connection from the pool.
2018-02-13 15:46:16,446: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:46:16,448: Re-using an available connection from the pool.
2018-02-13 15:46:17,257: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:46:17,295: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:46:17,296: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:46:17,314: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:46:18,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ad51d0>]}
2018-02-13 15:46:18,827: 15:46:18 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.96s]
2018-02-13 15:46:18,827: 15:46:18 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:46:18,828: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:46:18,836: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:46:18,838: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:46:18,838: Re-using an available connection from the pool.
2018-02-13 15:46:19,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114f85588>]}
2018-02-13 15:46:19,581: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aedeb8>]}
2018-02-13 15:46:19,638: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:46:19,965: 15:46:19 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.07s]
2018-02-13 15:46:19,967: 15:46:19 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:46:19,968: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:46:19,979: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:46:19,982: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:46:19,983: Re-using an available connection from the pool.
2018-02-13 15:46:20,405: 15:46:20 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.17s]
2018-02-13 15:46:20,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129db0b8>]}
2018-02-13 15:46:20,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ad51d0>]}
2018-02-13 15:46:20,923: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:46:21,045: 15:46:21 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 4.14s]
2018-02-13 15:46:21,449: 15:46:21 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.09s]
2018-02-13 15:46:22,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aed0b8>]}
2018-02-13 15:46:22,544: 15:46:22 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.08s]
2018-02-13 15:46:22,544: 15:46:22 | 30 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:46:22,545: 15:46:22 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:46:22,545: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:46:22,545: 15:46:22 | 32 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:46:22,546: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:46:22,552: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:46:22,553: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:46:22,559: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:46:22,563: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:46:22,564: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:46:22,565: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:46:22,565: Re-using an available connection from the pool.
2018-02-13 15:46:22,566: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:46:22,566: Re-using an available connection from the pool.
2018-02-13 15:46:22,568: Re-using an available connection from the pool.
2018-02-13 15:46:23,546: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:46:23,547: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:46:23,548: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:46:24,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:24,687: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114e39438>]}
2018-02-13 15:46:24,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ac6a20>]}
2018-02-13 15:46:25,234: 15:46:25 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 2.14s]
2018-02-13 15:46:25,764: 15:46:25 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.14s]
2018-02-13 15:46:26,281: 15:46:26 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 2.14s]
2018-02-13 15:46:26,282: 15:46:26 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:46:26,282: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:46:26,301: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:46:26,302: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:46:26,302: Re-using an available connection from the pool.
2018-02-13 15:46:27,226: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:46:34,030: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ac6ac8>]}
2018-02-13 15:46:34,294: 15:46:34 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 7.75s]
2018-02-13 15:46:34,295: 15:46:34 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:46:34,295: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:46:34,303: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:46:34,303: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:46:34,303: Re-using an available connection from the pool.
2018-02-13 15:46:35,193: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:46:36,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:36,778: 15:46:36 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.02s]
2018-02-13 15:46:36,779: 15:46:36 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:46:36,780: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:46:36,785: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:46:36,779: 15:46:36 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:46:36,786: Compiling model.seo_audit.ga_proc
2018-02-13 15:46:36,792: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:46:36,793: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:46:36,793: Re-using an available connection from the pool.
2018-02-13 15:46:36,795: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:46:36,796: Re-using an available connection from the pool.
2018-02-13 15:46:39,277: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:46:39,283: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:46:41,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aed940>]}
2018-02-13 15:46:41,897: 15:46:41 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.28s]
2018-02-13 15:46:42,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112aed0b8>]}
2018-02-13 15:46:43,075: 15:46:43 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 5.73s]
2018-02-13 15:46:43,075: 15:46:43 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:46:43,076: Compiling model.seo_audit.agg_indicative
2018-02-13 15:46:43,085: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:46:43,088: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:46:43,088: Re-using an available connection from the pool.
2018-02-13 15:46:45,565: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:46:50,100: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:50,359: 15:46:50 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 7.02s]
2018-02-13 15:46:50,360: 15:46:50 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:46:50,360: Compiling model.seo_audit.ga_stats
2018-02-13 15:46:50,367: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:46:50,368: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:46:50,369: Re-using an available connection from the pool.
2018-02-13 15:46:52,951: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:46:55,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114e414a8>]}
2018-02-13 15:46:56,235: 15:46:56 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 5.61s]
2018-02-13 15:46:56,236: 15:46:56 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:46:56,236: Compiling model.seo_audit.agg_stats
2018-02-13 15:46:56,248: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:46:56,250: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:46:56,250: Re-using an available connection from the pool.
2018-02-13 15:46:57,060: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:46:59,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129c8c18>]}
2018-02-13 15:46:59,573: 15:46:59 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.09s]
2018-02-13 15:46:59,574: 15:46:59 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:46:59,574: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:46:59,583: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:46:59,584: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:46:59,584: Re-using an available connection from the pool.
2018-02-13 15:47:00,850: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:47:03,053: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ad51d0>]}
2018-02-13 15:47:03,399: 15:47:03 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 3.48s]
2018-02-13 15:47:03,400: 15:47:03 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:47:03,400: Compiling model.seo_audit.agg_all
2018-02-13 15:47:03,411: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:47:03,412: Acquiring new bigquery connection "agg_all".
2018-02-13 15:47:03,413: Re-using an available connection from the pool.
2018-02-13 15:47:03,865: Model SQL (agg_all):
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:47:03,867: Bad request while running:
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, a.gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, a.gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:47:03,867: 400 Syntax error: Parenthesized expression cannot be parsed as an expression, struct constructor, or subquery at [97:9]
2018-02-13 15:47:03,868: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93fdb5dd-742d-418b-a128-8897de35b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114e39208>]}
2018-02-13 15:47:04,585: 15:47:04 | 41 of 42 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.47s]
2018-02-13 15:47:04,586: 15:47:04 | 42 of 42 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-13 15:47:04,610: 15:47:04 | 
2018-02-13 15:47:04,610: 15:47:04 | Finished running 42 table models in 91.57s.
2018-02-13 15:47:04,610: Connection 'master' was left open.
2018-02-13 15:47:04,611: 
2018-02-13 15:47:04,611: Completed with 1 errors:
2018-02-13 15:47:04,611: 
2018-02-13 15:47:04,611: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-13 15:47:04,611:   Syntax error: Parenthesized expression cannot be parsed as an expression, struct constructor, or subquery at [97:9]
2018-02-13 15:47:04,612:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-13 15:47:04,612: 
Done. PASS=40 ERROR=1 SKIP=1 TOTAL=42
2018-02-13 15:47:04,612: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a1d278>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1129ed390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112a5d5c0>]}
2018-02-13 15:47:04,967: Flushing usage events
2018-02-13 15:52:08,630: Tracking: tracking
2018-02-13 15:52:08,632: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056f3ba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056f3860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056f3828>]}
2018-02-13 15:52:09,392: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:52:09,409: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:52:09,415: Parsing core.sql
2018-02-13 15:52:09,443: Parsing adapters/bigquery.sql
2018-02-13 15:52:09,451: Parsing adapters/common.sql
2018-02-13 15:52:09,467: Parsing adapters/postgres.sql
2018-02-13 15:52:09,473: Parsing adapters/redshift.sql
2018-02-13 15:52:09,494: Parsing etc/get_custom_schema.sql
2018-02-13 15:52:09,503: Parsing materializations/archive.sql
2018-02-13 15:52:09,539: Parsing materializations/bigquery.sql
2018-02-13 15:52:09,565: Parsing materializations/helpers.sql
2018-02-13 15:52:09,591: Parsing materializations/incremental.sql
2018-02-13 15:52:09,624: Parsing materializations/table.sql
2018-02-13 15:52:09,654: Parsing materializations/view.sql
2018-02-13 15:52:09,676: Parsing materializations/wrapper.sql
2018-02-13 15:52:09,682: Parsing schema_tests/accepted_values.sql
2018-02-13 15:52:09,688: Parsing schema_tests/not_null.sql
2018-02-13 15:52:09,693: Parsing schema_tests/relationships.sql
2018-02-13 15:52:09,700: Parsing schema_tests/unique.sql
2018-02-13 15:52:09,764: Parsing model.seo_audit.actions
2018-02-13 15:52:09,769: Acquiring new bigquery connection "master".
2018-02-13 15:52:09,769: Opening a new connection (0 currently allocated)
2018-02-13 15:52:09,776: Parsing model.seo_audit.accounts_proc
2018-02-13 15:52:09,780: Parsing model.seo_audit.all_dates
2018-02-13 15:52:09,782: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:52:09,785: Parsing model.seo_audit.agg_all
2018-02-13 15:52:09,788: Parsing model.seo_audit.agg_indicative
2018-02-13 15:52:09,792: Parsing model.seo_audit.agg_stats
2018-02-13 15:52:09,797: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:52:09,800: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:52:09,802: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:52:09,804: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:52:09,807: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:52:09,809: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:52:09,811: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:52:09,813: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:52:09,816: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:52:09,823: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:52:09,825: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:52:09,828: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:52:09,829: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:52:09,831: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:52:09,833: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:52:09,835: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:52:09,839: Parsing model.seo_audit.ga_proc
2018-02-13 15:52:09,843: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:52:09,845: Parsing model.seo_audit.ga_stats
2018-02-13 15:52:09,847: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:52:09,849: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:52:09,852: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:52:09,855: Parsing model.seo_audit.moz_proc
2018-02-13 15:52:09,858: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:52:09,861: Parsing model.seo_audit.search_console_history
2018-02-13 15:52:09,863: Parsing model.seo_audit.search_console_proc
2018-02-13 15:52:09,866: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:52:09,868: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:52:09,870: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:52:09,875: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:52:09,877: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:52:09,880: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:52:09,882: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:52:09,885: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:52:09,887: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:52:09,902: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:52:09,916: 
2018-02-13 15:52:11,160: 15:52:11 | Concurrency: 4 threads (target='prod')
2018-02-13 15:52:11,161: 15:52:11 | 
2018-02-13 15:52:11,515: 15:52:11 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:52:11,515: Compiling model.seo_audit.all_dates
2018-02-13 15:52:11,515: 15:52:11 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:52:11,520: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:52:11,520: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:52:11,515: 15:52:11 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:52:11,526: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:52:11,526: Compiling model.seo_audit.accounts_proc
2018-02-13 15:52:11,535: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:52:11,535: Acquiring new bigquery connection "all_dates".
2018-02-13 15:52:11,536: Opening a new connection (1 currently allocated)
2018-02-13 15:52:11,537: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:52:11,537: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:52:11,540: Opening a new connection (2 currently allocated)
2018-02-13 15:52:11,596: Opening a new connection (3 currently allocated)
2018-02-13 15:52:12,572: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:52:12,667: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:52:12,673: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:52:13,667: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057c1a20>]}
2018-02-13 15:52:13,936: 15:52:13 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.15s]
2018-02-13 15:52:14,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10587bbe0>]}
2018-02-13 15:52:14,852: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10587b860>]}
2018-02-13 15:52:15,105: 15:52:15 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.32s]
2018-02-13 15:52:15,373: 15:52:15 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.33s]
2018-02-13 15:52:15,374: 15:52:15 | 4 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:52:15,375: 15:52:15 | 5 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:52:15,375: 15:52:15 | 6 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:52:15,375: 15:52:15 | 7 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:52:15,375: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:52:15,376: Compiling model.seo_audit.search_console_proc
2018-02-13 15:52:15,376: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:52:15,376: Compiling model.seo_audit.moz_proc
2018-02-13 15:52:15,390: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:52:15,390: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:52:15,403: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:52:15,407: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:52:15,412: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:52:15,413: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:52:15,414: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:52:15,414: Re-using an available connection from the pool.
2018-02-13 15:52:15,414: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:52:15,415: Re-using an available connection from the pool.
2018-02-13 15:52:15,417: Re-using an available connection from the pool.
2018-02-13 15:52:15,418: Opening a new connection (4 currently allocated)
2018-02-13 15:52:16,068: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:52:16,089: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:52:16,091: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:52:17,577: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:52:17,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057d4048>]}
2018-02-13 15:52:18,019: 15:52:18 | 7 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.40s]
2018-02-13 15:52:18,020: 15:52:18 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:52:18,020: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:52:18,028: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:52:18,029: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:52:18,029: Re-using an available connection from the pool.
2018-02-13 15:52:18,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057d4cc0>]}
2018-02-13 15:52:18,501: 15:52:18 | 6 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.89s]
2018-02-13 15:52:18,501: 15:52:18 | 9 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:52:18,502: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:52:18,508: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:52:18,511: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:52:18,511: Re-using an available connection from the pool.
2018-02-13 15:52:18,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105894e10>]}
2018-02-13 15:52:18,752: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:52:18,821: 15:52:18 | 4 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.18s]
2018-02-13 15:52:18,822: 15:52:18 | 10 of 42 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-02-13 15:52:18,822: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:52:18,832: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:52:18,834: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:52:18,834: Re-using an available connection from the pool.
2018-02-13 15:52:19,317: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:52:19,520: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:52:20,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10587b860>]}
2018-02-13 15:52:21,225: 15:52:21 | 5 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.61s]
2018-02-13 15:52:21,226: 15:52:21 | 11 of 42 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-13 15:52:21,226: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:52:21,236: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:52:21,238: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:52:21,238: Re-using an available connection from the pool.
2018-02-13 15:52:21,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057d4cc0>]}
2018-02-13 15:52:21,728: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105894e10>]}
2018-02-13 15:52:21,756: 15:52:21 | 9 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.01s]
2018-02-13 15:52:21,968: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:52:21,991: 15:52:21 | 10 of 42 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 2.91s]
2018-02-13 15:52:22,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058e7828>]}
2018-02-13 15:52:22,245: 15:52:22 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.99s]
2018-02-13 15:52:24,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10587b860>]}
2018-02-13 15:52:24,409: 15:52:24 | 11 of 42 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 2.92s]
2018-02-13 15:52:24,410: 15:52:24 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:52:24,411: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:52:24,410: 15:52:24 | 13 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:52:24,418: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:52:24,411: 15:52:24 | 14 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:52:24,418: Compiling model.seo_audit.search_console_history
2018-02-13 15:52:24,411: 15:52:24 | 15 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:52:24,418: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:52:24,423: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:52:24,424: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:52:24,424: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:52:24,428: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:52:24,428: Re-using an available connection from the pool.
2018-02-13 15:52:24,429: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:52:24,441: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:52:24,442: Re-using an available connection from the pool.
2018-02-13 15:52:24,443: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:52:24,458: Re-using an available connection from the pool.
2018-02-13 15:52:24,460: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:52:24,461: Re-using an available connection from the pool.
2018-02-13 15:52:25,252: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:52:25,253: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:52:25,253: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:52:25,256: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:52:27,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058d5f60>]}
2018-02-13 15:52:27,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:52:27,470: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057d4cc0>]}
2018-02-13 15:52:27,679: 15:52:27 | 14 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.01s]
2018-02-13 15:52:27,680: 15:52:27 | 16 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:52:27,682: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:52:27,693: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:52:27,696: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:52:27,696: Re-using an available connection from the pool.
2018-02-13 15:52:27,937: 15:52:27 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.05s]
2018-02-13 15:52:28,197: 15:52:28 | 15 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.05s]
2018-02-13 15:52:28,331: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:52:28,521: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058e7828>]}
2018-02-13 15:52:29,141: 15:52:29 | 13 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.10s]
2018-02-13 15:52:29,421: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058150b8>]}
2018-02-13 15:52:29,663: 15:52:29 | 16 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 1.74s]
2018-02-13 15:52:29,664: 15:52:29 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:52:29,664: 15:52:29 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:52:29,664: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:52:29,664: 15:52:29 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:52:29,665: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:52:29,670: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:52:29,671: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:52:29,676: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:52:29,681: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:52:29,682: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:52:29,682: Re-using an available connection from the pool.
2018-02-13 15:52:29,683: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:52:29,683: Re-using an available connection from the pool.
2018-02-13 15:52:29,684: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:52:29,684: Re-using an available connection from the pool.
2018-02-13 15:52:30,369: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:52:30,370: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:52:30,478: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:52:32,533: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057c1a20>]}
2018-02-13 15:52:32,552: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10587b860>]}
2018-02-13 15:52:32,650: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:52:32,798: 15:52:32 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.86s]
2018-02-13 15:52:33,051: 15:52:33 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.89s]
2018-02-13 15:52:33,453: 15:52:33 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.99s]
2018-02-13 15:52:33,454: 15:52:33 | 20 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:52:33,455: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:52:33,454: 15:52:33 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:52:33,462: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:52:33,470: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:52:33,473: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:52:33,455: 15:52:33 | 22 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:52:33,474: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:52:33,479: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:52:33,455: 15:52:33 | 23 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:52:33,479: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:52:33,487: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:52:33,488: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:52:33,488: Re-using an available connection from the pool.
2018-02-13 15:52:33,492: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:52:33,492: Re-using an available connection from the pool.
2018-02-13 15:52:33,493: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:52:33,504: Re-using an available connection from the pool.
2018-02-13 15:52:33,500: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:52:33,508: Re-using an available connection from the pool.
2018-02-13 15:52:34,158: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:52:34,159: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:52:34,205: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:52:35,242: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:52:38,506: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058150b8>]}
2018-02-13 15:52:38,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058de400>]}
2018-02-13 15:52:38,775: 15:52:38 | 20 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 5.05s]
2018-02-13 15:52:39,084: 15:52:39 | 22 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 5.07s]
2018-02-13 15:52:39,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058de0f0>]}
2018-02-13 15:52:40,169: 15:52:40 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 6.28s]
2018-02-13 15:52:42,687: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058de6a0>]}
2018-02-13 15:52:43,016: 15:52:43 | 23 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 9.21s]
2018-02-13 15:52:43,017: 15:52:43 | 24 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:52:43,018: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:52:43,017: 15:52:43 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:52:43,025: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:52:43,029: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:52:43,030: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:52:43,018: 15:52:43 | 26 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:52:43,018: 15:52:43 | 27 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:52:43,030: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:52:43,031: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:52:43,031: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:52:43,036: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:52:43,036: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:52:43,041: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:52:43,041: Re-using an available connection from the pool.
2018-02-13 15:52:43,042: Re-using an available connection from the pool.
2018-02-13 15:52:43,043: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:52:43,044: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:52:43,045: Re-using an available connection from the pool.
2018-02-13 15:52:43,049: Re-using an available connection from the pool.
2018-02-13 15:52:43,798: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:52:43,813: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:52:43,834: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:52:44,195: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:52:44,872: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:52:44,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:52:45,124: 15:52:45 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.85s]
2018-02-13 15:52:45,125: 15:52:45 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:52:45,127: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:52:45,137: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:52:45,140: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:52:45,140: Re-using an available connection from the pool.
2018-02-13 15:52:45,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105916b70>]}
2018-02-13 15:52:45,525: 15:52:45 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.93s]
2018-02-13 15:52:45,526: 15:52:45 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:52:45,527: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:52:45,537: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:52:45,540: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:52:45,540: Re-using an available connection from the pool.
2018-02-13 15:52:45,769: 15:52:45 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.48s]
2018-02-13 15:52:45,854: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:52:46,091: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058e7ba8>]}
2018-02-13 15:52:46,338: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:52:46,343: 15:52:46 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.07s]
2018-02-13 15:52:47,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:52:47,377: 15:52:47 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.91s]
2018-02-13 15:52:48,508: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:52:48,756: 15:52:48 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.98s]
2018-02-13 15:52:48,757: 15:52:48 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:52:48,757: 15:52:48 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:52:48,757: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:52:48,757: 15:52:48 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:52:48,758: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:52:48,764: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:52:48,765: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:52:48,770: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:52:48,775: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:52:48,776: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:52:48,776: Re-using an available connection from the pool.
2018-02-13 15:52:48,777: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:52:48,777: Re-using an available connection from the pool.
2018-02-13 15:52:48,778: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:52:48,778: Re-using an available connection from the pool.
2018-02-13 15:52:49,522: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:52:49,523: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:52:49,524: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:52:50,617: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057e6160>]}
2018-02-13 15:52:50,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105894400>]}
2018-02-13 15:52:50,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105916dd8>]}
2018-02-13 15:52:50,866: 15:52:50 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.86s]
2018-02-13 15:52:51,118: 15:52:51 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.86s]
2018-02-13 15:52:51,360: 15:52:51 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.87s]
2018-02-13 15:52:51,361: 15:52:51 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:52:51,361: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:52:51,373: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:52:51,374: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:52:51,374: Re-using an available connection from the pool.
2018-02-13 15:52:52,192: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:52:56,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:52:56,828: 15:52:56 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 5.23s]
2018-02-13 15:52:56,829: 15:52:56 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:52:56,829: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:52:56,837: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:52:56,837: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:52:56,838: Re-using an available connection from the pool.
2018-02-13 15:52:58,020: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:53:00,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:53:00,631: 15:53:00 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 3.39s]
2018-02-13 15:53:00,632: 15:53:00 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:53:00,632: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:53:00,638: 15:53:00 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:53:00,640: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:53:00,640: Compiling model.seo_audit.ga_proc
2018-02-13 15:53:00,645: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:53:00,646: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:53:00,647: Re-using an available connection from the pool.
2018-02-13 15:53:00,648: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:53:00,648: Re-using an available connection from the pool.
2018-02-13 15:53:01,247: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:53:01,386: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:53:03,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:53:03,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058fd0b8>]}
2018-02-13 15:53:04,173: 15:53:04 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.81s]
2018-02-13 15:53:04,406: 15:53:04 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.95s]
2018-02-13 15:53:04,407: 15:53:04 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:53:04,408: Compiling model.seo_audit.agg_indicative
2018-02-13 15:53:04,417: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:53:04,418: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:53:04,418: Re-using an available connection from the pool.
2018-02-13 15:53:05,195: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:53:07,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:53:07,615: 15:53:07 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.96s]
2018-02-13 15:53:07,615: 15:53:07 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:53:07,616: Compiling model.seo_audit.ga_stats
2018-02-13 15:53:07,622: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:53:07,622: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:53:07,623: Re-using an available connection from the pool.
2018-02-13 15:53:08,369: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:53:11,647: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:53:11,911: 15:53:11 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 4.03s]
2018-02-13 15:53:11,911: 15:53:11 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:53:11,912: Compiling model.seo_audit.agg_stats
2018-02-13 15:53:11,927: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:53:11,928: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:53:11,928: Re-using an available connection from the pool.
2018-02-13 15:53:12,694: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:53:14,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:53:15,606: 15:53:15 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.03s]
2018-02-13 15:53:15,607: 15:53:15 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:53:15,608: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:53:15,617: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:53:15,618: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:53:15,618: Re-using an available connection from the pool.
2018-02-13 15:53:16,355: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:53:18,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105837898>]}
2018-02-13 15:53:18,797: 15:53:18 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.94s]
2018-02-13 15:53:18,798: 15:53:18 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:53:18,798: Compiling model.seo_audit.agg_all
2018-02-13 15:53:18,808: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:53:18,809: Acquiring new bigquery connection "agg_all".
2018-02-13 15:53:18,809: Re-using an available connection from the pool.
2018-02-13 15:53:20,291: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:53:23,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058c3b00>]}
2018-02-13 15:53:23,864: 15:53:23 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.79s]
2018-02-13 15:53:23,865: 15:53:23 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 15:53:23,865: Compiling model.seo_audit.actions
2018-02-13 15:53:23,877: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 15:53:23,878: Acquiring new bigquery connection "actions".
2018-02-13 15:53:23,878: Re-using an available connection from the pool.
2018-02-13 15:53:24,331: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:53:24,331: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:53:24,331: 400 Syntax error: Unexpected keyword AS at [28:135]
2018-02-13 15:53:24,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13c058dd-e2cc-4faf-b5f1-5a04686db2cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058b97f0>]}
2018-02-13 15:53:24,619: 15:53:24 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.47s]
2018-02-13 15:53:24,655: 15:53:24 | 
2018-02-13 15:53:24,656: 15:53:24 | Finished running 42 table models in 73.50s.
2018-02-13 15:53:24,656: Connection 'master' was left open.
2018-02-13 15:53:24,656: 
2018-02-13 15:53:24,657: Completed with 1 errors:
2018-02-13 15:53:24,657: 
2018-02-13 15:53:24,657: Database Error in model actions (models/actions/actions.sql)
2018-02-13 15:53:24,657:   Syntax error: Unexpected keyword AS at [28:135]
2018-02-13 15:53:24,657:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 15:53:24,658: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 15:53:24,658: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057c1908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057c17b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1057c1780>]}
2018-02-13 15:53:24,897: Flushing usage events
2018-02-13 15:54:11,803: Tracking: tracking
2018-02-13 15:54:11,803: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11405eda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11405ee48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11405e9e8>]}
2018-02-13 15:54:12,513: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:54:12,527: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:54:12,529: Parsing core.sql
2018-02-13 15:54:12,541: Parsing adapters/bigquery.sql
2018-02-13 15:54:12,545: Parsing adapters/common.sql
2018-02-13 15:54:12,559: Parsing adapters/postgres.sql
2018-02-13 15:54:12,562: Parsing adapters/redshift.sql
2018-02-13 15:54:12,579: Parsing etc/get_custom_schema.sql
2018-02-13 15:54:12,585: Parsing materializations/archive.sql
2018-02-13 15:54:12,614: Parsing materializations/bigquery.sql
2018-02-13 15:54:12,627: Parsing materializations/helpers.sql
2018-02-13 15:54:12,642: Parsing materializations/incremental.sql
2018-02-13 15:54:12,668: Parsing materializations/table.sql
2018-02-13 15:54:12,685: Parsing materializations/view.sql
2018-02-13 15:54:12,705: Parsing materializations/wrapper.sql
2018-02-13 15:54:12,709: Parsing schema_tests/accepted_values.sql
2018-02-13 15:54:12,712: Parsing schema_tests/not_null.sql
2018-02-13 15:54:12,713: Parsing schema_tests/relationships.sql
2018-02-13 15:54:12,716: Parsing schema_tests/unique.sql
2018-02-13 15:54:12,724: Parsing model.seo_audit.actions
2018-02-13 15:54:12,728: Acquiring new bigquery connection "master".
2018-02-13 15:54:12,728: Opening a new connection (0 currently allocated)
2018-02-13 15:54:12,730: Parsing model.seo_audit.accounts_proc
2018-02-13 15:54:12,732: Parsing model.seo_audit.all_dates
2018-02-13 15:54:12,733: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:54:12,736: Parsing model.seo_audit.agg_all
2018-02-13 15:54:12,739: Parsing model.seo_audit.agg_indicative
2018-02-13 15:54:12,742: Parsing model.seo_audit.agg_stats
2018-02-13 15:54:12,746: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:54:12,749: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:54:12,751: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:54:12,753: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:54:12,754: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:54:12,756: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:54:12,758: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:54:12,760: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:54:12,764: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:54:12,773: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:54:12,775: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:54:12,777: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:54:12,778: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:54:12,780: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:54:12,782: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:54:12,784: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:54:12,787: Parsing model.seo_audit.ga_proc
2018-02-13 15:54:12,790: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:54:12,792: Parsing model.seo_audit.ga_stats
2018-02-13 15:54:12,795: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:54:12,796: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:54:12,799: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:54:12,801: Parsing model.seo_audit.moz_proc
2018-02-13 15:54:12,804: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:54:12,807: Parsing model.seo_audit.search_console_history
2018-02-13 15:54:12,809: Parsing model.seo_audit.search_console_proc
2018-02-13 15:54:12,811: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:54:12,814: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:54:12,815: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:54:12,818: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:54:12,821: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:54:12,823: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:54:12,826: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:54:12,827: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:54:12,830: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:54:12,842: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:54:12,854: 
2018-02-13 15:54:13,265: 15:54:13 | Concurrency: 4 threads (target='prod')
2018-02-13 15:54:13,265: 15:54:13 | 
2018-02-13 15:54:13,641: 15:54:13 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:54:13,642: Compiling model.seo_audit.all_dates
2018-02-13 15:54:13,641: 15:54:13 | 2 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:54:13,647: Compiling model.seo_audit.accounts_proc
2018-02-13 15:54:13,641: 15:54:13 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:54:13,648: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:54:13,654: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:54:13,654: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:54:13,662: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:54:13,663: Acquiring new bigquery connection "all_dates".
2018-02-13 15:54:13,663: Opening a new connection (1 currently allocated)
2018-02-13 15:54:13,664: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:54:13,666: Opening a new connection (2 currently allocated)
2018-02-13 15:54:13,667: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:54:13,717: Opening a new connection (3 currently allocated)
2018-02-13 15:54:14,786: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:54:14,797: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:54:14,905: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:54:16,970: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141eb7f0>]}
2018-02-13 15:54:17,008: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141eb1d0>]}
2018-02-13 15:54:17,096: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141eb518>]}
2018-02-13 15:54:17,239: 15:54:17 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.33s]
2018-02-13 15:54:17,481: 15:54:17 | 2 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.36s]
2018-02-13 15:54:17,724: 15:54:17 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.44s]
2018-02-13 15:54:17,724: 15:54:17 | 4 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:54:17,725: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:54:17,731: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:54:17,725: 15:54:17 | 5 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:54:17,731: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:54:17,725: 15:54:17 | 6 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:54:17,740: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:54:17,740: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:54:17,725: 15:54:17 | 7 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:54:17,749: Compiling model.seo_audit.search_console_proc
2018-02-13 15:54:17,741: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:54:17,749: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:54:17,765: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:54:17,765: Re-using an available connection from the pool.
2018-02-13 15:54:17,766: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:54:17,768: Re-using an available connection from the pool.
2018-02-13 15:54:17,769: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:54:17,774: Re-using an available connection from the pool.
2018-02-13 15:54:17,788: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:54:17,789: Opening a new connection (4 currently allocated)
2018-02-13 15:54:18,507: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:54:18,512: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:54:18,810: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:54:18,914: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:54:20,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141e1b38>]}
2018-02-13 15:54:20,927: 15:54:20 | 4 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.97s]
2018-02-13 15:54:20,928: 15:54:20 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:54:20,928: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:54:20,934: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:54:20,935: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:54:20,935: Re-using an available connection from the pool.
2018-02-13 15:54:21,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1142429e8>]}
2018-02-13 15:54:21,377: 15:54:21 | 6 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.40s]
2018-02-13 15:54:21,377: 15:54:21 | 9 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:54:21,377: Compiling model.seo_audit.moz_proc
2018-02-13 15:54:21,383: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:54:21,384: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:54:21,384: Re-using an available connection from the pool.
2018-02-13 15:54:21,738: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:54:21,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141ebeb8>]}
2018-02-13 15:54:22,062: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:54:22,088: 15:54:22 | 5 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.11s]
2018-02-13 15:54:22,089: 15:54:22 | 10 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:54:22,089: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:54:22,096: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:54:22,099: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:54:22,099: Re-using an available connection from the pool.
2018-02-13 15:54:22,813: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:54:23,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141e5160>]}
2018-02-13 15:54:24,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11424dcc0>]}
2018-02-13 15:54:24,527: 15:54:24 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.98s]
2018-02-13 15:54:24,528: 15:54:24 | 11 of 42 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-13 15:54:24,529: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:54:24,539: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:54:24,542: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:54:24,542: Re-using an available connection from the pool.
2018-02-13 15:54:24,830: 15:54:24 | 9 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.94s]
2018-02-13 15:54:25,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bf96d8>]}
2018-02-13 15:54:25,239: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:54:25,267: 15:54:25 | 10 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.92s]
2018-02-13 15:54:28,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141e5160>]}
2018-02-13 15:54:28,815: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114243be0>]}
2018-02-13 15:54:28,821: 15:54:28 | 11 of 42 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 4.06s]
2018-02-13 15:54:29,049: 15:54:29 | 7 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 11.07s]
2018-02-13 15:54:29,050: 15:54:29 | 12 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:54:29,051: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:54:29,051: 15:54:29 | 13 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:54:29,058: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:54:29,063: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:54:29,065: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:54:29,051: 15:54:29 | 14 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:54:29,066: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:54:29,051: 15:54:29 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:54:29,072: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:54:29,072: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:54:29,073: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:54:29,073: Compiling model.seo_audit.search_console_history
2018-02-13 15:54:29,075: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:54:29,075: Re-using an available connection from the pool.
2018-02-13 15:54:29,081: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:54:29,082: Re-using an available connection from the pool.
2018-02-13 15:54:29,090: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:54:29,098: Re-using an available connection from the pool.
2018-02-13 15:54:29,101: Re-using an available connection from the pool.
2018-02-13 15:54:29,874: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:54:29,876: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:54:29,878: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:54:29,882: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:54:30,970: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114157400>]}
2018-02-13 15:54:31,212: 15:54:31 | 14 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 1.90s]
2018-02-13 15:54:31,212: 15:54:31 | 16 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:54:31,213: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:54:31,220: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:54:31,221: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:54:31,222: Re-using an available connection from the pool.
2018-02-13 15:54:31,893: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:54:32,055: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114173cc0>]}
2018-02-13 15:54:32,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c81898>]}
2018-02-13 15:54:32,313: 15:54:32 | 12 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.00s]
2018-02-13 15:54:32,559: 15:54:32 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.99s]
2018-02-13 15:54:33,136: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59128>]}
2018-02-13 15:54:33,373: 15:54:33 | 13 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.08s]
2018-02-13 15:54:34,094: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114157400>]}
2018-02-13 15:54:34,377: 15:54:34 | 16 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.88s]
2018-02-13 15:54:34,377: 15:54:34 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:54:34,378: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:54:34,378: 15:54:34 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:54:34,388: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:54:34,378: 15:54:34 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:54:34,388: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:54:34,396: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:54:34,396: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:54:34,404: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:54:34,406: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:54:34,406: Re-using an available connection from the pool.
2018-02-13 15:54:34,412: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:54:34,413: Re-using an available connection from the pool.
2018-02-13 15:54:34,418: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:54:34,418: Re-using an available connection from the pool.
2018-02-13 15:54:35,148: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:54:35,191: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:54:35,217: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:54:36,254: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c57a58>]}
2018-02-13 15:54:36,548: 15:54:36 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 1.86s]
2018-02-13 15:54:37,387: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114237f98>]}
2018-02-13 15:54:37,415: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c66358>]}
2018-02-13 15:54:37,759: 15:54:37 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.01s]
2018-02-13 15:54:38,057: 15:54:38 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.03s]
2018-02-13 15:54:38,058: 15:54:38 | 20 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:54:38,059: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:54:38,058: 15:54:38 | 22 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:54:38,069: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:54:38,069: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:54:38,058: 15:54:38 | 23 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:54:38,078: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:54:38,058: 15:54:38 | 21 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:54:38,084: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:54:38,078: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:54:38,091: Re-using an available connection from the pool.
2018-02-13 15:54:38,099: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:54:38,102: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:54:38,103: Re-using an available connection from the pool.
2018-02-13 15:54:38,114: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:54:38,116: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:54:38,118: Re-using an available connection from the pool.
2018-02-13 15:54:38,134: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:54:38,135: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:54:38,135: Re-using an available connection from the pool.
2018-02-13 15:54:38,804: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:54:38,835: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:54:38,880: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:54:38,886: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:54:41,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114243a20>]}
2018-02-13 15:54:41,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114157400>]}
2018-02-13 15:54:41,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c66cc0>]}
2018-02-13 15:54:41,316: 15:54:41 | 22 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.95s]
2018-02-13 15:54:41,612: 15:54:41 | 20 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.99s]
2018-02-13 15:54:41,927: 15:54:41 | 23 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.97s]
2018-02-13 15:54:42,127: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c9bcf8>]}
2018-02-13 15:54:42,360: 15:54:42 | 21 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.04s]
2018-02-13 15:54:42,360: 15:54:42 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:54:42,361: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:54:42,369: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:54:42,367: 15:54:42 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:54:42,369: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:54:42,367: 15:54:42 | 26 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:54:42,367: 15:54:42 | 27 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:54:42,377: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:54:42,378: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:54:42,378: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:54:42,379: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:54:42,401: Re-using an available connection from the pool.
2018-02-13 15:54:42,387: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:54:42,406: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:54:42,410: Re-using an available connection from the pool.
2018-02-13 15:54:42,400: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:54:42,415: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:54:42,418: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:54:42,419: Re-using an available connection from the pool.
2018-02-13 15:54:42,420: Re-using an available connection from the pool.
2018-02-13 15:54:43,034: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:54:43,092: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:54:43,115: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:54:43,121: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:54:45,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c57be0>]}
2018-02-13 15:54:45,521: 15:54:45 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.91s]
2018-02-13 15:54:45,521: 15:54:45 | 28 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:54:45,522: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:54:45,532: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:54:45,532: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:54:45,533: Re-using an available connection from the pool.
2018-02-13 15:54:46,103: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141e1f28>]}
2018-02-13 15:54:46,343: 15:54:46 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.72s]
2018-02-13 15:54:46,343: 15:54:46 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:54:46,343: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:54:46,348: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:54:46,349: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:54:46,349: Re-using an available connection from the pool.
2018-02-13 15:54:46,658: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:54:46,728: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1142435f8>]}
2018-02-13 15:54:46,972: 15:54:46 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 4.36s]
2018-02-13 15:54:47,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114243cc0>]}
2018-02-13 15:54:47,521: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:54:47,722: 15:54:47 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 5.12s]
2018-02-13 15:54:47,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c57be0>]}
2018-02-13 15:54:47,977: 15:54:47 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.24s]
2018-02-13 15:54:48,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59128>]}
2018-02-13 15:54:48,894: 15:54:48 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.29s]
2018-02-13 15:54:48,895: 15:54:48 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:54:48,895: 15:54:48 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:54:48,896: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:54:48,895: 15:54:48 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:54:48,896: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:54:48,901: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:54:48,901: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:54:48,906: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:54:48,912: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:54:48,914: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:54:48,914: Re-using an available connection from the pool.
2018-02-13 15:54:48,915: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:54:48,916: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:54:48,916: Re-using an available connection from the pool.
2018-02-13 15:54:48,920: Re-using an available connection from the pool.
2018-02-13 15:54:49,586: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:54:49,611: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:54:49,632: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:54:50,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141450f0>]}
2018-02-13 15:54:50,705: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114232f28>]}
2018-02-13 15:54:50,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114252a58>]}
2018-02-13 15:54:50,965: 15:54:50 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.80s]
2018-02-13 15:54:51,214: 15:54:51 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.81s]
2018-02-13 15:54:51,479: 15:54:51 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.86s]
2018-02-13 15:54:51,480: 15:54:51 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:54:51,480: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:54:51,495: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:54:51,496: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:54:51,496: Re-using an available connection from the pool.
2018-02-13 15:54:52,615: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:54:55,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1142524a8>]}
2018-02-13 15:54:56,199: 15:54:56 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.43s]
2018-02-13 15:54:56,200: 15:54:56 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:54:56,200: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:54:56,205: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:54:56,206: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:54:56,206: Re-using an available connection from the pool.
2018-02-13 15:54:56,861: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:54:57,946: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114173cc0>]}
2018-02-13 15:54:58,185: 15:54:58 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.75s]
2018-02-13 15:54:58,186: 15:54:58 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:54:58,186: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:54:58,186: 15:54:58 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:54:58,198: Compiling model.seo_audit.ga_proc
2018-02-13 15:54:58,201: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:54:58,211: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:54:58,213: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:54:58,213: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:54:58,214: Re-using an available connection from the pool.
2018-02-13 15:54:58,214: Re-using an available connection from the pool.
2018-02-13 15:54:58,849: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:54:58,914: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:55:01,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59128>]}
2018-02-13 15:55:01,272: 15:55:01 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.84s]
2018-02-13 15:55:02,192: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11424d5c0>]}
2018-02-13 15:55:02,440: 15:55:02 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.99s]
2018-02-13 15:55:02,441: 15:55:02 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:55:02,442: Compiling model.seo_audit.agg_indicative
2018-02-13 15:55:02,451: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:55:02,451: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:55:02,451: Re-using an available connection from the pool.
2018-02-13 15:55:03,118: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:55:07,217: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114173cc0>]}
2018-02-13 15:55:07,936: 15:55:07 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 4.77s]
2018-02-13 15:55:07,937: 15:55:07 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:55:07,937: Compiling model.seo_audit.ga_stats
2018-02-13 15:55:07,947: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:55:07,948: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:55:07,948: Re-using an available connection from the pool.
2018-02-13 15:55:08,667: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:55:10,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114232748>]}
2018-02-13 15:55:11,110: 15:55:11 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.91s]
2018-02-13 15:55:11,110: 15:55:11 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:55:11,110: Compiling model.seo_audit.agg_stats
2018-02-13 15:55:11,119: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:55:11,120: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:55:11,120: Re-using an available connection from the pool.
2018-02-13 15:55:11,959: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:55:14,526: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114173cc0>]}
2018-02-13 15:55:14,807: 15:55:14 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.42s]
2018-02-13 15:55:14,807: 15:55:14 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:55:14,808: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:55:14,816: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:55:14,817: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:55:14,817: Re-using an available connection from the pool.
2018-02-13 15:55:15,553: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:55:17,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114232748>]}
2018-02-13 15:55:18,041: 15:55:18 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.96s]
2018-02-13 15:55:18,042: 15:55:18 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:55:18,042: Compiling model.seo_audit.agg_all
2018-02-13 15:55:18,051: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:55:18,052: Acquiring new bigquery connection "agg_all".
2018-02-13 15:55:18,052: Re-using an available connection from the pool.
2018-02-13 15:55:18,892: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:55:22,167: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114173cc0>]}
2018-02-13 15:55:22,789: 15:55:22 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.13s]
2018-02-13 15:55:22,790: 15:55:22 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 15:55:22,790: Compiling model.seo_audit.actions
2018-02-13 15:55:22,798: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 15:55:22,799: Acquiring new bigquery connection "actions".
2018-02-13 15:55:22,799: Re-using an available connection from the pool.
2018-02-13 15:55:23,236: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:55:23,236: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url
	a.date = c.date
	)
2018-02-13 15:55:23,236: 400 Syntax error: Parenthesized expression cannot be parsed as an expression, struct constructor, or subquery at [125:9]
2018-02-13 15:55:23,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '625d7cd7-d3ea-4bc9-977e-953c7ce2f78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114145320>]}
2018-02-13 15:55:23,553: 15:55:23 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.45s]
2018-02-13 15:55:23,623: 15:55:23 | 
2018-02-13 15:55:23,624: 15:55:23 | Finished running 42 table models in 70.36s.
2018-02-13 15:55:23,624: Connection 'master' was left open.
2018-02-13 15:55:23,625: 
2018-02-13 15:55:23,625: Completed with 1 errors:
2018-02-13 15:55:23,625: 
2018-02-13 15:55:23,625: Database Error in model actions (models/actions/actions.sql)
2018-02-13 15:55:23,625:   Syntax error: Parenthesized expression cannot be parsed as an expression, struct constructor, or subquery at [125:9]
2018-02-13 15:55:23,625:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 15:55:23,626: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 15:55:23,626: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11411ea20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11411e780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1141943c8>]}
2018-02-13 15:55:23,901: Flushing usage events
2018-02-13 15:56:37,980: Tracking: tracking
2018-02-13 15:56:37,986: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d6dda0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d6de48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d6d9e8>]}
2018-02-13 15:56:38,774: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:56:38,799: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:56:38,803: Parsing core.sql
2018-02-13 15:56:38,832: Parsing adapters/bigquery.sql
2018-02-13 15:56:38,842: Parsing adapters/common.sql
2018-02-13 15:56:38,866: Parsing adapters/postgres.sql
2018-02-13 15:56:38,872: Parsing adapters/redshift.sql
2018-02-13 15:56:38,902: Parsing etc/get_custom_schema.sql
2018-02-13 15:56:38,913: Parsing materializations/archive.sql
2018-02-13 15:56:38,960: Parsing materializations/bigquery.sql
2018-02-13 15:56:38,991: Parsing materializations/helpers.sql
2018-02-13 15:56:39,022: Parsing materializations/incremental.sql
2018-02-13 15:56:39,060: Parsing materializations/table.sql
2018-02-13 15:56:39,091: Parsing materializations/view.sql
2018-02-13 15:56:39,119: Parsing materializations/wrapper.sql
2018-02-13 15:56:39,128: Parsing schema_tests/accepted_values.sql
2018-02-13 15:56:39,139: Parsing schema_tests/not_null.sql
2018-02-13 15:56:39,143: Parsing schema_tests/relationships.sql
2018-02-13 15:56:39,150: Parsing schema_tests/unique.sql
2018-02-13 15:56:39,206: Parsing model.seo_audit.actions
2018-02-13 15:56:39,211: Acquiring new bigquery connection "master".
2018-02-13 15:56:39,212: Opening a new connection (0 currently allocated)
2018-02-13 15:56:39,216: Parsing model.seo_audit.accounts_proc
2018-02-13 15:56:39,219: Parsing model.seo_audit.all_dates
2018-02-13 15:56:39,220: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:56:39,227: Parsing model.seo_audit.agg_all
2018-02-13 15:56:39,233: Parsing model.seo_audit.agg_indicative
2018-02-13 15:56:39,237: Parsing model.seo_audit.agg_stats
2018-02-13 15:56:39,244: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:56:39,252: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:56:39,261: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:56:39,267: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:56:39,272: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:56:39,275: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:56:39,279: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:56:39,283: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:56:39,287: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:56:39,298: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:56:39,303: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:56:39,308: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:56:39,311: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:56:39,314: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:56:39,318: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:56:39,320: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:56:39,325: Parsing model.seo_audit.ga_proc
2018-02-13 15:56:39,342: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:56:39,350: Parsing model.seo_audit.ga_stats
2018-02-13 15:56:39,362: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:56:39,366: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:56:39,371: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:56:39,375: Parsing model.seo_audit.moz_proc
2018-02-13 15:56:39,378: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:56:39,384: Parsing model.seo_audit.search_console_history
2018-02-13 15:56:39,388: Parsing model.seo_audit.search_console_proc
2018-02-13 15:56:39,391: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:56:39,396: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:56:39,401: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:56:39,407: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:56:39,412: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:56:39,418: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:56:39,423: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:56:39,426: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:56:39,430: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:56:39,465: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:56:39,511: 
2018-02-13 15:56:41,183: 15:56:41 | Concurrency: 4 threads (target='prod')
2018-02-13 15:56:41,183: 15:56:41 | 
2018-02-13 15:56:41,661: 15:56:41 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:56:41,662: Compiling model.seo_audit.accounts_proc
2018-02-13 15:56:41,661: 15:56:41 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:56:41,661: 15:56:41 | 3 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:56:41,672: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:56:41,672: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:56:41,672: Compiling model.seo_audit.all_dates
2018-02-13 15:56:41,683: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:56:41,692: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:56:41,694: Opening a new connection (1 currently allocated)
2018-02-13 15:56:41,694: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:56:41,696: Acquiring new bigquery connection "all_dates".
2018-02-13 15:56:41,771: Opening a new connection (2 currently allocated)
2018-02-13 15:56:41,839: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:56:41,840: Opening a new connection (3 currently allocated)
2018-02-13 15:56:42,999: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:56:43,046: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:56:43,128: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:56:44,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113edf9e8>]}
2018-02-13 15:56:44,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ee87f0>]}
2018-02-13 15:56:44,331: 15:56:44 | 3 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.40s]
2018-02-13 15:56:44,657: 15:56:44 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.54s]
2018-02-13 15:56:45,278: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f56b00>]}
2018-02-13 15:56:45,599: 15:56:45 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.61s]
2018-02-13 15:56:45,599: 15:56:45 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:56:45,599: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:56:45,610: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:56:45,606: 15:56:45 | 5 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 15:56:45,611: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:56:45,607: 15:56:45 | 6 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 15:56:45,623: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:56:45,623: Compiling model.seo_audit.search_console_proc
2018-02-13 15:56:45,607: 15:56:45 | 7 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:56:45,660: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:56:45,689: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:56:45,689: Re-using an available connection from the pool.
2018-02-13 15:56:45,751: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:56:45,751: Re-using an available connection from the pool.
2018-02-13 15:56:45,757: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:56:45,761: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:56:45,761: Re-using an available connection from the pool.
2018-02-13 15:56:45,767: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:56:45,769: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:56:45,772: Opening a new connection (4 currently allocated)
2018-02-13 15:56:46,512: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:56:46,679: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:56:46,741: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 15:56:46,851: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:56:48,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113edfe48>]}
2018-02-13 15:56:48,933: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f0cf60>]}
2018-02-13 15:56:49,011: 15:56:49 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.17s]
2018-02-13 15:56:49,013: 15:56:49 | 8 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:56:49,015: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:56:49,026: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:56:49,028: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:56:49,028: Re-using an available connection from the pool.
2018-02-13 15:56:49,034: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f56f98>]}
2018-02-13 15:56:49,283: 15:56:49 | 5 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.32s]
2018-02-13 15:56:49,284: 15:56:49 | 9 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:56:49,285: Compiling model.seo_audit.moz_proc
2018-02-13 15:56:49,300: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:56:49,302: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:56:49,303: Re-using an available connection from the pool.
2018-02-13 15:56:49,569: 15:56:49 | 7 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.37s]
2018-02-13 15:56:49,569: 15:56:49 | 10 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 15:56:49,570: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:56:49,577: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:56:49,581: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:56:49,581: Re-using an available connection from the pool.
2018-02-13 15:56:49,803: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:56:49,977: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:56:50,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:56:50,513: 15:56:50 | 6 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.64s]
2018-02-13 15:56:50,513: 15:56:50 | 11 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 15:56:50,514: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:56:50,520: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:56:50,521: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:56:50,522: Re-using an available connection from the pool.
2018-02-13 15:56:50,538: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:56:51,242: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:56:51,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e65710>]}
2018-02-13 15:56:52,211: 15:56:52 | 8 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.95s]
2018-02-13 15:56:52,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f53cc0>]}
2018-02-13 15:56:52,504: 15:56:52 | 9 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.95s]
2018-02-13 15:56:52,731: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f56f98>]}
2018-02-13 15:56:52,990: 15:56:52 | 10 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 3.16s]
2018-02-13 15:56:53,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:56:53,758: 15:56:53 | 11 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.99s]
2018-02-13 15:56:53,759: 15:56:53 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 15:56:53,760: Compiling model.seo_audit.semrush_url_history
2018-02-13 15:56:53,760: 15:56:53 | 13 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 15:56:53,769: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 15:56:53,760: 15:56:53 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 15:56:53,770: Compiling model.seo_audit.search_console_history
2018-02-13 15:56:53,760: 15:56:53 | 15 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 15:56:53,770: Compiling model.seo_audit.majestic_domain_history
2018-02-13 15:56:53,776: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 15:56:53,776: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 15:56:53,780: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 15:56:53,781: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 15:56:53,789: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 15:56:53,789: Acquiring new bigquery connection "search_console_history".
2018-02-13 15:56:53,790: Re-using an available connection from the pool.
2018-02-13 15:56:53,793: Re-using an available connection from the pool.
2018-02-13 15:56:53,797: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 15:56:53,797: Re-using an available connection from the pool.
2018-02-13 15:56:53,806: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 15:56:53,811: Re-using an available connection from the pool.
2018-02-13 15:56:54,468: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 15:56:54,481: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 15:56:54,561: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 15:56:54,610: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 15:56:56,650: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e65320>]}
2018-02-13 15:56:56,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f56b00>]}
2018-02-13 15:56:56,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e2be0>]}
2018-02-13 15:56:56,887: 15:56:56 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.88s]
2018-02-13 15:56:56,890: 15:56:56 | 16 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 15:56:56,891: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 15:56:56,899: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 15:56:56,901: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 15:56:56,901: Re-using an available connection from the pool.
2018-02-13 15:56:57,147: 15:56:57 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.96s]
2018-02-13 15:56:57,394: 15:56:57 | 15 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.99s]
2018-02-13 15:56:57,524: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 15:56:58,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11090fb00>]}
2018-02-13 15:56:59,112: 15:56:59 | 13 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 5.09s]
2018-02-13 15:56:59,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110923b70>]}
2018-02-13 15:57:00,028: 15:57:00 | 16 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.85s]
2018-02-13 15:57:00,028: 15:57:00 | 17 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 15:57:00,029: Compiling model.seo_audit.deepcrawl_class
2018-02-13 15:57:00,041: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 15:57:00,041: 15:57:00 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 15:57:00,042: Compiling model.seo_audit.search_console_stats_url
2018-02-13 15:57:00,056: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 15:57:00,060: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 15:57:00,061: Re-using an available connection from the pool.
2018-02-13 15:57:00,066: 15:57:00 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 15:57:00,066: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 15:57:00,091: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 15:57:00,092: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 15:57:00,095: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 15:57:00,095: Re-using an available connection from the pool.
2018-02-13 15:57:00,100: Re-using an available connection from the pool.
2018-02-13 15:57:00,881: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 15:57:00,902: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 15:57:00,916: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 15:57:03,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11090f208>]}
2018-02-13 15:57:03,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108ea0f0>]}
2018-02-13 15:57:03,076: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:03,361: 15:57:03 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.98s]
2018-02-13 15:57:03,678: 15:57:03 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.02s]
2018-02-13 15:57:03,952: 15:57:03 | 17 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 3.05s]
2018-02-13 15:57:03,952: 15:57:03 | 20 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 15:57:03,953: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 15:57:03,952: 15:57:03 | 21 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 15:57:03,963: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:57:03,963: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 15:57:03,953: 15:57:03 | 22 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 15:57:03,972: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 15:57:03,953: 15:57:03 | 23 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 15:57:03,973: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 15:57:03,974: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 15:57:03,986: Re-using an available connection from the pool.
2018-02-13 15:57:03,975: Compiling model.seo_audit.semrush_url_stats
2018-02-13 15:57:03,986: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 15:57:04,016: Re-using an available connection from the pool.
2018-02-13 15:57:03,985: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 15:57:04,026: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 15:57:04,035: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 15:57:04,035: Re-using an available connection from the pool.
2018-02-13 15:57:04,033: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 15:57:04,040: Re-using an available connection from the pool.
2018-02-13 15:57:04,641: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 15:57:04,676: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:57:04,702: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 15:57:04,797: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 15:57:06,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f87390>]}
2018-02-13 15:57:06,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f0cda0>]}
2018-02-13 15:57:06,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108eaa90>]}
2018-02-13 15:57:07,139: 15:57:07 | 21 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.93s]
2018-02-13 15:57:07,389: 15:57:07 | 20 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.95s]
2018-02-13 15:57:07,622: 15:57:07 | 22 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.97s]
2018-02-13 15:57:07,730: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e2080>]}
2018-02-13 15:57:07,956: 15:57:07 | 23 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.75s]
2018-02-13 15:57:07,957: 15:57:07 | 24 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 15:57:07,958: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:57:07,957: 15:57:07 | 25 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 15:57:07,968: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 15:57:07,958: 15:57:07 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 15:57:07,969: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:57:07,958: 15:57:07 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 15:57:07,969: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:57:07,983: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 15:57:07,993: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 15:57:07,993: Re-using an available connection from the pool.
2018-02-13 15:57:07,983: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:57:07,984: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 15:57:08,013: Re-using an available connection from the pool.
2018-02-13 15:57:08,021: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 15:57:08,030: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 15:57:08,032: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 15:57:08,032: Re-using an available connection from the pool.
2018-02-13 15:57:08,035: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 15:57:08,040: Re-using an available connection from the pool.
2018-02-13 15:57:08,625: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:57:08,688: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 15:57:08,759: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 15:57:09,117: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:57:09,706: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:09,771: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e655f8>]}
2018-02-13 15:57:09,948: 15:57:09 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.75s]
2018-02-13 15:57:09,949: 15:57:09 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 15:57:09,949: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:57:09,954: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 15:57:09,956: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 15:57:09,956: Re-using an available connection from the pool.
2018-02-13 15:57:10,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f0cda0>]}
2018-02-13 15:57:10,210: 15:57:10 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.79s]
2018-02-13 15:57:10,211: 15:57:10 | 29 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 15:57:10,214: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:57:10,220: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 15:57:10,223: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 15:57:10,223: Re-using an available connection from the pool.
2018-02-13 15:57:10,475: 15:57:10 | 25 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.24s]
2018-02-13 15:57:10,842: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 15:57:11,370: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 15:57:11,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e65748>]}
2018-02-13 15:57:11,820: 15:57:11 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.60s]
2018-02-13 15:57:11,972: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e41080>]}
2018-02-13 15:57:12,240: 15:57:12 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.76s]
2018-02-13 15:57:13,561: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:13,818: 15:57:13 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.61s]
2018-02-13 15:57:13,819: 15:57:13 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 15:57:13,819: 15:57:13 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 15:57:13,819: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:57:13,820: 15:57:13 | 32 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 15:57:13,820: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:57:13,826: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 15:57:13,827: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:57:13,831: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 15:57:13,836: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 15:57:13,837: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 15:57:13,837: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 15:57:13,838: Re-using an available connection from the pool.
2018-02-13 15:57:13,838: Re-using an available connection from the pool.
2018-02-13 15:57:13,839: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 15:57:13,840: Re-using an available connection from the pool.
2018-02-13 15:57:14,534: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 15:57:14,534: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 15:57:14,695: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 15:57:15,626: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f68208>]}
2018-02-13 15:57:15,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ee80f0>]}
2018-02-13 15:57:15,796: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f3c860>]}
2018-02-13 15:57:15,880: 15:57:15 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.81s]
2018-02-13 15:57:16,125: 15:57:16 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.81s]
2018-02-13 15:57:16,356: 15:57:16 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.97s]
2018-02-13 15:57:16,356: 15:57:16 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 15:57:16,357: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:57:16,373: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 15:57:16,375: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 15:57:16,375: Re-using an available connection from the pool.
2018-02-13 15:57:17,166: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 15:57:20,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:20,767: 15:57:20 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.15s]
2018-02-13 15:57:20,768: 15:57:20 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 15:57:20,768: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 15:57:20,780: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 15:57:20,781: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 15:57:20,781: Re-using an available connection from the pool.
2018-02-13 15:57:21,554: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 15:57:22,646: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e531d0>]}
2018-02-13 15:57:22,905: 15:57:22 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.88s]
2018-02-13 15:57:22,906: 15:57:22 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 15:57:22,906: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 15:57:22,906: 15:57:22 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 15:57:22,914: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 15:57:22,914: Compiling model.seo_audit.ga_proc
2018-02-13 15:57:22,920: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 15:57:22,923: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 15:57:22,924: Acquiring new bigquery connection "ga_proc".
2018-02-13 15:57:22,924: Re-using an available connection from the pool.
2018-02-13 15:57:22,924: Re-using an available connection from the pool.
2018-02-13 15:57:23,751: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:57:23,752: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 15:57:25,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108e2c50>]}
2018-02-13 15:57:26,534: 15:57:26 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.00s]
2018-02-13 15:57:27,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:27,264: 15:57:27 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 4.10s]
2018-02-13 15:57:27,265: 15:57:27 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 15:57:27,265: Compiling model.seo_audit.agg_indicative
2018-02-13 15:57:27,273: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 15:57:27,274: Acquiring new bigquery connection "agg_indicative".
2018-02-13 15:57:27,274: Re-using an available connection from the pool.
2018-02-13 15:57:28,049: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 15:57:30,214: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e531d0>]}
2018-02-13 15:57:30,452: 15:57:30 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.95s]
2018-02-13 15:57:30,453: 15:57:30 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 15:57:30,453: Compiling model.seo_audit.ga_stats
2018-02-13 15:57:30,461: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 15:57:30,462: Acquiring new bigquery connection "ga_stats".
2018-02-13 15:57:30,462: Re-using an available connection from the pool.
2018-02-13 15:57:31,225: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 15:57:33,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:33,839: 15:57:33 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.95s]
2018-02-13 15:57:33,839: 15:57:33 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 15:57:33,840: Compiling model.seo_audit.agg_stats
2018-02-13 15:57:33,849: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 15:57:33,849: Acquiring new bigquery connection "agg_stats".
2018-02-13 15:57:33,850: Re-using an available connection from the pool.
2018-02-13 15:57:34,646: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 15:57:36,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e531d0>]}
2018-02-13 15:57:37,087: 15:57:37 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.01s]
2018-02-13 15:57:37,088: 15:57:37 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 15:57:37,088: Compiling model.seo_audit.agg_stats_client
2018-02-13 15:57:37,096: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 15:57:37,097: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 15:57:37,097: Re-using an available connection from the pool.
2018-02-13 15:57:37,872: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 15:57:40,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2fbe0>]}
2018-02-13 15:57:40,322: 15:57:40 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.96s]
2018-02-13 15:57:40,323: 15:57:40 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 15:57:40,323: Compiling model.seo_audit.agg_all
2018-02-13 15:57:40,334: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 15:57:40,335: Acquiring new bigquery connection "agg_all".
2018-02-13 15:57:40,336: Re-using an available connection from the pool.
2018-02-13 15:57:41,095: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 15:57:44,383: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e531d0>]}
2018-02-13 15:57:44,661: 15:57:44 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.06s]
2018-02-13 15:57:44,662: 15:57:44 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 15:57:44,663: Compiling model.seo_audit.actions
2018-02-13 15:57:44,677: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 15:57:44,679: Acquiring new bigquery connection "actions".
2018-02-13 15:57:44,679: Re-using an available connection from the pool.
2018-02-13 15:57:45,233: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-13 15:57:45,233: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when c.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', c.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	b.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-13 15:57:45,233: 400 Name canonical_url not found inside b at [125:11]
2018-02-13 15:57:45,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4c5d236-b9ba-4eff-8d58-a52591231393', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113edf780>]}
2018-02-13 15:57:45,495: 15:57:45 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.57s]
2018-02-13 15:57:45,533: 15:57:45 | 
2018-02-13 15:57:45,533: 15:57:45 | Finished running 42 table models in 64.35s.
2018-02-13 15:57:45,533: Connection 'master' was left open.
2018-02-13 15:57:45,534: 
2018-02-13 15:57:45,534: Completed with 1 errors:
2018-02-13 15:57:45,535: 
2018-02-13 15:57:45,535: Database Error in model actions (models/actions/actions.sql)
2018-02-13 15:57:45,535:   Name canonical_url not found inside b at [125:11]
2018-02-13 15:57:45,535:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 15:57:45,535: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 15:57:45,535: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2f9b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113e2f860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113d6dda0>]}
2018-02-13 15:57:45,787: Flushing usage events
2018-02-13 15:59:47,854: Tracking: tracking
2018-02-13 15:59:47,857: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10887eba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10887e860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10887e828>]}
2018-02-13 15:59:49,053: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 15:59:49,071: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 15:59:49,077: Parsing core.sql
2018-02-13 15:59:49,095: Parsing adapters/bigquery.sql
2018-02-13 15:59:49,103: Parsing adapters/common.sql
2018-02-13 15:59:49,121: Parsing adapters/postgres.sql
2018-02-13 15:59:49,127: Parsing adapters/redshift.sql
2018-02-13 15:59:49,151: Parsing etc/get_custom_schema.sql
2018-02-13 15:59:49,160: Parsing materializations/archive.sql
2018-02-13 15:59:49,193: Parsing materializations/bigquery.sql
2018-02-13 15:59:49,209: Parsing materializations/helpers.sql
2018-02-13 15:59:49,229: Parsing materializations/incremental.sql
2018-02-13 15:59:49,282: Parsing materializations/table.sql
2018-02-13 15:59:49,315: Parsing materializations/view.sql
2018-02-13 15:59:49,340: Parsing materializations/wrapper.sql
2018-02-13 15:59:49,347: Parsing schema_tests/accepted_values.sql
2018-02-13 15:59:49,359: Parsing schema_tests/not_null.sql
2018-02-13 15:59:49,364: Parsing schema_tests/relationships.sql
2018-02-13 15:59:49,373: Parsing schema_tests/unique.sql
2018-02-13 15:59:49,422: Parsing model.seo_audit.actions
2018-02-13 15:59:49,429: Acquiring new bigquery connection "master".
2018-02-13 15:59:49,429: Opening a new connection (0 currently allocated)
2018-02-13 15:59:49,436: Parsing model.seo_audit.accounts_proc
2018-02-13 15:59:49,439: Parsing model.seo_audit.all_dates
2018-02-13 15:59:49,440: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 15:59:49,445: Parsing model.seo_audit.agg_all
2018-02-13 15:59:49,453: Parsing model.seo_audit.agg_indicative
2018-02-13 15:59:49,457: Parsing model.seo_audit.agg_stats
2018-02-13 15:59:49,468: Parsing model.seo_audit.agg_stats_client
2018-02-13 15:59:49,472: Parsing model.seo_audit.deepcrawl_class
2018-02-13 15:59:49,475: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 15:59:49,477: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 15:59:49,482: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 15:59:49,486: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 15:59:49,491: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 15:59:49,495: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 15:59:49,500: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 15:59:49,510: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 15:59:49,514: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 15:59:49,517: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 15:59:49,520: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 15:59:49,524: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 15:59:49,528: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 15:59:49,532: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 15:59:49,539: Parsing model.seo_audit.ga_proc
2018-02-13 15:59:49,543: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 15:59:49,548: Parsing model.seo_audit.ga_stats
2018-02-13 15:59:49,553: Parsing model.seo_audit.majestic_domain_history
2018-02-13 15:59:49,556: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 15:59:49,560: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 15:59:49,564: Parsing model.seo_audit.moz_proc
2018-02-13 15:59:49,567: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 15:59:49,572: Parsing model.seo_audit.search_console_history
2018-02-13 15:59:49,575: Parsing model.seo_audit.search_console_proc
2018-02-13 15:59:49,580: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 15:59:49,584: Parsing model.seo_audit.search_console_stats_url
2018-02-13 15:59:49,587: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 15:59:49,591: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 15:59:49,597: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 15:59:49,602: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 15:59:49,607: Parsing model.seo_audit.semrush_url_history
2018-02-13 15:59:49,609: Parsing model.seo_audit.semrush_url_stats
2018-02-13 15:59:49,613: Parsing model.seo_audit.sitemap_proc
2018-02-13 15:59:49,635: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 15:59:49,651: 
2018-02-13 15:59:50,932: 15:59:50 | Concurrency: 4 threads (target='prod')
2018-02-13 15:59:50,932: 15:59:50 | 
2018-02-13 15:59:51,279: 15:59:51 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 15:59:51,279: 15:59:51 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 15:59:51,279: Compiling model.seo_audit.accounts_proc
2018-02-13 15:59:51,279: 15:59:51 | 3 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 15:59:51,279: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 15:59:51,284: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 15:59:51,285: Compiling model.seo_audit.all_dates
2018-02-13 15:59:51,289: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 15:59:51,294: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 15:59:51,297: Acquiring new bigquery connection "accounts_proc".
2018-02-13 15:59:51,297: Opening a new connection (1 currently allocated)
2018-02-13 15:59:51,298: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 15:59:51,300: Opening a new connection (2 currently allocated)
2018-02-13 15:59:51,350: Acquiring new bigquery connection "all_dates".
2018-02-13 15:59:51,358: Opening a new connection (3 currently allocated)
2018-02-13 15:59:52,453: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 15:59:52,500: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 15:59:52,558: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 15:59:54,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06c18>]}
2018-02-13 15:59:54,677: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06588>]}
2018-02-13 15:59:54,740: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06048>]}
2018-02-13 15:59:54,859: 15:59:54 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.34s]
2018-02-13 15:59:55,101: 15:59:55 | 3 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.39s]
2018-02-13 15:59:55,487: 15:59:55 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.46s]
2018-02-13 15:59:55,488: 15:59:55 | 4 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 15:59:55,489: Compiling model.seo_audit.moz_proc
2018-02-13 15:59:55,489: 15:59:55 | 5 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 15:59:55,495: Compiling model.seo_audit.sitemap_proc
2018-02-13 15:59:55,503: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 15:59:55,504: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 15:59:55,489: 15:59:55 | 6 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 15:59:55,489: 15:59:55 | 7 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 15:59:55,505: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 15:59:55,505: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 15:59:55,511: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 15:59:55,521: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 15:59:55,524: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 15:59:55,524: Re-using an available connection from the pool.
2018-02-13 15:59:55,530: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 15:59:55,530: Re-using an available connection from the pool.
2018-02-13 15:59:55,536: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 15:59:55,536: Re-using an available connection from the pool.
2018-02-13 15:59:55,550: Acquiring new bigquery connection "moz_proc".
2018-02-13 15:59:55,550: Opening a new connection (4 currently allocated)
2018-02-13 15:59:56,167: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 15:59:56,190: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:59:56,230: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 15:59:56,840: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 15:59:58,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06898>]}
2018-02-13 15:59:58,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 15:59:58,408: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a6acc0>]}
2018-02-13 15:59:58,572: 15:59:58 | 7 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.82s]
2018-02-13 15:59:58,574: 15:59:58 | 8 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 15:59:58,574: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 15:59:58,582: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 15:59:58,586: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 15:59:58,586: Re-using an available connection from the pool.
2018-02-13 15:59:58,831: 15:59:58 | 6 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.89s]
2018-02-13 15:59:58,835: 15:59:58 | 9 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 15:59:58,837: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 15:59:58,846: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 15:59:58,847: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 15:59:58,847: Re-using an available connection from the pool.
2018-02-13 15:59:59,145: 15:59:59 | 5 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.91s]
2018-02-13 15:59:59,145: 15:59:59 | 10 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 15:59:59,146: Compiling model.seo_audit.search_console_proc
2018-02-13 15:59:59,155: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 15:59:59,157: Acquiring new bigquery connection "search_console_proc".
2018-02-13 15:59:59,157: Re-using an available connection from the pool.
2018-02-13 15:59:59,209: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a60da0>]}
2018-02-13 15:59:59,266: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 15:59:59,474: 15:59:59 | 4 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.72s]
2018-02-13 15:59:59,474: 15:59:59 | 11 of 42 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-02-13 15:59:59,474: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 15:59:59,480: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 15:59:59,481: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 15:59:59,481: Re-using an available connection from the pool.
2018-02-13 15:59:59,587: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 15:59:59,911: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:00:00,231: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:00:01,451: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06898>]}
2018-02-13 16:00:01,773: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:01,785: 16:00:01 | 8 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.88s]
2018-02-13 16:00:02,131: 16:00:02 | 9 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.94s]
2018-02-13 16:00:02,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089a0710>]}
2018-02-13 16:00:02,833: 16:00:02 | 11 of 42 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 3.00s]
2018-02-13 16:00:03,187: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c05860>]}
2018-02-13 16:00:03,758: 16:00:03 | 10 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 4.04s]
2018-02-13 16:00:03,759: 16:00:03 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:00:03,759: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:00:03,759: 16:00:03 | 13 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:00:03,766: Compiling model.seo_audit.search_console_history
2018-02-13 16:00:03,759: 16:00:03 | 14 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:00:03,773: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:00:03,784: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:00:03,788: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:00:03,793: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:00:03,759: 16:00:03 | 15 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:00:03,794: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:00:03,804: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:00:03,813: Re-using an available connection from the pool.
2018-02-13 16:00:03,808: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:00:03,820: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:00:03,810: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:00:03,821: Re-using an available connection from the pool.
2018-02-13 16:00:03,822: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:00:03,824: Re-using an available connection from the pool.
2018-02-13 16:00:03,845: Re-using an available connection from the pool.
2018-02-13 16:00:04,621: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:00:04,663: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:00:04,714: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:00:04,830: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:00:06,920: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10895ecc0>]}
2018-02-13 16:00:07,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a6a4e0>]}
2018-02-13 16:00:07,187: 16:00:07 | 15 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.13s]
2018-02-13 16:00:07,188: 16:00:07 | 16 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:00:07,188: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:00:07,193: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:00:07,196: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:00:07,196: Re-using an available connection from the pool.
2018-02-13 16:00:07,547: 16:00:07 | 14 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.27s]
2018-02-13 16:00:08,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a4dc18>]}
2018-02-13 16:00:08,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10895e048>]}
2018-02-13 16:00:08,044: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:00:08,381: 16:00:08 | 13 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.27s]
2018-02-13 16:00:08,658: 16:00:08 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 4.27s]
2018-02-13 16:00:10,284: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c2a668>]}
2018-02-13 16:00:10,552: 16:00:10 | 16 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.10s]
2018-02-13 16:00:10,553: 16:00:10 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:00:10,553: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:00:10,553: 16:00:10 | 18 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:00:10,562: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:00:10,563: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:00:10,553: 16:00:10 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:00:10,572: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:00:10,573: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:00:10,579: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:00:10,579: Re-using an available connection from the pool.
2018-02-13 16:00:10,579: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:00:10,582: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:00:10,583: Re-using an available connection from the pool.
2018-02-13 16:00:10,585: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:00:10,587: Re-using an available connection from the pool.
2018-02-13 16:00:11,219: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:00:11,297: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:00:11,300: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:00:13,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:13,767: 16:00:13 | 18 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.91s]
2018-02-13 16:00:15,634: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a06898>]}
2018-02-13 16:00:15,702: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c32320>]}
2018-02-13 16:00:15,956: 16:00:15 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 5.08s]
2018-02-13 16:00:16,229: 16:00:16 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 5.13s]
2018-02-13 16:00:16,230: 16:00:16 | 20 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:00:16,231: 16:00:16 | 21 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:00:16,231: 16:00:16 | 22 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:00:16,231: 16:00:16 | 23 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:00:16,231: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:00:16,232: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:00:16,232: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:00:16,232: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:00:16,241: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:00:16,247: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:00:16,252: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:00:16,256: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:00:16,258: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:00:16,258: Re-using an available connection from the pool.
2018-02-13 16:00:16,259: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:00:16,260: Re-using an available connection from the pool.
2018-02-13 16:00:16,262: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:00:16,262: Re-using an available connection from the pool.
2018-02-13 16:00:16,266: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:00:16,267: Re-using an available connection from the pool.
2018-02-13 16:00:17,056: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:00:17,058: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:00:17,058: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:00:17,066: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:00:19,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10895ecc0>]}
2018-02-13 16:00:19,269: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a45eb8>]}
2018-02-13 16:00:19,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894bb38>]}
2018-02-13 16:00:19,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:19,529: 16:00:19 | 20 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.03s]
2018-02-13 16:00:19,768: 16:00:19 | 23 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.04s]
2018-02-13 16:00:20,007: 16:00:20 | 22 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.07s]
2018-02-13 16:00:20,242: 16:00:20 | 21 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.07s]
2018-02-13 16:00:20,243: 16:00:20 | 24 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:00:20,244: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:00:20,243: 16:00:20 | 25 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:00:20,251: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:00:20,243: 16:00:20 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:00:20,244: 16:00:20 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:00:20,258: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:00:20,258: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:00:20,263: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:00:20,263: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:00:20,272: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:00:20,281: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:00:20,284: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:00:20,288: Re-using an available connection from the pool.
2018-02-13 16:00:20,285: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:00:20,289: Re-using an available connection from the pool.
2018-02-13 16:00:20,288: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:00:20,286: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:00:20,295: Re-using an available connection from the pool.
2018-02-13 16:00:20,300: Re-using an available connection from the pool.
2018-02-13 16:00:20,919: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:00:20,938: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:00:20,955: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:00:20,958: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:00:22,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a60d68>]}
2018-02-13 16:00:22,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:22,283: 16:00:22 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.76s]
2018-02-13 16:00:22,284: 16:00:22 | 28 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:00:22,285: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:00:22,293: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:00:22,296: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:00:22,296: Re-using an available connection from the pool.
2018-02-13 16:00:22,545: 16:00:22 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.79s]
2018-02-13 16:00:22,545: 16:00:22 | 29 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:00:22,545: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:00:22,550: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:00:22,550: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:00:22,551: Re-using an available connection from the pool.
2018-02-13 16:00:22,925: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:00:23,114: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c32710>]}
2018-02-13 16:00:23,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a70b00>]}
2018-02-13 16:00:23,365: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:00:23,378: 16:00:23 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.85s]
2018-02-13 16:00:23,621: 16:00:23 | 25 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.96s]
2018-02-13 16:00:24,048: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a60d68>]}
2018-02-13 16:00:24,303: 16:00:24 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.76s]
2018-02-13 16:00:24,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:24,686: 16:00:24 | 29 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.90s]
2018-02-13 16:00:24,686: 16:00:24 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:00:24,687: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:00:24,687: 16:00:24 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:00:24,693: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:00:24,687: 16:00:24 | 32 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:00:24,693: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:00:24,694: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:00:24,698: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:00:24,703: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:00:24,704: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:00:24,706: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:00:24,706: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:00:24,707: Re-using an available connection from the pool.
2018-02-13 16:00:24,707: Re-using an available connection from the pool.
2018-02-13 16:00:24,707: Re-using an available connection from the pool.
2018-02-13 16:00:25,412: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:00:25,423: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:00:25,541: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:00:26,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a60438>]}
2018-02-13 16:00:26,571: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108970048>]}
2018-02-13 16:00:26,646: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:26,772: 16:00:26 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.84s]
2018-02-13 16:00:27,012: 16:00:27 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.88s]
2018-02-13 16:00:27,388: 16:00:27 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.96s]
2018-02-13 16:00:27,389: 16:00:27 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:00:27,389: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:00:27,401: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:00:27,402: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:00:27,402: Re-using an available connection from the pool.
2018-02-13 16:00:28,335: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:00:31,679: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:31,956: 16:00:31 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.29s]
2018-02-13 16:00:31,957: 16:00:31 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:00:31,957: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:00:31,965: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:00:31,966: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:00:31,966: Re-using an available connection from the pool.
2018-02-13 16:00:32,705: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:00:33,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:34,056: 16:00:34 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.86s]
2018-02-13 16:00:34,057: 16:00:34 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:00:34,057: 16:00:34 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:00:34,057: Compiling model.seo_audit.ga_proc
2018-02-13 16:00:34,057: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:00:34,075: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:00:34,077: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:00:34,079: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:00:34,079: Re-using an available connection from the pool.
2018-02-13 16:00:34,080: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:00:34,080: Re-using an available connection from the pool.
2018-02-13 16:00:34,755: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:00:34,755: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:00:37,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a60710>]}
2018-02-13 16:00:37,311: 16:00:37 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.97s]
2018-02-13 16:00:38,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:38,393: 16:00:38 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 4.05s]
2018-02-13 16:00:38,394: 16:00:38 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:00:38,395: Compiling model.seo_audit.agg_indicative
2018-02-13 16:00:38,403: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:00:38,404: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:00:38,404: Re-using an available connection from the pool.
2018-02-13 16:00:39,236: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:00:41,429: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:42,245: 16:00:42 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.03s]
2018-02-13 16:00:42,246: 16:00:42 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:00:42,246: Compiling model.seo_audit.ga_stats
2018-02-13 16:00:42,257: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:00:42,258: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:00:42,258: Re-using an available connection from the pool.
2018-02-13 16:00:43,227: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:00:45,447: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:45,776: 16:00:45 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.20s]
2018-02-13 16:00:45,777: 16:00:45 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:00:45,777: Compiling model.seo_audit.agg_stats
2018-02-13 16:00:45,788: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:00:45,790: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:00:45,790: Re-using an available connection from the pool.
2018-02-13 16:00:46,822: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:00:49,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:49,255: 16:00:49 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.23s]
2018-02-13 16:00:49,257: 16:00:49 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:00:49,257: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:00:49,266: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:00:49,268: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:00:49,268: Re-using an available connection from the pool.
2018-02-13 16:00:49,906: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:00:53,204: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053a16d8>]}
2018-02-13 16:00:53,460: 16:00:53 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 3.95s]
2018-02-13 16:00:53,461: 16:00:53 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:00:53,461: Compiling model.seo_audit.agg_all
2018-02-13 16:00:53,471: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:00:53,472: Acquiring new bigquery connection "agg_all".
2018-02-13 16:00:53,472: Re-using an available connection from the pool.
2018-02-13 16:00:54,185: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:00:57,460: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089bc320>]}
2018-02-13 16:00:57,698: 16:00:57 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.00s]
2018-02-13 16:00:57,699: 16:00:57 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:00:57,699: Compiling model.seo_audit.actions
2018-02-13 16:00:57,705: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:00:57,706: Acquiring new bigquery connection "actions".
2018-02-13 16:00:57,706: Re-using an available connection from the pool.
2018-02-13 16:00:58,194: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:00:58,195: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:00:58,195: 400 Column name url is ambiguous at [16:11]
2018-02-13 16:00:58,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '171575e1-8a31-4ea4-907f-17775a4656ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a27780>]}
2018-02-13 16:00:58,438: 16:00:58 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.50s]
2018-02-13 16:00:58,468: 16:00:58 | 
2018-02-13 16:00:58,468: 16:00:58 | Finished running 42 table models in 67.54s.
2018-02-13 16:00:58,468: Connection 'master' was left open.
2018-02-13 16:00:58,469: 
2018-02-13 16:00:58,469: Completed with 1 errors:
2018-02-13 16:00:58,469: 
2018-02-13 16:00:58,469: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:00:58,469:   Column name url is ambiguous at [16:11]
2018-02-13 16:00:58,469:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:00:58,470: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:00:58,470: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894b7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108970e48>]}
2018-02-13 16:00:58,754: Flushing usage events
2018-02-13 16:02:35,262: Tracking: tracking
2018-02-13 16:02:35,263: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d21da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d21e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d219e8>]}
2018-02-13 16:02:36,029: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:02:36,060: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:02:36,065: Parsing core.sql
2018-02-13 16:02:36,098: Parsing adapters/bigquery.sql
2018-02-13 16:02:36,108: Parsing adapters/common.sql
2018-02-13 16:02:36,135: Parsing adapters/postgres.sql
2018-02-13 16:02:36,144: Parsing adapters/redshift.sql
2018-02-13 16:02:36,187: Parsing etc/get_custom_schema.sql
2018-02-13 16:02:36,196: Parsing materializations/archive.sql
2018-02-13 16:02:36,264: Parsing materializations/bigquery.sql
2018-02-13 16:02:36,288: Parsing materializations/helpers.sql
2018-02-13 16:02:36,327: Parsing materializations/incremental.sql
2018-02-13 16:02:36,399: Parsing materializations/table.sql
2018-02-13 16:02:36,577: Parsing materializations/view.sql
2018-02-13 16:02:36,660: Parsing materializations/wrapper.sql
2018-02-13 16:02:36,668: Parsing schema_tests/accepted_values.sql
2018-02-13 16:02:36,693: Parsing schema_tests/not_null.sql
2018-02-13 16:02:36,702: Parsing schema_tests/relationships.sql
2018-02-13 16:02:36,709: Parsing schema_tests/unique.sql
2018-02-13 16:02:36,775: Parsing model.seo_audit.actions
2018-02-13 16:02:36,783: Acquiring new bigquery connection "master".
2018-02-13 16:02:36,783: Opening a new connection (0 currently allocated)
2018-02-13 16:02:36,785: Parsing model.seo_audit.accounts_proc
2018-02-13 16:02:36,790: Parsing model.seo_audit.all_dates
2018-02-13 16:02:36,792: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:02:36,807: Parsing model.seo_audit.agg_all
2018-02-13 16:02:36,812: Parsing model.seo_audit.agg_indicative
2018-02-13 16:02:36,820: Parsing model.seo_audit.agg_stats
2018-02-13 16:02:36,832: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:02:36,842: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:02:36,846: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:02:36,848: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:02:36,851: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:02:36,854: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:02:36,858: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:02:36,861: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:02:36,865: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:02:36,874: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:02:36,876: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:02:36,879: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:02:36,884: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:02:36,890: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:02:36,893: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:02:36,895: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:02:36,902: Parsing model.seo_audit.ga_proc
2018-02-13 16:02:36,911: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:02:36,916: Parsing model.seo_audit.ga_stats
2018-02-13 16:02:36,922: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:02:36,924: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:02:36,927: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:02:36,930: Parsing model.seo_audit.moz_proc
2018-02-13 16:02:36,940: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:02:36,944: Parsing model.seo_audit.search_console_history
2018-02-13 16:02:36,955: Parsing model.seo_audit.search_console_proc
2018-02-13 16:02:37,024: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:02:37,054: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:02:37,058: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:02:37,065: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:02:37,071: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:02:37,075: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:02:37,079: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:02:37,084: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:02:37,089: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:02:37,116: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:02:37,169: 
2018-02-13 16:02:38,653: 16:02:38 | Concurrency: 4 threads (target='prod')
2018-02-13 16:02:38,653: 16:02:38 | 
2018-02-13 16:02:39,053: 16:02:39 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:02:39,053: Compiling model.seo_audit.all_dates
2018-02-13 16:02:39,053: 16:02:39 | 2 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:02:39,057: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:02:39,053: 16:02:39 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:02:39,057: Compiling model.seo_audit.accounts_proc
2018-02-13 16:02:39,058: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:02:39,063: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:02:39,063: Acquiring new bigquery connection "all_dates".
2018-02-13 16:02:39,070: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:02:39,071: Opening a new connection (1 currently allocated)
2018-02-13 16:02:39,072: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:02:39,075: Opening a new connection (2 currently allocated)
2018-02-13 16:02:39,077: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:02:39,079: Opening a new connection (3 currently allocated)
2018-02-13 16:02:40,215: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:02:40,243: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:02:40,263: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:02:41,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e97908>]}
2018-02-13 16:02:41,661: 16:02:41 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.35s]
2018-02-13 16:02:42,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ef4ef0>]}
2018-02-13 16:02:42,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e92e80>]}
2018-02-13 16:02:42,765: 16:02:42 | 2 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.42s]
2018-02-13 16:02:43,182: 16:02:43 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.43s]
2018-02-13 16:02:43,183: 16:02:43 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:02:43,184: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:02:43,183: 16:02:43 | 5 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:02:43,190: Compiling model.seo_audit.moz_proc
2018-02-13 16:02:43,192: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:02:43,183: 16:02:43 | 6 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 16:02:43,199: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:02:43,184: 16:02:43 | 7 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:02:43,199: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:02:43,200: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:02:43,214: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:02:43,222: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:02:43,223: Re-using an available connection from the pool.
2018-02-13 16:02:43,225: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:02:43,226: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:02:43,229: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:02:43,229: Re-using an available connection from the pool.
2018-02-13 16:02:43,231: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:02:43,235: Re-using an available connection from the pool.
2018-02-13 16:02:43,238: Opening a new connection (4 currently allocated)
2018-02-13 16:02:43,939: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:02:44,041: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:02:44,042: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:02:44,369: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:02:46,135: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e662e8>]}
2018-02-13 16:02:46,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e080f0>]}
2018-02-13 16:02:46,228: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e979b0>]}
2018-02-13 16:02:46,752: 16:02:46 | 5 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.95s]
2018-02-13 16:02:46,754: 16:02:46 | 8 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:02:46,756: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:02:46,767: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:02:46,769: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:02:46,769: Re-using an available connection from the pool.
2018-02-13 16:02:47,315: 16:02:47 | 7 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.03s]
2018-02-13 16:02:47,316: 16:02:47 | 9 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 16:02:47,317: Compiling model.seo_audit.search_console_proc
2018-02-13 16:02:47,327: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:02:47,329: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:02:47,329: Re-using an available connection from the pool.
2018-02-13 16:02:47,601: 16:02:47 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.04s]
2018-02-13 16:02:47,602: 16:02:47 | 10 of 42 START table model seo_audit.majestic_domain_proc............ [RUN]
2018-02-13 16:02:47,602: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:02:47,611: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:02:47,615: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:02:47,615: Re-using an available connection from the pool.
2018-02-13 16:02:47,718: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:02:48,094: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:02:48,416: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:02:48,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e92630>]}
2018-02-13 16:02:49,293: 16:02:49 | 6 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 5.74s]
2018-02-13 16:02:49,294: 16:02:49 | 11 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 16:02:49,294: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:02:49,306: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:02:49,307: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:02:49,307: Re-using an available connection from the pool.
2018-02-13 16:02:50,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e662e8>]}
2018-02-13 16:02:50,263: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:02:50,551: 16:02:50 | 8 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.34s]
2018-02-13 16:02:51,381: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e92630>]}
2018-02-13 16:02:51,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e080f0>]}
2018-02-13 16:02:51,704: 16:02:51 | 11 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.09s]
2018-02-13 16:02:51,948: 16:02:51 | 9 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.17s]
2018-02-13 16:02:55,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f32470>]}
2018-02-13 16:02:55,558: 16:02:55 | 10 of 42 OK created table model seo_audit.majestic_domain_proc....... [CREATE TABLE in 7.67s]
2018-02-13 16:02:55,559: 16:02:55 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:02:55,559: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:02:55,559: 16:02:55 | 13 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:02:55,566: Compiling model.seo_audit.search_console_history
2018-02-13 16:02:55,572: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:02:55,566: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:02:55,559: 16:02:55 | 14 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:02:55,559: 16:02:55 | 15 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:02:55,573: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:02:55,574: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:02:55,574: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:02:55,575: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:02:55,584: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:02:55,584: Re-using an available connection from the pool.
2018-02-13 16:02:55,597: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:02:55,598: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:02:55,599: Re-using an available connection from the pool.
2018-02-13 16:02:55,605: Re-using an available connection from the pool.
2018-02-13 16:02:55,613: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:02:55,614: Re-using an available connection from the pool.
2018-02-13 16:02:56,188: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:02:56,298: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:02:56,323: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:02:56,377: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:02:58,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f17d30>]}
2018-02-13 16:02:58,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e377b8>]}
2018-02-13 16:02:58,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10190e048>]}
2018-02-13 16:02:58,638: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10191ce10>]}
2018-02-13 16:02:59,109: 16:02:59 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.82s]
2018-02-13 16:02:59,110: 16:02:59 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:02:59,110: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:02:59,118: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:02:59,122: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:02:59,123: Re-using an available connection from the pool.
2018-02-13 16:02:59,487: 16:02:59 | 15 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.99s]
2018-02-13 16:02:59,767: 16:02:59 | 13 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.00s]
2018-02-13 16:02:59,883: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:03:00,039: 16:03:00 | 14 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.06s]
2018-02-13 16:03:03,182: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:03,435: 16:03:03 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 4.07s]
2018-02-13 16:03:03,436: 16:03:03 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:03:03,437: 16:03:03 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:03:03,437: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:03:03,437: 16:03:03 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:03:03,437: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:03:03,449: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:03:03,449: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:03:03,463: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:03:03,464: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:03:03,465: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:03:03,465: Re-using an available connection from the pool.
2018-02-13 16:03:03,467: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:03:03,467: Re-using an available connection from the pool.
2018-02-13 16:03:03,471: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:03:03,473: Re-using an available connection from the pool.
2018-02-13 16:03:04,420: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:03:04,422: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:03:04,603: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:03:06,729: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e94ef0>]}
2018-02-13 16:03:06,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b7b8>]}
2018-02-13 16:03:07,009: 16:03:07 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.29s]
2018-02-13 16:03:07,434: 16:03:07 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 3.44s]
2018-02-13 16:03:07,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b630>]}
2018-02-13 16:03:08,095: 16:03:08 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 4.37s]
2018-02-13 16:03:08,096: 16:03:08 | 20 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:03:08,097: 16:03:08 | 21 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:03:08,097: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:03:08,097: 16:03:08 | 22 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:03:08,097: 16:03:08 | 23 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:03:08,098: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:03:08,105: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:03:08,105: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:03:08,105: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:03:08,110: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:03:08,115: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:03:08,120: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:03:08,121: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:03:08,122: Re-using an available connection from the pool.
2018-02-13 16:03:08,123: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:03:08,124: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:03:08,125: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:03:08,125: Re-using an available connection from the pool.
2018-02-13 16:03:08,131: Re-using an available connection from the pool.
2018-02-13 16:03:08,132: Re-using an available connection from the pool.
2018-02-13 16:03:08,716: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:03:08,850: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:03:08,894: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:03:08,925: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:03:11,063: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37a20>]}
2018-02-13 16:03:11,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e582b0>]}
2018-02-13 16:03:11,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e94dd8>]}
2018-02-13 16:03:11,308: 16:03:11 | 21 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.97s]
2018-02-13 16:03:11,560: 16:03:11 | 22 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.00s]
2018-02-13 16:03:11,822: 16:03:11 | 23 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.05s]
2018-02-13 16:03:12,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:12,259: 16:03:12 | 20 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 3.92s]
2018-02-13 16:03:12,260: 16:03:12 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:03:12,261: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:03:12,260: 16:03:12 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:03:12,268: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:03:12,275: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:03:12,260: 16:03:12 | 26 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:03:12,276: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:03:12,261: 16:03:12 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:03:12,277: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:03:12,277: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:03:12,277: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:03:12,277: Re-using an available connection from the pool.
2018-02-13 16:03:12,281: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:03:12,286: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:03:12,287: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:03:12,288: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:03:12,290: Re-using an available connection from the pool.
2018-02-13 16:03:12,291: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:03:12,292: Re-using an available connection from the pool.
2018-02-13 16:03:12,301: Re-using an available connection from the pool.
2018-02-13 16:03:13,156: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:03:13,207: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:03:13,226: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:03:13,663: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:03:14,267: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e92f98>]}
2018-02-13 16:03:14,325: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b470>]}
2018-02-13 16:03:14,761: 16:03:14 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.00s]
2018-02-13 16:03:14,762: 16:03:14 | 28 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:03:14,763: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:03:14,771: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:03:14,774: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:03:14,774: Re-using an available connection from the pool.
2018-02-13 16:03:15,022: 16:03:15 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.05s]
2018-02-13 16:03:15,023: 16:03:15 | 29 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:03:15,023: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:03:15,031: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:03:15,032: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:03:15,032: Re-using an available connection from the pool.
2018-02-13 16:03:15,381: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:03:15,551: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e947b8>]}
2018-02-13 16:03:15,723: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:03:15,863: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104efd898>]}
2018-02-13 16:03:15,880: 16:03:15 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.29s]
2018-02-13 16:03:16,120: 16:03:16 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.59s]
2018-02-13 16:03:16,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104efd1d0>]}
2018-02-13 16:03:16,729: 16:03:16 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.70s]
2018-02-13 16:03:16,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b860>]}
2018-02-13 16:03:17,049: 16:03:17 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.78s]
2018-02-13 16:03:17,049: 16:03:17 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:03:17,050: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:03:17,050: 16:03:17 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:03:17,061: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:03:17,061: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:03:17,066: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:03:17,050: 16:03:17 | 32 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:03:17,067: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:03:17,073: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:03:17,075: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:03:17,076: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:03:17,077: Re-using an available connection from the pool.
2018-02-13 16:03:17,081: Re-using an available connection from the pool.
2018-02-13 16:03:17,085: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:03:17,085: Re-using an available connection from the pool.
2018-02-13 16:03:17,700: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:03:17,753: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:03:17,754: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:03:18,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e97320>]}
2018-02-13 16:03:18,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e97d30>]}
2018-02-13 16:03:18,872: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:19,119: 16:03:19 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.74s]
2018-02-13 16:03:19,384: 16:03:19 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.80s]
2018-02-13 16:03:19,631: 16:03:19 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.82s]
2018-02-13 16:03:19,632: 16:03:19 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:03:19,632: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:03:19,649: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:03:19,650: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:03:19,650: Re-using an available connection from the pool.
2018-02-13 16:03:20,425: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:03:27,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e92f98>]}
2018-02-13 16:03:27,358: 16:03:27 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 7.42s]
2018-02-13 16:03:27,359: 16:03:27 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:03:27,359: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:03:27,366: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:03:27,367: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:03:27,367: Re-using an available connection from the pool.
2018-02-13 16:03:28,456: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:03:29,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:29,818: 16:03:29 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.18s]
2018-02-13 16:03:29,819: 16:03:29 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:03:29,819: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:03:29,827: 16:03:29 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:03:29,827: Compiling model.seo_audit.ga_proc
2018-02-13 16:03:29,836: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:03:29,840: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:03:29,841: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:03:29,842: Re-using an available connection from the pool.
2018-02-13 16:03:29,842: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:03:29,842: Re-using an available connection from the pool.
2018-02-13 16:03:30,514: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:03:30,527: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:03:32,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e97320>]}
2018-02-13 16:03:32,925: 16:03:32 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.86s]
2018-02-13 16:03:33,778: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101926898>]}
2018-02-13 16:03:34,094: 16:03:34 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.95s]
2018-02-13 16:03:34,095: 16:03:34 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:03:34,095: Compiling model.seo_audit.agg_indicative
2018-02-13 16:03:34,103: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:03:34,107: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:03:34,107: Re-using an available connection from the pool.
2018-02-13 16:03:34,884: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:03:38,195: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:38,464: 16:03:38 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 4.10s]
2018-02-13 16:03:38,464: 16:03:38 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:03:38,465: Compiling model.seo_audit.ga_stats
2018-02-13 16:03:38,473: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:03:38,473: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:03:38,473: Re-using an available connection from the pool.
2018-02-13 16:03:39,287: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:03:41,460: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e943c8>]}
2018-02-13 16:03:41,688: 16:03:41 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.00s]
2018-02-13 16:03:41,689: 16:03:41 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:03:41,689: Compiling model.seo_audit.agg_stats
2018-02-13 16:03:41,705: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:03:41,707: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:03:41,707: Re-using an available connection from the pool.
2018-02-13 16:03:42,511: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:03:45,098: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:45,867: 16:03:45 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.41s]
2018-02-13 16:03:45,868: 16:03:45 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:03:45,868: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:03:45,877: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:03:45,879: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:03:45,879: Re-using an available connection from the pool.
2018-02-13 16:03:46,599: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:03:50,094: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e97320>]}
2018-02-13 16:03:50,528: 16:03:50 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.23s]
2018-02-13 16:03:50,529: 16:03:50 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:03:50,530: Compiling model.seo_audit.agg_all
2018-02-13 16:03:50,542: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:03:50,544: Acquiring new bigquery connection "agg_all".
2018-02-13 16:03:50,544: Re-using an available connection from the pool.
2018-02-13 16:03:51,446: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:03:54,771: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e37fd0>]}
2018-02-13 16:03:55,033: 16:03:55 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.24s]
2018-02-13 16:03:55,033: 16:03:55 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:03:55,033: Compiling model.seo_audit.actions
2018-02-13 16:03:55,042: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:03:55,043: Acquiring new bigquery connection "actions".
2018-02-13 16:03:55,044: Re-using an available connection from the pool.
2018-02-13 16:03:55,559: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:03:55,559: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when meta_description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:03:55,559: 400 Unrecognized name: meta_description; Did you mean description? at [19:14]
2018-02-13 16:03:55,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '54a204ac-235a-434d-900b-3d923444359b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10190df98>]}
2018-02-13 16:03:55,832: 16:03:55 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.53s]
2018-02-13 16:03:55,933: 16:03:55 | 
2018-02-13 16:03:55,934: 16:03:55 | Finished running 42 table models in 77.28s.
2018-02-13 16:03:55,934: Connection 'master' was left open.
2018-02-13 16:03:55,934: 
2018-02-13 16:03:55,934: Completed with 1 errors:
2018-02-13 16:03:55,934: 
2018-02-13 16:03:55,934: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:03:55,934:   Unrecognized name: meta_description; Did you mean description? at [19:14]
2018-02-13 16:03:55,935:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:03:55,935: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:03:55,935: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104de2a20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104de2780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b390>]}
2018-02-13 16:03:56,349: Flushing usage events
2018-02-13 16:07:21,907: Tracking: tracking
2018-02-13 16:07:21,909: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108743da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108743e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087439e8>]}
2018-02-13 16:07:22,699: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:07:22,721: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:07:22,727: Parsing core.sql
2018-02-13 16:07:22,744: Parsing adapters/bigquery.sql
2018-02-13 16:07:22,756: Parsing adapters/common.sql
2018-02-13 16:07:22,777: Parsing adapters/postgres.sql
2018-02-13 16:07:22,785: Parsing adapters/redshift.sql
2018-02-13 16:07:22,809: Parsing etc/get_custom_schema.sql
2018-02-13 16:07:22,817: Parsing materializations/archive.sql
2018-02-13 16:07:22,854: Parsing materializations/bigquery.sql
2018-02-13 16:07:22,870: Parsing materializations/helpers.sql
2018-02-13 16:07:22,891: Parsing materializations/incremental.sql
2018-02-13 16:07:22,924: Parsing materializations/table.sql
2018-02-13 16:07:22,946: Parsing materializations/view.sql
2018-02-13 16:07:22,965: Parsing materializations/wrapper.sql
2018-02-13 16:07:22,974: Parsing schema_tests/accepted_values.sql
2018-02-13 16:07:22,982: Parsing schema_tests/not_null.sql
2018-02-13 16:07:22,988: Parsing schema_tests/relationships.sql
2018-02-13 16:07:22,995: Parsing schema_tests/unique.sql
2018-02-13 16:07:23,059: Parsing model.seo_audit.actions
2018-02-13 16:07:23,065: Acquiring new bigquery connection "master".
2018-02-13 16:07:23,065: Opening a new connection (0 currently allocated)
2018-02-13 16:07:23,072: Parsing model.seo_audit.accounts_proc
2018-02-13 16:07:23,076: Parsing model.seo_audit.all_dates
2018-02-13 16:07:23,078: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:07:23,083: Parsing model.seo_audit.agg_all
2018-02-13 16:07:23,085: Parsing model.seo_audit.agg_indicative
2018-02-13 16:07:23,088: Parsing model.seo_audit.agg_stats
2018-02-13 16:07:23,096: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:07:23,099: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:07:23,101: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:07:23,103: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:07:23,105: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:07:23,106: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:07:23,109: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:07:23,111: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:07:23,113: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:07:23,120: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:07:23,122: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:07:23,124: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:07:23,125: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:07:23,127: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:07:23,129: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:07:23,131: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:07:23,135: Parsing model.seo_audit.ga_proc
2018-02-13 16:07:23,138: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:07:23,140: Parsing model.seo_audit.ga_stats
2018-02-13 16:07:23,142: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:07:23,144: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:07:23,147: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:07:23,149: Parsing model.seo_audit.moz_proc
2018-02-13 16:07:23,152: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:07:23,155: Parsing model.seo_audit.search_console_history
2018-02-13 16:07:23,157: Parsing model.seo_audit.search_console_proc
2018-02-13 16:07:23,159: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:07:23,162: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:07:23,163: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:07:23,166: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:07:23,169: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:07:23,171: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:07:23,174: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:07:23,176: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:07:23,178: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:07:23,193: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:07:23,206: 
2018-02-13 16:07:24,462: 16:07:24 | Concurrency: 4 threads (target='prod')
2018-02-13 16:07:24,462: 16:07:24 | 
2018-02-13 16:07:24,783: 16:07:24 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:07:24,784: Compiling model.seo_audit.accounts_proc
2018-02-13 16:07:24,783: 16:07:24 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:07:24,788: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:07:24,783: 16:07:24 | 3 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:07:24,789: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:07:24,789: Compiling model.seo_audit.all_dates
2018-02-13 16:07:24,794: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:07:24,798: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:07:24,801: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:07:24,802: Opening a new connection (1 currently allocated)
2018-02-13 16:07:24,858: Acquiring new bigquery connection "all_dates".
2018-02-13 16:07:24,859: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:07:24,862: Opening a new connection (2 currently allocated)
2018-02-13 16:07:24,869: Opening a new connection (3 currently allocated)
2018-02-13 16:07:25,976: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:07:25,994: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:07:26,006: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:07:27,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088cdef0>]}
2018-02-13 16:07:27,134: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d07f0>]}
2018-02-13 16:07:27,321: 16:07:27 | 3 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.29s]
2018-02-13 16:07:27,567: 16:07:27 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.35s]
2018-02-13 16:07:28,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108914be0>]}
2018-02-13 16:07:28,392: 16:07:28 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.36s]
2018-02-13 16:07:28,393: 16:07:28 | 4 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:07:28,394: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:07:28,393: 16:07:28 | 5 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:07:28,401: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:07:28,412: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:07:28,416: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:07:28,393: 16:07:28 | 6 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 16:07:28,417: Compiling model.seo_audit.search_console_proc
2018-02-13 16:07:28,394: 16:07:28 | 7 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:07:28,429: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:07:28,429: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:07:28,430: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:07:28,438: Re-using an available connection from the pool.
2018-02-13 16:07:28,431: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:07:28,442: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:07:28,442: Re-using an available connection from the pool.
2018-02-13 16:07:28,450: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:07:28,451: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:07:28,453: Re-using an available connection from the pool.
2018-02-13 16:07:28,454: Opening a new connection (4 currently allocated)
2018-02-13 16:07:29,158: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:07:29,203: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:07:29,470: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:07:29,691: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:07:31,371: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10886bd68>]}
2018-02-13 16:07:31,614: 16:07:31 | 4 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.98s]
2018-02-13 16:07:31,615: 16:07:31 | 8 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:07:31,615: Compiling model.seo_audit.moz_proc
2018-02-13 16:07:31,625: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:07:31,626: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:07:31,626: Re-using an available connection from the pool.
2018-02-13 16:07:31,978: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891d9b0>]}
2018-02-13 16:07:32,229: 16:07:32 | 7 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.55s]
2018-02-13 16:07:32,229: 16:07:32 | 9 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 16:07:32,230: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:07:32,238: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:07:32,239: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:07:32,239: Re-using an available connection from the pool.
2018-02-13 16:07:32,325: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:07:32,914: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:07:33,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108813080>]}
2018-02-13 16:07:34,273: 16:07:34 | 6 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.50s]
2018-02-13 16:07:34,278: 16:07:34 | 10 of 42 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-02-13 16:07:34,281: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:07:34,309: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:07:34,310: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:07:34,311: Re-using an available connection from the pool.
2018-02-13 16:07:34,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10886bd68>]}
2018-02-13 16:07:34,857: 16:07:34 | 8 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.90s]
2018-02-13 16:07:34,857: 16:07:34 | 11 of 42 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-13 16:07:34,858: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:07:34,867: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:07:34,868: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:07:34,868: Re-using an available connection from the pool.
2018-02-13 16:07:35,132: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:07:35,613: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:07:35,727: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891df28>]}
2018-02-13 16:07:36,024: 16:07:36 | 5 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 7.33s]
2018-02-13 16:07:37,750: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108813080>]}
2018-02-13 16:07:37,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891d9b0>]}
2018-02-13 16:07:37,968: 16:07:37 | 10 of 42 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 3.47s]
2018-02-13 16:07:38,246: 16:07:38 | 9 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 5.55s]
2018-02-13 16:07:44,668: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10886bd68>]}
2018-02-13 16:07:44,919: 16:07:44 | 11 of 42 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 9.81s]
2018-02-13 16:07:44,920: 16:07:44 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:07:44,920: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:07:44,925: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:07:44,920: 16:07:44 | 13 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:07:44,925: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:07:44,931: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:07:44,920: 16:07:44 | 14 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:07:44,920: 16:07:44 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:07:44,932: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:07:44,932: Compiling model.seo_audit.search_console_history
2018-02-13 16:07:44,933: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:07:44,933: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:07:44,941: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:07:44,949: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:07:44,949: Re-using an available connection from the pool.
2018-02-13 16:07:44,950: Re-using an available connection from the pool.
2018-02-13 16:07:44,957: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:07:44,957: Re-using an available connection from the pool.
2018-02-13 16:07:44,963: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:07:44,964: Re-using an available connection from the pool.
2018-02-13 16:07:47,383: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:07:47,384: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:07:47,385: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:07:47,386: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:07:48,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10894feb8>]}
2018-02-13 16:07:49,075: 16:07:49 | 13 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.91s]
2018-02-13 16:07:49,076: 16:07:49 | 16 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:07:49,076: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:07:49,084: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:07:49,086: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:07:49,086: Re-using an available connection from the pool.
2018-02-13 16:07:50,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382a20>]}
2018-02-13 16:07:50,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105346828>]}
2018-02-13 16:07:50,275: 16:07:50 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 5.10s]
2018-02-13 16:07:50,504: 16:07:50 | 14 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 5.10s]
2018-02-13 16:07:50,600: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:07:51,689: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088dff60>]}
2018-02-13 16:07:51,936: 16:07:51 | 16 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.61s]
2018-02-13 16:07:53,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:07:53,511: 16:07:53 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 8.34s]
2018-02-13 16:07:53,512: 16:07:53 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:07:53,512: 16:07:53 | 18 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:07:53,512: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:07:53,513: 16:07:53 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:07:53,513: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:07:53,520: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:07:53,522: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:07:53,528: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:07:53,537: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:07:53,539: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:07:53,539: Re-using an available connection from the pool.
2018-02-13 16:07:53,540: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:07:53,542: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:07:53,543: Re-using an available connection from the pool.
2018-02-13 16:07:53,544: Re-using an available connection from the pool.
2018-02-13 16:07:54,256: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:07:54,260: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:07:54,262: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:07:56,425: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105340978>]}
2018-02-13 16:07:56,447: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10886bd68>]}
2018-02-13 16:07:56,663: 16:07:56 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.91s]
2018-02-13 16:07:56,892: 16:07:56 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.93s]
2018-02-13 16:07:57,535: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:07:57,785: 16:07:57 | 18 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 4.02s]
2018-02-13 16:07:57,785: 16:07:57 | 20 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:07:57,786: 16:07:57 | 21 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:07:57,786: 16:07:57 | 22 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:07:57,786: 16:07:57 | 23 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:07:57,787: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:07:57,787: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:07:57,787: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:07:57,787: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:07:57,797: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:07:57,813: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:07:57,817: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:07:57,825: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:07:57,826: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:07:57,826: Re-using an available connection from the pool.
2018-02-13 16:07:57,829: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:07:57,830: Re-using an available connection from the pool.
2018-02-13 16:07:57,831: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:07:57,831: Re-using an available connection from the pool.
2018-02-13 16:07:57,835: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:07:57,837: Re-using an available connection from the pool.
2018-02-13 16:07:58,558: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:07:58,578: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:07:58,579: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:07:58,692: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:08:00,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10893fa20>]}
2018-02-13 16:08:00,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088d0908>]}
2018-02-13 16:08:00,782: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088cddd8>]}
2018-02-13 16:08:00,873: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:00,996: 16:08:00 | 22 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.98s]
2018-02-13 16:08:01,219: 16:08:01 | 23 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.99s]
2018-02-13 16:08:01,450: 16:08:01 | 21 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.99s]
2018-02-13 16:08:01,691: 16:08:01 | 20 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.09s]
2018-02-13 16:08:01,691: 16:08:01 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:08:01,692: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:08:01,698: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:08:01,698: 16:08:01 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:08:01,698: 16:08:01 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:08:01,699: 16:08:01 | 27 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:08:01,699: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:08:01,699: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:08:01,699: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:08:01,704: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:08:01,704: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:08:01,709: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:08:01,715: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:08:01,716: Re-using an available connection from the pool.
2018-02-13 16:08:01,717: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:08:01,727: Re-using an available connection from the pool.
2018-02-13 16:08:01,720: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:08:01,730: Re-using an available connection from the pool.
2018-02-13 16:08:01,722: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:08:01,736: Re-using an available connection from the pool.
2018-02-13 16:08:02,436: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:08:02,437: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:08:02,438: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:08:02,438: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:08:03,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:08:03,784: 16:08:03 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.83s]
2018-02-13 16:08:03,785: 16:08:03 | 28 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:08:03,785: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:08:03,795: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:08:03,796: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:08:03,796: Re-using an available connection from the pool.
2018-02-13 16:08:04,548: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:08:04,636: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891df60>]}
2018-02-13 16:08:04,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108955978>]}
2018-02-13 16:08:04,648: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891d9b0>]}
2018-02-13 16:08:04,870: 16:08:04 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.94s]
2018-02-13 16:08:04,871: 16:08:04 | 29 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:08:04,871: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:08:04,876: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:08:04,879: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:08:04,879: Re-using an available connection from the pool.
2018-02-13 16:08:05,119: 16:08:05 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.94s]
2018-02-13 16:08:05,381: 16:08:05 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.95s]
2018-02-13 16:08:05,543: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:08:05,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:08:05,905: 16:08:05 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.86s]
2018-02-13 16:08:06,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10891df60>]}
2018-02-13 16:08:06,849: 16:08:06 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.74s]
2018-02-13 16:08:06,850: 16:08:06 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:08:06,850: 16:08:06 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:08:06,850: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:08:06,851: 16:08:06 | 32 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:08:06,851: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:08:06,859: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:08:06,859: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:08:06,868: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:08:06,873: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:08:06,874: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:08:06,874: Re-using an available connection from the pool.
2018-02-13 16:08:06,877: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:08:06,878: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:08:06,879: Re-using an available connection from the pool.
2018-02-13 16:08:06,880: Re-using an available connection from the pool.
2018-02-13 16:08:07,561: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:08:07,561: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:08:07,571: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:08:08,672: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:08,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105366940>]}
2018-02-13 16:08:08,676: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10532dda0>]}
2018-02-13 16:08:08,917: 16:08:08 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.82s]
2018-02-13 16:08:09,147: 16:08:09 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.81s]
2018-02-13 16:08:09,374: 16:08:09 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.83s]
2018-02-13 16:08:09,375: 16:08:09 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:08:09,376: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:08:09,390: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:08:09,391: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:08:09,391: Re-using an available connection from the pool.
2018-02-13 16:08:10,214: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:08:13,549: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382710>]}
2018-02-13 16:08:13,840: 16:08:13 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.17s]
2018-02-13 16:08:13,841: 16:08:13 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:08:13,841: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:08:13,851: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:08:13,852: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:08:13,852: Re-using an available connection from the pool.
2018-02-13 16:08:14,632: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:08:16,818: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:17,466: 16:08:17 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 2.98s]
2018-02-13 16:08:17,467: 16:08:17 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:08:17,468: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:08:17,467: 16:08:17 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:08:17,478: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:08:17,478: Compiling model.seo_audit.ga_proc
2018-02-13 16:08:17,489: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:08:17,490: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:08:17,491: Re-using an available connection from the pool.
2018-02-13 16:08:17,493: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:08:17,493: Re-using an available connection from the pool.
2018-02-13 16:08:18,306: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:08:18,306: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:08:20,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:08:20,734: 16:08:20 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.01s]
2018-02-13 16:08:22,755: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10893f710>]}
2018-02-13 16:08:23,074: 16:08:23 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 5.28s]
2018-02-13 16:08:23,075: 16:08:23 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:08:23,076: Compiling model.seo_audit.agg_indicative
2018-02-13 16:08:23,085: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:08:23,086: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:08:23,086: Re-using an available connection from the pool.
2018-02-13 16:08:23,803: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:08:25,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:26,251: 16:08:26 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.90s]
2018-02-13 16:08:26,252: 16:08:26 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:08:26,252: Compiling model.seo_audit.ga_stats
2018-02-13 16:08:26,260: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:08:26,260: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:08:26,260: Re-using an available connection from the pool.
2018-02-13 16:08:27,008: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:08:29,178: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:08:29,416: 16:08:29 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.93s]
2018-02-13 16:08:29,417: 16:08:29 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:08:29,417: Compiling model.seo_audit.agg_stats
2018-02-13 16:08:29,430: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:08:29,431: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:08:29,431: Re-using an available connection from the pool.
2018-02-13 16:08:30,284: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:08:32,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:32,704: 16:08:32 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.05s]
2018-02-13 16:08:32,705: 16:08:32 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:08:32,705: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:08:32,714: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:08:32,715: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:08:32,716: Re-using an available connection from the pool.
2018-02-13 16:08:33,560: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:08:36,850: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802be0>]}
2018-02-13 16:08:37,110: 16:08:37 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.14s]
2018-02-13 16:08:37,110: 16:08:37 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:08:37,111: Compiling model.seo_audit.agg_all
2018-02-13 16:08:37,118: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:08:37,119: Acquiring new bigquery connection "agg_all".
2018-02-13 16:08:37,119: Re-using an available connection from the pool.
2018-02-13 16:08:37,759: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:08:41,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10883a198>]}
2018-02-13 16:08:41,323: 16:08:41 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 3.91s]
2018-02-13 16:08:41,324: 16:08:41 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:08:41,324: Compiling model.seo_audit.actions
2018-02-13 16:08:41,334: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:08:41,335: Acquiring new bigquery connection "actions".
2018-02-13 16:08:41,335: Re-using an available connection from the pool.
2018-02-13 16:08:42,062: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:08:42,062: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:08:42,062: 400 Column name gsc_top_keyword_90d is ambiguous at [20:167]
2018-02-13 16:08:42,063: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76395a56-b696-485c-aaeb-3248ad3f3adc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105346940>]}
2018-02-13 16:08:42,327: 16:08:42 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.74s]
2018-02-13 16:08:42,365: 16:08:42 | 
2018-02-13 16:08:42,366: 16:08:42 | Finished running 42 table models in 77.91s.
2018-02-13 16:08:42,366: Connection 'master' was left open.
2018-02-13 16:08:42,366: 
2018-02-13 16:08:42,367: Completed with 1 errors:
2018-02-13 16:08:42,367: 
2018-02-13 16:08:42,367: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:08:42,367:   Column name gsc_top_keyword_90d is ambiguous at [20:167]
2018-02-13 16:08:42,367:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:08:42,368: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:08:42,368: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1088029b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108802860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105346940>]}
2018-02-13 16:08:42,646: Flushing usage events
2018-02-13 16:09:14,281: Tracking: tracking
2018-02-13 16:09:14,284: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10456e908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10456ec18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10456ec50>]}
2018-02-13 16:09:15,169: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:09:15,199: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:09:15,203: Parsing core.sql
2018-02-13 16:09:15,227: Parsing adapters/bigquery.sql
2018-02-13 16:09:15,236: Parsing adapters/common.sql
2018-02-13 16:09:15,256: Parsing adapters/postgres.sql
2018-02-13 16:09:15,262: Parsing adapters/redshift.sql
2018-02-13 16:09:15,285: Parsing etc/get_custom_schema.sql
2018-02-13 16:09:15,293: Parsing materializations/archive.sql
2018-02-13 16:09:15,332: Parsing materializations/bigquery.sql
2018-02-13 16:09:15,350: Parsing materializations/helpers.sql
2018-02-13 16:09:15,369: Parsing materializations/incremental.sql
2018-02-13 16:09:15,403: Parsing materializations/table.sql
2018-02-13 16:09:15,433: Parsing materializations/view.sql
2018-02-13 16:09:15,469: Parsing materializations/wrapper.sql
2018-02-13 16:09:15,476: Parsing schema_tests/accepted_values.sql
2018-02-13 16:09:15,480: Parsing schema_tests/not_null.sql
2018-02-13 16:09:15,485: Parsing schema_tests/relationships.sql
2018-02-13 16:09:15,491: Parsing schema_tests/unique.sql
2018-02-13 16:09:15,577: Parsing model.seo_audit.actions
2018-02-13 16:09:15,583: Acquiring new bigquery connection "master".
2018-02-13 16:09:15,584: Opening a new connection (0 currently allocated)
2018-02-13 16:09:15,588: Parsing model.seo_audit.accounts_proc
2018-02-13 16:09:15,591: Parsing model.seo_audit.all_dates
2018-02-13 16:09:15,593: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:09:15,596: Parsing model.seo_audit.agg_all
2018-02-13 16:09:15,601: Parsing model.seo_audit.agg_indicative
2018-02-13 16:09:15,606: Parsing model.seo_audit.agg_stats
2018-02-13 16:09:15,617: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:09:15,622: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:09:15,628: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:09:15,631: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:09:15,634: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:09:15,637: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:09:15,640: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:09:15,643: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:09:15,646: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:09:15,654: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:09:15,658: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:09:15,660: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:09:15,662: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:09:15,663: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:09:15,666: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:09:15,668: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:09:15,672: Parsing model.seo_audit.ga_proc
2018-02-13 16:09:15,675: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:09:15,677: Parsing model.seo_audit.ga_stats
2018-02-13 16:09:15,680: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:09:15,681: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:09:15,684: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:09:15,689: Parsing model.seo_audit.moz_proc
2018-02-13 16:09:15,692: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:09:15,695: Parsing model.seo_audit.search_console_history
2018-02-13 16:09:15,699: Parsing model.seo_audit.search_console_proc
2018-02-13 16:09:15,701: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:09:15,704: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:09:15,706: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:09:15,710: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:09:15,714: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:09:15,719: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:09:15,723: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:09:15,726: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:09:15,729: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:09:15,750: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:09:15,772: 
2018-02-13 16:09:17,038: 16:09:17 | Concurrency: 4 threads (target='prod')
2018-02-13 16:09:17,038: 16:09:17 | 
2018-02-13 16:09:17,381: 16:09:17 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:09:17,382: Compiling model.seo_audit.all_dates
2018-02-13 16:09:17,382: 16:09:17 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:09:17,388: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:09:17,382: 16:09:17 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:09:17,388: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:09:17,388: Compiling model.seo_audit.accounts_proc
2018-02-13 16:09:17,393: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:09:17,400: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:09:17,401: Opening a new connection (1 currently allocated)
2018-02-13 16:09:17,399: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:09:17,402: Acquiring new bigquery connection "all_dates".
2018-02-13 16:09:17,474: Opening a new connection (2 currently allocated)
2018-02-13 16:09:17,475: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:09:17,484: Opening a new connection (3 currently allocated)
2018-02-13 16:09:18,587: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:09:18,656: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:09:18,682: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:09:19,679: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104718ac8>]}
2018-02-13 16:09:19,921: 16:09:19 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.30s]
2018-02-13 16:09:20,845: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104698470>]}
2018-02-13 16:09:20,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f7b70>]}
2018-02-13 16:09:21,079: 16:09:21 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.46s]
2018-02-13 16:09:21,300: 16:09:21 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.47s]
2018-02-13 16:09:21,301: 16:09:21 | 4 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:09:21,302: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:09:21,312: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:09:21,307: 16:09:21 | 5 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 16:09:21,307: 16:09:21 | 6 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:09:21,308: 16:09:21 | 7 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:09:21,314: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:09:21,312: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:09:21,313: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:09:21,336: Re-using an available connection from the pool.
2018-02-13 16:09:21,313: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:09:21,325: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:09:21,348: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:09:21,368: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:09:21,370: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:09:21,370: Re-using an available connection from the pool.
2018-02-13 16:09:21,371: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:09:21,373: Re-using an available connection from the pool.
2018-02-13 16:09:21,381: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:09:21,381: Opening a new connection (4 currently allocated)
2018-02-13 16:09:22,103: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:09:22,103: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:09:22,167: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:09:22,408: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:09:24,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10474e860>]}
2018-02-13 16:09:24,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104780b70>]}
2018-02-13 16:09:24,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104780e10>]}
2018-02-13 16:09:24,522: 16:09:24 | 5 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.97s]
2018-02-13 16:09:24,523: 16:09:24 | 8 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:09:24,523: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:09:24,545: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:09:24,547: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:09:24,547: Re-using an available connection from the pool.
2018-02-13 16:09:24,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104750e80>]}
2018-02-13 16:09:24,826: 16:09:24 | 4 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.99s]
2018-02-13 16:09:24,826: 16:09:24 | 9 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:09:24,826: Compiling model.seo_audit.moz_proc
2018-02-13 16:09:24,841: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:09:24,842: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:09:24,842: Re-using an available connection from the pool.
2018-02-13 16:09:25,147: 16:09:25 | 7 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.00s]
2018-02-13 16:09:25,147: 16:09:25 | 10 of 42 START table model seo_audit.semrush_keyword_proc............ [RUN]
2018-02-13 16:09:25,148: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:09:25,155: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:09:25,160: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:09:25,161: Re-using an available connection from the pool.
2018-02-13 16:09:25,391: 16:09:25 | 6 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.26s]
2018-02-13 16:09:25,392: 16:09:25 | 11 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 16:09:25,392: Compiling model.seo_audit.search_console_proc
2018-02-13 16:09:25,403: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:09:25,406: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:09:25,407: Re-using an available connection from the pool.
2018-02-13 16:09:25,457: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:09:25,670: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:09:25,876: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:09:26,068: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:09:27,855: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047186d8>]}
2018-02-13 16:09:28,121: 16:09:28 | 9 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.03s]
2018-02-13 16:09:29,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101126668>]}
2018-02-13 16:09:29,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101168cc0>]}
2018-02-13 16:09:29,391: 16:09:29 | 10 of 42 OK created table model seo_audit.semrush_keyword_proc....... [CREATE TABLE in 4.00s]
2018-02-13 16:09:29,618: 16:09:29 | 11 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.93s]
2018-02-13 16:09:32,012: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f77f0>]}
2018-02-13 16:09:32,625: 16:09:32 | 8 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 7.49s]
2018-02-13 16:09:32,626: 16:09:32 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:09:32,626: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:09:32,633: 16:09:32 | 13 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:09:32,633: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:09:32,650: 16:09:32 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:09:32,657: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:09:32,680: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:09:32,681: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:09:32,682: Re-using an available connection from the pool.
2018-02-13 16:09:32,689: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:09:32,690: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:09:32,691: Re-using an available connection from the pool.
2018-02-13 16:09:32,695: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:09:32,696: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:09:32,697: Re-using an available connection from the pool.
2018-02-13 16:09:32,676: 16:09:32 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:09:32,701: Compiling model.seo_audit.search_console_history
2018-02-13 16:09:32,712: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:09:32,729: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:09:32,729: Re-using an available connection from the pool.
2018-02-13 16:09:33,378: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:09:33,384: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:09:33,388: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:09:33,436: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:09:35,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104780a20>]}
2018-02-13 16:09:35,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101168ef0>]}
2018-02-13 16:09:35,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047619e8>]}
2018-02-13 16:09:35,823: 16:09:35 | 13 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.91s]
2018-02-13 16:09:35,824: 16:09:35 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:09:35,825: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:09:35,833: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:09:35,839: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:09:35,839: Re-using an available connection from the pool.
2018-02-13 16:09:36,097: 16:09:36 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.95s]
2018-02-13 16:09:36,397: 16:09:36 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.02s]
2018-02-13 16:09:36,547: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:09:36,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104732b38>]}
2018-02-13 16:09:36,960: 16:09:36 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.06s]
2018-02-13 16:09:38,744: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104780a20>]}
2018-02-13 16:09:38,977: 16:09:38 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.92s]
2018-02-13 16:09:38,978: 16:09:38 | 17 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:09:38,978: 16:09:38 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:09:38,979: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:09:38,978: 16:09:38 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:09:38,985: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:09:38,984: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:09:38,979: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:09:38,994: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:09:38,999: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:09:39,000: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:09:39,000: Re-using an available connection from the pool.
2018-02-13 16:09:39,001: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:09:39,002: Re-using an available connection from the pool.
2018-02-13 16:09:39,003: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:09:39,011: Re-using an available connection from the pool.
2018-02-13 16:09:39,751: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:09:39,752: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:09:39,754: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:09:41,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101180eb8>]}
2018-02-13 16:09:41,945: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101168dd8>]}
2018-02-13 16:09:42,178: 16:09:42 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.95s]
2018-02-13 16:09:42,404: 16:09:42 | 17 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.97s]
2018-02-13 16:09:43,042: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101191be0>]}
2018-02-13 16:09:43,737: 16:09:43 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 4.06s]
2018-02-13 16:09:43,739: 16:09:43 | 20 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:09:43,739: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:09:43,739: 16:09:43 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:09:43,739: 16:09:43 | 22 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:09:43,751: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:09:43,751: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:09:43,752: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:09:43,739: 16:09:43 | 23 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:09:43,779: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:09:43,765: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:09:43,762: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:09:43,788: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:09:43,802: Re-using an available connection from the pool.
2018-02-13 16:09:43,811: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:09:43,813: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:09:43,816: Re-using an available connection from the pool.
2018-02-13 16:09:43,815: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:09:43,816: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:09:43,820: Re-using an available connection from the pool.
2018-02-13 16:09:43,823: Re-using an available connection from the pool.
2018-02-13 16:09:44,490: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:09:44,491: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:09:44,497: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:09:44,525: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:09:46,651: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104780da0>]}
2018-02-13 16:09:46,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:09:46,934: 16:09:46 | 22 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.90s]
2018-02-13 16:09:47,177: 16:09:47 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.90s]
2018-02-13 16:09:47,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101191d68>]}
2018-02-13 16:09:47,787: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104765a90>]}
2018-02-13 16:09:48,112: 16:09:48 | 20 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.98s]
2018-02-13 16:09:48,340: 16:09:48 | 23 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 4.01s]
2018-02-13 16:09:48,341: 16:09:48 | 24 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:09:48,341: 16:09:48 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:09:48,342: 16:09:48 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:09:48,342: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:09:48,342: 16:09:48 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:09:48,343: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:09:48,343: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:09:48,353: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:09:48,353: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:09:48,359: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:09:48,363: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:09:48,368: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:09:48,370: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:09:48,371: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:09:48,372: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:09:48,372: Re-using an available connection from the pool.
2018-02-13 16:09:48,373: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:09:48,374: Re-using an available connection from the pool.
2018-02-13 16:09:48,374: Re-using an available connection from the pool.
2018-02-13 16:09:48,378: Re-using an available connection from the pool.
2018-02-13 16:09:49,065: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:09:49,106: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:09:49,197: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:09:49,658: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:09:50,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104761d68>]}
2018-02-13 16:09:50,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104732cc0>]}
2018-02-13 16:09:50,359: 16:09:50 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.79s]
2018-02-13 16:09:50,360: 16:09:50 | 28 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:09:50,360: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:09:50,365: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:09:50,367: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:09:50,368: Re-using an available connection from the pool.
2018-02-13 16:09:50,595: 16:09:50 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.93s]
2018-02-13 16:09:50,595: 16:09:50 | 29 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:09:50,596: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:09:50,605: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:09:50,606: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:09:50,606: Re-using an available connection from the pool.
2018-02-13 16:09:51,076: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:09:51,190: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:09:51,280: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046f74e0>]}
2018-02-13 16:09:51,530: 16:09:51 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.94s]
2018-02-13 16:09:51,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104761898>]}
2018-02-13 16:09:52,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104651f98>]}
2018-02-13 16:09:52,177: 16:09:52 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.57s]
2018-02-13 16:09:52,413: 16:09:52 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.81s]
2018-02-13 16:09:53,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:09:53,596: 16:09:53 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.75s]
2018-02-13 16:09:53,596: 16:09:53 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:09:53,597: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:09:53,602: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:09:53,596: 16:09:53 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:09:53,602: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:09:53,596: 16:09:53 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:09:53,607: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:09:53,607: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:09:53,608: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:09:53,613: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:09:53,614: Re-using an available connection from the pool.
2018-02-13 16:09:53,615: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:09:53,616: Re-using an available connection from the pool.
2018-02-13 16:09:53,618: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:09:53,621: Re-using an available connection from the pool.
2018-02-13 16:09:54,268: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:09:54,286: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:09:54,291: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:09:55,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101199358>]}
2018-02-13 16:09:55,379: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104772b38>]}
2018-02-13 16:09:55,394: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104772e48>]}
2018-02-13 16:09:55,794: 16:09:55 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.75s]
2018-02-13 16:09:56,077: 16:09:56 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.78s]
2018-02-13 16:09:56,341: 16:09:56 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.80s]
2018-02-13 16:09:56,341: 16:09:56 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:09:56,341: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:09:56,354: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:09:56,356: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:09:56,356: Re-using an available connection from the pool.
2018-02-13 16:09:57,150: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:10:06,220: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:10:06,558: 16:10:06 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 9.88s]
2018-02-13 16:10:06,559: 16:10:06 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:10:06,559: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:10:06,570: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:10:06,571: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:10:06,572: Re-using an available connection from the pool.
2018-02-13 16:10:07,413: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:10:19,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104651c50>]}
2018-02-13 16:10:19,737: 16:10:19 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 12.90s]
2018-02-13 16:10:19,738: 16:10:19 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:10:19,738: Compiling model.seo_audit.ga_proc
2018-02-13 16:10:19,751: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:10:19,751: 16:10:19 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:10:19,753: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:10:19,753: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:10:19,762: Re-using an available connection from the pool.
2018-02-13 16:10:19,772: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:10:19,775: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:10:19,776: Re-using an available connection from the pool.
2018-02-13 16:10:20,494: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:10:20,578: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:10:22,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104765c50>]}
2018-02-13 16:10:22,961: 16:10:22 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.94s]
2018-02-13 16:10:25,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:10:25,288: 16:10:25 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 5.28s]
2018-02-13 16:10:25,289: 16:10:25 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:10:25,289: Compiling model.seo_audit.agg_indicative
2018-02-13 16:10:25,299: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:10:25,302: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:10:25,303: Re-using an available connection from the pool.
2018-02-13 16:10:25,998: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:10:29,255: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104651c50>]}
2018-02-13 16:10:29,498: 16:10:29 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.97s]
2018-02-13 16:10:29,499: 16:10:29 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:10:29,499: Compiling model.seo_audit.ga_stats
2018-02-13 16:10:29,508: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:10:29,509: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:10:29,509: Re-using an available connection from the pool.
2018-02-13 16:10:30,138: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:10:31,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:10:31,886: 16:10:31 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.13s]
2018-02-13 16:10:31,886: 16:10:31 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:10:31,887: Compiling model.seo_audit.agg_stats
2018-02-13 16:10:31,896: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:10:31,897: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:10:31,897: Re-using an available connection from the pool.
2018-02-13 16:10:34,299: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:10:37,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104651c50>]}
2018-02-13 16:10:37,467: 16:10:37 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 5.35s]
2018-02-13 16:10:37,468: 16:10:37 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:10:37,468: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:10:37,475: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:10:37,477: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:10:37,477: Re-using an available connection from the pool.
2018-02-13 16:10:39,872: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:10:42,923: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046640b8>]}
2018-02-13 16:10:43,615: 16:10:43 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 5.46s]
2018-02-13 16:10:43,621: 16:10:43 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:10:43,621: Compiling model.seo_audit.agg_all
2018-02-13 16:10:43,636: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:10:43,637: Acquiring new bigquery connection "agg_all".
2018-02-13 16:10:43,637: Re-using an available connection from the pool.
2018-02-13 16:10:46,272: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:10:49,204: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104651c50>]}
2018-02-13 16:10:49,420: 16:10:49 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 5.58s]
2018-02-13 16:10:49,421: 16:10:49 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:10:49,421: Compiling model.seo_audit.actions
2018-02-13 16:10:49,428: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:10:49,428: Acquiring new bigquery connection "actions".
2018-02-13 16:10:49,429: Re-using an available connection from the pool.
2018-02-13 16:10:51,107: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:10:51,109: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads > 0 or transactions > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:10:51,109: 400 Unrecognized name: sessions at [28:60]
2018-02-13 16:10:51,110: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30dd6128-1273-480b-970e-d3becef69a95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10116e4a8>]}
2018-02-13 16:10:51,344: 16:10:51 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 1.69s]
2018-02-13 16:10:51,431: 16:10:51 | 
2018-02-13 16:10:51,432: 16:10:51 | Finished running 42 table models in 94.39s.
2018-02-13 16:10:51,432: Connection 'master' was left open.
2018-02-13 16:10:51,432: 
2018-02-13 16:10:51,432: Completed with 1 errors:
2018-02-13 16:10:51,432: 
2018-02-13 16:10:51,433: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:10:51,433:   Unrecognized name: sessions at [28:60]
2018-02-13 16:10:51,433:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:10:51,433: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:10:51,433: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10463d898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10463d748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104664dd8>]}
2018-02-13 16:10:51,666: Flushing usage events
2018-02-13 16:12:13,464: Tracking: tracking
2018-02-13 16:12:13,464: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108931da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108931e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089319e8>]}
2018-02-13 16:12:14,190: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:12:14,212: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:12:14,216: Parsing core.sql
2018-02-13 16:12:14,235: Parsing adapters/bigquery.sql
2018-02-13 16:12:14,243: Parsing adapters/common.sql
2018-02-13 16:12:14,262: Parsing adapters/postgres.sql
2018-02-13 16:12:14,267: Parsing adapters/redshift.sql
2018-02-13 16:12:14,289: Parsing etc/get_custom_schema.sql
2018-02-13 16:12:14,300: Parsing materializations/archive.sql
2018-02-13 16:12:14,337: Parsing materializations/bigquery.sql
2018-02-13 16:12:14,357: Parsing materializations/helpers.sql
2018-02-13 16:12:14,384: Parsing materializations/incremental.sql
2018-02-13 16:12:14,416: Parsing materializations/table.sql
2018-02-13 16:12:14,449: Parsing materializations/view.sql
2018-02-13 16:12:14,466: Parsing materializations/wrapper.sql
2018-02-13 16:12:14,471: Parsing schema_tests/accepted_values.sql
2018-02-13 16:12:14,477: Parsing schema_tests/not_null.sql
2018-02-13 16:12:14,481: Parsing schema_tests/relationships.sql
2018-02-13 16:12:14,488: Parsing schema_tests/unique.sql
2018-02-13 16:12:14,532: Parsing model.seo_audit.actions
2018-02-13 16:12:14,536: Acquiring new bigquery connection "master".
2018-02-13 16:12:14,537: Opening a new connection (0 currently allocated)
2018-02-13 16:12:14,540: Parsing model.seo_audit.accounts_proc
2018-02-13 16:12:14,543: Parsing model.seo_audit.all_dates
2018-02-13 16:12:14,544: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:12:14,547: Parsing model.seo_audit.agg_all
2018-02-13 16:12:14,550: Parsing model.seo_audit.agg_indicative
2018-02-13 16:12:14,552: Parsing model.seo_audit.agg_stats
2018-02-13 16:12:14,559: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:12:14,561: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:12:14,563: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:12:14,565: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:12:14,567: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:12:14,568: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:12:14,571: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:12:14,573: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:12:14,575: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:12:14,581: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:12:14,583: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:12:14,585: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:12:14,587: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:12:14,589: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:12:14,591: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:12:14,593: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:12:14,596: Parsing model.seo_audit.ga_proc
2018-02-13 16:12:14,599: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:12:14,601: Parsing model.seo_audit.ga_stats
2018-02-13 16:12:14,604: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:12:14,605: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:12:14,608: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:12:14,610: Parsing model.seo_audit.moz_proc
2018-02-13 16:12:14,613: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:12:14,616: Parsing model.seo_audit.search_console_history
2018-02-13 16:12:14,617: Parsing model.seo_audit.search_console_proc
2018-02-13 16:12:14,620: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:12:14,623: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:12:14,624: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:12:14,627: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:12:14,630: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:12:14,632: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:12:14,634: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:12:14,636: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:12:14,638: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:12:14,651: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:12:14,663: 
2018-02-13 16:12:16,457: 16:12:16 | Concurrency: 4 threads (target='prod')
2018-02-13 16:12:16,458: 16:12:16 | 
2018-02-13 16:12:16,825: 16:12:16 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:12:16,825: 16:12:16 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:12:16,826: Compiling model.seo_audit.accounts_proc
2018-02-13 16:12:16,825: 16:12:16 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:12:16,826: Compiling model.seo_audit.all_dates
2018-02-13 16:12:16,831: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:12:16,831: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:12:16,835: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:12:16,841: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:12:16,844: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:12:16,845: Opening a new connection (1 currently allocated)
2018-02-13 16:12:16,845: Acquiring new bigquery connection "all_dates".
2018-02-13 16:12:16,846: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:12:16,847: Opening a new connection (2 currently allocated)
2018-02-13 16:12:16,960: Opening a new connection (3 currently allocated)
2018-02-13 16:12:17,930: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:12:18,032: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:12:18,058: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:12:19,016: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa8c18>]}
2018-02-13 16:12:19,258: 16:12:19 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.19s]
2018-02-13 16:12:20,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa8518>]}
2018-02-13 16:12:20,333: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a99e48>]}
2018-02-13 16:12:20,519: 16:12:20 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.42s]
2018-02-13 16:12:20,760: 16:12:20 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.50s]
2018-02-13 16:12:20,760: 16:12:20 | 4 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:12:20,761: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:12:20,767: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:12:20,760: 16:12:20 | 5 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:12:20,767: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:12:20,761: 16:12:20 | 6 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:12:20,774: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:12:20,774: Compiling model.seo_audit.moz_proc
2018-02-13 16:12:20,761: 16:12:20 | 7 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:12:20,780: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:12:20,780: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:12:20,786: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:12:20,787: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:12:20,787: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:12:20,787: Re-using an available connection from the pool.
2018-02-13 16:12:20,789: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:12:20,789: Re-using an available connection from the pool.
2018-02-13 16:12:20,790: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:12:20,792: Re-using an available connection from the pool.
2018-02-13 16:12:20,795: Opening a new connection (4 currently allocated)
2018-02-13 16:12:21,457: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:12:21,481: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:12:21,530: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:12:21,918: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:12:23,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:12:23,712: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b05f60>]}
2018-02-13 16:12:23,968: 16:12:23 | 4 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.93s]
2018-02-13 16:12:23,969: 16:12:23 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:12:23,970: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:12:23,981: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:12:23,984: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:12:23,985: Re-using an available connection from the pool.
2018-02-13 16:12:24,224: 16:12:24 | 6 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.94s]
2018-02-13 16:12:24,224: 16:12:24 | 9 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 16:12:24,225: Compiling model.seo_audit.search_console_proc
2018-02-13 16:12:24,234: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:12:24,235: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:12:24,235: Re-using an available connection from the pool.
2018-02-13 16:12:24,614: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:12:24,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b10160>]}
2018-02-13 16:12:24,700: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10554c6d8>]}
2018-02-13 16:12:24,872: 16:12:24 | 7 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.86s]
2018-02-13 16:12:24,873: 16:12:24 | 10 of 42 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-13 16:12:24,873: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:12:24,884: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:12:24,890: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:12:24,891: Re-using an available connection from the pool.
2018-02-13 16:12:24,900: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:12:25,143: 16:12:25 | 5 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.93s]
2018-02-13 16:12:25,143: 16:12:25 | 11 of 42 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-13 16:12:25,144: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:12:25,150: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:12:25,151: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:12:25,151: Re-using an available connection from the pool.
2018-02-13 16:12:25,579: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:12:25,890: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:12:26,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:12:27,039: 16:12:27 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.83s]
2018-02-13 16:12:27,742: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a59b00>]}
2018-02-13 16:12:27,984: 16:12:27 | 10 of 42 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 2.87s]
2018-02-13 16:12:28,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10554c6d8>]}
2018-02-13 16:12:28,288: 16:12:28 | 11 of 42 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.90s]
2018-02-13 16:12:29,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089ffda0>]}
2018-02-13 16:13:45,258: 16:13:45 | 9 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 5.00s]
2018-02-13 16:13:45,262: 16:13:45 | 12 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:13:45,263: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:13:45,263: 16:13:45 | 13 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:13:45,275: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:13:45,263: 16:13:45 | 14 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:13:45,279: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:13:45,263: 16:13:45 | 15 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:13:45,296: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:13:45,296: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:13:45,298: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:13:45,298: Compiling model.seo_audit.search_console_history
2018-02-13 16:13:45,308: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:13:45,312: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:13:45,313: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:13:45,314: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:13:45,314: Re-using an available connection from the pool.
2018-02-13 16:13:45,323: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:13:45,323: Re-using an available connection from the pool.
2018-02-13 16:13:45,325: Re-using an available connection from the pool.
2018-02-13 16:13:45,326: Re-using an available connection from the pool.
2018-02-13 16:13:46,077: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:13:46,088: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:13:46,091: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:13:46,521: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:13:48,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a99e48>]}
2018-02-13 16:13:48,281: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e03dd8>]}
2018-02-13 16:13:48,282: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b10780>]}
2018-02-13 16:13:48,693: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa8b00>]}
2018-02-13 16:13:48,860: 16:13:48 | 12 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.01s]
2018-02-13 16:13:48,861: 16:13:48 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:13:48,861: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:13:48,869: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:13:48,877: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:13:48,877: Re-using an available connection from the pool.
2018-02-13 16:13:49,107: 16:13:49 | 14 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.00s]
2018-02-13 16:13:49,392: 16:13:49 | 13 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.01s]
2018-02-13 16:13:49,603: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:13:49,641: 16:13:49 | 15 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.39s]
2018-02-13 16:13:51,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e324a8>]}
2018-02-13 16:13:52,052: 16:13:52 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.94s]
2018-02-13 16:13:52,053: 16:13:52 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:13:52,053: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:13:52,063: 16:13:52 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:13:52,066: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:13:52,066: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:13:52,066: 16:13:52 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:13:52,077: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:13:52,077: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:13:52,102: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:13:52,102: Re-using an available connection from the pool.
2018-02-13 16:13:52,095: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:13:52,107: Re-using an available connection from the pool.
2018-02-13 16:13:52,097: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:13:52,119: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:13:52,119: Re-using an available connection from the pool.
2018-02-13 16:13:52,775: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:13:52,786: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:13:52,796: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:13:54,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e15b38>]}
2018-02-13 16:13:54,987: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:13:55,210: 16:13:55 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.92s]
2018-02-13 16:13:55,476: 16:13:55 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.93s]
2018-02-13 16:13:57,087: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a66da0>]}
2018-02-13 16:13:57,314: 16:13:57 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 5.01s]
2018-02-13 16:13:57,315: 16:13:57 | 20 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:13:57,315: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:13:57,321: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:13:57,315: 16:13:57 | 21 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:13:57,315: 16:13:57 | 22 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:13:57,322: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:13:57,322: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:13:57,315: 16:13:57 | 23 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:13:57,328: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:13:57,329: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:13:57,336: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:13:57,337: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:13:57,338: Re-using an available connection from the pool.
2018-02-13 16:13:57,349: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:13:57,358: Re-using an available connection from the pool.
2018-02-13 16:13:57,356: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:13:57,358: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:13:57,370: Re-using an available connection from the pool.
2018-02-13 16:13:57,370: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:13:57,375: Re-using an available connection from the pool.
2018-02-13 16:13:58,071: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:13:58,115: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:13:58,131: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:13:58,174: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:14:00,247: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0b940>]}
2018-02-13 16:14:00,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e10550>]}
2018-02-13 16:14:00,333: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b100b8>]}
2018-02-13 16:14:00,336: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa72b0>]}
2018-02-13 16:14:00,520: 16:14:00 | 22 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.92s]
2018-02-13 16:14:00,787: 16:14:00 | 23 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.92s]
2018-02-13 16:14:01,011: 16:14:01 | 20 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.02s]
2018-02-13 16:14:01,253: 16:14:01 | 21 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.01s]
2018-02-13 16:14:01,254: 16:14:01 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:14:01,255: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:14:01,260: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:14:01,254: 16:14:01 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:14:01,261: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:14:01,265: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:14:01,254: 16:14:01 | 26 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:14:01,255: 16:14:01 | 27 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:14:01,267: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:14:01,267: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:14:01,275: Re-using an available connection from the pool.
2018-02-13 16:14:01,268: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:14:01,276: Re-using an available connection from the pool.
2018-02-13 16:14:01,275: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:14:01,266: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:14:01,293: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:14:01,296: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:14:01,297: Re-using an available connection from the pool.
2018-02-13 16:14:01,304: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:14:01,306: Re-using an available connection from the pool.
2018-02-13 16:14:01,962: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:14:01,992: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:14:02,056: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:14:02,581: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:14:03,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0bc50>]}
2018-02-13 16:14:03,356: 16:14:03 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.81s]
2018-02-13 16:14:03,356: 16:14:03 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:14:03,356: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:14:03,363: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:14:03,364: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:14:03,365: Re-using an available connection from the pool.
2018-02-13 16:14:03,722: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e10e10>]}
2018-02-13 16:14:03,977: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:14:03,983: 16:14:03 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.46s]
2018-02-13 16:14:03,984: 16:14:03 | 29 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:14:03,984: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:14:03,993: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:14:03,994: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:14:03,994: Re-using an available connection from the pool.
2018-02-13 16:14:04,136: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0b080>]}
2018-02-13 16:14:04,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a66da0>]}
2018-02-13 16:14:04,363: 16:14:04 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.88s]
2018-02-13 16:14:04,606: 16:14:04 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.00s]
2018-02-13 16:14:04,692: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:14:05,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e32198>]}
2018-02-13 16:14:05,329: 16:14:05 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.72s]
2018-02-13 16:14:05,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e15898>]}
2018-02-13 16:14:06,039: 16:14:06 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.81s]
2018-02-13 16:14:06,040: 16:14:06 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:14:06,040: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:14:06,047: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:14:06,045: 16:14:06 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:14:06,047: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:14:06,052: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:14:06,045: 16:14:06 | 32 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:14:06,052: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:14:06,058: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:14:06,059: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:14:06,059: Re-using an available connection from the pool.
2018-02-13 16:14:06,060: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:14:06,060: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:14:06,061: Re-using an available connection from the pool.
2018-02-13 16:14:06,065: Re-using an available connection from the pool.
2018-02-13 16:14:06,676: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:14:06,689: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:14:06,809: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:14:07,781: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a66da0>]}
2018-02-13 16:14:07,896: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa72b0>]}
2018-02-13 16:14:08,022: 16:14:08 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.73s]
2018-02-13 16:14:08,262: 16:14:08 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.86s]
2018-02-13 16:14:09,959: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:14:10,211: 16:14:10 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 3.91s]
2018-02-13 16:14:10,212: 16:14:10 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:14:10,212: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:14:10,226: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:14:10,228: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:14:10,228: Re-using an available connection from the pool.
2018-02-13 16:14:10,905: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:14:14,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0b940>]}
2018-02-13 16:14:14,417: 16:14:14 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.97s]
2018-02-13 16:14:14,418: 16:14:14 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:14:14,418: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:14:14,427: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:14:14,430: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:14:14,430: Re-using an available connection from the pool.
2018-02-13 16:14:15,105: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:14:16,191: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:14:16,421: 16:14:16 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.77s]
2018-02-13 16:14:16,422: 16:14:16 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:14:16,422: 16:14:16 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:14:16,422: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:14:16,422: Compiling model.seo_audit.ga_proc
2018-02-13 16:14:16,428: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:14:16,433: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:14:16,442: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:14:16,442: Re-using an available connection from the pool.
2018-02-13 16:14:16,444: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:14:16,445: Re-using an available connection from the pool.
2018-02-13 16:14:17,126: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:14:17,191: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:14:18,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089ff0f0>]}
2018-02-13 16:14:18,897: 16:14:18 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 1.80s]
2018-02-13 16:14:19,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b0b940>]}
2018-02-13 16:14:19,631: 16:14:19 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.97s]
2018-02-13 16:14:19,632: 16:14:19 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:14:19,632: Compiling model.seo_audit.agg_indicative
2018-02-13 16:14:19,641: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:14:19,646: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:14:19,646: Re-using an available connection from the pool.
2018-02-13 16:14:20,309: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:14:22,488: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:14:22,722: 16:14:22 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.86s]
2018-02-13 16:14:22,723: 16:14:22 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:14:22,723: Compiling model.seo_audit.ga_stats
2018-02-13 16:14:22,731: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:14:22,734: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:14:22,734: Re-using an available connection from the pool.
2018-02-13 16:14:23,366: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:14:25,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b10f98>]}
2018-02-13 16:14:25,834: 16:14:25 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.83s]
2018-02-13 16:14:25,835: 16:14:25 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:14:25,835: Compiling model.seo_audit.agg_stats
2018-02-13 16:14:25,846: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:14:25,849: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:14:25,849: Re-using an available connection from the pool.
2018-02-13 16:14:26,757: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:14:28,956: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:14:29,222: 16:14:29 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.12s]
2018-02-13 16:14:29,223: 16:14:29 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:14:29,223: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:14:29,229: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:14:29,230: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:14:29,230: Re-using an available connection from the pool.
2018-02-13 16:14:29,905: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:14:32,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa8dd8>]}
2018-02-13 16:14:32,457: 16:14:32 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.93s]
2018-02-13 16:14:32,458: 16:14:32 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:14:32,458: Compiling model.seo_audit.agg_all
2018-02-13 16:14:32,467: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:14:32,470: Acquiring new bigquery connection "agg_all".
2018-02-13 16:14:32,470: Re-using an available connection from the pool.
2018-02-13 16:14:33,405: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:14:36,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a15128>]}
2018-02-13 16:14:36,931: 16:14:36 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.22s]
2018-02-13 16:14:36,932: 16:14:36 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:14:36,932: Compiling model.seo_audit.actions
2018-02-13 16:14:36,943: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:14:36,946: Acquiring new bigquery connection "actions".
2018-02-13 16:14:36,946: Re-using an available connection from the pool.
2018-02-13 16:14:37,807: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:14:37,807: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:14:37,807: 400 Column name url is ambiguous at [31:56]
2018-02-13 16:14:37,808: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eca32c2-6a11-46e5-ac53-8eab1dbcab94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108aa8cf8>]}
2018-02-13 16:14:38,058: 16:14:38 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.88s]
2018-02-13 16:14:38,164: 16:14:38 | 
2018-02-13 16:14:38,164: 16:14:38 | Finished running 42 table models in 141.71s.
2018-02-13 16:14:38,164: Connection 'master' was left open.
2018-02-13 16:14:38,165: 
2018-02-13 16:14:38,165: Completed with 1 errors:
2018-02-13 16:14:38,166: 
2018-02-13 16:14:38,167: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:14:38,170:   Column name url is ambiguous at [31:56]
2018-02-13 16:14:38,175:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:14:38,177: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:14:38,180: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089f1a58>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089f17b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a66400>]}
2018-02-13 16:14:38,489: Flushing usage events
2018-02-13 16:15:21,702: Tracking: tracking
2018-02-13 16:15:21,708: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10377f5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10377f390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105111e10>]}
2018-02-13 16:15:22,984: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:15:23,001: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:15:23,004: Parsing core.sql
2018-02-13 16:15:23,024: Parsing adapters/bigquery.sql
2018-02-13 16:15:23,031: Parsing adapters/common.sql
2018-02-13 16:15:23,050: Parsing adapters/postgres.sql
2018-02-13 16:15:23,058: Parsing adapters/redshift.sql
2018-02-13 16:15:23,083: Parsing etc/get_custom_schema.sql
2018-02-13 16:15:23,091: Parsing materializations/archive.sql
2018-02-13 16:15:23,122: Parsing materializations/bigquery.sql
2018-02-13 16:15:23,146: Parsing materializations/helpers.sql
2018-02-13 16:15:23,173: Parsing materializations/incremental.sql
2018-02-13 16:15:23,207: Parsing materializations/table.sql
2018-02-13 16:15:23,227: Parsing materializations/view.sql
2018-02-13 16:15:23,250: Parsing materializations/wrapper.sql
2018-02-13 16:15:23,256: Parsing schema_tests/accepted_values.sql
2018-02-13 16:15:23,261: Parsing schema_tests/not_null.sql
2018-02-13 16:15:23,266: Parsing schema_tests/relationships.sql
2018-02-13 16:15:23,272: Parsing schema_tests/unique.sql
2018-02-13 16:15:23,450: Parsing model.seo_audit.actions
2018-02-13 16:15:23,457: Acquiring new bigquery connection "master".
2018-02-13 16:15:23,458: Opening a new connection (0 currently allocated)
2018-02-13 16:15:23,463: Parsing model.seo_audit.accounts_proc
2018-02-13 16:15:23,465: Parsing model.seo_audit.all_dates
2018-02-13 16:15:23,466: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:15:23,470: Parsing model.seo_audit.agg_all
2018-02-13 16:15:23,473: Parsing model.seo_audit.agg_indicative
2018-02-13 16:15:23,475: Parsing model.seo_audit.agg_stats
2018-02-13 16:15:23,480: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:15:23,482: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:15:23,484: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:15:23,486: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:15:23,487: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:15:23,489: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:15:23,491: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:15:23,493: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:15:23,495: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:15:23,502: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:15:23,504: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:15:23,505: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:15:23,507: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:15:23,508: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:15:23,510: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:15:23,512: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:15:23,515: Parsing model.seo_audit.ga_proc
2018-02-13 16:15:23,518: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:15:23,521: Parsing model.seo_audit.ga_stats
2018-02-13 16:15:23,523: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:15:23,525: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:15:23,528: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:15:23,530: Parsing model.seo_audit.moz_proc
2018-02-13 16:15:23,532: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:15:23,535: Parsing model.seo_audit.search_console_history
2018-02-13 16:15:23,538: Parsing model.seo_audit.search_console_proc
2018-02-13 16:15:23,540: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:15:23,543: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:15:23,545: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:15:23,547: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:15:23,550: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:15:23,552: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:15:23,555: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:15:23,557: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:15:23,559: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:15:23,572: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:15:23,584: 
2018-02-13 16:15:23,987: 16:15:23 | Concurrency: 4 threads (target='prod')
2018-02-13 16:15:23,988: 16:15:23 | 
2018-02-13 16:15:24,349: 16:15:24 | 1 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:15:24,349: Compiling model.seo_audit.all_dates
2018-02-13 16:15:24,349: 16:15:24 | 2 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:15:24,353: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:15:24,349: 16:15:24 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:15:24,354: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:15:24,354: Compiling model.seo_audit.accounts_proc
2018-02-13 16:15:24,359: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:15:24,363: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:15:24,365: Acquiring new bigquery connection "all_dates".
2018-02-13 16:15:24,365: Opening a new connection (1 currently allocated)
2018-02-13 16:15:24,365: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:15:24,367: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:15:24,368: Opening a new connection (2 currently allocated)
2018-02-13 16:15:24,418: Opening a new connection (3 currently allocated)
2018-02-13 16:15:25,527: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:15:25,528: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:15:25,603: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:15:27,701: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052a54a8>]}
2018-02-13 16:15:27,734: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10526dba8>]}
2018-02-13 16:15:27,756: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10528fb00>]}
2018-02-13 16:15:27,956: 16:15:27 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.35s]
2018-02-13 16:15:28,191: 16:15:28 | 2 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.38s]
2018-02-13 16:15:28,428: 16:15:28 | 1 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 3.41s]
2018-02-13 16:15:28,429: 16:15:28 | 4 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:15:28,430: 16:15:28 | 5 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:15:28,430: 16:15:28 | 6 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:15:28,430: 16:15:28 | 7 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:15:28,431: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:15:28,431: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:15:28,431: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:15:28,431: Compiling model.seo_audit.moz_proc
2018-02-13 16:15:28,442: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:15:28,448: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:15:28,453: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:15:28,458: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:15:28,460: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:15:28,461: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:15:28,461: Re-using an available connection from the pool.
2018-02-13 16:15:28,461: Re-using an available connection from the pool.
2018-02-13 16:15:28,464: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:15:28,466: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:15:28,466: Re-using an available connection from the pool.
2018-02-13 16:15:28,469: Opening a new connection (4 currently allocated)
2018-02-13 16:15:29,096: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:15:29,108: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:15:29,212: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:15:29,388: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:15:31,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10526d0b8>]}
2018-02-13 16:15:31,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10522a2e8>]}
2018-02-13 16:15:31,508: 16:15:31 | 6 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.84s]
2018-02-13 16:15:31,509: 16:15:31 | 8 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 16:15:31,510: Compiling model.seo_audit.search_console_proc
2018-02-13 16:15:31,522: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:15:31,524: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:15:31,524: Re-using an available connection from the pool.
2018-02-13 16:15:31,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052de240>]}
2018-02-13 16:15:31,761: 16:15:31 | 5 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.96s]
2018-02-13 16:15:31,762: 16:15:31 | 9 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:15:31,763: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:15:31,774: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:15:31,776: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:15:31,777: Re-using an available connection from the pool.
2018-02-13 16:15:32,013: 16:15:32 | 7 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.14s]
2018-02-13 16:15:32,014: 16:15:32 | 10 of 42 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-13 16:15:32,014: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:15:32,025: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:15:32,026: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:15:32,026: Re-using an available connection from the pool.
2018-02-13 16:15:32,241: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:15:32,336: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:15:32,374: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:15:32,573: 16:15:32 | 4 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.91s]
2018-02-13 16:15:32,574: 16:15:32 | 11 of 42 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-13 16:15:32,574: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:15:32,582: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:15:32,583: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:15:32,583: Re-using an available connection from the pool.
2018-02-13 16:15:32,665: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:15:33,321: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:15:34,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10522a2e8>]}
2018-02-13 16:15:34,810: 16:15:34 | 9 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.79s]
2018-02-13 16:15:35,508: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:15:35,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052a5470>]}
2018-02-13 16:15:35,749: 16:15:35 | 11 of 42 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.93s]
2018-02-13 16:15:36,013: 16:15:36 | 8 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.00s]
2018-02-13 16:15:38,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052de240>]}
2018-02-13 16:15:38,419: 16:15:38 | 10 of 42 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 6.17s]
2018-02-13 16:15:38,420: 16:15:38 | 12 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:15:38,420: 16:15:38 | 13 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:15:38,421: 16:15:38 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:15:38,421: 16:15:38 | 15 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:15:38,421: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:15:38,422: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:15:38,422: Compiling model.seo_audit.search_console_history
2018-02-13 16:15:38,422: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:15:38,439: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:15:38,440: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:15:38,444: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:15:38,450: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:15:38,454: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:15:38,455: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:15:38,455: Re-using an available connection from the pool.
2018-02-13 16:15:38,456: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:15:38,456: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:15:38,457: Re-using an available connection from the pool.
2018-02-13 16:15:38,458: Re-using an available connection from the pool.
2018-02-13 16:15:38,459: Re-using an available connection from the pool.
2018-02-13 16:15:39,151: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:15:39,152: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:15:39,153: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:15:39,159: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:15:40,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d057f0>]}
2018-02-13 16:15:40,495: 16:15:40 | 12 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 1.82s]
2018-02-13 16:15:40,496: 16:15:40 | 16 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:15:40,496: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:15:40,504: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:15:40,505: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:15:40,505: Re-using an available connection from the pool.
2018-02-13 16:15:41,205: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:15:41,330: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d262b0>]}
2018-02-13 16:15:41,573: 16:15:41 | 15 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.91s]
2018-02-13 16:15:42,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d26d30>]}
2018-02-13 16:15:42,418: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05940>]}
2018-02-13 16:15:42,645: 16:15:42 | 13 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.98s]
2018-02-13 16:15:42,905: 16:15:42 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.00s]
2018-02-13 16:15:43,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d002e8>]}
2018-02-13 16:15:43,630: 16:15:43 | 16 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.90s]
2018-02-13 16:15:43,631: 16:15:43 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:15:43,632: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:15:43,640: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:15:43,632: 16:15:43 | 18 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:15:43,632: 16:15:43 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:15:43,641: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:15:43,641: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:15:43,642: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:15:43,646: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:15:43,646: Re-using an available connection from the pool.
2018-02-13 16:15:43,651: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:15:43,654: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:15:43,655: Re-using an available connection from the pool.
2018-02-13 16:15:43,660: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:15:43,665: Re-using an available connection from the pool.
2018-02-13 16:15:44,292: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:15:44,334: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:15:44,369: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:15:46,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d165c0>]}
2018-02-13 16:15:46,504: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d6ba8>]}
2018-02-13 16:15:46,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d16a20>]}
2018-02-13 16:15:46,711: 16:15:46 | 18 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.82s]
2018-02-13 16:15:46,955: 16:15:46 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.87s]
2018-02-13 16:15:47,235: 16:15:47 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.89s]
2018-02-13 16:15:47,236: 16:15:47 | 20 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:15:47,237: 16:15:47 | 21 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:15:47,237: 16:15:47 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:15:47,237: 16:15:47 | 23 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:15:47,238: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:15:47,238: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:15:47,238: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:15:47,238: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:15:47,249: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:15:47,250: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:15:47,255: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:15:47,259: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:15:47,261: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:15:47,261: Re-using an available connection from the pool.
2018-02-13 16:15:47,264: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:15:47,264: Re-using an available connection from the pool.
2018-02-13 16:15:47,266: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:15:47,266: Re-using an available connection from the pool.
2018-02-13 16:15:47,269: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:15:47,269: Re-using an available connection from the pool.
2018-02-13 16:15:47,882: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:15:47,896: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:15:47,919: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:15:48,051: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:15:51,178: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105313c18>]}
2018-02-13 16:15:51,420: 16:15:51 | 20 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 3.94s]
2018-02-13 16:15:51,540: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10526d0f0>]}
2018-02-13 16:15:51,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d0e550>]}
2018-02-13 16:15:51,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:15:51,779: 16:15:51 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 4.30s]
2018-02-13 16:15:52,012: 16:15:52 | 23 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 4.31s]
2018-02-13 16:15:52,248: 16:15:52 | 21 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 4.33s]
2018-02-13 16:15:52,249: 16:15:52 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:15:52,250: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:15:52,250: 16:15:52 | 25 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:15:52,257: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:15:52,263: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:15:52,263: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:15:52,250: 16:15:52 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:15:52,264: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:15:52,250: 16:15:52 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:15:52,269: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:15:52,270: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:15:52,270: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:15:52,271: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:15:52,276: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:15:52,276: Re-using an available connection from the pool.
2018-02-13 16:15:52,277: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:15:52,277: Re-using an available connection from the pool.
2018-02-13 16:15:52,279: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:15:52,281: Re-using an available connection from the pool.
2018-02-13 16:15:52,287: Re-using an available connection from the pool.
2018-02-13 16:15:52,887: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:15:52,892: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:15:52,904: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:15:52,981: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:15:55,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:15:55,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052a5f98>]}
2018-02-13 16:15:55,379: 16:15:55 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.83s]
2018-02-13 16:15:55,380: 16:15:55 | 28 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:15:55,380: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:15:55,403: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:15:55,406: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:15:55,406: Re-using an available connection from the pool.
2018-02-13 16:15:55,703: 16:15:55 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.83s]
2018-02-13 16:15:55,703: 16:15:55 | 29 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:15:55,703: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:15:55,714: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:15:55,716: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:15:55,716: Re-using an available connection from the pool.
2018-02-13 16:15:56,075: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:15:56,232: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d6c88>]}
2018-02-13 16:15:56,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530bd30>]}
2018-02-13 16:15:56,310: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:15:56,494: 16:15:56 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.96s]
2018-02-13 16:15:56,729: 16:15:56 | 25 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 4.00s]
2018-02-13 16:15:57,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:15:57,421: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530b2e8>]}
2018-02-13 16:15:57,483: 16:15:57 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.87s]
2018-02-13 16:15:57,710: 16:15:57 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.72s]
2018-02-13 16:15:57,711: 16:15:57 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:15:57,711: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:15:57,712: 16:15:57 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:15:57,747: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:15:57,748: 16:15:57 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:15:57,758: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:15:57,758: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:15:57,748: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:15:57,784: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:15:57,792: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:15:57,801: Re-using an available connection from the pool.
2018-02-13 16:15:57,817: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:15:57,817: Re-using an available connection from the pool.
2018-02-13 16:15:57,833: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:15:57,834: Re-using an available connection from the pool.
2018-02-13 16:15:58,461: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:15:58,463: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:15:58,465: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:15:59,540: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10528ff98>]}
2018-02-13 16:15:59,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d053c8>]}
2018-02-13 16:15:59,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:15:59,791: 16:15:59 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.78s]
2018-02-13 16:16:00,037: 16:16:00 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.81s]
2018-02-13 16:16:00,285: 16:16:00 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.85s]
2018-02-13 16:16:00,286: 16:16:00 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:16:00,286: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:16:00,297: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:16:00,298: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:16:00,298: Re-using an available connection from the pool.
2018-02-13 16:16:01,369: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:16:06,838: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:16:07,073: 16:16:07 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 6.55s]
2018-02-13 16:16:07,074: 16:16:07 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:16:07,074: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:16:07,084: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:16:07,085: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:16:07,085: Re-using an available connection from the pool.
2018-02-13 16:16:07,841: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:16:08,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:16:09,165: 16:16:09 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.85s]
2018-02-13 16:16:09,166: 16:16:09 | 35 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:16:09,166: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:16:09,166: 16:16:09 | 36 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:16:09,173: Compiling model.seo_audit.ga_proc
2018-02-13 16:16:09,183: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:16:09,186: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:16:09,187: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:16:09,187: Re-using an available connection from the pool.
2018-02-13 16:16:09,188: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:16:09,188: Re-using an available connection from the pool.
2018-02-13 16:16:09,866: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:16:09,877: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:16:13,145: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10521a358>]}
2018-02-13 16:16:13,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d29278>]}
2018-02-13 16:16:13,394: 16:16:13 | 35 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.98s]
2018-02-13 16:16:13,646: 16:16:13 | 36 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.98s]
2018-02-13 16:16:13,647: 16:16:13 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:16:13,647: Compiling model.seo_audit.agg_indicative
2018-02-13 16:16:13,656: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:16:13,657: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:16:13,658: Re-using an available connection from the pool.
2018-02-13 16:16:14,370: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:16:16,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:16:16,800: 16:16:16 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.92s]
2018-02-13 16:16:16,801: 16:16:16 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:16:16,801: Compiling model.seo_audit.ga_stats
2018-02-13 16:16:16,811: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:16:16,812: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:16:16,812: Re-using an available connection from the pool.
2018-02-13 16:16:17,492: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:16:25,134: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e9eb8>]}
2018-02-13 16:16:25,762: 16:16:25 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 8.33s]
2018-02-13 16:16:25,763: 16:16:25 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:16:25,763: Compiling model.seo_audit.agg_stats
2018-02-13 16:16:25,776: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:16:25,777: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:16:25,777: Re-using an available connection from the pool.
2018-02-13 16:16:26,659: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:16:28,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:16:29,100: 16:16:29 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.09s]
2018-02-13 16:16:29,101: 16:16:29 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:16:29,101: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:16:29,108: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:16:29,108: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:16:29,109: Re-using an available connection from the pool.
2018-02-13 16:16:29,851: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:16:33,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10526df28>]}
2018-02-13 16:16:33,387: 16:16:33 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 4.05s]
2018-02-13 16:16:33,387: 16:16:33 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:16:33,388: Compiling model.seo_audit.agg_all
2018-02-13 16:16:33,398: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:16:33,399: Acquiring new bigquery connection "agg_all".
2018-02-13 16:16:33,399: Re-using an available connection from the pool.
2018-02-13 16:16:34,237: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:16:37,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101d05080>]}
2018-02-13 16:16:37,798: 16:16:37 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.16s]
2018-02-13 16:16:37,799: 16:16:37 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:16:37,799: Compiling model.seo_audit.actions
2018-02-13 16:16:37,814: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:16:37,818: Acquiring new bigquery connection "actions".
2018-02-13 16:16:37,818: Re-using an available connection from the pool.
2018-02-13 16:16:38,265: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:16:38,265: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:16:38,265: 400 Unrecognized name: rank at [31:101]
2018-02-13 16:16:38,266: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0d52a14-c73e-4ac0-bbbf-9583458cb837', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052d68d0>]}
2018-02-13 16:16:38,512: 16:16:38 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.47s]
2018-02-13 16:16:38,591: 16:16:38 | 
2018-02-13 16:16:38,592: 16:16:38 | Finished running 42 table models in 74.60s.
2018-02-13 16:16:38,592: Connection 'master' was left open.
2018-02-13 16:16:38,592: 
2018-02-13 16:16:38,592: Completed with 1 errors:
2018-02-13 16:16:38,592: 
2018-02-13 16:16:38,593: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:16:38,593:   Unrecognized name: rank at [31:101]
2018-02-13 16:16:38,593:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:16:38,593: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:16:38,593: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051c8860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1051c8710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105170048>]}
2018-02-13 16:16:38,841: Flushing usage events
2018-02-13 16:18:54,827: Tracking: tracking
2018-02-13 16:18:54,828: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d142da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d142e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d1429e8>]}
2018-02-13 16:18:55,630: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:18:55,656: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:18:55,660: Parsing core.sql
2018-02-13 16:18:55,690: Parsing adapters/bigquery.sql
2018-02-13 16:18:55,701: Parsing adapters/common.sql
2018-02-13 16:18:55,718: Parsing adapters/postgres.sql
2018-02-13 16:18:55,726: Parsing adapters/redshift.sql
2018-02-13 16:18:55,752: Parsing etc/get_custom_schema.sql
2018-02-13 16:18:55,768: Parsing materializations/archive.sql
2018-02-13 16:18:55,805: Parsing materializations/bigquery.sql
2018-02-13 16:18:55,821: Parsing materializations/helpers.sql
2018-02-13 16:18:55,839: Parsing materializations/incremental.sql
2018-02-13 16:18:55,871: Parsing materializations/table.sql
2018-02-13 16:18:55,897: Parsing materializations/view.sql
2018-02-13 16:18:55,914: Parsing materializations/wrapper.sql
2018-02-13 16:18:55,919: Parsing schema_tests/accepted_values.sql
2018-02-13 16:18:55,925: Parsing schema_tests/not_null.sql
2018-02-13 16:18:55,930: Parsing schema_tests/relationships.sql
2018-02-13 16:18:55,935: Parsing schema_tests/unique.sql
2018-02-13 16:18:55,993: Parsing model.seo_audit.actions
2018-02-13 16:18:55,998: Acquiring new bigquery connection "master".
2018-02-13 16:18:55,998: Opening a new connection (0 currently allocated)
2018-02-13 16:18:56,002: Parsing model.seo_audit.accounts_proc
2018-02-13 16:18:56,004: Parsing model.seo_audit.all_dates
2018-02-13 16:18:56,005: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:18:56,009: Parsing model.seo_audit.agg_all
2018-02-13 16:18:56,012: Parsing model.seo_audit.agg_indicative
2018-02-13 16:18:56,014: Parsing model.seo_audit.agg_stats
2018-02-13 16:18:56,019: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:18:56,021: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:18:56,023: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:18:56,025: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:18:56,027: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:18:56,029: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:18:56,032: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:18:56,035: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:18:56,040: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:18:56,049: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:18:56,051: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:18:56,055: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:18:56,058: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:18:56,061: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:18:56,064: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:18:56,066: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:18:56,069: Parsing model.seo_audit.ga_proc
2018-02-13 16:18:56,072: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:18:56,075: Parsing model.seo_audit.ga_stats
2018-02-13 16:18:56,077: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:18:56,079: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:18:56,081: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:18:56,083: Parsing model.seo_audit.moz_proc
2018-02-13 16:18:56,086: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:18:56,089: Parsing model.seo_audit.search_console_history
2018-02-13 16:18:56,091: Parsing model.seo_audit.search_console_proc
2018-02-13 16:18:56,093: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:18:56,096: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:18:56,097: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:18:56,100: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:18:56,103: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:18:56,106: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:18:56,108: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:18:56,110: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:18:56,113: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:18:56,126: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:18:56,138: 
2018-02-13 16:18:57,462: 16:18:57 | Concurrency: 4 threads (target='prod')
2018-02-13 16:18:57,463: 16:18:57 | 
2018-02-13 16:18:57,791: 16:18:57 | 1 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:18:57,791: Compiling model.seo_audit.accounts_proc
2018-02-13 16:18:57,791: 16:18:57 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:18:57,791: 16:18:57 | 3 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:18:57,797: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:18:57,797: Compiling model.seo_audit.all_dates
2018-02-13 16:18:57,797: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:18:57,801: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:18:57,806: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:18:57,807: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:18:57,807: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:18:57,807: Opening a new connection (1 currently allocated)
2018-02-13 16:18:57,808: Acquiring new bigquery connection "all_dates".
2018-02-13 16:18:57,810: Opening a new connection (2 currently allocated)
2018-02-13 16:18:57,867: Opening a new connection (3 currently allocated)
2018-02-13 16:18:58,930: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:18:58,995: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:18:59,011: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:19:00,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2bb748>]}
2018-02-13 16:19:00,093: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c35c0>]}
2018-02-13 16:19:00,267: 16:19:00 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.24s]
2018-02-13 16:19:00,520: 16:19:00 | 1 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 2.30s]
2018-02-13 16:19:01,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d26bd68>]}
2018-02-13 16:19:01,403: 16:19:01 | 3 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.36s]
2018-02-13 16:19:01,404: 16:19:01 | 4 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:19:01,405: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:19:01,405: 16:19:01 | 5 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:19:01,416: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:19:01,405: 16:19:01 | 6 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:19:01,416: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:19:01,405: 16:19:01 | 7 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:19:01,417: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:19:01,423: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:19:01,428: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:19:01,430: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:19:01,431: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:19:01,443: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:19:01,445: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:19:01,445: Re-using an available connection from the pool.
2018-02-13 16:19:01,447: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:19:01,449: Re-using an available connection from the pool.
2018-02-13 16:19:01,448: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:19:01,450: Re-using an available connection from the pool.
2018-02-13 16:19:01,456: Opening a new connection (4 currently allocated)
2018-02-13 16:19:02,075: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:19:02,127: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:19:02,194: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:19:02,369: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:19:04,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3423c8>]}
2018-02-13 16:19:04,326: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:04,498: 16:19:04 | 6 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.83s]
2018-02-13 16:19:04,500: 16:19:04 | 8 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 16:19:04,502: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:19:04,513: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:19:04,515: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:19:04,515: Re-using an available connection from the pool.
2018-02-13 16:19:04,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d31b080>]}
2018-02-13 16:19:04,857: 16:19:04 | 5 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.91s]
2018-02-13 16:19:04,859: 16:19:04 | 9 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:19:04,859: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:19:04,874: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:19:04,880: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:19:04,881: Re-using an available connection from the pool.
2018-02-13 16:19:05,193: 16:19:05 | 7 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.13s]
2018-02-13 16:19:05,193: 16:19:05 | 10 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 16:19:05,193: Compiling model.seo_audit.search_console_proc
2018-02-13 16:19:05,203: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:19:05,204: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:19:05,204: Re-using an available connection from the pool.
2018-02-13 16:19:05,405: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:19:05,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d31b4a8>]}
2018-02-13 16:19:05,647: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:19:05,878: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:19:05,884: 16:19:05 | 4 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 4.18s]
2018-02-13 16:19:05,884: 16:19:05 | 11 of 42 START table model seo_audit.moz_proc........................ [RUN]
2018-02-13 16:19:05,885: Compiling model.seo_audit.moz_proc
2018-02-13 16:19:05,893: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:19:05,894: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:19:05,894: Re-using an available connection from the pool.
2018-02-13 16:19:06,614: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:19:08,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3423c8>]}
2018-02-13 16:19:08,820: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d31b4a8>]}
2018-02-13 16:19:08,963: 16:19:08 | 8 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.18s]
2018-02-13 16:19:09,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d299668>]}
2018-02-13 16:19:09,189: 16:19:09 | 11 of 42 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 2.94s]
2018-02-13 16:19:09,438: 16:19:09 | 10 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.96s]
2018-02-13 16:19:11,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:11,305: 16:19:11 | 9 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 6.20s]
2018-02-13 16:19:11,306: 16:19:11 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:19:11,306: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:19:11,306: 16:19:11 | 13 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:19:11,311: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:19:11,312: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:19:11,306: 16:19:11 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:19:11,306: 16:19:11 | 15 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:19:11,318: Compiling model.seo_audit.search_console_history
2018-02-13 16:19:11,319: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:19:11,319: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:19:11,325: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:19:11,344: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:19:11,345: Re-using an available connection from the pool.
2018-02-13 16:19:11,326: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:19:11,348: Re-using an available connection from the pool.
2018-02-13 16:19:11,343: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:19:11,341: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:19:11,358: Re-using an available connection from the pool.
2018-02-13 16:19:11,358: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:19:11,364: Re-using an available connection from the pool.
2018-02-13 16:19:12,039: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:19:12,042: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:19:12,042: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:19:12,055: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:19:14,210: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d327f60>]}
2018-02-13 16:19:14,212: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d78ba8>]}
2018-02-13 16:19:14,230: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d26bd68>]}
2018-02-13 16:19:14,451: 16:19:14 | 15 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.89s]
2018-02-13 16:19:14,452: 16:19:14 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:19:14,454: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:19:14,467: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:19:14,469: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:19:14,469: Re-using an available connection from the pool.
2018-02-13 16:19:14,692: 16:19:14 | 13 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.90s]
2018-02-13 16:19:14,943: 16:19:14 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.92s]
2018-02-13 16:19:15,231: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:19:15,400: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d68eb8>]}
2018-02-13 16:19:15,687: 16:19:15 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.08s]
2018-02-13 16:19:17,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d83d30>]}
2018-02-13 16:19:17,653: 16:19:17 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.95s]
2018-02-13 16:19:17,653: 16:19:17 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:19:17,654: 16:19:17 | 18 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:19:17,654: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:19:17,654: 16:19:17 | 19 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:19:17,654: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:19:17,661: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:19:17,663: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:19:17,669: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:19:17,675: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:19:17,676: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:19:17,677: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:19:17,677: Re-using an available connection from the pool.
2018-02-13 16:19:17,679: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:19:17,680: Re-using an available connection from the pool.
2018-02-13 16:19:17,681: Re-using an available connection from the pool.
2018-02-13 16:19:18,258: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:19:18,283: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:19:18,333: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:19:20,455: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d83470>]}
2018-02-13 16:19:20,485: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:20,513: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d78f98>]}
2018-02-13 16:19:20,689: 16:19:20 | 19 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.79s]
2018-02-13 16:19:20,914: 16:19:20 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.83s]
2018-02-13 16:19:21,154: 16:19:21 | 18 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.86s]
2018-02-13 16:19:21,155: 16:19:21 | 20 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:19:21,156: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:19:21,155: 16:19:21 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:19:21,155: 16:19:21 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:19:21,167: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:19:21,167: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:19:21,167: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:19:21,156: 16:19:21 | 23 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:19:21,180: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:19:21,181: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:19:21,180: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:19:21,182: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:19:21,192: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:19:21,195: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:19:21,196: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:19:21,197: Re-using an available connection from the pool.
2018-02-13 16:19:21,198: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:19:21,202: Re-using an available connection from the pool.
2018-02-13 16:19:21,205: Re-using an available connection from the pool.
2018-02-13 16:19:21,209: Re-using an available connection from the pool.
2018-02-13 16:19:21,882: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:19:21,883: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:19:21,884: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:19:21,923: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:19:24,055: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d68710>]}
2018-02-13 16:19:24,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d453c8>]}
2018-02-13 16:19:24,138: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d49da0>]}
2018-02-13 16:19:24,194: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d83d30>]}
2018-02-13 16:19:24,293: 16:19:24 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.89s]
2018-02-13 16:19:24,526: 16:19:24 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.89s]
2018-02-13 16:19:24,761: 16:19:24 | 23 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.96s]
2018-02-13 16:19:24,988: 16:19:24 | 20 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.04s]
2018-02-13 16:19:24,988: 16:19:24 | 24 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:19:24,989: 16:19:24 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:19:24,989: 16:19:24 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:19:24,989: 16:19:24 | 27 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:19:24,990: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:19:24,990: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:19:24,990: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:19:24,990: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:19:24,997: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:19:25,001: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:19:25,005: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:19:25,011: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:19:25,012: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:19:25,013: Re-using an available connection from the pool.
2018-02-13 16:19:25,014: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:19:25,014: Re-using an available connection from the pool.
2018-02-13 16:19:25,015: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:19:25,017: Re-using an available connection from the pool.
2018-02-13 16:19:25,018: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:19:25,020: Re-using an available connection from the pool.
2018-02-13 16:19:25,658: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:19:25,659: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:19:25,670: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:19:26,756: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d342be0>]}
2018-02-13 16:19:26,992: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:19:27,031: 16:19:27 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.77s]
2018-02-13 16:19:27,032: 16:19:27 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:19:27,032: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:19:27,039: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:19:27,040: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:19:27,040: Re-using an available connection from the pool.
2018-02-13 16:19:27,696: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:19:27,842: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:27,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2291d0>]}
2018-02-13 16:19:28,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c3d68>]}
2018-02-13 16:19:28,242: 16:19:28 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.85s]
2018-02-13 16:19:28,246: 16:19:28 | 29 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:19:28,247: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:19:28,253: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:19:28,254: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:19:28,254: Re-using an available connection from the pool.
2018-02-13 16:19:28,498: 16:19:28 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.87s]
2018-02-13 16:19:28,716: 16:19:28 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 3.08s]
2018-02-13 16:19:28,802: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2c3e80>]}
2018-02-13 16:19:28,882: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:19:29,072: 16:19:29 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.77s]
2018-02-13 16:19:29,969: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:30,216: 16:19:30 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.72s]
2018-02-13 16:19:30,217: 16:19:30 | 30 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:19:30,217: 16:19:30 | 31 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:19:30,218: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:19:30,218: 16:19:30 | 32 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:19:30,218: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:19:30,224: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:19:30,226: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:19:30,230: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:19:30,235: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:19:30,236: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:19:30,237: Re-using an available connection from the pool.
2018-02-13 16:19:30,237: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:19:30,238: Re-using an available connection from the pool.
2018-02-13 16:19:30,240: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:19:30,242: Re-using an available connection from the pool.
2018-02-13 16:19:30,862: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:19:30,879: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:19:30,906: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:19:31,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2bb208>]}
2018-02-13 16:19:31,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d31b908>]}
2018-02-13 16:19:32,000: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23b710>]}
2018-02-13 16:19:32,174: 16:19:32 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.72s]
2018-02-13 16:19:32,398: 16:19:32 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.74s]
2018-02-13 16:19:32,628: 16:19:32 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.78s]
2018-02-13 16:19:32,629: 16:19:32 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:19:32,629: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:19:32,648: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:19:32,649: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:19:32,650: Re-using an available connection from the pool.
2018-02-13 16:19:33,441: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:19:36,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:36,943: 16:19:36 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.07s]
2018-02-13 16:19:36,943: 16:19:36 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:19:36,944: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:19:36,952: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:19:36,953: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:19:36,953: Re-using an available connection from the pool.
2018-02-13 16:19:37,540: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:19:38,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23b710>]}
2018-02-13 16:19:38,902: 16:19:38 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.69s]
2018-02-13 16:19:38,903: 16:19:38 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:19:38,903: 16:19:38 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:19:38,903: Compiling model.seo_audit.ga_proc
2018-02-13 16:19:38,904: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:19:38,915: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:19:38,923: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:19:38,925: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:19:38,925: Re-using an available connection from the pool.
2018-02-13 16:19:38,925: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:19:38,926: Re-using an available connection from the pool.
2018-02-13 16:19:39,586: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:19:39,650: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:19:41,844: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2150b8>]}
2018-02-13 16:19:42,104: 16:19:42 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.94s]
2018-02-13 16:19:42,855: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3425f8>]}
2018-02-13 16:19:43,100: 16:19:43 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.95s]
2018-02-13 16:19:43,101: 16:19:43 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:19:43,101: Compiling model.seo_audit.agg_indicative
2018-02-13 16:19:43,108: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:19:43,109: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:19:43,109: Re-using an available connection from the pool.
2018-02-13 16:19:43,883: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:19:46,108: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23b710>]}
2018-02-13 16:19:46,435: 16:19:46 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.01s]
2018-02-13 16:19:46,435: 16:19:46 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:19:46,436: Compiling model.seo_audit.ga_stats
2018-02-13 16:19:46,446: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:19:46,447: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:19:46,448: Re-using an available connection from the pool.
2018-02-13 16:19:47,073: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:19:49,278: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2bbd68>]}
2018-02-13 16:19:49,948: 16:19:49 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.84s]
2018-02-13 16:19:49,948: 16:19:49 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:19:49,949: Compiling model.seo_audit.agg_stats
2018-02-13 16:19:49,962: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:19:49,963: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:19:49,963: Re-using an available connection from the pool.
2018-02-13 16:19:50,754: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:19:52,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23b710>]}
2018-02-13 16:19:53,203: 16:19:53 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.98s]
2018-02-13 16:19:53,204: 16:19:53 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:19:53,205: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:19:53,219: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:19:53,221: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:19:53,221: Re-using an available connection from the pool.
2018-02-13 16:19:53,932: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:19:56,097: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d48390>]}
2018-02-13 16:19:56,349: 16:19:56 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.89s]
2018-02-13 16:19:56,349: 16:19:56 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:19:56,349: Compiling model.seo_audit.agg_all
2018-02-13 16:19:56,360: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:19:56,361: Acquiring new bigquery connection "agg_all".
2018-02-13 16:19:56,361: Re-using an available connection from the pool.
2018-02-13 16:19:57,094: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:20:00,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23b710>]}
2018-02-13 16:20:00,964: 16:20:00 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 3.98s]
2018-02-13 16:20:00,965: 16:20:00 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:20:00,965: Compiling model.seo_audit.actions
2018-02-13 16:20:00,974: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:20:00,974: Acquiring new bigquery connection "actions".
2018-02-13 16:20:00,975: Re-using an available connection from the pool.
2018-02-13 16:20:01,499: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:20:01,500: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:20:01,500: 400 Unrecognized name: impressions_90d; Did you mean gsc_impressions_90d? at [35:14]
2018-02-13 16:20:01,500: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f1071ab-7f35-4b96-8ec8-ff293c3d95b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d5d048>]}
2018-02-13 16:20:01,746: 16:20:01 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 0.53s]
2018-02-13 16:20:01,837: 16:20:01 | 
2018-02-13 16:20:01,837: 16:20:01 | Finished running 42 table models in 64.37s.
2018-02-13 16:20:01,838: Connection 'master' was left open.
2018-02-13 16:20:01,838: 
2018-02-13 16:20:01,838: Completed with 1 errors:
2018-02-13 16:20:01,838: 
2018-02-13 16:20:01,839: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:20:01,839:   Unrecognized name: impressions_90d; Did you mean gsc_impressions_90d? at [35:14]
2018-02-13 16:20:01,839:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:20:01,840: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:20:01,840: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d2029b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d202860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab3aba8>]}
2018-02-13 16:20:02,103: Flushing usage events
2018-02-13 16:21:09,790: Tracking: tracking
2018-02-13 16:21:09,790: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1067492e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106749b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106749080>]}
2018-02-13 16:21:10,509: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:21:10,523: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:21:10,524: Parsing core.sql
2018-02-13 16:21:10,539: Parsing adapters/bigquery.sql
2018-02-13 16:21:10,544: Parsing adapters/common.sql
2018-02-13 16:21:10,556: Parsing adapters/postgres.sql
2018-02-13 16:21:10,559: Parsing adapters/redshift.sql
2018-02-13 16:21:10,577: Parsing etc/get_custom_schema.sql
2018-02-13 16:21:10,582: Parsing materializations/archive.sql
2018-02-13 16:21:10,610: Parsing materializations/bigquery.sql
2018-02-13 16:21:10,624: Parsing materializations/helpers.sql
2018-02-13 16:21:10,640: Parsing materializations/incremental.sql
2018-02-13 16:21:10,665: Parsing materializations/table.sql
2018-02-13 16:21:10,683: Parsing materializations/view.sql
2018-02-13 16:21:10,697: Parsing materializations/wrapper.sql
2018-02-13 16:21:10,700: Parsing schema_tests/accepted_values.sql
2018-02-13 16:21:10,703: Parsing schema_tests/not_null.sql
2018-02-13 16:21:10,704: Parsing schema_tests/relationships.sql
2018-02-13 16:21:10,707: Parsing schema_tests/unique.sql
2018-02-13 16:21:10,716: Parsing model.seo_audit.actions
2018-02-13 16:21:10,720: Acquiring new bigquery connection "master".
2018-02-13 16:21:10,720: Opening a new connection (0 currently allocated)
2018-02-13 16:21:10,724: Parsing model.seo_audit.accounts_proc
2018-02-13 16:21:10,726: Parsing model.seo_audit.all_dates
2018-02-13 16:21:10,727: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:21:10,731: Parsing model.seo_audit.agg_all
2018-02-13 16:21:10,733: Parsing model.seo_audit.agg_indicative
2018-02-13 16:21:10,736: Parsing model.seo_audit.agg_stats
2018-02-13 16:21:10,741: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:21:10,743: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:21:10,745: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:21:10,747: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:21:10,748: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:21:10,750: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:21:10,753: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:21:10,755: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:21:10,757: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:21:10,763: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:21:10,765: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:21:10,767: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:21:10,769: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:21:10,770: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:21:10,772: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:21:10,774: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:21:10,777: Parsing model.seo_audit.ga_proc
2018-02-13 16:21:10,780: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:21:10,783: Parsing model.seo_audit.ga_stats
2018-02-13 16:21:10,785: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:21:10,787: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:21:10,789: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:21:10,791: Parsing model.seo_audit.moz_proc
2018-02-13 16:21:10,794: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:21:10,797: Parsing model.seo_audit.search_console_history
2018-02-13 16:21:10,799: Parsing model.seo_audit.search_console_proc
2018-02-13 16:21:10,801: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:21:10,804: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:21:10,805: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:21:10,808: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:21:10,810: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:21:10,813: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:21:10,815: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:21:10,817: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:21:10,819: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:21:10,832: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:21:10,845: 
2018-02-13 16:21:11,652: 16:21:11 | Concurrency: 4 threads (target='prod')
2018-02-13 16:21:11,653: 16:21:11 | 
2018-02-13 16:21:11,983: 16:21:11 | 1 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:21:11,984: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:21:11,983: 16:21:11 | 2 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:21:11,988: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:21:11,983: 16:21:11 | 3 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:21:11,989: Compiling model.seo_audit.accounts_proc
2018-02-13 16:21:11,989: Compiling model.seo_audit.all_dates
2018-02-13 16:21:11,994: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:21:11,998: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:21:11,999: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:21:11,999: Opening a new connection (1 currently allocated)
2018-02-13 16:21:12,000: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:21:12,000: Acquiring new bigquery connection "all_dates".
2018-02-13 16:21:12,002: Opening a new connection (2 currently allocated)
2018-02-13 16:21:12,063: Opening a new connection (3 currently allocated)
2018-02-13 16:21:13,067: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:21:13,083: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:21:13,239: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:21:14,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106955860>]}
2018-02-13 16:21:14,394: 16:21:14 | 3 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.17s]
2018-02-13 16:21:15,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106935550>]}
2018-02-13 16:21:15,415: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687c470>]}
2018-02-13 16:21:15,487: 16:21:15 | 2 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.26s]
2018-02-13 16:21:15,728: 16:21:15 | 1 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.43s]
2018-02-13 16:21:15,729: 16:21:15 | 4 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:21:15,730: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:21:15,729: 16:21:15 | 5 of 42 START table model seo_audit.moz_proc......................... [RUN]
2018-02-13 16:21:15,737: Compiling model.seo_audit.moz_proc
2018-02-13 16:21:15,748: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:21:15,752: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:21:15,730: 16:21:15 | 6 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:21:15,753: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:21:15,759: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:21:15,761: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:21:15,762: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:21:15,762: Re-using an available connection from the pool.
2018-02-13 16:21:15,730: 16:21:15 | 7 of 42 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-13 16:21:15,763: Re-using an available connection from the pool.
2018-02-13 16:21:15,763: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:21:15,767: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:21:15,781: Re-using an available connection from the pool.
2018-02-13 16:21:15,784: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:21:15,786: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:21:15,790: Opening a new connection (4 currently allocated)
2018-02-13 16:21:16,365: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:21:16,445: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:21:16,494: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:21:16,866: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:21:18,535: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106935550>]}
2018-02-13 16:21:18,619: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c8278>]}
2018-02-13 16:21:18,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106831ba8>]}
2018-02-13 16:21:18,780: 16:21:18 | 5 of 42 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.80s]
2018-02-13 16:21:18,784: 16:21:18 | 8 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:21:18,785: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:21:18,796: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:21:18,797: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:21:18,797: Re-using an available connection from the pool.
2018-02-13 16:21:19,021: 16:21:19 | 6 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.87s]
2018-02-13 16:21:19,022: 16:21:19 | 9 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:21:19,023: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:21:19,030: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:21:19,032: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:21:19,032: Re-using an available connection from the pool.
2018-02-13 16:21:19,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069555f8>]}
2018-02-13 16:21:19,264: 16:21:19 | 4 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.96s]
2018-02-13 16:21:19,265: 16:21:19 | 10 of 42 START table model seo_audit.search_console_proc............. [RUN]
2018-02-13 16:21:19,266: Compiling model.seo_audit.search_console_proc
2018-02-13 16:21:19,277: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:21:19,280: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:21:19,280: Re-using an available connection from the pool.
2018-02-13 16:21:19,441: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:21:19,520: 16:21:19 | 7 of 42 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.33s]
2018-02-13 16:21:19,520: 16:21:19 | 11 of 42 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-13 16:21:19,521: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:21:19,531: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:21:19,532: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:21:19,532: Re-using an available connection from the pool.
2018-02-13 16:21:19,663: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:21:19,916: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:21:20,222: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:21:21,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106935550>]}
2018-02-13 16:21:21,843: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106854cc0>]}
2018-02-13 16:21:21,880: 16:21:21 | 8 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 2.85s]
2018-02-13 16:21:22,120: 16:21:22 | 9 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.82s]
2018-02-13 16:21:22,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10694b9e8>]}
2018-02-13 16:21:23,102: 16:21:23 | 11 of 42 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.89s]
2018-02-13 16:21:36,341: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106831ba8>]}
2018-02-13 16:21:36,592: 16:21:36 | 10 of 42 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 17.08s]
2018-02-13 16:21:36,593: 16:21:36 | 12 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:21:36,594: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:21:36,593: 16:21:36 | 13 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:21:36,593: 16:21:36 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:21:36,593: 16:21:36 | 15 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:21:36,603: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:21:36,603: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:21:36,603: Compiling model.seo_audit.search_console_history
2018-02-13 16:21:36,603: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:21:36,609: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:21:36,614: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:21:36,620: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:21:36,621: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:21:36,621: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:21:36,622: Re-using an available connection from the pool.
2018-02-13 16:21:36,623: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:21:36,623: Re-using an available connection from the pool.
2018-02-13 16:21:36,625: Re-using an available connection from the pool.
2018-02-13 16:21:36,626: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:21:36,637: Re-using an available connection from the pool.
2018-02-13 16:21:37,293: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:21:37,312: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:21:37,312: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:21:37,352: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:21:39,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10692e6d8>]}
2018-02-13 16:21:39,529: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106749080>]}
2018-02-13 16:21:39,758: 16:21:39 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.91s]
2018-02-13 16:21:39,760: 16:21:39 | 16 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:21:39,763: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:21:39,775: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:21:39,780: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:21:39,781: Re-using an available connection from the pool.
2018-02-13 16:21:40,011: 16:21:40 | 13 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.93s]
2018-02-13 16:21:40,488: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:21:40,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687c470>]}
2018-02-13 16:21:40,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cb6e10>]}
2018-02-13 16:21:40,794: 16:21:40 | 12 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 3.95s]
2018-02-13 16:21:41,160: 16:21:41 | 15 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 3.95s]
2018-02-13 16:21:45,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10692e6d8>]}
2018-02-13 16:21:46,155: 16:21:46 | 16 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 6.15s]
2018-02-13 16:21:46,156: 16:21:46 | 17 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:21:46,156: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:21:46,156: 16:21:46 | 18 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:21:46,163: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:21:46,156: 16:21:46 | 19 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:21:46,170: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:21:46,172: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:21:46,172: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:21:46,177: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:21:46,178: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:21:46,179: Re-using an available connection from the pool.
2018-02-13 16:21:46,180: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:21:46,180: Re-using an available connection from the pool.
2018-02-13 16:21:46,184: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:21:46,184: Re-using an available connection from the pool.
2018-02-13 16:21:46,755: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:21:46,799: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:21:46,833: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:21:48,930: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c8d68>]}
2018-02-13 16:21:48,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2630>]}
2018-02-13 16:21:48,991: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cb6a90>]}
2018-02-13 16:21:49,161: 16:21:49 | 18 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.77s]
2018-02-13 16:21:49,390: 16:21:49 | 17 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.83s]
2018-02-13 16:21:49,614: 16:21:49 | 19 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.82s]
2018-02-13 16:21:49,615: 16:21:49 | 20 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:21:49,616: 16:21:49 | 21 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:21:49,616: 16:21:49 | 22 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:21:49,616: 16:21:49 | 23 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:21:49,617: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:21:49,617: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:21:49,617: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:21:49,617: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:21:49,638: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:21:49,640: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:21:49,644: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:21:49,645: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:21:49,647: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:21:49,647: Re-using an available connection from the pool.
2018-02-13 16:21:49,649: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:21:49,649: Re-using an available connection from the pool.
2018-02-13 16:21:49,650: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:21:49,651: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:21:49,652: Re-using an available connection from the pool.
2018-02-13 16:21:49,655: Re-using an available connection from the pool.
2018-02-13 16:21:50,307: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:21:50,312: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:21:50,331: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:21:50,368: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:21:52,493: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106749080>]}
2018-02-13 16:21:52,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10681cf98>]}
2018-02-13 16:21:52,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10692ecf8>]}
2018-02-13 16:21:52,567: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2b70>]}
2018-02-13 16:21:53,222: 16:21:53 | 20 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.88s]
2018-02-13 16:21:53,504: 16:21:53 | 22 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.89s]
2018-02-13 16:21:53,738: 16:21:53 | 21 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.93s]
2018-02-13 16:21:53,978: 16:21:53 | 23 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.95s]
2018-02-13 16:21:53,979: 16:21:53 | 24 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:21:53,979: 16:21:53 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:21:53,980: 16:21:53 | 26 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:21:53,980: 16:21:53 | 27 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:21:53,980: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:21:53,980: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:21:53,980: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:21:53,981: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:21:54,007: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:21:54,008: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:21:54,009: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:21:54,010: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:21:54,011: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:21:54,011: Re-using an available connection from the pool.
2018-02-13 16:21:54,014: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:21:54,014: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:21:54,015: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:21:54,016: Re-using an available connection from the pool.
2018-02-13 16:21:54,017: Re-using an available connection from the pool.
2018-02-13 16:21:54,018: Re-using an available connection from the pool.
2018-02-13 16:21:54,663: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:21:54,681: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:21:54,725: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:21:54,765: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:21:55,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687a198>]}
2018-02-13 16:21:56,026: 16:21:56 | 26 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.78s]
2018-02-13 16:21:56,027: 16:21:56 | 28 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:21:56,027: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:21:56,035: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:21:56,036: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:21:56,036: Re-using an available connection from the pool.
2018-02-13 16:21:56,779: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:21:56,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069555f8>]}
2018-02-13 16:21:56,895: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106955400>]}
2018-02-13 16:21:56,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2518>]}
2018-02-13 16:21:57,089: 16:21:57 | 24 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.87s]
2018-02-13 16:21:57,090: 16:21:57 | 29 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:21:57,091: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:21:57,101: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:21:57,104: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:21:57,104: Re-using an available connection from the pool.
2018-02-13 16:21:57,354: 16:21:57 | 27 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.91s]
2018-02-13 16:21:57,576: 16:21:57 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.96s]
2018-02-13 16:21:57,741: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:21:57,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cc00b8>]}
2018-02-13 16:21:58,130: 16:21:58 | 28 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.84s]
2018-02-13 16:21:58,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cb63c8>]}
2018-02-13 16:21:59,035: 16:21:59 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.72s]
2018-02-13 16:21:59,036: 16:21:59 | 30 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:21:59,036: 16:21:59 | 31 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:21:59,036: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:21:59,037: 16:21:59 | 32 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:21:59,037: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:21:59,045: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:21:59,045: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:21:59,050: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:21:59,055: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:21:59,056: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:21:59,056: Re-using an available connection from the pool.
2018-02-13 16:21:59,057: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:21:59,057: Re-using an available connection from the pool.
2018-02-13 16:21:59,059: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:21:59,061: Re-using an available connection from the pool.
2018-02-13 16:21:59,636: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:21:59,638: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:21:59,808: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:22:00,725: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c93358>]}
2018-02-13 16:22:00,732: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2518>]}
2018-02-13 16:22:00,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c93cc0>]}
2018-02-13 16:22:00,961: 16:22:00 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.68s]
2018-02-13 16:22:01,222: 16:22:01 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.70s]
2018-02-13 16:22:01,458: 16:22:01 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.85s]
2018-02-13 16:22:01,459: 16:22:01 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:22:01,460: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:22:01,474: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:22:01,475: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:22:01,475: Re-using an available connection from the pool.
2018-02-13 16:22:02,333: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:22:04,512: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cb63c8>]}
2018-02-13 16:22:05,141: 16:22:05 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.05s]
2018-02-13 16:22:05,142: 16:22:05 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:22:05,142: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:22:05,149: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:22:05,150: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:22:05,150: Re-using an available connection from the pool.
2018-02-13 16:22:05,827: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:22:06,927: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687ac18>]}
2018-02-13 16:22:07,180: 16:22:07 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.78s]
2018-02-13 16:22:07,181: 16:22:07 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:22:07,181: 16:22:07 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:22:07,182: Compiling model.seo_audit.ga_proc
2018-02-13 16:22:07,182: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:22:07,193: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:22:07,195: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:22:07,197: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:22:07,198: Re-using an available connection from the pool.
2018-02-13 16:22:07,199: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:22:07,199: Re-using an available connection from the pool.
2018-02-13 16:22:07,875: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:22:07,904: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:22:10,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108cb63c8>]}
2018-02-13 16:22:10,121: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106955240>]}
2018-02-13 16:22:10,308: 16:22:10 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.88s]
2018-02-13 16:22:10,539: 16:22:10 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.94s]
2018-02-13 16:22:10,540: 16:22:10 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:22:10,541: Compiling model.seo_audit.agg_indicative
2018-02-13 16:22:10,550: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:22:10,551: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:22:10,552: Re-using an available connection from the pool.
2018-02-13 16:22:11,240: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:22:13,414: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687ac18>]}
2018-02-13 16:22:13,655: 16:22:13 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.87s]
2018-02-13 16:22:13,656: 16:22:13 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:22:13,656: Compiling model.seo_audit.ga_stats
2018-02-13 16:22:13,666: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:22:13,667: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:22:13,667: Re-using an available connection from the pool.
2018-02-13 16:22:14,423: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:22:16,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106888eb8>]}
2018-02-13 16:22:17,244: 16:22:17 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.94s]
2018-02-13 16:22:17,244: 16:22:17 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:22:17,245: Compiling model.seo_audit.agg_stats
2018-02-13 16:22:17,258: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:22:17,259: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:22:17,259: Re-using an available connection from the pool.
2018-02-13 16:22:18,103: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:22:20,279: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687ac18>]}
2018-02-13 16:22:20,519: 16:22:20 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.03s]
2018-02-13 16:22:20,520: 16:22:20 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:22:20,521: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:22:20,530: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:22:20,531: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:22:20,531: Re-using an available connection from the pool.
2018-02-13 16:22:21,278: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:22:23,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106888eb8>]}
2018-02-13 16:22:23,690: 16:22:23 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.92s]
2018-02-13 16:22:23,691: 16:22:23 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:22:23,691: Compiling model.seo_audit.agg_all
2018-02-13 16:22:23,702: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:22:23,703: Acquiring new bigquery connection "agg_all".
2018-02-13 16:22:23,703: Re-using an available connection from the pool.
2018-02-13 16:22:24,451: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:22:27,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10687ac18>]}
2018-02-13 16:22:27,971: 16:22:27 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.02s]
2018-02-13 16:22:27,972: 16:22:27 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:22:27,972: Compiling model.seo_audit.actions
2018-02-13 16:22:27,984: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:22:27,985: Acquiring new bigquery connection "actions".
2018-02-13 16:22:27,985: Re-using an available connection from the pool.
2018-02-13 16:22:28,650: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when a.gsc_impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:22:29,723: Bad request while running:
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
redirected_to_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when a.gsc_impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:22:29,724: 400 Duplicate column names in the result are not supported. Found duplicate(s): redirected_to_url
2018-02-13 16:22:29,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff2d1710-f3b5-47db-99eb-2de228c70836', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106888048>]}
2018-02-13 16:22:29,960: 16:22:29 | 42 of 42 ERROR creating table model seo_audit.actions................ [ERROR in 1.75s]
2018-02-13 16:22:30,049: 16:22:30 | 
2018-02-13 16:22:30,049: 16:22:30 | Finished running 42 table models in 78.40s.
2018-02-13 16:22:30,050: Connection 'master' was left open.
2018-02-13 16:22:30,050: 
2018-02-13 16:22:30,050: Completed with 1 errors:
2018-02-13 16:22:30,050: 
2018-02-13 16:22:30,051: Database Error in model actions (models/actions/actions.sql)
2018-02-13 16:22:30,051:   Duplicate column names in the result are not supported. Found duplicate(s): redirected_to_url
2018-02-13 16:22:30,051:   compiled SQL at target/compiled/seo_audit/actions/actions.sql
2018-02-13 16:22:30,052: 
Done. PASS=41 ERROR=1 SKIP=0 TOTAL=42
2018-02-13 16:22:30,052: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2668>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2cf8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c2390>]}
2018-02-13 16:22:30,296: Flushing usage events
2018-02-13 16:23:40,119: Tracking: tracking
2018-02-13 16:23:40,119: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107759ba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107759860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107759828>]}
2018-02-13 16:23:40,815: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-13 16:23:40,829: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-13 16:23:40,830: Parsing core.sql
2018-02-13 16:23:40,842: Parsing adapters/bigquery.sql
2018-02-13 16:23:40,846: Parsing adapters/common.sql
2018-02-13 16:23:40,860: Parsing adapters/postgres.sql
2018-02-13 16:23:40,863: Parsing adapters/redshift.sql
2018-02-13 16:23:40,880: Parsing etc/get_custom_schema.sql
2018-02-13 16:23:40,885: Parsing materializations/archive.sql
2018-02-13 16:23:40,917: Parsing materializations/bigquery.sql
2018-02-13 16:23:40,933: Parsing materializations/helpers.sql
2018-02-13 16:23:40,950: Parsing materializations/incremental.sql
2018-02-13 16:23:40,979: Parsing materializations/table.sql
2018-02-13 16:23:40,998: Parsing materializations/view.sql
2018-02-13 16:23:41,016: Parsing materializations/wrapper.sql
2018-02-13 16:23:41,019: Parsing schema_tests/accepted_values.sql
2018-02-13 16:23:41,022: Parsing schema_tests/not_null.sql
2018-02-13 16:23:41,024: Parsing schema_tests/relationships.sql
2018-02-13 16:23:41,028: Parsing schema_tests/unique.sql
2018-02-13 16:23:41,037: Parsing model.seo_audit.actions
2018-02-13 16:23:41,042: Acquiring new bigquery connection "master".
2018-02-13 16:23:41,042: Opening a new connection (0 currently allocated)
2018-02-13 16:23:41,044: Parsing model.seo_audit.accounts_proc
2018-02-13 16:23:41,046: Parsing model.seo_audit.all_dates
2018-02-13 16:23:41,047: Parsing model.seo_audit.mappings_ga_proc
2018-02-13 16:23:41,050: Parsing model.seo_audit.agg_all
2018-02-13 16:23:41,052: Parsing model.seo_audit.agg_indicative
2018-02-13 16:23:41,055: Parsing model.seo_audit.agg_stats
2018-02-13 16:23:41,062: Parsing model.seo_audit.agg_stats_client
2018-02-13 16:23:41,065: Parsing model.seo_audit.deepcrawl_class
2018-02-13 16:23:41,067: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:23:41,069: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:23:41,070: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:23:41,073: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:23:41,075: Parsing model.seo_audit.deepcrawl_proc
2018-02-13 16:23:41,077: Parsing model.seo_audit.deepcrawl_reclass
2018-02-13 16:23:41,081: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:23:41,087: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:23:41,090: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:23:41,091: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:23:41,094: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:23:41,096: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:23:41,098: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:23:41,099: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-13 16:23:41,103: Parsing model.seo_audit.ga_proc
2018-02-13 16:23:41,106: Parsing model.seo_audit.ga_proc_pageviews
2018-02-13 16:23:41,109: Parsing model.seo_audit.ga_stats
2018-02-13 16:23:41,112: Parsing model.seo_audit.majestic_domain_history
2018-02-13 16:23:41,114: Parsing model.seo_audit.majestic_domain_proc
2018-02-13 16:23:41,117: Parsing model.seo_audit.majestic_domain_stats
2018-02-13 16:23:41,119: Parsing model.seo_audit.moz_proc
2018-02-13 16:23:41,122: Parsing model.seo_audit.screamingfrog_proc
2018-02-13 16:23:41,125: Parsing model.seo_audit.search_console_history
2018-02-13 16:23:41,127: Parsing model.seo_audit.search_console_proc
2018-02-13 16:23:41,130: Parsing model.seo_audit.search_console_stats_keyword
2018-02-13 16:23:41,133: Parsing model.seo_audit.search_console_stats_url
2018-02-13 16:23:41,135: Parsing model.seo_audit.semrush_domain_proc
2018-02-13 16:23:41,138: Parsing model.seo_audit.semrush_keyword_history
2018-02-13 16:23:41,141: Parsing model.seo_audit.semrush_keyword_proc
2018-02-13 16:23:41,144: Parsing model.seo_audit.semrush_keyword_stats
2018-02-13 16:23:41,146: Parsing model.seo_audit.semrush_url_history
2018-02-13 16:23:41,148: Parsing model.seo_audit.semrush_url_stats
2018-02-13 16:23:41,150: Parsing model.seo_audit.sitemap_proc
2018-02-13 16:23:41,164: Found 42 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-13 16:23:41,176: 
2018-02-13 16:23:42,027: 16:23:42 | Concurrency: 4 threads (target='prod')
2018-02-13 16:23:42,027: 16:23:42 | 
2018-02-13 16:23:42,390: 16:23:42 | 1 of 42 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-13 16:23:42,390: Compiling model.seo_audit.deepcrawl_proc
2018-02-13 16:23:42,395: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-13 16:23:42,390: 16:23:42 | 2 of 42 START table model seo_audit.all_dates........................ [RUN]
2018-02-13 16:23:42,396: Compiling model.seo_audit.all_dates
2018-02-13 16:23:42,399: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-13 16:23:42,390: 16:23:42 | 3 of 42 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-13 16:23:42,400: Compiling model.seo_audit.accounts_proc
2018-02-13 16:23:42,404: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-13 16:23:42,405: Acquiring new bigquery connection "all_dates".
2018-02-13 16:23:42,406: Opening a new connection (1 currently allocated)
2018-02-13 16:23:42,406: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-13 16:23:42,409: Acquiring new bigquery connection "accounts_proc".
2018-02-13 16:23:42,410: Opening a new connection (2 currently allocated)
2018-02-13 16:23:42,465: Opening a new connection (3 currently allocated)
2018-02-13 16:23:43,396: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-13 16:23:43,437: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-13 16:23:43,497: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-13 16:23:44,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ed048>]}
2018-02-13 16:23:44,714: 16:23:44 | 2 of 42 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.08s]
2018-02-13 16:23:45,597: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078eda20>]}
2018-02-13 16:23:45,672: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:23:45,837: 16:23:45 | 3 of 42 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.20s]
2018-02-13 16:23:46,072: 16:23:46 | 1 of 42 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.28s]
2018-02-13 16:23:46,073: 16:23:46 | 4 of 42 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-13 16:23:46,074: Compiling model.seo_audit.screamingfrog_proc
2018-02-13 16:23:46,073: 16:23:46 | 5 of 42 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-13 16:23:46,081: Compiling model.seo_audit.semrush_keyword_proc
2018-02-13 16:23:46,087: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-13 16:23:46,089: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-13 16:23:46,074: 16:23:46 | 6 of 42 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-13 16:23:46,074: 16:23:46 | 7 of 42 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-13 16:23:46,090: Compiling model.seo_audit.mappings_ga_proc
2018-02-13 16:23:46,090: Compiling model.seo_audit.search_console_proc
2018-02-13 16:23:46,095: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-13 16:23:46,101: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-13 16:23:46,103: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-13 16:23:46,103: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-13 16:23:46,104: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-13 16:23:46,104: Re-using an available connection from the pool.
2018-02-13 16:23:46,105: Acquiring new bigquery connection "search_console_proc".
2018-02-13 16:23:46,105: Re-using an available connection from the pool.
2018-02-13 16:23:46,107: Re-using an available connection from the pool.
2018-02-13 16:23:46,107: Opening a new connection (4 currently allocated)
2018-02-13 16:23:46,775: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-13 16:23:46,788: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:23:46,809: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-13 16:23:47,472: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-13 16:23:48,963: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107826b38>]}
2018-02-13 16:23:48,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10784b048>]}
2018-02-13 16:23:49,211: 16:23:49 | 6 of 42 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.87s]
2018-02-13 16:23:49,213: 16:23:49 | 8 of 42 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-13 16:23:49,214: Compiling model.seo_audit.majestic_domain_proc
2018-02-13 16:23:49,223: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-13 16:23:49,226: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-13 16:23:49,226: Re-using an available connection from the pool.
2018-02-13 16:23:49,565: 16:23:49 | 4 of 42 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.90s]
2018-02-13 16:23:49,566: 16:23:49 | 9 of 42 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-13 16:23:49,566: Compiling model.seo_audit.sitemap_proc
2018-02-13 16:23:49,576: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-13 16:23:49,577: Acquiring new bigquery connection "sitemap_proc".
2018-02-13 16:23:49,577: Re-using an available connection from the pool.
2018-02-13 16:23:49,930: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-13 16:23:50,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:23:50,272: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-13 16:23:50,297: 16:23:50 | 5 of 42 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 3.96s]
2018-02-13 16:23:50,297: 16:23:50 | 10 of 42 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-13 16:23:50,298: Compiling model.seo_audit.semrush_domain_proc
2018-02-13 16:23:50,304: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-13 16:23:50,305: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-13 16:23:50,305: Re-using an available connection from the pool.
2018-02-13 16:23:50,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10795ceb8>]}
2018-02-13 16:23:50,921: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:23:51,081: 16:23:51 | 7 of 42 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 4.74s]
2018-02-13 16:23:51,081: 16:23:51 | 11 of 42 START table model seo_audit.moz_proc........................ [RUN]
2018-02-13 16:23:51,082: Compiling model.seo_audit.moz_proc
2018-02-13 16:23:51,090: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-13 16:23:51,090: Acquiring new bigquery connection "moz_proc".
2018-02-13 16:23:51,090: Re-using an available connection from the pool.
2018-02-13 16:23:51,710: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-13 16:23:52,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107826b38>]}
2018-02-13 16:23:52,379: 16:23:52 | 8 of 42 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.90s]
2018-02-13 16:23:53,097: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:23:53,340: 16:23:53 | 10 of 42 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.80s]
2018-02-13 16:23:53,668: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10784b048>]}
2018-02-13 16:23:53,902: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10795ceb8>]}
2018-02-13 16:23:53,974: 16:23:53 | 9 of 42 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.10s]
2018-02-13 16:23:54,244: 16:23:54 | 11 of 42 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 2.82s]
2018-02-13 16:23:54,245: 16:23:54 | 12 of 42 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-13 16:23:54,246: Compiling model.seo_audit.semrush_keyword_history
2018-02-13 16:23:54,245: 16:23:54 | 13 of 42 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-13 16:23:54,252: Compiling model.seo_audit.majestic_domain_history
2018-02-13 16:23:54,258: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-13 16:23:54,260: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-13 16:23:54,245: 16:23:54 | 14 of 42 START table model seo_audit.search_console_history.......... [RUN]
2018-02-13 16:23:54,245: 16:23:54 | 15 of 42 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-13 16:23:54,260: Compiling model.seo_audit.search_console_history
2018-02-13 16:23:54,261: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-13 16:23:54,265: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-13 16:23:54,266: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-13 16:23:54,273: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-13 16:23:54,273: Acquiring new bigquery connection "majestic_domain_history".
2018-02-13 16:23:54,274: Re-using an available connection from the pool.
2018-02-13 16:23:54,275: Acquiring new bigquery connection "search_console_history".
2018-02-13 16:23:54,276: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-13 16:23:54,276: Re-using an available connection from the pool.
2018-02-13 16:23:54,278: Re-using an available connection from the pool.
2018-02-13 16:23:54,280: Re-using an available connection from the pool.
2018-02-13 16:23:54,976: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-13 16:23:55,033: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-13 16:23:55,125: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-13 16:23:55,272: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-13 16:23:56,495: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079434e0>]}
2018-02-13 16:23:56,740: 16:23:56 | 12 of 42 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.25s]
2018-02-13 16:23:56,740: 16:23:56 | 16 of 42 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-13 16:23:56,741: Compiling model.seo_audit.semrush_url_history
2018-02-13 16:23:56,748: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-13 16:23:56,749: Acquiring new bigquery connection "semrush_url_history".
2018-02-13 16:23:56,749: Re-using an available connection from the pool.
2018-02-13 16:23:57,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107953518>]}
2018-02-13 16:23:57,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107942cc0>]}
2018-02-13 16:23:58,090: 16:23:58 | 15 of 42 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.56s]
2018-02-13 16:23:58,270: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-13 16:23:58,321: 16:23:58 | 14 of 42 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.68s]
2018-02-13 16:23:58,982: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107928cf8>]}
2018-02-13 16:23:59,210: 16:23:59 | 13 of 42 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 4.73s]
2018-02-13 16:24:00,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079434e0>]}
2018-02-13 16:24:00,684: 16:24:00 | 16 of 42 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.70s]
2018-02-13 16:24:00,685: 16:24:00 | 17 of 42 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-13 16:24:00,686: 16:24:00 | 18 of 42 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-13 16:24:00,686: Compiling model.seo_audit.search_console_stats_keyword
2018-02-13 16:24:00,686: 16:24:00 | 19 of 42 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-13 16:24:00,686: Compiling model.seo_audit.deepcrawl_class
2018-02-13 16:24:00,693: Compiling model.seo_audit.search_console_stats_url
2018-02-13 16:24:00,697: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-13 16:24:00,708: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-13 16:24:00,712: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-13 16:24:00,713: Acquiring new bigquery connection "search_console_stats_url".
2018-02-13 16:24:00,713: Re-using an available connection from the pool.
2018-02-13 16:24:00,714: Acquiring new bigquery connection "deepcrawl_class".
2018-02-13 16:24:00,716: Re-using an available connection from the pool.
2018-02-13 16:24:00,716: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-13 16:24:00,717: Re-using an available connection from the pool.
2018-02-13 16:24:01,429: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-13 16:24:01,431: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-13 16:24:01,439: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-13 16:24:03,608: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ccada0>]}
2018-02-13 16:24:03,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078937b8>]}
2018-02-13 16:24:03,626: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cad518>]}
2018-02-13 16:24:03,851: 16:24:03 | 18 of 42 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.92s]
2018-02-13 16:24:04,102: 16:24:04 | 17 of 42 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.93s]
2018-02-13 16:24:04,328: 16:24:04 | 19 of 42 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.93s]
2018-02-13 16:24:04,329: 16:24:04 | 20 of 42 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-13 16:24:04,329: 16:24:04 | 21 of 42 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-13 16:24:04,330: 16:24:04 | 22 of 42 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-13 16:24:04,330: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-13 16:24:04,330: 16:24:04 | 23 of 42 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-13 16:24:04,331: Compiling model.seo_audit.semrush_url_stats
2018-02-13 16:24:04,331: Compiling model.seo_audit.majestic_domain_stats
2018-02-13 16:24:04,338: Compiling model.seo_audit.semrush_keyword_stats
2018-02-13 16:24:04,340: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-13 16:24:04,345: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-13 16:24:04,350: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-13 16:24:04,355: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-13 16:24:04,356: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-13 16:24:04,356: Re-using an available connection from the pool.
2018-02-13 16:24:04,359: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-13 16:24:04,359: Re-using an available connection from the pool.
2018-02-13 16:24:04,361: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-13 16:24:04,361: Re-using an available connection from the pool.
2018-02-13 16:24:04,364: Acquiring new bigquery connection "semrush_url_stats".
2018-02-13 16:24:04,364: Re-using an available connection from the pool.
2018-02-13 16:24:05,120: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:24:05,121: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-13 16:24:05,121: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-13 16:24:05,122: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-13 16:24:07,283: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ea780>]}
2018-02-13 16:24:07,285: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ccae10>]}
2018-02-13 16:24:07,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078cd668>]}
2018-02-13 16:24:07,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104355cf8>]}
2018-02-13 16:24:07,534: 16:24:07 | 21 of 42 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.95s]
2018-02-13 16:24:07,790: 16:24:07 | 23 of 42 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.95s]
2018-02-13 16:24:08,039: 16:24:08 | 20 of 42 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.96s]
2018-02-13 16:24:08,293: 16:24:08 | 22 of 42 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.99s]
2018-02-13 16:24:08,294: 16:24:08 | 24 of 42 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-13 16:24:08,295: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-13 16:24:08,300: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-13 16:24:08,294: 16:24:08 | 25 of 42 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-13 16:24:08,300: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-13 16:24:08,306: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-13 16:24:08,294: 16:24:08 | 26 of 42 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-13 16:24:08,307: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-13 16:24:08,295: 16:24:08 | 27 of 42 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-13 16:24:08,308: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-13 16:24:08,307: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-13 16:24:08,308: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-13 16:24:08,307: Re-using an available connection from the pool.
2018-02-13 16:24:08,316: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-13 16:24:08,327: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-13 16:24:08,334: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-13 16:24:08,334: Re-using an available connection from the pool.
2018-02-13 16:24:08,338: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-13 16:24:08,339: Re-using an available connection from the pool.
2018-02-13 16:24:08,348: Re-using an available connection from the pool.
2018-02-13 16:24:09,119: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:24:09,127: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-13 16:24:09,203: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-13 16:24:09,261: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:24:10,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ea128>]}
2018-02-13 16:24:10,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078937b8>]}
2018-02-13 16:24:10,431: 16:24:10 | 24 of 42 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.90s]
2018-02-13 16:24:10,432: 16:24:10 | 28 of 42 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-13 16:24:10,433: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-13 16:24:10,440: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-13 16:24:10,443: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-13 16:24:10,443: Re-using an available connection from the pool.
2018-02-13 16:24:10,697: 16:24:10 | 25 of 42 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.92s]
2018-02-13 16:24:10,697: 16:24:10 | 29 of 42 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-13 16:24:10,697: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-13 16:24:10,706: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-13 16:24:10,707: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-13 16:24:10,707: Re-using an available connection from the pool.
2018-02-13 16:24:11,118: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-13 16:24:11,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cbc240>]}
2018-02-13 16:24:11,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cad358>]}
2018-02-13 16:24:11,474: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-13 16:24:11,591: 16:24:11 | 27 of 42 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 3.05s]
2018-02-13 16:24:11,814: 16:24:11 | 26 of 42 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 3.12s]
2018-02-13 16:24:12,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ea128>]}
2018-02-13 16:24:12,444: 16:24:12 | 28 of 42 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.76s]
2018-02-13 16:24:12,551: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078937b8>]}
2018-02-13 16:24:12,797: 16:24:12 | 29 of 42 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 1.85s]
2018-02-13 16:24:12,798: 16:24:12 | 30 of 42 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-13 16:24:12,799: 16:24:12 | 31 of 42 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-13 16:24:12,799: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-13 16:24:12,799: 16:24:12 | 32 of 42 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-13 16:24:12,799: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-13 16:24:12,806: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-13 16:24:12,808: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-13 16:24:12,820: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-13 16:24:12,820: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-13 16:24:12,821: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-13 16:24:12,821: Re-using an available connection from the pool.
2018-02-13 16:24:12,824: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-13 16:24:12,824: Re-using an available connection from the pool.
2018-02-13 16:24:12,826: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-13 16:24:12,826: Re-using an available connection from the pool.
2018-02-13 16:24:13,518: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-13 16:24:13,520: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-13 16:24:13,532: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-13 16:24:14,603: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:14,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107942588>]}
2018-02-13 16:24:14,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cbc7f0>]}
2018-02-13 16:24:14,851: 16:24:14 | 30 of 42 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.80s]
2018-02-13 16:24:15,094: 16:24:15 | 32 of 42 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.81s]
2018-02-13 16:24:15,328: 16:24:15 | 31 of 42 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.83s]
2018-02-13 16:24:15,329: 16:24:15 | 33 of 42 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-13 16:24:15,330: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-13 16:24:15,345: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-13 16:24:15,346: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-13 16:24:15,346: Re-using an available connection from the pool.
2018-02-13 16:24:16,172: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-13 16:24:18,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:18,831: 16:24:18 | 33 of 42 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.26s]
2018-02-13 16:24:18,832: 16:24:18 | 34 of 42 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-13 16:24:18,832: Compiling model.seo_audit.deepcrawl_reclass
2018-02-13 16:24:18,841: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-13 16:24:18,842: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-13 16:24:18,842: Re-using an available connection from the pool.
2018-02-13 16:24:19,552: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-13 16:24:20,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920400>]}
2018-02-13 16:24:20,910: 16:24:20 | 34 of 42 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.83s]
2018-02-13 16:24:20,911: 16:24:20 | 35 of 42 START table model seo_audit.ga_proc......................... [RUN]
2018-02-13 16:24:20,911: Compiling model.seo_audit.ga_proc
2018-02-13 16:24:20,911: 16:24:20 | 36 of 42 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-13 16:24:20,918: Compiling model.seo_audit.ga_proc_pageviews
2018-02-13 16:24:20,923: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-13 16:24:20,925: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-13 16:24:20,927: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-13 16:24:20,927: Acquiring new bigquery connection "ga_proc".
2018-02-13 16:24:20,927: Re-using an available connection from the pool.
2018-02-13 16:24:20,928: Re-using an available connection from the pool.
2018-02-13 16:24:21,600: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:24:21,601: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-13 16:24:23,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ccc5f8>]}
2018-02-13 16:24:24,025: 16:24:24 | 36 of 42 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.85s]
2018-02-13 16:24:27,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:27,399: 16:24:27 | 35 of 42 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 6.24s]
2018-02-13 16:24:27,400: 16:24:27 | 37 of 42 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-13 16:24:27,400: Compiling model.seo_audit.agg_indicative
2018-02-13 16:24:27,407: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-13 16:24:27,408: Acquiring new bigquery connection "agg_indicative".
2018-02-13 16:24:27,408: Re-using an available connection from the pool.
2018-02-13 16:24:28,154: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-13 16:24:30,328: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920400>]}
2018-02-13 16:24:30,568: 16:24:30 | 37 of 42 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.93s]
2018-02-13 16:24:30,569: 16:24:30 | 38 of 42 START table model seo_audit.ga_stats........................ [RUN]
2018-02-13 16:24:30,569: Compiling model.seo_audit.ga_stats
2018-02-13 16:24:30,579: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-13 16:24:30,580: Acquiring new bigquery connection "ga_stats".
2018-02-13 16:24:30,580: Re-using an available connection from the pool.
2018-02-13 16:24:31,443: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-13 16:24:33,618: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:33,881: 16:24:33 | 38 of 42 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 3.05s]
2018-02-13 16:24:33,882: 16:24:33 | 39 of 42 START table model seo_audit.agg_stats....................... [RUN]
2018-02-13 16:24:33,882: Compiling model.seo_audit.agg_stats
2018-02-13 16:24:33,893: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-13 16:24:33,893: Acquiring new bigquery connection "agg_stats".
2018-02-13 16:24:33,894: Re-using an available connection from the pool.
2018-02-13 16:24:34,604: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-13 16:24:36,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920400>]}
2018-02-13 16:24:37,080: 16:24:37 | 39 of 42 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.91s]
2018-02-13 16:24:37,081: 16:24:37 | 40 of 42 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-13 16:24:37,081: Compiling model.seo_audit.agg_stats_client
2018-02-13 16:24:37,091: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-13 16:24:37,092: Acquiring new bigquery connection "agg_stats_client".
2018-02-13 16:24:37,092: Re-using an available connection from the pool.
2018-02-13 16:24:37,792: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-13 16:24:39,980: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:40,626: 16:24:40 | 40 of 42 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.90s]
2018-02-13 16:24:40,627: 16:24:40 | 41 of 42 START table model seo_audit.agg_all......................... [RUN]
2018-02-13 16:24:40,627: Compiling model.seo_audit.agg_all
2018-02-13 16:24:40,637: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-13 16:24:40,638: Acquiring new bigquery connection "agg_all".
2018-02-13 16:24:40,638: Re-using an available connection from the pool.
2018-02-13 16:24:41,361: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-13 16:24:44,641: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920400>]}
2018-02-13 16:24:44,887: 16:24:44 | 41 of 42 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.01s]
2018-02-13 16:24:44,888: 16:24:44 | 42 of 42 START table model seo_audit.actions......................... [RUN]
2018-02-13 16:24:44,888: Compiling model.seo_audit.actions
2018-02-13 16:24:44,898: Writing injected SQL for node "model.seo_audit.actions"
2018-02-13 16:24:44,898: Acquiring new bigquery connection "actions".
2018-02-13 16:24:44,898: Re-using an available connection from the pool.
2018-02-13 16:24:45,547: Model SQL (actions):
SELECT
a.date,
client,
sitemap,
found_at_sitemap,
a.url,
domain,
canonical_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when a.gsc_impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
2018-02-13 16:24:47,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fe4f5a3-a544-4f33-9e94-1bede4883ab2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078edc18>]}
2018-02-13 16:24:47,974: 16:24:47 | 42 of 42 OK created table model seo_audit.actions.................... [CREATE TABLE in 2.83s]
2018-02-13 16:24:47,990: 16:24:47 | 
2018-02-13 16:24:47,990: 16:24:47 | Finished running 42 table models in 65.97s.
2018-02-13 16:24:47,991: Connection 'master' was left open.
2018-02-13 16:24:47,991: 
2018-02-13 16:24:47,991: Completed successfully
2018-02-13 16:24:47,991: 
Done. PASS=42 ERROR=0 SKIP=0 TOTAL=42
2018-02-13 16:24:47,992: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10784be48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107826908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078267b8>]}
2018-02-13 16:24:48,260: Flushing usage events
2018-02-14 08:41:30,919: Tracking: tracking
2018-02-14 08:41:30,923: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a12908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a12c18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a12c50>]}
2018-02-14 08:41:31,784: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 08:41:31,816: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 08:41:31,819: Parsing core.sql
2018-02-14 08:41:31,854: Parsing adapters/bigquery.sql
2018-02-14 08:41:31,868: Parsing adapters/common.sql
2018-02-14 08:41:31,896: Parsing adapters/postgres.sql
2018-02-14 08:41:31,905: Parsing adapters/redshift.sql
2018-02-14 08:41:31,934: Parsing etc/get_custom_schema.sql
2018-02-14 08:41:31,946: Parsing materializations/archive.sql
2018-02-14 08:41:31,988: Parsing materializations/bigquery.sql
2018-02-14 08:41:32,006: Parsing materializations/helpers.sql
2018-02-14 08:41:32,025: Parsing materializations/incremental.sql
2018-02-14 08:41:32,053: Parsing materializations/table.sql
2018-02-14 08:41:32,074: Parsing materializations/view.sql
2018-02-14 08:41:32,090: Parsing materializations/wrapper.sql
2018-02-14 08:41:32,096: Parsing schema_tests/accepted_values.sql
2018-02-14 08:41:32,102: Parsing schema_tests/not_null.sql
2018-02-14 08:41:32,107: Parsing schema_tests/relationships.sql
2018-02-14 08:41:32,112: Parsing schema_tests/unique.sql
2018-02-14 08:41:32,278: Parsing model.seo_audit.actions
2018-02-14 08:41:32,286: Acquiring new bigquery connection "master".
2018-02-14 08:41:32,287: Opening a new connection (0 currently allocated)
2018-02-14 08:41:32,291: Parsing model.seo_audit.dates
2018-02-14 08:41:32,293: Parsing model.seo_audit.accounts_proc
2018-02-14 08:41:32,296: Parsing model.seo_audit.all_dates
2018-02-14 08:41:32,297: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 08:41:32,299: Parsing model.seo_audit.agg_all
2018-02-14 08:41:32,302: Parsing model.seo_audit.agg_indicative
2018-02-14 08:41:32,305: Parsing model.seo_audit.agg_stats
2018-02-14 08:41:32,311: Parsing model.seo_audit.agg_stats_client
2018-02-14 08:41:32,313: Parsing model.seo_audit.deepcrawl_class
2018-02-14 08:41:32,315: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:41:32,317: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:41:32,319: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:41:32,320: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:41:32,323: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 08:41:32,325: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 08:41:32,327: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:41:32,334: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:41:32,337: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:41:32,338: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:41:32,340: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:41:32,341: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:41:32,343: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:41:32,345: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 08:41:32,348: Parsing model.seo_audit.ga_proc
2018-02-14 08:41:32,351: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 08:41:32,354: Parsing model.seo_audit.ga_stats
2018-02-14 08:41:32,356: Parsing model.seo_audit.majestic_domain_history
2018-02-14 08:41:32,358: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 08:41:32,361: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 08:41:32,363: Parsing model.seo_audit.moz_proc
2018-02-14 08:41:32,365: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 08:41:32,368: Parsing model.seo_audit.search_console_history
2018-02-14 08:41:32,370: Parsing model.seo_audit.search_console_proc
2018-02-14 08:41:32,372: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 08:41:32,375: Parsing model.seo_audit.search_console_stats_url
2018-02-14 08:41:32,376: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 08:41:32,379: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 08:41:32,381: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 08:41:32,384: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 08:41:32,386: Parsing model.seo_audit.semrush_url_history
2018-02-14 08:41:32,388: Parsing model.seo_audit.semrush_url_stats
2018-02-14 08:41:32,390: Parsing model.seo_audit.sitemap_proc
2018-02-14 08:41:32,403: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 08:41:32,416: 
2018-02-14 08:41:33,577: 08:41:33 | Concurrency: 4 threads (target='prod')
2018-02-14 08:41:33,577: 08:41:33 | 
2018-02-14 08:41:33,937: 08:41:33 | 1 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 08:41:33,937: 08:41:33 | 2 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 08:41:33,938: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 08:41:33,938: 08:41:33 | 3 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 08:41:33,939: Compiling model.seo_audit.all_dates
2018-02-14 08:41:33,949: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 08:41:33,949: Compiling model.seo_audit.accounts_proc
2018-02-14 08:41:33,956: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 08:41:33,963: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 08:41:33,965: Acquiring new bigquery connection "all_dates".
2018-02-14 08:41:33,966: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 08:41:33,966: Acquiring new bigquery connection "accounts_proc".
2018-02-14 08:41:33,967: Opening a new connection (1 currently allocated)
2018-02-14 08:41:33,970: Opening a new connection (2 currently allocated)
2018-02-14 08:41:34,038: Opening a new connection (3 currently allocated)
2018-02-14 08:41:35,073: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 08:41:35,086: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 08:41:35,144: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 08:41:36,178: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c4ff98>]}
2018-02-14 08:41:36,841: 08:41:36 | 2 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.24s]
2018-02-14 08:41:37,289: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c82e48>]}
2018-02-14 08:41:37,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c592e8>]}
2018-02-14 08:41:37,595: 08:41:37 | 1 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.35s]
2018-02-14 08:41:37,808: 08:41:37 | 3 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.37s]
2018-02-14 08:41:37,809: 08:41:37 | 4 of 43 START table model seo_audit.moz_proc......................... [RUN]
2018-02-14 08:41:37,810: Compiling model.seo_audit.moz_proc
2018-02-14 08:41:37,809: 08:41:37 | 5 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 08:41:37,816: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 08:41:37,809: 08:41:37 | 6 of 43 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-14 08:41:37,828: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 08:41:37,832: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 08:41:37,809: 08:41:37 | 7 of 43 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-14 08:41:37,832: Compiling model.seo_audit.majestic_domain_proc
2018-02-14 08:41:37,833: Compiling model.seo_audit.screamingfrog_proc
2018-02-14 08:41:37,844: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-14 08:41:37,856: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-14 08:41:37,858: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 08:41:37,859: Acquiring new bigquery connection "moz_proc".
2018-02-14 08:41:37,859: Re-using an available connection from the pool.
2018-02-14 08:41:37,861: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-14 08:41:37,863: Re-using an available connection from the pool.
2018-02-14 08:41:37,865: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-14 08:41:37,869: Re-using an available connection from the pool.
2018-02-14 08:41:37,872: Opening a new connection (4 currently allocated)
2018-02-14 08:41:38,517: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:41:38,581: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-14 08:41:38,610: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:41:39,031: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-14 08:41:40,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c86ef0>]}
2018-02-14 08:41:40,725: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c4f940>]}
2018-02-14 08:41:40,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6d16a0>]}
2018-02-14 08:41:40,982: 08:41:40 | 5 of 43 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.86s]
2018-02-14 08:41:40,983: 08:41:40 | 8 of 43 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-14 08:41:40,985: Compiling model.seo_audit.search_console_proc
2018-02-14 08:41:40,996: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-14 08:41:41,000: Acquiring new bigquery connection "search_console_proc".
2018-02-14 08:41:41,000: Re-using an available connection from the pool.
2018-02-14 08:41:41,260: 08:41:41 | 6 of 43 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.89s]
2018-02-14 08:41:41,261: 08:41:41 | 9 of 43 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-14 08:41:41,263: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 08:41:41,275: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 08:41:41,277: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 08:41:41,277: Re-using an available connection from the pool.
2018-02-14 08:41:41,481: 08:41:41 | 4 of 43 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.95s]
2018-02-14 08:41:41,482: 08:41:41 | 10 of 43 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-14 08:41:41,482: Compiling model.seo_audit.sitemap_proc
2018-02-14 08:41:41,492: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 08:41:41,496: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 08:41:41,496: Re-using an available connection from the pool.
2018-02-14 08:41:41,891: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:41:42,209: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:41:42,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4c18>]}
2018-02-14 08:41:42,488: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-14 08:41:42,711: 08:41:42 | 7 of 43 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.59s]
2018-02-14 08:41:42,711: 08:41:42 | 11 of 43 START table model seo_audit.mappings_ga_proc................ [RUN]
2018-02-14 08:41:42,712: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 08:41:42,722: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 08:41:42,726: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 08:41:42,726: Re-using an available connection from the pool.
2018-02-14 08:41:43,389: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 08:41:44,120: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bb8240>]}
2018-02-14 08:41:44,437: 08:41:44 | 8 of 43 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.14s]
2018-02-14 08:41:44,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110cbdd68>]}
2018-02-14 08:41:44,665: 08:41:44 | 9 of 43 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.19s]
2018-02-14 08:41:45,558: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4c18>]}
2018-02-14 08:41:46,013: 08:41:46 | 11 of 43 OK created table model seo_audit.mappings_ga_proc........... [CREATE TABLE in 2.85s]
2018-02-14 08:41:46,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6d16a0>]}
2018-02-14 08:41:47,216: 08:41:47 | 10 of 43 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 5.37s]
2018-02-14 08:41:47,217: 08:41:47 | 12 of 43 START table model seo_audit.search_console_history.......... [RUN]
2018-02-14 08:41:47,217: 08:41:47 | 13 of 43 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-14 08:41:47,218: 08:41:47 | 14 of 43 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-14 08:41:47,218: 08:41:47 | 15 of 43 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-14 08:41:47,218: Compiling model.seo_audit.search_console_history
2018-02-14 08:41:47,218: Compiling model.seo_audit.semrush_url_history
2018-02-14 08:41:47,219: Compiling model.seo_audit.majestic_domain_history
2018-02-14 08:41:47,219: Compiling model.seo_audit.semrush_keyword_history
2018-02-14 08:41:47,232: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-14 08:41:47,237: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-14 08:41:47,237: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-14 08:41:47,243: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-14 08:41:47,244: Acquiring new bigquery connection "search_console_history".
2018-02-14 08:41:47,245: Acquiring new bigquery connection "semrush_url_history".
2018-02-14 08:41:47,246: Acquiring new bigquery connection "majestic_domain_history".
2018-02-14 08:41:47,246: Re-using an available connection from the pool.
2018-02-14 08:41:47,247: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-14 08:41:47,247: Re-using an available connection from the pool.
2018-02-14 08:41:47,248: Re-using an available connection from the pool.
2018-02-14 08:41:47,248: Re-using an available connection from the pool.
2018-02-14 08:41:47,947: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-14 08:41:47,948: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-14 08:41:47,948: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-14 08:41:47,949: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-14 08:41:50,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c3deb8>]}
2018-02-14 08:41:50,135: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59160>]}
2018-02-14 08:41:50,138: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c3d080>]}
2018-02-14 08:41:50,411: 08:41:50 | 14 of 43 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.90s]
2018-02-14 08:41:50,412: 08:41:50 | 16 of 43 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-14 08:41:50,413: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-14 08:41:50,428: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-14 08:41:50,431: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-14 08:41:50,431: Re-using an available connection from the pool.
2018-02-14 08:41:50,639: 08:41:50 | 15 of 43 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.92s]
2018-02-14 08:41:50,885: 08:41:50 | 13 of 43 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 2.92s]
2018-02-14 08:41:51,122: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 08:41:51,248: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bc0d68>]}
2018-02-14 08:41:51,558: 08:41:51 | 12 of 43 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 4.03s]
2018-02-14 08:41:53,297: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c12048>]}
2018-02-14 08:41:53,599: 08:41:53 | 16 of 43 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.88s]
2018-02-14 08:41:53,600: 08:41:53 | 17 of 43 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-14 08:41:53,601: 08:41:53 | 18 of 43 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-14 08:41:53,601: Compiling model.seo_audit.search_console_stats_keyword
2018-02-14 08:41:53,601: 08:41:53 | 19 of 43 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-14 08:41:53,601: Compiling model.seo_audit.search_console_stats_url
2018-02-14 08:41:53,607: Compiling model.seo_audit.deepcrawl_class
2018-02-14 08:41:53,609: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-14 08:41:53,614: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-14 08:41:53,619: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-14 08:41:53,621: Acquiring new bigquery connection "search_console_stats_url".
2018-02-14 08:41:53,622: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-14 08:41:53,623: Acquiring new bigquery connection "deepcrawl_class".
2018-02-14 08:41:53,623: Re-using an available connection from the pool.
2018-02-14 08:41:53,623: Re-using an available connection from the pool.
2018-02-14 08:41:53,624: Re-using an available connection from the pool.
2018-02-14 08:41:54,310: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-14 08:41:54,311: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-14 08:41:54,312: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-14 08:41:56,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59160>]}
2018-02-14 08:41:56,494: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6d16a0>]}
2018-02-14 08:41:56,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112fd4080>]}
2018-02-14 08:41:56,808: 08:41:56 | 19 of 43 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.88s]
2018-02-14 08:41:57,101: 08:41:57 | 17 of 43 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.89s]
2018-02-14 08:41:57,304: 08:41:57 | 18 of 43 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.95s]
2018-02-14 08:41:57,304: 08:41:57 | 20 of 43 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-14 08:41:57,305: 08:41:57 | 21 of 43 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-14 08:41:57,305: 08:41:57 | 22 of 43 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-14 08:41:57,305: 08:41:57 | 23 of 43 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-14 08:41:57,306: Compiling model.seo_audit.majestic_domain_stats
2018-02-14 08:41:57,306: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:41:57,306: Compiling model.seo_audit.semrush_keyword_stats
2018-02-14 08:41:57,306: Compiling model.seo_audit.semrush_url_stats
2018-02-14 08:41:57,323: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-14 08:41:57,323: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-14 08:41:57,324: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-14 08:41:57,328: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-14 08:41:57,330: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-14 08:41:57,331: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-14 08:41:57,331: Re-using an available connection from the pool.
2018-02-14 08:41:57,331: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-14 08:41:57,333: Re-using an available connection from the pool.
2018-02-14 08:41:57,333: Re-using an available connection from the pool.
2018-02-14 08:41:57,334: Acquiring new bigquery connection "semrush_url_stats".
2018-02-14 08:41:57,334: Re-using an available connection from the pool.
2018-02-14 08:41:57,982: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-14 08:41:57,983: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:41:57,983: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-14 08:41:58,012: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:42:00,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c3d9b0>]}
2018-02-14 08:42:00,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c122e8>]}
2018-02-14 08:42:00,200: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59cf8>]}
2018-02-14 08:42:00,446: 08:42:00 | 21 of 43 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.84s]
2018-02-14 08:42:00,747: 08:42:00 | 23 of 43 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.85s]
2018-02-14 08:42:00,953: 08:42:00 | 20 of 43 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.89s]
2018-02-14 08:42:01,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59d68>]}
2018-02-14 08:42:01,566: 08:42:01 | 22 of 43 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 3.95s]
2018-02-14 08:42:01,567: 08:42:01 | 24 of 43 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-14 08:42:01,568: 08:42:01 | 25 of 43 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-14 08:42:01,568: 08:42:01 | 26 of 43 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-14 08:42:01,568: 08:42:01 | 27 of 43 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-14 08:42:01,568: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:42:01,569: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:42:01,569: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:42:01,569: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:42:01,585: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-14 08:42:01,585: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-14 08:42:01,587: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-14 08:42:01,591: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-14 08:42:01,593: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-14 08:42:01,593: Re-using an available connection from the pool.
2018-02-14 08:42:01,593: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-14 08:42:01,595: Re-using an available connection from the pool.
2018-02-14 08:42:01,596: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-14 08:42:01,597: Re-using an available connection from the pool.
2018-02-14 08:42:01,600: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-14 08:42:01,600: Re-using an available connection from the pool.
2018-02-14 08:42:02,203: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:42:02,203: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:42:02,230: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-14 08:42:02,267: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-14 08:42:03,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c824e0>]}
2018-02-14 08:42:03,540: 08:42:03 | 24 of 43 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.75s]
2018-02-14 08:42:03,541: 08:42:03 | 28 of 43 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-14 08:42:03,541: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:42:03,551: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-14 08:42:03,552: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-14 08:42:03,552: Re-using an available connection from the pool.
2018-02-14 08:42:04,390: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c826a0>]}
2018-02-14 08:42:04,411: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c4f7b8>]}
2018-02-14 08:42:04,479: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:42:04,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4c18>]}
2018-02-14 08:42:04,684: 08:42:04 | 26 of 43 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.82s]
2018-02-14 08:42:04,685: 08:42:04 | 29 of 43 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-14 08:42:04,687: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:42:04,697: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-14 08:42:04,699: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-14 08:42:04,699: Re-using an available connection from the pool.
2018-02-14 08:42:04,987: 08:42:04 | 27 of 43 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 2.84s]
2018-02-14 08:42:05,332: 08:42:05 | 25 of 43 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.99s]
2018-02-14 08:42:05,450: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-14 08:42:06,543: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c826a0>]}
2018-02-14 08:42:06,839: 08:42:06 | 29 of 43 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.86s]
2018-02-14 08:42:07,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c4f9b0>]}
2018-02-14 08:42:08,099: 08:42:08 | 28 of 43 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 4.21s]
2018-02-14 08:42:08,100: 08:42:08 | 30 of 43 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-14 08:42:08,101: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:42:08,100: 08:42:08 | 31 of 43 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-14 08:42:08,108: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:42:08,115: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-14 08:42:08,116: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-14 08:42:08,101: 08:42:08 | 32 of 43 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-14 08:42:08,116: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:42:08,121: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-14 08:42:08,122: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-14 08:42:08,122: Re-using an available connection from the pool.
2018-02-14 08:42:08,123: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-14 08:42:08,123: Re-using an available connection from the pool.
2018-02-14 08:42:08,124: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-14 08:42:08,124: Re-using an available connection from the pool.
2018-02-14 08:42:08,868: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-14 08:42:08,915: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-14 08:42:08,961: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-14 08:42:09,955: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4f60>]}
2018-02-14 08:42:10,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c82630>]}
2018-02-14 08:42:10,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59d68>]}
2018-02-14 08:42:10,243: 08:42:10 | 32 of 43 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.84s]
2018-02-14 08:42:10,523: 08:42:10 | 31 of 43 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.89s]
2018-02-14 08:42:10,756: 08:42:10 | 30 of 43 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 2.03s]
2018-02-14 08:42:10,757: 08:42:10 | 33 of 43 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-14 08:42:10,757: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:42:10,770: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-14 08:42:10,771: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-14 08:42:10,771: Re-using an available connection from the pool.
2018-02-14 08:42:11,596: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-14 08:42:14,868: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c4f9b0>]}
2018-02-14 08:42:15,080: 08:42:15 | 33 of 43 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.11s]
2018-02-14 08:42:15,081: 08:42:15 | 34 of 43 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-14 08:42:15,081: Compiling model.seo_audit.deepcrawl_reclass
2018-02-14 08:42:15,090: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-14 08:42:15,091: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-14 08:42:15,091: Re-using an available connection from the pool.
2018-02-14 08:42:15,992: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-14 08:42:17,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c59d68>]}
2018-02-14 08:42:17,376: 08:42:17 | 34 of 43 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.99s]
2018-02-14 08:42:17,377: 08:42:17 | 35 of 43 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-14 08:42:17,377: Compiling model.seo_audit.ga_proc_pageviews
2018-02-14 08:42:17,377: 08:42:17 | 36 of 43 START table model seo_audit.ga_proc......................... [RUN]
2018-02-14 08:42:17,384: Compiling model.seo_audit.ga_proc
2018-02-14 08:42:17,385: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-14 08:42:17,391: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-14 08:42:17,395: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-14 08:42:17,395: Re-using an available connection from the pool.
2018-02-14 08:42:17,396: Acquiring new bigquery connection "ga_proc".
2018-02-14 08:42:17,397: Re-using an available connection from the pool.
2018-02-14 08:42:18,051: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:42:18,052: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:42:20,231: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110cbd710>]}
2018-02-14 08:42:20,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110cbdcc0>]}
2018-02-14 08:42:20,447: 08:42:20 | 36 of 43 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.85s]
2018-02-14 08:42:20,744: 08:42:20 | 35 of 43 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.87s]
2018-02-14 08:42:20,745: 08:42:20 | 37 of 43 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-14 08:42:20,745: Compiling model.seo_audit.agg_indicative
2018-02-14 08:42:20,754: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-14 08:42:20,755: Acquiring new bigquery connection "agg_indicative".
2018-02-14 08:42:20,756: Re-using an available connection from the pool.
2018-02-14 08:42:21,536: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-14 08:42:24,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4c18>]}
2018-02-14 08:42:24,300: 08:42:24 | 37 of 43 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 3.34s]
2018-02-14 08:42:24,301: 08:42:24 | 38 of 43 START table model seo_audit.ga_stats........................ [RUN]
2018-02-14 08:42:24,301: Compiling model.seo_audit.ga_stats
2018-02-14 08:42:24,312: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-14 08:42:24,313: Acquiring new bigquery connection "ga_stats".
2018-02-14 08:42:24,313: Re-using an available connection from the pool.
2018-02-14 08:42:24,932: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-14 08:42:27,106: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4f60>]}
2018-02-14 08:42:27,344: 08:42:27 | 38 of 43 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.80s]
2018-02-14 08:42:27,344: 08:42:27 | 39 of 43 START table model seo_audit.agg_stats....................... [RUN]
2018-02-14 08:42:27,345: Compiling model.seo_audit.agg_stats
2018-02-14 08:42:27,358: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-14 08:42:27,359: Acquiring new bigquery connection "agg_stats".
2018-02-14 08:42:27,359: Re-using an available connection from the pool.
2018-02-14 08:42:28,085: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-14 08:42:30,290: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4c18>]}
2018-02-14 08:42:30,576: 08:42:30 | 39 of 43 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.94s]
2018-02-14 08:42:30,577: 08:42:30 | 40 of 43 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-14 08:42:30,577: Compiling model.seo_audit.agg_stats_client
2018-02-14 08:42:30,587: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-14 08:42:30,588: Acquiring new bigquery connection "agg_stats_client".
2018-02-14 08:42:30,588: Re-using an available connection from the pool.
2018-02-14 08:42:31,361: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-14 08:42:33,519: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110af4f60>]}
2018-02-14 08:42:34,126: 08:42:34 | 40 of 43 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.94s]
2018-02-14 08:42:34,127: 08:42:34 | 41 of 43 START table model seo_audit.agg_all......................... [RUN]
2018-02-14 08:42:34,127: Compiling model.seo_audit.agg_all
2018-02-14 08:42:34,138: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-14 08:42:34,139: Acquiring new bigquery connection "agg_all".
2018-02-14 08:42:34,139: Re-using an available connection from the pool.
2018-02-14 08:42:35,064: Model SQL (agg_all):
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-14 08:42:35,064: Bad request while running:
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-14 08:42:35,064: 400 Name canonical_url not found inside a at [97:11]
2018-02-14 08:42:35,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a026f-3151-48d0-9e4e-dbb4b298f1ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c82e48>]}
2018-02-14 08:42:35,271: 08:42:35 | 41 of 43 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.94s]
2018-02-14 08:42:35,272: 08:42:35 | 42 of 43 SKIP relation seo_audit.dates............................... [SKIP]
2018-02-14 08:42:35,272: 08:42:35 | 43 of 43 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-14 08:42:35,323: 08:42:35 | 
2018-02-14 08:42:35,323: 08:42:35 | Finished running 43 table models in 61.75s.
2018-02-14 08:42:35,323: Connection 'master' was left open.
2018-02-14 08:42:35,323: 
2018-02-14 08:42:35,323: Completed with 1 errors:
2018-02-14 08:42:35,324: 
2018-02-14 08:42:35,324: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-14 08:42:35,324:   Name canonical_url not found inside a at [97:11]
2018-02-14 08:42:35,324:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-14 08:42:35,324: 
Done. PASS=40 ERROR=1 SKIP=2 TOTAL=43
2018-02-14 08:42:35,324: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bce7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110adf860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110adf710>]}
2018-02-14 08:42:35,554: Flushing usage events
2018-02-14 08:55:33,534: Tracking: tracking
2018-02-14 08:55:33,537: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1106782e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110678b70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110678080>]}
2018-02-14 08:55:34,267: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 08:55:34,293: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 08:55:34,297: Parsing core.sql
2018-02-14 08:55:34,325: Parsing adapters/bigquery.sql
2018-02-14 08:55:34,333: Parsing adapters/common.sql
2018-02-14 08:55:34,349: Parsing adapters/postgres.sql
2018-02-14 08:55:34,357: Parsing adapters/redshift.sql
2018-02-14 08:55:34,385: Parsing etc/get_custom_schema.sql
2018-02-14 08:55:34,393: Parsing materializations/archive.sql
2018-02-14 08:55:34,424: Parsing materializations/bigquery.sql
2018-02-14 08:55:34,440: Parsing materializations/helpers.sql
2018-02-14 08:55:34,460: Parsing materializations/incremental.sql
2018-02-14 08:55:34,489: Parsing materializations/table.sql
2018-02-14 08:55:34,513: Parsing materializations/view.sql
2018-02-14 08:55:34,530: Parsing materializations/wrapper.sql
2018-02-14 08:55:34,537: Parsing schema_tests/accepted_values.sql
2018-02-14 08:55:34,544: Parsing schema_tests/not_null.sql
2018-02-14 08:55:34,552: Parsing schema_tests/relationships.sql
2018-02-14 08:55:34,559: Parsing schema_tests/unique.sql
2018-02-14 08:55:34,624: Parsing model.seo_audit.actions
2018-02-14 08:55:34,628: Acquiring new bigquery connection "master".
2018-02-14 08:55:34,628: Opening a new connection (0 currently allocated)
2018-02-14 08:55:34,635: Parsing model.seo_audit.dates
2018-02-14 08:55:34,637: Parsing model.seo_audit.accounts_proc
2018-02-14 08:55:34,640: Parsing model.seo_audit.all_dates
2018-02-14 08:55:34,642: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 08:55:34,644: Parsing model.seo_audit.agg_all
2018-02-14 08:55:34,647: Parsing model.seo_audit.agg_indicative
2018-02-14 08:55:34,650: Parsing model.seo_audit.agg_stats
2018-02-14 08:55:34,654: Parsing model.seo_audit.agg_stats_client
2018-02-14 08:55:34,657: Parsing model.seo_audit.deepcrawl_class
2018-02-14 08:55:34,661: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:55:34,663: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:55:34,665: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:55:34,667: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:55:34,669: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 08:55:34,671: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 08:55:34,673: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:55:34,680: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:55:34,682: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:55:34,683: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:55:34,685: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:55:34,688: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:55:34,691: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:55:34,694: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 08:55:34,699: Parsing model.seo_audit.ga_proc
2018-02-14 08:55:34,702: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 08:55:34,704: Parsing model.seo_audit.ga_stats
2018-02-14 08:55:34,707: Parsing model.seo_audit.majestic_domain_history
2018-02-14 08:55:34,708: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 08:55:34,711: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 08:55:34,713: Parsing model.seo_audit.moz_proc
2018-02-14 08:55:34,716: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 08:55:34,719: Parsing model.seo_audit.search_console_history
2018-02-14 08:55:34,721: Parsing model.seo_audit.search_console_proc
2018-02-14 08:55:34,724: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 08:55:34,726: Parsing model.seo_audit.search_console_stats_url
2018-02-14 08:55:34,728: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 08:55:34,730: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 08:55:34,733: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 08:55:34,736: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 08:55:34,738: Parsing model.seo_audit.semrush_url_history
2018-02-14 08:55:34,741: Parsing model.seo_audit.semrush_url_stats
2018-02-14 08:55:34,743: Parsing model.seo_audit.sitemap_proc
2018-02-14 08:55:34,756: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 08:55:34,769: 
2018-02-14 08:55:35,936: 08:55:35 | Concurrency: 4 threads (target='prod')
2018-02-14 08:55:35,936: 08:55:35 | 
2018-02-14 08:55:36,299: 08:55:36 | 1 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 08:55:36,299: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 08:55:36,304: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 08:55:36,304: 08:55:36 | 2 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 08:55:36,305: Compiling model.seo_audit.all_dates
2018-02-14 08:55:36,309: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 08:55:36,305: 08:55:36 | 3 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 08:55:36,309: Compiling model.seo_audit.accounts_proc
2018-02-14 08:55:36,315: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 08:55:36,318: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 08:55:36,319: Opening a new connection (1 currently allocated)
2018-02-14 08:55:36,319: Acquiring new bigquery connection "accounts_proc".
2018-02-14 08:55:36,320: Acquiring new bigquery connection "all_dates".
2018-02-14 08:55:36,322: Opening a new connection (2 currently allocated)
2018-02-14 08:55:36,386: Opening a new connection (3 currently allocated)
2018-02-14 08:55:37,443: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 08:55:37,516: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 08:55:37,522: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 08:55:38,603: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108d1860>]}
2018-02-14 08:55:38,905: 08:55:38 | 2 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.30s]
2018-02-14 08:55:39,690: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108d1cf8>]}
2018-02-14 08:55:39,946: 08:55:39 | 3 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.38s]
2018-02-14 08:55:49,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110876358>]}
2018-02-14 08:55:49,586: 08:55:49 | 1 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 13.06s]
2018-02-14 08:55:49,587: 08:55:49 | 4 of 43 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-14 08:55:49,588: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 08:55:49,588: 08:55:49 | 5 of 43 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-14 08:55:49,594: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 08:55:49,588: 08:55:49 | 6 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 08:55:49,603: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 08:55:49,604: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 08:55:49,604: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 08:55:49,588: 08:55:49 | 7 of 43 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-14 08:55:49,609: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 08:55:49,609: Compiling model.seo_audit.majestic_domain_proc
2018-02-14 08:55:49,615: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-14 08:55:49,616: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 08:55:49,617: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 08:55:49,617: Re-using an available connection from the pool.
2018-02-14 08:55:49,618: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 08:55:49,618: Re-using an available connection from the pool.
2018-02-14 08:55:49,619: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-14 08:55:49,620: Re-using an available connection from the pool.
2018-02-14 08:55:49,631: Opening a new connection (4 currently allocated)
2018-02-14 08:55:50,208: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 08:55:50,246: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:55:50,277: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:55:50,708: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-14 08:55:52,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110876550>]}
2018-02-14 08:55:52,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110805198>]}
2018-02-14 08:55:52,448: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110839c18>]}
2018-02-14 08:55:52,574: 08:55:52 | 4 of 43 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.78s]
2018-02-14 08:55:52,576: 08:55:52 | 8 of 43 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-14 08:55:52,578: Compiling model.seo_audit.sitemap_proc
2018-02-14 08:55:52,591: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 08:55:52,592: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 08:55:52,592: Re-using an available connection from the pool.
2018-02-14 08:55:52,886: 08:55:52 | 5 of 43 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 2.83s]
2018-02-14 08:55:52,886: 08:55:52 | 9 of 43 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-14 08:55:52,887: Compiling model.seo_audit.screamingfrog_proc
2018-02-14 08:55:52,897: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-14 08:55:52,899: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-14 08:55:52,899: Re-using an available connection from the pool.
2018-02-14 08:55:53,114: 08:55:53 | 6 of 43 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.84s]
2018-02-14 08:55:53,115: 08:55:53 | 10 of 43 START table model seo_audit.moz_proc........................ [RUN]
2018-02-14 08:55:53,115: Compiling model.seo_audit.moz_proc
2018-02-14 08:55:53,125: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 08:55:53,126: Acquiring new bigquery connection "moz_proc".
2018-02-14 08:55:53,127: Re-using an available connection from the pool.
2018-02-14 08:55:53,164: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-14 08:55:53,677: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-14 08:55:53,783: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:55:54,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110761ba8>]}
2018-02-14 08:55:54,370: 08:55:54 | 7 of 43 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 4.45s]
2018-02-14 08:55:54,371: 08:55:54 | 11 of 43 START table model seo_audit.search_console_proc............. [RUN]
2018-02-14 08:55:54,371: Compiling model.seo_audit.search_console_proc
2018-02-14 08:55:54,379: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-14 08:55:54,382: Acquiring new bigquery connection "search_console_proc".
2018-02-14 08:55:54,383: Re-using an available connection from the pool.
2018-02-14 08:55:54,991: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:55:56,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110925978>]}
2018-02-14 08:55:56,709: 08:55:56 | 8 of 43 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 3.82s]
2018-02-14 08:55:56,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110805198>]}
2018-02-14 08:55:57,218: 08:55:57 | 9 of 43 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 4.06s]
2018-02-14 08:55:58,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110761ba8>]}
2018-02-14 08:55:58,569: 08:55:58 | 11 of 43 OK created table model seo_audit.search_console_proc........ [CREATE TABLE in 3.89s]
2018-02-14 08:55:59,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110839c18>]}
2018-02-14 08:55:59,631: 08:55:59 | 10 of 43 OK created table model seo_audit.moz_proc................... [CREATE TABLE in 6.21s]
2018-02-14 08:55:59,632: 08:55:59 | 12 of 43 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-14 08:55:59,633: Compiling model.seo_audit.majestic_domain_history
2018-02-14 08:55:59,632: 08:55:59 | 13 of 43 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-14 08:55:59,639: Compiling model.seo_audit.semrush_url_history
2018-02-14 08:55:59,647: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-14 08:55:59,650: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-14 08:55:59,632: 08:55:59 | 14 of 43 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-14 08:55:59,650: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-14 08:55:59,657: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-14 08:55:59,632: 08:55:59 | 15 of 43 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-14 08:55:59,658: Compiling model.seo_audit.semrush_keyword_history
2018-02-14 08:55:59,664: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-14 08:55:59,664: Acquiring new bigquery connection "semrush_url_history".
2018-02-14 08:55:59,666: Acquiring new bigquery connection "majestic_domain_history".
2018-02-14 08:55:59,666: Re-using an available connection from the pool.
2018-02-14 08:55:59,668: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-14 08:55:59,669: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-14 08:55:59,670: Re-using an available connection from the pool.
2018-02-14 08:55:59,676: Re-using an available connection from the pool.
2018-02-14 08:55:59,678: Re-using an available connection from the pool.
2018-02-14 08:56:00,247: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-14 08:56:00,329: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 08:56:00,329: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-14 08:56:00,361: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-14 08:56:01,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110895860>]}
2018-02-14 08:56:01,563: 08:56:01 | 15 of 43 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 1.68s]
2018-02-14 08:56:01,564: 08:56:01 | 16 of 43 START table model seo_audit.search_console_history.......... [RUN]
2018-02-14 08:56:01,564: Compiling model.seo_audit.search_console_history
2018-02-14 08:56:01,573: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-14 08:56:01,574: Acquiring new bigquery connection "search_console_history".
2018-02-14 08:56:01,574: Re-using an available connection from the pool.
2018-02-14 08:56:02,280: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-14 08:56:02,515: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11074af60>]}
2018-02-14 08:56:02,819: 08:56:02 | 12 of 43 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.88s]
2018-02-14 08:56:03,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3c59e8>]}
2018-02-14 08:56:03,603: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3b4f60>]}
2018-02-14 08:56:03,816: 08:56:03 | 13 of 43 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.96s]
2018-02-14 08:56:04,171: 08:56:04 | 14 of 43 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.95s]
2018-02-14 08:56:04,435: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108d1208>]}
2018-02-14 08:56:04,658: 08:56:04 | 16 of 43 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.87s]
2018-02-14 08:56:04,659: 08:56:04 | 17 of 43 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-14 08:56:04,660: Compiling model.seo_audit.search_console_stats_keyword
2018-02-14 08:56:04,660: 08:56:04 | 18 of 43 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-14 08:56:04,671: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-14 08:56:04,660: 08:56:04 | 19 of 43 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-14 08:56:04,671: Compiling model.seo_audit.deepcrawl_class
2018-02-14 08:56:04,672: Compiling model.seo_audit.search_console_stats_url
2018-02-14 08:56:04,681: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-14 08:56:04,690: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-14 08:56:04,691: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-14 08:56:04,692: Re-using an available connection from the pool.
2018-02-14 08:56:04,693: Acquiring new bigquery connection "search_console_stats_url".
2018-02-14 08:56:04,695: Acquiring new bigquery connection "deepcrawl_class".
2018-02-14 08:56:04,696: Re-using an available connection from the pool.
2018-02-14 08:56:04,704: Re-using an available connection from the pool.
2018-02-14 08:56:05,357: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-14 08:56:05,358: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-14 08:56:05,358: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-14 08:56:06,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110876c88>]}
2018-02-14 08:56:06,668: 08:56:06 | 18 of 43 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 1.77s]
2018-02-14 08:56:07,534: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110839c18>]}
2018-02-14 08:56:07,571: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3c50b8>]}
2018-02-14 08:56:07,738: 08:56:07 | 17 of 43 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.87s]
2018-02-14 08:56:07,951: 08:56:07 | 19 of 43 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.90s]
2018-02-14 08:56:07,952: 08:56:07 | 20 of 43 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-14 08:56:07,953: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:56:07,952: 08:56:07 | 21 of 43 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-14 08:56:07,959: Compiling model.seo_audit.semrush_keyword_stats
2018-02-14 08:56:07,969: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-14 08:56:07,972: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-14 08:56:07,953: 08:56:07 | 22 of 43 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-14 08:56:07,953: 08:56:07 | 23 of 43 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-14 08:56:07,972: Compiling model.seo_audit.semrush_url_stats
2018-02-14 08:56:07,974: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-14 08:56:07,975: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-14 08:56:07,975: Compiling model.seo_audit.majestic_domain_stats
2018-02-14 08:56:07,986: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-14 08:56:07,987: Re-using an available connection from the pool.
2018-02-14 08:56:07,995: Acquiring new bigquery connection "semrush_url_stats".
2018-02-14 08:56:08,002: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-14 08:56:08,003: Re-using an available connection from the pool.
2018-02-14 08:56:08,009: Re-using an available connection from the pool.
2018-02-14 08:56:08,012: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-14 08:56:08,012: Re-using an available connection from the pool.
2018-02-14 08:56:08,737: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:56:08,738: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-14 08:56:08,738: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:56:08,793: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-14 08:56:10,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:10,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110895d68>]}
2018-02-14 08:56:10,923: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3aaf98>]}
2018-02-14 08:56:11,199: 08:56:11 | 21 of 43 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.94s]
2018-02-14 08:56:11,496: 08:56:11 | 22 of 43 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.93s]
2018-02-14 08:56:11,811: 08:56:11 | 23 of 43 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.95s]
2018-02-14 08:56:12,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108d1208>]}
2018-02-14 08:56:12,449: 08:56:12 | 20 of 43 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 4.15s]
2018-02-14 08:56:12,450: 08:56:12 | 24 of 43 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-14 08:56:12,451: 08:56:12 | 25 of 43 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-14 08:56:12,451: 08:56:12 | 26 of 43 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-14 08:56:12,451: 08:56:12 | 27 of 43 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-14 08:56:12,451: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:56:12,452: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:56:12,452: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:56:12,452: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:56:12,459: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-14 08:56:12,464: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-14 08:56:12,468: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-14 08:56:12,472: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-14 08:56:12,474: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-14 08:56:12,475: Re-using an available connection from the pool.
2018-02-14 08:56:12,475: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-14 08:56:12,475: Re-using an available connection from the pool.
2018-02-14 08:56:12,477: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-14 08:56:12,478: Re-using an available connection from the pool.
2018-02-14 08:56:12,480: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-14 08:56:12,480: Re-using an available connection from the pool.
2018-02-14 08:56:13,057: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:56:13,068: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:56:13,069: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-14 08:56:13,095: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-14 08:56:14,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3c5d68>]}
2018-02-14 08:56:14,379: 08:56:14 | 27 of 43 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.70s]
2018-02-14 08:56:14,380: 08:56:14 | 28 of 43 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-14 08:56:14,380: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:56:14,387: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-14 08:56:14,388: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-14 08:56:14,388: Re-using an available connection from the pool.
2018-02-14 08:56:15,080: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-14 08:56:15,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:15,277: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3aa5c0>]}
2018-02-14 08:56:15,363: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3aa1d0>]}
2018-02-14 08:56:15,463: 08:56:15 | 25 of 43 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.77s]
2018-02-14 08:56:15,464: 08:56:15 | 29 of 43 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-14 08:56:15,466: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:56:15,474: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-14 08:56:15,477: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-14 08:56:15,477: Re-using an available connection from the pool.
2018-02-14 08:56:15,703: 08:56:15 | 26 of 43 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 2.82s]
2018-02-14 08:56:15,965: 08:56:15 | 24 of 43 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 2.91s]
2018-02-14 08:56:16,097: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:56:16,162: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110902b00>]}
2018-02-14 08:56:16,402: 08:56:16 | 28 of 43 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.78s]
2018-02-14 08:56:17,175: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:17,411: 08:56:17 | 29 of 43 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.71s]
2018-02-14 08:56:17,412: 08:56:17 | 30 of 43 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-14 08:56:17,412: 08:56:17 | 31 of 43 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-14 08:56:17,412: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:56:17,413: 08:56:17 | 32 of 43 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-14 08:56:17,413: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:56:17,419: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:56:17,420: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-14 08:56:17,424: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-14 08:56:17,429: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-14 08:56:17,430: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-14 08:56:17,430: Re-using an available connection from the pool.
2018-02-14 08:56:17,431: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-14 08:56:17,431: Re-using an available connection from the pool.
2018-02-14 08:56:17,433: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-14 08:56:17,433: Re-using an available connection from the pool.
2018-02-14 08:56:17,992: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-14 08:56:18,007: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-14 08:56:18,080: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-14 08:56:19,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108d1208>]}
2018-02-14 08:56:19,168: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1108957f0>]}
2018-02-14 08:56:19,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110876358>]}
2018-02-14 08:56:19,464: 08:56:19 | 30 of 43 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.75s]
2018-02-14 08:56:19,770: 08:56:19 | 32 of 43 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.75s]
2018-02-14 08:56:19,983: 08:56:19 | 31 of 43 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.83s]
2018-02-14 08:56:19,984: 08:56:19 | 33 of 43 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-14 08:56:19,984: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:56:19,999: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-14 08:56:20,000: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-14 08:56:20,000: Re-using an available connection from the pool.
2018-02-14 08:56:20,712: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-14 08:56:25,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:25,322: 08:56:25 | 33 of 43 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 5.10s]
2018-02-14 08:56:25,323: 08:56:25 | 34 of 43 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-14 08:56:25,323: Compiling model.seo_audit.deepcrawl_reclass
2018-02-14 08:56:25,330: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-14 08:56:25,331: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-14 08:56:25,332: Re-using an available connection from the pool.
2018-02-14 08:56:26,037: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-14 08:56:30,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3b4eb8>]}
2018-02-14 08:56:30,551: 08:56:30 | 34 of 43 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 5.01s]
2018-02-14 08:56:30,551: 08:56:30 | 35 of 43 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-14 08:56:30,552: Compiling model.seo_audit.ga_proc_pageviews
2018-02-14 08:56:30,558: 08:56:30 | 36 of 43 START table model seo_audit.ga_proc......................... [RUN]
2018-02-14 08:56:30,560: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-14 08:56:30,560: Compiling model.seo_audit.ga_proc
2018-02-14 08:56:30,565: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-14 08:56:30,567: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-14 08:56:30,567: Acquiring new bigquery connection "ga_proc".
2018-02-14 08:56:30,567: Re-using an available connection from the pool.
2018-02-14 08:56:30,568: Re-using an available connection from the pool.
2018-02-14 08:56:31,165: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:56:31,226: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:56:33,388: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:34,413: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d384d68>]}
2018-02-14 08:56:34,482: 08:56:34 | 35 of 43 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 2.84s]
2018-02-14 08:56:34,775: 08:56:34 | 36 of 43 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.85s]
2018-02-14 08:56:34,775: 08:56:34 | 37 of 43 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-14 08:56:34,776: Compiling model.seo_audit.agg_indicative
2018-02-14 08:56:34,783: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-14 08:56:34,784: Acquiring new bigquery connection "agg_indicative".
2018-02-14 08:56:34,784: Re-using an available connection from the pool.
2018-02-14 08:56:35,469: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-14 08:56:37,643: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3b4eb8>]}
2018-02-14 08:56:37,886: 08:56:37 | 37 of 43 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.87s]
2018-02-14 08:56:37,887: 08:56:37 | 38 of 43 START table model seo_audit.ga_stats........................ [RUN]
2018-02-14 08:56:37,887: Compiling model.seo_audit.ga_stats
2018-02-14 08:56:37,896: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-14 08:56:37,897: Acquiring new bigquery connection "ga_stats".
2018-02-14 08:56:37,898: Re-using an available connection from the pool.
2018-02-14 08:56:38,544: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-14 08:56:40,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:40,943: 08:56:40 | 38 of 43 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.83s]
2018-02-14 08:56:40,944: 08:56:40 | 39 of 43 START table model seo_audit.agg_stats....................... [RUN]
2018-02-14 08:56:40,944: Compiling model.seo_audit.agg_stats
2018-02-14 08:56:40,955: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-14 08:56:40,955: Acquiring new bigquery connection "agg_stats".
2018-02-14 08:56:40,955: Re-using an available connection from the pool.
2018-02-14 08:56:41,805: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-14 08:56:43,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3c52e8>]}
2018-02-14 08:56:44,292: 08:56:44 | 39 of 43 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.03s]
2018-02-14 08:56:44,292: 08:56:44 | 40 of 43 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-14 08:56:44,293: Compiling model.seo_audit.agg_stats_client
2018-02-14 08:56:44,302: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-14 08:56:44,303: Acquiring new bigquery connection "agg_stats_client".
2018-02-14 08:56:44,303: Re-using an available connection from the pool.
2018-02-14 08:56:44,981: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-14 08:56:50,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110870400>]}
2018-02-14 08:56:50,618: 08:56:50 | 40 of 43 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 6.11s]
2018-02-14 08:56:50,619: 08:56:50 | 41 of 43 START table model seo_audit.agg_all......................... [RUN]
2018-02-14 08:56:50,619: Compiling model.seo_audit.agg_all
2018-02-14 08:56:50,627: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-14 08:56:50,628: Acquiring new bigquery connection "agg_all".
2018-02-14 08:56:50,628: Re-using an available connection from the pool.
2018-02-14 08:56:51,125: Model SQL (agg_all):
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-14 08:56:51,126: Bad request while running:
SELECT 
a.date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
c.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
LEFT JOIN 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` c
ON (
	a.canonical_url = c.url AND
	a.date = c.date
	)
2018-02-14 08:56:51,126: 400 Name canonical_url not found inside a at [97:11]
2018-02-14 08:56:51,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0cfbab2-42a4-4361-aab4-33b6115a4b15', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d3c50b8>]}
2018-02-14 08:56:51,456: 08:56:51 | 41 of 43 ERROR creating table model seo_audit.agg_all................ [ERROR in 0.51s]
2018-02-14 08:56:51,459: 08:56:51 | 42 of 43 SKIP relation seo_audit.dates............................... [SKIP]
2018-02-14 08:56:51,460: 08:56:51 | 43 of 43 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-14 08:56:51,479: 08:56:51 | 
2018-02-14 08:56:51,480: 08:56:51 | Finished running 43 table models in 75.55s.
2018-02-14 08:56:51,480: Connection 'master' was left open.
2018-02-14 08:56:51,480: 
2018-02-14 08:56:51,480: Completed with 1 errors:
2018-02-14 08:56:51,480: 
2018-02-14 08:56:51,481: Database Error in model agg_all (models/agg/join/agg_all.sql)
2018-02-14 08:56:51,481:   Name canonical_url not found inside a at [97:11]
2018-02-14 08:56:51,481:   compiled SQL at target/compiled/seo_audit/agg/join/agg_all.sql
2018-02-14 08:56:51,481: 
Done. PASS=40 ERROR=1 SKIP=2 TOTAL=43
2018-02-14 08:56:51,481: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110908f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110908240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110908550>]}
2018-02-14 08:56:51,713: Flushing usage events
2018-02-14 08:57:37,552: Tracking: tracking
2018-02-14 08:57:37,552: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f62da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f62e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113f629e8>]}
2018-02-14 08:57:38,334: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 08:57:38,355: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 08:57:38,359: Parsing core.sql
2018-02-14 08:57:38,377: Parsing adapters/bigquery.sql
2018-02-14 08:57:38,388: Parsing adapters/common.sql
2018-02-14 08:57:38,405: Parsing adapters/postgres.sql
2018-02-14 08:57:38,411: Parsing adapters/redshift.sql
2018-02-14 08:57:38,433: Parsing etc/get_custom_schema.sql
2018-02-14 08:57:38,445: Parsing materializations/archive.sql
2018-02-14 08:57:38,479: Parsing materializations/bigquery.sql
2018-02-14 08:57:38,494: Parsing materializations/helpers.sql
2018-02-14 08:57:38,512: Parsing materializations/incremental.sql
2018-02-14 08:57:38,540: Parsing materializations/table.sql
2018-02-14 08:57:38,565: Parsing materializations/view.sql
2018-02-14 08:57:38,582: Parsing materializations/wrapper.sql
2018-02-14 08:57:38,588: Parsing schema_tests/accepted_values.sql
2018-02-14 08:57:38,593: Parsing schema_tests/not_null.sql
2018-02-14 08:57:38,598: Parsing schema_tests/relationships.sql
2018-02-14 08:57:38,604: Parsing schema_tests/unique.sql
2018-02-14 08:57:38,639: Parsing model.seo_audit.actions
2018-02-14 08:57:38,643: Acquiring new bigquery connection "master".
2018-02-14 08:57:38,643: Opening a new connection (0 currently allocated)
2018-02-14 08:57:38,647: Parsing model.seo_audit.dates
2018-02-14 08:57:38,649: Parsing model.seo_audit.accounts_proc
2018-02-14 08:57:38,651: Parsing model.seo_audit.all_dates
2018-02-14 08:57:38,653: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 08:57:38,656: Parsing model.seo_audit.agg_all
2018-02-14 08:57:38,658: Parsing model.seo_audit.agg_indicative
2018-02-14 08:57:38,661: Parsing model.seo_audit.agg_stats
2018-02-14 08:57:38,665: Parsing model.seo_audit.agg_stats_client
2018-02-14 08:57:38,667: Parsing model.seo_audit.deepcrawl_class
2018-02-14 08:57:38,670: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:57:38,672: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:57:38,673: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:57:38,675: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:57:38,677: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 08:57:38,679: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 08:57:38,681: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:57:38,688: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:57:38,690: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:57:38,691: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:57:38,693: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:57:38,694: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:57:38,696: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:57:38,698: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 08:57:38,701: Parsing model.seo_audit.ga_proc
2018-02-14 08:57:38,704: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 08:57:38,706: Parsing model.seo_audit.ga_stats
2018-02-14 08:57:38,709: Parsing model.seo_audit.majestic_domain_history
2018-02-14 08:57:38,710: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 08:57:38,713: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 08:57:38,715: Parsing model.seo_audit.moz_proc
2018-02-14 08:57:38,717: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 08:57:38,720: Parsing model.seo_audit.search_console_history
2018-02-14 08:57:38,722: Parsing model.seo_audit.search_console_proc
2018-02-14 08:57:38,724: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 08:57:38,727: Parsing model.seo_audit.search_console_stats_url
2018-02-14 08:57:38,729: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 08:57:38,731: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 08:57:38,734: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 08:57:38,737: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 08:57:38,739: Parsing model.seo_audit.semrush_url_history
2018-02-14 08:57:38,741: Parsing model.seo_audit.semrush_url_stats
2018-02-14 08:57:38,743: Parsing model.seo_audit.sitemap_proc
2018-02-14 08:57:38,756: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 08:57:38,768: 
2018-02-14 08:57:39,572: 08:57:39 | Concurrency: 4 threads (target='prod')
2018-02-14 08:57:39,573: 08:57:39 | 
2018-02-14 08:57:39,958: 08:57:39 | 1 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 08:57:39,958: Compiling model.seo_audit.all_dates
2018-02-14 08:57:39,962: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 08:57:39,958: 08:57:39 | 2 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 08:57:39,958: 08:57:39 | 3 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 08:57:39,963: Compiling model.seo_audit.accounts_proc
2018-02-14 08:57:39,963: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 08:57:39,968: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 08:57:39,972: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 08:57:39,973: Acquiring new bigquery connection "all_dates".
2018-02-14 08:57:39,974: Opening a new connection (1 currently allocated)
2018-02-14 08:57:39,975: Acquiring new bigquery connection "accounts_proc".
2018-02-14 08:57:39,978: Opening a new connection (2 currently allocated)
2018-02-14 08:57:39,979: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 08:57:40,028: Opening a new connection (3 currently allocated)
2018-02-14 08:57:40,925: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 08:57:40,976: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 08:57:40,991: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 08:57:42,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114158a90>]}
2018-02-14 08:57:42,326: 08:57:42 | 1 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.07s]
2018-02-14 08:57:43,168: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140dc8d0>]}
2018-02-14 08:57:43,486: 08:57:43 | 2 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.20s]
2018-02-14 08:57:45,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114153e80>]}
2018-02-14 08:57:45,599: 08:57:45 | 3 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 5.42s]
2018-02-14 08:57:45,600: 08:57:45 | 4 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 08:57:45,600: 08:57:45 | 5 of 43 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-14 08:57:45,601: 08:57:45 | 6 of 43 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-14 08:57:45,601: 08:57:45 | 7 of 43 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-14 08:57:45,601: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 08:57:45,602: Compiling model.seo_audit.sitemap_proc
2018-02-14 08:57:45,602: Compiling model.seo_audit.majestic_domain_proc
2018-02-14 08:57:45,602: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 08:57:45,619: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 08:57:45,635: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 08:57:45,638: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-14 08:57:45,640: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 08:57:45,642: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 08:57:45,642: Re-using an available connection from the pool.
2018-02-14 08:57:45,644: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 08:57:45,644: Re-using an available connection from the pool.
2018-02-14 08:57:45,648: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-14 08:57:45,648: Re-using an available connection from the pool.
2018-02-14 08:57:45,654: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 08:57:45,655: Opening a new connection (4 currently allocated)
2018-02-14 08:57:46,286: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-14 08:57:46,308: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-14 08:57:46,309: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:57:46,627: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 08:57:48,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140dc828>]}
2018-02-14 08:57:48,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114077400>]}
2018-02-14 08:57:48,757: 08:57:48 | 6 of 43 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.86s]
2018-02-14 08:57:48,758: 08:57:48 | 8 of 43 START table model seo_audit.moz_proc......................... [RUN]
2018-02-14 08:57:48,760: Compiling model.seo_audit.moz_proc
2018-02-14 08:57:48,771: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 08:57:48,774: Acquiring new bigquery connection "moz_proc".
2018-02-14 08:57:48,774: Re-using an available connection from the pool.
2018-02-14 08:57:48,787: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140aa400>]}
2018-02-14 08:57:49,081: 08:57:49 | 4 of 43 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.87s]
2018-02-14 08:57:49,082: 08:57:49 | 9 of 43 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-14 08:57:49,083: Compiling model.seo_audit.search_console_proc
2018-02-14 08:57:49,091: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-14 08:57:49,094: Acquiring new bigquery connection "search_console_proc".
2018-02-14 08:57:49,094: Re-using an available connection from the pool.
2018-02-14 08:57:49,299: 08:57:49 | 7 of 43 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.18s]
2018-02-14 08:57:49,299: 08:57:49 | 10 of 43 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-14 08:57:49,299: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 08:57:49,304: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 08:57:49,305: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 08:57:49,305: Re-using an available connection from the pool.
2018-02-14 08:57:49,498: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:57:49,617: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140e8be0>]}
2018-02-14 08:57:49,666: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-14 08:57:49,904: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-14 08:57:49,917: 08:57:49 | 5 of 43 OK created table model seo_audit.sitemap_proc................ [CREATE TABLE in 4.02s]
2018-02-14 08:57:49,918: 08:57:49 | 11 of 43 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-14 08:57:49,918: Compiling model.seo_audit.screamingfrog_proc
2018-02-14 08:57:49,926: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-14 08:57:49,927: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-14 08:57:49,927: Re-using an available connection from the pool.
2018-02-14 08:57:50,516: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-14 08:57:51,652: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140dc828>]}
2018-02-14 08:57:51,871: 08:57:51 | 8 of 43 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.89s]
2018-02-14 08:57:52,072: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140aa400>]}
2018-02-14 08:57:52,316: 08:57:52 | 10 of 43 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 2.77s]
2018-02-14 08:57:52,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114077400>]}
2018-02-14 08:57:53,115: 08:57:53 | 9 of 43 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.81s]
2018-02-14 08:57:53,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140e8be0>]}
2018-02-14 08:57:54,162: 08:57:54 | 11 of 43 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 3.83s]
2018-02-14 08:57:54,163: 08:57:54 | 12 of 43 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-14 08:57:54,164: Compiling model.seo_audit.majestic_domain_history
2018-02-14 08:57:54,164: 08:57:54 | 13 of 43 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-14 08:57:54,170: Compiling model.seo_audit.semrush_keyword_history
2018-02-14 08:57:54,164: 08:57:54 | 14 of 43 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-14 08:57:54,180: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-14 08:57:54,182: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-14 08:57:54,164: 08:57:54 | 15 of 43 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-14 08:57:54,182: Compiling model.seo_audit.semrush_url_history
2018-02-14 08:57:54,182: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-14 08:57:54,188: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-14 08:57:54,188: Acquiring new bigquery connection "majestic_domain_history".
2018-02-14 08:57:54,189: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-14 08:57:54,196: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-14 08:57:54,196: Re-using an available connection from the pool.
2018-02-14 08:57:54,197: Acquiring new bigquery connection "semrush_url_history".
2018-02-14 08:57:54,199: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-14 08:57:54,200: Re-using an available connection from the pool.
2018-02-14 08:57:54,211: Re-using an available connection from the pool.
2018-02-14 08:57:54,216: Re-using an available connection from the pool.
2018-02-14 08:57:54,729: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-14 08:57:54,762: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-14 08:57:54,823: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  domain,
  'Deepcrawl' as platform,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 08:57:54,956: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-14 08:57:55,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114036d30>]}
2018-02-14 08:57:56,031: 08:57:56 | 12 of 43 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 1.65s]
2018-02-14 08:57:56,032: 08:57:56 | 16 of 43 START table model seo_audit.search_console_history.......... [RUN]
2018-02-14 08:57:56,032: Compiling model.seo_audit.search_console_history
2018-02-14 08:57:56,041: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-14 08:57:56,042: Acquiring new bigquery connection "search_console_history".
2018-02-14 08:57:56,043: Re-using an available connection from the pool.
2018-02-14 08:57:56,662: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-14 08:57:57,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11413b470>]}
2018-02-14 08:57:57,447: 08:57:57 | 13 of 43 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.98s]
2018-02-14 08:57:58,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111440ba8>]}
2018-02-14 08:57:58,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11413b400>]}
2018-02-14 08:57:58,259: 08:57:58 | 14 of 43 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.87s]
2018-02-14 08:57:58,548: 08:57:58 | 15 of 43 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 3.88s]
2018-02-14 08:57:58,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114036d30>]}
2018-02-14 08:57:59,022: 08:57:59 | 16 of 43 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.78s]
2018-02-14 08:57:59,023: 08:57:59 | 17 of 43 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-14 08:57:59,023: 08:57:59 | 18 of 43 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-14 08:57:59,023: Compiling model.seo_audit.search_console_stats_keyword
2018-02-14 08:57:59,024: 08:57:59 | 19 of 43 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-14 08:57:59,024: Compiling model.seo_audit.search_console_stats_url
2018-02-14 08:57:59,030: Compiling model.seo_audit.deepcrawl_class
2018-02-14 08:57:59,034: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-14 08:57:59,038: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-14 08:57:59,043: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-14 08:57:59,044: Acquiring new bigquery connection "search_console_stats_url".
2018-02-14 08:57:59,045: Re-using an available connection from the pool.
2018-02-14 08:57:59,047: Acquiring new bigquery connection "deepcrawl_class".
2018-02-14 08:57:59,047: Re-using an available connection from the pool.
2018-02-14 08:57:59,050: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-14 08:57:59,050: Re-using an available connection from the pool.
2018-02-14 08:57:59,632: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-14 08:57:59,640: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-14 08:57:59,687: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-14 08:58:01,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11141b048>]}
2018-02-14 08:58:01,802: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110b776d8>]}
2018-02-14 08:58:01,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11413b2b0>]}
2018-02-14 08:58:02,029: 08:58:02 | 19 of 43 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 2.76s]
2018-02-14 08:58:02,326: 08:58:02 | 18 of 43 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 2.78s]
2018-02-14 08:58:02,634: 08:58:02 | 17 of 43 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.81s]
2018-02-14 08:58:02,635: 08:58:02 | 20 of 43 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-14 08:58:02,636: Compiling model.seo_audit.semrush_keyword_stats
2018-02-14 08:58:02,636: 08:58:02 | 21 of 43 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-14 08:58:02,643: Compiling model.seo_audit.majestic_domain_stats
2018-02-14 08:58:02,651: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-14 08:58:02,652: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-14 08:58:02,636: 08:58:02 | 22 of 43 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-14 08:58:02,652: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-14 08:58:02,636: 08:58:02 | 23 of 43 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-14 08:58:02,658: Compiling model.seo_audit.semrush_url_stats
2018-02-14 08:58:02,662: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-14 08:58:02,663: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-14 08:58:02,664: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-14 08:58:02,665: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-14 08:58:02,665: Re-using an available connection from the pool.
2018-02-14 08:58:02,666: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-14 08:58:02,666: Acquiring new bigquery connection "semrush_url_stats".
2018-02-14 08:58:02,666: Re-using an available connection from the pool.
2018-02-14 08:58:02,674: Re-using an available connection from the pool.
2018-02-14 08:58:02,676: Re-using an available connection from the pool.
2018-02-14 08:58:03,325: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-14 08:58:03,326: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-14 08:58:03,327: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:58:03,327: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 08:58:05,486: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114036d30>]}
2018-02-14 08:58:05,495: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11417c080>]}
2018-02-14 08:58:05,501: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111417588>]}
2018-02-14 08:58:06,031: 08:58:06 | 20 of 43 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.85s]
2018-02-14 08:58:06,266: 08:58:06 | 22 of 43 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.84s]
2018-02-14 08:58:06,500: 08:58:06 | 21 of 43 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.86s]
2018-02-14 08:58:06,571: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114552e8>]}
2018-02-14 08:58:06,801: 08:58:06 | 23 of 43 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 3.91s]
2018-02-14 08:58:06,802: 08:58:06 | 24 of 43 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-14 08:58:06,803: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-14 08:58:06,802: 08:58:06 | 25 of 43 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-14 08:58:06,809: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-14 08:58:06,803: 08:58:06 | 26 of 43 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-14 08:58:06,818: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-14 08:58:06,819: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-14 08:58:06,803: 08:58:06 | 27 of 43 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-14 08:58:06,819: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-14 08:58:06,820: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 08:58:06,837: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-14 08:58:06,839: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-14 08:58:06,840: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-14 08:58:06,844: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-14 08:58:06,846: Re-using an available connection from the pool.
2018-02-14 08:58:06,846: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-14 08:58:06,848: Re-using an available connection from the pool.
2018-02-14 08:58:06,849: Re-using an available connection from the pool.
2018-02-14 08:58:06,851: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-14 08:58:06,853: Re-using an available connection from the pool.
2018-02-14 08:58:07,436: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:58:07,520: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:58:07,542: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 08:58:07,567: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-14 08:58:08,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141b00>]}
2018-02-14 08:58:08,804: 08:58:08 | 26 of 43 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.78s]
2018-02-14 08:58:08,805: 08:58:08 | 28 of 43 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-14 08:58:08,805: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 08:58:08,810: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-14 08:58:08,811: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-14 08:58:08,811: Re-using an available connection from the pool.
2018-02-14 08:58:09,409: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-14 08:58:09,582: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140bd908>]}
2018-02-14 08:58:09,709: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140e8b00>]}
2018-02-14 08:58:09,839: 08:58:09 | 24 of 43 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 2.78s]
2018-02-14 08:58:09,840: 08:58:09 | 29 of 43 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-14 08:58:09,841: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 08:58:09,849: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-14 08:58:09,852: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-14 08:58:09,852: Re-using an available connection from the pool.
2018-02-14 08:58:10,084: 08:58:10 | 25 of 43 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.90s]
2018-02-14 08:58:10,505: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141b00>]}
2018-02-14 08:58:10,519: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-14 08:58:10,727: 08:58:10 | 28 of 43 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 1.70s]
2018-02-14 08:58:11,606: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140bd908>]}
2018-02-14 08:58:11,845: 08:58:11 | 29 of 43 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 1.76s]
2018-02-14 08:58:17,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11141f748>]}
2018-02-14 08:58:17,492: 08:58:17 | 27 of 43 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 10.45s]
2018-02-14 08:58:17,493: 08:58:17 | 30 of 43 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-14 08:58:17,493: 08:58:17 | 31 of 43 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-14 08:58:17,493: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 08:58:17,493: 08:58:17 | 32 of 43 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-14 08:58:17,494: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 08:58:17,499: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-14 08:58:17,500: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 08:58:17,505: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-14 08:58:17,513: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-14 08:58:17,514: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-14 08:58:17,514: Re-using an available connection from the pool.
2018-02-14 08:58:17,515: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-14 08:58:17,516: Re-using an available connection from the pool.
2018-02-14 08:58:17,520: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-14 08:58:17,520: Re-using an available connection from the pool.
2018-02-14 08:58:18,133: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-14 08:58:18,176: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-14 08:58:18,186: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-14 08:58:19,333: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140ef668>]}
2018-02-14 08:58:19,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114158748>]}
2018-02-14 08:58:19,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141cf8>]}
2018-02-14 08:58:19,894: 08:58:19 | 30 of 43 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.84s]
2018-02-14 08:58:20,191: 08:58:20 | 32 of 43 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.83s]
2018-02-14 08:58:20,481: 08:58:20 | 31 of 43 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.98s]
2018-02-14 08:58:20,482: 08:58:20 | 33 of 43 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-14 08:58:20,482: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-14 08:58:20,494: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-14 08:58:20,495: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-14 08:58:20,495: Re-using an available connection from the pool.
2018-02-14 08:58:21,360: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-14 08:58:24,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114155b00>]}
2018-02-14 08:58:24,844: 08:58:24 | 33 of 43 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 4.14s]
2018-02-14 08:58:24,845: 08:58:24 | 34 of 43 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-14 08:58:24,845: Compiling model.seo_audit.deepcrawl_reclass
2018-02-14 08:58:24,857: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-14 08:58:24,859: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-14 08:58:24,859: Re-using an available connection from the pool.
2018-02-14 08:58:25,541: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-14 08:58:26,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141cf8>]}
2018-02-14 08:58:26,868: 08:58:26 | 34 of 43 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.78s]
2018-02-14 08:58:26,869: 08:58:26 | 35 of 43 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-14 08:58:26,870: Compiling model.seo_audit.ga_proc_pageviews
2018-02-14 08:58:26,869: 08:58:26 | 36 of 43 START table model seo_audit.ga_proc......................... [RUN]
2018-02-14 08:58:26,882: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-14 08:58:26,882: Compiling model.seo_audit.ga_proc
2018-02-14 08:58:26,891: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-14 08:58:26,892: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-14 08:58:26,893: Re-using an available connection from the pool.
2018-02-14 08:58:26,894: Acquiring new bigquery connection "ga_proc".
2018-02-14 08:58:26,894: Re-using an available connection from the pool.
2018-02-14 08:58:27,592: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:58:27,593: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 08:58:28,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111402c88>]}
2018-02-14 08:58:28,937: 08:58:28 | 35 of 43 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 1.81s]
2018-02-14 08:58:30,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114158d68>]}
2018-02-14 08:58:31,038: 08:58:31 | 36 of 43 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 3.94s]
2018-02-14 08:58:31,039: 08:58:31 | 37 of 43 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-14 08:58:31,039: Compiling model.seo_audit.agg_indicative
2018-02-14 08:58:31,053: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-14 08:58:31,055: Acquiring new bigquery connection "agg_indicative".
2018-02-14 08:58:31,055: Re-using an available connection from the pool.
2018-02-14 08:58:31,786: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-14 08:58:33,946: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141cf8>]}
2018-02-14 08:58:34,254: 08:58:34 | 37 of 43 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.91s]
2018-02-14 08:58:34,255: 08:58:34 | 38 of 43 START table model seo_audit.ga_stats........................ [RUN]
2018-02-14 08:58:34,255: Compiling model.seo_audit.ga_stats
2018-02-14 08:58:34,266: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-14 08:58:34,267: Acquiring new bigquery connection "ga_stats".
2018-02-14 08:58:34,268: Re-using an available connection from the pool.
2018-02-14 08:58:34,859: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-14 08:58:37,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141a90>]}
2018-02-14 08:58:37,298: 08:58:37 | 38 of 43 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.76s]
2018-02-14 08:58:37,300: 08:58:37 | 39 of 43 START table model seo_audit.agg_stats....................... [RUN]
2018-02-14 08:58:37,300: Compiling model.seo_audit.agg_stats
2018-02-14 08:58:37,317: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-14 08:58:37,318: Acquiring new bigquery connection "agg_stats".
2018-02-14 08:58:37,318: Re-using an available connection from the pool.
2018-02-14 08:58:38,058: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-14 08:58:40,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114141cf8>]}
2018-02-14 08:58:41,252: 08:58:41 | 39 of 43 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 3.33s]
2018-02-14 08:58:41,253: 08:58:41 | 40 of 43 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-14 08:58:41,253: Compiling model.seo_audit.agg_stats_client
2018-02-14 08:58:41,261: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-14 08:58:41,262: Acquiring new bigquery connection "agg_stats_client".
2018-02-14 08:58:41,262: Re-using an available connection from the pool.
2018-02-14 08:58:43,466: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-14 08:58:46,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140dc8d0>]}
2018-02-14 08:58:46,749: 08:58:46 | 40 of 43 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 5.20s]
2018-02-14 08:58:46,750: 08:58:46 | 41 of 43 START table model seo_audit.agg_all......................... [RUN]
2018-02-14 08:58:46,751: Compiling model.seo_audit.agg_all
2018-02-14 08:58:46,760: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-14 08:58:46,761: Acquiring new bigquery connection "agg_all".
2018-02-14 08:58:46,762: Re-using an available connection from the pool.
2018-02-14 08:58:48,376: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-14 08:58:51,265: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111417400>]}
2018-02-14 08:58:51,622: 08:58:51 | 41 of 43 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 4.51s]
2018-02-14 08:58:51,623: 08:58:51 | 42 of 43 START table model seo_audit.dates........................... [RUN]
2018-02-14 08:58:51,624: Compiling model.seo_audit.dates
2018-02-14 08:58:51,630: Writing injected SQL for node "model.seo_audit.dates"
2018-02-14 08:58:51,634: Acquiring new bigquery connection "dates".
2018-02-14 08:58:51,634: Re-using an available connection from the pool.
2018-02-14 08:58:53,299: Model SQL (dates):
select
client,
max(date) date
from `curious-domain-121318`.`seo_audit`.`agg_all`
where
gsc_keyword_count_90d is not null
and semrush_keyword_count is not null
and sessions_30d is not null
group by client
2018-02-14 08:58:54,799: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140dc8d0>]}
2018-02-14 08:58:55,106: 08:58:55 | 42 of 43 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.18s]
2018-02-14 08:58:55,107: 08:58:55 | 43 of 43 START table model seo_audit.actions......................... [RUN]
2018-02-14 08:58:55,108: Compiling model.seo_audit.actions
2018-02-14 08:58:55,120: Writing injected SQL for node "model.seo_audit.actions"
2018-02-14 08:58:55,121: Acquiring new bigquery connection "actions".
2018-02-14 08:58:55,121: Re-using an available connection from the pool.
2018-02-14 08:58:57,362: Model SQL (actions):
SELECT
a.date date,
c.date max_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when a.gsc_impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE a.date = c.date
OR a.date is null
2018-02-14 08:59:00,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '350d638c-81d5-4d73-9213-db748b6bde1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111417400>]}
2018-02-14 08:59:00,608: 08:59:00 | 43 of 43 OK created table model seo_audit.actions.................... [CREATE TABLE in 5.18s]
2018-02-14 08:59:00,627: 08:59:00 | 
2018-02-14 08:59:00,627: 08:59:00 | Finished running 43 table models in 81.06s.
2018-02-14 08:59:00,628: Connection 'master' was left open.
2018-02-14 08:59:00,628: 
2018-02-14 08:59:00,628: Completed successfully
2018-02-14 08:59:00,629: 
Done. PASS=43 ERROR=0 SKIP=0 TOTAL=43
2018-02-14 08:59:00,630: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11405b4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1140239b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114023860>]}
2018-02-14 08:59:00,929: Flushing usage events
2018-02-14 09:23:17,650: Tracking: tracking
2018-02-14 09:23:17,653: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a4cc18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a4cb00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110a4c518>]}
2018-02-14 09:23:18,453: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 09:23:18,474: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 09:23:18,477: Parsing core.sql
2018-02-14 09:23:18,495: Parsing adapters/bigquery.sql
2018-02-14 09:23:18,509: Parsing adapters/common.sql
2018-02-14 09:23:18,535: Parsing adapters/postgres.sql
2018-02-14 09:23:18,544: Parsing adapters/redshift.sql
2018-02-14 09:23:18,568: Parsing etc/get_custom_schema.sql
2018-02-14 09:23:18,576: Parsing materializations/archive.sql
2018-02-14 09:23:18,608: Parsing materializations/bigquery.sql
2018-02-14 09:23:18,623: Parsing materializations/helpers.sql
2018-02-14 09:23:18,643: Parsing materializations/incremental.sql
2018-02-14 09:23:18,677: Parsing materializations/table.sql
2018-02-14 09:23:18,701: Parsing materializations/view.sql
2018-02-14 09:23:18,723: Parsing materializations/wrapper.sql
2018-02-14 09:23:18,729: Parsing schema_tests/accepted_values.sql
2018-02-14 09:23:18,735: Parsing schema_tests/not_null.sql
2018-02-14 09:23:18,740: Parsing schema_tests/relationships.sql
2018-02-14 09:23:18,746: Parsing schema_tests/unique.sql
2018-02-14 09:23:18,874: Parsing model.seo_audit.actions
2018-02-14 09:23:18,882: Acquiring new bigquery connection "master".
2018-02-14 09:23:18,882: Opening a new connection (0 currently allocated)
2018-02-14 09:23:18,886: Parsing model.seo_audit.dates
2018-02-14 09:23:18,889: Parsing model.seo_audit.accounts_proc
2018-02-14 09:23:18,891: Parsing model.seo_audit.all_dates
2018-02-14 09:23:18,892: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 09:23:18,894: Parsing model.seo_audit.agg_all
2018-02-14 09:23:18,897: Parsing model.seo_audit.agg_indicative
2018-02-14 09:23:18,900: Parsing model.seo_audit.agg_stats
2018-02-14 09:23:18,905: Parsing model.seo_audit.agg_stats_client
2018-02-14 09:23:18,907: Parsing model.seo_audit.deepcrawl_class
2018-02-14 09:23:18,909: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 09:23:18,911: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 09:23:18,913: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 09:23:18,914: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 09:23:18,917: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 09:23:18,919: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 09:23:18,921: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 09:23:18,927: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 09:23:18,929: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 09:23:18,931: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 09:23:18,932: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 09:23:18,934: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 09:23:18,936: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 09:23:18,937: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 09:23:18,941: Parsing model.seo_audit.ga_proc
2018-02-14 09:23:18,944: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 09:23:18,946: Parsing model.seo_audit.ga_stats
2018-02-14 09:23:18,949: Parsing model.seo_audit.majestic_domain_history
2018-02-14 09:23:18,950: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 09:23:18,953: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 09:23:18,955: Parsing model.seo_audit.moz_proc
2018-02-14 09:23:18,957: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 09:23:18,960: Parsing model.seo_audit.search_console_history
2018-02-14 09:23:18,962: Parsing model.seo_audit.search_console_proc
2018-02-14 09:23:18,964: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 09:23:18,967: Parsing model.seo_audit.search_console_stats_url
2018-02-14 09:23:18,969: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 09:23:18,971: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 09:23:18,974: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 09:23:18,977: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 09:23:18,979: Parsing model.seo_audit.semrush_url_history
2018-02-14 09:23:18,981: Parsing model.seo_audit.semrush_url_stats
2018-02-14 09:23:18,983: Parsing model.seo_audit.sitemap_proc
2018-02-14 09:23:18,996: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 09:23:19,009: 
2018-02-14 09:23:20,114: 09:23:20 | Concurrency: 4 threads (target='prod')
2018-02-14 09:23:20,114: 09:23:20 | 
2018-02-14 09:23:20,497: 09:23:20 | 1 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 09:23:20,497: 09:23:20 | 2 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 09:23:20,498: 09:23:20 | 3 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 09:23:20,498: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 09:23:20,499: Compiling model.seo_audit.accounts_proc
2018-02-14 09:23:20,499: Compiling model.seo_audit.all_dates
2018-02-14 09:23:20,515: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 09:23:20,517: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 09:23:20,521: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 09:23:20,524: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 09:23:20,525: Acquiring new bigquery connection "all_dates".
2018-02-14 09:23:20,525: Acquiring new bigquery connection "accounts_proc".
2018-02-14 09:23:20,525: Opening a new connection (1 currently allocated)
2018-02-14 09:23:20,527: Opening a new connection (2 currently allocated)
2018-02-14 09:23:20,588: Opening a new connection (3 currently allocated)
2018-02-14 09:23:21,614: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 09:23:21,658: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 09:23:21,661: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 09:23:22,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6cafac13-5c8d-4997-9226-359eccdc1084', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c262b0>]}
2018-02-14 09:23:23,244: 09:23:23 | 3 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.49s]
2018-02-14 09:23:23,799: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6cafac13-5c8d-4997-9226-359eccdc1084', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c47cc0>]}
2018-02-14 09:23:23,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6cafac13-5c8d-4997-9226-359eccdc1084', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110bba208>]}
2018-02-14 09:23:24,026: 09:23:24 | 2 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.30s]
2018-02-14 09:23:24,274: 09:23:24 | 1 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.32s]
2018-02-14 09:23:24,275: 09:23:24 | 4 of 43 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-14 09:23:24,276: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 09:23:24,275: 09:23:24 | 5 of 43 START table model seo_audit.moz_proc......................... [RUN]
2018-02-14 09:23:24,286: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 09:23:24,275: 09:23:24 | 6 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 09:23:24,287: Compiling model.seo_audit.moz_proc
2018-02-14 09:23:24,276: 09:23:24 | 7 of 43 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-14 09:23:24,287: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 09:23:24,293: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 09:23:24,295: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 09:23:24,301: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 09:23:24,310: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 09:23:24,319: Re-using an available connection from the pool.
2018-02-14 09:23:24,318: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 09:23:24,323: Acquiring new bigquery connection "moz_proc".
2018-02-14 09:23:24,325: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 09:23:24,325: Re-using an available connection from the pool.
2018-02-14 09:23:24,327: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 09:23:24,327: Re-using an available connection from the pool.
2018-02-14 09:23:24,329: Opening a new connection (4 currently allocated)
2018-02-14 09:23:24,760: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables?pageToken=semrush_keyword_proc: Not found: Token semrush_keyword_proc
2018-02-14 09:23:24,760: 09:23:24 | 8 of 43 START table model seo_audit.sitemap_proc..................... [RUN]
2018-02-14 09:23:24,760: Compiling model.seo_audit.sitemap_proc
2018-02-14 09:23:24,766: Connection 'master' was left open.
2018-02-14 09:23:24,767: Connection 'mappings_ga_proc' was left open.
2018-02-14 09:23:24,767: Connection 'moz_proc' was left open.
2018-02-14 09:23:24,767: Connection 'semrush_keyword_proc' was left open.
2018-02-14 09:23:24,767: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c26358>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c69438>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110c69a58>]}
2018-02-14 09:23:24,772: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 09:23:24,775: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 09:23:24,775: Opening a new connection (0 currently allocated)
2018-02-14 09:23:24,952: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 09:23:24,975: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 09:23:24,983: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 09:23:25,081: Encountered an error:
2018-02-14 09:23:25,082: 404 GET https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables?pageToken=semrush_keyword_proc: Not found: Token semrush_keyword_proc
2018-02-14 09:23:25,118: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/curious-domain-121318/datasets/seo_audit/tables?pageToken=semrush_keyword_proc: Not found: Token semrush_keyword_proc

2018-02-14 09:24:52,636: Tracking: tracking
2018-02-14 09:24:52,639: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10454fba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10454f860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10454f828>]}
2018-02-14 09:24:53,382: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 09:24:53,398: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 09:24:53,402: Parsing core.sql
2018-02-14 09:24:53,423: Parsing adapters/bigquery.sql
2018-02-14 09:24:53,432: Parsing adapters/common.sql
2018-02-14 09:24:53,453: Parsing adapters/postgres.sql
2018-02-14 09:24:53,459: Parsing adapters/redshift.sql
2018-02-14 09:24:53,480: Parsing etc/get_custom_schema.sql
2018-02-14 09:24:53,489: Parsing materializations/archive.sql
2018-02-14 09:24:53,524: Parsing materializations/bigquery.sql
2018-02-14 09:24:53,541: Parsing materializations/helpers.sql
2018-02-14 09:24:53,564: Parsing materializations/incremental.sql
2018-02-14 09:24:53,595: Parsing materializations/table.sql
2018-02-14 09:24:53,623: Parsing materializations/view.sql
2018-02-14 09:24:53,646: Parsing materializations/wrapper.sql
2018-02-14 09:24:53,656: Parsing schema_tests/accepted_values.sql
2018-02-14 09:24:53,662: Parsing schema_tests/not_null.sql
2018-02-14 09:24:53,668: Parsing schema_tests/relationships.sql
2018-02-14 09:24:53,674: Parsing schema_tests/unique.sql
2018-02-14 09:24:53,721: Parsing model.seo_audit.actions
2018-02-14 09:24:53,726: Acquiring new bigquery connection "master".
2018-02-14 09:24:53,726: Opening a new connection (0 currently allocated)
2018-02-14 09:24:53,730: Parsing model.seo_audit.dates
2018-02-14 09:24:53,733: Parsing model.seo_audit.accounts_proc
2018-02-14 09:24:53,737: Parsing model.seo_audit.all_dates
2018-02-14 09:24:53,738: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 09:24:53,741: Parsing model.seo_audit.agg_all
2018-02-14 09:24:53,744: Parsing model.seo_audit.agg_indicative
2018-02-14 09:24:53,747: Parsing model.seo_audit.agg_stats
2018-02-14 09:24:53,755: Parsing model.seo_audit.agg_stats_client
2018-02-14 09:24:53,757: Parsing model.seo_audit.deepcrawl_class
2018-02-14 09:24:53,760: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 09:24:53,762: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 09:24:53,764: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 09:24:53,768: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 09:24:53,772: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 09:24:53,774: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 09:24:53,776: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 09:24:53,784: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 09:24:53,788: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 09:24:53,791: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 09:24:53,792: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 09:24:53,794: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 09:24:53,796: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 09:24:53,799: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 09:24:53,805: Parsing model.seo_audit.ga_proc
2018-02-14 09:24:53,809: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 09:24:53,812: Parsing model.seo_audit.ga_stats
2018-02-14 09:24:53,816: Parsing model.seo_audit.majestic_domain_history
2018-02-14 09:24:53,819: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 09:24:53,822: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 09:24:53,824: Parsing model.seo_audit.moz_proc
2018-02-14 09:24:53,827: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 09:24:53,830: Parsing model.seo_audit.search_console_history
2018-02-14 09:24:53,832: Parsing model.seo_audit.search_console_proc
2018-02-14 09:24:53,835: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 09:24:53,839: Parsing model.seo_audit.search_console_stats_url
2018-02-14 09:24:53,842: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 09:24:53,848: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 09:24:53,852: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 09:24:53,856: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 09:24:53,858: Parsing model.seo_audit.semrush_url_history
2018-02-14 09:24:53,860: Parsing model.seo_audit.semrush_url_stats
2018-02-14 09:24:53,863: Parsing model.seo_audit.sitemap_proc
2018-02-14 09:24:53,878: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 09:24:53,893: 
2018-02-14 09:24:54,703: 09:24:54 | Concurrency: 4 threads (target='prod')
2018-02-14 09:24:54,704: 09:24:54 | 
2018-02-14 09:24:55,043: 09:24:55 | 1 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 09:24:55,043: Compiling model.seo_audit.all_dates
2018-02-14 09:24:55,043: 09:24:55 | 2 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 09:24:55,047: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 09:24:55,043: 09:24:55 | 3 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 09:24:55,048: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 09:24:55,048: Compiling model.seo_audit.accounts_proc
2018-02-14 09:24:55,052: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 09:24:55,053: Acquiring new bigquery connection "all_dates".
2018-02-14 09:24:55,058: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 09:24:55,058: Opening a new connection (1 currently allocated)
2018-02-14 09:24:55,114: Acquiring new bigquery connection "accounts_proc".
2018-02-14 09:24:55,116: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 09:24:55,119: Opening a new connection (2 currently allocated)
2018-02-14 09:24:55,125: Opening a new connection (3 currently allocated)
2018-02-14 09:24:56,149: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 09:24:56,149: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 09:24:56,149: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 09:24:57,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046e0b38>]}
2018-02-14 09:24:57,452: 09:24:57 | 1 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 2.20s]
2018-02-14 09:24:58,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104743eb8>]}
2018-02-14 09:24:58,320: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104743d68>]}
2018-02-14 09:24:58,555: 09:24:58 | 2 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 3.26s]
2018-02-14 09:24:58,862: 09:24:58 | 3 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.27s]
2018-02-14 09:24:58,862: 09:24:58 | 4 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 09:24:58,863: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 09:24:58,863: 09:24:58 | 6 of 43 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-14 09:24:58,862: 09:24:58 | 5 of 43 START table model seo_audit.screamingfrog_proc............... [RUN]
2018-02-14 09:24:58,873: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 09:24:58,873: Compiling model.seo_audit.majestic_domain_proc
2018-02-14 09:24:58,863: 09:24:58 | 7 of 43 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-14 09:24:58,874: Compiling model.seo_audit.screamingfrog_proc
2018-02-14 09:24:58,880: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-14 09:24:58,881: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 09:24:58,888: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 09:24:58,901: Re-using an available connection from the pool.
2018-02-14 09:24:58,892: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-14 09:24:58,909: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-14 09:24:58,920: Re-using an available connection from the pool.
2018-02-14 09:24:58,927: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-14 09:24:58,927: Re-using an available connection from the pool.
2018-02-14 09:24:58,940: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 09:24:58,947: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 09:24:58,953: Opening a new connection (4 currently allocated)
2018-02-14 09:24:59,553: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-14 09:24:59,572: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 09:24:59,712: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-14 09:24:59,946: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 09:25:01,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047035c0>]}
2018-02-14 09:25:01,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104751da0>]}
2018-02-14 09:25:01,936: 09:25:01 | 5 of 43 OK created table model seo_audit.screamingfrog_proc.......... [CREATE TABLE in 2.83s]
2018-02-14 09:25:01,937: 09:25:01 | 8 of 43 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-14 09:25:01,937: Compiling model.seo_audit.search_console_proc
2018-02-14 09:25:01,949: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-14 09:25:01,956: Acquiring new bigquery connection "search_console_proc".
2018-02-14 09:25:01,957: Re-using an available connection from the pool.
2018-02-14 09:25:02,177: 09:25:02 | 6 of 43 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 3.02s]
2018-02-14 09:25:02,178: 09:25:02 | 9 of 43 START table model seo_audit.moz_proc......................... [RUN]
2018-02-14 09:25:02,178: Compiling model.seo_audit.moz_proc
2018-02-14 09:25:02,196: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 09:25:02,197: Acquiring new bigquery connection "moz_proc".
2018-02-14 09:25:02,198: Re-using an available connection from the pool.
2018-02-14 09:25:02,208: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10473e908>]}
2018-02-14 09:25:02,436: 09:25:02 | 7 of 43 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 3.33s]
2018-02-14 09:25:02,436: 09:25:02 | 10 of 43 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-14 09:25:02,437: Compiling model.seo_audit.sitemap_proc
2018-02-14 09:25:02,451: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 09:25:02,454: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 09:25:02,454: Re-using an available connection from the pool.
2018-02-14 09:25:02,636: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-14 09:25:02,843: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 09:25:03,209: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-14 09:25:04,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046e0390>]}
2018-02-14 09:25:05,241: 09:25:05 | 9 of 43 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 2.81s]
2018-02-14 09:25:05,241: 09:25:05 | 11 of 43 START table model seo_audit.semrush_domain_proc............. [RUN]
2018-02-14 09:25:05,242: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 09:25:05,250: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 09:25:05,253: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 09:25:05,253: Re-using an available connection from the pool.
2018-02-14 09:25:05,383: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047285f8>]}
2018-02-14 09:25:05,696: 09:25:05 | 10 of 43 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 2.95s]
2018-02-14 09:25:05,859: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10468acf8>]}
2018-02-14 09:25:05,910: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-14 09:25:06,169: 09:25:06 | 8 of 43 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 3.92s]
2018-02-14 09:25:07,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104778eb8>]}
2018-02-14 09:25:07,525: 09:25:07 | 4 of 43 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 8.39s]
2018-02-14 09:25:09,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1046e0390>]}
2018-02-14 09:25:09,435: 09:25:09 | 11 of 43 OK created table model seo_audit.semrush_domain_proc........ [CREATE TABLE in 3.97s]
2018-02-14 09:25:09,436: 09:25:09 | 12 of 43 START table model seo_audit.search_console_history.......... [RUN]
2018-02-14 09:25:09,436: Compiling model.seo_audit.search_console_history
2018-02-14 09:25:09,437: 09:25:09 | 13 of 43 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-14 09:25:09,437: 09:25:09 | 14 of 43 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-14 09:25:09,448: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-14 09:25:09,448: Compiling model.seo_audit.majestic_domain_history
2018-02-14 09:25:09,442: 09:25:09 | 15 of 43 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-14 09:25:09,448: Compiling model.seo_audit.semrush_url_history
2018-02-14 09:25:09,459: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-14 09:25:09,459: Compiling model.seo_audit.semrush_keyword_history
2018-02-14 09:25:09,465: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-14 09:25:09,467: Acquiring new bigquery connection "search_console_history".
2018-02-14 09:25:09,480: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-14 09:25:09,480: Re-using an available connection from the pool.
2018-02-14 09:25:09,481: Acquiring new bigquery connection "majestic_domain_history".
2018-02-14 09:25:09,487: Acquiring new bigquery connection "semrush_url_history".
2018-02-14 09:25:09,490: Re-using an available connection from the pool.
2018-02-14 09:25:09,490: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-14 09:25:09,492: Re-using an available connection from the pool.
2018-02-14 09:25:09,494: Re-using an available connection from the pool.
2018-02-14 09:25:10,055: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-14 09:25:10,136: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-14 09:25:10,137: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-14 09:25:10,153: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-14 09:25:12,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104671c50>]}
2018-02-14 09:25:12,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ac61d0>]}
2018-02-14 09:25:12,315: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104778eb8>]}
2018-02-14 09:25:12,478: 09:25:12 | 12 of 43 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 2.75s]
2018-02-14 09:25:12,480: 09:25:12 | 16 of 43 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-14 09:25:12,480: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-14 09:25:12,495: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-14 09:25:12,501: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-14 09:25:12,501: Re-using an available connection from the pool.
2018-02-14 09:25:12,836: 09:25:12 | 15 of 43 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.85s]
2018-02-14 09:25:12,962: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
split(domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 09:25:12,962: Bad request while running:
select
b.client,
a.platform,
split(domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 09:25:12,962: 400 Syntax error: Expected ")" but got keyword AS at [14:15]
2018-02-14 09:25:12,963: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106aa7908>]}
2018-02-14 09:25:13,050: 09:25:13 | 13 of 43 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.87s]
2018-02-14 09:25:13,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104743048>]}
2018-02-14 09:25:13,372: 09:25:13 | 16 of 43 ERROR creating table model seo_audit.deepcrawl_url_proc..... [ERROR in 0.48s]
2018-02-14 09:25:13,579: 09:25:13 | 14 of 43 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 3.90s]
2018-02-14 09:25:13,580: 09:25:13 | 17 of 43 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-14 09:25:13,580: Compiling model.seo_audit.search_console_stats_url
2018-02-14 09:25:13,587: 09:25:13 | 18 of 43 SKIP relation seo_audit.deepcrawl_class..................... [SKIP]
2018-02-14 09:25:13,587: 09:25:13 | 19 of 43 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-14 09:25:13,587: Compiling model.seo_audit.search_console_stats_keyword
2018-02-14 09:25:13,597: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-14 09:25:13,601: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-14 09:25:13,602: Acquiring new bigquery connection "search_console_stats_url".
2018-02-14 09:25:13,603: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-14 09:25:13,604: Re-using an available connection from the pool.
2018-02-14 09:25:13,604: Re-using an available connection from the pool.
2018-02-14 09:25:14,151: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-14 09:25:14,290: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-14 09:25:16,418: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104703f28>]}
2018-02-14 09:25:16,832: 09:25:16 | 19 of 43 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.83s]
2018-02-14 09:25:17,527: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1047788d0>]}
2018-02-14 09:25:17,747: 09:25:17 | 17 of 43 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 3.95s]
2018-02-14 09:25:17,748: 09:25:17 | 20 of 43 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-14 09:25:17,749: Compiling model.seo_audit.semrush_url_stats
2018-02-14 09:25:17,748: 09:25:17 | 21 of 43 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-14 09:25:17,754: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-14 09:25:17,748: 09:25:17 | 22 of 43 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-14 09:25:17,755: Compiling model.seo_audit.semrush_keyword_stats
2018-02-14 09:25:17,748: 09:25:17 | 23 of 43 SKIP relation seo_audit.deepcrawl_classification_stats...... [SKIP]
2018-02-14 09:25:17,755: Compiling model.seo_audit.majestic_domain_stats
2018-02-14 09:25:17,761: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-14 09:25:17,762: Acquiring new bigquery connection "semrush_url_stats".
2018-02-14 09:25:17,773: Re-using an available connection from the pool.
2018-02-14 09:25:17,772: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-14 09:25:17,778: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-14 09:25:17,779: Re-using an available connection from the pool.
2018-02-14 09:25:17,786: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-14 09:25:17,786: Re-using an available connection from the pool.
2018-02-14 09:25:18,466: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-14 09:25:18,467: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 09:25:18,536: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 09:25:20,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ac6240>]}
2018-02-14 09:25:20,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104761278>]}
2018-02-14 09:25:20,713: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '298fcc40-40c6-41cb-8f76-3a62d6355fa1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10470e7b8>]}
2018-02-14 09:25:20,931: 09:25:20 | 21 of 43 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.88s]
2018-02-14 09:25:21,234: 09:25:21 | 20 of 43 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.90s]
2018-02-14 09:25:21,539: 09:25:21 | 22 of 43 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 2.96s]
2018-02-14 09:25:21,540: 09:25:21 | 24 of 43 SKIP relation seo_audit.deepcrawl_rules_first_path.......... [SKIP]
2018-02-14 09:25:21,541: 09:25:21 | 25 of 43 SKIP relation seo_audit.deepcrawl_class_stats_query_string.. [SKIP]
2018-02-14 09:25:21,541: 09:25:21 | 26 of 43 SKIP relation seo_audit.deepcrawl_class_stats_first_path.... [SKIP]
2018-02-14 09:25:21,541: 09:25:21 | 27 of 43 SKIP relation seo_audit.deepcrawl_rules_query_string........ [SKIP]
2018-02-14 09:25:21,541: 09:25:21 | 28 of 43 SKIP relation seo_audit.deepcrawl_rules_filename............ [SKIP]
2018-02-14 09:25:21,542: 09:25:21 | 29 of 43 SKIP relation seo_audit.deepcrawl_class_stats_filename...... [SKIP]
2018-02-14 09:25:21,544: 09:25:21 | 30 of 43 SKIP relation seo_audit.deepcrawl_rules_query_string_unclassified [SKIP]
2018-02-14 09:25:21,544: 09:25:21 | 31 of 43 SKIP relation seo_audit.deepcrawl_rules_filename_unclassified [SKIP]
2018-02-14 09:25:21,544: 09:25:21 | 32 of 43 SKIP relation seo_audit.deepcrawl_rules_first_path_unclassified [SKIP]
2018-02-14 09:25:21,546: 09:25:21 | 33 of 43 SKIP relation seo_audit.deepcrawl_reclass_proc.............. [SKIP]
2018-02-14 09:25:21,546: 09:25:21 | 34 of 43 SKIP relation seo_audit.deepcrawl_reclass................... [SKIP]
2018-02-14 09:25:21,547: 09:25:21 | 35 of 43 SKIP relation seo_audit.ga_proc............................. [SKIP]
2018-02-14 09:25:21,547: 09:25:21 | 36 of 43 SKIP relation seo_audit.ga_proc_pageviews................... [SKIP]
2018-02-14 09:25:21,548: 09:25:21 | 37 of 43 SKIP relation seo_audit.agg_indicative...................... [SKIP]
2018-02-14 09:25:21,549: 09:25:21 | 38 of 43 SKIP relation seo_audit.ga_stats............................ [SKIP]
2018-02-14 09:25:21,549: 09:25:21 | 39 of 43 SKIP relation seo_audit.agg_stats........................... [SKIP]
2018-02-14 09:25:21,550: 09:25:21 | 40 of 43 SKIP relation seo_audit.agg_stats_client.................... [SKIP]
2018-02-14 09:25:21,550: 09:25:21 | 41 of 43 SKIP relation seo_audit.agg_all............................. [SKIP]
2018-02-14 09:25:21,551: 09:25:21 | 42 of 43 SKIP relation seo_audit.dates............................... [SKIP]
2018-02-14 09:25:21,552: 09:25:21 | 43 of 43 SKIP relation seo_audit.actions............................. [SKIP]
2018-02-14 09:25:21,576: 09:25:21 | 
2018-02-14 09:25:21,577: 09:25:21 | Finished running 43 table models in 26.87s.
2018-02-14 09:25:21,577: Connection 'master' was left open.
2018-02-14 09:25:21,577: 
2018-02-14 09:25:21,577: Completed with 1 errors:
2018-02-14 09:25:21,578: 
2018-02-14 09:25:21,578: Database Error in model deepcrawl_url_proc (models/base-adp/deepcrawl/deepcrawl_url_proc.sql)
2018-02-14 09:25:21,578:   Syntax error: Expected ")" but got keyword AS at [14:15]
2018-02-14 09:25:21,578:   compiled SQL at target/compiled/seo_audit/base-adp/deepcrawl/deepcrawl_url_proc.sql
2018-02-14 09:25:21,579: 
Done. PASS=20 ERROR=1 SKIP=22 TOTAL=43
2018-02-14 09:25:21,580: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10461d780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10461d908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10461d7b8>]}
2018-02-14 09:25:21,838: Flushing usage events
2018-02-14 09:30:52,687: Tracking: tracking
2018-02-14 09:30:52,694: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a25da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a25e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a259e8>]}
2018-02-14 09:30:53,480: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-02-14 09:30:53,504: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/seo-audit/dbt_modules
2018-02-14 09:30:53,507: Parsing core.sql
2018-02-14 09:30:53,526: Parsing adapters/bigquery.sql
2018-02-14 09:30:53,537: Parsing adapters/common.sql
2018-02-14 09:30:53,570: Parsing adapters/postgres.sql
2018-02-14 09:30:53,581: Parsing adapters/redshift.sql
2018-02-14 09:30:53,623: Parsing etc/get_custom_schema.sql
2018-02-14 09:30:53,641: Parsing materializations/archive.sql
2018-02-14 09:30:53,711: Parsing materializations/bigquery.sql
2018-02-14 09:30:53,735: Parsing materializations/helpers.sql
2018-02-14 09:30:53,756: Parsing materializations/incremental.sql
2018-02-14 09:30:53,788: Parsing materializations/table.sql
2018-02-14 09:30:53,811: Parsing materializations/view.sql
2018-02-14 09:30:53,830: Parsing materializations/wrapper.sql
2018-02-14 09:30:53,836: Parsing schema_tests/accepted_values.sql
2018-02-14 09:30:53,841: Parsing schema_tests/not_null.sql
2018-02-14 09:30:53,847: Parsing schema_tests/relationships.sql
2018-02-14 09:30:53,853: Parsing schema_tests/unique.sql
2018-02-14 09:30:53,919: Parsing model.seo_audit.actions
2018-02-14 09:30:53,926: Acquiring new bigquery connection "master".
2018-02-14 09:30:53,926: Opening a new connection (0 currently allocated)
2018-02-14 09:30:53,933: Parsing model.seo_audit.dates
2018-02-14 09:30:53,936: Parsing model.seo_audit.accounts_proc
2018-02-14 09:30:53,940: Parsing model.seo_audit.all_dates
2018-02-14 09:30:53,943: Parsing model.seo_audit.mappings_ga_proc
2018-02-14 09:30:53,946: Parsing model.seo_audit.agg_all
2018-02-14 09:30:53,950: Parsing model.seo_audit.agg_indicative
2018-02-14 09:30:53,952: Parsing model.seo_audit.agg_stats
2018-02-14 09:30:53,958: Parsing model.seo_audit.agg_stats_client
2018-02-14 09:30:53,961: Parsing model.seo_audit.deepcrawl_class
2018-02-14 09:30:53,965: Parsing model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 09:30:53,967: Parsing model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 09:30:53,969: Parsing model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 09:30:53,972: Parsing model.seo_audit.deepcrawl_classification_stats
2018-02-14 09:30:53,977: Parsing model.seo_audit.deepcrawl_proc
2018-02-14 09:30:53,984: Parsing model.seo_audit.deepcrawl_reclass
2018-02-14 09:30:53,990: Parsing model.seo_audit.deepcrawl_reclass_proc
2018-02-14 09:30:54,002: Parsing model.seo_audit.deepcrawl_rules_filename
2018-02-14 09:30:54,005: Parsing model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 09:30:54,008: Parsing model.seo_audit.deepcrawl_rules_first_path
2018-02-14 09:30:54,011: Parsing model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 09:30:54,013: Parsing model.seo_audit.deepcrawl_rules_query_string
2018-02-14 09:30:54,017: Parsing model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 09:30:54,019: Parsing model.seo_audit.deepcrawl_url_proc
2018-02-14 09:30:54,022: Parsing model.seo_audit.ga_proc
2018-02-14 09:30:54,026: Parsing model.seo_audit.ga_proc_pageviews
2018-02-14 09:30:54,029: Parsing model.seo_audit.ga_stats
2018-02-14 09:30:54,032: Parsing model.seo_audit.majestic_domain_history
2018-02-14 09:30:54,036: Parsing model.seo_audit.majestic_domain_proc
2018-02-14 09:30:54,039: Parsing model.seo_audit.majestic_domain_stats
2018-02-14 09:30:54,041: Parsing model.seo_audit.moz_proc
2018-02-14 09:30:54,044: Parsing model.seo_audit.screamingfrog_proc
2018-02-14 09:30:54,047: Parsing model.seo_audit.search_console_history
2018-02-14 09:30:54,049: Parsing model.seo_audit.search_console_proc
2018-02-14 09:30:54,051: Parsing model.seo_audit.search_console_stats_keyword
2018-02-14 09:30:54,055: Parsing model.seo_audit.search_console_stats_url
2018-02-14 09:30:54,056: Parsing model.seo_audit.semrush_domain_proc
2018-02-14 09:30:54,059: Parsing model.seo_audit.semrush_keyword_history
2018-02-14 09:30:54,062: Parsing model.seo_audit.semrush_keyword_proc
2018-02-14 09:30:54,068: Parsing model.seo_audit.semrush_keyword_stats
2018-02-14 09:30:54,077: Parsing model.seo_audit.semrush_url_history
2018-02-14 09:30:54,081: Parsing model.seo_audit.semrush_url_stats
2018-02-14 09:30:54,084: Parsing model.seo_audit.sitemap_proc
2018-02-14 09:30:54,123: Found 43 models, 0 tests, 0 archives, 0 analyses, 40 macros, 0 operations
2018-02-14 09:30:54,256: 
2018-02-14 09:30:55,495: 09:30:55 | Concurrency: 4 threads (target='prod')
2018-02-14 09:30:55,495: 09:30:55 | 
2018-02-14 09:30:55,890: 09:30:55 | 1 of 43 START table model seo_audit.all_dates........................ [RUN]
2018-02-14 09:30:55,891: Compiling model.seo_audit.all_dates
2018-02-14 09:30:55,890: 09:30:55 | 3 of 43 START table model seo_audit.deepcrawl_proc................... [RUN]
2018-02-14 09:30:55,890: 09:30:55 | 2 of 43 START table model seo_audit.accounts_proc.................... [RUN]
2018-02-14 09:30:55,897: Writing injected SQL for node "model.seo_audit.all_dates"
2018-02-14 09:30:55,897: Compiling model.seo_audit.deepcrawl_proc
2018-02-14 09:30:55,897: Compiling model.seo_audit.accounts_proc
2018-02-14 09:30:55,913: Writing injected SQL for node "model.seo_audit.accounts_proc"
2018-02-14 09:30:55,915: Writing injected SQL for node "model.seo_audit.deepcrawl_proc"
2018-02-14 09:30:55,916: Acquiring new bigquery connection "accounts_proc".
2018-02-14 09:30:55,917: Acquiring new bigquery connection "all_dates".
2018-02-14 09:30:55,917: Opening a new connection (1 currently allocated)
2018-02-14 09:30:55,923: Opening a new connection (2 currently allocated)
2018-02-14 09:30:55,985: Acquiring new bigquery connection "deepcrawl_proc".
2018-02-14 09:30:56,039: Opening a new connection (3 currently allocated)
2018-02-14 09:30:57,031: Model SQL (all_dates):
SELECT date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-02-14 09:30:57,064: Model SQL (accounts_proc):
select 
client,
account,
platform platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.accounts`

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-02-14 09:30:57,213: Model SQL (deepcrawl_proc):
SELECT * 
FROM
(
  SELECT 
  regexp_extract(url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain,
  regexp_extract(canonical_url,r'^(?:https?:\/\/)?(?:www\.)?([^\/]+)') as domain_canonical,
  lower(trim(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'/')) as url,
  lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
  lower(trim(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),'/')) canonical_url,
  lower(trim(regexp_replace(replace(replace(replace(canonical_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) canonical_url_stripped,
  count(url) OVER (PARTITION by canonical_url) urls_to_canonical,
  crawl_datetime,
  first_value(crawl_datetime) OVER (PARTITION BY url ORDER BY crawl_datetime desc) last_crawl,
  found_at_sitemap,
  http_status_code,
  level,
  lower(schema_type) schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  lower(h1_tag) h1_tag,
  lower(h2_tag) h2_tag,
  (LENGTH(decimal_price) - LENGTH(REGEXP_REPLACE(decimal_price, '"', '')))/2 as qt_dec_price,
  (LENGTH(currency_price) - LENGTH(REGEXP_REPLACE(currency_price, '"', '')))/2 as qt_cur_price,
  (LENGTH(Add_to_cart) - LENGTH(REGEXP_REPLACE(Add_to_cart, '"', '')))/2 as qt_add_to_cart,
  (LENGTH(Google_Maps) - LENGTH(REGEXP_REPLACE(Google_Maps, '"', '')))/2 as qt_google_maps,
  (LENGTH(Learn_more) - LENGTH(REGEXP_REPLACE(Learn_more, '"', '')))/2 as qt_learn_more,
  (LENGTH(Review) - LENGTH(REGEXP_REPLACE(Review, '"', '')))/2 as qt_reviews,
  (LENGTH(Size) - LENGTH(REGEXP_REPLACE(Size, '"', '')))/2 as qt_size,
  (LENGTH(form_submit) - LENGTH(REGEXP_REPLACE(form_submit, '"', '')))/2 as qt_form_submit,
  (LENGTH(infinite_scroll) - LENGTH(REGEXP_REPLACE(infinite_scroll, '"', '')))/2 as qt_infinite_scroll,
  Decimal_price,
  Currency_price,
  Add_to_cart,
  Learn_more,
  Review,
  Size
  FROM `curious-domain-121318.seo_audit.deepcawl_cifl` 
 )
WHERE last_crawl = crawl_datetime
2018-02-14 09:30:59,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97080>]}
2018-02-14 09:30:59,449: 09:30:59 | 2 of 43 OK created table model seo_audit.accounts_proc............... [CREATE TABLE in 3.34s]
2018-02-14 09:31:00,345: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97c50>]}
2018-02-14 09:31:00,559: 09:31:00 | 1 of 43 OK created table model seo_audit.all_dates................... [CREATE TABLE in 4.45s]
2018-02-14 09:31:00,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97160>]}
2018-02-14 09:31:01,274: 09:31:01 | 3 of 43 OK created table model seo_audit.deepcrawl_proc.............. [CREATE TABLE in 5.06s]
2018-02-14 09:31:01,276: 09:31:01 | 4 of 43 START table model seo_audit.semrush_domain_proc.............. [RUN]
2018-02-14 09:31:01,276: Compiling model.seo_audit.semrush_domain_proc
2018-02-14 09:31:01,276: 09:31:01 | 5 of 43 START table model seo_audit.mappings_ga_proc................. [RUN]
2018-02-14 09:31:01,283: Compiling model.seo_audit.mappings_ga_proc
2018-02-14 09:31:01,293: Writing injected SQL for node "model.seo_audit.semrush_domain_proc"
2018-02-14 09:31:01,276: 09:31:01 | 6 of 43 START table model seo_audit.semrush_keyword_proc............. [RUN]
2018-02-14 09:31:01,294: Compiling model.seo_audit.semrush_keyword_proc
2018-02-14 09:31:01,276: 09:31:01 | 7 of 43 START table model seo_audit.search_console_proc.............. [RUN]
2018-02-14 09:31:01,300: Compiling model.seo_audit.search_console_proc
2018-02-14 09:31:01,304: Writing injected SQL for node "model.seo_audit.mappings_ga_proc"
2018-02-14 09:31:01,309: Writing injected SQL for node "model.seo_audit.semrush_keyword_proc"
2018-02-14 09:31:01,324: Writing injected SQL for node "model.seo_audit.search_console_proc"
2018-02-14 09:31:01,327: Acquiring new bigquery connection "semrush_domain_proc".
2018-02-14 09:31:01,328: Acquiring new bigquery connection "mappings_ga_proc".
2018-02-14 09:31:01,329: Acquiring new bigquery connection "semrush_keyword_proc".
2018-02-14 09:31:01,330: Re-using an available connection from the pool.
2018-02-14 09:31:01,331: Acquiring new bigquery connection "search_console_proc".
2018-02-14 09:31:01,332: Re-using an available connection from the pool.
2018-02-14 09:31:01,333: Re-using an available connection from the pool.
2018-02-14 09:31:01,334: Opening a new connection (4 currently allocated)
2018-02-14 09:31:01,988: Model SQL (semrush_keyword_proc):
SELECT  
date, 
unix_date(date) unix_date,
account,
'SEMrush' as platform,
lower(trim(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),' '),'/')) as url,
keyword,
min(position) as position, 
min(previous_position) as previous_position, 
max(search_volume) as search_volume,
max(cpc) as cpc
FROM `curious-domain-121318.seo_audit.semrush_keyword`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, unix_date, account, platform, url, keyword
2018-02-14 09:31:02,081: Model SQL (mappings_ga_proc):
select 
client,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `curious-domain-121318.seo_audit.mappings_ga`

) 

WHERE lv = time_of_entry
and client in (select client from `curious-domain-121318`.`seo_audit`.`accounts_proc` )
group by client, source, medium, platform_n, channel_n, time_of_entry
order by client asc, source asc
2018-02-14 09:31:02,122: Model SQL (semrush_domain_proc):
SELECT  
account,
'SEMrush' as platform,
date,
max(organic_keywords) as organic_keywords,
max(organic_traffic) as organic_traffic,
max(organic_value) as organic_value
FROM `curious-domain-121318.seo_audit.semrush_domain`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by account, platform, date
order by account asc, date asc
2018-02-14 09:31:02,328: Model SQL (search_console_proc):
SELECT  
date, 
unix_date(date) as unix_date,
site as account,
'Organic' as platform,
lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
keyword,
max(impressions) as impressions, 
max(clicks) as clicks, 
min(position) as position
FROM `curious-domain-121318.seo_audit.gsc`
where site in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Organic')
group by date, unix_date, account, platform, url, keyword
2018-02-14 09:31:04,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bfd438>]}
2018-02-14 09:31:04,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b0a0f0>]}
2018-02-14 09:31:04,278: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9afd0>]}
2018-02-14 09:31:04,373: 09:31:04 | 6 of 43 OK created table model seo_audit.semrush_keyword_proc........ [CREATE TABLE in 2.85s]
2018-02-14 09:31:04,374: 09:31:04 | 8 of 43 START table model seo_audit.majestic_domain_proc............. [RUN]
2018-02-14 09:31:04,375: Compiling model.seo_audit.majestic_domain_proc
2018-02-14 09:31:04,385: Writing injected SQL for node "model.seo_audit.majestic_domain_proc"
2018-02-14 09:31:04,387: Acquiring new bigquery connection "majestic_domain_proc".
2018-02-14 09:31:04,387: Re-using an available connection from the pool.
2018-02-14 09:31:04,600: 09:31:04 | 5 of 43 OK created table model seo_audit.mappings_ga_proc............ [CREATE TABLE in 2.96s]
2018-02-14 09:31:04,601: 09:31:04 | 9 of 43 START table model seo_audit.moz_proc......................... [RUN]
2018-02-14 09:31:04,602: Compiling model.seo_audit.moz_proc
2018-02-14 09:31:04,608: Writing injected SQL for node "model.seo_audit.moz_proc"
2018-02-14 09:31:04,610: Acquiring new bigquery connection "moz_proc".
2018-02-14 09:31:04,612: Re-using an available connection from the pool.
2018-02-14 09:31:04,839: 09:31:04 | 4 of 43 OK created table model seo_audit.semrush_domain_proc......... [CREATE TABLE in 3.00s]
2018-02-14 09:31:04,839: 09:31:04 | 10 of 43 START table model seo_audit.screamingfrog_proc.............. [RUN]
2018-02-14 09:31:04,839: Compiling model.seo_audit.screamingfrog_proc
2018-02-14 09:31:04,851: Writing injected SQL for node "model.seo_audit.screamingfrog_proc"
2018-02-14 09:31:04,852: Acquiring new bigquery connection "screamingfrog_proc".
2018-02-14 09:31:04,852: Re-using an available connection from the pool.
2018-02-14 09:31:05,092: Model SQL (majestic_domain_proc):
SELECT  
account,
'Majestic' as platform,
source_domain,
lower(trim(regexp_replace(replace(replace(replace(target_url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as target_url,
min(date) as date, 
max(citation_flow) as citation_flow,
max(trust_flow) as trust_flow
FROM `curious-domain-121318.seo_audit.majestic` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Majestic')
and citation_flow > 20
group by account, platform, source_domain, target_url
2018-02-14 09:31:05,236: Model SQL (moz_proc):
SELECT  
account,
'Moz' as platform,
date,
max(domain_authority) as domain_authority
FROM `curious-domain-121318.seo_audit.moz`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Moz')
group by account, platform, date
order by account asc, date asc
2018-02-14 09:31:05,603: Model SQL (screamingfrog_proc):
SELECT
b.client client,
url,
title,
title_length,
description,
description_length,
word_count,
status_code,
meta_robots,
canonical_link_element,
content
FROM 

(

	SELECT  
	filename as account,
	'ScreamingFrog' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	title,
	title_length,
	description,
	description_length,
	word_count,
	status_code,
	meta_robots,
	canonical_link_element,
	content,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY filename ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.screamingfrog` 
	where filename in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'ScreamingFrog')
	and content = 'text/html; charset=UTF-8'

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
WHERE time_of_entry = lv
2018-02-14 09:31:07,252: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b0a208>]}
2018-02-14 09:31:07,477: 09:31:07 | 8 of 43 OK created table model seo_audit.majestic_domain_proc........ [CREATE TABLE in 2.88s]
2018-02-14 09:31:07,478: 09:31:07 | 11 of 43 START table model seo_audit.sitemap_proc.................... [RUN]
2018-02-14 09:31:07,478: Compiling model.seo_audit.sitemap_proc
2018-02-14 09:31:07,486: Writing injected SQL for node "model.seo_audit.sitemap_proc"
2018-02-14 09:31:07,487: Acquiring new bigquery connection "sitemap_proc".
2018-02-14 09:31:07,487: Re-using an available connection from the pool.
2018-02-14 09:31:07,815: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9afd0>]}
2018-02-14 09:31:08,037: 09:31:08 | 10 of 43 OK created table model seo_audit.screamingfrog_proc......... [CREATE TABLE in 2.98s]
2018-02-14 09:31:08,097: Model SQL (sitemap_proc):
SELECT 
a.sitemap,
b.client,
url
FROM 
(

	SELECT  
	sitemap as account,
	sitemap,
	'Sitemap' as platform,
	lower(trim(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY sitemap ORDER BY time_of_entry DESC) lv
	FROM `curious-domain-121318.seo_audit.sitemap` 
	where sitemap in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Sitemap')

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
where time_of_entry = lv
2018-02-14 09:31:08,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b0a0f0>]}
2018-02-14 09:31:08,817: 09:31:08 | 9 of 43 OK created table model seo_audit.moz_proc.................... [CREATE TABLE in 3.90s]
2018-02-14 09:31:08,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111af7d68>]}
2018-02-14 09:31:09,132: 09:31:09 | 7 of 43 OK created table model seo_audit.search_console_proc......... [CREATE TABLE in 7.62s]
2018-02-14 09:31:12,452: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b0a208>]}
2018-02-14 09:31:12,758: 09:31:12 | 11 of 43 OK created table model seo_audit.sitemap_proc............... [CREATE TABLE in 4.97s]
2018-02-14 09:31:12,759: 09:31:12 | 12 of 43 START table model seo_audit.majestic_domain_history......... [RUN]
2018-02-14 09:31:12,760: Compiling model.seo_audit.majestic_domain_history
2018-02-14 09:31:12,760: 09:31:12 | 13 of 43 START table model seo_audit.deepcrawl_url_proc.............. [RUN]
2018-02-14 09:31:12,766: Compiling model.seo_audit.deepcrawl_url_proc
2018-02-14 09:31:12,760: 09:31:12 | 14 of 43 START table model seo_audit.semrush_keyword_history......... [RUN]
2018-02-14 09:31:12,780: Writing injected SQL for node "model.seo_audit.majestic_domain_history"
2018-02-14 09:31:12,760: 09:31:12 | 15 of 43 START table model seo_audit.semrush_url_history............. [RUN]
2018-02-14 09:31:12,781: Writing injected SQL for node "model.seo_audit.deepcrawl_url_proc"
2018-02-14 09:31:12,781: Compiling model.seo_audit.semrush_keyword_history
2018-02-14 09:31:12,781: Compiling model.seo_audit.semrush_url_history
2018-02-14 09:31:12,787: Writing injected SQL for node "model.seo_audit.semrush_keyword_history"
2018-02-14 09:31:12,792: Writing injected SQL for node "model.seo_audit.semrush_url_history"
2018-02-14 09:31:12,794: Acquiring new bigquery connection "semrush_keyword_history".
2018-02-14 09:31:12,795: Acquiring new bigquery connection "majestic_domain_history".
2018-02-14 09:31:12,796: Acquiring new bigquery connection "semrush_url_history".
2018-02-14 09:31:12,797: Acquiring new bigquery connection "deepcrawl_url_proc".
2018-02-14 09:31:12,797: Re-using an available connection from the pool.
2018-02-14 09:31:12,798: Re-using an available connection from the pool.
2018-02-14 09:31:12,800: Re-using an available connection from the pool.
2018-02-14 09:31:12,802: Re-using an available connection from the pool.
2018-02-14 09:31:13,350: Model SQL (deepcrawl_url_proc):
select
b.client,
a.platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
case when url = canonical_url then 'self'
  when url_stripped = canonical_url_stripped then 'self_query_string_mismatch'
  when url_stripped != canonical_url_stripped then 'canonicalized'
  when canonical_url = '' or canonical_url is null then 'missing_canonical'
  else '' end as canonical_status,
path_count,
ifnull(first_path, '') first_path,
ifnull(last_path, '') last_path,
ifnull(query_string, '') query_string,
ifnull(split(split(last_path,'.')[SAFE_ORDINAL(2)],'?')[SAFE_ORDINAL(1)],'') as filename,
trim(replace(url, last_path, ''),'/') last_subfolder,
trim(replace(canonical_url, last_path, ''),'/') last_subfolder_canonical,
concat(domain,'/',first_path) first_subfolder,
urls_to_canonical,
last_crawl,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
case when found_at_sitemap like '%category%' then 'category'
  when found_at_sitemap like '%product%' then 'product'
  when found_at_sitemap like '%post%' then 'article'
  when found_at_sitemap like '%location%' then 'local'
  else null end as class_sitemap,
case when schema_type like '%product%' then 'product'
  when ( schema_type like '%creativework%' or schema_type like '%blog%' or schema_type like '%article%') then 'article'
  when schema_type like '%event%' then 'info'
  when schema_type like '%local%' or schema_type like '%place%' then 'local'
  else null end as class_schema,  
case when qt_google_maps > min_google_maps then 'local'
  else null end as class_google_maps,  
case when qt_cur_price > min_cur_price then 1 else 0 end as flag_prices,
case when qt_cur_price > avg_cur_price then 1 else 0 end as flag_above_avg_prices,
case when qt_cur_price = min_cur_price then 1 else 0 end as flag_min_prices,
case when qt_add_to_cart > min_add_to_cart then 1 else 0 end as flag_add_to_cart,
case when qt_reviews > min_reviews then 1 else 0 end as flag_reviews,
case when qt_size > min_size then 1 else 0 end as flag_select_size,
case when qt_learn_more > min_learn_more then 1 else 0 end as flag_learn_more,
case when med_word_count > word_count then 1 else 0 end as flag_high_word_count,
case when word_count < 500 then 1 else 0 end as flag_thin_page,
case when qt_form_submit > min_form_submit then 1 else 0 end as flag_form_submit,
case when regexp_contains(url, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_path,
case when regexp_contains(h1_tag, r'/blog|blog.|resource|article|knowledge') then 1 else 0 end as flag_blog_h1,
case when regexp_contains(url, r'sitemap|customer-service|returns|affiliate|loyalty|register|wholesale|about-us|help|account|wishlist|jobs|password|contact|stores') then 1 else 0 end as flag_info_path,
case when rel_next_url is not null or rel_prev_url is not null or qt_infinite_scroll > 0 then 1 else 0 end as flag_paginated 

FROM 
 (
  SELECT
  'Deepcrawl' as platform,
  domain,
  domain_canonical,
  url,
  url_stripped,
  canonical_url,
  canonical_url_stripped,
  ARRAY_LENGTH(SPLIT(url, '/')) path_count,
  SPLIT(url, '/')[SAFE_ORDINAL(2)] first_path,
  ARRAY_REVERSE(SPLIT(url, '/'))[SAFE_ORDINAL(1)] last_path,
  ARRAY_REVERSE(SPLIT(canonical_url, '/'))[SAFE_ORDINAL(1)] last_path_canonical,
  ifnull(split(url, '?')[SAFE_ORDINAL(2)], '') as full_query_string,
  ifnull(split(canonical_url, '?')[SAFE_ORDINAL(2)], '') as full_query_string_canonical,
  ifnull(split(split(canonical_url, '?')[SAFE_ORDINAL(2)],'=')[SAFE_ORDINAL(1)], '') as query_string,
  urls_to_canonical,
  last_crawl,
  crawl_datetime,
  found_at_sitemap,
  http_status_code,
  level,
  schema_type,
  header_content_type,
  word_count, 
  page_title,
  page_title_length,
  description,
  description_length,
  indexable,
  robots_noindex,
  is_self_canonical,
  backlink_count,
  backlink_domain_count,
  redirected_to_url,
  found_at_url,
  rel_next_url,
  rel_prev_url,
  h1_tag,
  h2_tag,
  PERCENTILE_DISC(word_count, 0.5 RESPECT NULLS) OVER (PARTITION BY header_content_type) AS med_word_count,
  qt_dec_price,
  min(qt_dec_price) OVER w1 AS min_dec_price,
  avg(qt_dec_price) OVER w1 AS avg_dec_price,
  PERCENTILE_DISC(qt_dec_price, 0.5 RESPECT NULLS) OVER w2 AS med_dec_price,
  qt_cur_price,
  min(qt_cur_price) OVER w1 AS min_cur_price,
  avg(qt_cur_price) OVER w1 AS avg_cur_price,
  PERCENTILE_DISC(qt_cur_price, 0.5 RESPECT NULLS) OVER w2 AS med_cur_price,
  qt_add_to_cart,
  min(qt_add_to_cart) OVER w1 AS min_add_to_cart,
  qt_reviews,
  min(qt_reviews) OVER w1 AS min_reviews,
  qt_size,
  min(qt_size) OVER w1 AS min_size,
  qt_google_maps,
  min(qt_google_maps) OVER w1 AS min_google_maps,
  qt_learn_more,
  min(qt_google_maps) OVER w1 AS min_learn_more,
  qt_form_submit,
  min(qt_form_submit) OVER w1 AS min_form_submit,
  qt_infinite_scroll
  FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_proc`
  WINDOW w1 as (PARTITION BY header_content_type ORDER BY http_status_code desc),
  w2 as (PARTITION BY header_content_type),
  w3 as (PARTITION BY url_trimmed ORDER BY url_length asc)
  ) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.domain = b.account
  and a.platform = b.platform )
2018-02-14 09:31:13,417: Model SQL (semrush_keyword_history):
SELECT
date, 
account, 
platform, 
url, 
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
max(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
max(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
max(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
max(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as semrush_top_keyword_vol,
first_value(search_volume) OVER w1 as semrush_top_keyword_vol_vol,
first_value(cpc) OVER w1 as semrush_top_keyword_vol_cpc,
first_value(keyword) OVER w2 as semrush_top_keyword_cpc,
first_value(search_volume) OVER w2 as semrush_top_keyword_cpc_vol,
first_value(cpc) OVER w2 as semrush_top_keyword_cpc_cpc
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY search_volume desc),
w2 AS (PARTITION BY account, url, date ORDER BY cpc desc)

)

GROUP BY date, account, platform, url, semrush_top_keyword_vol, semrush_top_keyword_cpc
ORDER BY url asc, date desc
2018-02-14 09:31:13,445: Model SQL (majestic_domain_history):
SELECT 
account, 
platform, 
url,
date, 
SUM(ref_domain_count) OVER(PARTITION BY account, url ORDER BY date asc) as ref_domain_count,
SUM(citation_flow) OVER(PARTITION BY account, url ORDER BY date asc) as citation_flow_sum,
SUM(trust_flow) OVER(PARTITION BY account, url ORDER BY date asc) as trust_flow_sum
FROM (

SELECT  
account,
platform,
target_url url,
date,
count(source_domain) as ref_domain_count,
sum(citation_flow) as citation_flow,
sum(trust_flow) as trust_flow
FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_proc`
group by account, platform, date, url

)
2018-02-14 09:31:13,587: Model SQL (semrush_url_history):
SELECT  
date, 
account,
platform,
url,
count(distinct(keyword)) semrush_keyword_count,
sum(cpc) semrush_total_cpc,
sum(search_volume) semrush_total_search_volume
FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_proc`
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'SEMrush')
group by date, account, platform, url
2018-02-14 09:31:15,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be2048>]}
2018-02-14 09:31:15,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be2a58>]}
2018-02-14 09:31:15,678: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:15,857: 09:31:15 | 14 of 43 OK created table model seo_audit.semrush_keyword_history.... [CREATE TABLE in 2.79s]
2018-02-14 09:31:15,858: 09:31:15 | 16 of 43 START table model seo_audit.search_console_history.......... [RUN]
2018-02-14 09:31:15,858: Compiling model.seo_audit.search_console_history
2018-02-14 09:31:15,869: Writing injected SQL for node "model.seo_audit.search_console_history"
2018-02-14 09:31:15,871: Acquiring new bigquery connection "search_console_history".
2018-02-14 09:31:15,871: Re-using an available connection from the pool.
2018-02-14 09:31:16,087: 09:31:16 | 12 of 43 OK created table model seo_audit.majestic_domain_history.... [CREATE TABLE in 2.91s]
2018-02-14 09:31:16,403: 09:31:16 | 13 of 43 OK created table model seo_audit.deepcrawl_url_proc......... [CREATE TABLE in 2.91s]
2018-02-14 09:31:16,516: Model SQL (search_console_history):
SELECT  
date, 
unix_date,
account,
platform,
url,
keyword,
sum(impressions) OVER w1 as impressions_90d,
sum(clicks) OVER w1 as clicks_90d,
(sum(clicks) OVER w1)/(sum(impressions) OVER w1) as ctr_90d,
(sum(impressions * position) OVER w1)/(sum(impressions) OVER w1) as pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_proc`
WINDOW w1 AS (PARTITION BY account, url, keyword ORDER BY unix_date asc RANGE BETWEEN 90 PRECEDING AND CURRENT ROW)
2018-02-14 09:31:16,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97550>]}
2018-02-14 09:31:17,170: 09:31:17 | 15 of 43 OK created table model seo_audit.semrush_url_history........ [CREATE TABLE in 4.07s]
2018-02-14 09:31:19,816: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b370b8>]}
2018-02-14 09:31:20,031: 09:31:20 | 16 of 43 OK created table model seo_audit.search_console_history..... [CREATE TABLE in 3.96s]
2018-02-14 09:31:20,032: 09:31:20 | 17 of 43 START table model seo_audit.search_console_stats_url........ [RUN]
2018-02-14 09:31:20,033: 09:31:20 | 18 of 43 START table model seo_audit.deepcrawl_class................. [RUN]
2018-02-14 09:31:20,033: Compiling model.seo_audit.search_console_stats_url
2018-02-14 09:31:20,033: 09:31:20 | 19 of 43 START table model seo_audit.search_console_stats_keyword.... [RUN]
2018-02-14 09:31:20,033: Compiling model.seo_audit.deepcrawl_class
2018-02-14 09:31:20,040: Compiling model.seo_audit.search_console_stats_keyword
2018-02-14 09:31:20,042: Writing injected SQL for node "model.seo_audit.search_console_stats_url"
2018-02-14 09:31:20,056: Writing injected SQL for node "model.seo_audit.deepcrawl_class"
2018-02-14 09:31:20,057: Writing injected SQL for node "model.seo_audit.search_console_stats_keyword"
2018-02-14 09:31:20,058: Acquiring new bigquery connection "search_console_stats_url".
2018-02-14 09:31:20,059: Re-using an available connection from the pool.
2018-02-14 09:31:20,061: Acquiring new bigquery connection "deepcrawl_class".
2018-02-14 09:31:20,061: Re-using an available connection from the pool.
2018-02-14 09:31:20,064: Acquiring new bigquery connection "search_console_stats_keyword".
2018-02-14 09:31:20,064: Re-using an available connection from the pool.
2018-02-14 09:31:20,763: Model SQL (deepcrawl_class):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
first_path,
last_path,
query_string,
filename,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score,
case 
	when first_path is null then 'homepage'
	when class_schema is not null then class_schema
	when class_google_maps is not null then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 ) then 'info'
	when product_score >=2 or class_sitemap = 'product' then 'product'
	when flag_prices = 1 then 'product_category'
	when flag_form_submit = 1 then 'lead_generation'
	when flag_learn_more = 1  then 'blog_category'
	when class_sitemap is not null then class_sitemap
	when article_score >= 1 then 'article'
	else 'unclassified' end as classification
FROM 
(
	SELECT 
	client,
	platform,
	domain,
	domain_canonical,
	url,
	url_stripped,
	canonical_url,
	canonical_url_stripped,
	canonical_status,
	path_count,
	first_path,
	last_path,
	query_string,
	filename,
	last_subfolder,
	last_subfolder_canonical,
	first_subfolder,
	urls_to_canonical,
	crawl_datetime,
	found_at_sitemap,
	http_status_code,
	level,
	schema_type,
	header_content_type,
	word_count, 
	med_word_count,
	page_title,
	page_title_length,
	description,
	description_length,
	indexable,
	robots_noindex,
	is_self_canonical,
	backlink_count,
	backlink_domain_count,
	redirected_to_url,
	found_at_url,
	rel_next_url,
	rel_prev_url,
	h1_tag,
	h2_tag,
	class_sitemap,
	class_schema,
	class_google_maps,
	flag_blog_path,
	flag_blog_h1,
	flag_high_word_count,
	flag_thin_page,
	flag_reviews,
	flag_select_size,
	flag_add_to_cart,
	flag_prices,
	flag_above_avg_prices,
	flag_learn_more,
	flag_info_path,
	flag_form_submit,
	flag_paginated,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_prices) as product_score,
	(flag_reviews + flag_select_size + flag_add_to_cart + flag_above_avg_prices) as category_score,
	(flag_blog_path + flag_blog_h1 + flag_high_word_count) as article_score
	FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_url_proc`
)
2018-02-14 09:31:20,778: Model SQL (search_console_stats_keyword):
SELECT
date, 
account, 
platform, 
url, 
keyword gsc_top_keyword_90d, 
first_value(url) OVER w2 as gsc_top_url_for_keyword_90d,
max(impressions) gsc_top_keyword_impressions_90d, 
max(clicks) gsc_top_keyword_clicks_90d, 
max(ctr) gsc_top_keyword_ctr_90d
FROM 

(

SELECT  
date, 
account,
platform,
url,
first_value(keyword) OVER w1 as keyword,
first_value(impressions_90d) OVER w1 as impressions,
first_value(clicks_90d) OVER w1 as clicks,
first_value(ctr_90d) OVER w1 as ctr
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
where keyword not in ('cifl', 'losers', 'coding is for losers')
WINDOW w1 AS (PARTITION BY account, url, date ORDER BY impressions_90d desc)

)

GROUP BY date, account, platform, url, gsc_top_keyword_90d
WINDOW w2 AS (PARTITION BY account, keyword, date ORDER BY max(impressions) desc)
ORDER BY url asc, date desc
2018-02-14 09:31:20,782: Model SQL (search_console_stats_url):
SELECT 
date,
account,
platform,
url,
count(distinct(keyword)) as gsc_keyword_count_90d,
sum(impressions_90d) as gsc_impressions_90d,
sum(clicks_90d) as gsc_clicks_90d,	
sum(clicks_90d)/sum(impressions_90d) as gsc_ctr_90d,
sum(impressions_90d * pos_90d)/sum(impressions_90d) as gsc_pos_90d
FROM `curious-domain-121318`.`seo_audit`.`search_console_history`
GROUP BY date, account, platform, url
2018-02-14 09:31:21,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be20f0>]}
2018-02-14 09:31:22,150: 09:31:22 | 18 of 43 OK created table model seo_audit.deepcrawl_class............ [CREATE TABLE in 1.81s]
2018-02-14 09:31:22,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b866a0>]}
2018-02-14 09:31:23,272: 09:31:23 | 19 of 43 OK created table model seo_audit.search_console_stats_keyword [CREATE TABLE in 2.94s]
2018-02-14 09:31:25,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:25,382: 09:31:25 | 17 of 43 OK created table model seo_audit.search_console_stats_url... [CREATE TABLE in 5.06s]
2018-02-14 09:31:25,382: 09:31:25 | 20 of 43 START table model seo_audit.majestic_domain_stats........... [RUN]
2018-02-14 09:31:25,383: 09:31:25 | 21 of 43 START table model seo_audit.semrush_keyword_stats........... [RUN]
2018-02-14 09:31:25,383: 09:31:25 | 22 of 43 START table model seo_audit.semrush_url_stats............... [RUN]
2018-02-14 09:31:25,383: 09:31:25 | 23 of 43 START table model seo_audit.deepcrawl_classification_stats.. [RUN]
2018-02-14 09:31:25,384: Compiling model.seo_audit.majestic_domain_stats
2018-02-14 09:31:25,384: Compiling model.seo_audit.semrush_keyword_stats
2018-02-14 09:31:25,384: Compiling model.seo_audit.semrush_url_stats
2018-02-14 09:31:25,384: Compiling model.seo_audit.deepcrawl_classification_stats
2018-02-14 09:31:25,414: Writing injected SQL for node "model.seo_audit.semrush_url_stats"
2018-02-14 09:31:25,417: Writing injected SQL for node "model.seo_audit.majestic_domain_stats"
2018-02-14 09:31:25,422: Writing injected SQL for node "model.seo_audit.semrush_keyword_stats"
2018-02-14 09:31:25,427: Writing injected SQL for node "model.seo_audit.deepcrawl_classification_stats"
2018-02-14 09:31:25,429: Acquiring new bigquery connection "semrush_url_stats".
2018-02-14 09:31:25,430: Acquiring new bigquery connection "deepcrawl_classification_stats".
2018-02-14 09:31:25,431: Acquiring new bigquery connection "majestic_domain_stats".
2018-02-14 09:31:25,431: Re-using an available connection from the pool.
2018-02-14 09:31:25,432: Acquiring new bigquery connection "semrush_keyword_stats".
2018-02-14 09:31:25,433: Re-using an available connection from the pool.
2018-02-14 09:31:25,434: Re-using an available connection from the pool.
2018-02-14 09:31:25,436: Re-using an available connection from the pool.
2018-02-14 09:31:26,017: Model SQL (deepcrawl_classification_stats):
with first_path as (
	
	SELECT
	'first_path' as type,
	first_path as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	first_path, classification
),

filename as (
	SELECT
	'filename' as type,
	filename as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	filename, classification

),

query_string as (
	SELECT
	'query_string' as type,
	query_string as value,
	classification,
	count(url) count
	FROM 
	`curious-domain-121318`.`seo_audit`.`deepcrawl_class`
	GROUP BY 
	query_string, classification
)

SELECT 
type,
value,
count,
classification,
count/SUM(count) OVER (PARTITION BY classification, type) as pct_of_classification,
count/SUM(count) OVER (PARTITION BY value, type) as pct_of_value
FROM (

	SELECT * FROM first_path
	UNION ALL
	SELECT * FROM filename
	UNION ALL
	SELECT * FROM query_string

)
2018-02-14 09:31:26,099: Model SQL (semrush_url_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_url_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d,
  semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_keyword_count, semrush_total_cpc, semrush_total_search_volume
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 09:31:26,146: Model SQL (semrush_keyword_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`semrush_keyword_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, semrush_top_keyword_vol, semrush_top_keyword_cpc,
  semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc,
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, 
semrush_top_keyword_vol, semrush_top_keyword_cpc,
semrush_top_keyword_vol_vol, semrush_top_keyword_vol_cpc, semrush_top_keyword_cpc_vol, semrush_top_keyword_cpc_cpc
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
2018-02-14 09:31:26,187: Model SQL (majestic_domain_stats):
WITH history AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`majestic_domain_history`
),
daterange AS (
	SELECT * FROM `curious-domain-121318`.`seo_audit`.`all_dates`  	
),
temp AS (
  SELECT account, url, platform, date d, ref_domain_count, citation_flow_sum, trust_flow_sum, 
  LEAD(date) OVER(PARTITION BY account, url, platform ORDER BY date) AS next_date
  FROM history
  ORDER BY account, platform, url, date
)
SELECT date_in_range, account, platform, url, ref_domain_count, citation_flow_sum/ref_domain_count as avg_citation_flow, trust_flow_sum/ref_domain_count as avg_trust_flow
FROM daterange
JOIN temp
ON daterange.date_in_range >= temp.d
AND (daterange.date_in_range < temp.next_date OR temp.next_date IS NULL)
ORDER BY account, platform, url, date_in_range
2018-02-14 09:31:28,186: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bfdd68>]}
2018-02-14 09:31:28,263: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111bfdf28>]}
2018-02-14 09:31:28,322: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b866a0>]}
2018-02-14 09:31:28,402: 09:31:28 | 23 of 43 OK created table model seo_audit.deepcrawl_classification_stats [CREATE TABLE in 2.80s]
2018-02-14 09:31:28,619: 09:31:28 | 22 of 43 OK created table model seo_audit.semrush_url_stats.......... [CREATE TABLE in 2.88s]
2018-02-14 09:31:28,915: 09:31:28 | 21 of 43 OK created table model seo_audit.semrush_keyword_stats...... [CREATE TABLE in 2.94s]
2018-02-14 09:31:29,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b370b8>]}
2018-02-14 09:31:29,762: 09:31:29 | 20 of 43 OK created table model seo_audit.majestic_domain_stats...... [CREATE TABLE in 4.08s]
2018-02-14 09:31:29,762: 09:31:29 | 24 of 43 START table model seo_audit.deepcrawl_rules_first_path...... [RUN]
2018-02-14 09:31:29,763: Compiling model.seo_audit.deepcrawl_rules_first_path
2018-02-14 09:31:29,769: 09:31:29 | 25 of 43 START table model seo_audit.deepcrawl_rules_filename........ [RUN]
2018-02-14 09:31:29,769: Compiling model.seo_audit.deepcrawl_rules_filename
2018-02-14 09:31:29,775: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path"
2018-02-14 09:31:29,776: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename"
2018-02-14 09:31:29,774: 09:31:29 | 26 of 43 START table model seo_audit.deepcrawl_class_stats_first_path [RUN]
2018-02-14 09:31:29,775: 09:31:29 | 27 of 43 START table model seo_audit.deepcrawl_rules_query_string.... [RUN]
2018-02-14 09:31:29,776: Compiling model.seo_audit.deepcrawl_class_stats_first_path
2018-02-14 09:31:29,777: Compiling model.seo_audit.deepcrawl_rules_query_string
2018-02-14 09:31:29,777: Acquiring new bigquery connection "deepcrawl_rules_first_path".
2018-02-14 09:31:29,787: Re-using an available connection from the pool.
2018-02-14 09:31:29,783: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_first_path"
2018-02-14 09:31:29,787: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string"
2018-02-14 09:31:29,778: Acquiring new bigquery connection "deepcrawl_rules_filename".
2018-02-14 09:31:29,788: Re-using an available connection from the pool.
2018-02-14 09:31:29,791: Acquiring new bigquery connection "deepcrawl_rules_query_string".
2018-02-14 09:31:29,792: Acquiring new bigquery connection "deepcrawl_class_stats_first_path".
2018-02-14 09:31:29,794: Re-using an available connection from the pool.
2018-02-14 09:31:29,801: Re-using an available connection from the pool.
2018-02-14 09:31:30,492: Model SQL (deepcrawl_rules_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 09:31:30,496: Model SQL (deepcrawl_class_stats_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
2018-02-14 09:31:30,498: Model SQL (deepcrawl_rules_first_path):
SELECT
type,
value as first_path,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'first_path'
and pct_of_classification > .9
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 09:31:30,498: Model SQL (deepcrawl_rules_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
and pct_of_classification > 0.9 
and pct_of_classification != 1
and pct_of_value != 1
2018-02-14 09:31:31,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97978>]}
2018-02-14 09:31:31,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:31,884: 09:31:31 | 27 of 43 OK created table model seo_audit.deepcrawl_rules_query_string [CREATE TABLE in 1.81s]
2018-02-14 09:31:31,886: 09:31:31 | 28 of 43 START table model seo_audit.deepcrawl_class_stats_filename.. [RUN]
2018-02-14 09:31:31,889: Compiling model.seo_audit.deepcrawl_class_stats_filename
2018-02-14 09:31:31,898: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_filename"
2018-02-14 09:31:31,899: Acquiring new bigquery connection "deepcrawl_class_stats_filename".
2018-02-14 09:31:31,899: Re-using an available connection from the pool.
2018-02-14 09:31:32,103: 09:31:32 | 24 of 43 OK created table model seo_audit.deepcrawl_rules_first_path. [CREATE TABLE in 1.84s]
2018-02-14 09:31:32,103: 09:31:32 | 29 of 43 START table model seo_audit.deepcrawl_class_stats_query_string [RUN]
2018-02-14 09:31:32,104: Compiling model.seo_audit.deepcrawl_class_stats_query_string
2018-02-14 09:31:32,108: Writing injected SQL for node "model.seo_audit.deepcrawl_class_stats_query_string"
2018-02-14 09:31:32,109: Acquiring new bigquery connection "deepcrawl_class_stats_query_string".
2018-02-14 09:31:32,110: Re-using an available connection from the pool.
2018-02-14 09:31:32,467: Model SQL (deepcrawl_class_stats_filename):
SELECT
type,
value as filename,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'filename'
2018-02-14 09:31:32,676: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111be24a8>]}
2018-02-14 09:31:32,739: Model SQL (deepcrawl_class_stats_query_string):
SELECT
type,
value as query_string,
count,
classification,
pct_of_classification,
pct_of_value
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_classification_stats`
WHERE 
type = 'query_string'
2018-02-14 09:31:32,774: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:31:32,970: 09:31:32 | 25 of 43 OK created table model seo_audit.deepcrawl_rules_filename... [CREATE TABLE in 2.91s]
2018-02-14 09:31:33,268: 09:31:33 | 26 of 43 OK created table model seo_audit.deepcrawl_class_stats_first_path [CREATE TABLE in 3.00s]
2018-02-14 09:31:33,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97978>]}
2018-02-14 09:31:33,769: 09:31:33 | 28 of 43 OK created table model seo_audit.deepcrawl_class_stats_filename [CREATE TABLE in 1.65s]
2018-02-14 09:31:34,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:35,128: 09:31:35 | 29 of 43 OK created table model seo_audit.deepcrawl_class_stats_query_string [CREATE TABLE in 2.81s]
2018-02-14 09:31:35,129: 09:31:35 | 30 of 43 START table model seo_audit.deepcrawl_rules_query_string_unclassified [RUN]
2018-02-14 09:31:35,130: Compiling model.seo_audit.deepcrawl_rules_query_string_unclassified
2018-02-14 09:31:35,130: 09:31:35 | 31 of 43 START table model seo_audit.deepcrawl_rules_filename_unclassified [RUN]
2018-02-14 09:31:35,130: 09:31:35 | 32 of 43 START table model seo_audit.deepcrawl_rules_first_path_unclassified [RUN]
2018-02-14 09:31:35,139: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_query_string_unclassified"
2018-02-14 09:31:35,140: Compiling model.seo_audit.deepcrawl_rules_filename_unclassified
2018-02-14 09:31:35,140: Compiling model.seo_audit.deepcrawl_rules_first_path_unclassified
2018-02-14 09:31:35,147: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_filename_unclassified"
2018-02-14 09:31:35,152: Writing injected SQL for node "model.seo_audit.deepcrawl_rules_first_path_unclassified"
2018-02-14 09:31:35,153: Acquiring new bigquery connection "deepcrawl_rules_query_string_unclassified".
2018-02-14 09:31:35,153: Acquiring new bigquery connection "deepcrawl_rules_filename_unclassified".
2018-02-14 09:31:35,154: Re-using an available connection from the pool.
2018-02-14 09:31:35,154: Acquiring new bigquery connection "deepcrawl_rules_first_path_unclassified".
2018-02-14 09:31:35,155: Re-using an available connection from the pool.
2018-02-14 09:31:35,156: Re-using an available connection from the pool.
2018-02-14 09:31:35,787: Model SQL (deepcrawl_rules_query_string_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string`
order by pct_of_value desc
limit 1
2018-02-14 09:31:35,798: Model SQL (deepcrawl_rules_first_path_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path`
order by pct_of_value desc
limit 1
2018-02-14 09:31:35,848: Model SQL (deepcrawl_rules_filename_unclassified):
SELECT
*
FROM
`curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename`
order by pct_of_value desc
limit 1
2018-02-14 09:31:36,883: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b370b8>]}
2018-02-14 09:31:36,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4eb70>]}
2018-02-14 09:31:36,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b86860>]}
2018-02-14 09:31:37,143: 09:31:37 | 30 of 43 OK created table model seo_audit.deepcrawl_rules_query_string_unclassified [CREATE TABLE in 1.75s]
2018-02-14 09:31:37,359: 09:31:37 | 32 of 43 OK created table model seo_audit.deepcrawl_rules_first_path_unclassified [CREATE TABLE in 1.75s]
2018-02-14 09:31:37,579: 09:31:37 | 31 of 43 OK created table model seo_audit.deepcrawl_rules_filename_unclassified [CREATE TABLE in 1.78s]
2018-02-14 09:31:37,580: 09:31:37 | 33 of 43 START table model seo_audit.deepcrawl_reclass_proc.......... [RUN]
2018-02-14 09:31:37,581: Compiling model.seo_audit.deepcrawl_reclass_proc
2018-02-14 09:31:37,593: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass_proc"
2018-02-14 09:31:37,594: Acquiring new bigquery connection "deepcrawl_reclass_proc".
2018-02-14 09:31:37,594: Re-using an available connection from the pool.
2018-02-14 09:31:38,192: Model SQL (deepcrawl_reclass_proc):
SELECT 
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
path_count,
last_path,
last_subfolder,
last_subfolder_canonical,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
a.first_path first_path,
first_subfolder,
a.query_string query_string,
a.filename filename,
a.classification original_class,
b.query_string query_string_rule,
e.pct_of_classification query_string_pct_of_class,
e.pct_of_value query_string_pct_of_value,
h.classification class_if_unclassified_query_string,
c.filename filename_rule,
f.pct_of_classification filename_pct_of_class,
f.pct_of_value filename_pct_of_value,
i.classification class_if_unclassified_filename,
d.first_path first_path_rule,
g.pct_of_classification first_path_pct_of_class,
g.pct_of_value first_path_pct_of_value,
j.classification class_if_unclassified_first_path,
coalesce(h.classification, i.classification, j.classification) class_if_unclassified,
case when ( b.query_string is not null and ( a.query_string != b.query_string ) and e.pct_of_value < 0.3 ) then 1 else 0 end as reclass_query_string,
case when ( c.filename is not null and ( a.filename != c.filename ) and ( f.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_filename, 
case when ( d.first_path is not null and (a.first_path != d.first_path ) and ( g.pct_of_value < 0.3 ) ) then 1 else 0 end as reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_class` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string` b
ON (  a.classification = b.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename` c
ON (  a.classification = c.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path` d
ON (  a.classification = d.classification )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_query_string` e
ON (  a.classification = e.classification AND 
	a.query_string = e.query_string ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_filename` f
ON (  a.classification = f.classification AND 
	a.filename = f.filename ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_class_stats_first_path` g
ON (  a.classification = g.classification AND 
	a.first_path = g.first_path ) 
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_query_string_unclassified` h
ON (  a.query_string = h.query_string )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_filename_unclassified` i
ON (  a.filename = i.filename )
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_rules_first_path_unclassified` j
ON (  a.first_path = j.first_path )
2018-02-14 09:31:41,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:41,675: 09:31:41 | 33 of 43 OK created table model seo_audit.deepcrawl_reclass_proc..... [CREATE TABLE in 3.88s]
2018-02-14 09:31:41,676: 09:31:41 | 34 of 43 START table model seo_audit.deepcrawl_reclass............... [RUN]
2018-02-14 09:31:41,676: Compiling model.seo_audit.deepcrawl_reclass
2018-02-14 09:31:41,686: Writing injected SQL for node "model.seo_audit.deepcrawl_reclass"
2018-02-14 09:31:41,687: Acquiring new bigquery connection "deepcrawl_reclass".
2018-02-14 09:31:41,687: Re-using an available connection from the pool.
2018-02-14 09:31:42,279: Model SQL (deepcrawl_reclass):
SELECT 
case 
	when ( (reclass_query_string + reclass_filename + reclass_first_path) = 0 and original_class != 'unclassified' ) then original_class
	when class_schema is not null then class_schema
	when class_sitemap is not null then class_sitemap
	when original_class = 'unclassified' and class_if_unclassified is not null then class_if_unclassified
	when class_google_maps is not null and class_google_maps != original_class then class_google_maps
	when ( flag_info_path = 1 and flag_blog_path = 0 and flag_blog_h1 = 0 and original_class != 'info' ) then 'info'
	when product_score >=2 and original_class != 'product' then 'product'
	when flag_prices = 1 and original_class != 'product_category' then 'product_category'
	when flag_form_submit = 1 and original_class != 'lead_generation' then 'lead_generation'
	when flag_learn_more = 1  and original_class != 'blog_category' then 'blog_category'
	when class_sitemap is not null and original_class != class_sitemap then class_sitemap
	when article_score >= 1 and original_class != 'article' then 'article'
	else 'unclassified' end as page_type,
client,
platform,
domain,
domain_canonical,
url,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
crawl_datetime,
found_at_sitemap,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
med_word_count,
page_title,
page_title_length,
description,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
h1_tag,
h2_tag,
path_count,
first_path,
last_path,
last_subfolder,
last_subfolder_canonical,
first_subfolder,
query_string,
filename,
original_class,
query_string_rule,
query_string_pct_of_class,
query_string_pct_of_value,
class_if_unclassified_query_string,
filename_rule,
filename_pct_of_class,
filename_pct_of_value,
class_if_unclassified_filename,
first_path_rule,
first_path_pct_of_class,
first_path_pct_of_value,
class_if_unclassified_first_path,
class_if_unclassified,
reclass_query_string,
reclass_filename, 
reclass_first_path,
class_sitemap,
class_schema,
class_google_maps,
flag_blog_path,
flag_blog_h1,
flag_high_word_count,
flag_thin_page,
flag_reviews,
flag_select_size,
flag_add_to_cart,
flag_prices,
flag_above_avg_prices,
flag_form_submit,
flag_learn_more,
flag_info_path,
flag_paginated,
product_score,
category_score,
article_score
FROM 
`curious-domain-121318`.`seo_audit`.`deepcrawl_reclass_proc`
2018-02-14 09:31:43,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:31:43,656: 09:31:43 | 34 of 43 OK created table model seo_audit.deepcrawl_reclass.......... [CREATE TABLE in 1.68s]
2018-02-14 09:31:43,657: 09:31:43 | 35 of 43 START table model seo_audit.ga_proc......................... [RUN]
2018-02-14 09:31:43,657: Compiling model.seo_audit.ga_proc
2018-02-14 09:31:43,657: 09:31:43 | 36 of 43 START table model seo_audit.ga_proc_pageviews............... [RUN]
2018-02-14 09:31:43,668: Writing injected SQL for node "model.seo_audit.ga_proc"
2018-02-14 09:31:43,669: Compiling model.seo_audit.ga_proc_pageviews
2018-02-14 09:31:43,676: Writing injected SQL for node "model.seo_audit.ga_proc_pageviews"
2018-02-14 09:31:43,677: Acquiring new bigquery connection "ga_proc_pageviews".
2018-02-14 09:31:43,678: Acquiring new bigquery connection "ga_proc".
2018-02-14 09:31:43,678: Re-using an available connection from the pool.
2018-02-14 09:31:43,679: Re-using an available connection from the pool.
2018-02-14 09:31:44,275: Model SQL (ga_proc_pageviews):
SELECT 
date,
unix_date,
account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(pageviews) pageviews
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
max(pageviews) pageviews
FROM `curious-domain-121318.seo_audit.ga_pageviews` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'GA Pageviews')
group by date, account, platform, url, url_stripped

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 09:31:44,297: Model SQL (ga_proc):
SELECT 
date,
unix_date,
a.account,
a.platform,
case when b.canonical_status in ( 'self', 'canonicalized', 'missing_canonical') then a.url 
	else a.url_stripped end as url,
sum(sessions) sessions,
sum(leads) leads,
sum(transactions) transactions
FROM

( 
SELECT 
date,
unix_date(date) unix_date,
account,
'Google Analytics' as platform,
lower(trim(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),'/')) as url,
lower(trim(regexp_replace(replace(replace(replace(CONCAT(hostname,path),'www.',''),'http://',''),'https://',''),r'\?.*$',''),'/')) as url_stripped,
source,
medium,
max(sessions) sessions,
max(leads) leads,
max(transactions) transactions
FROM `curious-domain-121318.seo_audit.ga` 
where account in (select account from `curious-domain-121318`.`seo_audit`.`accounts_proc` where platform = 'Google Analytics')
and medium = 'organic'
group by date, account, platform, url, url_stripped, source, medium

) a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` b
ON (
	a.url = b.url
	)
GROUP BY 
date, unix_date, account, platform, url
2018-02-14 09:31:46,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b97400>]}
2018-02-14 09:31:46,779: 09:31:46 | 35 of 43 OK created table model seo_audit.ga_proc.................... [CREATE TABLE in 2.82s]
2018-02-14 09:31:47,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c154a8>]}
2018-02-14 09:31:47,787: 09:31:47 | 36 of 43 OK created table model seo_audit.ga_proc_pageviews.......... [CREATE TABLE in 3.88s]
2018-02-14 09:31:47,788: 09:31:47 | 37 of 43 START table model seo_audit.agg_indicative.................. [RUN]
2018-02-14 09:31:47,788: Compiling model.seo_audit.agg_indicative
2018-02-14 09:31:47,799: Writing injected SQL for node "model.seo_audit.agg_indicative"
2018-02-14 09:31:47,800: Acquiring new bigquery connection "agg_indicative".
2018-02-14 09:31:47,801: Re-using an available connection from the pool.
2018-02-14 09:31:48,404: Model SQL (agg_indicative):
SELECT 
coalesce(dc.client, s.client) client,
coalesce(dc.url, s.url) url,
max(url_stripped) url_stripped,
max(canonical_url) canonical_url,
max(canonical_url_stripped) canonical_url_stripped,
max(canonical_status) canonical_status,
max(urls_to_canonical) urls_to_canonical,
max(first_subfolder) first_subfolder,
max(last_subfolder) last_subfolder,
max(last_subfolder_canonical) last_subfolder_canonical,
max(sitemap) sitemap,
max(domain) domain,
max(page_type) page_type,
max(crawl_datetime) crawl_datetime,
max(found_at_sitemap) found_at_sitemap,
max(http_status_code) http_status_code,
max(level) level,
max(schema_type) schema_type,
max(header_content_type) header_content_type,
max(word_count) word_count, 
max(page_title) page_title,
max(page_title_length) page_title_length,
max(description) description,
max(description_length) description_length,
max(indexable) indexable,
max(robots_noindex) robots_noindex,
max(is_self_canonical) is_self_canonical,
max(backlink_count) backlink_count,
max(backlink_domain_count) backlink_domain_count,
max(redirected_to_url) redirected_to_url,
max(found_at_url) found_at_url,
max(rel_next_url) rel_next_url,
max(rel_prev_url) rel_prev_url,
max(h1_tag) h1_tag,
max(h2_tag) h2_tag,
max(flag_paginated) flag_paginated
FROM `curious-domain-121318`.`seo_audit`.`deepcrawl_reclass` dc
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`sitemap_proc` s
on ( dc.url = s.url
  and dc.client = s.client )
group by client, url
2018-02-14 09:31:50,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:31:50,786: 09:31:50 | 37 of 43 OK created table model seo_audit.agg_indicative............. [CREATE TABLE in 2.77s]
2018-02-14 09:31:50,787: 09:31:50 | 38 of 43 START table model seo_audit.ga_stats........................ [RUN]
2018-02-14 09:31:50,787: Compiling model.seo_audit.ga_stats
2018-02-14 09:31:50,796: Writing injected SQL for node "model.seo_audit.ga_stats"
2018-02-14 09:31:50,798: Acquiring new bigquery connection "ga_stats".
2018-02-14 09:31:50,798: Re-using an available connection from the pool.
2018-02-14 09:31:51,485: Model SQL (ga_stats):
with sessions as (
	SELECT 
	date, unix_date, account, platform, url, 
	sessions, leads, transactions, null as pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc`
),
pageviews as (
	SELECT 
	date, unix_date, account, platform, url, 
	null as sessions, null as leads, null as transactions, pageviews
	FROM `curious-domain-121318`.`seo_audit`.`ga_proc_pageviews`
)

SELECT  
date,
account,
platform,
url,
sum(sessions) OVER w1 as sessions_30d,
sum(leads) OVER w1 as leads_30d,
sum(transactions) OVER w1 as transactions_30d,
sum(pageviews) OVER w1 as pageviews_30d,
sum(sessions) OVER w2 as sessions_mom,
sum(leads) OVER w2 as leads_mom,
sum(transactions) OVER w2 as transactions_mom,
sum(pageviews) OVER w2 as pageviews_mom,
sum(sessions) OVER w3 as sessions_yoy,
sum(leads) OVER w3 as leads_yoy,
sum(transactions) OVER w3 as transactions_yoy,
sum(pageviews) OVER w3 as pageviews_yoy
FROM (

	select 
	date,
	unix_date,
	account,
	platform,
	url,
	sum(sessions) sessions,
	sum(leads) leads,
	sum(transactions) transactions,
	sum(pageviews) pageviews
	FROM (
		SELECT * FROM sessions
		UNION ALL
		SELECT * FROM pageviews

	)
	group by date, unix_date, account, platform, url

)
WINDOW w1 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 30 PRECEDING AND CURRENT ROW),
w2 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 60 PRECEDING AND 31 PRECEDING),
w3 AS (PARTITION BY account, url ORDER BY unix_date asc RANGE BETWEEN 395 PRECEDING AND 366 PRECEDING)
2018-02-14 09:31:53,642: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c309e8>]}
2018-02-14 09:31:54,264: 09:31:54 | 38 of 43 OK created table model seo_audit.ga_stats................... [CREATE TABLE in 2.85s]
2018-02-14 09:31:54,266: 09:31:54 | 39 of 43 START table model seo_audit.agg_stats....................... [RUN]
2018-02-14 09:31:54,266: Compiling model.seo_audit.agg_stats
2018-02-14 09:31:54,280: Writing injected SQL for node "model.seo_audit.agg_stats"
2018-02-14 09:31:54,282: Acquiring new bigquery connection "agg_stats".
2018-02-14 09:31:54,282: Re-using an available connection from the pool.
2018-02-14 09:31:54,969: Model SQL (agg_stats):
SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`majestic_domain_stats`
 UNION ALL

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_url`
UNION ALL  

SELECT 
date, 
account, 
platform,
url,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_url_stats`
UNION ALL  

SELECT 
date_in_range date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
semrush_top_keyword_vol,
semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc,
null as sessions_30d,
null as leads_30d,
null as transactions_30d,
null as pageviews_30d,
null as sessions_mom,
null as leads_mom,
null as transactions_mom,
null as pageviews_mom,
null as sessions_yoy,
null as leads_yoy,
null as transactions_yoy,
null as pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`semrush_keyword_stats`

UNION ALL  

SELECT 
date, 
account, 
platform,
url,
'' as gsc_top_keyword_90d,
'' gsc_top_url_for_keyword_90d,
'' as semrush_top_keyword_vol,
'' as semrush_top_keyword_cpc,
null as ref_domain_count,
null as avg_trust_flow,
null as avg_citation_flow,
null as gsc_keyword_count_90d,
null as gsc_impressions_90d,
null as gsc_clicks_90d,	
null as gsc_ctr_90d,
null as gsc_top_keyword_impressions_90d, 
null as gsc_top_keyword_clicks_90d, 
null as gsc_top_keyword_ctr_90d,
null as semrush_keyword_count,
null as semrush_total_cpc,
null as semrush_total_search_volume,
null as semrush_top_keyword_vol_vol, 
null as semrush_top_keyword_vol_cpc, 
null as semrush_top_keyword_cpc_vol, 
null as semrush_top_keyword_cpc_cpc,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy
FROM  
  `curious-domain-121318`.`seo_audit`.`ga_stats`
2018-02-14 09:31:57,155: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:31:57,387: 09:31:57 | 39 of 43 OK created table model seo_audit.agg_stats.................. [CREATE TABLE in 2.89s]
2018-02-14 09:31:57,388: 09:31:57 | 40 of 43 START table model seo_audit.agg_stats_client................ [RUN]
2018-02-14 09:31:57,388: Compiling model.seo_audit.agg_stats_client
2018-02-14 09:31:57,398: Writing injected SQL for node "model.seo_audit.agg_stats_client"
2018-02-14 09:31:57,399: Acquiring new bigquery connection "agg_stats_client".
2018-02-14 09:31:57,400: Re-using an available connection from the pool.
2018-02-14 09:31:58,047: Model SQL (agg_stats_client):
SELECT 
a.date date, 
a.url url,
b.client client,
max(gsc_top_keyword_90d) as gsc_top_keyword_90d,
max(gsc_top_url_for_keyword_90d) as gsc_top_url_for_keyword_90d,
max(semrush_top_keyword_vol) as semrush_top_keyword_vol,
max(semrush_top_keyword_cpc) as semrush_top_keyword_cpc,
sum(ref_domain_count) as ref_domain_count,
sum(avg_trust_flow) as avg_trust_flow,
sum(avg_citation_flow) as avg_citation_flow,
sum(gsc_keyword_count_90d) as gsc_keyword_count_90d,
sum(gsc_impressions_90d) as gsc_impressions_90d,
sum(gsc_clicks_90d) as gsc_clicks_90d,	
sum(gsc_ctr_90d) as gsc_ctr_90d,
sum(gsc_top_keyword_impressions_90d) as gsc_top_keyword_impressions_90d, 
sum(gsc_top_keyword_clicks_90d) as gsc_top_keyword_clicks_90d, 
sum(gsc_top_keyword_ctr_90d) as gsc_top_keyword_ctr_90d,
sum(semrush_keyword_count) semrush_keyword_count,
sum(semrush_total_cpc) semrush_total_cpc,
sum(semrush_total_search_volume) semrush_total_search_volume,
sum(semrush_top_keyword_vol_vol) semrush_top_keyword_vol_vol, 
sum(semrush_top_keyword_vol_cpc) semrush_top_keyword_vol_cpc, 
sum(semrush_top_keyword_cpc_vol) semrush_top_keyword_cpc_vol, 
sum(semrush_top_keyword_cpc_cpc) semrush_top_keyword_cpc_cpc,
sum(sessions_30d) sessions_30d,
sum(leads_30d) leads_30d,
sum(transactions_30d) transactions_30d,
sum(pageviews_30d) pageviews_30d,
sum(sessions_mom) sessions_mom,
sum(leads_mom) leads_mom,
sum(transactions_mom) transactions_mom,
sum(pageviews_mom) pageviews_mom,
sum(sessions_yoy) sessions_yoy,
sum(leads_yoy) leads_yoy,
sum(transactions_yoy) transactions_yoy,
sum(pageviews_yoy) pageviews_yoy
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`accounts_proc` b
ON ( a.account = b.account
	and a.platform = b.platform )
GROUP BY date, client, url
2018-02-14 09:32:00,235: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4eb70>]}
2018-02-14 09:32:00,469: 09:32:00 | 40 of 43 OK created table model seo_audit.agg_stats_client........... [CREATE TABLE in 2.85s]
2018-02-14 09:32:00,470: 09:32:00 | 41 of 43 START table model seo_audit.agg_all......................... [RUN]
2018-02-14 09:32:00,470: Compiling model.seo_audit.agg_all
2018-02-14 09:32:00,480: Writing injected SQL for node "model.seo_audit.agg_all"
2018-02-14 09:32:00,481: Acquiring new bigquery connection "agg_all".
2018-02-14 09:32:00,481: Re-using an available connection from the pool.
2018-02-14 09:32:01,212: Model SQL (agg_all):
SELECT 
date, 
coalesce(a.url, b.url) url,
coalesce(a.client, b.client) client,
sitemap,
case when sitemap is not null then 'yes' else 'no' end as in_sitemap,
found_at_sitemap,
page_type,
rank() over (PARTITION BY page_type ORDER BY sessions_30d desc) as page_type_rank,
domain,
url_stripped,
canonical_url,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
sum(sessions_30d) OVER (PARTITION BY first_subfolder) first_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY first_subfolder) first_subfolder_pageviews_30d,
last_subfolder,
sum(sessions_30d) OVER (PARTITION BY last_subfolder) last_subfolder_sessions_30d,
sum(pageviews_30d) OVER (PARTITION BY last_subfolder) last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
case when regexp_contains(page_title, gsc_top_keyword_90d) then 1 else 0 end as title_contains_top_keyword,
page_title_length,
description,
case when regexp_contains(description, gsc_top_keyword_90d) then 1 else 0 end as description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
case when sessions_mom > 0 then (sessions_30d-sessions_mom)/sessions_mom else null end sessions_mom_pct,
case when leads_mom > 0 then (leads_30d-leads_mom)/leads_mom else null end leads_mom_pct,
case when transactions_mom > 0 then (transactions_30d-transactions_mom)/transactions_mom else null end transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
case when sessions_yoy > 0 then (sessions_30d-sessions_yoy)/sessions_yoy else null end sessions_yoy_pct,
case when leads_yoy > 0 then (leads_30d-leads_yoy)/leads_yoy else null end leads_yoy_pct,
case when transactions_yoy > 0 then (transactions_30d-transactions_yoy)/transactions_yoy else null end transactions_yoy_pct,
case when sessions_30d > sessions_mom then 'yes' else 'no' end as gaining_traffic_mom,
case when sessions_30d > sessions_yoy then 'yes' else 'no' end as gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
gsc_keyword_count_90d,
gsc_impressions_90d,
gsc_clicks_90d,	
gsc_ctr_90d,
gsc_top_keyword_90d,
gsc_top_url_for_keyword_90d,
gsc_top_keyword_impressions_90d, 
gsc_top_keyword_clicks_90d, 
gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc
FROM 
  `curious-domain-121318`.`seo_audit`.`agg_stats_client` a
FULL OUTER JOIN `curious-domain-121318`.`seo_audit`.`agg_indicative` b
ON ( a.url = b.url
	and a.client = b.client )
2018-02-14 09:32:07,770: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:32:08,155: 09:32:08 | 41 of 43 OK created table model seo_audit.agg_all.................... [CREATE TABLE in 7.30s]
2018-02-14 09:32:08,156: 09:32:08 | 42 of 43 START table model seo_audit.dates........................... [RUN]
2018-02-14 09:32:08,156: Compiling model.seo_audit.dates
2018-02-14 09:32:08,165: Writing injected SQL for node "model.seo_audit.dates"
2018-02-14 09:32:08,169: Acquiring new bigquery connection "dates".
2018-02-14 09:32:08,169: Re-using an available connection from the pool.
2018-02-14 09:32:08,996: Model SQL (dates):
select
client,
max(date) date
from `curious-domain-121318`.`seo_audit`.`agg_all`
where
gsc_keyword_count_90d is not null
and semrush_keyword_count is not null
and sessions_30d is not null
group by client
2018-02-14 09:32:11,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4eb70>]}
2018-02-14 09:32:11,529: 09:32:11 | 42 of 43 OK created table model seo_audit.dates...................... [CREATE TABLE in 3.07s]
2018-02-14 09:32:11,530: 09:32:11 | 43 of 43 START table model seo_audit.actions......................... [RUN]
2018-02-14 09:32:11,530: Compiling model.seo_audit.actions
2018-02-14 09:32:11,540: Writing injected SQL for node "model.seo_audit.actions"
2018-02-14 09:32:11,541: Acquiring new bigquery connection "actions".
2018-02-14 09:32:11,541: Re-using an available connection from the pool.
2018-02-14 09:32:12,680: Model SQL (actions):
SELECT
a.date date,
c.date max_date,
a.client client,
sitemap,
found_at_sitemap,
a.url url,
domain,
canonical_url,
page_type,
case 
	when http_status_code = 404 then concat('301 redirect to ', last_subfolder) 
	when http_status_code = 302 then concat('301 redirect to ', redirected_to_url)
	when http_status_code = 301 then 'leave as is'
	else '' end as http_status_action,
case when a.url like '%#%' then 'leave as is' else '' end as anchored_url_action,
case when robots_noindex = true and sitemap is not null then concat('remove from sitemap: ', sitemap) else '' end as noindex_sitemap_action,
case 
	when description = '' or page_title = '' then 'metas missing' 
	when page_type = 'blog_category' and (title_contains_top_keyword + description_contains_top_keyword) = 0 then concat('update metas to include top keyword: ', a.gsc_top_keyword_90d) 
	else 'leave as is' end as meta_rewrite_action,
case when page_type like '%category%' and flag_paginated = 0 then 'needs pagination' else '' end as pagination_action,
case 
	when a.gsc_top_url_for_keyword_90d != a.url then concat('canonicalize to ', a.gsc_top_url_for_keyword_90d)
	when b.gsc_top_url_for_keyword_90d != canonical_url then concat('canonicalize to ', b.gsc_top_url_for_keyword_90d)
	when a.gsc_top_url_for_keyword_90d = a.url then 'leave as is' 
	else '' end as canonical_action,
case when page_type in ('homepage', 'info', 'article') and sessions_30d > 0 and word_count < 500 then 'update content' else 'leave as is' end as thin_page_action,
case when page_type in ('homepage', 'info', 'article') and leads_30d > 0 or transactions_30d > 0 and gaining_traffic_yoy = 'no' then 'target links + on-page' else '' end as losing_traffic_action,
case when page_type = 'blog_category' and page_type_rank > 6 then 'quality review, potential 301 to top category' else '' end as category_action,
case when page_type = 'blog_category' then first_value(a.url) over (partition by page_type order by page_type_rank asc) else '' end as top_blog_category,
case 
	when sessions_30d > 0 and semrush_top_keyword_vol_vol >= 500 then 'leave as is'
	when sessions_30d > 0 and semrush_top_keyword_vol_vol < 500 then 'target links + on-page'
	when a.gsc_impressions_90d > 0 and sessions_30d = 0 then 'target links + on-page'
	when last_subfolder_sessions_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('block crawl to: ', last_subfolder)
	when first_subfolder_sessions_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('block crawl to: ', first_subfolder)
	when sessions_30d = 0 and pageviews_30d > 0 then 'noindex'
	when pageviews_30d = 0 and last_subfolder_pageviews_30d > 0 then concat('301 to: ', last_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d > 0 then concat('301 to: ', first_subfolder)
	when pageviews_30d = 0 and first_subfolder_pageviews_30d = 0 then concat('301 to: ', domain)
	else 'quality review' end as page_action,
page_type_rank,
url_stripped,
canonical_url_stripped,
canonical_status,
urls_to_canonical,
first_subfolder,
first_subfolder_sessions_30d,
first_subfolder_pageviews_30d,
last_subfolder,
last_subfolder_sessions_30d,
last_subfolder_pageviews_30d,
last_subfolder_canonical,
crawl_datetime,
http_status_code,
level,
schema_type,
header_content_type,
word_count, 
page_title,
title_contains_top_keyword,
page_title_length,
description,
description_contains_top_keyword,
description_length,
indexable,
robots_noindex,
is_self_canonical,
backlink_count,
backlink_domain_count,
redirected_to_url,
found_at_url,
rel_next_url,
rel_prev_url,
flag_paginated,
h1_tag,
h2_tag,
sessions_30d,
leads_30d,
transactions_30d,
pageviews_30d,
sessions_mom,
leads_mom,
transactions_mom,
pageviews_mom,
sessions_mom_pct,
leads_mom_pct,
transactions_mom_pct,
sessions_yoy,
leads_yoy,
transactions_yoy,
pageviews_yoy,
sessions_yoy_pct,
leads_yoy_pct,
transactions_yoy_pct,
gaining_traffic_mom,
gaining_traffic_yoy,
ref_domain_count,
avg_trust_flow,
avg_citation_flow,
a.gsc_keyword_count_90d,
a.gsc_impressions_90d,
a.gsc_clicks_90d,	
a.gsc_ctr_90d,
a.gsc_top_keyword_90d,
a.gsc_top_url_for_keyword_90d,
b.gsc_top_url_for_keyword_90d gsc_top_canonical_url_for_keyword_90d,
a.gsc_top_keyword_impressions_90d, 
a.gsc_top_keyword_clicks_90d, 
a.gsc_top_keyword_ctr_90d,
semrush_keyword_count,
semrush_total_cpc,
semrush_total_search_volume,
semrush_top_keyword_vol,
semrush_top_keyword_vol_vol, 
semrush_top_keyword_vol_cpc, 
semrush_top_keyword_cpc,
semrush_top_keyword_cpc_vol, 
semrush_top_keyword_cpc_cpc	
FROM `curious-domain-121318`.`seo_audit`.`agg_all` a
LEFT JOIN `curious-domain-121318`.`seo_audit`.`search_console_stats_keyword` b
ON (
	a.canonical_url = b.url AND
	a.date = b.date
	)
LEFT JOIN  `curious-domain-121318`.`seo_audit`.`dates` c
ON (
	a.client = c.client
)
WHERE a.date = c.date
OR a.date is null
2018-02-14 09:32:14,866: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4d8526c5-ddb6-4322-a762-850ccd13f61d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b4e710>]}
2018-02-14 09:32:15,152: 09:32:15 | 43 of 43 OK created table model seo_audit.actions.................... [CREATE TABLE in 3.34s]
2018-02-14 09:32:15,176: 09:32:15 | 
2018-02-14 09:32:15,177: 09:32:15 | Finished running 43 table models in 79.68s.
2018-02-14 09:32:15,177: Connection 'master' was left open.
2018-02-14 09:32:15,177: 
2018-02-14 09:32:15,177: Completed successfully
2018-02-14 09:32:15,177: 
Done. PASS=43 ERROR=0 SKIP=0 TOTAL=43
2018-02-14 09:32:15,178: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b1c4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ae49b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ae4860>]}
2018-02-14 09:32:15,500: Flushing usage events
